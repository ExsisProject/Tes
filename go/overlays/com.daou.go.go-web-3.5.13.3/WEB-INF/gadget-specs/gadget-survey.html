<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>참여할 설문</title>
    <meta name = "gadget:name-ko" content="진행중인 설문" />
    <meta name = "gadget:name-en" content="Ongoing Surveys" />
    <meta name = "gadget:name-ja" content="進行中アンケート" />
    <meta name = "gadget:name-zhcn" content="进行中的问卷" />
    <meta name = "gadget:name-zhtw" content="進行中的問卷" />
    <meta name = "gadget:name-vi" content="Thăm dò ý kiến đang thi hành" />
    <meta name = "gadget:description" content="진행중인 설문을 표시하는 가젯입니다." />
    <meta name = "gadget:version" content="1.5.0" />
    <meta name = "gadget:app-dependency" content="SURVEY" />
    <meta name = "gadget:thumbnail" content="gadget_survey.png" />
    
    <meta name = "locale" content="ko" />
    <meta name = "contextRoot" content="/" />
    <link rel="stylesheet" href="css/go-gadget-standalone.css" media="screen, print" />

    <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script type="text/javascript" src="js/go-gadget-standalone.js"></script>

    <!-- ajax mock: 개발시 크로스 도메인 문제가 발생할 경우 ajax mock request를 이용하여 테스트 할 수 있습니다-->
    <script type="text/javascript">
    $.ajaxMock.register(GO.config("contextRoot")+ 'api/survey/list/todo?page=0&offset=20&property=id&direction=desc',{
        responseText: {
            "data" : [ {
                "id" : 7,
                "createdAt" : "2014-01-29T13:34:52",
                "updatedAt" : "2014-01-29T13:34:58",
                "title" : "설문 작성 테스트",
                "startTime" : "2014-01-29T00:00:00",
                "endTime" : "2014-01-30T23:59:59",
                "status" : "progress",
                "allday" : true,
                "targetAll" : false,
                "creator" : {
                  "id" : 2,
                  "name" : "진범동1",
                  "email" : "test1@daou.co.kr",
                  "position" : "부회장",
                  "thumbnail" : "/go/resources/images/photo_profile_small.jpg",
                  "status" : "ONLINE"
                },
                "creatorName" : "진범동1",
                "visible" : true,
                "commentable" : true,
                "editable" : true,
                "noti" : "none",
                "deptName" : "",
                "guidance" : "ㄴㅇㄹㄹ",
                "attaches" : [ ],
                "targetCount" : 64,
                "responseCount" : 0,
                "commentCount" : 0,
                "responseStatus" : "done",
                "responsible" : true
              }, {
                "id" : 6,
                "createdAt" : "2014-01-29T13:34:00",
                "updatedAt" : "2014-01-29T13:34:09",
                "title" : "설문 테스트",
                "startTime" : "2014-01-29T00:00:00",
                "endTime" : "2014-01-30T23:59:59",
                "status" : "progress",
                "allday" : true,
                "targetAll" : false,
                "creator" : {
                  "id" : 2,
                  "name" : "진범동1",
                  "email" : "test1@daou.co.kr",
                  "position" : "부회장",
                  "thumbnail" : "/go/resources/images/photo_profile_small.jpg",
                  "status" : "ONLINE"
                },
                "creatorName" : "진범동1",
                "visible" : true,
                "commentable" : true,
                "editable" : true,
                "noti" : "none",
                "deptName" : "",
                "guidance" : "ㄴㅇㄹㄹ",
                "attaches" : [ ],
                "targetCount" : 64,
                "responseCount" : 0,
                "commentCount" : 0,
                "responseStatus" : "none",
                "responsible" : true
              }, {
                "id" : 4,
                "createdAt" : "2014-01-23T17:46:52",
                "updatedAt" : "2014-01-23T17:47:08",
                "title" : "댓글 테스트",
                "startTime" : "2014-01-23T00:00:00",
                "endTime" : "2014-01-24T23:59:59",
                "status" : "progress",
                "allday" : true,
                "targetAll" : false,
                "creator" : {
                  "id" : 11,
                  "name" : "최경영2",
                  "email" : "test10@daou.co.kr",
                  "position" : "부회장",
                  "thumbnail" : "/go/resources/images/photo_profile_small.jpg",
                  "status" : "ONLINE"
                },
                "creatorName" : "최경영2",
                "visible" : true,
                "commentable" : true,
                "editable" : true,
                "noti" : "none",
                "deptName" : "",
                "guidance" : "ㄴㄻㄴㅇㄹ",
                "attaches" : [ ],
                "targetCount" : 8,
                "responseCount" : 1,
                "commentCount" : 3,
                "responseStatus" : "done",
                "responsible" : true
              } ],
              "message" : "OK",
              "code" : "200",
              "__go_checksum__" : true
            },
        statusCode: 200,
        status:'OK',
        type: 'GET'
    });
    </script>

    <script type="text/javascript" id="go-gadget-script">
        gadget.load(GO.config("contextRoot") + 'api/survey/list/todo?page=0&offset=20&property=id&direction=desc', {}, {
            langs: {
                "title" : "진행중인 설문",
                "pre": "이전",
                "next": "다음",
                "empty_survey" : "참여할 설문이 없습니다.",
                "survey" : "설문",
                "creator" : "작성자",
                "result" : "설문결과",
                "join" : "설문 참여",
                "public" : "공개",
                "private" : "비공개",
                "result_view" : "결과 보기",
                "finish" : "참여완료",
                "notyet" : "미참여",
                "ja": {
                    "title" : "進行中アンケート",
                    "pre": "前へ",
                    "next": "次へ",
                    "empty_survey" : "参加するアンケートがありません。",
                    "survey" : "アンケート",
                    "creator" : "作成者",
                    "result" : "アンケート結果",
                    "join" : "アンケート参加",
                    "result_view" : "結果確認",
                    "finish" : "参加完了",
                    "notyet" : "未参加",
                },
                "en": {
                    "title" : "Ongoing Surveys",
                    "pre": "Previous",
                    "next": "Next",
                    "empty_survey" : "No surveys found.",
                    "survey" : "Survey",
                    "creator" : "Author",
                    "result" : "Result",
                    "join" : "Respond",
                    "result_view" : "View Results",
                    "finish" : "Complete",
                    "notyet" : "Ongoing",
                },
                "zh_CN": {
                    "title" : "进行中的问卷",
                    "pre": "前一頁",
                    "next": "下一頁",
                    "empty_survey" : "没有可以参加的问卷。",
                    "survey" : "问卷",
                    "creator" : "创建者",
                    "result" : "问卷结果",
                    "join" : "参加问卷",
                    "result_view" : "查看结果",
                    "finish" : "参加完成",
                    "notyet" : "未参加",
                },
                
                "zh_TW": {
                    "title" : "進行中的問卷",
                    "pre": "前一页",
                    "next": "下一页",
                    "empty_survey" : "沒有可以參加的問卷。",
                    "survey" : "問卷",
                    "creator" : "創建者",
                    "result" : "問卷結果",
                    "join" : "參加問卷",
                    "result_view" : "查看結果",
                    "finish" : "參加完成",
                    "notyet" : "未參加",
                },

                "vi": {
                	"title" : "Thăm dò ý kiến đang thi hành",
                    "pre": "Trang trước",
                    "next": "Tiếp theo",
                    "empty_survey" : "Không có khảo sát để tham gia.",
                    "survey" : "Thăm dò ý kiến",
                    "creator" : "Người soạn thảo",
                    "result" : "Kết quả thăm dò ý kiến",
                    "join" : "Tham gia thăm dò ý kiến",
                    "public" : "Công khai",
                    "private" : "Không công khai",
                    "result_view" : "Xem kết quả",
                    "finish" : "Hoàn tất tham gia",
                    "notyet" : "Không tham gia"
                }
            }, 
            
            refreshable: true,
            
            highlightable : true,
            
            styles: {
                "li.null_data" : "border-top:0px"
            }, 

            renderConfig: function(el) {
                
            }, 

            onSuccess: function(el, data) {
                this.data = data;
                this.render(el, data);
            }, 
            
            onMoved : function(el, data) {
                this.render(el, this.data);
            }, 

            render: function(el, data) {
                 var surveyView = new SurveyView({el : $(el), data : data.data, i18n : this.i18n, highlight : this.options.highlight});
                 $(el).html(surveyView.render());
                 if(data.data.length != 0){
                     surveyView.makeContent();
                 }
            },
            
            setTitle: function() {
                return this.getTitle();
            }, 
            
            getTitle: function() {
                return this.i18n.parse("title");
            }, 
        });
        
        var SurveyView = Backbone.View.extend({
            className : "slide_contents_warp",
            
            events : {
                "click span[data-type='prev']" : "prev",
                "click span[data-type='next']" : "next",
            },
            
            initialize : function(){
                this.$el.off();
                this.collection = new (Backbone.Collection.extend({}));
                this.collection.set(this.options.data);
                this.i18n = this.options.i18n;
                this.currentPage = 0;
                this.offset = null;
                this.isLastPage = null;
                this.highlight = this.options.highlight;
                this.emptyEl = [
                    "<ul class='type_simple_list'>",
                        "<li class='null_data'>",
                            "<p class='desc'>" + this.i18n.parse("empty_survey") + "</p>",
                        "</li>",
                    "</ul>"].join("");
            },
            
            render : function(){
                var html = [];
                
                html.push("<div class='gadget_design_wrap'>");
                html.push('    <div class="go_gadget_header">')
                html.push('        <div class="gadget_h1">');
                html.push("            <span class='type'>");
                html.push("                <span class='ic_dashboard2 ic_type_survey' title='" + this.i18n.parse("survey") +"'/>");
                html.push('            </span>');
                html.push("            <span class='title'>" + this.i18n.parse("title") + "</span>");
                html.push('        </div>');
                html.push('    </div>');
                if(this.collection.length == 0){
                    html.push(this.emptyEl);
                }else{
                    html.push("    <div class='slide_contents_warp'>");
                    html.push("        <div class='card_item_wrapper' id='survey_cards'>");
                    html.push("        </div>");
                    html.push("        <div class='btn_control' id='page_controll'>");
                    html.push("        </div>");
                    html.push("    </div>");
                    html.push("</div>");
                }
                return html.join("");
            },
            
            makeContent : function(){
                var cardsWidth = this.$el.find("#survey_cards").width(),
                    defaultCardWidth = 228;
                
                if(cardsWidth < defaultCardWidth){
                    cardsWidth = defaultCardWidth;
                }
                
                this.offset = parseInt(cardsWidth / defaultCardWidth);
                this.isLastPage = ((this.currentPage +1) * this.offset) >= this.collection.length ? true : false;
                
                this.$el.find("#survey_cards").html(this.makeCards());
                this.$el.find("#page_controll").html(this.makePage());
            },
            
            makePage : function(){
                var html = [];
                
                html.push("            <span class='btn_wrap' data-type='prev' style='display:none'>");
                html.push("                <span class='ic_dashboard2 ic_prev' title='" + this.i18n.parse("pre") + "'></span>");
                html.push("            </span>");
                
                if(this.isLastPage){
                    
                html.push("            <span class='btn_wrap' data-type='next' style='display:none'>");
                html.push("                <span class='ic_dashboard2 ic_next' title='" + this.i18n.parse("next") + "'></span>");
                html.push("            </span>");
                
                }else{
                    
                html.push("            <span class='btn_wrap' data-type='next'>");
                html.push("                <span class='ic_dashboard2 ic_next' title='" + this.i18n.parse("next") + "'></span>");
                html.push("            </span>");
                
                }
                return html.join("");
            },
            
            makeCards : function(){
                var items = [],
                    self = this;
                
                if(this.collection.length == 0){
                    return emptyEl;
                }
            
                this.collection.each(function(model, index){
                    var html = [],
                        cardPage = parseInt( index / self.offset ),
                        isResponsed = model.get("responseStatus") == "none",
                        isCurrentPage = (cardPage == self.currentPage);
                    
                    if(isCurrentPage){
                    html.push("         <section class='card_item survey_home_card' data-page='" + cardPage + "'>");
                    }else{
                    html.push("         <section class='card_item survey_home_card' data-page='" + cardPage + "' style='display:none'>");
                    }
                    
                    html.push("             <div class='h_border'></div>");
                    
                    /*
                    <header>
                    <span class="number">No.1</span>
            <span class="state finish">참여완료</span>
                </header>
                */
                    html.push("             <div class='card_wrapper'>");
                    html.push("                 <header>");
                    html.push("                     <span class='number'>No."+ (index + 1 )+"</span>");
                    html.push("                     <span class='state "+ (isResponsed ? "notyet" : "finish") +"'>" + (isResponsed ? self.i18n.parse("notyet") : self.i18n.parse("finish")) +"</span>");
                    html.push("                 </header>");
                    
                    /*
                    if(isToday(model.get("closedAt"), model.get("currentDate"))){
                        html.push("                 <span class='btn_custom'>" + self.i18n.parse("today_closing_day") + "</span>");
                    }
                    */
                    
                    html.push("                 <div class='card_subject'>");
                    html.push("                     <span class='title'>"+GO.util.escapeHtml(model.get("title"))+"</span>");
                    html.push("                     <span class='date'>"+ GO.util.customDate(moment(model.get("startTime"), "YYYY-MM-DD"), "YYYY-MM-DD") + " ~ " + GO.util.customDate(moment(model.get("endTime"), "YYYY-MM-DD"), "YYYY-MM-DD") +"</span>");
                    html.push("                 </div>");
                    html.push("                 <div class='card_content'>");
                    html.push("                     <table class='form_s'>");
                    html.push("                         <tbody>");
                    html.push("                             <tr>");
                    html.push("                                 <th> " + self.i18n.parse("creator") + "</th>");
                    html.push("                                 <td>"+model.get("creator").name + "</td>");
                    html.push("                             </tr>");
                    html.push("                             <tr>");
                    html.push("                                 <th>" + self.i18n.parse("result") + " </th>");
                    html.push("                                 <td>" + (model.get("visible") ? self.i18n.parse("public") : self.i18n.parse("private")) + "</td>");
                    html.push("                             </tr>");
                    html.push("                         </tbody>");
                    html.push("                     </table>");
                    html.push("                 </div>");
                    html.push("                 <div class='card_action'>");
                    html.push("                     <a class='btn_lead' href='"+ GO.config("contextRoot") + "app/survey/" + model.get("id") +"'><span class='ic'></span><span class='txt'>" + (isResponsed ? self.i18n.parse("join") : self.i18n.parse("result_view")) + "</span></a>");
                    html.push("                 </div>");
                    html.push("             </div>");
                    html.push("         </section>");
                    
                    items.push(html.join(""));
                });
                
                return items.join("");
            },
            
            prev : function(){
                this.currentPage -= 1;
                this.pageNavigator();
            },
            
            next : function(){
                this.currentPage += 1;
                this.pageNavigator();
                
            },
            
            pageNavigator : function(){
                this.$el.find("#survey_cards section").hide();
                this.$el.find("#survey_cards section[data-page='"+ this.currentPage +"']").show();
                
                this.isLastPage = ((this.currentPage +1) * this.offset) >= this.collection.length ? true : false;
                
                if(this.isLastPage){
                    this.$el.find("#page_controll span[data-type='next']").hide();
                }else{
                    this.$el.find("#page_controll span[data-type='next']").show();
                }
                
                if(this.currentPage == 0){
                    this.$el.find("#page_controll span[data-type='prev']").hide();
                }else{
                    this.$el.find("#page_controll span[data-type='prev']").show();
                }

            }
        });
    </script>
</head>

<body id="main" class="go_skin_home_default" data-role="main">
    <div class="go-dashboard go-dashboard-editing go_dashboard_3_2">
        <div class="go-gadget-column gadget-col-1" data-columnid="1">
            <!-- empty -->
        </div>
        
        <div class="gripper"></div>

        <div id="gadget-containter" class="go-gadget-column gadget-col-2" data-columnid="2">
            <!-- empty -->
        </div>

        <div class="gripper"></div>

        <div class="go-gadget-column gadget-col-3" data-columnid="3">
            <!-- empty -->
        </div>
    </div>
</body>
</html>