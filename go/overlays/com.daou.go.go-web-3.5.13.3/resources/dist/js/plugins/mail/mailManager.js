function uploadMailMessage(){if(upfolderName==""||upfolderName.length==0)upfolderName=mailControl.getCurrentFolder();startUploadMsg(upfolderName),upfolderName=""}function startUploadMsg(e){var t=basicMsgUploadControl.getUploadQueueFile();jQuery("#basicMsgUploadControl").swfupload("addPostParam","folderName",e),jQuery("#messageUploadListTable").append(getHandlebarsTemplate("mail_message_upload_items_tmpl",t)),jQuery("#messageUploadListWrap").show(),basicMsgUploadControl.startUpload()}function closeUploadModal(e){basicMsgUploadControl.cancelUpload(),basicMsgUploadControl.destroy(),jQuery.goPopup.close(),e&&e()}function generatorFileIndex(){var e=0,t=jQuery("#basicAttachList > li").size();if(t>0){var n=jQuery("#basicAttachList li:last").attr("data-index");n&&(e=parseInt(n)+1)}return e}function openUploadMessageLayer(){var e=0,t={useFlash:hasFlashPlayer()};jQuery.goPopup({id:"mail_message_upload_popup",pclass:"layer_normal",header:mailMsg.menu_uploadmsg,width:500,contents:getHandlebarsTemplate("mail_message_upload_tmpl",t),openCallback:function(){if(!hasFlashPlayer()){if(upfolderName==""||upfolderName.length==0)upfolderName=mailControl.getCurrentFolder();jQuery("#mailSimpleMessageUpload").fileupload({url:"/api/mail/message/upload",sequentialUploads:!0,formData:{uploadType:"flash",folderName:upfolderName},dataType:"json",pasteZone:null}),jQuery("#mailSimpleMessageUpload").bind("fileuploadadd",function(t,n){var r=n.files[0].size,i=n.files[0].name,s=e++,o="file_index_"+s;n.files[0].id=o,n.files[0].index=s;if(!isFileExt(i,"eml"))return jQuery.goMessage(msgArgsReplace(mailMsg.error_nofileext,["eml"])+" ["+n.files[0].name+"]"),!1;if(r>104857600)return jQuery.goMessage(mailMsg.ocx_upalert_size+" ["+n.files[0].name+"]"),!1;var u={id:o,index:s,name:i};jQuery("#messageUploadListTable").append(getHandlebarsTemplate("mail_message_upload_item_tmpl",u)),jQuery("#messageUploadListWrap").show()}).bind("fileuploadprogress",function(e,t){var n=t.files[0],r=n.id,i=Math.ceil(t.loaded/t.total*100);i=i>=100?100:i,jQuery("#msg_progress_"+r).hide(),jQuery("#msg_progress_"+r).progressBar(i,msgProgressBarOpt),jQuery("#msg_progress_"+r).show(),i==100&&jQuery("#msg_progress_"+r).html("<img src='/resources/images/img_loader_s.gif' align='absmiddle'>")}).bind("fileuploadsubmit",function(e,t){}).bind("fileuploadsend",function(e,t){}).bind("fileuploaddone",function(e,t){var n=t.result,r=t.files[0],i=r.id;switch(n.resultMessage){case"success":jQuery("#msg_progress_"+i).html('<span style="color:red">['+mailMsg.comn_upload_complete+"]</span>");break;case"overQuota":jQuery.goAlert(mailMsg.comn_upload_title,mailMsg.error_upload_quota),setTimeout(function(){closeUploadModal()},1e3);break;case"sizeZero":jQuery.goAlert(mailMsg.comn_upload_title,mailMsg.file_size_zero);break;default:jQuery.goMessage(mailMsg.comn_upload_title,mailMsg.error_fileupload),jQuery("#msg_progress_"+i).addClass("failUpload").html('<span style="color:red">['+mailMsg.comn_cancel+"]</span>")}}).bind("fileuploadstop",function(e){jQuery.goPopup.close(),isFolderManageMenu()?mailSettingControl.loadViewFolderManage():mailControl.reloadMessageList()}).bind("fileuploadfail",function(e,t){jQuery.goAlert(mailMsg.comn_upload_title,mailMsg.error_fileupload)}).bind("fileuploadchunkalways",function(e,t){})}else msgUploadInit()},closeCallback:function(){},buttons:[{btype:"cancel",btext:mailMsg.comn_cancel,callback:function(){closeUploadModal()}}]})}function msgUploadInit(){basicMsgUploadControl.init(),basicMsgUploadControl.makeBtnControl(),basicMsgUploadControl.setAttachSize("normalMax",104857600),basicMsgUploadControl.setAttachSize("normalUse",0),isOcxMsgUploadMode=!1}var msgProgressBarOpt={boxImage:"/resources/images/progressbar.gif",barImage:"/resources/images/progressbg_green_50.gif",width:60,showText:!1},basicMsgUploadListeners={swfuploadLoaded:function(e){},fileQueued:function(e,t){var n=t.size,r=basicMsgUploadControl.getAttachQuotaInfo();if(n>r.normalMax||n+r.normalUse>r.normalMax){jQuery.goMessage(mailMsg.error_upload_quota),setTimeout(function(){closeUploadModal()},1e3);return}basicMsgUploadControl.addUploadQueueFile(t)},fileQueueError:function(e,t,n,r){n=="-120"?jQuery.goMessage(mailMsg.ocx_virtxt_failquest):jQuery.goMessage(mailMsg.error_fileupload+"["+n+"]")},fileDialogStart:function(e){},fileDialogComplete:function(e,t,n){if(t==0)return;uploadMailMessage()},uploadStart:function(e,t){jQuery("#msg_progress_"+t.id).progressBar(0,msgProgressBarOpt)},uploadProgress:function(e,t,n){var r=t.size,i=Math.ceil(n/r*100);i=i>=100?100:i,jQuery("#msg_progress_"+t.id).hide(),jQuery("#msg_progress_"+t.id).progressBar(i,msgProgressBarOpt),jQuery("#msg_progress_"+t.id).show(),i==100&&jQuery("#msg_progress_"+t.id).html("<img src='/resources/images/img_loader_s.gif' align='absmiddle'>")},uploadSuccess:function(e,t,n){var r=JSON.parse(n),i=!1;switch(r.resultMessage){case"success":jQuery("#msg_progress_"+t.id).html('<span style="color:red">['+mailMsg.comn_upload_complete+"]</span>");break;case"overQuota":jQuery.goAlert(mailMsg.comn_upload_title,mailMsg.error_upload_quota),setTimeout(function(){closeUploadModal()},1e3);break;case"sizeZero":jQuery.goAlert(mailMsg.comn_upload_title,mailMsg.file_size_zero);break;default:jQuery.goMessage(mailMsg.comn_upload_title,mailMsg.error_fileupload),jQuery("#msg_progress_"+t.id).addClass("failUpload").html('<span style="color:red">['+mailMsg.comn_cancel+"]</span>")}},uploadComplete:function(e,t){basicMsgUploadControl.isNextUploadQueue(t.id)||(jQuery.goMessage(mailMsg.alert_messageupload),setTimeout(function(){var e=[];jQuery("#messageUploadListWrap span.failUpload").each(function(t){e.push({name:jQuery(this).closest("tr").find("span.name").text()})}),e.length==0?closeUploadModal(function(){mailMenuStatus=="setting"?reloadViewFolderManage():reloadMessageList()}):(jQuery("#mail_message_upload_popup a.btn_minor_s span.txt").text(mailMsg.comn_close),jQuery("#messageUploadFailListWrap").html(getHandlebarsTemplate("mail_message_upload_fail_tmpl",e)).show(),mailMenuStatus=="setting"?reloadViewFolderManage():reloadMessageList())},1e3))},uploadError:function(e,t,n,r){if(n!=SWFUpload.UPLOAD_ERROR.FILE_CANCELLED){jQuery.goMessage(mailMsg.error_fileupload),setTimeout(function(){closeUploadModal()},1e3);return}}},basicMsgUploadOpt={controlType:"normal",btnId:"basicMsgUploadControl",btnCid:"basicMsgUploadBtn",formName:"theFile",param:{uploadType:"flash",email:USEREMAIL},url:"/api/mail/message/upload",maxFileSize:104857600,fileType:"*.eml",btnText:mailMsg.comn_file_select,width:LOCALE=="jp"?90:73,debug:!1,handler:basicMsgUploadListeners},basicMsgUploadControl=null,upfolderName="";hasFlashPlayer()?basicMsgUploadControl=new UploadBasicControl(basicMsgUploadOpt):basicMsgUploadControl=new UploadSimpleBasicControl(basicMsgUploadOpt);