define("todo/views/site/card_activity_list",["backbone","hogan","todo/models/todo_activity","todo/models/todo_activities","todo/views/site/edit_text_form","hgn!todo/templates/card_activity_list","text!todo/templates/partials/_card_activity_list.html","text!todo/templates/partials/_user_thumbnail.html","todo/views/menus/main","todo/libs/util","i18n!todo/nls/todo","i18n!nls/commons"],function(e,t,n,r,i,s,o,u,a,f,l,c){function m(){this.__page__=1,this.contentModels=[],y.call(this),b.call(this),this.collection.getPageList().then(_.bind(w,this)).then(_.bind(g,this)).otherwise(function(e){console.warn(e.stack)})}function g(){var e=this.collection.length<this.collection.page.total||!1;e?this.$el.find("#moreBtn").show():this.$el.find("#moreBtn").hide()}function y(){this.$el.find(".comment-write-form").toggle(this.collection.isActivated(d.comments))}function b(){this.$el.find(".activity-list-container").empty()}function w(e){var t=v;this.$el.find(".activity-list-container").append(t({activities:E(e),label:{save:c["\uc800\uc7a5"],cancel:c["\ucde8\uc18c"],modify:c["\uc218\uc815"],remove:c["\uc0ad\uc81c"]}},{_user_thumbnail:u})),_.each(e.models,function(e){this.contentModels.push(e)},this)}function E(e){var t=e.toJSON();return _.map(t,function(e){e.updatedAt&&(e.updatedAt=f.toStreamDate(e.updatedAt)),e.editable=e.activityType==="comment"&&e.actor.id===GO.session("id"),e.content=GO.util.escapeHtml(e.content)}),t}function S(e){var t=this.$el.find("form[name=form_reply]"),n=t.find("footer");t.hasClass("form_wrap")||(t.addClass("form_wrap"),e&&t.find("textarea").val(""),n.hide())}var h,p,d={comments:"comments",timelines:"timelines"},v=function(){var e=Hogan.compile(o);return e.render.apply(e,arguments)};return p=i.extend({initialize:function(e){e=e||{},e.content=this.model.get("content"),e.enterNewLine=!0,e.autoExpand=!0,i.prototype.initialize.call(this,e)},_confirm:function(e){var t=this,n=this.getValue();e.preventDefault(),this.model.updateContent(n).then(function(e){t.remove(),t.afterConfirm.call(t,e)})}}),h=e.View.extend({className:"card-activity-container",template:s,__page__:1,__pageSize__:20,events:{"click form[name=form_reply] .btn-submit":"_saveReply","focus form[name=form_reply] textarea":"_activateReplyForm","click form[name=form_reply] .btn-cancel":"_deactivateReplyForm","click .btn-reply-modify":"_callReplyEditForm","click .btn-reply-remove":"_callRemoveConfirmForm","click .activity-tab > li":"_changeTab","keyup textarea":"_expandTextarea","click .btn_list_reload":"_loadMore"},initialize:function(e){var t=this;this.contentModels=[],e=e||{},this.todoItemModel=e.todoItemModel,this.collection||(this.collection=r.newForTodoItem(this.todoItemModel)),this.listenTo(this.todoItemModel,"change:commentCount",this.reload)},delegateEvents:function(){var t=this;e.View.prototype.delegateEvents.apply(this,arguments),$(document).on("click.card-activity-list",function(e){var n=$(e.target);!n.parents("form[name=form_reply]").length>0&&S.call(t,!1)})},undelegateEvents:function(){e.View.prototype.undelegateEvents.apply(this,arguments),$(document).off(".card-activity-list")},render:function(){this.$el.empty().append(this.template({session:GO.session(),commentCount:this.todoItemModel.get("commentCount"),activatedComments:this.collection.isActivated(d.comments),label:{comment:c["\ub313\uae00"],timeline:l["\ud0c0\uc784\ub77c\uc778"],save:c["\uc800\uc7a5"],cancel:c["\ucde8\uc18c"],modify:c["\uc218\uc815"],remove:c["\uc0ad\uc81c"],load_more:c["\ub354\ubcf4\uae30"]}},{_user_thumbnail:u})),m.call(this)},_expandTextarea:function(e){GO.util.textAreaExpand(e)},changeActivityType:function(e){this.collection.setActivityType(e),m.call(this)},reload:function(){this.render()},_changeTab:function(e){var t=$(e.currentTarget),n=t.data("actitytype");this.changeActivityType(n),this.$el.find(".activity-tab > li.active").removeClass("active"),t.addClass("active")},_activateReplyForm:function(e){var t=$(e.currentTarget),n=t.closest("form[name=form_reply]"),r=n.find("footer");n.removeClass("form_wrap"),r.show()},_deactivateReplyForm:function(e){e.preventDefault(),S.call(this,!0)},_saveReply:function(e){var t=this.todoItemModel,r=this.$el.find("textarea[name=content]").val();e.preventDefault();if(r==""){var i=c["\ub313\uae00\uc744 \uc785\ub825\ud558\uc138\uc694."];GO.util.isMobile()?alert(i):$.goSlideMessage(i);return}n.createComment(t,r).then(function(){t.set("commentCount",t.getCommentCount()+1)})},_callReplyEditForm:function(e){var t=$(e.currentTarget),n=t.closest(".card-activity-container"),r=n.find(".card-activity-content"),i=n.data("id"),s=this,o;e.preventDefault();var u=_.find(this.contentModels,function(e){return i==e.get("id")});o=new p({model:u,textareaHeight:r.height(),afterConfirm:function(e){s.reload()},afterCancel:function(){r.children().show(),s.$el.find(".comment-action-buttons").removeAttr("style")}}),r.children().hide(),r.append(o.el),this.$el.find(".comment-action-buttons").hide()},_callRemoveConfirmForm:function(e){var t=$(e.currentTarget),n=t.closest(".card-activity-container"),r=n.find(".card-activity-content"),i=n.data("id"),s=this.todoItemModel,o=this,u,f=_.find(this.contentModels,function(e){return i==e.get("id")});e.preventDefault(),a.attachTo(t,new a.RemoveConfirmMenuView({subject:l["\ub313\uae00 \uc0ad\uc81c \ud0c0\uc774\ud2c0"],description:l["\ub313\uae00 \uc0ad\uc81c \ud655\uc778 \uba54\uc2dc\uc9c0"],afterClick:function(){var e=this;f.remove().then(function(){e.back(),s.set("commentCount",s.getCommentCount()-1)})}}))},_loadMore:function(){var e=this.__page__+1,t=r.newForTodoItem(this.todoItemModel);t.setActivityType(this.collection.activityType),t.getPageList(e,this.__pageSize__).then(_.bind(function(e){if(e.length>0)w.call(this,e),++this.__page__;else{var n=l["\ub313\uae00 \uc5c6\uc74c \uba54\uc2dc\uc9c0"];t.activityType==="timelines"&&(n=l["\ud0c0\uc784\ub77c\uc778 \uc5c6\uc74c \uba54\uc2dc\uc9c0"]),GO.util.isMobile()?window.alert(n):$.goSlideMessage(n)}},this))}}),h});