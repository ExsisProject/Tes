define("todo/models/todo",["when","app","todo/models/base","todo/models/todo_activities","todo/models/todo_category","todo/models/todo_label","todo/libs/util","libs/go-utils"],function(e,t,n,r,i,s,o,u){function c(e,t){return o.convertArrayToCollection(e,t)}function h(e){return e&&e[0]==="/"&&(e=e.slice(1)),[_.result(this,"urlRoot"),this.id,"category",e].join("/")}function p(e){return e&&e[0]==="/"&&(e=e.slice(1)),[_.result(this,"urlRoot"),this.id,"owner",e].join("/")}function d(t){var n=e.defer();return this.save(t,{success:n.resolve,error:function(){n.reject(o.createResponseError(500,"Internal Server Error",""))}}),n.promise}function v(n){var r=e.defer();return!this.isNew()&&!this.isOwner(t.session("id"))?e.reject(o.createResponseError(404,"Not Found","")):d.call(this,n)}function m(t){var n=e.defer(),r=this.get("members"),i=this;return this.isOwner(t)?e.reject("owner of board can't leave"):(this.isMember(t)?this.save(null,{type:"DELETE",url:[_.result(this,"urlRoot"),this.id,"member",t].join("/"),success:function(e){i.set("members",_.filter(r,function(e){return e.id!==t})),n.resolve(i)},error:function(){n.reject(o.createResponseError(500,"Internal Server Error"))}}):n.reject(o.createResponseError(404,"Not Found","")),n.promise)}function g(t){var n=this,r=e.defer(),i={add:f,remove:l}[t];return i?this.save({},{url:[_.result(this,"urlRoot"),this.id,"favorite",t].join("/"),success:function(e){n.set("favoriteFlag",i),r.resolve.apply(r,arguments)},error:function(e,t,n){t.responseJSON.code==404&&t.responseJSON.name=="todo.not.found.element"&&$.goSlideMessage(t.responseJSON.message,"caution"),r.reject(t)}}):r.reject(o.createResponseError(400,"Parse Error","")),r.promise}var a,f="Y",l="N";return a=n.Model.extend({__items__:[],defaults:{publicFlag:l},initialize:function(e,t){this.__items__=[],n.Model.prototype.initialize.apply(this,arguments)},urlRoot:function(){return t.config("contextRoot")+"api/todo"},remove:function(){var t=e.defer();return this.destroy({success:t.resolve,error:function(e,n,r){t.reject(n)}}),t.promise},getActivities:function(t,n){var i=r.newForTodo(this,t,n),s=e.defer();return i.fetch({success:s.resolve,fail:function(e,t,n){s.reject(t)}}),s.promise},getCategories:function(){return this.get("categories")||[]},getCategory:function(e){return _.findWhere(this.get("categories"),{id:e})},getLabels:function(){return this.get("labels")||[]},getLabel:function(e){return _.findWhere(this.get("labels"),{id:e})},getMember:function(e){return _.findWhere(this.get("members")||[],{id:e})},addFavorite:function(){return g.call(this,"add")},removeFavorite:function(){return g.call(this,"remove")},addMember:function(t){var n=e.defer(),r=[_.result(this,"urlRoot"),this.id,"members"].join("/"),i=this.get("members"),s=this,u=0;_.each(t,function(e){this.isMember(e.id)&&u++},this);if(t.length==1&&u)return e.reject(o.createResponseError(400,"Already Exists",""));var a=_.map(t,function(e){return e.id}),f=_.map(this.get("members"),function(e){return e.id}),l=_.uniq(_.difference(a,f));return o.promiseAsync(r,{type:"POST",data:JSON.stringify({ids:l})}).then(function(t){return _.each(t,function(e){i.push(e),s.set("members",i)}),s.trigger("change:members"),e.resolve(s)})},leaveMember:function(e){return m.call(this,e)},removeMember:function(n){return this.isOwner(t.session("id"))?m.call(this,n):e.reject(o.createResponseError(403,"Not Authorized",""))},setPublic:function(){this.set("publicFlag",f)},setPrivate:function(){this.set("publicFlag",l)},updateTitle:function(e){return v.call(this,{title:u.escapeString(e)})},updatePublic:function(){return v.call(this,{publicFlag:f})},updatePrivate:function(){return v.call(this,{publicFlag:l})},addCategory:function(t){var n=this,r=this.getCategories();return i.createfromTodo(this,t).then(function(t){return r.push(t.toJSON()),n.set("categories",r),e.resolve(t)},e.reject)},updateCategory:function(t,n){var r=this.getCategories(),s=e.defer(),u=this;if(!this.getCategory(t))return e.reject(o.createResponseError(404,"Not Found",""));var a=new i(this.getCategory(t));return a.save(n,{success:function(e){var t=[];_.each(r,function(n){e.id===n.id?t.push(e.toJSON()):t.push(n)}),u.set("categories",t),s.resolve(e)},error:function(e,t,n){t.responseJSON.code==404&&t.responseJSON.name=="todo.not.found.element"&&$.goSlideMessage(t.responseJSON.message,"caution"),s.reject(t)}}),s.promise},updateCategoryTitle:function(e,t){return this.updateCategory(e,{title:u.escapeString(t)})},reorderCategories:function(t){var n=h.call(this,"move"),r=_.pluck(this.getCategories(),"id"),i=this;return _.isEqual(r,t)?e.resolve(this):o.reqReorderList(n,t).then(function(t){return i.set("categories",t),e.resolve(i)})},removeCategory:function(t){var n=c(this.getCategories(),i),r=n.get(t),s=e.defer(),o=this;return r.destroy({success:function(e){n.remove(t),o.set("categories",n.toJSON()),s.resolve(o)},error:function(e,t,n){s.reject(t)}}),s.promise},updateLabel:function(t,n){var r=c(this.getLabels(),s),i=r.get(t),u=e.defer(),a=this;return i?(i.save(n,{success:function(e){r.set([e]),a.set("labels",r.toJSON()),a.trigger("change:labels"),u.resolve(e)},error:function(e,t,n){t.responseJSON.code==404&&t.responseJSON.name=="todo.not.found.element"&&$.goSlideMessage(t.responseJSON.message,"caution"),u.reject(t)}}),u.promise):e.reject(o.createResponseError(404,"Not Found",""))},updateLabelTitle:function(e,t){return this.updateLabel(e,{title:u.escapeString(t)})},updateLabels:function(n){var r=[t.config("contextRoot")+"api/todo",this.id,"label"].join("/"),i=this;return o.promiseAsync(r,{type:"PUT",data:n}).then(function(t){return i.set("labels",t),i.trigger("change:labels"),e.resolve(i)})},updateOwner:function(t){var n=e.defer();return this.isMember(t)?this.save(null,{url:p.call(this,t),success:n.resolve,error:function(e,t,r){n.reject(t)}}):n.reject(o.createResponseError(400,"Bad Request","Only member can be owner.")),n.promise},getNextItemSeq:function(e){return _.where(this.__items__,{todoCategoryId:e}).length},addItem:function(t,n){var r=this;return TodoItemModel.createfromTodo(this,t,u.escapeString(n)).then(function(t){return r.__items__.push(t.toJSON()),e.resolve(t)},e.reject)},isFavorite:function(){return this.get("favoriteFlag")===f},isArchived:function(){return this.get("deleteFlag")===f},isPublic:function(){return this.get("publicFlag")===f},isPrivate:function(){return this.get("publicFlag")===l},isOwner:function(e){return this.get("owner").id===e},isMember:function(e){return _.where(this.get("members")||[],{id:e}).length>0}},{newBoard:function(e,t){return new a({title:u.escapeString(e),publicFlag:t||l})},createBoard:function(e,t){var n=this.newBoard(e,t);return d.call(n)},getBoard:function(t){var n=e.defer(),r=new a({id:t});return r.fetch({success:n.resolve,error:function(e,t,r){n.reject(t)}}),n.promise}}),a});