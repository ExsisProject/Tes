define("todo/views/site/board_timeline",["backbone","app","hogan","todo/constants","todo/models/todo_activities","hgn!todo/templates/board_activity_list","text!todo/templates/partials/_board_activity_item.html","text!todo/templates/partials/_user_thumbnail.html","todo/libs/util","todo/libs/scroll","i18n!todo/nls/todo","i18n!nls/commons","jquery.go-popup"],function(e,t,n,r,i,s,o,u,a,f,l,c){function m(){var e=this.$el.find("header"),t=this.$el.find(h.detail.timelineBottomButtons),n=this.$el.height()-e.outerHeight()-t.outerHeight()-20,r=this.$el.find(h.detail.timelineContents).outerHeight();this.$el.find(h.common.scrollContainer).height(Math.min(n,r))}function g(){f.attachTo(this.$el.find(h.common.scrollContainer))}function y(e){var n=e.toJSON();return _.map(n,function(e){e.updatedAt&&(e.updatedAt=a.toStreamDate(e.updatedAt)),e.editable=e.activityType==="comment"&&e.actor.id===t.session("id")}),n}var h=r.SELECTORS,p=".go.todo.timeline",d=function(e){return Hogan.compile(o).render(e,{_user_thumbnail:u})},v=e.View.extend({tagName:"aside",className:"board-timeline-container aside_timeline",template:s,__page__:1,__pageSize__:20,events:{"click .btn-load-more":"_loadMore","click .btn-close-timeline":"_close"},initialize:function(e){var t=this;e=e||{},this.todoModel=e.todoModel,this.onClose=e.onClose||function(){},this.collection||(this.collection=i.newForTodo(this.todoModel))},render:function(){var e=this;this.collection.getPageList().then(function(n){e.$el.empty().append(e.template({activities:y(n),label:{timeline:l["\ud0c0\uc784\ub77c\uc778"],load_more:c["\ub354\ubcf4\uae30"],close_timeline:l["\ud0c0\uc784\ub77c\uc778 \ub2eb\uae30"]},msg:{no_activities:l["\ud0c0\uc784\ub77c\uc778 \uc5c6\uc74c \uba54\uc2dc\uc9c0"]}},{_board_activity_item:o,_user_thumbnail:u})),m.call(e),g.call(e),t.EventEmitter.on("todo","resize:column",e.resize,e)}).otherwise(function(e){console.warn(e.stack)})},reload:function(){this.render()},resize:function(e){this.$el.height(e),m.call(this),this.$el.find(h.common.scrollContainer).length>0&&this.$el.find(h.common.scrollContainer).data("go.todo.scroller").resizeScroll()},remove:function(){t.EventEmitter.off("todo","resize:column",this.resize),e.View.prototype.remove.apply(this,arguments)},_loadMore:function(){var e=this.__page__+1,n=this;this.collection.getPageList(e,this.__pageSize__).then(function(e){if(e.length>0)_.each(y(e),function(e){n.$el.find(h.detail.timelineContents).append(d(e))}),++n.__page__;else{var r=l["\ud0c0\uc784\ub77c\uc778 \uc5c6\uc74c \uba54\uc2dc\uc9c0"];t.util.isMobile()?window.alert(r):$.goSlideMessage(l["\ud0c0\uc784\ub77c\uc778 \uc5c6\uc74c \uba54\uc2dc\uc9c0"])}})},close:function(){this.remove(),this.onClose()},_close:function(e){e.preventDefault(),this.close()}});return v});