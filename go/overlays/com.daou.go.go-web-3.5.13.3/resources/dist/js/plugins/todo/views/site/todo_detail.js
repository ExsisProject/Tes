define("todo/views/site/todo_detail",["backbone","app","when","todo/constants","todo/models/todo","todo/models/todo_category","todo/models/todo_item","todo/models/todo_items","todo/views/site/todo_column","todo/views/site/board_timeline","todo/views/extensions/burnup_chart/main","todo/views/extensions/calendar","todo/views/menus/main","hgn!todo/templates/todo_detail","todo/libs/util","todo/libs/scroll","i18n!nls/commons","i18n!todo/nls/todo","jquery.go-validation","jquery.go-popup"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g){function w(e,t){if(this.extensionView){var n=this.extensionView.name;this.extensionView.close();if(n===e.prototype.name)return}this.$el.find(y.detail.boardContainer).hide(),this.extensionView=e.attachTo(this.$el,t||{}),this.extensionView.resize(D.call(this)),this.subViews.push(this.extensionView)}function E(){this.extensionView=null,this.$el.find(y.detail.boardContainer).show()}function S(){this.extensionView=null,this.$el.find(y.detail.boardContainer).show(),L()}function x(e,t,n){return d.callActionForOwner(e,t,n)}function T(e,t,n){return d.callActionForMember(e,t,n)}function N(){var e=this;this.timelineView?this.timelineView.close():(this.timelineView=new f({todoModel:this.model,onClose:function(){e.timelineView=null}}),$(".go_body").append(this.timelineView.el),this.timelineView.resize(this.__layout__.getContentPageHeight()),this.timelineView.render(),this.subViews.push(this.timelineView))}function C(){var e=this.model.getCategories(),t=[];_.each(e,function(e){var n=F.call(this,new s(e));t.push(n.el)},this),$.fn.prepend.apply($(y.detail.boardContent),t),I(),L()}function k(){var e=this;P.call(this),this.listenTo(this.__layout__,"resize:content",function(t){M.call(e,t),P.call(e),O.call(e),H.call(e),L(t)})}function L(e){GO.EventEmitter.trigger("todo","resize:column",e)}function A(){v.attachTo(this.$el.find(y.common.scrollContainer),{bounces:GO.util.isMobile()})}function O(){this.$el.find(y.common.scrollContainer).each(function(e,t){$(t).data("go.todo.scroller")&&$(t).data("go.todo.scroller").resizeScroll()})}function M(e){var t=e?e:this.__layout__.getContentPageHeight();this.$el.height(t)}function D(){var e=this.$el.height(),t=this.$el.find(".content-header").outerHeight();return e-t-this.scrollWidth}function P(){$(y.detail.boardContent).height(D.call(this))}function H(){if(!this.extensionView)return;this.extensionView.resize(D.call(this))}function B(e,t){e.isFavorite()?t.removeClass("ic_star_off").addClass("ic_star"):t.removeClass("ic_star").addClass("ic_star_off")}function j(e,t){e.isPublic()?t.removeClass("ic_private").addClass("ic_public").attr("title",m["\uacf5\uac1c"]):t.removeClass("ic_public").addClass("ic_private").attr("title",m["\ube44\uacf5\uac1c"])}function F(e){var t=new a({model:e,todoModel:this.model,todoItemList:this.todoItemList,width:this.options.columnWidth});return this.subViews.push(t),t}function I(){var e=0;$(y.detail.boardContent).find(y.detail.columnContainer).each(function(t,n){var r=$(n).outerWidth(!0);e+=r}),$(y.detail.boardContent).width(e)}function q(){var e=this.model,t=this;if(!this.model.isMember(GO.session("id")))return void 0;z.call(this),W.call(this)}function U(e,t){var n=$(t).clone();return $(y.detail.boardContainer).append(n),n.hide(),setTimeout(function(){R&&(n.appendTo("body"),n.show())},1),R=!0,n}function z(){var e=this.model;$(y.detail.boardContent).sortable({items:y.detail.todoColumn,handle:"header",helper:U,stop:function(t,n){var r=n.item.parent(),i=[];r.find(y.detail.todoColumn).each(function(e,t){var n=$(t).data("categoryid");i.push(n)}),e.reorderCategories(i).then(function(e){}),R=!1}})}function W(){$(y.detail.cardContainer).sortable({items:y.detail.todoCard,connectWith:y.detail.cardContainer,helper:U,start:function(e,t){$("body").scrollParent()},over:function(e,t){L()},stop:function(e,t){var n=t.item,r=n.closest(y.detail.cardContainer),i=n.closest(y.detail.columnContainer).data("categoryid"),s=n.data("view"),o=0;s&&(o=V(r.find(y.detail.todoCard),s.getItemId()),s.updatePosition(i,o).then(function(){J(r.find(y.detail.todoCard)),L()})),R=!1},remove:function(e,t){var n=t.item,r=$(this).closest(y.detail.columnContainer).data("view");X(t.item,r)}})}function X(t,n){n instanceof e.View&&n.takeOutCardView(t.data("view"))}function V(e,t){return d.searchCardSeq(e,t)}function J(e){return d.syncCardSeqs(e)}function K(e){var t=e.attr("data-type");t==="button"?(e.removeClass("column_create_wrap"),e.find(y.detail.columnAddButton).hide(),e.find(y.detail.columnAddForm+" input:text").val(""),e.find(y.detail.columnAddForm).show(),e.attr("data-type","form")):(e.addClass("column_create_wrap"),e.find(y.detail.columnAddButton).show(),e.find(y.detail.columnAddForm).hide(),e.attr("data-type","button"))}var y=r.SELECTORS,b;b=e.View.extend({className:"content_page",__layout__:null,template:p,subViews:[],options:{},timelineView:null,extensionView:null,events:{"click .btn-add-column":"_toggleAddButton","click .btn-favorite":"_toggleFavorite","click .btn-public-status":"_callPublicOptionMenu","click .btn-board-menu":"_callBoardMenu","click .ui-column-add-form .btn-save":"_reqAddColumn","submit form[name=form_column_add]":"_reqAddColumn","click .ui-column-add-form .btn-cancel":"_toggleAddButton","click .ui-todo-title":"_callBoardTitleMenu","click .btn-open-calendar":"_openCalendar","click .btn-open-stat":"_openStatistic","click .btn-open-timeline":"_openTimeline"},initialize:function(e){this.options=_.extend({},{useToolbar:!0,useCustomScroll:!0,columnWidth:null},e||{}),this.__layout__=this.options.layout,this.todoItemList=u.newFromTodo(this.model),this.scrollWidth=v.detectScrollWidth(),M.call(this)},render:function(){var e=this.todoItemList,t=this;return t.subViews=[],this.setTheme(),this.$el.empty().append(this.template({title:GO.util.unescapeHtml(this.model.get("title")),"public?":this.model.isPublic(),"favorite?":this.model.isFavorite(),"useToolbar?":this.options.useToolbar,"editable?":this.model.isMember(GO.session("id")),"owner?":this.model.isOwner(GO.session("id")),attr_title_public:this.model.isPublic()?m["\uacf5\uac1c"]:m["\ube44\uacf5\uac1c"],attr_title_favorite:this.model.isFavorite()?g["\uc990\uaca8\ucc3e\uae30 \ud574\uc81c"]:g["\uc990\uaca8\ucc3e\uae30 \ucd94\uac00"],label:{"public":m["\uacf5\uac1c"],"private":m["\ube44\uacf5\uac1c"],timeline:g["\ud0c0\uc784\ub77c\uc778"],columnAdd:g["\uce7c\ub7fc \ucd94\uac00"],save:m["\uc800\uc7a5"],cancel:m["\ucde8\uc18c"],stat:g["\ud1b5\uacc4"],calendar:m["\uce98\ub9b0\ub354"]}})),e.getFilteredList().then(function(e){return k.call(t),C.call(t),A.call(t),q.call(t),t}).otherwise(function(e){console.log(e.hasOwnProperty("stack")?e.stack:e.message)})},delegateEvents:function(){e.View.prototype.delegateEvents.apply(this,arguments),GO.EventEmitter.on("todo","go.todo.detail.clearlayers",this.clearLayers,this)},undelegateEvents:function(){e.View.prototype.undelegateEvents.apply(this,arguments),GO.EventEmitter.off("todo","go.todo.detail.clearlayers")},clearLayers:function(){this.timelineView&&this.timelineView.remove(),$(document).trigger("go.todo.clearmenu")},remove:function(){GO.util.isMobile()?(this.stopListening(),this.$el.empty(),this.$el.removeAttr("style")):e.View.prototype.remove.apply(this,arguments),_.each(this.subViews,function(e){e&&e.remove&&e.remove()})},setTheme:function(){var e=this.model.get("themeNo");return e<1&&(e=1),this.__layout__.setTheme(e),this},changeTheme:function(){},getTodoModel:function(){return this.model},getTodoItemModel:function(e){return this.todoItemList.get(e)},_toggleAddButton:function(e){var t=this.$el.find(y.detail.addCloumnContainer),n=this;e.preventDefault(),T.call(this,this.model,e,function(e){K.call(n,t)})},_reqAddColumn:function(e){var n,r=this.$el.find(y.detail.addCloumnContainer),i=this;e.preventDefault(),T.call(this,this.model,e,function(e){n=i.$el.find(y.detail.columnAddForm+" input[name=title]").val();if(!$.goValidation.isCheckLength(1,1e3,n))return $.goMessage(t.i18n(m["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:1,arg2:1e3})),$(y.detail.columnAddForm+" input[name=title]").focus(),!1;i.model.addCategory(n).then(function(e){var t=F.call(i,e);r.before(t.el),K.call(i,r),v.attachTo(t.$el.find(y.common.scrollContainer)),q.call(i),I()})})},_toggleFavorite:function(e){var t=$(e.currentTarget),n=this.model.isFavorite()?"removeFavorite":"addFavorite",r=this;e.preventDefault(),this.model[n].call(this.model).then(function(e){var n=r.__layout__.collections.favoriteTodoList;e.isFavorite()?(n.add(e),t.find("ins").prop("title",g["\uc990\uaca8\ucc3e\uae30 \ud574\uc81c"])):(n.remove(e),t.find("ins").prop("title",g["\uc990\uaca8\ucc3e\uae30 \ucd94\uac00"])),B(e,t.find("ins"))})},_callPublicOptionMenu:function(e){var t=$(e.currentTarget),n=t.find(".ic_board"),r=this;e.preventDefault(),x.call(this,this.model,e,function(e){h.attachTo(t,new h.PublicOptionMenuView({model:r.model,afterSave:function(e){j(e,n)}}))})},_callBoardTitleMenu:function(e){var t=$(e.currentTarget),n=this;e.preventDefault(),x.call(this,this.model,e,function(e){h.attachTo(t,new h.BoardTitleMenuView({model:n.model,afterSave:function(e){t.html(e.get("title"))}}))})},_callBoardMenu:function(e){var t=$(e.currentTarget);e.preventDefault(),h.attachTo(t,new h.BoardActionMenuView({model:this.model}))},_openTimeline:function(e){e.preventDefault(),N.call(this)},_openStatistic:function(e){var t=this;e.preventDefault(),w.call(this,l,{todoModel:this.model,height:D.call(this),onClose:function(){S.call(t)}})},_openCalendar:function(e){var t=this;e.preventDefault(),w.call(this,c,{todoModel:this.model,todoItemList:this.todoItemList,height:D.call(this),onClose:function(){S.call(t)}})}},{attachToLayout:function(e,t,r){var s=n.defer();return i.getBoard(t).then(function(t){var n,i=_.extend({model:t,layout:e},r||{});e.buildContentView?n=e.buildContentView(b,i):(n=new b(i),e.setContent(n)),n.render().then(s.resolve,s.reject)},s.reject),s.promise}});var R=!1;return b});