define("todo/views/site/todo_card",["backbone","app","todo/views/menus/main","todo/views/site/card_detail","todo/models/todo_category","todo/libs/util","hgn!todo/templates/todo_card","text!todo/templates/partials/_user_thumbnail.html","libs/go-utils","i18n!todo/nls/todo","i18n!nls/commons"],function(e,t,n,r,i,s,o,u,a,f,l){function h(){return this.model.hasContent()||this.model.hasComments()||this.model.hasFiles()||this.model.hasChecklists()||!!this.model.get("dueDate")}var c;return c=e.View.extend({className:"board_card",template:o,todoModel:null,onRemoved:function(){},events:{click:"_callCardDetail","click .btn-card-action":"_callCardActionMenu"},initialize:function(e){e=e||{},this.todoModel=e.todoModel,e.hasOwnProperty("onRemoved")&&_.isFunction(e.onRemoved)&&(this.onRemoved=e.onRemoved),this.$el.data("view",this),this.$el.addClass("ui-todocard ui-todocard-"+this.model.id),this.$el.attr("data-itemid",this.model.id),this.render(),this.listenTo(this.todoModel,"change:members",this.fetch),this.listenTo(this.model,"change:title",this.reload),this.listenTo(this.model,"change:labels",this.reload),this.listenTo(this.model,"change:members",this.reload),this.listenTo(this.model,"change:dueDate",this.reload),this.listenTo(this.model,"change:attaches",this.reload),this.listenTo(this.model,"change:checklists",this.reload),this.listenTo(this.model,"change:content",this.reload),this.listenTo(this.model,"change:commentCount",this.reload),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"moved",this.move)},render:function(e){var n=this.model.get("dueDate"),r=this.model.getChecklistItemCount(),i=this.model.getChecklistCheckedItemCount();this.$el.empty().append(this.template({title:t.util.escapeHtml(this.model.get("title")),model:this.model.toJSON(),"editable?":this.todoModel.isMember(t.session("id")),featureImage:this.model.getFeatureImage(),attach_count:this.model.getFileCount(),"hasMembers?":this.model.hasMembers(),"hasMetadata?":h.call(this),"hasLabels?":this.model.hasLabels(),"hasImages?":this.model.hasImages(),"hasComments?":this.model.hasComments(),"hasAttaches?":this.model.hasFiles(),"hasContent?":this.model.hasContent(),"hasChecklists?":this.model.hasChecklists(),checklistItemCount:r,checklistCheckedItemCount:i,attachCountStatus:t.i18n(f["\ud30c\uc77c\uac1c\uc218 \uc11c\uc220\uc2dd \ud45c\ud604"],{arg1:this.model.getFileCount()}),commentCountStatus:t.i18n(f["\ub313\uae00\uac1c\uc218 \uc11c\uc220\uc2dd \ud45c\ud604"],{arg1:this.model.getCommentCount()}),duedateStatus:t.i18n(f["\uae30\ud55c\uc77c \uc11c\uc220\uc2dd \ud45c\ud604"],{arg1:n?moment(n).format(f["\uae30\ud55c\ub144\uc6d4\uc77c\uc2dc \ud3ec\ub9f7"]):""}),checklistStatus:t.i18n(f["\uccb4\ud06c\ub9ac\uc2a4\ud2b8 \uc11c\uc220\uc2dd \ud45c\ud604"],{arg1:r,arg2:i}),due_date:n?moment(n).format(f["\uae30\ud55c\uc77c \ud3ec\ub9f7"]):!1,"delayed?":this.model.isDelayed(),label:{more:l["\ub354\ubcf4\uae30"],showDesc:f["\uc0c1\uc138\ub0b4\uc6a9 \ubcf4\uae30"]},useMobilePreview:GO_config.__config__.mobileConfig.useMobilePreview,isMobile:t.util.isMobile()},{_user_thumbnail:u}))},fetch:function(){var e=$.Deferred(),t=this;return this.model.fetch({success:function(){t.reload(),e.resolve()}}),e},reload:function(){this.render(),t.EventEmitter.trigger("todo","resize:column")},remove:function(){e.View.prototype.remove.apply(this,arguments),this.onRemoved(this),t.EventEmitter.trigger("todo","resize:column")},move:function(n,r){var i=$("#column-content-"+n),o=i.find(".ui-todocard"),u=this.$el.closest(".ui-todocolumn"),a=u.data("view"),f=parseInt(u.data("categoryid")),l=s.searchCardSeq(o,this.$el.data("itemid"));if(f===n){var c=o.get(r);r<l?$(c).before(this.$el):r>l&&$(c).after(this.$el)}else{if(o.length>0)if(o.length===r){var c=o.last();$(c).after(this.$el)}else{var c=o.get(r);$(c).before(this.$el)}else i.append(this.$el);a instanceof e.View&&a.takeOutCardView(this)}s.syncCardSeqs(i.find(".ui-todocard")),t.EventEmitter.trigger("todo","resize:column")},updatePosition:function(e,t){return this.model.move(e,t)},getItemId:function(){return this.model.id},getSeq:function(){return this.model.get("seq")},setSequence:function(e){this.model.set("seq",parseInt(e))},_callCardDetail:function(e){var t=this;this.fetch().done(function(){r.create(t.todoModel,t.model)})},_callCardActionMenu:function(e){var t=$(e.currentTarget),r=this;e.preventDefault(),s.callActionForMember(this.todoModel,e,function(e){n.attachTo(t,new n.CardActionMenuView({model:r.model,todoModel:r.todoModel}))}),e.stopPropagation()}}),c});