define(["backbone","app","todo/views/menus/main","todo/libs/util","hgn!todo/templates/board_card","hgn!todo/templates/partials/_card_add_button","text!todo/templates/partials/_user_thumbnail.html","i18n!todo/nls/todo","i18n!nls/commons","i18n!board/nls/board","jquery.ui","jquery.go-validation","jquery.go-popup"],function(e,t,n,r,i,s,o,u,a){function v(){var e=this;this.$el.find(".ui-favorite-board .ui-board-list").sortable({items:".ui-todo-card",containment:"document",stop:function(t,n){var r=n.item.parent(),i=[];r.find("li.ui-todo-card").each(function(e,t){var n=$(t).data("view");i.push(n.getTodoId())}),e.favoriteTodoList.reorder(i).then(function(t){e.favoriteTodoList.trigger("resort")}).otherwise(function(e){console.log(e)})}})}function m(e){e.prepend(g.call(this,"favorite",u["\uc990\uaca8\ucc3e\ub294 \ubcf4\ub4dc"],this.favoriteTodoList).addClass("ui-favorite-board"))}function g(e,t,n){var r=$('<div class="wrap_todo_board"></div>'),i=[];return i.push('<h1 class="s_title"><span class="txt">'+t+"</span></h1>"),r.append(i.join("\n")),r.append(w.call(this,e,n)),e==="my"&&r.find(".ui-board-list").append(y(b())),r}function y(e,t){var n=[];return n.push("<li"+(t?' class="'+t+'"':"")+">"),n.push(e),n.push("</li>"),n.join("\n")}function b(){return s({buttonTitle:u["\ubcf4\ub4dc \ucd94\uac00"]})}function w(e,t){var n=$('<ul class="ui-board-list list_todo_board"></ul>'),r={my:h,favorite:p}[e],i=[];return t.each(function(e){var t=new r({model:e,favoriteTodoList:this.favoriteTodoList});i.push(t.el)},this),n.append.apply(n,i),n}var f={copy_url:a["URL \ubcf5\uc0ac"]},l,c=n.CreateTodoMenuView,h,p,d;return d=c.extend({tagName:"span",className:"todo_board",initialize:function(e){this.myTodoList=e.myTodoList,c.prototype.initialize.call(this,e),this.render()},_confirm:function(e){var n=this,i=this.$el.find("input[name=title]").val();if(!$.goValidation.isCheckLength(1,1e3,i))return $.goMessage(t.i18n(a["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:1,arg2:1e3})),this.$el.find("input[name=title]").focus(),!1;e.preventDefault(),r.promiseModelSave(this.model,{title:i}).then(function(e){n.$el.closest("li").remove(),n.remove(),n.myTodoList.add(e),GO.router.navigate("todo/"+e.id,{trigger:!0,pushState:!0})}).otherwise(function(e){console.log(e.stack)})},_cancel:function(e){e.preventDefault(),this.$el.replaceWith(b()),this.remove()}}),h=e.View.extend({tagName:"li",className:"ui-todo-card",template:i,favoriteTodoList:null,events:{"click .btn-star":"_toggleFavorite","click .btn-board":"_navigate","click .btn-go-url-copy":"copyUrl"},initialize:function(e){this.favoriteTodoList=e.favoriteTodoList,this.$el.data("view",this),this.$el.addClass("ui-todo-"+this.model.id),this.render(),this.listenTo(this.model,"change:favoriteFlag",this.changeFavorite)},render:function(){this.$el.empty().append(this.template({"favorite?":this.model.isFavorite(),"private?":this.model.isPrivate(),title:GO.util.escapeHtml(this.model.get("title")),members:this.model.get("members"),directUrl:this.directUrl(),attr_title_favorite:this.model.isFavorite()?u["\uc990\uaca8\ucc3e\uae30 \ud574\uc81c"]:u["\uc990\uaca8\ucc3e\uae30 \ucd94\uac00"],attr_title_public:this.model.isPublic()?a["\uacf5\uac1c"]:a["\ube44\uacf5\uac1c"],lang:f},{_user_thumbnail:o}))},changeFavorite:function(e){this.render()},getTodoId:function(){return this.model.id},_toggleFavorite:function(e){var t=this.model.isFavorite()?"removeFavorite":"addFavorite",n=this;e.preventDefault(),this.model[t].call(this.model).then(function(e){e.isFavorite()?n.favoriteTodoList.add(e):n.favoriteTodoList.remove(e.id)})},_navigate:function(e){e.preventDefault();if($(e.target).is(".btn-star")||$(e.target).parents(".btn-star").length>0)return!1;GO.router.navigate("todo/"+this.model.id,{pushState:!0,trigger:!0})},directUrl:function(){var e=GO.router.getRootUrl();return e+="todo/"+this.model.id,e},copyUrl:function(e){function n(e){var t=[GO.router.getRootUrl(),GO.router.getUrl(),"/",e].join("");return console.log(t),t}e.preventDefault(),e.stopPropagation();var t=document.createElement("textarea");document.body.appendChild(t),t.value=n(this.model.id),t.select(),document.execCommand("copy"),document.body.removeChild(t);try{GO.util.checkOS()=="android"?window.GOMobile.copyUrl(t.value):window.location="gomobile://copyUrl?"+t.value}catch(e){console.log(e)}}}),p=h.extend({changeFavorite:function(e){e.isFavorite()||this.remove()}}),l=e.View.extend({className:"content_page",myTodoList:null,favoriteTodoList:null,events:{"click .btn-add-board":"_callNewBoardDialog"},initialize:function(e){this.myTodoList=e.myTodoList,this.favoriteTodoList=e.favoriteTodoList,this.listenTo(this.myTodoList,"add",this.addBoard),this.listenTo(this.favoriteTodoList,"add",this.addFavorite),this.listenTo(this.favoriteTodoList,"remove",this.removeFavorite),this.listenTo(this.favoriteTodoList,"resort",this.resortFavorite)},render:function(){var e=$('<div class="wrap_todo"></div>');this.favoriteTodoList.length>0&&m.call(this,e),e.append(g.call(this,"my",u["\ub0b4 \ubcf4\ub4dc"],this.myTodoList).addClass("ui-my-board my_board")),this.$el.empty().append(e),v.call(this),GO.util.pageDone&&GO.util.pageDone(),GO.util.appLoading(!1)},remove:function(){GO.util.isMobile()?(this.stopListening(),this.$el.empty()):e.View.prototype.remove.apply(this,arguments)},resortFavorite:function(){this.$el.find(".ui-favorite-board .ui-board-list").replaceWith(w.call(this,"favorite",this.favoriteTodoList)),v.call(this)},addBoard:function(e){var t=new h({model:e,favoriteTodoList:this.favoriteTodoList});this.$el.find(".ui-my-board .ui-board-list").append(t.el,y(b()))},addFavorite:function(e){if(this.$el.find(".ui-favorite-board").length>0){var t=new p({model:e,favoriteTodoList:this.favoriteTodoList});this.$el.find(".ui-favorite-board .ui-board-list").append(t.el)}else m.call(this,this.$el.find(".wrap_todo"));v.call(this)},removeFavorite:function(e){this.favoriteTodoList.length>0||this.$el.find(".ui-favorite-board").remove()},_callNewBoardDialog:function(e){var t=$(e.currentTarget),n=new d({myTodoList:this.myTodoList});e.preventDefault(),t.replaceWith(n.el)}},{create:function(e,t){return new l({myTodoList:e,favoriteTodoList:t})}}),l});