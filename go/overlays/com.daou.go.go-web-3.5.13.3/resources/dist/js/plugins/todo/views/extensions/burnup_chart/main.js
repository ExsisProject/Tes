define("todo/views/extensions/burnup_chart/main",function(require){function d(){var e=this.todoModel.id,t=_.pluck(this.todoModel.getCategories(),"id");s.hasTodoId(e)?s.set(e,_.intersection(s.get(e),_.union(t,[0]))):s.set(e,t.pop())}function v(e){var t=this.todoModel.getCategory(e)||{};return S(e)&&(t.title=u["\uc804\uccb4"]),t}function m(){var e=this.todoModel,t=s.get(e.id),n=[],r=this;_.each(t,function(e){var t=v.call(this,e);n.push({id:e,title:GO.util.unescapeHtml(t.title),options:{removable:!0}})},this),this.nameTagListView=f.create(n||[],{useAddButton:!1,useMarker:!0}),this.$el.find(".selected-column-list").append(this.nameTagListView.el),this.nameTagListView.$el.on("nametag:removed",function(t,n,i){o.clear(),s.remove(e.id,n),r.isDirty=!0,b.call(r)})}function g(e,t){var n=v.call(this,t);if(!this.nameTagListView)return;e?this.nameTagListView.addTag(t,GO.util.unescapeHtml(n.title),{removable:!0}):this.nameTagListView.removeTag(t)}function y(){var e=this.$el.height(),t=this.$el.find(".todo_statistic_opt").outerHeight();return e-t-30}function b(){var e=this;if(!this.isDirty){w.call(this);return}this.collection.getFilteredData(this.startDate,this.endDate,_.without(s.get(this.todoModel.id),0)).then(function(){w.call(e),e.isDirty=!1})}function w(){var e=this.$el.find("[data-chart-placeholder]"),t=E.call(this),n=[];e.height(y.call(this)),_.each(t,function(e,t){if(t!=="total"){var r=this.nameTagListView.getNameTag(t);n.push(r.data("marker"))}},this),this.__plotObj=$.plot(e,_.values(t),{series:{lines:{show:!0},points:{show:!0}},legend:{show:!1},xaxis:{ticks:T.call(this)},yaxis:{min:0,tickDecimals:0},selection:{mode:"x"},grid:{hoverable:!0,clickable:!0},colors:n}),C.call(this)}function E(){function f(e,t){var n=0;return e&&(S(t)?n=e.get("totalCount"):e.get("evaluatedMap")[t]&&(n=e.get("evaluatedMap")[t])),n}function l(){var e={},t=s.get(this.todoModel.id);return _.each(t,function(t){var n=S(t)?a["\uc804\uccb4\uce74\ub4dc\uc218"]:this.todoModel.getCategory(t).title;e[t]={label:n,data:[]}},this),e}var e=this.startDate.clone(),t=this.endDate.clone(),n=e,r=l.call(this),i=s.get(this.todoModel.id),o=0;while(n.isBefore(t)){var u=this.collection.findWhere({date:n.format("YYYYMMDD")});_.each(i,function(e){var t=f(u,e);r[e].data.push([o,t])}),this.tootipData.push(n.format("MM/DD")),n.add(1,"day"),o++}return r}function S(e){return e==0}function x(){var e=this,n=this.startDate.toDate(),r=this.endDate.toDate(),i=this.$el.find("#start-date"),s=this.$el.find("#end-date");$.datepicker.setDefaults($.datepicker.regional[GO.config("locale")]),i.val(this.startDate.format(h)).datepicker({defaultDate:n,maxDate:t(new Date).add(-1,"day").format(h),changeMonth:!0,changeYear:!0,yearRange:"-1:+0",numberOfMonths:1,dateFormat:"yy-mm-dd",yearSuffix:"",onSelect:function(t){s.datepicker("option",{minDate:t,maxDate:L(t,s.val()).format(h)}),k.call(e,t,s.val())}}),s.val(this.endDate.format(h)).datepicker({defaultDate:r,minDate:n,maxDate:L(this.startDate.format(h),this.endDate.format(h)).format(h),changeMonth:!0,changeYear:!0,yearRange:"+0:+1",numberOfMonths:1,yearSuffix:"",onSelect:function(t){k.call(e,i.val(),t)}})}function T(){var e=this.startDate,t=this.endDate,n=t.diff(e,"day"),r=e.clone(),i=[],s=0;while(r.isBefore(t)){var o=r.format("MM/DD");n>7&&s%7!==0&&s!==n&&(o=""),i.push([s,o]),r.add(1,"day"),s++}return i}function N(e,t,n){var r=_.extend({},{position:"absolute",display:"none",top:n,border:"2px solid #4572A7",padding:"2px 10px",size:"10","background-color":"#fff",opacity:.8});$("."+p.tooltip).remove(),$('<div class="'+p.tooltip+'">'+e+"</div>").css(r).appendTo("body");var i=$(window).width(),s=$("."+p.tooltip).outerWidth(),o={};s+t>i?o.right=Math.abs(i-t):o.left=t,$("."+p.tooltip).css(o).fadeIn(200)}function C(){var e=this,t=null;this.$el.on("plothover",function(n,r,i){if(i){if(t!=i.dataIndex){var s=i.datapoint[0],o=i.datapoint[1],u="<strong>"+o+"</strong> ("+i.series.label+")"+"<br>"+e.tootipData[i.dataIndex];N(u,i.pageX,i.pageY),t=i.dataIndex}}else $("."+p.tooltip).remove(),t=null})}function k(e,n){var r=t(e),i=A(e,n);this.startDate=r,this.endDate=A(e,n),this.$el.find("#start-date").val(r.format(h)),this.$el.find("#end-date").val(i.format(h)),this.isDirty=!0,b.call(this)}function L(e,n){var r=t(e).add(c,"month").endOf("day"),i=t().endOf("day");return r.isAfter(i)&&(r=i),r}function A(e,n){var r=t(e).clone().startOf("d"),i=t(n).clone().endOf("d"),s=i;return i.isAfter(new Date)&&(s=t().endOf("day")),i.diff(r,"month")>c&&(s=r.clone().add(c,"month")),i.isBefore(r)&&(s=r.clone().add(i.diff(r,"days"),"day")),s}var e=require("backbone"),t=require("moment"),n=require("todo/models/todo_burnup_list"),r=require("todo/views/extensions/base"),i=require("hgn!todo/templates/extensions/extension_burnupchart"),s=require("todo/views/extensions/burnup_chart/column_store"),o=require("todo/views/extensions/burnup_chart/select_column_menu"),u=require("i18n!nls/commons"),a=require("i18n!todo/nls/todo"),f=require("go-nametags");require("go-ignoreduplicatemethod"),require("go-charts"),require("jquery.ui"),require("GO.util");var l,c=6,h="YYYY-MM-DD",p={tooltip:"flot-tooltip"};return l=r.extend({id:"burnup_chart_view_id",name:"todo-burnupchart-view",className:"view_type view_todo_statistic",todoModel:null,startDate:null,endDate:null,template:i,isDirty:!0,tootipData:[],nameTagListView:null,events:function(){var e=r.prototype.events||{};return _.extend({},e,{"click .btn-add-column":"_toggleSelectColumnMenu"})},initialize:function(e){var i=e||{};r.prototype.initialize.call(this,i),this.todoModel=i.todoModel,this.collection||(this.collection=new n({todoId:this.todoModel.id})),this.startDate=t().subtract("d","30").startOf("d"),this.endDate=t().endOf("d"),this.__plotObj=null,d.call(this)},render:function(){this.setContent(this.template({label:{add_column:a["\uce7c\ub7fc \ucd94\uac00"]}})),x.call(this),m.call(this),b.call(this)},resize:function(e){r.prototype.resize.call(this,e-20),o.clear(),b.call(this)},_toggleSelectColumnMenu:function(e){var t=this;e.preventDefault(),o.toggle($(e.currentTarget),{model:this.todoModel,onClicked:function(e){var n=parseInt(e.val());g.call(t,e.prop("checked"),n),t.isDirty=!0,b.call(t)}})}}),l});