define("todo/models/todo_item",["when","moment","app","todo/models/base","todo/models/todo_checklist","todo/models/todo_activities","todo/libs/util","libs/go-utils"],function(e,t,n,r,i,s,o,u){function l(e){return[_.result(this,"urlRoot"),this.id,"label",e].join("/")}function c(e){return[_.result(this,"urlRoot"),this.id,"member",e].join("/")}function h(e){return i.newFromTodoItem(this,this.getChecklist(e))}function p(e,t){var n=[];return typeof t=="undefined"&&(t=!0),_.each(this.getChecklists(),function(t){n.push(t.id===e.id?e.toJSON():t)}),this.set("checklists",n),t&&this.trigger("change:checklists"),n}function d(e){var t=this.getChecklists(),n=e.id;return _.map(t,function(e){e.checklistItems=_.reject(e.checklistItems,function(e){return e.id===n})}),_.map(t,function(t){if(t.id===e.checklistId){var n=t.checklistItems;_.map(n,function(t,n){t.seq>=e.seq&&++t.seq}),n.push(e),n=_.sortBy(n,function(e){return e.seq})}}),this.set("checklists",t),this.trigger("change:checklists"),t}var a,f=1e3;return a=r.Model.extend({todoModel:null,activities:null,defaults:{seq:0,deleteFlag:"N"},initialize:function(e,t){t=t||{},r.Model.prototype.initialize.apply(this,arguments),this.activities=s.newForTodoItem(this),t.todoModel&&(this.todoModel=t.todoModel,this.listenTo(this.todoModel,"change:labels",this._syncLabels))},validate:function(e,t){if(e.title&&e.title.length>f)return o.createResponseError(400,"Bad Request","Invalid Title")},urlRoot:function(){return n.config("contextRoot")+"api/todo/"+this.get("todoId")+"/item"},updateAttributes:function(t,r){var i=this,s=e.defer(),o={success:s.resolve,error:function(e,t,r){if(t.responseJSON.name=="DuplicateRequestException"){var o=t.responseJSON.message.split(".");$.goAlert(o[0],o[1],function(){n.router.navigate("todo/"+i.todoModel.get("id"),{trigger:!0,pushState:!0})})}t.responseJSON.code==404&&t.responseJSON.name=="todo.not.found.element"&&$.goSlideMessage(t.responseJSON.message,"caution"),s.reject(t)}},i=this;return r&&(o.url=r),this.save(t,o),s.promise},move:function(t,n){var r=[_.result(this,"urlRoot"),this.id,"move"].join("/"),i=this;return this.get("todoCategoryId")===parseInt(t)&&this.get("seq")===parseInt(n)?e.resolve(this):this.updateAttributes({todoCategoryId:t,seq:n},r).then(function(t){return i.todoModel.trigger("reorder:item"),e.resolve(t)})},updateTitle:function(e){return this.updateAttributes({title:e})},updateContent:function(e){return this.updateAttributes({content:e})},updateDueDate:function(e){return this.updateAttributes({dueDate:n.util.toISO8601(e)},[_.result(this,"urlRoot"),this.id,"duedate"].join("/"))},removeDueDate:function(){return this.updateAttributes({dueDate:null},[_.result(this,"urlRoot"),this.id,"duedate"].join("/"))},remove:function(){var t=e.defer(),r=this;return this.destroy({data:JSON.stringify(this.toJSON()),dataType:"json",contentType:"application/json",success:t.resolve,error:function(e,i,s){if(i.responseJSON.name=="DuplicateRequestException"){var o=i.responseJSON.message.split(".");$.goAlert(o[0],o[1],function(){n.router.navigate("todo/"+r.todoModel.get("id"),{trigger:!0,pushState:!0})})}t.reject(i)}}),t.promise},addLabel:function(t){var n=this.get("labels")||[],r=this;return this.hasLabel(t)?e.resolve(this):o.promiseAsync(l.call(this,t),{type:"POST"}).then(function(t){return n.push(t),r.set("labels",n),r.trigger("change:labels",r),e.resolve(r)})},removeLabel:function(t){var n=this.get("labels")||[],r=this;return this.hasLabel(t)?o.promiseAsync(l.call(this,t),{type:"DELETE"}).then(function(i){var s=_.reject(n,function(e){return e.id===t});return r.set("labels",s),e.resolve(r)}):e.reject(o.createResponseError(404,"Not Found"))},addMember:function(t){var n=this.getMembers(),r=this;return this.hasMember(t)?e.resolve(this):o.promiseAsync(c.call(this,t),{type:"POST"}).then(function(t){return n.push(t),r.set("members",n),r.trigger("change:members",r),e.resolve(r)})},removeMember:function(t){var n=this.getMembers(),r=this;return o.promiseAsync(c.call(this,t),{type:"DELETE"}).then(function(i){var s=_.reject(n,function(e){return e.id===t});return r.set("members",s),r.trigger("change:members",r),e.resolve(r)})},hasLabel:function(e){return _.where(this.get("labels")||[],{id:e}).length>0},hasLabels:function(){return(this.get("labels")||[]).length>0},getMembers:function(){return this.get("members")||[]},hasMember:function(e){return _.where(this.getMembers(),{id:e}).length>0},hasMembers:function(){return this.getMembers().length>0},getFiles:function(){return this.get("attaches")||[]},hasFile:function(e){return _.where(this.getFiles(),{id:e}).length>0},hasFiles:function(){return this.getFileCount()>0},hasDuedate:function(){return!!this.get("dueDate")},getFileCount:function(){return this.getFiles().length},getFile:function(e){return _.findWhere(this.getFiles(),{id:e})},getImages:function(){return _.filter(this.getFiles(),function(e){return u.isImage(e.name)})},getFeatureImage:function(){return _.last(this.getImages())},hasImages:function(){return this.getImages().length>0},hasComments:function(){return this.get("commentCount")>0},getCommentCount:function(){return this.get("commentCount")},hasChecklists:function(){return this.getChecklists().length>0},isDelayed:function(){var e=this.get("dueDate"),n=t().result=!1;return e&&(result=t(e).isBefore(t().startOf("m"))),result},getChecklists:function(){return this.get("checklists")||[]},getChecklistItemCount:function(){var e=this.getChecklists(),t=0;return _.each(e,function(e){t+=e.checklistItems.length}),t},getChecklistCheckedItemCount:function(){var e=o.convertArrayToCollection(this.getChecklists(),i),t=0;return e.each(function(e){t+=e.getCheckedItemCount()}),t},getChecklist:function(e){return _.findWhere(this.get("checklists"),{id:e})},getChecklistItem:function(e,t){var n=this.getChecklist(e);return _.findWhere(n.checklistItems||[],{id:t})},getNextChecklistSeq:function(){return this.getChecklists().length==0?0:this.getChecklists().last().seq+1},createChecklist:function(t){var n=this,r=this.getChecklists();return i.createFromTodoItem(this,t).then(function(t){return r.push(t.toJSON()),n.set("checklists",r),n.trigger("change:checklists"),e.resolve(t)},e.reject)},updateChecklistTitle:function(t,n){var r=h.call(this,t),i=this;return r.updateTitle(n).then(function(t){return p.call(i,t),e.resolve(t)},e.reject)},removeChecklist:function(t){var n=o.convertArrayToCollection(this.getChecklists(),i),r=h.call(this,t),s=this;return r.remove().then(function(){return n.remove(r),s.set("checklists",n.toJSON()),s.trigger("change:checklists"),e.resolve()},e.reject)},addChecklistItem:function(t,n){var r=h.call(this,t),i=this;return r.createItem(n).then(function(t){return p.call(i,r),e.resolve(t)},e.reject)},updateChecklistItemTitle:function(t,n,r){var i=h.call(this,t),s=this;return i.updateItemTitle(n,r).then(function(t){return p.call(s,t),e.resolve(t)},e.reject)},toggleChecklistItem:function(t,n){var r=h.call(this,t),i=this;return r.toggleItem(n).then(function(t){return p.call(i,t),e.resolve(t)},e.reject)},removeChecklistItem:function(t,n){var r=h.call(this,t),i=this;return r.removeItem(n).then(function(){return p.call(i,r),e.resolve()},e.reject)},moveChecklistItem:function(t,n,r,i){var s=h.call(this,t),o=this;return s.moveItem(n,r,i).then(function(t){var i=h.call(o,r);return s.set("checklistItems",_.reject(s.getChecklistItems(),function(e){return e.id===n})),p.call(o,s,!1),i.set("checklistItems",t),p.call(o,i),e.resolve(o)},e.reject)},addFile:function(e){var t=this.get("attaches")||[];return t.push(e),this.set("attaches",t),this.trigger("change:attaches"),this},updateFile:function(t){var n=[_.result(this,"urlRoot"),this.id,"files"].join("/"),r=this;return o.promiseAsync(n,{type:"POST",data:t}).then(function(t){return r.addFile(t),e.resolve(r)},e.reject)},removeFile:function(t){var n=[_.result(this,"urlRoot"),this.id,"file",t].join("/"),r=this.get("attaches")||[],i=this;return this.hasFile(t)?o.promiseAsync(n,{type:"DELETE"}).then(function(){var n=_.filter(r,function(e){return e.id!==t});return i.set("attaches",n),i.trigger("change:attaches"),e.resolve(i)},e.reject):e.reject(o.createResponseError(404,"Not Found"))},_syncLabels:function(){var e=[];_.each(this.get("labels"),function(t){var n=_.findWhere(this.todoModel.get("labels"),{id:t.id});e.push(n)},this),this.set("labels",e)},hasContent:function(){var e=this.get("content");return!!e&&e.length>0}},{newFromTodo:function(e,t){var n;return n=new a(_.extend(t,{todoId:e.id}),{todoModel:e}),n},createFromTodo:function(t,n,r){var i=e.defer(),s;return s=this.newFromTodo(t,{todoCategoryId:n,title:r}),s.save(null,{success:i.resolve,error:function(e,t,n){t.responseJSON.code==404&&t.responseJSON.name=="todo.not.found.element"&&$.goSlideMessage(t.responseJSON.message,"caution"),i.reject(t)}}),i.promise}}),a});