(function(){define(["underscore","backbone","survey/libs/util","helpers/form","survey/models/survey","survey/collections/queries","survey/views/query/edit","attach_file","hgn!survey/templates/query_list","i18n!nls/commons","i18n!survey/nls/survey","file_upload","jquery.ui","jquery.cookie","jquery.go-popup","jquery.go-preloader"],function(e,t,n,r,i,s,o,u,a,f,l,c){function m(){var e=0,t=[];this.$el.find(".query-item").each(function(n,r){var i=$(r).data("view");i.isRemoved()||(t.push(i.model.id),i.updateSeq(++e))});if(t.length==0)return;$.ajax(GO.config("contextRoot")+"api/survey/"+this.model.id+"/query/order",{type:"PUT",data:JSON.stringify({ids:t}),dataType:"json",contentType:"application/json"})}function g(e){e.model.getQueryList({success:function(t){t.each(e.renderQueryPreview,e),e.initSortable()}})}function y(e){e.$el.append(a({guidance:e.model.get("guidance"),label:{quide_text:l["\uc2dc\uc791 \uc548\ub0b4 \ubb38\uad6c"],attach_file:l["\ud30c\uc77c \ucca8\ubd80"],add_query:l["\ubb38\ud56d \ucd94\uac00"],finished:l["\uc791\uc131 \uc644\ub8cc"],previous:l["\uc774\uc804"],tempsave:l["\uc784\uc2dc\uc800\uc7a5"],guide_desc:l["\uc2dc\uc791\uc548\ub0b4\ubb38\uad6c\uc0c1\uc138"]}})),e.attachFileView=u.create("#survey-attach-placeholder",e.model.getAttaches(),function(t){return GO.config("contextRoot")+"api/survey/"+e.model.id+"/download/"+t.id},"edit"),e.attachFileView.done(function(t){t.$el.on("removedFile",function(t,n){e._removeAttachFile(n)})}),E(e)}function b(t,n){var r=$.goPreloader();r.render(),t.model.save({status:n,guidance:t.$el.find("textarea[name=survey_guidance]").val()},{success:e.bind(function(e){GO.router.navigate("survey/list/my",{trigger:!0,pushState:!1})},t)}).done(function(){r.release()})}function w(e){$(".query-item").each(function(t,n){var r=$(n).data("view");if(r.type!=="preview")return;r[(e?"un":"")+"delegateEvents"].call(r)})}function E(e){var t=(new c({el:".file-uploader",context_root:GO.config("contextRoot"),button_text:"<span class='buttonText'>"+l["\ud30c\uc77c \ucca8\ubd80"]+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie")})).queue(function(e,t){}).start(function(e,t){if(!GO.config("attachFileUpload"))return $.goAlert(f["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1}).progress(function(e,t){}).success(function(t,n){var r={hostId:n.data.hostId,name:n.data.fileName,path:n.data.filePath,extension:n.data.fileExt,size:n.data.fileSize,thumbnail:n.data.thumbnail};if(GO.util.fileUploadErrorCheck(n)){var i=n.data,s=f["\ucca8\ubd80\ud30c\uc77c \uba85"]+" : ' "+i.fileName+" '"+n.message;$.goSlideMessage(s,"caution")}else{if(GO.util.isFileSizeZero(n))return $.goAlert(GO.util.serverMessage(n)),!1;e.model.addAttachFile(r),e.attachFileView.done(function(e){e.attach(r)})}}).complete(function(e,t){}).error(function(e,t){});return t}function S(){if(this.lock){var e=$(".query-item-editing").data("view");return e.saveQuery()}var t=$.Deferred();return t.resolve(),t}function x(e,t,n){$(e).on("click.preview-lock",function(e){var r=$(e.currentTarget).closest("li.query-item").data("view");S.call(n).done(function(){n.melt(),r[t]&&r[t].call(r)})})}var h=".btn-edit-query",p=".btn-copy-query",d=".btn-remove-query",v=t.View.extend({tagName:"div",className:"content_page survey_form go_renew",lock:!1,events:{"click #btn-add-query":"_addQueryForm","click .btn-finished":"_complete","click .btn-tempsave":"_tempsave","click .btn-previous":"_goToPrev","keyup textarea[name=survey_guidance]":"_checkLength"},initialize:function(){this.lock=!1,this.model||(this.model=new i)},render:function(){var e=this;this.model.fetch({success:function(t){y(e),g(e)}})},freeze:function(){this.$el.find(".survey_list").sortable("disable"),w(!0),this.lock=!0,x(h,"convertToForm",this),x(p,"copyQuery",this),x(d,"removeQuery",this)},melt:function(){$([h,p,d].join(",")).off(".preview-lock"),this.$el.find(".survey_list").sortable("enable"),w(!1),this.lock=!1},renderQueryPreview:function(e){var t=o.preview(e);this.attachQueryView(t)},renderQueryForm:function(e){var t;typeof e=="undefined"?t=o.create(this.model.id):t=o.modify(e),this.attachQueryView(t),this.freeze()},initSortable:function(){var e=this;this.$el.find(".survey_list").sortable({items:"> li.sortable",axis:"y",containment:"parent",placeholder:"go-gadget-placeholder",distance:20,forceHelperSize:!0,start:function(e,t){t.placeholder.height(t.item.height()),t.item.addClass("drag_on").disableSelection()},beforeStop:function(t,n){var r=n.item.data("view"),i=1;m.call(e)},stop:function(e,t){t.item.removeClass("drag_on").enableSelection()}})},attachQueryView:function(t){this.$el.find("li.action").before(t.el),t.onStart(e.bind(this._publishStartEdit,this)),t.onComplete(e.bind(this._publishEndEdit,this)),t.$el.on("copied",e.bind(function(e,t){this.renderQueryPreview(t)},this)),t.$el.on("removed",e.bind(function(e,t){m.call(this)},this))},hasQuery:function(){return this.$el.find(".query-item").length>0},_addQueryForm:function(t){S.call(this).done(e.bind(function(){this.renderQueryForm()},this))},_complete:function(t){S.call(this).done(e.bind(function(){$.goConfirm(l["\uc124\ubb38 \uc791\uc131 \uc54c\ub9bc"],l["\uc124\ubb38 \uc791\uc131 \uc54c\ub9bc \uc124\uba85"],$.proxy(function(){this.hasQuery()?b(this,"progress"):$.goAlert(l["\ub4f1\ub85d \uc9c8\ubb38 \uc5c6\uc74c \uba54\uc2dc\uc9c0"])},this))},this))},_tempsave:function(t){S.call(this).done(e.bind(function(){b(this,"temp")},this))},_goToPrev:function(t){S.call(this).done(e.bind(function(){var e=this;$.goCaution(l["\uc774\uc804\ub2e8\uacc4\uc774\ub3d9\uc9c8\ubb38"],l["\uc774\uc804\ub2e8\uacc4\uc774\ub3d9\uacbd\uace0"],function(){GO.router.navigate("survey/"+e.model.id+"/edit",{trigger:!0,pushState:!0})},f["\ud655\uc778"])},this))},_checkLength:function(e){var t=$(e.currentTarget);t&&t.val().length>1e3?(r.printError(t,n.getStringLengthError(0,1e3)),t.val(t.val().substr(0,1e3))):(t.siblings(".go_error").remove(),t.removeClass("enter error"))},_publishStartEdit:function(e){this.freeze()},_publishEndEdit:function(e){this.melt()},_removeAttachFile:function(e){this.model.removeAttachFile(e)}});return v})})();