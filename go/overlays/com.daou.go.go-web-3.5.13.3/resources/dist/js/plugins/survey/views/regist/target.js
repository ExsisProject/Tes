(function(){define(["jquery","underscore","backbone","app","helpers/form","i18n!nls/commons","i18n!survey/nls/survey","go-nametags","libraries/go-classcodepicker"],function(e,t,n,r,i,s,o,u,a){function p(n,i,a,f){function h(e){var t=e.position?e.name+" "+e.position:e.name;l.addTag(e.id,t,{attrs:e,removable:a})}var l,c=[];t.each(f,function(e){e.nodeType==="user"&&c.push({id:e.nodeId,title:e.nodeValue,options:{removable:a}})}),l=u.create(c||[],{useAddButton:i,useRemoveAll:!0}),e(n).data("instance",l).append(l.el),l.$el.on("nametag:clicked-add",function(n){e.goOrgSlide({header:o["\uc124\ubb38 \ub300\uc0c1\uc790 \ucd94\uac00"],type:"node",desc:o["\uc124\ubb38 \uacb0\uacfc \uc5f4\ub78c \uac00\ub2a5 \uc548\ub0b4 \uba54\uc2dc\uc9c0"],contextRoot:r.config("contextRoot"),memberTypeLabel:s["\ub300\uc0c1\uc790"],externalLang:s,isBatchAdd:!0,callback:function(e){var n=t.isArray(e)?e:[e];t.each(n,function(e){h(e,l,a)})}})})}function d(t,n){var i=e(t.currentTarget),s=n.getTargetNodes(),o=!0;i.attr("type")==="checkbox"&&(o=i.is(":checked")),o&&i.val()==="user"?(e("#target-user-div").length<1&&(i.parent().after('<div id="target-user-div" class="option_display"></div>'),p("#target-user-div",!0,n.isCreator(r.session("id")),s)),e("#target-user-div").show()):e("#target-user-div").hide()}function v(e,t,n,r){return e.push({nodeId:t,nodeType:n,nodeValue:r}),e}var f={label:{add_dept:o["\ubd80\uc11c\ucd94\uac00"],dept_name:o["\ubd80\uc11c\uba85"],include_child_dept:o["\ud558\uc704 \ubd80\uc11c \ud3ec\ud568\ud558\uae30"],remove:o["\uc0ad\uc81c"],target_whole:o["\uc804\uc0ac"],target_part:o["\uc77c\ubd80"],select_dept:o["\ubd80\uc11c \uc120\ud0dd"],select_class:o["\ud074\ub798\uc2a4 \uc120\ud0dd"],select_user:o["\uc9c1\uc811 \uc120\ud0dd"],child_dept:o["\ud558\uc704 \ubd80\uc11c"]}},l=n.View.extend({initialize:function(){this.$el.data("targetview")&&this.$el.data("targetview").release(),this.$el.data("targetview",this)},release:function(){this.$el.off(),this.$el.empty(),this.$el.data("targetview",null)},getList:function(){return[]}}),c=function(){function n(n){var r=n.model.getTargetNodes();t.each(r,function(t){t.nodeType==="user"?e("#radio-target-user").is(":checked")||e("#radio-target-user").trigger("click"):(e("#radio-target-"+t.nodeId).is(":checked")||e("#radio-target-"+t.nodeId).trigger("click"),t.nodeType==="subdepartment"&&e("input[name=target_child_"+t.nodeId+"]").trigger("click"))})}function s(){var n=e("#target-user-div").data("instance"),r=n.getNameTagList(),i=[];return t.each(r,function(e){v(i,e.id,"user",e.displayName)}),i}function o(e,n){var s=[];return t.each(e,function(e,t){r.session("useOrg")&&(s.push(i.radio("target",e.id,{label:e.name,checked:t===0,attrs:{"data-name":e.name,"data-type":"department"}})),e.childrenCount>0&&(s.push("("),s.push(i.checkbox("target_child_"+e.id,"Y",{label:n.label.child_dept})),s.push(")")),s.push("<br />"))}),r.session("useOrg")?s.push(i.radio("target","user",{label:n.label.select_user,attrs:{"data-type":"user"}})):(s.push(i.radio("target","user",{label:n.label.select_user,attrs:{"data-type":"user",checked:"checked"}})),s.push("<div id='target-user-div' class='wrap_name_tag'>"),s.push("</div>")),s.join("\n")}return l.extend({events:{"click input[name=target]":"_toggleTargetUserList"},render:function(){var t=this;e.ajax(r.config("contextRoot")+"api/department/list/joined").done(function(e){t.$el.append(o(e.data,f)),r.session("useOrg")?n(t):(t.$el.find("span.wrap_option").hide(),p("#target-user-div",!0,t.model.isCreator(r.session("id")),t.model.getTargetNodes()))})},isTargetAll:function(){return!1},getList:function(){var t=e("input[name=target]:checked"),n=t.val(),r=t.data("name"),i=[];if(t.length>0)if(n==="user")Array.prototype.push.apply(i,s());else{var o=e("input[name=target_child_"+n+"]:checked").length>0;v(i,n,(o?"sub":"")+"department",r)}return i},_toggleTargetUserList:function(t){e("input[type=checkbox]").prop("checked",!1),d(t,this.model)}})}(l),h=function(){function n(e){var t=e.$el.find("select[name=target_type]");e.model.isTargetCompany()?t.val("whole"):t.val("part"),t.trigger("change"),r(e)}function r(n){if(n.model.isTargetCompany())return;var r=n.model.getTargetNodes();t.each(r,function(r,i){var s=r.nodeId,o=r.nodeType,a=r.nodeValue;t.contains(["department","subdepartment"],o)?(e("#checkbox-targetpart-dept").is(":checked")||e("#checkbox-targetpart-dept").trigger("click"),e("#target-dept-table tbody").append(u({id:r.nodeId,name:r.nodeValue},o==="subdepartment"))):t.contains(["position","grade","duty","usergroup"],o)?(e("#checkbox-targetpart-class").is(":checked")||e("#checkbox-targetpart-class").trigger("click"),n.classCodePicker.addClassCode(s,o,a)):o==="user"&&(e("#checkbox-targetpart-user").is(":checked")||e("#checkbox-targetpart-user").trigger("click"))})}function s(e){var n=[],r=[{value:"whole",label:f.label.target_whole},{value:"part",label:f.label.target_part}];return n.push(i.select("target_type",r,e||"whole")),n.push('<div id="survey-target-option" style="display:none">'),t.each({dept:f.label.select_dept,"class":f.label.select_class,user:f.label.select_user},function(e,t){t!="dept"&&n.push(i.checkbox("targetpart",t,{label:e})+"<br />")}),n.push("</div>"),n.join("\n")}function o(){var e=[];return e.push('<div id="target-dept-div" class="option_display" style="display:none">'),e.push('<span id="btn-add-dept" class="btn_wrap"><span class="ic_form ic_addlist"></span><span class="txt">'+f.label.add_dept+"</span></span>"),e.push('<table id="target-dept-table" class="type_normal tb_list_sub list_survey002">'),e.push("<caption>"+f.label.add_dept+"</caption>"),e.push("<thead>"),e.push("<tr>"),t.each({name:f.label.add_dept,option:f.label.include_child_dept,action:f.label.remove},function(t,n){e.push('<th class="sorting_disabled '+n+'"><span class="title">'+t+"</span></th>")}),e.push("</tr>"),e.push("</thead>"),e.push("<tbody></tbody>"),e.push("</table>"),e.push("</div>"),e.join("\n")}function u(e,t){t=t||!1;var n=[];return n.push('<tr class="target-dept-',e.id,'" data-id="'+e.id+'" data-name="'+e.name+'">',"\n"),n.push('<td class="name"><span class="txt">',e.name,"</span></td>","\n"),n.push('<td class="option"><span class="wrap_single_form"><input type="checkbox" name="target_dept_id" value="',e.id,'"',t?' checked="checked"':"","></span></td>","\n"),n.push('<td class="action"><span class="wrap_btn_m btn-remove"><span class="ic_side ic_basket_bx" title="',f.label.remove,'"></span></span></td>',"\n"),n.push("</tr>"),n.join("")}return l.extend({events:{"change select[name=target_type]":"_setTargetOption","click #checkbox-targetpart-dept":"_toggleTargetDeptList","click #checkbox-targetpart-class":"_toggleTargetClassList","click #checkbox-targetpart-user":"_toggleTargetUserList","click #target-dept-table .btn-remove":"_removeTargetDept"},initialize:function(){l.prototype.initialize.apply(this,arguments),this.classCodePicker=new a({id:"target-class-div"})},render:function(){this.$el.append(s()),n(this)},isTargetAll:function(){return e("select[name=target_type]").val()==="whole"},getList:function(){var t=e("select[name=target_type]").val(),n=[];return t==="part"&&(e("#checkbox-targetpart-dept").is(":checked")&&Array.prototype.push.apply(n,this.getTargetDeptInfoList()),e("#checkbox-targetpart-class").is(":checked")&&Array.prototype.push.apply(n,this.getTargetClassInfoList()),e("#checkbox-targetpart-user").is(":checked")&&Array.prototype.push.apply(n,this.getTargetUserInfoList())),n},getTargetDeptInfoList:function(){var t=[];return e("#target-dept-table > tbody > tr").each(function(n,r){var i=e(r).data("id"),s=e(r).data("name"),o=(e(r).find("input[name=target_dept_id]:checked").length>0?"sub":"")+"department";v(t,i,o,s)}),t},getTargetClassInfoList:function(){var t=[];return e("#target-class-div ul.list_option li").each(function(n,r){v(t,e(r).data("id"),e(r).data("type"),e(r).data("name"))}),t},getTargetUserInfoList:function(){var n=e("#target-user-div").data("instance"),r=n.getNameTagList(),i=[];return t.each(r,function(e){v(i,e.id,"user",e.displayName)}),i},showTargetOption:function(){e("#survey-target-option").show()},hideTargetOption:function(){e("#survey-target-option").hide()},_setTargetOption:function(t){var n=e(t.currentTarget).val();n==="part"?this.showTargetOption():this.hideTargetOption()},_toggleTargetDeptList:function(t){var n=e(t.currentTarget);n.is(":checked")?(e("#target-dept-div").length<1&&n.parent().after(o()),e("#target-dept-div").show()):e("#target-dept-div").hide()},_toggleTargetClassList:function(t){var n=e(t.currentTarget);n.is(":checked")?(e("#target-class-div").length<1&&(n.parent().after(this.classCodePicker.el),this.classCodePicker.render()),e("#target-class-div").show()):e("#target-class-div").hide()},_toggleTargetUserList:function(e){d(e,this.model)},_removeTargetDept:function(t){e(t.target).closest("tr").remove()}})}(l);return{create:function(e,t,n){var r={el:e,model:t},i=n?new h(r):new c(r);return i.render(),i}}})})();