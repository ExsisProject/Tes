(function(){define(["underscore","backbone","app","survey/models/query","survey/libs/util","hgn!survey/templates/query_form","helpers/form","i18n!survey/nls/survey","jquery.go-popup","jquery.go-preloader"],function(e,t,n,r,i,s,o,u){function h(e){var t=[];return this.$el.find(".querycase-item").each(function(n,r){var i=$(r),s={description:"",selected:!1,answer:"",count:0,caseType:i.data("type"),seq:n};e==="select"||e==="mselect"?s.description=i.find("input[type=text], textarea").val():e==="score"&&(s.description=n+""),t.push(s)}),t}function p(t){var n=[],r={select:{select:u["\ud558\ub098\ub9cc \uc120\ud0dd"],mselect:u["\ubcf5\uc218 \uc120\ud0dd"]},text:{text:u["\ub2e8\ubb38 \uc785\ub825"],textarea:u["\uc7a5\ubb38 \uc785\ub825"]},score:{3:d(3),5:d(5),7:d(7),10:d(10)}};return e.each(r[t],function(e,t){n.push('<option value="'+t+'">'+e+"</option>")}),n.join("\n")}function d(e){return n.i18n(u["\uc810\uc218\ud615 \uc810\uc218"],{arg1:e})}function v(t,n){var r=[],i=n.getCases(),s=g(t);return r.push('<ul class="wrap_answer" data-type="'+t+'">'),n.isGroupOfSelect()&&e.each(i,function(e,t){r.push(m(s,t+1,e))}),r.push("<li>"),r.push('<span class="btn-add-querycase wrap_txt disable"><input type="'+s+'" name="'+s+'" value="-1" disabled="disabled" /><input class="txt wfix_max" type="text" readonly="readonly" value="'+u["\uc120\ud0dd\ud615 \ubb38\ud56d \ucd94\uac00 \uac00\uc774\ub4dc \ud14d\uc2a4\ud2b8"]+'"></span>'),r.push("</li>"),r.push(b()),r.push("</ul>"),r.join("\n")}function m(e,t,n){var r=[],i=n.description||"",s=n.caseType==="input";return s&&!i&&(i=u["\uae30\ud0c0"]),r.push('<li class="querycase-item'+(s?" querycase-item-etc etc":"")+'" data-type="'+n.caseType+'">'),r.push('<span class="wrap_txt">'),r.push('<input type="'+e+'" name="'+e+'" value="'+t+'"/>'),r.push('<input class="txt wfix_max querycase-desc" type="text" name="case_'+t+'" value="'+i+'">'),r.push("</span>"),r.push('<span class="wrap_btn_m btn-del-querycase"><span class="ic_classic ic_del"></span></span>'),r.push("</li>"),r.join("\n")}function g(e){return e==="mselect"?"checkbox":"radio"}function y(e){var t=e.get("type");return e.isScoreType()&&(t=""+e.getCases().length),t}function b(){return'<li class="creat"><span class="btn-add-querycase-etc btn_wrap btn_creat"><span class="ic_form ic_addlist"></span><span class="txt">'+u["\uae30\ud0c0 \ucd94\uac00"]+"</span></span></li>"}function w(t){var r=t.getQueryType(),s=t.$el.find("input[name=question]"),l=s.val(),c=!1;if(!E(l))return o.printError(s,i.getStringLengthError(a,f)),!1;n.util.isXSSPettern(l)&&s.val(n.util.escapeXssToBlank(l));if(e.contains(["select","mselect"],r)){var h=t.$el.find(".querycase-item"),p=!0;if(h.length<1)return $.goAlert(u["\ub4f1\ub85d \ubb38\ud56d \uc5c6\uc74c \uba54\uc2dc\uc9c0"]),!1;h.each(function(e,t){var n=$(t),r=n.find(".querycase-desc"),s=r.val();if(!s||s&&(s.length<1||s.length>64))o.printError(r,i.getStringLengthError(1,64)),p=!1});if(!p)return!1}return!0}function E(e){return e?e.length<a?!1:e.length>f?!1:!0:!1}var a=2,f=255,l=50,c;return c=t.View.extend({type:"form",tagName:"li",events:{"change select[name=query_type]":"changeQueryTypeOption","change select[name=query_subtype]":"changeSubQueryTypeOption","click .btn-add-querycase":"addQueryCase","click .btn-add-querycase-etc":"addQueryCaseEtc","click .btn-del-querycase":"removeQueryCase","click .btn-submit":"saveQuery","click .btn-cancel":"cancel","blur .querycase-item":"setSelectQueryData"},initialize:function(){this.model||(this.model=new r),this.originModel=this.model.clone(),this.$el.data("view",this),this.$el.addClass("query-item-editing")},render:function(){this.$el.append(s({question:this.model.get("question"),"required?":this.model.isRequired()||!1,max_of_selectable:this.model.getMaxOfSelectable(),label:{question:u["\uc9c8\ubb38"],query_type:u["\uc124\ubb38 \ubb38\ud56d \ud0c0\uc785"],query_case:u["\ub2f5\ubcc0"],required:u["\ud544\uc218 \ub2f5\ubcc0"],max_of_selectable:u["\ucd5c\ub300 \uc120\ud0dd \uac2f\uc218"],query_type_select:u["\uc120\ud0dd\ud615"],query_type_text:u["\ud14d\uc2a4\ud2b8\ud615"],query_type_score:u["\uc810\uc218\ud615"],finish:u["\uc644\ub8cc"],cancel:u["\ucde8\uc18c"],unlimited:u["\uc81c\ud55c\uc5c6\uc74c"]}})),this.initQueryCase()},initQueryCase:function(){this.model.isNew()||this.$el.find("select[name=query_type]").val(this.model.getGroupedType()),this.setSubQueryTypeOption(),this.$el.find(".querycase-item-etc").length>0&&this.$el.find(".btn-add-querycase-etc").hide()},setSelectQueryData:function(){var e=[],t=this.getQueryType();e=h.call(this,t),this.model.set({type:t},{silent:!0}),this.model.set({cases:e},{silent:!0})},saveQuery:function(){var e=this,t=$.Deferred(),r=[],s=this.getQueryType(),o=this.$el.find(".querycase-item");o.each(function(e,t){var r=$(t),i=r.find(".querycase-desc"),s=i.val();n.util.isXSSPettern(s)&&i.val(n.util.escapeXssToBlank(s))});if(s==="text"||s==="textarea")r.push({description:"",selected:!0,answer:"",count:0,caseType:"input",seq:0});else if(s==="score"){var u=parseInt(this.$el.find("select[name=query_subtype]").val());for(var a=0;a<u;a++)r.push({description:a+1+"",selected:!1,answer:"",count:0,caseType:"radio",seq:a})}else r=h.call(this,s);if(w(this)){var f=$.goPreloader();f.render(),this.model.save({type:s,required:this.$el.find("input[name=required]").is(":checked"),question:this.$el.find("input[name=question]").val().trim(),cases:r,responseCount:0,maxOfSelectable:parseInt(s==="mselect"?$("select#maxOfSelectable > option:selected").val():0)||0},{success:function(n){e.$el.trigger("click:edit-end",[n]),t.resolve()},error:function(e){i.raiseRequestError(),t.reject()}}).done(function(){f.release()})}else t.reject();return t},cancel:function(){this.model=this.originModel,this.$el.trigger("click:edit-end",[this.model]),this.model.isNew()&&this.remove()},setSubQueryTypeOption:function(){var e=this.$el.find("select[name=query_type]").val(),t=this.$el.find("select[name=query_subtype]");t.empty().append(p(this.$el.find("select[name=query_type]").val())),!this.model.isNew()&&this.model.getGroupedType()===e&&t.val(y(this.model)),this.setQueryCaseList()},setQueryCaseList:function(e){var t=this.getQueryCaseHtml(),n=this.$el.find(".query-answer-container");n.empty(),t&&n.append(t),this.toggleAnswerRow(t),this.getQueryType()==="mselect"?(this.$el.find(".mselect-only").show(),this.$el.find(".querycase-item").each(function(e,t){var n=e+1;$("#maxOfSelectable").append('<option value="'+n+'">'+n+"</option>")}),$('select#maxOfSelectable > option[value="'+this.model.get("maxOfSelectable")+'"]').attr("selected","true")):this.$el.find(".mselect-only").hide()},toggleAnswerRow:function(e){var t=this.$el.find(".query-answer-row");e?t.show():t.hide()},getNextQueryCaseIndex:function(){return this.$el.find(".querycase-item").length+1},getPresentQueryCaseIndex:function(){return this.$el.find(".querycase-item").length},addQueryCase:function(e){var t=$(e.currentTarget),r=t.closest("li"),i=t.closest("ul"),s=g(i.data("type"));this.$el.find(".querycase-item").length<l?(r.before(m(s,this.getNextQueryCaseIndex(),{caseType:t.hasClass("btn-add-querycase-etc")?"input":s})),this.$el.find('input[name="case_'+this.getPresentQueryCaseIndex()+'"]').focus(),this.getQueryType()==="mselect"&&$("#maxOfSelectable").append('<option value="'+this.getPresentQueryCaseIndex()+'">'+this.getPresentQueryCaseIndex()+"</option>")):(t.hasClass("btn-add-querycase-etc")&&this.$el.find(".btn-add-querycase-etc").show(),$.goAlert(n.i18n(u["\ubb38\ud56d \ub4f1\ub85d 0\uac1c \ucd08\uacfc \uba54\uc2dc\uc9c0"],{arg1:l})))},addQueryCaseEtc:function(e){this.$el.find(".querycase-item-etc").length<1&&(this.$el.find(".btn-add-querycase-etc").hide(),this.addQueryCase(e))},removeQueryCase:function(e){var t=$(e.currentTarget).closest("li");t.hasClass("querycase-item-etc")&&this.$el.find(".btn-add-querycase-etc").show(),$("#maxOfSelectable option:last").remove(),t.remove()},getQueryCaseHtml:function(){var e=this.getQueryType(),t="";switch(e){case"select":case"mselect":t=v(e,this.model);break;case"text":case"textarea":break;default:}return t},getQueryType:function(){var e=this.$el.find("select[name=query_type]").val();return e==="score"?e:this.$el.find("select[name=query_subtype]").val()},changeQueryTypeOption:function(e){this.setSubQueryTypeOption()},changeSubQueryTypeOption:function(e){this.setQueryCaseList()}}),c})})();