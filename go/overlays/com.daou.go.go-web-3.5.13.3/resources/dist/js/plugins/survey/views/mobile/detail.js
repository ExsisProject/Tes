(function(){define(["survey/views/base/detail","app","survey/views/mobile/detail/response","survey/views/mobile/detail/result","hgn!survey/templates/mobile/detail","survey/helpers/html","attach_file","survey/libs/util","i18n!nls/commons","i18n!survey/nls/survey","views/mobile/header_toolbar"],function(e,t,n,r,i,s,o,u,a,f,l){function p(e){$("#tool_bar").length>0?e.$el.find(".tool_bar").remove():(e.$toolbar=e.$el.find(".tool_bar"),e.$toolbar.on("vclick.toolbar",".btn-change-status",_.bind(e._changeStatus,e)),e.$toolbar.on("vclick.toolbar",".btn-remove-survey",_.bind(e._removeSurvey,e)),e.$toolbar.on("vclick.toolbar",".btn-list",_.bind(e._goToList,e)),e.$toolbar.attr("id","tool_bar"),e.$el.before(e.$toolbar))}var c=e.prototype,h;return h=e.extend({tagName:"section",id:"survey-datail-container",className:"classic_detail",filterName:"all",events:{"vclick #copyUrl":"copyUrl","vclick .btn-modify-resp":"modifyResponse"},initialize:function(){c.initialize.apply(this,arguments),this.ResponseView=n,this.ResultView=r,this.headerToolBarView=l,_.extend(this.lang,{start_survey:f["\uc2dc\uc791"],stop_survey:f["\uc911\uc9c0"]}),this.$el.data("view",this),this.headerBindEvent()},headerBindEvent:function(){t.EventEmitter.off("trigger-action"),t.EventEmitter.on("trigger-action","survey-comment",this.moveComment,this),t.EventEmitter.on("trigger-action","survey-start",function(){this._changeStatusForMobile("temp")},this),t.EventEmitter.on("trigger-action","survey-stop",function(){this._changeStatusForMobile("progress")},this),t.EventEmitter.on("trigger-action","survey-delete",this._removeSurvey,this)},release:function(){var e=this.$el.parent();this.$toolbar&&this.$toolbar.off(),this.remove(),e.empty()},moveComment:function(){t.router.navigate("/survey/"+this.surveId+"/comments",{trigger:!0})},render:function(){var e=this,n=$.Deferred();return t.util.appLoading(!0),this.model.fetch({success:function(r){e.surveId=r.id,e.status=r.get("status"),r.isStopped()&&!r.isCreator(t.session("id"))&&(u.alert(f["\uc911\uc9c0\ub41c \uc124\ubb38"],f["\uc911\uc9c0\ub41c \uc124\ubb38 \uc548\ub0b4\ubb38"]),t.router.navigate("survey",{trigger:!0})),e.$el.append(i({context_root:t.config("contextRoot"),survey_id:r.id,status:r.get("status"),"creator?":r.isCreator(t.session("id")),creator:{display_name:r.getCreatorName(),thumbnail:r.hasDeptName()?null:r.get("creator").thumbnail},period:s.getSurveyPeriod(r),guidance:r.getGuidance(),comment_count:r.getCommentCount(),public_flag:f["\uc124\ubb38 \uacb0\uacfc"]+" "+(r.isPrivate()?f["\ube44\uacf5\uac1c"]:f["\uacf5\uac1c"]),editable_flag:f["\ucc38\uc5ec \ud6c4 \uc218\uc815"]+" "+(r.editable()?f["\ud5c8\uc6a9"]:f["\ud5c8\uc6a9\uc548\ud568"]),"accessible?":e.accessible(),"progressing?":r.isProgressing(),"finished?":r.isFinished(),"started?":r.isStarted(),"responded?":r.isResponseDone(),"editable?":r.editable(),"use_comment?":r.commentable(),label:{list:a["\ubaa9\ub85d"],comment:a["\ub313\uae00"],modify_response:f["\uc751\ub2f5 \uc218\uc815"],go_home:f["\uc124\ubb38 \ud648\uc73c\ub85c"],start_survey:f["\uc2dc\uc791"],stop_survey:f["\uc911\uc9c0"],remove_survey:f["\uc0ad\uc81c"]},msg:{responded:f["\uc124\ubb38 \uc644\ub8cc \uba54\uc2dc\uc9c0"],not_accessible:f["\uc124\ubb38 \uc0c1\uc138 \uc811\uadfc\uad8c\ud55c \uc5c6\uc74c \uba54\uc2dc\uc9c0"]}})),r.hasDeptName()&&e.$el.find(".article_header").css("padding-left","10px"),e.renderHeaderToolbar(r),o.create("#survey-attach-placeholder",r.getAttaches(),function(e){return t.config("contextRoot")+"api/survey/"+r.id+"/download/"+e.id}),e.accessible()&&e._renderDetailSubView(r),n.resolveWith(e,[e]),t.util.pageDone(),_.isEmpty($(".content"))&&!_.isEmpty($("#tool_bar"))&&$("#survey-datail-container").wrap('<div class="content" />')},error:function(e,n){t.util.linkToErrorPage(n)}}),n},copyUrl:function(e){t.util.copyUrl(e)},modifyResponse:function(e){t.router.navigate("survey/"+this.model.id+"/response/edit",{trigger:!0,pushState:!0})},reload:function(){return this.$el.empty(),this.render()},renderHeaderToolbar:function(e){var t={isPrev:!0,actionMenu:this.getUseMenus(e)};this.headerToolBarView.render(t)},getUseMenus:function(e){var n=[],r={"\ub313\uae00":{id:"survey-comment",text:a["\ub313\uae00"],triggerFunc:"survey-comment",cls:"btn_comments",commentsCount:e.getCommentCount()},"\uc2dc\uc791":{id:"survey-start",text:f["\uc2dc\uc791"],triggerFunc:"survey-start",inMoreBtn:!0},"\uc911\uc9c0":{id:"survey-stop",text:f["\uc911\uc9c0"],triggerFunc:"survey-stop",inMoreBtn:!0},"\uc0ad\uc81c":{id:"survey-delete",text:f["\uc0ad\uc81c"],triggerFunc:"survey-delete",inMoreBtn:!0}};return e.commentable()&&n.push(r.\ub313\uae00),e.isCreator(t.session("id"))&&e.isProgressing()&&(e.isStarted()?n.push(r.\uc911\uc9c0):n.push(r.\uc2dc\uc791)),e.isCreator(t.session("id"))&&n.push(r.\uc0ad\uc81c),n}}),h})})();