(function(){define(["backbone","app","survey/models/survey_response","survey/libs/util","survey/helpers/html","hgn!survey/templates/list","i18n!nls/commons","i18n!survey/nls/survey","jquery.go-grid","jquery.go-popup"],function(e,t,n,r,i,s,o,u){function f(){return $("#survey-list-table input[type=checkbox]:checked")}function l(){var e=[];return e.push('<p class="data_null">'),e.push('<span class="ic_data_type ic_no_contents"></span>'),e.push('<span class="txt">'+u["\uc124\ubb38 \ube48\ubaa9\ub85d \uba54\uc2dc\uc9c0"]+"</span>"),e.push("</p>"),e.join("\n")}function c(e,n){var r=(t.config("contextRoot")+"api/survey"+(n==="remove"?"":"/status/"+n)).replace("//","/"),i=e.dataTable.tables.getCheckedData(),s,o=null;i.length==0&&$.goSlideMessage(u["\uc120\ud0dd \uc124\ubb38 \uc5c6\uc74c"]);if(n==="remove")s=i;else{var a={progress:"stop",stop:"progress",finished:"progress"}[n],f=i[0].status,l=!0;$.each(i,function(e,t){l&&f!=t.status&&(l=!1)}),s=_.filter(i,function(e){if(!l){o=u["\uac19\uc740\uc0c1\ud0dc\ub9cc\uc120\ud0dd"];return}if(n=="stop"){if(e.status=="finished"){o=u["\uc644\ub8cc\ub41c\uc124\ubb38\uc911\uc9c0"];return}if(e.status=="ready"){o=u["\uc900\ube44\uc911\uc124\ubb38\uc911\uc9c0"];return}if(e.status=="temp"){o=u["\uc784\uc2dc\uc800\uc7a5\uc124\ubb38\uc911\uc9c0"];return}if(e.status=="stop"){o=u["\uc911\uc9c0\ub41c\uc124\ubb38\uc911\uc9c0"];return}}if(n=="progress"){if(e.status=="finished"){o=u["\uc644\ub8cc\ub41c\uc124\ubb38\uc9c4\ud589"];return}if(e.status=="ready")return!0;if(e.status=="temp"){o=u["\uc784\uc2dc\uc800\uc7a5\uc124\ubb38\uc9c4\ud589"];return}if(e.status=="progress"){o=u["\uc9c4\ud589\ub41c\uc124\ubb38\uc9c4\ud589"];return}}if(n=="finished"){if(e.status=="finished"){o=u["\ub9c8\uac10\ub41c\uc124\ubb38\ub9c8\uac10"];return}if(e.status=="stop"){o=u["\uc911\uc9c0\ub41c\uc124\ubb38\ub9c8\uac10"];return}if(e.status=="temp"){o=u["\uc784\uc2dc\uc800\uc7a5\uc124\ubb38\ub9c8\uac10"];return}if(e.status=="ready"){o=u["\uc900\ube44\uc911\uc124\ubb38\ub9c8\uac10"];return}}return e.status===a})}s.length>0?n=="remove"?$.goConfirm(u["\uc124\ubb38 \uc0ad\uc81c \ud655\uc778 \ud0c0\uc774\ud2c0"],u["\uc124\ubb38 \uc0ad\uc81c \ud655\uc778 \uba54\uc2dc\uc9c0"],function(){$.ajax(r,{method:"DELETE",data:JSON.stringify({ids:_.pluck(s,"id")}),dataType:"json",contentType:"application/json"}).done(function(){e.dataTable.tables.fnSettings().sAjaxSource=e.getSearchUrl(),e.dataTable.tables.fnClearTable(),e.$el.find("input[type=checkbox]").prop("checked",!1)}).fail(function(){$.goSlideMessage(u["\ubc30\uce58 \ucc98\ub9ac \uc624\ub958 \uba54\uc2dc\uc9c0"],"caution")})}):n=="finished"?$.goConfirm(u["\uc124\ubb38 \ub9c8\uac10 \ud655\uc778 \ud0c0\uc774\ud2c0"],"",function(){$.ajax(r,{method:"POST",data:JSON.stringify({ids:_.pluck(s,"id")}),dataType:"json",contentType:"application/json"}).done(function(){e.dataTable.tables.fnSettings().sAjaxSource=e.getSearchUrl(),e.dataTable.tables.fnClearTable(),e.$el.find("input[type=checkbox]").prop("checked",!1)}).fail(function(){$.goSlideMessage(u["\ubc30\uce58 \ucc98\ub9ac \uc624\ub958 \uba54\uc2dc\uc9c0"],"caution")})}):$.ajax(r,{method:"POST",data:JSON.stringify({ids:_.pluck(s,"id")}),dataType:"json",contentType:"application/json"}).done(function(){e.dataTable.tables.fnSettings().sAjaxSource=e.getSearchUrl(),e.dataTable.tables.fnClearTable(),e.$el.find("input[type=checkbox]").prop("checked",!1)}).fail(function(){$.goSlideMessage(u["\ubc30\uce58 \ucc98\ub9ac \uc624\ub958 \uba54\uc2dc\uc9c0"],"caution")}):o!=null?$.goSlideMessage(o):$.goSlideMessage(u["\uc120\ud0dd \uc124\ubb38 \uc5c6\uc74c"])}function h(e,t){return{mData:null,sClass:e,bSortable:!1,fnRender:t}}function p(e){var t=e.oSettings,n=t._iRecordsTotal-t._iDisplayStart-e.iDataRow;return'<span class="txt">'+n+"</span>"}function d(e){var r=new n(e.aData),s="-";return this.isMyList()||this.isCopyableList()?s=i.getStatusTagByStatus(r.get("status")):r.isResponsible()?s=i.getStatusTagByResponse(r.getResponseStatus()):r.isIncludedReferrer(t.session("id"))&&(s=i.getStatusTag("read",u["\uc5f4\ub78c"])),s}function v(e){var r=new n(e.aData),s=r.isIncludedReferrer(t.session("id")),o=t.config("contextRoot")+"app/survey/"+r.id,u=[];return this.isMyList()&&r.isTempSaved()&&(o+="/edit"),s&&u.push(i.getReferTag()),this.isCopyableList()?u.push('<a class="preview"><span class="txt">'+_.escape(r.get("title"))+"</span></a>"):u.push('<a href="'+o+'"><span class="txt">'+_.escape(r.get("title"))+"</span></a>"),r.get("commentCount")>0&&(u.push('<span class="ic_classic ic_reply"></span>'),u.push('<span class="num">[<strong>'+r.get("commentCount")+"</strong>]</span>")),u.join("\n")}function m(e){var t=moment(e.aData.startTime,"YYYY-MM-DD").format("YYYY-MM-DD"),n=moment(e.aData.endTime,"YYYY-MM-DD").format("YYYY-MM-DD");return'<span class="txt">'+t+" ~ "+n+"</span>"}function g(e){var t="",n=e.aData.targetCount,r=e.aData.responseCount<0?0:e.aData.responseCount;if(n>0){var i=(r/n*100).toFixed(2);t=r+"/"+n+"<strong> ("+i+"%)</strong>"}else t="-";return'<span class="txt">'+t+"</span>"}function y(e){var t=e.aData.deptName?e.aData.deptName:e.aData.creator.name+" "+e.aData.creator.position;return'<span class="txt">'+t+"</span>"}var a=e.View.extend({tagName:"div",className:"content_page",dataTable:null,filterName:"all",events:{"click .btn-search":"_search","click .btn-survey-progress":"_startSurveys","click .btn-survey-stop":"_stopSurveys","click .btn-survey-finished":"_finishedSurveys","click .btn-survey-remove":"_removeSurveys","change #selectSite":"loadTable","keydown section.search2 input":"_searchKeyboardEvent","click a.preview":"preview","change input.copyable":"copySurvey"},initialize:function(e){this.options=e||{},this.dataTable=null,_.defaults(this.options,{usePage:!0,useButton:!0,useToolbar:!0,showSeq:!0,displayLength:20})},_isUseButtonMenu:function(){return location.href.indexOf("/list/my")>-1},_canCopyMultiCompanySurvey:function(){return this.isCopyableList()&&t.session("integratedCompanies").length>1},render:function(){this.$el.append(s({context_root:t.config("contextRoot"),"my_list?":this.isMyList(),canCopyMultiCompanySurvey:this._canCopyMultiCompanySurvey(),companies:t.session("integratedCompanies"),"use_button?":this._isUseButtonMenu(),"show_seq?":this.options.showSeq,label:{select_site:u["\uc0ac\uc774\ud2b8 \uc120\ud0dd"],num:u["\ubc88\ud638"],status:u["\uc0c1\ud0dc"],title:u["\uc124\ubb38 \uc81c\ubaa9"],period:u["\uc124\ubb38 \uae30\uac04"],creator:u["\uc791\uc131\uc790"],rating:u["\ucc38\uc5ec\uc728"],progress:u["\uc9c4\ud589"],finished:u["\ub9c8\uac10"],stop:u["\uc911\uc9c0"],"delete":u["\uc0ad\uc81c"],search:o["\uac80\uc0c9"]}})),this._canCopyMultiCompanySurvey()&&this.$el.find("#selectSite option[value="+t.session("companyId")+"]").prop("selected",!0),this.loadTable()},loadTable:function(){var e=this,t=this.getSearchUrl();if(this.dataTable===null){var n={el:"#survey-list-table",url:t,displayLength:e.options.displayLength,emptyMessage:l(),columns:[],fnDrawCallback:function(t,n,r){e.$el.find(".btn-custom").appendTo(e.$el.find(".tool_bar .custom_header")).show(),e.isCopyableList()&&(e.$el.find(".select-custom").appendTo(e.$el.find(".tool_bar .custom_header")).show(),e.$el.find('tr input[type="checkbox"]').addClass("copyable")),e.options.usePage?n._iRecordsTotal==0&&!r.keyword?$(".dataTables_paginate, .table_search").hide():$(".dataTables_paginate, .table_search").show():$(".dataTables_paginate, .table_search").hide(),e.options.useToolbar||$(".dataTables_wrapper .tool_bar").hide(),$(window).scrollTop(0)}};this.options.showSeq&&n.columns.push(h("num",_.bind(p,this))),n.columns.push(h("state",_.bind(d,this))),n.columns.push(h("list_subject",_.bind(v,this))),n.columns.push(h("date",_.bind(m,this))),this.isMyList()?(n.columns.push(h("rate",_.bind(g,this))),n.checkbox=!0,n.checkboxData="id",$("select[name='searchtype'] option[value='writer']").remove()):(this.isCopyableList()&&(n.checkbox=!0,n.checkboxData="id"),n.columns.push(h("name",_.bind(y,this)))),this.dataTable=$.goGrid(n)}else this.isCopyableList()&&this.dataTable.tables.setParam("companyId",this.$el.find("#selectSite option:selected").val()),this.dataTable.tables.fnSettings().sAjaxSource=t,this.dataTable.tables.fnClearTable()},setFilter:function(e){this.filterName=e},getSearchUrl:function(){return t.config("contextRoot")+"api/survey/list/"+this.filterName},isProgressList:function(){return this.filterName==="progress"},isFinishedList:function(){return this.filterName==="finished"},isMyList:function(){return this.filterName==="my"},isCopyableList:function(){return this.filterName==="copyable"},_searchKeyboardEvent:function(e){e.keyCode==13&&this._search(e)},_search:function(e){var t=$(e.currentTarget).closest(".table_search"),n=t.find("select[name=searchtype]"),i=t.find("input[name=keyword]"),s=n.val(),o=i.val();console.log(e);if(!o||o&&(o.length<2||o.length>64))return $.goAlert(r.getStringLengthError(2,64)),!1;this.dataTable.tables.fnSettings().sAjaxSource=this.getSearchUrl(),this.dataTable.tables.customParams={searchtype:s,keyword:o},this.dataTable.tables.fnClearTable()},_startSurveys:function(){c(this,"progress")},_stopSurveys:function(){c(this,"stop")},_finishedSurveys:function(){c(this,"finished")},_removeSurveys:function(){c(this,"remove")},preview:function(e){e.preventDefault();var n=t.contextRoot+"app/survey/"+$(e.currentTarget).closest("tr").find("input").val()+"/preview";window.open(n,"surveyPreview","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},copySurvey:function(e){var n=$(e.currentTarget);this.$el.find("input.copyable").prop("checked",!1);if(n.attr("id")==="checkedAll")return;$(e.currentTarget).prop("checked",!0),$.goConfirm(u["\uc124\ubb38\uc744 \ubcf5\uc0ac\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],u["\uc124\ubb38 \ubcf5\uc0ac \uc54c\ub9bc"],function(){var e=t.contextRoot+"api/survey/"+n.val()+"/copy";$.ajax(e,{method:"POST"}).done(function(e){t.router.navigate("survey/"+e.data.id+"/copied/edit",{trigger:!0,pushState:!0})})},function(){n.prop("checked",!1)})}});return a})})();