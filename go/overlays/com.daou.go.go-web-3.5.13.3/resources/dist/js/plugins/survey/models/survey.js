(function(){define(["underscore","backbone","amplify","app","survey/collections/queries","survey/collections/response_queries"],function(e,t,n,r,i,s){function u(t,n,i){var s=r.config("contextRoot")+e.result(t,"url")+"/"+n,o=e.extend(i||{},{url:s.replace("//","/")});return t.save({status:n},o)}function a(e,t){return r.util.toISO8601(e+"T"+t)}var o=t.Model.extend({urlRoot:"/api/survey",queryCollection:null,initialize:function(){this.queryCollection=null},start:function(e){return u(this,"progress",e)},stop:function(e){return u(this,"stop",e)},finished:function(e){return u(this,"finished",e)},addAttachFile:function(e){var t=this.getAttaches();return t.push(e),this.set("attaches",t),this},removeAttachFile:function(e){var t=this.getAttaches(),n=-1;for(var r=0,i=t.length;r<i;r++)if(t[r].name===e.name){n=r;break}return t.splice(n,1),this.set("attaches",t),this},isTargetCompany:function(){return this.isNew()?!0:this.get("targetAll")},isCreator:function(e){return this.isNew()?!0:this.get("creator").id===e},isTempSaved:function(){return this.get("status")==="temp"},isReady:function(){return this.get("status")==="ready"},isStarted:function(){return this.get("status")==="progress"},isBeforeStart:function(){return this.isReady()||this.isTempSaved()},isStopped:function(){return this.get("status")==="stop"},isProgressing:function(){return e.contains(["progress","stop"],this.get("status"))},isReferrer:function(t){var n=!1;return e.each(this.get("referrers"),function(e,r){if(e.id==t){n=!0;return}}),n},isFinished:function(){return this.get("status")==="finished"},isPublic:function(){var e=this.get("visible");return typeof e=="undefined"?!0:e},isPrivate:function(){return!this.isPublic()},isAllday:function(){return this.get("allday")||!1},setQueryCollection:function(e){this.queryCollection=e},getQueryCollection:function(){return this.queryCollection},hasQuery:function(){return!this.queryCollection||this.queryCollection.length>0},setFromFormData:function(e){var t=e.allDay&&e.allDay==="Y";this.set({title:e.title,startTime:e.start_date+" 00:00",endTime:e.end_date+" 23:59",status:this.isNew()?"temp":this.get("status"),allday:t?!0:!1,targetAll:e.target==="whole"?!0:!1,visible:e.visible==="Y",noti:"none",commentable:e.use_comment==="Y",editable:e.editable==="Y",deptName:e.deptName||""})},getQueryList:function(t){var n=this;e.defaults(t||{},{async:!0,success:function(e){},error:function(){}}),this.isResponseNone()||t.previewMode?queries=new i:queries=new s,queries.setSurveyId(this.id),queries.fetch({async:t.async,success:function(e){n.setQueryCollection(e),t.success.apply(queries,arguments)},error:function(){t.error.apply(queries,arguments)}})},editable:function(){var e=this.get("editable");return typeof e=="undefined"?!0:e},commentable:function(){var e=this.get("commentable");return typeof e=="undefined"?!0:e},getTitle:function(){return this.get("title")||""},getDeptName:function(){return this.get("deptName")||""},getResponseStatus:function(){return this.get("responseStatus")||"none"},getCreatorName:function(){return this.get("deptName")?this.get("deptName"):this.getDisplayName("creator")},getDisplayName:function(e){var t=this.get(e);return[t.name,t.position].join(" ")},getTargetNodes:function(){var e=this.get("target")||[];return e.hasOwnProperty("nodes")?e.nodes:[]},gerReferrers:function(){return this.get("referrers")||[]},getTargetCount:function(){return this.get("targetCount")||0},getResponseCount:function(){return this.get("responseCount")||0},getNoResponseCount:function(){var e=this.getTargetCount()-this.getResponseCount();return e<0?0:e},getCommentCount:function(){return this.get("commentCount")||0},getAttaches:function(){return this.get("attaches")||[]},isResponseDone:function(){return this.getResponseStatus()==="done"},isResponseNone:function(){return this.getResponseStatus()==="none"},isResponseTemp:function(){return this.getResponseStatus()==="temp"},isIncludedReferrer:function(t){return e.where(this.get("referrers"),{id:t}).length>0},hasDeptName:function(){return!!this.get("deptName")},getGuidance:function(){var e=this.get("guidance");if(e=="undefined"||e==null)return"";var t=""+e;return t=r.util.textToHtml(t),t=r.util.autolink(t,{"data-bypass":"true",target:"_blank"}),t},reorderQueries:function(){!this.queryCollection||this.queryCollection.reorder()}},{getModelFromStorage:function(){return new o(r.util.storage().get(r.session("loginId")+"-tempsave-survey-model"))},saveModelToStorage:function(e){r.util.storage().get(r.session("loginId")+"-tempsave-survey-model",e.toJSON())}});return o})})();