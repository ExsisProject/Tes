(function(){define(["backbone","app","survey/models/survey_response","survey/collections/queries","survey/views/query/response","survey/libs/util","i18n!survey/nls/survey","jquery.go-popup"],function(e,t,n,r,i,s,o){function f(e,t){t.each(function(e,t){this.addQueryView(e)},e)}function l(e){var t=[];return t.push('<div class="survey_box">'),t.push('<ul class="survey"></ul>'),t.push("</div>"),e.isStarted()&&!e.previewMode&&(t.push('<div class="survey_action">'),t.push('<a href="#" class="btn-complete btn_major" data-role="button"><span class="txt">'+o["\uc124\ubb38 \uc81c\ucd9c"]+"</span></a>"),e.isResponseDone()||t.push('<a href="#" class="btn-tempsave btn_minor" data-role="button"><span class="txt">'+o["\uc784\uc2dc\uc800\uc7a5"]+"</span></a>"),t.push("</div>")),t.join("\n")}function c(e,n){return n=n||!1,t.config("contextRoot")+"api/survey/"+e.id+"/response"+(n?"/tempsave":"")}var u=!1,a=e.View.extend({tagName:"div",id:"query-resp-form",events:{"click .btn-complete":"_compelteSurvey","click .btn-tempsave":"_tempSave"},initialize:function(){this.model||(this.model=new n),this.template=l(this.model)},render:function(){var e=this;this.$el.append(this.template),this.model.getQueryList({previewMode:e.model.previewMode,success:function(t){f(e,t)}})},addQueryView:function(e){var t=new i({model:e});this.$el.find(".survey_box .survey").append(t.el),t.render()},save:function(e){if(u)return;e=e||!1;var n=this,r=[],i=this.$el.find(".query-response"),a=e?o["\uc124\ubb38 \uc751\ub2f5 \uc784\uc2dc\uc800\uc7a5 \ud655\uc778 \uba54\uc2dc\uc9c0"]:o["\uc124\ubb38 \uc81c\ucd9c \ud655\uc778 \uba54\uc2dc\uc9c0"];for(var f=0,l=i.length;f<l;f++){var h=$(i[f]).data("instance");if(!e&&!h.validate())return r=[],!1;r.push(h.getUpdatedModel().toJSON())}return this._confirm(a,function(){t.EventEmitter.trigger("common","layout:setOverlay",""),u=!0,$.ajax(c(this.model,e),{method:this.model.isResponseNone()||this.model.isResponseTemp()?"POST":"PUT",data:JSON.stringify({surveyQueryModels:r}),dataType:"json",contentType:"application/json"}).done(function(r){n.model.set("responseStatus",e?"temp":"done"),t.EventEmitter.trigger("common","layout:clearOverlay",!0),t.router.navigate("survey/"+n.model.id,{trigger:!0,pushState:!0}),u=!1}).fail(function(e){t.EventEmitter.trigger("common","layout:clearOverlay",!0);var n=e.error().responseJSON;if(n.name=="DuplicateRequestException"){var r=n.message.split(",");s.raiseRequestError(r[0],r[1])}else s.raiseRequestError();u=!1})}),u=!1,!0},complete:function(){this.save(!1)},tempsave:function(){this.save(!0)},_compelteSurvey:function(e){return this.complete(),!1},_tempSave:function(e){return this.tempsave(),!1},_confirm:function(e,t){s.confirm(e,"",_.bind(t,this))}});return a})})();