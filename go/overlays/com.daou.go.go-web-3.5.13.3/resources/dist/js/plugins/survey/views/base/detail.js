(function(){define(["backbone","app","survey/models/survey_response","survey/libs/util","i18n!nls/commons","i18n!survey/nls/survey"],function(e,t,n,r,i,s){function u(e,n){var r,i,s=t.session("id"),o=n.isCreator(s);if(e.forceResponseView)r=e.ResponseView;else if(n.isProgressing()){if(n.isResponsible())n.isResponseDone()?r=e.ResultView:r=e.ResponseView;else if(o||n.isIncludedReferrer(s))r=e.ResultView}else n.isBeforeStart()&&o?r=e.ResponseView:n.isFinished()&&(r=e.ResultView);i=new r({model:n,previewMode:n.previewMode}),e.$el.find(".queryview-placeholder").replaceWith(i.el),i.render()}var o=e.View.extend({className:"content_page",events:{"click .btn-change-status":"_changeStatus","click .btn-remove-survey":"_removeSurvey","click .btn-copy-survey":"copySurvey","click .btn-list":"_goToList","click .btn-modify-resp":"_modifyResponse"},lang:{start_survey:i["\uc9c4\ud589"],stop_survey:i["\uc911\uc9c0"],finished_survey:s["\ub9c8\uac10"]},ResponseView:null,DetailResultView:null,forceResponseView:null,initialize:function(e){this.options=e||{},this.forceResponseView=this.options.forceResponseView||!1,this.previewMode=this.options.previewMode,this.model||(this.model=new n)},setResponseView:function(){this.forceResponseView=!0},accessible:function(){var e=t.session("id");if(this.model.isCreator(e)||this.model.isIncludedReferrer(e))return!0;if(this.model.isResponsible()){if(this.model.isResponseNone()&&this.model.attributes.status=="finished"&&this.model.attributes.visible==0)return!1;if(this.model.isResponseNone()||this.model.isResponseTemp())return!0;if(this.model.isResponseDone()&&this.model.isPublic())return!0;if(this.model.isResponseDone()&&this.forceResponseView===!0)return!0}return this.previewMode&&t.session("integratedCompanies").length>1?!0:!1},getConfirmTextClass:function(){return"txt_caution"},removeSurvey:function(){this.model.destroy({success:_.bind(function(){this.remove(),r.goToLastList()},this),error:function(){r.raiseRequestError()}})},copySurvey:function(){var e=this;$.goConfirm(s["\uc124\ubb38\uc744 \ubcf5\uc0ac\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],s["\uc124\ubb38 \ubcf5\uc0ac \uc54c\ub9bc"],function(){var n=t.contextRoot+"api/survey/"+e.model.id+"/copy";$.ajax(n,{method:"POST"}).done(function(n){var r="survey/"+n.data.id+"/copied/edit";if(e.previewMode){var i=t.contextRoot+"app/"+r;window.close(),window.opener.location.href=i}else t.router.navigate(r,{trigger:!0,pushState:!0})})})},_confirmSuvey:function(e,n,i){r.confirm(i,_.bind(function(){this.model[e].call(this.model,{success:_.bind(function(e){n=="modify_progress"?t.router.navigate("survey/"+this.model.id+"/edit",{trigger:!0,pushState:!0}):t.router.navigate("survey/"+this.model.id,{trigger:!0,pushState:!0})},this),error:function(){r.raiseRequestError()}})},this))},_changeStatusForMobile:function(e){var t,n,r,i;switch(e){case"progress":n="stop",r="stop",i=this.lang.start_survey,t=s["\uc124\ubb38 \uc911\uc9c0 \uc548\ub0b4 \uba54\uc2dc\uc9c0"];break;case"temp":n="start",r="progress",i=this.lang.stop_survey,t=s["\uc124\ubb38 \uc2dc\uc791 \uc548\ub0b4 \uba54\uc2dc\uc9c0"]}this._confirmSuvey(n,e,t)},_changeStatus:function(e){var t=$(e.currentTarget),n=t.attr("data-status"),r=this.getConfirmTextClass(),i,o,u,a;switch(n){case"progress":o="stop",u="stop",a=this.lang.start_survey,i=s["\uc124\ubb38 \uc911\uc9c0 \uc548\ub0b4 \uba54\uc2dc\uc9c0"];break;case"modify_progress":o="stop",i=s["\uc9c4\ud589\uc911 \uc124\ubb38 \uc218\uc815 \uc54c\ub9bc"];break;case"stop":case"temp":o="start",u="progress",a=this.lang.stop_survey,i=s["\uc124\ubb38 \uc2dc\uc791 \uc548\ub0b4 \uba54\uc2dc\uc9c0"];break;case"finished":o="finished",u="finished",a=this.lang.finished_survey,i=s["\uc124\ubb38 \ub9c8\uac10 \ud655\uc778 \ud0c0\uc774\ud2c0"]}this._confirmSuvey(o,n,i)},_modifyResponse:function(e){t.router.navigate("survey/"+this.model.id+"/response/edit",{trigger:!0,pushState:!0})},_removeSurvey:function(e){r.confirm(s["\uc124\ubb38 \uc0ad\uc81c \ud655\uc778 \ud0c0\uc774\ud2c0"],s["\uc124\ubb38 \uc0ad\uc81c \ud655\uc778 \uba54\uc2dc\uc9c0"],_.bind(this.removeSurvey,this))},_goToList:function(e){r.goToLastList()},_renderDetailSubView:function(e){return u(this,e)}});return o})})();