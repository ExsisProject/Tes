(function(){define(["jquery","backbone","survey/models/survey_response","survey/helpers/html","i18n!survey/nls/survey","go-charts"],function(e,t,n,r,i){function o(){if(GO.util.checkOS()==="android")return!1;e(window).off(".plot").on("orientationchange.plot",function(t){e(".graph-placeholder").each(function(t,n){var r=e(n),i=r.data("plot");i.resize(),i.draw()})})}function u(){var e=[];return e.push('<div class="survey_action">'),e.push('<a class="btn-modify-resp btn_major" data-role="button"><span class="txt">'+i["\uc751\ub2f5 \uc218\uc815"]+"</span></a>"),e.push("</div>"),e.join("\n")}function a(e,t){t.each(function(e,t){this.addQueryView(e)},e),e.responseEditable()&&e._renderActtionButton()}function f(t,n,r){var i,s,o=[];n.getResponseCount()>0&&n.isGroupOfSelect()&&(s=e('<div class="legend-placeholder"></div>'),i=e('<div class="graph-placeholder"></div>'),i.css({"margin-top":"10px",width:"100%","max-width":"500px",height:"250px"}),r.append(i,s),_.each(n.getCases(),function(e,t){o.push({label:_.escape(e.description),data:e.count,caseId:e.id})}),l(i,s,o))}function l(t,n,r){var s={series:{pie:{show:!0,innerRadius:.35,label:{show:!0,radius:1,formatter:function(e,t){return'<span class="number" style="color:'+t.color+'">'+parseInt(t.percent*100)/100+"%</span>"}}}},grid:{hoverable:!0},tooltip:!0,tooltipOpts:{shifts:{x:20,y:0},defaultTheme:!0,onHover:function(e,t){var n=e.series;parseInt(t.css("left").replace("px",""))<0&&t.css({left:window.event.x+20+"px"}),t.html("<span class='txt' style='max-width: 300px;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;'>"+n.label+"</br> (<span class='number'>"+n.data[0][1]+"</span>"+i["\uc778\uc6d0 \ud45c\uc2dc \ub2e8\uc704"]+")"+parseInt(n.percent*100)/100+"%"+"</span>")}},legend:{show:!0,labelFormatter:function(e,t){return'<span style="txt">'+e+' (<span class="number">'+t.data[0][1]+"</span>"+i["\uc778\uc6d0 \ud45c\uc2dc \ub2e8\uc704"]+")</span>"},container:n,position:"nw"}},o={grid:{hoverable:!1}};GO.util.isMobile()&&(s=e.extend({},s,o));var u=e.plot(t,r,s);n.find("td.legendColorBox").width("18px"),n.find("td.legendLabel").css({"font-size":"12px",padding:"5px"})}function c(e,t,n){var r=[],s=e.model,o=s.getTargetCount(),u=t.getResponseCount(),a=u>0?(u/o*100).toFixed(2):"0",f=t.get("type");r.push('<dl class="result_survey_info">'),r.push('<dt><span class="txt">'+i["\uc804\uccb4 \ucc38\uc5ec\uc790"]+" :</span></dt>"),r.push('<dd><span class="number">'+o+'</span><span class="txt">'+i["\uc778\uc6d0 \ud45c\uc2dc \ub2e8\uc704"]+"</span></dd>"),r.push('<dt><span class="txt">'+i["\ucc38\uc5ec\uc728"]+" :</span></dt>"),r.push("<dd>"),r.push('<span class="number">'+u+'</span><span class="txt">'+i["\uc778\uc6d0 \ud45c\uc2dc \ub2e8\uc704"]+"</span>"),f!=="score"&&(r.push('<span class="gage_wrap"><span class="gage" style="width:'+a+'%"></span></span>'),r.push('<span class="number">'+a+"%</span>")),r.push("</dd>"),f==="score"&&(r.push('<dt><span class="txt">'+i["\ud3c9\uade0 \uc810\uc218"]+" :</span></dt>"),r.push('<dd><span class="average-txt number">'+h(t)+"</span></dd>")),r.push("</dl>"),n.append(r.join("\n"))}function h(e){var t=e.getResponseCount(),n=e.getCases(),r=0,i=0;return t>0&&(r=_.reduce(n,function(e,t){return e+(parseInt(t.description)||0)*(t.count||0)},0),i=(r/t).toFixed(2)),i}var s=t.View.extend({tagName:"div",className:"survey_box",initialize:function(){this.model||(this.model=new n),this.template='<div class="survey_box"><ul class="survey"></ul></div>',o()},render:function(){var e=this;this.$el.append(this.template),this.model.getQueryList({success:function(t){a(e,t)}})},addQueryView:function(t){var n=e("<li>"+this._makeQueryViewTemplate(t)+"</li>");n.appendTo("ul.survey"),this._makeQueryInfo(t,n.find(".wrap_answer")),this._renderGraph(t,n.find(".wrap_answer"))},responseEditable:function(){return this.model.isFinished()?!1:this.model.editable()?this.model.isResponsible()?!0:!1:!1},_makeQueryViewTemplate:function(e){return r.getQueryViewTemplate(e,"div")},_renderActtionButton:function(){this.$el.find(".survey_box").after(u())},_makeQueryInfo:function(e,t){c(this,e,t)},_renderGraph:function(e,t){f(this,e,t)}});return s})})();