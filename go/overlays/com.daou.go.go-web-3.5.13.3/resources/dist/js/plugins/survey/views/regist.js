(function(){define(["jquery","underscore","backbone","app","survey/models/survey","survey/views/regist/target","survey/libs/util","helpers/form","hgn!survey/templates/regist","i18n!nls/commons","i18n!survey/nls/survey","go-nametags","libraries/go-classcodepicker","jquery.go-popup","jquery.go-orgslide","jquery.go-preloader"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){function E(t){var n=t.find("input[name=title]"),i=t.find("input[name=deptName]"),s=n.val(),a=i.val();if(!s)return u.printError(n,l["\uc124\ubb38 \uc81c\ubaa9 \ud544\uc218 \uc624\ub958 \uba54\uc2dc\uc9c0"]),!1;r.util.isXSSPettern(s)&&n.val(r.util.escapeXssToBlank(s));if(s&&(s.length<p||s.length>d))return u.printError(n,o.getStringLengthError(p,d)),!1;if(a&&(a.length<v||a.length>m))return u.printError(i,o.getStringLengthError(v,m)),!1;if(T()){if(t.find("select[name=target_type]").val()==="part"){var f=e("#target-class-div");if(t.find("input[name=targetpart]:checked").length<=0)return e.goAlert(l["\uc124\ubb38\ub300\uc0c1 \ubbf8\uc9c0\uc815 \uc624\ub958 \uba54\uc2dc\uc9c0"]),!1;if(e("#checkbox-targetpart-dept").is(":checked")&&e("#target-dept-table > tbody > tr").length<=0)return e.goAlert(l["\uc124\ubb38\ub300\uc0c1 \ubd80\uc11c \ubbf8\uc9c0\uc815 \uc624\ub958 \uba54\uc2dc\uc9c0"]),!1;if(e("#checkbox-targetpart-class").is(":checked")&&f.find(".list_option > li").length<=0)return e.goAlert(l["\uc124\ubb38\ub300\uc0c1 \ud074\ub798\uc2a4 \ubbf8\uc9c0\uc815 \uc624\ub958 \uba54\uc2dc\uc9c0"]),!1;if(!S("#checkbox-targetpart-user"))return x(),!1}}else{if(!t.find("input[name=target]:checked").length)return x(),!1;if(!S("#radio-target-user"))return x(),!1}return!0}function S(t){return e(t).is(":checked")?e("#target-user-div").find("li:not(.add-btn)").length>0:!0}function x(){return o.alert(l["\uc124\ubb38\ub300\uc0c1 \uc0ac\uc6a9\uc790 \ubbf8\uc9c0\uc815 \uc624\ub958 \uba54\uc2dc\uc9c0"])}function T(){return r.session("surveyAdmin")||!1}function N(){return{nodes:e("#target-container").data("targetview").getList()}}function C(){var n=e("#referer-list").data("instance"),r=[];return t.each(n.getNameTagList(),function(e){r.push(t.pick(e,"id","name","email","position"))}),r}function k(n,i){i=t.defaults(i||{},{title:"",type:"list",desc:"",removable:!0}),n.$el.on("nametag:clicked-add",function(s){e.goOrgSlide({header:i.title,type:i.type,desc:i.desc,contextRoot:r.config("contextRoot"),memberTypeLabel:l["\ucc38\uc870\uc790 \uc124\uc815"],externalLang:f,isBatchAdd:!0,callback:function(e){var r=t.isArray(e)?e:[e];t.each(r,function(e){var r=e.position?e.name+" "+e.position:e.name;n.addTag(e.id,r,{attrs:e,removable:t.result(i,"removable")})})}})})}var p=2,d=64,v=2,m=64,g="YYYY-MM-DD",y="HH:mm",b={label:{title:l["\uc124\ubb38 \uc81c\ubaa9"],survey_period:l["\uc124\ubb38 \uae30\uac04 \uc124\uc815"],allday:l["\uc885\uc77c"],survey_target:l["\uc124\ubb38 \ub300\uc0c1\uc790 \uc124\uc815"],setup_referer:l["\ucc38\uc870\uc790 \uc124\uc815"],add_item:l["\ucd94\uac00"],open_result:l["\uc124\ubb38 \uacb0\uacfc \uacf5\uac1c"],"public":l["\uacf5\uac1c"],"private":l["\ube44\uacf5\uac1c"],use_comment:l["\ub313\uae00 \uc0ac\uc6a9"],usable:l["\uc0ac\uc6a9"],unusable:l["\uc0ac\uc6a9\uc548\ud568"],editable:l["\ucc38\uc5ec \ud6c4 \uc218\uc815 \ud5c8\uc6a9"],permit:l["\ud5c8\uc6a9"],not_permit:l["\ud5c8\uc6a9\uc548\ud568"],setup_creator:l["\uc791\uc131\uc790 \uc774\ub984 \ubcc0\uacbd"],next_step:l["\ub2e4\uc74c"],cancel:l["\ucde8\uc18c"],tempsave:l["\uc784\uc2dc\uc800\uc7a5"],add_dept:l["\ubd80\uc11c\ucd94\uac00"],finished:l["\uc791\uc131 \uc644\ub8cc"]},msg:{about_referer:l["\uc124\ubb38 \uacb0\uacfc \uc5f4\ub78c \uac00\ub2a5 \uc548\ub0b4 \uba54\uc2dc\uc9c0"],about_copyable_target:l["\uc124\ubb38 \ubcf5\uc0ac \uac00\ub2a5 \ub300\uc0c1\uc790 \uc548\ub0b4\uba54\uc2dc\uc9c0"],about_open_result:l["\uc124\ubb38 \ucc38\uc5ec\uc790 \uacb0\uacfc \uacf5\uac1c \uc548\ub0b4\uba54\uc2dc\uc9c0"],about_setup_creator:l["\uc124\ubb38 \ub4f1\ub85d\uc790 \uc124\uc815 \uc548\ub0b4 \uba54\uc2dc\uc9c0"],about_target:l["\uc124\ubb38 \ub300\uc0c1\uc790 \uc124\uc815 \uc548\ub0b4 \uba54\uc2dc\uc9c0"]}},w=n.View.extend({tagName:"div",className:"content_page survey_form go_renew",events:{"click #btn-next":"_saveAndNext","click #btn-cancel":"_cancel","click #all-day":"_toggleTimeSelect","click #btn-finished":"_saveAndNext"},initialize:function(){this.model||(this.model=new i)},render:function(){var t=r.util.now(),n=r.util.toMoment(this.model.get("startTime"))<t?t:r.util.toMoment(this.model.get("startTime")),i=r.util.toMoment(this.model.get("endTime"))<t?t:r.util.toMoment(this.model.get("endTime"));this.$el.append(a(e.extend(!0,b,{title:this.model.getTitle(),start_date:(this.model.isNew()?t:n).format(g),start_time:(this.model.isNew()?r.util.getIntervalTime(t):n).format(y),end_date:(this.model.isNew()?t.clone().add("days",1).startOf("days"):i).format(g),end_time:this.model.isNew()?"00:00":i.format(y),deptName:this.model.getDeptName(),"admin?":T(),"allday?":this.model.isAllday(),"target_company?":this.model.isTargetCompany(),"private?":this.model.isPrivate(),"use_comment?":this.model.commentable(),"editable?":this.model.editable(),"stopped?":this.model.isStopped()}))),this.initDatepicker(),this.targetView=s.create("#target-container",this.model,T()),this.addReferrerListView(),this.toggleSelectTime(e("#all-day"))},initDatepicker:function(){var t=this.$("#start-date"),n=this.$("#end-date");e.datepicker.setDefaults(e.datepicker.regional[r.config("locale")]),t.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,minDate:r.util.customDate(new Date,"YYYY-MM-DD"),yearSuffix:"",onClose:function(e){e&&t.trigger("change:startdate",[e]),n.datepicker("option","minDate",moment(e).toDate())}}),n.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,minDate:t.val(),yearSuffix:"",onClose:function(e){e&&n.trigger("change:enddate",[e])}})},addReferrerListView:function(){var n=this.model.isCreator(r.session("id")),i=[],s;t.each(this.model.gerReferrers(),function(e){i.push({id:e.id,title:e.name+" "+e.position,options:{attrs:e,removable:n}})}),s=c.create(i,{useAddButton:!0,useRemoveAll:!0}),e("#referer-list").append(s.el).data("instance",s),k(s,{title:l["\ucc38\uc870\uc790 \ucd94\uac00"],desc:l["\ucc38\uc870\uc790 \ucd94\uac00 \uc548\ub0b4 \uba54\uc2dc\uc9c0"],removable:n})},toggleSelectTime:function(e){this.$el.find(".select_date").hide()},_saveAndNext:function(t){var n=e("#survey-form"),i,s,u=this.model.isStopped(),a={};return u&&(a={noti:"false",status:"progress"}),E(n)?(s=e.goPreloader(),s.render(),i=r.util.serializeForm(e("#survey-form")),this.model.setFromFormData(i),this.targetView.isTargetAll()?(this.model.set("target",{}),this.model.set("targetAll",!0)):(this.model.set("target",N()),this.model.set("targetAll",!1)),this.model.set("referrers",C()),this.model.save(a,{success:function(e){u?r.router.navigate("survey/list/my",{trigger:!0,pushState:!1}):r.router.navigate("survey/"+e.id+"/query/editor",{trigger:!0,pushState:!0})},error:function(e){o.raiseRequestError()}}).done(function(){s.release()}),!0):!1},_toggleTimeSelect:function(t){this.toggleSelectTime(e(t.currentTarget))},_cancel:function(){return o.goToLastList()}});return w})})();