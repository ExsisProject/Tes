define("works/views/app/form_manager",function(require){function y(e){return new v(function(t,n,r){e.fetch({success:t,error:n})})}function b(e){var t=$(window).height(),n=GO.session("theme")==="THEME_ADVANCED",r=n?0:e.getHeaderElement().outerHeight();return t-r}var e=require("backbone"),t=require("when"),n=require("views/layouts/default"),r=require("works/models/applet_baseconfig"),i=require("works/models/applet_form"),s=require("works/components/formbuilder/formbuilder"),o=require("go-ignoreduplicatemethod"),u=require("works/views/app/layout/app_content_top"),a=require("works/components/formbuilder/core/component_manager"),f=require("works/libs/util"),l=require("works/components/formbuilder/constants"),c=require("hgn!works/templates/app/app_home_form_tab"),h=require("i18n!works/nls/works"),p=require("i18n!nls/commons");require("jquery.go-popup"),require("jquery.go-preloader");var d=n.extend({name:"form_manager",className:"go_skin_default go_skin_edit go_skin_works go_renew",_init:function(){this.setUseSide(!1),this.setUseContentWrapper(!1)}},{__instance__:null}),v=function(){return t.promise.apply(this,arguments)},m=function(e){e=e||{},this.appletId=null,this.contentTopView=null,this.formBuilder=null,this.layoutView=d.create(),GO.session().theme!=="THEME_ADVANCED"&&this.layoutView.setUseOrganogram(!1);if(!e.hasOwnProperty("appletId"))throw new Error("\uc571 ID\uac00 \ud544\uc694\ud569\ub2c8\ub2e4.");this.appletId=e.appletId,this.baseConfigModel=new r({id:this.appletId}),this.appletFormModel=new i({appletId:this.appletId})},g=!1;return _.extend(m.prototype,e.Events,{render:function(){var e=this,n=this.layoutView,r=this.formBuilder;return t(n.render()).then(function(){return e._fetchAccessibleForms()}).then(function(){return y(e.baseConfigModel)}).then(function(){return y(e.appletFormModel)}).then(_.bind(this.renderMe,this)).otherwise(function(t){console.log(t.stack)})},renderMe:function(){f.checkAppManager(this.baseConfigModel.get("admins")),this.appletFormModel.get("mainForm")&&(this.mainFormModel=GO.util.clone(this.appletFormModel,!0)),this.formBuilder=s.createBuilder(this.appletFormModel.toJSON()),this.layoutView.setContent(this.formBuilder),this.formBuilder.render(),this._renderContentTopView(),this.formBuilder.resize(b(this.layoutView)),this._bindWindowResizeEvent(),this.listenTo(this.formBuilder,l.REQ_CHANGE_FORM,this._changeForm),this.listenTo(this.formBuilder,l.REQ_CREATE_FORM,this._createForm),this.listenTo(this.formBuilder,l.REQ_FORM_SAVE,this._saveForm),this.listenTo(this.formBuilder,l.REQ_DELETE_SUBFORM,this._deleteSubForm),this.listenTo(this.formBuilder,l.REQ_GOTO_SETTINGS_HOME,this._goToSettingsHome),this.listenTo(this.formBuilder,l.REQ_GOTO_APP_HOME,this._goToAppHome)},remove:function(){this.stopListening(),this.formBuilder.remove(),$(window).off(".formmanager")},_renderContentTopView:function(){this.contentTopView=new u({appletId:this.appletId,accessibleForms:this.accessibleForms,subFormId:this.appletFormModel.get("subFormId"),isFormManager:!0,baseConfigModel:this.baseConfigModel,pageName:h["\uc785\ub825\ud654\uba74 \uad00\ub9ac"],useActionButton:!1,isSetting:!0,description:h["\uc785\ub825\ud654\uba74 \uad00\ub9ac \uc124\uba85"]}),this.formBuilder.setContenTopElement(this.contentTopView.el),this.contentTopView.render();var e=this;this.accessibleForms.length>0&&($(this.contentTopView.el).after(c({forms:this.accessibleForms,isSelect:function(){return this.mainForm?GO.util.isInvalidValue(e.appletFormModel.get("subFormId")):this.id==e.appletFormModel.get("subFormId")},isFormManager:!0})),$(".tab_menu_wrap").scroll(function(t){e._onScrollMoveTab(t)}),$("span[el-arrow-tab]").click(function(t){e._onClickMoveTab(t)}),$(".tab_menu_wrap").animate({scrollLeft:$("li.active").attr("data-id")=="tab_main"?0:$("#tabMenu").scrollLeft()-$("#tabMenu").offset().left+$("li.active").offset().left-45},200),this.__onScrollMoveTab($(".tab_menu_wrap")))},_onScrollMoveTab:function(e){this.__onScrollMoveTab($(e.currentTarget))},__onScrollMoveTab:function(e){var t=e.scrollLeft();t+e.innerWidth()+80>=e[0].scrollWidth?$(".tab_arrow.right").hide():$(".tab_arrow.right").show(),t==0?$(".tab_arrow.left").hide():$(".tab_arrow.left").show()},_onClickMoveTab:function(e){var t=$(e.currentTarget).hasClass("ic_arrow_next");t?$(".tab_menu_wrap").animate({scrollLeft:"+=460"},200):$(".tab_menu_wrap").animate({scrollLeft:"-=460"},200)},_fetchAccessibleForms:function(){var e=this;$.ajax({type:"GET",dataType:"json",async:!1,url:GO.config("contextRoot")+"api/works/applets/"+this.appletId+"/accessible/form/list",success:function(t){e.accessibleForms=t.data;var n=e.accessibleForms[0];n.mainForm?e.subFormId=null:e.subFormId=n.id}})},_changeForm:function(e){return this.appletFormModel=new i({appletId:this.appletId}),e!="tab_main"&&(this.appletFormModel.set("type","subform_setting"),this.appletFormModel.set("subFormId",e)),t(y(this.appletFormModel)).then(_.bind(this.renderMe,this)).otherwise(function(t){console.log(t.stack)})},_createForm:function(){var e=new i({appletId:this.appletId,type:"subform_setting"});if(this.accessibleForms.length>30){$.goAlert(GO.i18n(h["\ud558\uc704\ud3fc \ucd94\uac00 \uac1c\uc218\uc81c\ud55c \uc548\ub0b4"],{arg1:"30"}));return}var t=this.accessibleForms.length==1?null:_.filter(this.accessibleForms,function(e){return!e.mainForm}).last(),n=_.isNull(t)?h["\ud558\uc704\ud3fc"]+1:h["\ud558\uc704\ud3fc"]+this.accessibleForms.length,r=_.isNull(t)?0:t.seq+1,s=this;this.popupView=$.goPopup({pclass:"layer_normal",header:h["\ud558\uc704\ud3fc \ucd94\uac00"],contents:'<p class="desc">'+h["\uba54\uc778 \ud3fc\uc758 \ucef4\ud3ec\ub10c\ud2b8\ub97c \ubaa8\ub450 \uac00\uc838\uc624\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"]+"</br>"+h["\uba54\uc778 \ud3fc \uac00\uc838\uc624\uae30 \uc124\uba85"]+"</p>",buttons:[{btext:h["\uac00\uc838\uc624\uae30"],btype:"normal",callback:$.proxy(function(){e.set("name",n),e.set("seq",r),e.set("data",s.mainFormModel.get("data")),e.save({},{success:function(e){$.goMessage(p["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),s._fetchAccessibleForms(),s.appletFormModel=e,s.appletFormModel.set("subFormId",e.id),s.renderMe()},error:function(e,t){$.goError(t.responseJSON.message)}})},this)},{btext:h["\ud3fc\ub9cc \ucd94\uac00"],callback:$.proxy(function(){var t=GO.util.clone(s.mainFormModel.get("data"),!0);t.components=[],e.set("name",n),e.set("seq",r),e.set("data",t),e.save({},{success:function(e){$.goMessage(p["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),s._fetchAccessibleForms(),s.appletFormModel=e,s.appletFormModel.set("subFormId",e.id),s.renderMe()},error:function(e,t){$.goError(t.responseJSON.message)}})},this)}]})},_saveForm:function(e,t,n){if(g){$.goSlideMessage(h["\uc800\uc7a5\uc911 \uba54\uc138\uc9c0"]);return}var r=$.goPreloader(),i=this;this.appletFormModel.save({data:e.data,name:e.name,accessSetting:e.accessSetting,accessTarget:e.accessTarget,exceptionTarget:e.exceptionTarget},{beforeSend:function(){r.render(),g=!0},success:function(e){$.goSlideMessage(h["\uc800\uc7a5 \ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),a.clearNewComponent(),i._fetchAccessibleForms(),this.appletFormModel=e,this.appletFormModel.get("mainForm")||this.appletFormModel.set("subFormId",e.get("id")),i.renderMe(),_.isFunction(t)&&t(e)},error:function(e){_.isFunction(n)&&n(e)},complete:function(){r.release(),g=!1}})},_deleteSubForm:function(t,n,r){var i=t.appletId,s=t.subFormId,o=this;$.goConfirm(p["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],h["\ud558\uc704\ud3fc\uc744 \uc0ad\uc81c\ud574\ub3c4 \ub370\uc774\ud130\ub294 \uc720\uc9c0\ub429\ub2c8\ub2e4."],_.bind(function(){var t=new e.Model;t.url=GO.config("contextRoot")+"api/works/applets/"+i+"/subform/"+s,t.save(null,{type:"DELETE",contentType:"application/json",success:function(){$.goSlideMessage(p["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o._fetchAccessibleForms(),o._changeForm("tab_main")},error:function(e,t){$.goError(e.message)}})},this))},_bindWindowResizeEvent:function(){var e=this,t=new o;$(window).on("resize.formmanager",function(n){if(!$.isWindow(n.target))return;t.bind(function(){e.formBuilder.resize(b(e.layoutView))})})},_goToSettingsHome:function(){this.remove(),GO.router.navigate("works/applet/"+this.appletId+"/settings/home",{trigger:!0})},_goToAppHome:function(){this.remove(),GO.router.navigate("works/applet/"+this.appletId+"/home",{trigger:!0})}}),m});