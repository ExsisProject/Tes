define("works/views/mobile/app_home",function(require){var e=require("works/constants/field_type");require("jquery.bxslider");var t=require("backbone"),n=require("when"),r=require("works/libs/util"),i=require("i18n!nls/commons"),s=require("i18n!works/nls/works"),o=require("works/models/applet_share"),u=require("works/components/list_manager/models/list_setting"),a=require("works/components/filter/models/filter_manager"),f=require("works/models/applet_baseconfig"),l=require("works/components/masking_manager/models/masking"),c=require("works/collections/docs"),h=require("works/collections/fields"),p=require("works/components/chart/collections/chart_settings"),d=require("works/personal_list_manager/collections/personal_list_settings"),v=require("views/mobile/header_toolbar"),m=require("works/views/mobile/app_home_filter"),g=require("works/components/chart/views/chart"),y=require("works/components/doc_list/views/doc_list"),b=require("hgn!works/templates/mobile/app_home"),w=require("hgn!works/templates/mobile/app_home_form_tab"),E=Hogan.compile(['<select id="settingList" style="width: 69px">','<option value="0">'+s["\uae30\ubcf8\ud615"]+"</option>","{{#collection}}",'<option value="{{id}}">{{name}}</option>',"{{/collection}}","</a>"].join("")),S=c.extend({isEmpty:function(){return this.models.length===0},mobilePageInfo:function(){var e=this.pageInfo(),t=e.pageNo,n=e.total,r=e.pageSize,i=e.pageNo===e.lastPageNo,s=t*r+1,o=i?n:(t+1)*r;return{lastIndex:o,firstIndex:s}}}),x={total:s["\ucd1d"],count:s["\uac74"],addr:s["\ud3f4\ub354 \uc8fc\uc18c"],copy:i["\ubcf5\uc0ac"],showShareInfo:s["\uacf5\uac1c/\uacf5\uc720 \ud604\ud669 \ubcf4\uae30"],admin:s["\uc6b4\uc601\uc790"],state:i["\uc0c1\ud0dc"],title:i["\uc81c\ubaa9"],dueDate:s["\uae30\ud55c"],assignee:s["\ub2f4\ub2f9\uc790"],activity:s["\ud65c\ub3d9\uae30\ub85d"],prev:i["\uc774\uc804"],next:i["\ub2e4\uc74c"],notReadable:s["\uc5f4\ub78c \uad8c\ud55c\uc774 \uc5c6\ub294 \uc5c5\ubb34\uc785\ub2c8\ub2e4"],empty:s["\ubbf8\uc9c0\uc815"]},T='<li class="creat data_null"><span class="subject"><span class="txt">'+s["\ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+"</span>"+"</span>"+"</li>",N=Hogan.compile('<li data-id="{{doc.id}}" data-type="doc" data-bypass=""><a href="#" class="tit" data-bypass="">{{#doc.titleIsMasking}}<span class="ic_hidden_data"></span>{{/doc.titleIsMasking}}{{^doc.titleIsMasking}}<span class="subject">{{{doc.titleText}}}</span>{{/doc.titleIsMasking}}<ul class="info">{{#doc.columns}}{{#visible}}<li><span class="txt">- {{label}} : {{^isMasking}}{{{data}}}{{/isMasking}}{{#isMasking}}<span class="ic_hidden_data"></span>{{/isMasking}}</span></li>{{/visible}}{{/doc.columns}}</ul></a></li>');return t.View.extend({el:"#content",events:{"vclick li[data-type=doc]":"goAppDetail","vclick a[data-value]":"paging","vclick [el-form-tab]":"_onChangeForm","change #settingList":"_onChangeSettingList"},initialize:function(e){this.$el.off(),this.$el.removeClass("bg_card_type go_works_home list_type"),this.options=e,this.appletId=e.appletId,this.filterId=e.filterId||r.getFilterStorage("works/applet/"+this.appletId+"/filter/mobile"),this.charts=new p,e.hasOwnProperty("appletId")&&(this.baseConfigModel=new f(e.hasOwnProperty("appletId")?{id:e.appletId}:null)),this.filters=new a({appletId:this.appletId}),this.baseSetting=new u({},{appletId:this.appletId}),this.share=new o({id:this.appletId}),this.fields=new h([],{appletId:this.appletId,subFormId:this.subFormId,includeProperty:!0}),this.masking=new l({appletId:this.appletId}),this.masking.fetch(),this.maskings={},this.fieldsOfIntegrationApplet={},this.docs=new S([],{appletId:this.appletId,subFormId:this.subFormId,includeActivityCount:!0}),this.settingId=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-works-list-setting",null)||"0",this.setting=new u({},{appletId:this.appletId}),this.settings=new d([],{appletId:this.appletId}),this.settings.fetch(),$.when(this.fields.deferred,this.baseSetting.deferred,this.settings.deferred).then($.proxy(function(){this._initSetting()},this)),this.$el.html(b({lang:x,list:this.docs.toJSON(),page:_.extend(this.docs.pageInfo(),this.docs.mobilePageInfo())})),this.$el.on("searchByFilter",$.proxy(function(e,t){this._search(t)},this)),this.docs.bind("reset",this.renderList,this),this.$el.on("searchByKeyword",$.proxy(function(e,t){this._search({queryString:'textContent:"'+t+'"'}).done($.proxy(function(){this._highlighting(t)},this))},this))},dataFetch:function(){var e=$.Deferred();return GO.util.preloader(e),$.when(this.setAccessibleForms()).then($.proxy(function(){return $.when(this.baseConfigModel.fetch(),this.fields.fetch(),this.baseSetting.fetch(),this.share.fetch(),this.settings.deferred,this.masking.deferred)},this)).done($.proxy(function(){return this.fetchIntegrationDatas()},this)).done($.proxy(function(){var t=this.baseSetting.getSortColumnFieldCid();this.docs.property=this.fields.getPropertyByFieldCid(t),this.docs.direction=this.baseSetting.getSortDirection(),this.charts.reset(this.setting.get("charts")),this._renderChartsView(),e.resolve(this),this._renderSettingList()},this)).fail(function(){GO.util.linkToCustomError({code:404,message:s["\uc0ad\uc81c\ub41c \ud3fc \uc811\uadfc"]})}),e},fetchIntegrationDatas:function(){var e=$.Deferred();return this.fields.getFieldsOfIntegrationApplet().done(_.bind(function(t){this.fieldsOfIntegrationApplet=t,e.resolve()},this)),e},render:function(){var e=this,t={title:this.baseConfigModel.get("name"),isList:!0,isSideMenu:!0,isHome:!0,isSearch:!0};this._isWritable()&&(t.isWriteBtn=!0,t.writeBtnCallback=function(){GO.util.isValidValue(e.subFormId)?GO.router.navigate("works/applet/"+e.appletId+"/doc/new/"+e.subFormId,{trigger:!0,pushState:!0}):GO.router.navigate("works/applet/"+e.appletId+"/doc/new",{trigger:!0,pushState:!0})}),v.render(t),$("#titleToolbar").hide();var e=this,n=!1;return this.$("div.content_tab").remove(),this.$("#filterSection").after(w({forms:this.accessibleForms,isSelect:function(){return this.mainForm?GO.util.isInvalidValue(e.subFormId)?(n=!0,!0):!1:this.id==e.subFormId?(n=!0,!0):!1}})),n||$(".tab_menu>li").first().addClass("active"),$(".tab_menu_wrap").animate({scrollLeft:$("li.active").attr("data-id")=="tab_main"?0:$("li.active").offset().left-100},200),this.renderFilterView(),this},goAppDetail:function(e){var t=e.currentTarget.getAttribute("data-id");e.preventDefault(),this.docs.storeParam();var n=this.docs.map(function(e){return e.id});GO.util.store.set(GO.session("id")+"-"+this.appletId+"-docIdsTable",n,{type:"session"}),GO.util.isValidValue(this.subFormId)?GO.router.navigate("works/applet/"+this.appletId+"/doc/"+t+"/navigate/"+this.subFormId,!0):GO.router.navigate("works/applet/"+this.appletId+"/doc/"+t+"/navigate",!0)},renderFilterView:function(){this.filterView=new m({appletId:this.appletId,filters:this.filters,filterId:this.filterId,fields:this.fields}),this.$("#filterSection").append(this.filterView.el),this.filterView.render()},renderList:function(){this.$("#docList").find("li").remove();if(this.docs.isEmpty()){this.$("#docList").append(T);return}var e=this._parseCollection(this.docs);_.each(e,function(e){this.$("#docList").append(N.render({lang:x,doc:e}))},this);var t=this.docs.pageInfo();t.prev?this.$("#prev").show():this.$("#prev").hide(),t.next?this.$("#next").show():this.$("#next").hide()},_renderChartsView:function(){this.charts.mergeFromFields(this.fields),this.$("div.card_item_wrapper").empty(),this.charts.each(function(e){if(e.get("hasDeletedField"))return;var t=new g({model:e,appletId:this.appletId,chartFields:this.fields.getChartFields(),numberFields:this.fields.getNumberFields(),useToolbox:!1});this.$("div.card_item_wrapper").append(t.el),t.render(),t.fetchChartDatas()},this);if(!this.charts.length){this.$("div[el-chart-wrapper]").hide();return}this.$("div[el-chart-wrapper]").show();var e=parseInt(($(window).width()-40)/350),t=e>1?350:0,n=e>1?10:0,r={pager:!1,hideControlOnEnd:!0,infiniteLoop:!1,minSlides:e,maxSlides:e+1,slideWidth:t,slideMargin:n,onSliderLoad:function(){$("div.bx-viewport").css("height",""),$("div.bx-viewport").removeClass(),$("div.bx-controls").css({"background-color":"transparent"}),$("a.bx-prev").css({"margin-top":"-215px"}),$("a.bx-next").css({"margin-top":"-215px"}),$("a.bx-prev").attr("href","javascript:void(0);"),$("a.bx-next").attr("href","javascript:void(0);")}};this.slider?this.slider.reloadSlider(r):this.slider=this.$("div.card_item_wrapper").bxSlider(r),this.$(".card_item_wrapper").children().length<1&&this.$("div[el-chart-wrapper]").hide()},_search:function(e){return this.docs.queryString=e.queryString,e.useStorePage||(this.docs.pageNo=0),this.docs.fetch({success:$.proxy(function(){this.setCurrentPage(),this.charts.setQueryString(e.queryString),GO.EventEmitter.trigger("common","layout:scrollToTop",this)},this)})},paging:function(e){var t=$(e.currentTarget),n=t.attr("data-type"),r=this.docs.pageInfo();if(n==="prev"&&!r.prev)return;if(n==="next"&&!r.next)return;var i=this,s=t.attr("data-value");this.docs.setPageNo(this.docs.pageInfo().pageNo+parseInt(s)),this.docs.fetch({success:function(){i.setCurrentPage(),GO.EventEmitter.trigger("common","layout:scrollToTop",this)}})},setCurrentPage:function(){var e=_.extend(this.docs.pageInfo(),this.docs.mobilePageInfo());this.$("#listCurrent").text(e.firstIndex),this.$("#listMax").text(e.lastIndex),this.$("#listTotal").text(" / "+e.total)},setAccessibleForms:function(){var e=this,t=$.Deferred();return $.ajax({type:"GET",dataType:"json",url:GO.config("contextRoot")+"api/works/applets/"+this.appletId+"/accessible/form/list",success:function(n){var r=GO.util.store.get(GO.session("id")+"-"+e.appletId+"-works-mobile-subform")||{};e.accessibleForms=n.data;if(e.accessibleForms.length<1){GO.util.linkToCustomError({code:403,message:s["\ud3fc \uc811\uadfc\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+" "+s["\ud3fc \uc811\uadfc\uad8c\ud55c \uc5c6\uc74c \uc124\uba85"]});return}if(r.subFormId)e.subFormId=r.subFormId;else{var i=e.accessibleForms[0];i.mainForm?e.subFormId=null:e.subFormId=i.id,r.subFormId=e.subFormId}GO.util.store.set(GO.session("id")+"-"+e.appletId+"-works-mobile-subform",r,{type:"session"}),t.resolve()},error:t.reject}),t},_getUserLabel:function(e){var t=e.position?" "+e.position:"";return e.name+t},_renderMasking:function(){return'<div class="hidden_data"><span class="help" title="'+s["\uad00\ub9ac\uc790\uc5d0 \uc758\ud574 \ub9c8\uc2a4\ud0b9 \ucc98\ub9ac \ub41c \ud56d\ubaa9\uc785\ub2c8\ub2e4"]+'"></span>'+"</div>"},_parseCollection:function(e){var t=_.clone(e),n=this.fields.getColumnFields(),r=this.setting.getColumns(n);return r=this._setMasking(r),_.map(t.models,function(e){var t=_.map(r,function(t){var n=t.get("columnName")||t.get("label"),r=t.get("isMasking")&&!e.isCreator(GO.session("id"));return{visible:!0,label:n,data:r?this._renderMasking():this.getColumnData(e,t,!1,!0),isMasking:r}},this),n=t[this.baseSetting.get("titleColumnIndex")];return GO.util.isValidValue(n)&&(n.visible=!1),e.has("activityCount")&&t.push({label:s["\ud65c\ub3d9\uae30\ub85d"],data:e.get("activityCount"),visible:!0}),{id:e.id,columns:t,titleText:!n||_.isEmpty(n.data)?"-":n.data,titleIsMasking:GO.util.isInvalidValue(n)?!1:n.isMasking}},this)},_isWritable:function(){var e=this.baseConfigModel.isAdmin(GO.session("id")),t=this.share.get("addDocRoles"),n=_.contains(t,"MEMBER");return e||n},_highlighting:function(e){var t=this.$("span.subject");_.each(t.contents(),function(t){t.data&&(t.parentNode.innerHTML=t.data.replace(new RegExp(e,"gi"),'<strong class="txt_key">'+e+"</strong>"))})},_renderSettingList:function(){this.$(".btn_submenu").append(E.render({collection:this.settings.toJSON()}));var e=this.$("#settingList"),t=e.find('[value="'+this.settingId+'"]').length?this.settingId:"0";this.$("#settingList").val(t)},_initSetting:function(){if(parseInt(this.settingId)){var e=this.settings.get(this.settingId);e?this.setting.set(_.extend(e.get("view"),{id:e.id})):this.setting.set(this.baseSetting.toJSON())}else this.setting.set(this.baseSetting.toJSON())},_setMasking:function(t){var n=this.masking.get("fieldCids");return _.each(t,function(t){var r;if(t.get("fieldType")===e.FIELD_MAPPING){n=this._getIntegrationAppletMaskingByFieldMappingCid(t.get("cid"));var i=t.get("properties")||{};r=_.contains(n,i.targetFieldCid)}else r=_.contains(n,t.get("cid"));t.set("isMasking",r)},this),t},_getIntegrationAppletMaskingByFieldMappingCid:function(e){var t=this.fields.findWhere({cid:e}),n=t?t.get("properties")||{}:{},r=n.targetComponentCid,i=this.fields.findWhere({cid:r}),s=i?i.get("properties")||{}:{},o=s.integrationAppletId,u=this.maskings[o];return u?u.get("fieldCids"):[]},_onChangeSettingList:function(e){var t=$(e.currentTarget).val();GO.util.store.set(GO.session("id")+"-"+this.appletId+"-works-list-setting",t),this.settingId=t,this._initSetting(),this.charts.reset(this.setting.get("charts")),this._renderChartsView(),this.renderList()},_onChangeForm:function(e){var t=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-works-mobile-subform")||{},n=$(e.currentTarget).attr("data-id");n==="tab_main"?delete t.subFormId:(t.subFormId=n,this.subFormId=n),GO.util.store.set(GO.session("id")+"-"+this.appletId+"-works-mobile-subform",t,{type:"session"}),GO.router.navigate("works/applet/"+this.appletId+"/home",{trigger:!0,pushState:!1,replace:!0})},_onClickMoveTab:function(e){var t=$(e.currentTarget).hasClass("ic_arrow_next");t?$(".tab_menu_wrap").animate({scrollLeft:"+=460"},200):$(".tab_menu_wrap").animate({scrollLeft:"-=460"},200)},getColumnData:y.prototype.getColumnData,getProperties:y.prototype.getProperties})});