define("works/views/app/workflow_graph",function(require){function d(e,t,n,r){if(!r)return;var i=JSON.parse(r);if(!i)return;i.forEach(function(r){if("stat"==r.type){if(!r.name){n.geometryX=r.geometryX,n.geometryY=r.geometryY;return}_.forEach(e,function(e){if(r.name==e.name){e.geometryX=r.geometryX,e.geometryY=r.geometryY;return}})}else"transition"==r.type&&_.forEach(t,function(e){e.beforeStatus==r.beforeStatus&&r.nextStatus==e.nextStatus&&(e.geometryX=r.geometryX,e.geometryY=r.geometryY)})})}function v(){var e=document.getElementById("graphContainer"),t=new mxEditor;return t.setGraphContainer(e),t}function m(){var e=editor.graph,t=e.getModel();e.border=80,e.getView().translate=new mxPoint(e.border/2,e.border/2),e.graphHandler.setRemoveCellsFromParent(!1),e.alternateEdgeStyle="elbow=vertical",e.setPanning(!0),e.setTooltips(!0),e.setConnectable(!0),e.setAllowDanglingEdges(!1),e.setDropEnabled(!0),e.setSplitEnabled(!1),e.view.setTranslate(20,20),e.panningHandler.useLeftButtonForPanning=!0,mxGraphHandler.prototype.guidesEnabled=!0,y(e),e.isValidTarget=function(e){return e.isEdge()?!1:this.isSwimlane(e)?!1:e.isStartCell()?!1:!0},e.isValidConnection=function(e,t){return this.isValidTarget(t)?e.isStartCell()&&e.getEdgeCount()>0?($.goError(r["\uc2dc\uc791 \uc0c1\ud0dc\ub294 1\uac1c\ub9cc \uc120\ud0dd\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."]),!1):H(e,t)?($.goError(r["\uc0c1\ud0dc \ud750\ub984\uc740 \ub3d9\uc77c\ud55c \uc2dc\uc791\uc0c1\ud0dc\uc640 \ub2e4\uc74c\uc0c1\ud0dc\ub97c \uac00\uc9c8 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1):!0:!1},e.isPool=function(e){var n=t.getParent(e);return n!=null&&t.getParent(n)==t.getRoot()},e.getSelectionModel().addListener(mxEvent.CHANGE,function(e,t){x()}),mxGraph.prototype.convertValueToString=function(e){if(mxUtils.isNode(e.value)){var t="";e.isEdge()?t=e.getAttribute("actionName"):t=e.getAttribute("name")}else"start"==e.style&&(t="START");return t},mxGraph.prototype.getLabel=function(e){var t=this.labelsVisible?this.convertValueToString(e):"",n=this.model.getGeometry(e);return t==null||n==null?t:!this.model.isCollapsed(e)&&h<t.length&&(n.offset==null||n.offset.x==0&&n.offset.y==0)&&this.model.isVertex(e)&&n.width>=2?t.substring(0,h-1)+"...":t},mxCellEditor.prototype.startEditing=function(e,t){return},mxConstraintHandler.prototype.pointImage=new mxImage("/resources/images/dot.gif",3,3),mxGraph.prototype.createVertex=function(t,n,r,i,s,o,u,a,f){var l=e.getModel();cells=O(l);if(cells)for(var c=0;c<cells.length;c++)if(cells[c].geometry.x==i&&cells[c].geometry.y==s)return i+=200,i>p&&(i=200,s+=100),d=e.insertVertex(t,n,r,i,s,o,u,a,f);var h=new mxGeometry(i,s,o,u);h.relative=f!=null?f:!1;var d=new mxCell(r,h,a);return d.setId(n),d.setVertex(!0),d.setConnectable(!0),"process"==a&&(d.value=M(r),W(d)),d},mxGraph.prototype.insertEdge=function(e,t,n,r,i,s){var o=this.createEdge(e,t,n,r,i,s);return this.addEdge(o,e,r,i,"",n)},mxGraph.prototype.addEdge=function(e,t,n,r,i,s){s||(s={});if(H(n,r))return;return e.value=M(s),this.addCell(e,t,i,n,r)},mxCell.prototype.getAttribute=function(e,t){var n=this.getValue(),r=n!=null&&n.nodeType==mxConstants.NODETYPE_ELEMENT?n.getAttribute(e):null;return _.startsWith(e,"is")?"true"==r:r!=null?r:t},mxCell.prototype.getAttributes=function(){var e={},t=this;return S(this).forEach(function(n){if(n.indexOf("Roles")>=0){e[n]=[],t.getAttribute(n).split(",").forEach(function(t){e[n].push(t)});return}e[n]=t.getAttribute(n)}),e},mxCell.prototype.isStartCell=function(){return this.style=="start"},mxCell.prototype.isStartFlow=function(){if(!this.isEdge())return!1;var e=this.source;return e?e.isStartCell():!1},mxCell.prototype.getTop=function(){if(this.isEdge()&&this.geometry.points){var e=1e3;return _.map(this.geometry.points,function(t){t.y<e&&(e=t.y)}),e}return this.isVertex()&&this.geometry?this.geometry.y:0},mxCell.prototype.getBottom=function(){if(this.isEdge()&&this.geometry.points){var e=0;return _.map(this.geometry.points,function(t){e<t.y&&(e=t.y)}),e}return this.isVertex()&&this.geometry?this.geometry.y:0},mxCell.prototype.getLeft=function(){if(this.isEdge()&&this.geometry.points){var e=1e3;return _.map(this.geometry.points,function(t){t.x<e&&(e=t.x)}),e}return this.isVertex()&&this.geometry?this.geometry.x:0},mxCell.prototype.getRight=function(){if(this.isEdge()&&this.geometry.points){var e=0;return _.map(this.geometry.points,function(t){e<t.x&&(e=t.x)}),e}return this.isVertex()&&this.geometry?this.geometry.x+this.geometry.width:0},mxGraphModel.prototype.getCellByName=function(e){var t=C(this);return t==null?null:_.find(t,function(t){return e==t.getAttribute("name")})},mxGraphModel.prototype.getCellByTypeAndId=function(e,t){var n=C(this);if(n==null)return null;for(var r=0;r<n.length;r++){if(cell.isVertex()&&"vertex"!=e)continue;if(cell.isEdge()&&"edge"!=e)continue;if(t==n[r].getAttribute("id"))return n[r]}return null},mxShape.prototype.constraints=[new mxConnectionConstraint(new mxPoint(.5,0),!0),new mxConnectionConstraint(new mxPoint(0,.5),!0),new mxConnectionConstraint(new mxPoint(1,.5),!0),new mxConnectionConstraint(new mxPoint(.5,1),!0)],mxGraph.prototype.getAllConnectionConstraints=function(e,t){if(e.cell.isEdge())return;if(e!=null&&e.shape!=null)if(e.shape.stencil!=null){if(e.shape.stencil.constraints!=null)return e.shape.stencil.constraints}else if(e.shape.constraints!=null)return e.shape.constraints;return null},E.prototype.destroy=function(){this.images!=null&&this.images.forEach(function(e){e.parentNode.removeChild(e)}),this.images=null};var n=e.getStylesheet().getDefaultVertexStyle();n=mxUtils.clone(n),n[mxConstants.STYLE_RESIZABLE]="0",n[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_RECTANGLE,n[mxConstants.STYLE_STROKE_OPACITY]=0,n[mxConstants.STYLE_FONTCOLOR]="#ffffff",n[mxConstants.STYLE_FONTSIZE]=13,n[mxConstants.STYLE_FONTSTYLE]=1,n[mxConstants.STYLE_ROUNDED]=!0,n[mxConstants.STYLE_HORIZONTAL]=!0,n[mxConstants.STYLE_VERTICAL_ALIGN]="middle",e.getStylesheet().putCellStyle("process",n),n=mxUtils.clone(n),n[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_ELLIPSE,n[mxConstants.STYLE_ROUNDED]=!0,n[mxConstants.STYLE_FILLCOLOR]="#FFFFFF",n[mxConstants.STYLE_STROKE_OPACITY]=100,n[mxConstants.STYLE_STROKECOLOR]="#000000",n[mxConstants.STYLE_FONTCOLOR]="#000000",delete n[mxConstants.STYLE_SPACING_RIGHT],e.getStylesheet().putCellStyle("start",n),n=e.getStylesheet().getDefaultEdgeStyle(),n[mxConstants.STYLE_EDGE]=mxEdgeStyle.SegmentConnector,n[mxConstants.STYLE_ENDARROW]=mxConstants.ARROW_BLOCK,n[mxConstants.STYLE_ROUNDED]=!0,n[mxConstants.STYLE_FONTCOLOR]="#656565",n[mxConstants.STYLE_STROKECOLOR]="#cccccc",n[mxConstants.STYLE_FONTSIZE]=12,n[mxConstants.STYLE_LABEL_BACKGROUNDCOLOR]="#f4f4f4",e.getStylesheet().putDefaultEdgeStyle(n);var i=new mxStackLayout(e,!1);i.fill=!0,i.isVertexIgnored=function(t){return!e.isSwimlane(t)};var s=new mxLayoutManager(e);s.getLayout=function(n){return!t.isEdge(n)&&t.getChildCount(n)>0&&(t.getParent(n)==t.getRoot()||e.isPool(n))?(i.fill=e.isPool(n),i):null};var o=new mxKeyHandler(e);return o.getFunction=function(t){if(t==null)return;if(t.code=="Delete"||t.key=="Del"){var n=e.getSelectionCells(),r=[];n.forEach(function(e){if(e.isStartCell())return;r.push(e),e.isVertex()&&T(e.getAttribute("name")).remove()}),e.removeCells(r),mxEvent.consume(t)}},jQuery(window).resize(function(){jQuery("#graphContainer").css("height",$(window).height()-248)}),e}function g(e){var t=$("#zoomActions");t.empty();var n=$(mxUtils.button("+",function(){e.zoomIn()}));n.attr("title",i["\ud655\ub300"]),t.append(n);var r=$(mxUtils.button("\u2013",function(){e.zoomOut()}));r.attr("title",i["\ucd95\uc18c"]),t.append(r),$("a[btn-close-sort-wrap]").click(function(){$("#workflow_sort_wrap").hide()}),$("button[btn-open-sort-wrap]").click(function(){$("#workflow_sort_wrap").show()})}function y(e){var t;e.addMouseListener({cell:null,mouseUp:function(e,n){if(!n.state){t&&t.images&&(t.destroy(),t=null);return}var r=t.images[0];r.style.left=n.state.x+n.state.width+"px",r.style.top=n.state.y-16+"px"},mouseDown:function(e,n){!n.state&&t?(t.destroy(),t=null):n.state&&!t&&(t=new E(n.state))},mouseMove:function(e,t){var n=t.getCell();n!=this.cell&&(this.cell!=null&&this.dragLeave(t.getEvent(),this.cell),this.cell=n,this.cell!=null&&this.dragEnter(t.getEvent(),this.cell))},dragEnter:function(t,n){if(e.getSelectionCell()!=null)return;b(e,n)},dragLeave:function(n,r){if(e.getSelectionCell()!=null)return;w(e),t!=null&&(t.destroy(),t=null)}})}function b(e,t){var n="fontStyle=1;strokeWidth=2;strokeColor=#999999",r=e.getModel();r.beginUpdate();if(t.edge)r.execute(new mxStyleChange(r,t,n));else if(t.edges&&t.edges.length>0)for(var i=0;i<t.edges.length;i++)r.execute(new mxStyleChange(r,t.edges[i],n));r.endUpdate()}function w(e){var t="fontStyle=0;strokeWidth=1;strokeColor=#cccccc",n=e.getModel();n.beginUpdate();if(n.cells)for(var r in n.cells){var i=n.cells[r];i.edge&&n.execute(new mxStyleChange(n,i,t))}n.endUpdate()}function E(e){if(!e||e.cell.isStartCell())return;this.images=[];var t=mxUtils.createImage("/resources/images/ic_delete.png");t.setAttribute("title","Delete"),t.style.position="absolute",t.style.cursor="pointer",t.style.width="16px",t.style.height="16px",t.style.left=e.x+e.width+"px",t.style.top=e.y-16+"px",mxEvent.addGestureListeners(t,mxUtils.bind(this,function(e){mxEvent.consume(e)})),mxEvent.addListener(t,"click",mxUtils.bind(this,function(t){graph.removeCells([e.cell]),mxEvent.consume(t),e.cell.isVertex()&&T(e.cell.getAttribute("name")).remove(),this.destroy()})),e.view.graph.container.appendChild(t),this.images.push(t)}function S(e){var t=[];return e.value.attributes.forEach(function(e){t.push(e.name)}),t}function x(){var e=document.getElementById("workflow_properties"),t=graph.getSelectionCell();w(graph),mxClient.IS_IE?jQuery("#workflow_properties [type=text]").focusout():jQuery("#workflow_properties [type=text]").blur(),jQuery("#workflow_properties").hide(),jQuery("#workflow_properties div").remove();if(t!=null&&!t.isStartCell()){b(graph,t),t.isEdge()?(jQuery("#workflow_properties").show(),z.call(this,t,e)):(jQuery("#workflow_properties").show(),U.call(this,t));var n=function(e){var n=e.currentTarget.name,r=[];_.forEach(jQuery("input[name="+n+"]"),function(e){e.checked&&r.push(e.value)});var i=graph.getModel();i.beginUpdate(),i.execute(new mxCellAttributeChange(t,n,r)),i.endUpdate()},r=function(e){var n=e.currentTarget.name,r=e.currentTarget.value||"",i=t.getAttribute(n);if(r!=i){if(t.isVertex()&&!D(r))return;if(t.isEdge()&&!P(r))return;var s=graph.getModel();s.beginUpdate(),s.execute(new mxCellAttributeChange(t,n,r));var o=T(i);o.attr("stat-name",r),o.find("span.txt").text(q(r)),s.endUpdate()}};mxClient.IS_IE?(jQuery("#workflow_properties [type=checkbox]").change(this,n),jQuery("#workflow_properties [type=text]").focusout(this,r)):(jQuery("#workflow_properties [type=checkbox]").change(this,n),jQuery("#workflow_properties [type=text]").blur(this,r))}}function T(e){return jQuery('#workflow_sort_layer li[stat-name="'+e+'"]')}function N(e){return jQuery('#workflow_sort_layer li[stat-name="'+e+'"]').index()}function C(e){return Object.keys(e.cells).map(function(t){return e.cells[t]})}function k(e){var t=_.find(C(graph.getModel()),function(t){return t.getAttribute("name")==e});return t?!0:!1}function L(e){var t=C(e),n=[];return t?(t.forEach(function(e){e.isEdge()&&!e.source.isStartCell()&&n.push(e)}),n):n}function A(e){var t=C(e),n=[];return t?(t.forEach(function(e){e.isVertex()&&!e.isStartCell()&&n.push(e)}),n):n}function O(e){var t=C(e),n=[];return t?(t.forEach(function(e){e.isVertex()&&n.push(e)}),n):n}function M(e){var t=mxUtils.createXmlDocument(),n=t.createElement("node");return Object.keys(e).forEach(function(t){var r=e[t];r!=0&&!r&&(r=""),n.setAttribute(t,r)}),n}function D(e){if(!e)return $.goError(GO.i18n(r["{{arg1}}\uc740 \ud544\uc218\uc785\ub825 \uc0ac\ud56d\uc785\ub2c8\ub2e4."],{arg1:s["\uc0c1\ud0dc\uba85"]})),!1;if(e.length<2||e.length>20)return $.goError(GO.i18n(i["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"20"})),!1;var t=_.find(A(graph.getModel()),function(t){return e==t.getAttribute("name")});return t?($.goError(s["\uc774\ubbf8 \uc0ac\uc6a9\uc911\uc778 \uc774\ub984\uc785\ub2c8\ub2e4."]),!1):!0}function P(e){return e?e.length<2||e.length>100?($.goError(GO.i18n(i["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"100"})),!1):!0:($.goError(GO.i18n(r["{{arg1}}\uc740 \ud544\uc218\uc785\ub825 \uc0ac\ud56d\uc785\ub2c8\ub2e4."],{arg1:r["\uc0c1\ud0dc\ubcc0\uacbd \ubc84\ud2bc\uba85"]})),!1)}function H(e,t){var n=graph.getModel();return _.find(L(n),function(n){return n.source==e&&n.target==t})}function B(e,t){var n=graph.getModel();return _.find(L(n),function(n){return n.source==t&&n.target==e})}function j(e,t){return _.find(e,function(e){return t==e.name})}function F(e){var t=graph.getDefaultParent(),n=graph.insertVertex(t,e.id,e,e.geometryX,e.geometryY,a,f,"process");I(e,n)}function I(e,t){e.color=graph.getStylesheet().getCellStyle(t.getStyle())[mxConstants.STYLE_FILLCOLOR],e.displayName=q(e.name),jQuery("#workflow_sort_layer").append(u({lang:o,stat:e}))}function q(e){return e.length>h?e.substring(0,h-1)+"...":e}function R(e,t,n){if(k(e.name))return;!e.geometryX&&!e.geometryY&&(e.geometryX=400,e.geometryY=300),F(e),n.forEach(function(r){if(r.beforeStatus==e.name){var i=j(t,r.nextStatus);R(i,t,n)}})}function U(e){var t=e.getAttributes(),r=new n({graph:graph,cell:e,model:t,stats:A(graph.getModel()),setColor:W});this.$("#workflow_properties").append(r.render().el),r.$el.data("instance",t),r.on("changeStatName",this.xi,this)}function z(e,n,r){var i=graph.getSelectionCell().isStartFlow(),s=e.getAttributes(),o=new t({model:s,isFirst:i,roles:i?_.reject(ROLES,function(e){return e.value=="REGISTRANT"}):ROLES,collection:this.stats,lang:this.lang});n?this.$(n).append(o.render().el):this.$("#workflow_properties").append(o.render().el),o.$el.data("instance",s)}function W(e){var t=graph.getModel().getStyle(e),n=X(e.getAttribute("color")),r=mxUtils.setStyle(t,mxConstants.STYLE_FILLCOLOR,n),i=[];i.push(e),T(e.getAttribute("name")).find("span.state").css("background-color",n),graph.setCellStyle(r,i)}function X(e){return 1==e?"#905341":2==e?"#d06b64":3==e?"#d75269":4==e?"#fa573c":5==e?"#ff7537":6==e?"#ffad46":7==e?"#42d692":8==e?"#16a765":9==e?"#7bd148":10==e?"#b3dc6c":11==e?"#fbe983":12==e?"#fad165":13==e?"#f691b2":14==e?"#cd74e6":15==e?"#9a9cff":16==e?"#b99aff":17==e?"#6691e5":18==e?"#000000":"#A3A3A3"}var e=require("backbone");require("mxgraph.mxClient");var t=require("works/views/app/workflow_flow_item"),n=require("works/views/app/workflow_stat_item"),r=require("i18n!works/nls/works"),i=require("i18n!nls/commons"),s=require("i18n!admin/nls/admin"),o={"\ub4dc\ub798\uadf8 \uba54\uc2dc\uc9c0":r["\ud574\ub2f9 \uc601\uc5ed\uc744 \uc7a1\uace0 \uc774\ub3d9 \uc2dc \uc21c\uc11c\ub97c \ubcc0\uacbd\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."]},u=require("hgn!works/templates/app/workflow_stat_sort_item"),a=80,f=25,l=190,c=300,h=6,p=window.innerWidth-470;return e.View.extend({editor:null,graph:null,initialize:function(){if(!mxClient.isBrowserSupported()){mxUtils.error("Browser is not supported!",200,!1);return}},render:function(){editor=v(),graph=m(),g(graph),jQuery(window).trigger("resize"),$("#workflow_sort_layer").sortable()},addStat:function(e){if(!D(e.name))return!1;var t=graph.getDefaultParent(),n=graph.insertVertex(t,null,e,l,c-100,a,f,"process");return I(e,n),!0},drawJsonData:function(e,t,n,r,i){var s=graph.getDefaultParent(),o=graph.getModel();ROLES=i,o.beginUpdate();try{var u=0,h=0,p={geometryX:l,geometryY:c};d(e,t,p,n),e.forEach(function(e,t){e.seq=t}),e.forEach(function(n){R(n,e,t)}),t.forEach(function(e){var t=o.getCellByName(e.beforeStatus),n=o.getCellByName(e.nextStatus);if(!t||!n)return;var r=graph.insertEdge(s,e.id,e,t,n);if(!r)return;var i=t.id-n.id;if(e.geometryX&&e.geometryY){r.geometry.points=[];for(var a=0;a<e.geometryX.length;a++)r.geometry.points.push(new mxPoint(e.geometryX[a],e.geometryY[a]))}else if(i<-1){var f=t.geometry;r.geometry.points=[],r.geometry.points.push(new mxPoint(f.x+f.width/2,f.y+f.height/2+40*++u))}else if(0<i){var f=t.geometry;r.geometry.points=[],r.geometry.points.push(new mxPoint(f.x+f.width/2,f.y+f.height/2-40*++h))}});var v=graph.insertVertex(s,null,"start",p.geometryX,p.geometryY,a,f,"start"),m=o.getCellByName(r.nextStatus);m&&graph.insertEdge(s,null,r,v,m),jQuery("#workflow_sort_layer").html(jQuery("#workflow_sort_layer li").sort(function(e,t){return $(e).attr("stat-idx")-$(t).attr("stat-idx")}))}finally{o.endUpdate()}},isValidData:function(){if(jQuery("#workflow_properties [type=text]").length>0)return $.goError(r["\uc218\uc815\uc0ac\ud56d\uc774 \ubc18\uc601\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4"]),!1;var e=C(graph.getModel());for(var t=0;t<e.length;t++){var n=e[t];if(n.isEdge()&&!n.isStartFlow()&&!P(n.getAttribute("actionName")))return!1}return!0},getTemplate:function(){var e=graph.getModel(),t=[];return C(e).forEach(function(e){var n={};if(e.isVertex())n.type="stat",n.name=e.getAttribute("name"),n.geometryX=e.geometry.x,n.geometryY=e.geometry.y,t.push(n);else if(e.isEdge()){var r=e.getGeometry().points;n.type="transition",n.beforeStatus=e.source.getAttribute("name"),n.nextStatus=e.target.getAttribute("name"),r&&(n.geometryX=[],n.geometryY=[],_.forEach(r,function(e){n.geometryX.push(e.x),n.geometryY.push(e.y)})),t.push(n)}}),t},getStats:function(){var e=graph.getModel(),t=[];return A(e).forEach(function(e){var n=e.getAttributes();n.seq=N(e.getAttribute("name"));var r=e.edges;n.start=!1,r&&r.forEach(function(e){e.isStartFlow()&&(n.start=!0)}),t.push(n)}),t.sort(function(e,t){return e.seq-t.seq})},getTransitions:function(){var e=graph.getModel(),t=[];return L(e).forEach(function(e){if(e.isStartFlow())return;var n=e.getAttributes();n.beforeStatus=e.source.getAttribute("name"),n.nextStatus=e.target.getAttribute("name"),t.push(n)}),t},getFirstFlow:function(){var e=graph.getModel(),t=_.find(C(e),function(e){return e.isStartFlow()});if(t){var n=t.getAttribute("pushRoles");return n?n.split(","):(n=[],n)}},disabled:function(){if(!graph.enabled)return;graph.enabled=!1},enabled:function(){if(graph.enabled)return;graph.enabled=!0}})});