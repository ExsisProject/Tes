define("works/components/doc_list/views/doc_list",function(require){require("jquery.tooltipster");var e=require("works/constants/value_type"),t=require("works/constants/field_type"),n=require("i18n!works/nls/works"),r=require("i18n!nls/commons"),i=require("works/components/list_manager/models/list_setting"),s=require("works/components/masking_manager/models/masking"),o=require("works/collections/fields"),u=require("go-realgrid"),a=require("works/components/doc_list/views/status_column"),f=require("works/components/formbuilder/formvalidator"),l=require("works/components/formbuilder/form_components/formula/formula_util"),c={"\uc77c":n["\uc77c"],"\uc2dc\uac04":n["\uc2dc\uac04"],"\ubd84":n["\ubd84"],"\uad00\ub9ac\uc790\uc5d0 \uc758\ud574 \ub9c8\uc2a4\ud0b9 \ucc98\ub9ac \ub41c \ud56d\ubaa9\uc785\ub2c8\ub2e4":n["\uad00\ub9ac\uc790\uc5d0 \uc758\ud574 \ub9c8\uc2a4\ud0b9 \ucc98\ub9ac \ub41c \ud56d\ubaa9\uc785\ub2c8\ub2e4"]};return u.extend({gridView:null,events:_.extend({"click [data-el-document-popup]":"_onClickDocPopup"},u.prototype.events),initialize:function(e){e=e||{},u.prototype.initialize.call(this,_.extend(e)),this.appletId=e.appletId,this.subFormId=e.subFormId,this.accessibleForms=e.accessibleForms,this.fields=e.fields,this.masking=new s({appletId:this.appletId}),this.masking.fetch(),this.maskings={},this.fieldsOfIntegrationApplet={},this.columnFields=e.columnFields,this.integrationFieldCid=e.integrationFieldCid,this.columns=[],this.useProfile=e.useProfile!==!1,this.conditions=e.conditions,this.usePopupView=typeof e.usePopupView=="undefined"||e.usePopupView===null?!1:e.usePopupView,this.isContainsTemplate=e.isContainsTemplate?e.isContainsTemplate:!1,this.fields||(this.fields=new o([],{appletId:this.appletId,subFormId:this.subFormId,includeProperty:!0}),this.fields.fetch()),this.setting||(this.setting=new i({},{appletId:this.appletId}),this.setting.fetch())},dataFetch:function(){return $.when(this.fields.deferred,this.setting.deferred,this.masking.deferred).then($.proxy(function(){return this.fetchIntegrationDatas()},this)).then($.proxy(function(){this._setColumns()},this))},fetchIntegrationDatas:function(){var e=$.Deferred();return this.fields.getFieldsOfIntegrationApplet().done(_.bind(function(t){this.fieldsOfIntegrationApplet=t,e.resolve()},this)),e},setCustomColumns:function(e){this.columnFields=e},_setColumns:function(){this.columns=this._getGridColumns()},_setMasking:function(e){var n=this.masking.get("fieldCids");return _.each(e,function(e){var r;if(e.get("fieldType")===t.FIELD_MAPPING){n=this._getIntegrationAppletMaskingByFieldMappingCid(e.get("cid"));var i=e.get("properties")||{};r=_.contains(n,i.targetFieldCid)}else r=_.contains(n,e.get("cid"));e.set("isMasking",r)},this),e},_getIntegrationAppletMaskingByFieldMappingCid:function(e){var t=this.fields.findWhere({cid:e}),n=t.get("properties")||{};if(n)return[];var r=n.targetComponentCid,i=this.fields.findWhere({cid:r}),s=i.get("properties")||{},o=s.integrationAppletId,u=this.maskings[o];return u.get("fieldCids")},_setFieldsNColumns:function(){var e=[];e.push({fieldName:"docId",dataType:this.DataType.NUMBER}),_.each(this.columns,function(t){e.push({fieldName:t.fieldName,dataType:t.dataType?t.dataType:this.DataType.TEXT})},this),this.provider.setFields(e),this.gridView.setColumns(this.columns);var t=GO.util.store.get(this.appletId+"-gridview-headerSummary");this.gridView.headerSummaries.visible=t?!0:!1},_renderListView:function(){this.columnDatas={},this.provider.clearRows(),this.collection.each(function(e){var t={appletId:this.appletId,docId:e.id};_.each(this.columns,function(n){if(n.fieldName==="status"){var r=new a({appletId:this.appletId,docId:e.id,statusLabel:n.render(e),color:e.get("status")?e.get("status").color:"0"}),i=e.id+"_"+n.fieldName;t[n.fieldName]=i,this.columnDataView=this.columnDataView?this.columnDataView:{},this.columnDataView[i]=r}else t[n.fieldName]=n.render(e)},this),this.provider.addRow(t)},this),this._resizeGrid()},_setOnLoadEvent:function(){this.gridView.onDataLoadComplated=$.proxy(function(e){this.collection.length&&this._numberValueStats()},this)},_setColumnEvent:function(){this.gridView.onColumnPropertyChanged=$.proxy(function(e,t,n,r,i){if(n=="displayIndex"){var s=e.getDisplayColumns(),o=_.map(s,function(e){return e.fieldName});this._changeColumnOrder(o)}else if(n=="displayWidth"){var u=GO.util.store.get(this.appletId+"-gridview-columnWidth");u=u?u:{},u[t.fieldName]=r,GO.util.store.set(this.appletId+"-gridview-columnWidth",u)}},this),this.gridView.onCellButtonClicked=$.proxy(function(e){var t=e.getCurrent(),n=this.provider.getJsonRow(t.dataRow);this.clickGridListItem(n.docId)},this)},_setEditColumnEvent:function(){this.gridView.onValidateColumn=$.proxy(function(t,n,r,i){i=i?i:"";var s=t.getCurrent();if(s.fieldName!=n.fieldName)return;var o=n.fieldName,u=this.fields.findWhere({cid:o}),a=u.get("fieldType"),l=u.get("valueType"),c=_.contains(e.MULTI_VALUED_TYPES,l),h=this.getProperties(u),p=i;c&&(p=p==""?[]:p.split(","));var d=f.getValidator(a);if(!d)return;var v=this._validateUpdateValue(d,a,p,h),m={};if(!v.isValid)m.level="warning",m.message=v.message;else{var g=this.provider.getJsonRow(s.dataRow),y=this._makeUpdateValueFormat(u,p,g,h);this._saveDataAndGridUpdate(g.docId,y,t,s.dataRow)}return m},this)},_setSelectionEvent:function(){var e=this.$el.find("[data-el-realgrid]");this.gridView.onSelectionChanged=$.proxy(function(t){var r=$.tooltipster.instances(e);r.length==0&&e.tooltipster({content:"",contentAsHTML:!0,theme:"tooltipster-light",hideOnClick:!0,trigger:"custom",arrow:!1,viewportAware:!1,functionPosition:function(e,t,n){return n.coord.top+=5,n}});var i=t.getSelectionData(),s=i?i.length:0,o=[],u=0,a=0,f=0;if(s>1){_.each(i,function(e,t){_.each(e,function(e,n){u++;if(t==0){var r=this.fields.findWhere({cid:n});r.isNumberValueType()&&!r.get("isMasking")&&o.push(n)}_.contains(o,n)&&$.isNumeric(e)&&(a++,f+=e)},this)},this);var l="";o.length>0?(l=n["\ud569\uacc4"]+": "+GO.util.formatNumber(f),l+="  "+n["\ud3c9\uade0"]+": "+(f==0?0:GO.util.formatNumber(f/a))):l=n["\uac1c\uc218"]+": "+u,e.tooltipster("content",l),e.tooltipster("show")}else e.tooltipster("content",""),e.tooltipster("hide")},this)},_setContextMenuPopupEvent:function(){this.gridView.onContextMenuPopup=$.proxy(function(e){if(this.readOnly)return;var t=e.getDisplayColumns(),i=_.map(t,function(e){return e.fieldName}),s=[],o=this.fields.getColumnFields().models;_.each(o,function(e){var t={};t.label=e.get("columnName")||e.get("label"),t.tag=e.get("cid"),t.checked=_.contains(i,e.get("cid")),t.callback=$.proxy(function(e,t){var n=!t.checked,i=parseInt(this.settingId),s=i?this.settings.get(i):null,o="api/works/applets/"+this.appletId+"/listview";o+=s?"/my/"+i:"",o+="/columns/visible",$.ajax({type:"PUT",contentType:"application/json",url:GO.contextRoot+o,data:JSON.stringify({fieldCids:[t.tag],visible:n}),success:$.proxy(function(){$.goMessage(r["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),this.$el.trigger("update:grid")},this),error:$.proxy(function(e){this._saveErrorMessage(e)},this)})},this),s.push(t)},this);var u=_.clone(this._getContextMenu());u.push({label:n["\ucef4\ud3ec\ub10c\ud2b8 \ud45c\uc2dc\uc5ec\ubd80"],tag:"columnMenu",children:s}),e.setContextMenu(u)},this)},_setOnCopyEvent:function(){this.gridView.onCopy=$.proxy(function(e,t,n){var r=e.getSelectionData(),i="";return _.each(r,function(e,t){var n=[];_.each(e,function(e,t){var r=this.fields.findWhere({cid:t});if(r.isStatusFieldType()){var i=this.columnDataView[e];n.push(i.options.statusLabel)}else if(r.isSelectValueType()){var s=r.get("options"),o=e.split(","),u=_.map(o,function(e){var t=_.findWhere(s,{value:parseInt(e)});return t?t.displayText:""});n.push(_.compact(u).join(","))}else n.push($("<div></div>").html(e).text())},this),i=i+n.join("	")+"\n"},this),i&&(window.clipboardData?window.clipboardData.setData("Text",i):n.clipboardData.setData("text/plain",i)),!1},this)},_renderMasking:function(){return'<div class="hidden_data"><span class="help" title="'+c["\uad00\ub9ac\uc790\uc5d0 \uc758\ud574 \ub9c8\uc2a4\ud0b9 \ucc98\ub9ac \ub41c \ud56d\ubaa9\uc785\ub2c8\ub2e4"]+'"></span>'+"</div>"},_getGridColumns:function(){var e=this.fields.getColumnFields(),t=this.columnFields?(new o(this.columnFields)).models:this.setting.getColumns(e);return t=this._setMasking(t),_.map(t,function(e,t){var r=e.get("columnName")||e.get("label"),i=t===this.setting.get("titleColumnIndex")&&e.isTextValueType(),s=this._getDataType(e.get("valueType")),o=this.getProperties(e),u=GO.util.store.get(this.appletId+"-gridview-columnWidth"),a=e.get("cid"),f=u&&u[a]?u[a]:i?300:150,l={name:r,fieldName:a,type:"data",width:f,sortable:!1,useSort:!0,multiple:e.get("multiple"),dataType:s,fillWidth:0,styleName:this._getColumnClass(e,i),header:{text:r},button:i?"none":"action"};if(a==="status")l.editable=!1,l.renderer="renderer_view";else if(i||e.isOrgType())l.editable=!1,l.renderer="renderer_html";else{var c=e.get("fieldType"),h=e.get("valueType");if(e.isDateValueType()||e.isDateTimeValueType()){var p="yyyy-MM-dd"+(e.isDateTimeValueType()?" HH:mm":"");l.editor={type:"date",datetimeFormat:p,mask:{definitions:{a:"[1,2]",b:"[0-9]",c:"[0-1]",d:"[0-3]",e:"[0-2]",f:"[0-5]",g:"[0-9]"},editMask:"abbb-cb-db"+(e.isDateTimeValueType()?" eb:fg":""),includedFormat:!0,overWrite:!0,allowEmpty:!0}},l.datetimeFormat=p;if(c=="create_date"||c=="update_date")l.editable=!1}else if(e.isTimeValueType())l.editor={mask:{definitions:{b:"[0-2]",c:"[0-9]",d:"[0-5]",e:"[0-9]"},editMask:"bc:de",includedFormat:!0,overWrite:!0,allowEmpty:!0}},l.textFormat="([0-9]{2})([0-9]{2});$1:$2";else if(c=="select"||c=="radio"){var d=e.get("options");l.lookupDisplay=!0,l.editor={type:"dropdown",textReadOnly:!0,domainOnly:!0,dropDownCount:d.length},l.values=_.map(d,function(e){return e.value}),l.labels=_.map(d,function(e){return e.displayText})}else if(c=="checkbox"||c=="listbox"){var v=e.get("options");l.editor={type:"checklist",acceptText:"\ud655\uc778",cancelText:"\ucde8\uc18c",textReadOnly:!0,domainOnly:!0,dropDownCount:v.length},l.editButtonVisibility="rowfocused",l.lookupDisplay=!0,l.valueSeparator=",",l.values=_.map(v,function(e){return e.value}),l.labels=_.map(v,function(e){return e.displayText})}else if(e.isNumberValueType()){if(o.expressionType=="day"||o.expressionType=="time")l.dataType="text",l.editable=!1;else if(o.dataType=="POINT")l.renderer={type:"html",callback:function(t,n,r,i){return e.getPointTemplate(n.value,o)}},l.width=parseInt(o.maxLength,10)*18+40;else if(o.dataType=="PERCENT")l.renderer={type:"html",callback:function(t,n){return e.getPercentTemplate(n.value)}},l.width=170;else{o.fixType&&(o.fixType=="prefix"?l.prefix=o.unitText:l.suffix=o.unitText),o.minLength&&(l.min=o.minLength),o.maxLength&&(l.max=o.minLength);var m=o.thousandComma?"#,##0":"###0";if(o.decimalPoints&&o.decimalPoints>0){m+=".";for(var g=0;g<o.decimalPoints;g++)m+="#"}l.numberFormat=m,l.styleName+=" right-column"}if(!e.get("isMasking")&&o.expressionType!="day"&&o.expressionType!="time"){var y="number-summary cid-"+l.fieldName;l.headerSummaries=[{height:30,expression:"sum",numberFormat:m,prefix:n["\ud569\uacc4"]+":",styleName:y,placeHolder:n["\ud569\uacc4"],valueCallback:function(e){var t=e.getItemCount(),n=0;for(var r=0;r<t;r++){var i=e.getValue(r,l.fieldName);$.isNumeric(i)&&(n+=i)}return n}},{numberFormat:m,prefix:n["\ud3c9\uade0"]+":",styleName:y,placeHolder:n["\ud3c9\uade0"],valueCallback:function(e){var t=e.getItemCount(),n=0,r=0;for(var i=0;i<t;i++){var s=e.getValue(i,l.fieldName);$.isNumeric(s)&&(n+=1,r+=s)}return n>0&&r>0?(r/n).toFixed(2):0}}]}}else l.styleName+=" left-column";if(e.isFieldMappingFieldType()||e.isAppletDocValueType()||e.isDocNoType()||e.isFormulaType())l.editable=!1;e.get("isMasking")&&(l.editable=!1,l.dataType="text",l.renderer="renderer_html")}return t==0&&!l.headerSummaries&&(l.headerSummaries=[{text:n["\ud604\uc7ac \ud398\uc774\uc9c0 \ud569\uacc4"],styleName:"rg-reader-summary"},{text:n["\ud604\uc7ac \ud398\uc774\uc9c0 \ud3c9\uade0"],styleName:"rg-reader-summary"}]),l.render=$.proxy(function(t){var n=this._getAdditionalColumnData(t,i);return(e.get("isMasking")&&!t.isCreator(GO.session("id"))?this._renderMasking():this.getColumnData(t,e,i,this.isContainsTemplate))+n},this),l},this)},_getDataType:function(t){return t==e.NUMBER?this.DataType.NUMBER:this.DataType.TEXT},getColumnData:function(t,n,r,i){var s=[],o,u=_.contains(e.MULTI_VALUED_TYPES,n.get("valueType"));u&&s.push("item");if(n.isOrgType()){var a=t.get("values")[n.get("cid")];return n.getOrgTemplateValue(a,this.useProfile)}var f=this.getProperties(n);i||n.get("isMasking")?o=n.getDisplayValueContainsTemplate(t,f):o=n.getValue(t,f),o=_.isArray(o)?o:[o];if(i){var l=n.isNumberValueType()||n.isAppletDocsValueType(),c=l?f.dataType:"",h=!1;if(c=="PERCENT"||c=="POINT")h=!0;h?(o=_.map(o,function(e){return s.length?'<li class="comp">'+_.unescape(e)+"</li>":_.unescape(e)}).join(""),s.length&&(o='<ul class="list_comp">'+o+"</ul>")):o=_.map(o,function(e){return s.length?'<span class="'+s.join(" ")+'">'+_.unescape(e)+"</span>":_.unescape(e)}).join(", ")}else{o=_.map(o,function(e){return _.unescape(e)}).join(",");if(r)return'<a el-grid-list-item data-id="'+t.id+'" title="'+o+'">'+(o?o:"-")+"</a>"}return o},getProperties:function(e){var t,n=null,r=null,i=null;if(e.isFieldMappingFieldType()&&e.isNumberValueType()){var s=e.get("properties").targetComponentCid,o=this.fields.findWhere({cid:s});o&&o.get("properties")&&(n=o.get("properties").integrationAppletId,r=this.fieldsOfIntegrationApplet[n],i=r.findWhere({cid:e.get("properties").targetFieldCid})),t=i?i.get("properties"):{}}else if(e.isAppletDocValueType()){var u=e.get("properties");u&&(n=u.integrationAppletId,r=this.fieldsOfIntegrationApplet[n],i=r.findWhere({cid:u.integrationFieldCid})),t=i?i.get("properties"):{}}else t=e.get("properties")||this.fields.findWhere({cid:e.get("cid")}).get("properties")||{};return t},_getAdditionalColumnData:function(e,t){var n,r="";return GO.util.isCurrentDate(e.get("values").create_date,1)&&(n=!0),t&&e.has("activityCount")&&(r+=this._getActivityLabel(e.get("activityCount"),e.get("lastActivityCreatedAt"))),t&&n&&(r+=' <span class="ic_classic ic_new2"></span>'),t&&this.usePopupView&&(r+=this._getPopupView()),r},_getColumnClass:function(e,t){var n="";return t&&(n="subject left-column "),e.get("isMasking")&&(n+="masking "),e.isMultiValueType()&&(n+="item_wrap "),n},_getActivityLabel:function(e,t){if(GO.util.isCurrentDate(t,1))var r=!0;return[" ",'<span class="btn_wrap btn_activity">',r?'<span class="ic_classic ic_activvity on"></span>':'<span class="ic_classic ic_activvity"></span>','<span class="txt_b">',n["\ud65c\ub3d9\uae30\ub85d"],"</span>",'<span class="num">',e,"</span>","</span>"].join("")},_getPopupView:function(){return' <span class="ic_classic ic_blank" data-el-document-popup title="'+r["\ud31d\uc5c5\ubcf4\uae30"]+'" '+'style="cursor:pointer"></span>'},_onClickDocPopup:function(e){e.stopPropagation();var t=this.gridView.getCurrent(),n=this.provider.getJsonRow(t.dataRow),r=GO.contextRoot+"app/works/applet/"+this.appletId+"/doc/"+n.docId+"/popup";GO.util.isValidValue(this.subFormId)&&(r+="/"+this.subFormId),window.open(r,"help","width=1280,height=700,status=yes,scrollbars=yes,resizable=yes")},_changeColumnOrder:function(e){var t=parseInt(this.settingId),n=t?this.settings.get(t):null,i="api/works/applets/"+this.appletId+"/listview";i+=n?"/my/"+t:"",i+="/columns/order",$.ajax({type:"PUT",contentType:"application/json",url:GO.contextRoot+i,data:JSON.stringify({fieldCids:e}),success:function(){$.goMessage(r["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:$.proxy(function(e){this._saveErrorMessage(e),this.$el.trigger("update:grid")},this)})},_onSelectContextMenu:function(e){e.tag=="showHeaderSummary"&&setTimeout($.proxy(function(){this._numberValueStats()},this),100)},_onClickCellButton:function(e){var t=e.getCurrent(),n=this.provider.getJsonRow(t.dataRow);this.clickGridListItem(n.docId)},_onClickIndicator:function(e){var t=e.getCurrent(),n=this.provider.getJsonRow(t.dataRow);this.clickGridListItem(n.docId)},_validateUpdateValue:function(e,n,r,i){var s={};if(n==t.RADIO||n==t.SELECT)s.count=1;else if(n==t.DATETIME){if(r!=""){var o=r.split(" "),u=o[0],a=o[1];s.dateValue=u,s.timeValue=a}}else _.isArray(r)&&(s.count=r.length);return s.value=r,e.validate(s,i)},_makeUpdateValueFormat:function(e,t,n,r){var i={};i[e.get("cid")]=e.convertDateTimeValue(t);if(e.isFormulaTargetType()){var s=r.code,o=this.fields.getColumnFields().models,u=_.filter(o,function(e){return e.isFormulaType()});_.each(u,function(e){var r=this.getProperties(e),o=l.getExpressionCodes(r.expression);if(_.contains(o,s)){var u=[];_.each(o,function(e){var r=this.fields.findByCode(e),i={valueType:r.get("valueType"),multiple:r.get("multiple"),dataType:r.get("properties").dataType};e==s?i.value=t:i.value=n[r.get("cid")],i.value=r.convertDateTimeValue(i.value),u.push(i)},this),i[e.get("cid")]=l.getFormulaValue(r,o,u)}},this)}return i},_saveDataAndGridUpdate:function(e,t,n,i){var s=this;$.ajax({type:"PUT",contentType:"application/json",url:GO.contextRoot+"api/works/applets/"+this.appletId+"/docs/"+e+"/values",data:JSON.stringify({values:t}),success:$.proxy(function(e){$.goMessage(r["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.cancel(),setTimeout(function(){var t=e.data.values;_.each(t,function(e,t,n){var r=s.fields.findWhere({cid:t});if(r.isOrgType())n[t]=r.getOrgTemplateValue(e,s.useProfile);else{var i=r.convertDateTimeAndNumberFormat(e,s.getProperties(r));n[t]=i?i:e}}),s.provider.updateRow(i,t)},100),this.$el.trigger("update:chart")},this),error:$.proxy(function(e){this._saveErrorMessage(e),this.$el.trigger("update:grid")},this)})},_numberValueStats:function(){function s(e,t,n){return GO.contextRoot+"api/works/applets/"+e+"/component/stats?q="+encodeURIComponent(t||"")+"&aggCid="+n}var e=this.appletId,t=this.collection.queryString,r=this.$el.find("td.number-summary"),i=$.tooltipster.instances(r);i.length>0&&$.each(i,function(e,t){$(t.elementOrigin()).data("loaded",!1),t.destroy()}),r.tooltipster({content:"Loading...",contentAsHTML:!0,theme:"tooltipster-borderless",updateAnimation:null,functionPosition:function(e,t,n){return n.coord.top+=5,n},functionBefore:function(r,i){var o=$(i.origin),u=o.attr("class"),a=u.split(" "),f="cid-",l=_.filter(a,function(e){return e.indexOf(f)==0});if(!l||l.length==0)return;var c=l[0].substring(f.length);o.data("loaded")||$.get(s(e,t,c),function(e){e=n["\uc804\uccb4"]+" "+n["\ud569\uacc4"]+": "+GO.util.formatNumber(e.data.sum)+"&nbsp;&nbsp;"+n["\uc804\uccb4"]+" "+n["\ud3c9\uade0"]+": "+GO.util.formatNumber(e.data.avg),r.content(e),o.data("loaded",!0)},"json")}})},_saveErrorMessage:function(e){e.responseJSON.code=="403"?$.goError(r["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]):$.goError(r["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})});