define("works/views/app/doc_detail/doc_activity",function(require){function v(e){e.find(".icon-arrow").hasClass("on")?(e.find(".icon-arrow").removeClass("on"),e.find(".txt").text(c.fold)):(e.find(".icon-arrow").addClass("on"),e.find(".txt").text(c.unfold))}function m(){$(this.el).find("#editor").goWebEditor({contextRoot:GO.config("contextRoot"),lang:GO.session("locale")}),this.editor=GO.Editor}function g(){var e=[];this.$("#attachList").find("li").remove(),_.each(this.collection.models,function(t){y(t.attributes,e),_.each(t.get("comments"),function(t){y(t,e)})}),b(e),_.each(e,function(e){this.$("#attachList").append(o(e))},this),k.call(this)}function y(e,t){var n=e.commentCount>=0?e.id:e.ownerId+"/comment/"+e.id;_.each(e.attaches,function(e){t.push({lang:c,file:e,fileSize:GO.util.getHumanizedFileSize(e.size),style:GO.util.getFileIconStyle(e),downloadPath:GO.contextRoot+"api/works/activity/"+n+"/download/"+e.id,imageGroupId:this.cid,isPreviewable:e.preview&&e.encrypt,isImage:GO.util.isImage(e.extention)})},this)}function b(e){e.sort(function(e,t){return new Date(e.file.createdAt)>=new Date(t.file.createdAt)?-1:1})}function w(e){var t=this,e={el:"#file-control",context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+c.addAttach+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie")},n=parseInt(GO.config("commonAttachConfig").maxAttachSize),r=n*1024*1024,i=parseInt(GO.config("commonAttachConfig").maxAttachNumber);(new l(e)).queue(function(e,t){}).start(function(e,s){if(!GO.config("attachFileUpload"))return $.goAlert(f["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1;if(t.isSaaS){if(r<s.size)return $.goMessage(GO.i18n(f["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",n)),!1;t.totalAttachSize+=s.size;var o=$("#fileWrap").find("li").size()+t.totalAttachCount+1;if(i<o)return $.goMessage(GO.i18n(f["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",i)),!1;t.totalAttachCount++}}).progress(function(e,t){}).success(function(e,n,r){var i=GO.util.isImage(n.data.fileExt),s=t.$("#fileWrap"),o=i?"ul.img_wrap":"ul.file_wrap";if(GO.util.fileUploadErrorCheck(n))r.find(".item_file").append("<strong class='caution'>"+GO.util.serverMessage(n)+"</strong>"),r.addClass("attachError");else if(GO.util.isFileSizeZero(n))return $.goAlert(GO.util.serverMessage(n)),!1;r.attr("data-hostId",n.data.hostId),s.find(o).show().append(r),t.resetAttachSizeAndCount()}).complete(function(e,t){}).error(function(e,n){n.jqXHR&&(n.jqXHR.statusText=="abort"?$.goAlert(f["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):$.goAlert(f["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."]),t.resetAttachSizeAndCount())})}function E(){var t=e.defer();return this.collection.fetch({success:t.resolve,error:t.reject}),t.promise}function S(){return _.each(this.collection.models,function(e){var t=x.call(this,e);$(this.$el).find("#activityList").append(t.el),t.render()},this),t.giveHoverEventAtIE(this,"#activityList","div.article","div.article iframe",".item"),this}function x(e){var t=new i({model:e,appletId:this.appletId,docId:this.docId}),n=this;return t.on("change:activity",function(){T.call(n)}),t.on("change:attach",function(e){n.isChangeAttach=!0,C.call(n,e)}),t}function T(){var e=this;this.collection.fetch({success:function(){var t=parseInt(e.$("#activityCount").text())-1;e.$("#activityCount").text(t),t||e.toggleEditor(!0)}})}function N(e){var t=x.call(this,e),n=this.collection.length||0;this.$("#activityList").prepend(t.el),t.render(),this.$("#activityCount").show().text(n),this.$("#attachCount").text(parseInt(this.$("#attachCount").text())+e.get("attaches").length),GO.Editor.getInstance("editor").setContent(" "),this.$("#fileWrap").find("li").remove(),this.toggleEditor(!1)}function C(e){var t=this.$el.find("#attachCount"),n=parseInt(t.text());t.text(n+e)}function k(){$(".fancybox-thumbs").goFancybox()}var e=require("when"),t=require("works/libs/util"),n=require("works/collections/applet_activities"),r=require("works/models/applet_activity"),i=require("works/views/app/doc_detail/doc_activity_item"),s=require("hgn!works/templates/app/doc_detail/doc_activity"),o=require("hgn!works/templates/app/doc_detail/doc_attacth"),u=require("i18n!task/nls/task"),a=require("i18n!works/nls/works"),f=require("i18n!nls/commons"),l=require("file_upload");require("go-webeditor/jquery.go-webeditor"),require("jquery.go-preloader"),require("go-fancybox");var c={activity:u["\ud65c\ub3d9\uae30\ub85d"],attach:f["\ucca8\ubd80\ud30c\uc77c"],writeActivity:u["\ud65c\ub3d9\uae30\ub85d \uc4f0\uae30"],addAttach:f["\ud30c\uc77c \ucca8\ubd80"],regist:f["\ub4f1\ub85d"],cancel:f["\ucde8\uc18c"],save:f["\ub2e4\uc6b4\ub85c\ub4dc"],preview:f["\ubbf8\ub9ac\ubcf4\uae30"],fold:a["\uc811\uae30"],unfold:a["\ud3bc\uce58\uae30"]},h=!1,p={ACTIVITY:"activity",ATTACH:"attach"},d=Backbone.View.extend({id:"activityView",initialize:function(e){this.docId=e.docId,this.appletId=e.appletId,this.reqAppletId=e.reqAppletId,this.collection=new n({docId:e.docId,appletId:e.appletId,reqAppletId:this.reqAppletId}),this.isSaaS=GO.session().brandName=="DO_SAAS",this.totalAttachSize=0,this.totalAttachCount=0},events:{"click #fileWrap span.ic_del":"attachDelete","click #writeActivity":"writeActivity","click #editorToggle":"editorToggleListener","click #closeEditor":"editorToggleListener","click li[data-tag=activityTab]":"activityTabToggleAction","click #activityAttachArea a.btn-preview":"preview","click span[data-tag='toggle']":"toggleView"},toggleView:function(e){var t=$(e.currentTarget),n=$("li[data-tag=activityTab]").filter(".active"),r=n.attr("data-type");if(r==p.ACTIVITY)var i=this.$("#activity-container");else var i=this.$("#activityAttachArea");i.css("display")=="none"?this.showActivityTabByType(r):i.hide(),v(t)},render:function(){var e=this;return this.$el.addClass("activity_type"),this.$el.html(s({lang:c,fileCount:this.getAttachCount(this.collection.models),activityPresent:this.collection.length>0,activityCount:this.collection.length})),w.call(this),this.collection.length==0?m.call(this):this.$("div[data-area=editor]").hide(),this.$el.on("change:attach",function(t,n){e.isChangeAttach=!0,C.call(e,n)}),S.call(this)},getAttachCount:function(e){var t=0;return _.each(e,function(e){t+=e.get("attaches").length;var n=e.get("comments");_.each(n,function(e){t+=e.attaches.length})}),t},dataFetch:function(){var t=e.defer(),n=this.collection.fetch();return $.when(n).done(function(){t.resolve()}),t.promise},attachDelete:function(e){$(e.target).parents("li").remove()},editorToggleListener:function(e){this.isActivityTabFolded()&&this.$("span[data-tag='toggle']").trigger("click");var t=typeof e=="object"?GO.util.toBoolean($(e.currentTarget).attr("data-display")):e;this.toggleEditor(t)},toggleEditor:function(e){var t=$("div[data-area=editor]"),n=$("#editorToggle");this.editor||m.call(this);if(e){n.hide(),t.show();var r=$("li[data-type=activity]");this.toggleActivityTab(r)}else n.show(),t.hide()},activityTabToggleAction:function(e){var t=$(e.currentTarget);this.toggleActivityTab(t)},preview:function(e){GO.util.preview($(e.currentTarget).attr("data-id"))},writeActivity:function(){if(!GO.Editor.getInstance("editor").validate())return $.goError(f["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=this,t=this.getContent();if(!GO.util.isEditorWriting()){$.goMessage(GO.i18n(f["{{portlet_title}}\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],"portlet_title",f["\ub0b4\uc6a9"]));return}if(h)return;h=!0;var n=new r({appletId:this.appletId,docId:this.docId});n.set({content:t,attaches:this.getActivityAttaches(),writer:_.pick(GO.session(),"id","name","email","position","thumbnail")}),n.save({},{success:function(t){e.collection.fetch({success:function(){e.isChangeAttach=!0,e.$el.trigger("change:log"),h=!1,N.call(e,t)}})},complete:function(){},error:function(e,t){h=!1,$.goError(t.responseJSON.message)}})},getActivityAttaches:function(){var e=[];return _.each(this.$("#fileWrap").find("li:not(.attachError)"),function(t){e.push({path:$(t).attr("data-path"),name:$(t).attr("data-name"),hostId:$(t).attr("data-hostId")})}),e},getContent:function(){var e=GO.Editor.getInstance("editor").getContent();return e==""||$.trim(e)=="<br>"?"":e},isActivityTabFolded:function(){return this.$("span[data-tag='toggle']").find(".icon-arrow").hasClass("on")},showActivityTabByType:function(e){var t=this;e==p.ACTIVITY?($("#activity-container").show(),this.collection.length||($("div[data-area=editor]").show(),$("#editorToggle").hide()),$("#activityArea").show(),$("#activityAttachArea").hide()):($("#activityAttachArea").show(),$("#editorToggle").show(),$("div[data-area=editor]").hide(),$("#activity-container").hide(),$("#activityArea").hide(),this.isChangeAttach?this.collection.fetch().done(function(){g.call(t)}):g.call(this))},toggleActivityTab:function(e){var t=e.attr("data-type");if(this.activityTab==t)return;this.activityTab=t,$("li[data-tag=activityTab]").removeClass("active"),e.addClass("active");if(this.isActivityTabFolded())return;this.showActivityTabByType(t)},getViewedTotalAttachSize:function(e){var t=0;return $(e).find("li").each(function(e,n){t+=parseInt(n.getAttribute("data-size"),0)}),t},resetAttachSizeAndCount:function(){this.isSaaS&&(this.totalAttachSize=0,this.totalAttachCount=0)}});return d});