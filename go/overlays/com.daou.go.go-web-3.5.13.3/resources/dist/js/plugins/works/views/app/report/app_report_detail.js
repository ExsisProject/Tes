define("works/views/app/report/app_report_detail",function(require){var e=require("i18n!nls/commons"),t=require("i18n!works/nls/works"),n=require("i18n!admin/nls/admin"),r=require("i18n!task/nls/task"),i=require("works/components/report/constants"),s={"\uc800\uc7a5":e["\uc800\uc7a5"],"\uc0ad\uc81c":e["\uc0ad\uc81c"],"\uc644\ub8cc":e["\uc644\ub8cc"],"\ucc28\ud2b8":t["\ucc28\ud2b8"],"\uce74\ub4dc":t["\uce74\ub4dc"],"\ub370\uc774\ud130":t["\ub370\uc774\ud130"],"\ud14d\uc2a4\ud2b8":e["\ud14d\uc2a4\ud2b8"],"\uc0ac\uc9c4":e["\uc0ac\uc9c4"],"\uc0ac\uc6a9\uc790":e["\uc0ac\uc6a9\uc790"],"\ubd80\uc11c":n["\ubd80\uc11c"],"\uc9c1\uc704":n["\uc9c1\uc704"],"\uc9c1\uae09":n["\uc9c1\uae09"],"\uc9c1\ucc45":n["\uc9c1\ucc45"],"\uc0ac\uc6a9\uc790\uadf8\ub8f9":n["\uc0ac\uc6a9\uc790\uadf8\ub8f9"],"\ucd94\uac00":e["\ucd94\uac00"],"\uacf5\uc720\uc124\uc815":r["\uacf5\uc720\uc124\uc815"],"\uc571 \uc0ac\uc6a9\uc790 \uc804\uccb4":t["\uc571 \uc0ac\uc6a9\uc790 \uc804\uccb4"],"\uc9c1\uc811\uc120\ud0dd":r["\uc9c1\uc811\uc120\ud0dd"],"\uc0c8 \ub9ac\ud3ec\ud2b8":t["\uc0c8 \ub9ac\ud3ec\ud2b8"],"PDF \ub0b4\ubcf4\ub0b4\uae30":t["PDF \ub0b4\ubcf4\ub0b4\uae30"],"\uba54\uc77c\ub85c \ubcf4\ub0b4\uae30":t["\uba54\uc77c\ub85c \ubcf4\ub0b4\uae30"],"\ub9ac\ud3ec\ud2b8 \uacf5\uc720 \uc124\uc815 \uc548\ub0b4\ubb38\uad6c":t["\ub9ac\ud3ec\ud2b8 \uacf5\uc720 \uc124\uc815 \uc548\ub0b4\ubb38\uad6c"],"\ub9ac\ud3ec\ud2b8\uba85":t["\ub9ac\ud3ec\ud2b8\uba85"],"\ub9ac\ud3ec\ud2b8\uc758 \uba85\uce6d\uc744 \ubcc0\uacbd\ud569\ub2c8\ub2e4":t["\ub9ac\ud3ec\ud2b8\uc758 \uba85\uce6d\uc744 \ubcc0\uacbd\ud569\ub2c8\ub2e4"],"\ub9ac\ud3ec\ud2b8":t["\ub9ac\ud3ec\ud2b8"],"\uc124\uc815":e["\uc124\uc815"],"\ub2eb\uae30":e["\ub2eb\uae30"],"\uacf5\uc720":r["\uacf5\uc720"],"\uc218\uc815\uc644\ub8cc":e["\uc218\uc815\uc644\ub8cc"],"\ud3b8\uc9d1":e["\ud3b8\uc9d1"],"\uc544\uc774\ud15c \uc5c6\uc744 \uacbd\uc6b0 \uc548\ub0b4\ubb38\uad6c":t["\ub9ac\ud3ec\ud2b8 \uc544\uc774\ud15c \uc5c6\uc744 \uacbd\uc6b0 \uc548\ub0b4\ubb38\uad6c"]},o=require("works/views/app/report/works_report_gridstack_manager"),u=require("works/views/app/base_applet"),a=require("hgn!works/components/report/template/editor_header"),f=require("hgn!works/components/report/template/report_setting_content"),l=require("hgn!works/components/report/template/report_setting_header"),c=require("components/backdrop/backdrop"),h=require("views/circle"),p=require("works/models/report"),d=require("works/collections/fields"),v=require("html2canvas"),m=require("jspdf");return u.extend({events:{"click a[el-setting]":"_onClickSetting","click a[el-save]":"_onClickSave","click a[el-output]":"_onClickOutput","click li[el-pdf-export], a[el-pdf-export]":"_onClickExportPdf","click li[el-email-export], a[el-email-export]":"_onClickExportEmail","click li[el-delete_report]":"_onClickDeleteReport","click li[el-add-item]":"_onClickAddItem","click span[el-title-edit]":"_onClickTitleEdit","click span[el-title-save]":"_onClickTitleSave"},initialize:function(e){u.prototype.initialize.apply(this,arguments),this.reportId=e.reportId,this.isCrete=e.reportId?!1:!0,this.fields=new d([],{appletId:this.appletId,includeProperty:!0}),this.report=new p({appletId:this.appletId,reportId:this.reportId})},render:function(){this.isCrete?$.when(u.prototype.render.apply(this,arguments),this.accessibleForms.length>0?this.fields.fetch():this._renderNoExistForm(this.$el)).then($.proxy(function(){this.report.set("title",t["\uc0c8 \ub9ac\ud3ec\ud2b8"]),this.report.set("shareModel",{"public":!1}),this.report.set("shared",!1),this._rendGrid()},this)):$.when(u.prototype.render.apply(this,arguments),this.accessibleForms.length>0?this.fields.fetch():this._renderNoExistForm(this.$el),this.report.fetch()).then($.proxy(function(){this._rendGrid()},this)).fail($.proxy(function(e){this._renderNoExistReport(this.$el)},this))},_rendGrid:function(){if(this.accessibleForms.length<1)return;this.isAdmin=this.baseConfigModel.isAdmin(GO.session("id")),this.$el.append(a({lang:s,title:this.report.get("title"),itemSize:i.ITEM_SIZE})),this.gridManger=new o({appletId:this.appletId,reportId:this.reportId,fields:this.fields,report:this.report}),this.gridManger.render(),!this.report.get("writer")&&!this.isCrete&&($("div.report_tool_bar").hide(),$("a[el-save]").hide(),$("a[el-setting]").hide(),$("span[el-title-edit]").hide(),this.gridManger.disable());var e=this;$(window).scroll(function(t){var n=$(this).scrollTop();if(n>94){e.$el.find(".report_header").addClass("fix_header");return}e.$el.find(".report_header").removeClass("fix_header")}),this.$el.closest(".go_content").addClass("go_works_report")},_onClickSetting:function(){var t=this,n=[{btype:"confirm",btext:s["\uc800\uc7a5"],autoclose:!1,callback:function(e){t.report.set("shared",$("#isShare").is(":checked")),t.report.set("shareModel",{"public":"public"==$("input[name=shareType]:checked").val(),circle:t.circleView.getData()}),t.gridManger.saveEnabled(),t._onClickSave(),e.close()}}];n.push({btext:e["\ucde8\uc18c"],btype:"cancel"}),$.goPopup({pclass:"layer_normal layer_report_set go_renew",headerHtml:l({lang:s}),contents:f({lang:s,isPublic:this.report.get("shareModel").public,isShared:this.report.get("shared"),title:this.report.get("title")}),buttons:n}),$("#isShare").on("change",function(e){$(e.target).is(":checked")?($("#shareArea").show(),$("input[name=shareType]:checked").val()=="custom"?$("#circleArea").show():$("#circleArea").hide()):($("#shareArea").hide(),$("#circleArea").hide())}),$("input[name=shareType]").on("change",function(e){$(e.target).val()=="custom"?$("#circleArea").show():$("#circleArea").hide()}),$("#isShare").trigger("change"),this.circleView=new h({selector:"#accessUser",isAdmin:!1,isWriter:!0,zIndex:999,circleJSON:this.report.get("shareModel").circle,nodeTypes:["user","department","position","grade","duty","usergroup"]}),this.circleView.render()},_onClickSave:function(){var e=this;if(this.gridManger.isSaveDisabled())return;this.gridManger.save().done(function(t){e.reportId||GO.router.navigate("works/applet/"+e.appletId+"/report/"+t.data,!0)})},_onClickOutput:function(e){this.backdropView=new c,this.backdropView.backdropToggleEl=$("#output_selector");if(this.backdropView.backdropToggleEl.is(":visible")){this.backdropView.backdropToggleEl.hide();return}this.backdropView.linkBackdrop($(e.currentTarget))},_onClickExportPdf:function(){var e=this;this._createReportPdf().then(function(t){var n=e.report.get("title")||"Report";t.save(n+".pdf")})},_createReportPdf:function(){return v(document.querySelector(".report_body")).then(function(e){var t=new m.jsPDF("p","mm","a4"),n=6,r=t.internal.pageSize.getWidth(),i=t.internal.pageSize.getHeight(),s=r,o=i-n,u=e.height,a=Math.floor(e.width*(i/r)),f=Math.ceil(u/a),i=o,l=document.createElement("canvas"),c=l.getContext("2d");l.width=e.width,l.height=a;for(var h=0;h<f;h++){var p=0;h==f-1&&u%a!=0&&(l.height=u%a,i=l.height*s/l.width),h>0&&(p=n,t.addPage());var d=l.width,v=l.height;c.fillStyle="white",c.fillRect(0,0,d,v),c.drawImage(e,0,h*a,d,v,0,0,d,v);var g=l.toDataURL("image/png");t.addImage(g,"png",0,p,s,i)}return t})},_setTitle:function(e){$("span.tit").empty(),$("span.tit").append(e)},_onClickExportEmail:function(){var e=this;if(this.reportId){this._exportReportMailTemplate(this.reportId);return}this.gridManger.save().done(function(t){var n=t.data;e._exportReportMailTemplate(n),GO.router.navigate("works/applet/"+e.appletId+"/report/"+n,!0)})},_onClickDeleteReport:function(){var n=this;$.goConfirm(e["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",function(){var r=GO.contextRoot+"api/works/applet/"+n.appletId+"/report/"+n.reportId,i=$.ajax({contentType:"application/json",dataType:"json",type:"DELETE",url:r});i.done(function(e){$.goSlideMessage(t["\uc0ad\uc81c\uc5d0 \uc131\uacf5\ud588\uc2b5\ub2c8\ub2e4"]),$("a[el-create]").trigger("refresh")}),i.fail(function(t,n,r){var i=JSON.parse(t.responseText);!_.isUndefined(i)&&i.message?$.goAlert(i.message):$.goAlert(e["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"])}),GO.router.navigate("works/applet/"+n.appletId+"/reports",!0)})},_exportReportMailTemplate:function(e){var t=this;this._createReportPdf().then(function(n){var r=new FormData;r.append("file",n.output("blob"));var i=GO.contextRoot+"api/works/applet/"+t.appletId+"/report/"+e+"/mail",s=$.ajax({contentType:!1,processData:!1,data:r,type:"POST",url:i});s.done(function(e){var n=e.data,r=_.map(n.attachModels,function(e){var t=e.path+":"+e.name+":"+e.size+":"+e.id+"\n";return t});t._openEmailPopup(n.subject,n.body,r)})})},_openEmailPopup:function(e,t,n){var r=Math.floor(Math.random()*1e4),i="scrollbars=yes,resizable=yes,width=1280,height=760";window.open("",r,i);var s=document.createElement("form"),o=document.createElement("input"),u={},a=[];_.each(n,function(e){a.push(e)}),u.subject=e,u.content=t,u.attachFiles=a,o.type="hidden",o.name="data",o.value=JSON.stringify(u),s.appendChild(o),s.action=GO.contextRoot+"app/mail/popup/process",s.method="post",s.target=r,document.body.appendChild(s),s.submit(),$("#subject").val(e),document.body.removeChild(s)},_onClickAddItem:function(e){var t=$(e.target).closest("[grid-type]").attr("grid-type");this.gridManger.addItem(t)},_onClickTitleEdit:function(){this.$el.find("#title-view-wrap").hide(),this.$el.find("#title-edit-wrap").show()},_onClickTitleSave:function(){var t=this.$el.find("#report_edit_title").val();if(t.length<1||t.length>20){$.goError(GO.i18n(e["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:1,arg2:20}),this.$el.find("#report_edit_title"),!1,!0);return}this.report.set("title",t),this.$el.find("#report_view_title").text(t),this.$el.find("#title-view-wrap").show(),this.$el.find("#title-edit-wrap").hide(),this.gridManger.saveEnabled()}})});