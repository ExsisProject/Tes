define("works/views/app/csv_manager",function(require){require("jquery.progressbar");var e=require("i18n!works/nls/works"),t=require("i18n!admin/nls/admin"),n={"\uc77c\uad04 \ub4f1\ub85d":e["\uc77c\uad04 \ub4f1\ub85d"],"\uafc0\ud301\uac00\uc774\ub4dc":e["\uafc0\ud301\uac00\uc774\ub4dc"],"\ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uc124\uba85":e["\ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uc124\uba85"],"\ud30c\uc77c \ucc3e\uae30":e["\ud30c\uc77c \ucc3e\uae30"],"\ub370\uc774\ud130 \uc77c\uad04 \ub4f1\ub85d \ub3c4\uc6c0\ub9d0":e["\ub370\uc774\ud130 \uc77c\uad04 \ub4f1\ub85d \ub3c4\uc6c0\ub9d0"],"\ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uc9c4\ud589 \ud604\ud669":e["\ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uc9c4\ud589 \ud604\ud669"],"\ucd5c\uadfc \ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uacb0\uacfc":e["\ucd5c\uadfc \ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uacb0\uacfc"],"\uc571 \ud648\uc73c\ub85c \uc774\ub3d9":e["\uc571 \ud648\uc73c\ub85c \uc774\ub3d9"],"\uc804\uccb4 \ucc98\ub9ac \uacb0\uacfc \ub2e4\uc6b4\ub85c\ub4dc":e["\uc804\uccb4 \ucc98\ub9ac \uacb0\uacfc \ub2e4\uc6b4\ub85c\ub4dc"],"\ub4f1\ub85d\uc77c":e["\ub4f1\ub85d\uc77c"],"\uc885\ub8cc\uc77c":e["\uc885\ub8cc\uc77c"],"\ucca8\ubd80\ud30c\uc77c\uc758 \ucd1d \ub370\uc774\ud130":e["\ucca8\ubd80\ud30c\uc77c\uc758 \ucd1d \ub370\uc774\ud130"],"\ubaa8\ub4e0 \uceec\ub7fc\uc758 \uac12\uc774 \ubc18\uc601\ub41c \ub370\uc774\ud130":e["\ubaa8\ub4e0 \uceec\ub7fc\uc758 \uac12\uc774 \ubc18\uc601\ub41c \ub370\uc774\ud130"],"\uc720\ud6a8\uc131 \uac80\uc99d \uc624\ub958\ub85c \uc77c\ubd80 \ub370\uc774\ud130\uc758 \uac12\uc774 \ubc18\uc601\ub418\uc9c0 \uc54a\uc740 \ub370\uc774\ud130":e["\uc720\ud6a8\uc131 \uac80\uc99d \uc624\ub958\ub85c \uc77c\ubd80 \ub370\uc774\ud130\uc758 \uac12\uc774 \ubc18\uc601\ub418\uc9c0 \uc54a\uc740 \ub370\uc774\ud130"],"\ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uc124\uba852":e["\ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uc124\uba852"]},r=require("when"),i=require("file_upload"),s=require("works/views/app/base_applet"),o=require("works/collections/applet_simples"),u=require("hgn!works/templates/app/csv_manager"),a=s.extend({progressBarOption:{boxImage:GO.contextRoot+"resources/images/progressbar.gif",barImage:GO.contextRoot+"resources/images/progressbg_green_200.gif",width:200,max:100},isProgress:!1,statusCheckInterval:1500,initialize:function(e){this.applets=new o,s.prototype.initialize.apply(this,arguments),this.filters.on("changeFilter.filters",this._onChangeFilter,this)},events:{"click #import":"_onClickImport","click #appHome":"_onClickAppHome","click #downloadResult":"_onClickDownloadResult","click #help":"_onClickHelp","click span.ic_del":"_onClickDeleteAttach"},_initRender:function(){this.$el.html(u({lang:n})),this._initFileUpload(),this._checkStatus(),this.layoutView.getContentElement().removeClass("build_situation"),$("body#main").removeClass("go_skin_works"),GO.config("locale")!=="ko"&&(this.$("#help").hide(),this.$("#help_explain").hide())},render:function(){return s.prototype.render.apply(this,arguments).then($.proxy(function(){this._initRender()},this)),this},_onClickImport:function(){if(this.isProgress)return;this.isProgress=!0;var e=$.ajax({url:GO.contextRoot+"api/works/applets/"+this.appletId+"/docs/import/csv",contentType:"application/json",type:"POST",data:JSON.stringify(this.$("#fileList").find("li").data("attach")),success:$.proxy(function(e){this._checkStatus(),this.$("#progressBarArea").show(),this.$("#progressBar").progressBar(0,this.progressBarOption)},this)});GO.util.preloader(e)},_checkStatus:function(){var e=$.proxy(function(){setTimeout(function(){t()},this.statusCheckInterval)}),t=$.proxy(function(){$.ajax({url:GO.contextRoot+"api/works/applets/"+this.appletId+"/docs/import/csv",contentType:"application/json",success:$.proxy(function(t){var n=t.data.jobStatus||"";if(typeof t.data.jobId=="undefined")this._defaultResult();else if(_.contains(["DOING","WAIT"],n)){this.isProgress=!0;var r=t.data.successCount,i=t.data.failCount,s=t.data.size,o=(r+i)/s*100;this.$("#progressBar").progressBar(o,this.progressBarOption),this.$("#progressBarArea").show(),this.$("#result").hide(),e.call(this)}else n=="DONE"&&(this.isProgress=!1,this.$("#import").hide(),this.$("#progressBarArea").hide(),this._displayResult(_.extend(t.data,{startAt:startAt})))},this)})},this);t()},_defaultResult:function(){this.$("#result").hide(),this.$("#downloadResult").hide()},_displayResult:function(e){this.$("#downloadResult").show(),this.$("#result").show(),this.$("#startAt").text(moment(e.startedAt).format("YYYY-MM-DD HH:mm:ss")),this.$("#endAt").text(moment(e.endedAt).format("YYYY-MM-DD HH:mm:ss")),this.$("#totalCount").text(GO.util.numberWithCommas(e.size)),this.$("#successCount").text(GO.util.numberWithCommas(e.successCount)),this.$("#failCount").text(GO.util.numberWithCommas(e.failCount))},_verify:function(t){$.ajax({url:GO.contextRoot+"api/works/applets/"+this.appletId+"/docs/import/csv/verify",contentType:"application/json",type:"POST",data:JSON.stringify(t),success:$.proxy(function(t){this.$("#importDesc").show();if(t.columnNames){var n=_.map(t.columnNames,function(e){return"["+e+"]"});this.$("#import").show(),this.$("#csvInfo").html(e["\ub370\uc774\ud130 \uac00\uc838\uc624\uae30 \uc124\uba852"]),this.$("#csvInfo").find("span").text(n.join(", "))}else this.$("#csvInfo").text(t.errorMessage)},this),error:$.proxy(function(e){this.$("#import").hide(),this.$("#importDesc").hide()},this)})},_onClickDownloadResult:function(){window.location.href=GO.contextRoot+"api/works/applets/"+this.appletId+"/docs/import/csv/result"},_initFileUpload:function(){var e={el:this.$("span[el-uploader]"),context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+n["\ud30c\uc77c \ucc3e\uae30"]+"</span>",progressBarUse:!0,url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie")};(new i(e)).queue(function(e,t){}).start($.proxy(function(e,n){var r=new RegExp("(.csv)","gi"),i=n.type.toLowerCase();if(!r.test(i))return this.$("#importDesc").show(),this.$("#csvInfo").text(t["csv \ud30c\uc77c\ub9cc \ub4f1\ub85d \uac00\ub2a5\ud569\ub2c8\ub2e4."]),!1},this)).progress(function(e,t){}).success($.proxy(function(e,t,n){if(GO.util.fileUploadErrorCheck(t))return $.goAlert(GO.util.serverMessage(t)),!1;if(GO.util.isFileSizeZero(t))return $.goAlert(GO.util.serverMessage(t)),!1;var r=t.data,i=$(["<li>","<span class='item_file'>","<span class='ic_file ic_",r.fileExt,"'></span>","<span class='name'>",r.fileName,"</span>","<span class='size'>(",GO.util.getHumanizedFileSize(r.fileSize),")</span>","<span class='btn_wrap'>","<span class='ic_classic ic_del'></span>","</span>","</span>","</li>"].join("")).data("attach",t.data);this.$("#fileList").html(i),this._verify(t.data)},this)).complete(function(e,t){console.info(t)}).error(function(e,t){console.info(t)})},_onClickDeleteAttach:function(e){$(e.currentTarget).closest("li").remove(),this.$("#importDesc").hide()},_onClickAppHome:function(e){GO.router.navigate("works/applet/"+this.appletId+"/home",!0)},_onClickHelp:function(){var e=window.location.protocol+"//"+window.location.host+GO.contextRoot+"app/works/csv/help",t="width=1280, height=700, left=0, top=0, scrollbars=1";window.open(e,"",t)},_onChangeFilter:function(){GO.router.navigate("works/applet/"+this.appletId+"/home",!0)}});return a});