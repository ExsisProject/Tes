define("works/components/filter/views/filter",function(require){var e=require("i18n!works/nls/works"),t={"\uc804\uccb4":e["\uc804\uccb4"],"\ud544\ud130 \uc800\uc7a5":e["\ud544\ud130 \uc800\uc7a5"],"\ud544\ud130 \uc0ad\uc81c":e["\ud544\ud130 \uc0ad\uc81c"],"\ud544\ud130\ub97c \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?":e["\ud544\ud130\ub97c \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"\uc0c8 \ud544\ud130 \uc800\uc7a5":e["\uc0c8 \ud544\ud130 \uc800\uc7a5"],"\uc0c8 \ud544\ud130 \uc800\uc7a5 \uc124\uba85":e["\uc0c8 \ud544\ud130 \uc800\uc7a5 \uc124\uba85"],"\ud544\ud130 \uc774\ub984 \ubcc0\uacbd":e["\ud544\ud130 \uc774\ub984 \ubcc0\uacbd"],"\ubcc0\uacbd\ud560 \ud544\ud130 \uc774\ub984\uc744 \uc785\ub825\ud558\uc138\uc694.":e["\ubcc0\uacbd\ud560 \ud544\ud130 \uc774\ub984\uc744 \uc785\ub825\ud558\uc138\uc694."],"\uc870\uac74\uc744 \ucd94\uac00\ud574\uc8fc\uc138\uc694.":e["\uc870\uac74\uc744 \ucd94\uac00\ud574\uc8fc\uc138\uc694."],"\uc0c8 \ud544\ud130":e["\uc0c8 \ud544\ud130"],"\ud14d\uc2a4\ud2b8 \uac80\uc0c9":e["\ud14d\uc2a4\ud2b8 \uac80\uc0c9"],"\uac1c\uc758 \ub370\uc774\ud130\uac00 \uc788\uc2b5\ub2c8\ub2e4":e["\uac1c\uc758 \ub370\uc774\ud130\uac00 \uc788\uc2b5\ub2c8\ub2e4"],"\uae30\ubcf8 \ud544\ud130\ub85c \uc800\uc7a5":e["\uae30\ubcf8 \ud544\ud130\ub85c \uc800\uc7a5"],"\ucc28\ud2b8\uc811\uae30":e["\ucc28\ud2b8\uc811\uae30"],"\uae30\ubcf8\ud615":e["\uae30\ubcf8\ud615"],"\ubaa9\ub85d\uad00\ub9ac":e["\ubaa9\ub85d \uad00\ub9ac"],"\ud544\ud130\uc870\uac74\uc124\uba85":e["\ud544\ud130\uc870\uac74\uc124\uba85"]},n=require("works/constants/value_type"),r=require("works/constants/condition_type"),i=require("i18n!nls/commons"),s=require("works/components/filter/views/filter_condition_add_button"),o=require("works/components/filter/views/filter_condition_button"),u=require("works/components/filter/views/filter_manager_layer"),a=require("works/components/filter/collections/filter_conditions"),f=require("works/components/filter/models/filter"),l=require("works/components/filter/models/filter_condition"),c=require("hgn!works/components/filter/templates/filter"),h=require("components/backdrop/backdrop");return Backbone.View.extend({className:"wrap_filter",events:{"click #filterManagerLayerToggleButton":"_onClickFilterManagerToggle","click [el-save-filter]":"_onClickSaveFilter","click [el-save-as-filter]":"_onClickSaveAsFilter","click [el-rename-filter]":"_onClickRenameFilter","click [el-delete-filter]":"_onClickDeleteFilter","click #search":"_onClickSearch","keydown #searchText":"_onKeydownSearch","change #searchText":"_onChangeSearch","click #filterDesc":"_toggleDesc"},initialize:function(e){this.appletId=e.appletId,this.mainForm=e.hasOwnProperty("mainForm")?e.mainForm:!0,this.isAdmin=e.isAdmin,this.useCachedCondition=e.useCachedCondition,this.fields=e.fields,this.filters=e.filters,this.filters&&(this.filters.on("changeFilter.filters",this._onChangeFilter,this),this.filters.on("remove",this._onRemoveFilter,this),this.filters.on("change:name",this._onChangeFilterName,this)),this.conditions=e.conditions||new a,this.conditions.on("unuseCondition",this._onUnuseCondition,this),this.template=e.template||c,this.templateParam=e.templateParam||{},this.useStore=e.store!==!1,this.useDocNo=e.useDocNo||!1;var t=e.refLink===undefined?!1:e.refLink.isLinkFilter;this.useCheckbox=e.useCheckbox!==!1,this.collection=e.collection;if(t){var n=this.options.refLink.appletId+"-"+this.options.refLink.docId+"-linkfilterData-"+this.appletId,i=GO.util.store.get(n),s={conditionType:r.SELECT,fieldCid:i.fieldCid[0],values:{isRelative:!0,values:[{id:i.values.values[0].id,text:i.values.values[0].text}]}},o=new l(s),u=this.fields.findWhere({cid:o.fieldCid});o.mergeFromFields(this.fields.toJSON()),this.conditions.push(o)}var f=t?undefined:this.useStore?this._getStoredFilter():{conditions:this.conditions.toJSON()};this._initFilter(f),this.hasInitFilterId=parseInt(f)>0,this.hasInitFilterId&&this.filter.fetch(),this.listenTo(this.conditions,"add",this._onUpdateConditions)},render:function(){return this.fields.deferred.done($.proxy(function(){this.$el.html(this.template(_.extend({lang:t,model:this.filter.toJSON(),collection:this.collection,mainForm:this.mainForm},this.templateParam))),this.$listEl=this.$("#fieldManagerAndConditionsArea"),this._renderManagerLayer(),this._renderFieldAddButton(),this.hasInitFilterId||this._filterProcess()},this)),this},addConditionButton:function(e){this._renderConditionButton(e)},_initFilter:function(e,t){var n={appletId:this.appletId,type:t||"mine",useDocNo:this.useDocNo||!1};_.isObject(e)?(this.filter=new f(_.extend(e,{useDocNo:this.useDocNo||!1})),this.conditions.reset(e.conditions)):e==="createdBy"?(this.filter=new f(_.extend(n,f.getCreatedByFilterOptions())),this.conditions.reset(this.filter.get("conditions"))):(parseInt(e)>0&&(n.id=parseInt(e)),this.filter=new f(n)),this.filter.off("sync"),this.filter.on("sync",this._onSyncFilter,this),this.filter.off("change:name"),this.filter.on("change:name",this._onChangeNameOfFilter,this)},_renderManagerLayer:function(){this.managerLayer=new u({model:this.filter,parentCid:this.cid});var e=this.$("#filterManagerLayerToggleButton");e.attr("backdrop-toggle",!0),this.managerLayer.linkBackdrop(e),this.managerLayer.toggle(!1),e.append(this.managerLayer.render().el)},_renderFieldAddButton:function(){var e=new s({useCheckbox:this.useCheckbox,type:n.SELECT,collection:this.fields.getFilterFields()});e.$el.on("addCondition",_.bind(this._onToggleFieldOption,this)),this.$listEl.append(e.render().el)},_renderConditionButton:function(e,t){var r=new o(_.extend(e,{fields:this.fields}));this.$("#fieldManagerAndConditionsArea").append(r.render().el),t&&_.contains(n.INSTANT_SEARCH_TYPES,e.valueType)&&this._triggerSearch()},_clearConditionButtons:function(){this.$listEl&&this.$listEl.find("div[el-condition]").remove()},_onUnuseCondition:function(e){var t=this.fields.findWhere({cid:e.get("fieldCid")});t.set("isUsed",!1),this.conditions.remove([e]),this.filter.set("conditions",this.conditions.toJSON())},_onToggleFieldOption:function(e,t){var n,r=t.get("isUsed");if(r){var i=t.fieldToCondition();n=new l(i);var s=this.fields.findWhere({cid:n.get("fieldCid")});n.setDefaultValues(),n.mergeFromFields(this.fields.toJSON()),this.conditions.push(n),this._renderConditionButton({type:s.get("fieldType"),valueType:s.get("valueType"),model:n},!0)}else n=this.conditions.findWhere({fieldCid:t.get("cid")}),n.trigger("unusedItem",[n])},_onChangeFilter:function(e,t){this._changeFilter(e,t),GO.util.store.set(GO.session("id")+"-"+this.appletId+"-works-last-filter-id",e)},_changeFilter:function(e,t){this._initFilter(e,t),this.managerLayer.model=this.filter,this.managerLayer.render(),e=="all"?(this._toggleSaveAndLayerButton(),this.fields.unuseAllField(),this.conditions.reset([]),this._clearConditionButtons(),this._setFilterValue(),this._triggerSearch()):this.filter.fetch()},_filterProcess:function(){this.filter.isOthersFilter()&&this.filter.set("id",undefined),this._toggleSaveAndLayerButton(),this._setFilterValue(),this.fields.mergeFromConditions(this.conditions.toJSON()),this._renderConditions(this.conditions),this._triggerSearch(!0)},_onSyncFilter:function(){this.conditions.reset(this.filter.get("conditions")),this.conditions.mergeFromFields(this.fields.toJSON()),this._filterProcess()},_renderConditions:function(e){this._clearConditionButtons(),e.each(function(e){var t=this.fields.findWhere({cid:e.get("fieldCid")});if(!t)return;var n=t.get("fieldType"),r=t.get("valueType");if(!n)return;this._renderConditionButton({type:n,valueType:r,model:e})},this),this.$el.off("changeFilter"),this.$el.on("changeFilter",_.bind(function(){this._triggerSearch()},this))},_onClickSaveFilter:function(){this.filter.save({searchKeyword:this.$("#searchText").val(),conditions:this.conditions.toJSON()},{success:function(){$.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])}})},_onClickSaveAsFilter:function(e){function n(){var e="";return this.isAdmin&&(e=['<span class="option_wrap">','<input type="checkbox" id="saveAsBaseFilter">','<label for="saveAsBaseFilter">',t["\uae30\ubcf8 \ud544\ud130\ub85c \uc800\uc7a5"],"</label>","</span>"].join("")),e}e.stopPropagation(),this.managerLayer.toggle(!1);var r=['<div class="content">','<p class="desc">',t["\uc0c8 \ud544\ud130 \uc800\uc7a5 \uc124\uba85"],"</p>",'<div class="form_type">','<input el-new-name class="txt_mini w_max" type="text" value="'+t["\uc0c8 \ud544\ud130"]+'">',"</div>",n.call(this),"</div>"].join("");this.popup=$.goPopup({modal:!0,pclass:"layer_normal layer_public_list",header:t["\ud544\ud130 \uc800\uc7a5"],width:500,contents:r,buttons:[{btext:i["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:$.proxy(function(){var e=this.popup.find("input[el-new-name]"),t=e.val();if(t.length>64||t.length<1)return $.goError(GO.i18n(i["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:1,arg2:64}),e,!1,!0),!1;var n=this.popup.find("#saveAsBaseFilter").is(":checked");this._saveAsFilter(t,n),this.popup.close()},this)},{btext:i["\ucde8\uc18c"],btype:"normal"}]}),this.popup.find("input").focus()},_saveAsFilter:function(e,t){this._initFilter(),this._saveFilter(e,t).done(_.bind(function(e){GO.util.store.set(GO.session("id")+"-"+this.appletId+"-works-last-filter-id",e.data.id)},this))},_saveFilter:function(e,t){return t&&this.filter.setType("base"),this.filter.save({searchKeyword:this.$("#searchText").val(),name:e,conditions:this.conditions.toJSON()},{success:$.proxy(function(){this.filters.fetch(),$.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},this)})},_onClickRenameFilter:function(e){e.stopPropagation(),this.managerLayer.toggle(!1);var n=['<div class="content">','<p class="desc">',t["\ubcc0\uacbd\ud560 \ud544\ud130 \uc774\ub984\uc744 \uc785\ub825\ud558\uc138\uc694."],"</p>",'<div class="form_type">','<input el-new-name class="txt_mini w_max" type="text" value="'+this.filter.get("name")+'">',"</div>","</div>"].join("");this.popup=$.goPopup({modal:!0,pclass:"layer_normal layer_public_list",header:t["\ud544\ud130 \uc774\ub984 \ubcc0\uacbd"],width:500,contents:n,buttons:[{btext:i["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:$.proxy(function(){var e=this.popup.find("input[el-new-name]"),t=e.val();if(t.length>64||t.length<1)return $.goError(GO.i18n(i["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:1,arg2:64}),e,!1,!0),!1;this._saveFilter(t),this.managerLayer.toggle(!1),this.popup.close()},this)},{btext:i["\ucde8\uc18c"],btype:"normal",callback:$.proxy(function(){this.managerLayer.toggle(!1)},this)}]})},_onClickDeleteFilter:function(e){e.stopPropagation(),this.managerLayer.toggle(!1),$.goConfirm(t["\ud544\ud130\ub97c \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",$.proxy(this._deleteFilter,this))},_deleteFilter:function(){var e=this.filter.get("id");this.filter.destroy({success:$.proxy(function(){this._changeFilter("all"),this.filters.remove([this.filters.findWhere({id:e})]),GO.util.store.set(GO.session("id")+"-"+this.appletId+"-works-last-filter-id",null),GO.router.navigate("works/applet/"+this.appletId+"/home",{replace:!0})},this)})},_onClickFilterManagerToggle:function(){this.$("#filterManagerLayer").toggle()},_setFilterValue:function(){this.$("span[el-filter-name]").text(this.filter.get("name")),this.$("#searchText").val(this.filter.get("searchKeyword"))},_search:function(){var e=$.trim(this.$("#searchText").val());this.filter.set("searchKeyword",e),GO.router.navigate("works/applet/"+this.appletId+"/home/search",{replace:!0}),this._triggerSearch()},_onClickSearch:function(){this._search()},_onKeydownSearch:function(e){if(e.keyCode!=13)return;this._search()},_triggerSearch:function(e){this._storeConditions();var t;if(this.options.refLink){var n=this.options.refLink.appletId+"-"+this.options.refLink.docId+"-linkFilterQuery-"+this.appletId;t=GO.util.store.get(n),_.isUndefined(t)&&(t=""),this.options.refLink=undefined}else t=this.filter.getSearchQuery();this.$el.trigger("searchByFilter",{queryString:t,useStorePage:e})},_onRemoveFilter:function(e){this.filter&&this.filter.id==e.id&&this._changeFilter("all")},_onChangeSearch:function(){var e=$.trim(this.$("#searchText").val());this.filter.set("searchKeyword",e)},_onChangeFilterName:function(e){this.filter.id==e.id&&this.filter.set("name",e.get("name"))},_onChangeNameOfFilter:function(){this._setFilterValue()},_toggleSaveAndLayerButton:function(){var e=this.filter.get("id")>0&&(this.filter.get("type")!=="base"||!!this.isAdmin);this.$("#filterManagerLayerToggleButton").toggle(e),this.$("a[el-save-as-filter]").toggle(!e),this.$("a[el-save-filter]").toggle(e)},_onUpdateConditions:function(){this._storeConditions()},_storeConditions:function(){this.useStore&&(this.filter.set("conditions",this.conditions.toJSON()),this.$el.trigger("storeConditions",this.filter.toJSON()))},_getStoredFilter:function(){var e=this.useCachedCondition?GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject"):null;return e?e&&e.filter&&parseInt(e.filter.appletId)===parseInt(this.appletId)?e.filter:null:GO.util.store.get(GO.session("id")+"-"+this.appletId+"-works-last-filter-id")},_getConditions:function(){return this.conditions},_toggleDesc:function(){this.backdropView||(this.backdropView=new h,this.backdropView.backdropToggleEl=this.$("span[el-backdrop]"),this.backdropView.linkBackdrop(this.$("span[el-backdrop-link]")))}})});