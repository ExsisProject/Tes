define("works/views/app/app_home",function(require){require("jquery.nanoscroller");var e=require("when"),t=require("i18n!nls/commons"),n=require("i18n!works/nls/works"),r={"\ub4f1\ub85d":t["\ub4f1\ub85d"],"\uc0ad\uc81c":t["\uc0ad\uc81c"],"\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc":t["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],"\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.":t["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]},i=require("works/components/chart/views/presentation"),s=require("works/views/app/base_applet"),o=require("works/components/doc_list/views/app_home_doc_list"),u=require("works/components/filter/views/filter"),a=require("works/components/chart/views/chart"),f=require("works/views/app/download_manager_btn"),l=require("works/collections/docs"),c=require("works/collections/fields"),h=require("works/components/chart/collections/chart_settings"),p=require("works/personal_list_manager/collections/personal_list_settings"),d=require("works/components/list_manager/models/list_setting"),v=require("hgn!works/templates/app/app_home_form_tab"),m=Hogan.compile(['<div class="dashboard_box {{layoutType}}" el-chart-wrapper>','<ul class="type_chart_view">','<li class="col_1" data-el-chart-layout="type_col_01" title="{{label.type1}}"><a class="chart_type"><span class="ic_works ic_chart_v1"></span></a></li>','<li class="col_2" data-el-chart-layout="type_col_02" title="{{label.type2}}"><a class="chart_type"><span class="ic_works ic_chart_v2"></span></a></li>','<li class="col_3 on" data-el-chart-layout="type_col_03" title="{{label.type3}}"><a class="chart_type"><span class="ic_works ic_chart_v3"></span></a></li>',"</ul>",'<div class="card_item_wrapper"></div>',"</div>"].join("")),g=Hogan.compile(['<div class="error_page"><hgroup><span class="ic_data_type ic_error_page"></span><h2>{{title}}</h2></hgroup>','{{#message}}<p class="desc">{{&.}}</p>{{/message}}'].join(""));return s.extend({events:{"click #navigateToListSetting":"_onClickNavigateToListSetting","click [data-action='chartArrow']":"toggleChart","change #settingList":"_onChangeSettingList","click [data-el-chart-layout]":"_onChangeChartLayout"},initialize:function(e){GO.util.store.set("applet-viewtype","list",{type:"session"}),this.useCachedCondition=e.useCachedCondition,s.prototype.initialize.apply(this,arguments),this.filters.on("changeFilter.filters",this._onChangeFilter,this);var t={};this.useCachedCondition?t=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject")||{}:GO.util.store.set(GO.session("id")+"-"+this.appletId+"-searchObject",{},{type:"session"}),this._setSubFormId(),this.settingId=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-works-list-setting",null)||"0",this.docs=new l([],{appletId:this.appletId,includeActivityCount:!0,subFormId:this.subFormId,personalViewId:this.settingId}),this._settingSynced=$.Deferred(),this._fieldSynced=$.Deferred(),this.docs.setPageNo(t.page||0),this._setPropertyAndDirection(),this.docs.on("sync",this._onSyncDocs,this),this.share.on("sync",this._onSyncShare,this),this._shareSynced=$.Deferred(),this.charts=new h,this.setting=new d({},{appletId:this.appletId}),this.settings=new p([],{appletId:this.appletId}),this.fields=new c([],{appletId:this.appletId,includeProperty:!0,subFormId:this.subFormId}),this.fields.on("sync",this._onSyncFields,this),this.$el.on("searchByFilter",$.proxy(function(e,t){this._search(t)},this)),this.layoutView.$el.on("storeParam",$.proxy(function(){this.docs.storeParam()},this));var r=GO.util.store.get(GO.session("id")+"-"+"-chart-view-layout")||"type_col_03";this.$el.html(m.render({layoutType:r,label:{type1:n["1\ub2e8 \ubcf4\uae30"],type2:n["2\ub2e8 \ubcf4\uae30"],type3:n["3\ub2e8 \ubcf4\uae30"]}})),this.$el.on("storeConditions",_.bind(this._storeConditions,this)),this.$el.on("selectPage",$.proxy(function(e,t){this._storePage(t),GO.router.navigate("works/applet/"+this.appletId+"/home/search",{replace:!0})},this)),this.$el.on("sorting:grid",_.bind(this._onSorting,this)),this.$el.on("changeFilter",_.bind(function(){GO.router.navigate("works/applet/"+this.appletId+"/home/search",{replace:!0})},this)),this.$el.on("showPresentationMode",_.bind(this._showPresentationMode,this)),this.$el.on("update:grid",_.bind(this._reloadListView,this)),this.$el.on("contextMenu:grid",_.bind(this._onSelectContextMenu,this)),this.$el.on("headerSummary:grid",_.bind(this._onListHeaderSummary,this)),this.$el.on("update:chart",_.bind(this._setChartsView,this))},render:function(){$.when(s.prototype.render.apply(this,arguments),this.accessibleForms.length>0?this.fields.fetch():this._renderNoExistForm(this.$el),this.setting.fetch(),this.settings.fetch()).then($.proxy(function(){if(this.accessibleForms.length<1)return;this._initCurrentSettings();var e=this,t=!1;this.accessibleForms.length>0&&(this.$("div.content_tab").remove(),this.$el.before(v({forms:this.accessibleForms,isSelect:function(){return this.mainForm?GO.util.isInvalidValue(e.subFormId)?(t=!0,!0):!1:this.id==e.subFormId?(t=!0,!0):!1},isFormManager:!1})),$("[el-form-tab]").click(function(t){e._onChangeForm(t)}),$(".tab_menu_wrap").scroll(function(t){e._onScrollMoveTab(t)}),$("span[el-arrow-tab]").click(function(t){e._onClickMoveTab(t)}),t||$(".tab_menu>li").first().addClass("active"),$(".tab_menu_wrap").animate({scrollLeft:$("li.active")==undefined||$("li.active").attr("data-id")=="tab_main"?0:$("#tabMenu").scrollLeft()-$("#tabMenu").offset().left+$("li.active").offset().left-45},200),this.__onScrollMoveTab($(".tab_menu_wrap"))),this._renderFilterView();var n=this.layoutView.getContentElement();n.removeClass("build_situation"),n.addClass("go_works_situation"),this.layoutView.$el.removeClass("go_skin_works"),this.settings.deferred.done($.proxy(function(){this._renderSettingList()},this)),this._renderListView(),this._chartViewDisplaySetting()},this))},_chartViewDisplaySetting:function(){GO.util.store.get(GO.session("id")+"-"+this.appletId+"-is-chart-view-active")==0?(this.$("a.chart").removeClass("off"),this.$("a.chart").find(".txt").text(n["\ucc28\ud2b8\ubcf4\uae30"]),this.$("div.dashboard_box").hide()):(this.$("a.chart").addClass("off"),this.$("a.chart").find(".txt").text(n["\ucc28\ud2b8\uc811\uae30"]),this.charts.length?this.$(".card_item_wrapper").children().length<1?this.$("div[el-chart-wrapper]").hide():this.$("div.dashboard_box").show():this.$("div[el-chart-wrapper]").hide())},_reloadListView:function(){$.when(this.settings.fetch(),this.setting.fetch()).then($.proxy(function(){this.adminSetting=this.setting.toJSON(),this.listView._setSetting(this.setting),this.listView._setSettings(this.settings),this._renderSettingListView(),this._chartViewDisplaySetting()},this))},_onSelectContextMenu:function(e,t){this.listView._onSelectContextMenu(t)},_onListHeaderSummary:function(e,t){GO.util.store.set(this.appletId+"-gridview-headerSummary",t.visible)},_onChangeChartLayout:function(e){var t=$(e.currentTarget);t.siblings().removeClass("on"),t.addClass("on");var n=$(e.currentTarget).attr("data-el-chart-layout");GO.util.store.set(GO.session("id")+"-"+"-chart-view-layout",n,"local"),this.$(".dashboard_box").removeClass("type_col_01 type_col_02 type_col_03").addClass(n),$(window).trigger("resize")},_showPresentationMode:function(e,t){var n=new i({model:t,charts:this.charts,appletId:this.appletId,chartFields:this.fields.getChartFields(),numberFields:this.fields.getNumberFields(),width:"100%",height:"100%"});$(".go_wrap").prepend(n.render().el)},_onSyncShare:function(){this._shareSynced.resolve()},_onSyncFields:function(){this._settingSynced.done($.proxy(function(){this._renderChartsView()},this)),this._fieldSynced.resolve()},_onSyncDocs:function(){this.$("#docsLength").text(this.docs.total)},_initCurrentSettings:function(){this.adminSetting=this.setting.toJSON();var e=parseInt(this.settingId),t=e?this.settings.get(e):null;t?(this.setting.set(_.extend(t.get("view"),{id:e})),this.charts.reset(this.setting.get("charts"))):this.charts.reset(this.setting.get("charts")),this.useCachedCondition||this._setPropertyAndDirection(),this._settingSynced.resolve()},_onSorting:function(e,t){this._storeSort(t),GO.router.navigate("works/applet/"+this.appletId+"/home/search",{replace:!0})},_onChangeFilter:function(){this.docs.setPageNo(0)},_renderChartsView:function(){this.charts.mergeFromFields(this.fields),this.$("div.card_item_wrapper").empty(),this.charts.each(function(e){if(e.get("hasDeletedField"))return;var t=new a({model:e,appletId:this.appletId,chartFields:this.fields.getChartFields(),numberFields:this.fields.getNumberFields()});this.$("div.card_item_wrapper").append(t.el),t.render()},this),this.charts.length||this.$("div[el-chart-wrapper]").hide()},_renderFilterView:function(){var e=new u({fields:this.fields,appletId:this.appletId,filters:this.filters,isAdmin:this.baseConfigModel.isAdmin(GO.session("id")),useDocNo:this.adminSetting.docNoConfig?this.adminSetting.docNoConfig.useDocNo:!1,refLink:this.options.refLink,useCachedCondition:this.useCachedCondition,collection:this.settings.toJSON(),mainForm:GO.util.isInvalidValue(this.subFormId)});this.$el.prepend(e.el),e.render(),this.conditions=e._getConditions(),this.charts.length?this.$("a.chart").show():this.$("a.chart").hide()},_renderSettingList:function(){var e=this.$("#settingList"),t=e.find('[value="'+this.settingId+'"]').length?this.settingId:"0";this.$("#settingList").val(t)},_renderListView:function(){var e=this.baseConfigModel.isAdmin(GO.session("id"));this.listView&&this.listView.remove(),this.listView=new o({appletId:this.appletId,subFormId:this.subFormId,checkbox:!!e,settingId:this.settingId,settings:this.settings,setting:this.setting,adminSetting:this.adminSetting,collection:this.docs,fields:this.fields,buttons:this._getGridButtons(),conditions:this.conditions,usePopupView:!0}),this.listView.$el.on("navigate:grid",$.proxy(function(e,t){this._setDocIdsTable(),GO.util.isValidValue(this.subFormId)?GO.router.navigate("works/applet/"+this.appletId+"/doc/"+t+"/navigate/"+this.subFormId,!0):GO.router.navigate("works/applet/"+this.appletId+"/doc/"+t+"/navigate",!0)},this)),this.listView.dataFetch().done($.proxy(function(){this.$el.append(this.listView.render().el)},this))},_getGridButtons:function(){var e=this.baseConfigModel.isAdmin(GO.session("id")),t=Hogan.compile(['<a class="btn_tool">','<span class="ic_toolbar {{className}}"></span>','<span class="txt">{{label}}</span>',"</a>"].join("")),i=Hogan.compile(['<div class="btn_submenu">','<a class="btn_tool btn_tool_multi" id="downloadBtn">','<span class="ic_toolbar {{className}}"></span>','<span class="txt">{{label}}</span>',"</a>",'<span class="btn_func_more" id="submenuBtn">','<span class="ic ic_arrow_type3"></span>',"</span>","</div>"].join("")),s=[];return this._isDeletable()&&s.push({render:function(){return t.render({label:r["\uc0ad\uc81c"],className:"del"})},onClick:$.proxy(function(){this._deleteDocs()},this)}),e&&s.push({render:function(){return i.render({label:r["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],className:"download"})},onClick:$.proxy(function(){window.location.href=this.docs.csvUrl()},this),type:function(){return"submenu"},getView:_.bind(function(){return new f({appletId:this.appletId,collection:this.docs,conditions:this.conditions})},this)}),this.share.get("docAddible")&&(s.unshift({render:function(){return t.render({label:r["\ub4f1\ub85d"],className:"write"})},onClick:$.proxy(function(){GO.util.isValidValue(this.subFormId)?GO.router.navigate("works/applet/"+this.appletId+"/doc/new/"+this.subFormId,!0):GO.router.navigate("works/applet/"+this.appletId+"/doc/new",!0)},this)}),s.push({render:function(){return t.render({label:n["\uc77c\uad04 \ub4f1\ub85d"],className:"upload"})},onClick:$.proxy(function(){GO.router.navigate("works/applet/"+this.appletId+"/settings/csv",!0)},this)})),s},_search:function(t){this.docs.queryString=t.queryString,t.useStorePage||(this.docs.pageNo=0),this._storePage(this.docs.pageNo),e.all([this._settingSynced,this._fieldSynced,this.settings.deferred]).then($.proxy(function(){GO.util.preloader(this.docs.fetch()),this.charts.setQueryString(t.queryString)},this))},_deleteDocs:function(){var e=this.listView.getCheckedIds();if(!e.length){$.goMessage(r["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}$.goConfirm(t["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",$.proxy(function(){GO.util.preloader($.ajax({type:"DELETE",contentType:"application/json",url:GO.contextRoot+"api/works/applets/"+this.appletId+"/docs",data:JSON.stringify({ids:this.listView.getCheckedIds()}),success:$.proxy(function(){$.goMessage(t["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),this.docs.fetch(),this.charts.triggerChangeDocs()},this),error:function(){$.goError(t["\uad00\ub9ac \uc11c\ubc84\uc5d0 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4"])}}))},this))},_setDocIdsTable:function(){var e=this.docs.map(function(e){return e.id});GO.util.store.set(GO.session("id")+"-"+this.appletId+"-docIdsTable",e,{type:"session"})},_isDeletable:function(){var e=this.baseConfigModel.isAdmin(GO.session("id")),t=this.share.get("deleteDocRoles"),n=_.contains(t,"ADMIN");return e&&n},_storeConditions:function(e,t){var n=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject")||{};n.filter=t,GO.util.store.set(GO.session("id")+"-"+this.appletId+"-searchObject",n,{type:"session"})},_storePage:function(e){var t=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject")||{};t.page=e,GO.util.store.set(GO.session("id")+"-"+this.appletId+"-searchObject",t,{type:"session"})},_storeSort:function(e){var t=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject")||{};t.property=e.property,t.direction=e.direction,GO.util.store.set(GO.session("id")+"-"+this.appletId+"-searchObject",t,{type:"session"})},_setSubFormId:function(){var e=this.useCachedCondition?GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject")||{}:{};this.useCachedCondition||(e.subFormId=this.subFormId,GO.util.store.set(GO.session("id")+"-"+this.appletId+"-searchObject",e,{type:"session"}))},_onChangeForm:function(e){var t=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject")||{},n=$(e.currentTarget).attr("data-id");n==="tab_main"?delete t.subFormId:(t.subFormId=n,this.subFormId=n),GO.util.store.set(GO.session("id")+"-"+this.appletId+"-searchObject",t,{type:"session"}),GO.router.navigate("works/applet/"+this.appletId+"/home",{trigger:!0,pushState:!1,replace:!0})},_setPropertyAndDirection:function(){$.when(this._settingSynced,this._fieldSynced).done(_.bind(function(){var e=this.useCachedCondition?GO.util.store.get(GO.session("id")+"-"+this.appletId+"-searchObject")||{}:{},t=this.setting.getSortColumnFieldCid();this.docs.property=this.fields.getPropertyByFieldCid(t),this.docs.direction=this.setting.getSortDirection(),this.useCachedCondition&&(e.property&&this.docs.setAttributes({property:e.property}),e.direction&&this.docs.setAttributes({direction:e.direction}))},this))},toggleChart:function(e){this.toggleEl(e,$("div.dashboard_box"))},toggleEl:function(e,t){var r=$(e.currentTarget);r.hasClass("off")?(r.removeClass("off"),r.find(".txt").text(n["\ucc28\ud2b8\ubcf4\uae30"]),t.hide(),GO.util.store.set(GO.session("id")+"-"+this.appletId+"-is-chart-view-active",!1,"local")):(r.addClass("off"),r.find(".txt").text(n["\ucc28\ud2b8\uc811\uae30"]),t.show(),$(window).trigger("resize"),GO.util.store.set(GO.session("id")+"-"+this.appletId+"-is-chart-view-active",!0,"local"))},_onClickNavigateToListSetting:function(){var e=GO.util.store.get(GO.session("id")+"-"+this.appletId+"-works-list-setting",null),t=parseInt(e)?"/"+e:"";GO.router.navigate("works/applet/"+this.appletId+"/settings/listview/personal"+t,!0)},_onChangeSettingList:function(e){this.settingId=$(e.currentTarget).val(),GO.util.store.set(GO.session("id")+"-"+this.appletId+"-works-list-setting",this.settingId),this._renderSettingListView()},_renderSettingListView:function(){this._initSetting(),this.listView._setPropertyAndDirection(),this.listView._setColumns(),this.listView._setSettingId(this.settingId),this._setChartsView(),this.listView.render(),this.docs._setPersonalViewId(this.settingId)},_initSetting:function(){var e=parseInt(this.settingId),t=e?this.settings.get(e).get("view"):this.adminSetting;t&&this.setting.set(_.extend(t,{id:t.id}))},_setChartsView:function(){this.charts.reset(this.setting.get("charts")),this.charts.mergeFromFields(this.fields),this.$("div.card_item_wrapper").empty(),this.charts.length?(this.$("div[el-chart-wrapper]").show(),this.$("a.chart").show(),this.$(".ic_chart").addClass("off"),this.$("a.chart").find(".txt").text(n["\ucc28\ud2b8\uc811\uae30"])):(this.$("div[el-chart-wrapper]").hide(),this.$("a.chart").hide()),this.charts.each(function(e){if(e.get("hasDeletedField"))return;var t=new a({model:e,appletId:this.appletId,chartFields:this.fields.getChartFields(),numberFields:this.fields.getNumberFields()});this.$("div.card_item_wrapper").append(t.el),t.render(),t.fetchChartDatas()},this),this._chartViewDisplaySetting()},_onScrollMoveTab:function(e){this.__onScrollMoveTab($(e.currentTarget))},__onScrollMoveTab:function(e){var t=e.scrollLeft();t+e.innerWidth()+80>=e[0].scrollWidth?$(".tab_arrow.right").hide():$(".tab_arrow.right").show(),t==0?$(".tab_arrow.left").hide():$(".tab_arrow.left").show()},_onClickMoveTab:function(e){var t=$(e.currentTarget).hasClass("ic_arrow_next");t?$(".tab_menu_wrap").animate({scrollLeft:"+=460"},200):$(".tab_menu_wrap").animate({scrollLeft:"-=460"},200)}})});