define("works/views/app/gantt_view/gantt_tree_config",function(require){var e=require("app"),t=require("underscore"),n=require("backbone"),r=require("hogan"),i=require("when"),s=require("works/constants/works"),o=require("text!works/templates/app/gantt_view/gantt_list_row.html"),u=require("i18n!nls/commons"),a=require("i18n!works/nls/works"),f=require("i18n!board/nls/board"),l=require("i18n!contact/nls/contact"),c={modify:u["\uc218\uc815"],save:u["\uc800\uc7a5"],remove:u["\uc0ad\uc81c"],cancel:u["\ucde8\uc18c"],popup:u["\ud31d\uc5c5\ubcf4\uae30"],except:a["\ub370\uc774\ud130 \uc81c\uc678"],open:u["\uc5f4\uae30"]},h="0";return n.View.extend({template:o,sortableState:!1,events:{"click .btnSaveNode":"_onClickSaveNode","click .btnEditNode":"_onClickEditNode","click .btnRemoveNode":"_onClickNodeRemove","click .btnCancelAddNode":"_onClickCancelAddNode","click .btnCancelEditNode":"_onClickCancelEditNode","click .btnToggleNode":"_onClickToggleNode","click .btnDocPopup":"_onClickDocPopup","click .node .title":"_onClickTitle","click #add_doc":"_onClickAddDoc"},initialize:function(t){this.options=t||{},this.appletId=this.options.appletId,this.fields=this.options.fields,this.isAdmin=this.options.isAdmin,this.ganttViewModel=this.options.ganttViewModel,this.queryString=this.options.queryString,this.sortableState=!1,e.EventEmitter.on("ganttTree","refresh:dates",function(e){this._changeNodeDates(e)},this)},render:function(){this.exposingDocCount=0,$.ajax({type:"GET",async:!1,dataType:"json",url:e.contextRoot+"api/works/applets/"+this.appletId+"/ganttview/nodes",data:{q:t.isUndefined(this.queryString)?"":this.queryString},success:$.proxy(function(e){var t=e.data;this.totalDocNodeCount=t.totalDocNodeCount,this.ganttTreeRootNode=t.appletGanttNodeModel,this.rootNodeId=this.ganttTreeRootNode.id,this.rootNodeType=this.ganttTreeRootNode.nodeType,this.ganttTreeNodes=this.ganttTreeRootNode.children,this.renderEmptyMessageIfNoData(),this.ganttTreeNodes.length>0&&(this._indicateTotalProgress(this.ganttTreeNodes),this.$el.empty().addClass("board-tree-nodes"),this.appendNodesToParent(this.ganttTreeNodes,this.$el),this.$el.find("li .item").last().addClass("last")),$("#exposingDocNodeCount").text(this.exposingDocCount),$("#totalDocNodeCount").text(this.totalDocNodeCount),this.sortableState&&this.enableSortable()},this),error:function(e){$.goError(e.responseJSON.message)}})},appendNodesToParent:function(e,n){t.each(e,function(e){if(this._isDocType(e.nodeType)&&!e.appletDocModel)return;var t=this.createNodeElement(e);this._isGroupType(e.nodeType)?(t.append('<ul class="board-tree-nodes"></ul>'),this.appendNodesToParent(e.children,t.find("ul.board-tree-nodes"))):this.exposingDocCount++,n.append(t)},this)},_onClickSaveNode:function(e){var t=$(e.currentTarget),n=t.closest("li");this._saveNode(n)},_onClickEditNode:function(e){var t=$(e.currentTarget),n=t.closest("li"),r=n.data("id"),i=this._getNodeById(r);this._toggleNodeTitleInput(i,n,!0)},_onClickNodeRemove:function(t){var n=this,r=$(t.currentTarget),i=r.closest("li.node");t.preventDefault(),t.stopImmediatePropagation();var s=a["\uac04\ud2b8 \ubdf0\uc5d0\uc11c \uc81c\uac70\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],o=a["\uac04\ud2b8 \ubdf0\uc5d0\uc11c \uc81c\uac70\ub418\uc5b4\ub3c4 \ub9ac\uc2a4\ud2b8 \ubdf0\uc5d0\uc11c \ud655\uc778\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],f="doc",c=i.attr("doc-id");r.closest("li").hasClass("folder")&&(s=l["\uadf8\ub8f9\uc0ad\uc81c"],o=u["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"]+" "+a["\uc0ad\uc81c\ud558\uba74 \uadf8\ub8f9 \ub0b4 \ubb38\uc11c\ub4e4\uc774 \uadf8\ub8f9 \ubc16\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4."],f="group",c=i.data("id")),$.goConfirm(s,o,function(){$.ajax({type:"DELETE",dataType:"json",url:e.contextRoot+"api/works/applets/"+n.appletId+"/ganttview/"+f+"/"+c,success:function(e){i.remove(),n.renderEmptyMessageIfNoData(),$.goSlideMessage(u["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n._triggerChangeEvent()},error:function(e){$.goError(e.responseJSON.message)}})})},_onClickCancelAddNode:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.closest("li");n.remove(),this.renderEmptyMessageIfNoData()},_onClickCancelEditNode:function(e){var n=$(e.currentTarget),r=n.closest("li"),i=r.data("id"),s=t.findWhere(this.ganttTreeNodes,{id:i});e.preventDefault(),this._toggleNodeTitleInput(s,r)},_onClickToggleNode:function(e){e.stopImmediatePropagation();var t=$(e.currentTarget),n=t.closest("li");t.hasClass("ic_stair_open")?this.unfoldNode(n):this.foldNode(n)},_onClickDocPopup:function(t){var n=$(t.currentTarget),r=n.closest("li");window.open(e.contextRoot+"app/works/applet/"+this.appletId+"/doc/"+r.attr("doc-id")+"/popup","help","width=1280,height=700,status=yes,scrollbars=yes,resizable=yes")},_onClickTitle:function(t){var n=$(t.currentTarget),r=n.closest("li");e.router.navigate("works/applet/"+this.appletId+"/doc/"+r.attr("doc-id"),!0)},_onClickAddDoc:function(){e.router.navigate("works/applet/"+this.appletId+"/doc/new",!0)},foldNode:function(e){e.find(".board-tree-nodes:first").hide(),e.find(".btnToggleNode:first").removeClass("ic_stair_close").addClass("ic_stair_open"),$("div#gantt_graph").find("div[parent-id='"+e.attr("data-id")+"']").hide()},unfoldNode:function(e){e.find(".board-tree-nodes:first").show(),e.find(".btnToggleNode:first").removeClass("ic_stair_open").addClass("ic_stair_close"),$("div#gantt_graph").find("div[parent-id='"+e.attr("data-id")+"']").show()},foldAllNodes:function(){var e=this;this.$("li.folder").each(function(){var t=$(this);e.foldNode(t)})},unfoldAllNodes:function(){var e=this;this.$("li.folder").each(function(){var t=$(this);e.unfoldNode(t)})},_saveNode:function(n){var r=this,s=n.data("type"),o=n.data("id"),a=n.find("input:text").val();if(!$.goValidation.isCheckLength(2,64,a))return $.goSlideMessage(e.i18n(f["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"})),!1;var l,c=!1;if(o)l=i.promise(function(t,n){$.ajax({type:"PUT",dataType:"json",contentType:"application/json",url:e.contextRoot+"api/works/applets/"+r.appletId+"/ganttview/group/"+o+"/rename",data:JSON.stringify({str:a}),success:function(e){return t(e)},error:function(e){return n(e)}})});else{c=!0;var h={nodeType:s,groupName:a,parentId:this.rootNodeId,parentType:this.rootNodeType};l=i.promise(function(t,n){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:e.contextRoot+"api/works/applets/"+r.appletId+"/ganttview/group",data:JSON.stringify(h),success:t,error:function(e,t){return n(t)}})})}return l.then(function(e){if(c)r._triggerChangeEvent(),$.goSlideMessage(f["\uadf8\ub8f9\uc774 \ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]);else{var s=e.data;n.attr("data-id",s.id);var o=t.find(r.ganttTreeNodes,{id:s.id});r._toggleNodeTitleInput(o,n),r._changeGroupName(s),$.goSlideMessage(f["\uadf8\ub8f9\uc774 \uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4"])}return i.resolve(s)},function(e){$.goSlideMessage(u["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])})},_toggleNodeTitleInput:function(e,t,n){var r=this.createNodeElement(e,{isEditingMode:n||!1});t.find(".item:first").replaceWith(r.find(".item:first")),n?this.bindNodeEnterEvent(t):t.off("keyup")},bindNodeEnterEvent:function(e){var t=this;e.find("input:first").on("keyup",function(n){var r=n.keyCode?n.keyCode:n.which;13===parseInt(r)&&t._saveNode(e)})},_changeGroupName:function(e){var n=this.$el.find("li[data-id="+e.id+"]");$(n).find(".item .node-title .folder_name .txt").text(e.groupName),t.find(this.ganttTreeNodes,{id:e.id}).groupName=e.groupName},_changeNodeDates:function(t){var n=this.$el.find("li[doc-id="+t.doc_id+"]");$(n).find(".item .startdate .txt").text(e.util.shortDate(t.start)),$(n).find(".item .enddate .txt").text(e.util.shortDate(t.end))},_triggerChangeEvent:function(){e.EventEmitter.trigger("ganttTree","refresh:listAndGraph")},_triggerRefreshGraphView:function(){e.EventEmitter.trigger("ganttTree","refresh:graph")},enableSortable:function(){function r(e){e.sortable({items:"li.node:not(.space)",scroll:!0,containment:"#gantt_list_config",connectWith:".board-tree-nodes",tolerance:"pointer",axis:"y",helper:"clone",beforeStop:function(e,t){var r=$(t.item).parents("li.node").get(0);n._isGroupType($(t.item).data("type"))&&n._isGroupType($(r).data("type"))&&($.goSlideMessage(a["\uadf8\ub8f9\uc744 \uadf8\ub8f9 \uc548\uc73c\ub85c \uc774\ub3d9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),$(this).sortable("cancel"))},stop:i,receive:i})}function i(e,t){var r=t.item,i=r.closest(".board-tree-nodes");if(!i.is(this))return;var s=i.children("li.node").index(r),o=r.attr("seq");if(t.sender==null&&o==s)return;if(parseInt(s)!=0){var u=parseInt(r.prev().attr("seq"));t.sender==null&&parseInt(o)<u?s=u:s=u+1}var a=n._getNodeByElement(r),f=a?a.id:null,l=r.attr("doc-id"),c=r.parents("li.node").get(0),h=c?n._getNodeIdByElement(c):n.rootNodeId;n._moveNode(f,l,h,s)}var e=t.find(this.$el.find("li.node.folder"),function(e){return t.isUndefined($(e).attr("data-id"))});t.isUndefined(e)||e.remove();var n=this;this.$el.addClass("tb_stair_edit"),this.$el.find(".ic_drag").attr("title",a["\ud574\ub2f9 \uc601\uc5ed\uc744 \uc7a1\uace0 \uc774\ub3d9 \uc2dc \uc21c\uc11c\ub97c \ubcc0\uacbd\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."]),this.addSpaceAtNoChildGroup(),r($("#gantt_list").find(".board-tree-nodes")),this.sortableState=!0},_getNodeByElement:function(e){var t=this._getNodeIdByElement(e);if(!t)return;return this._getNodeById(t)},_getNodeIdByElement:function(e){return $(e).data("id")},_getNodeById:function(e,n){var r=this;t.isUndefined(n)&&(n=this.ganttTreeNodes);var i=t.findWhere(n,{id:e});if(i)return i;var s=t.filter(n,function(e){return r._isGroupType(e.nodeType)});return this._getNodeFromGroup(e,s)},_getNodeFromGroup:function(e,n){var r=this,i=undefined;return t.each(n,function(t){var n=r._getNodeById(e,t.children);if(n)return i=n,n}),i},_moveNode:function(t,n,r,i){var s=this;$.ajax({type:"PUT",dataType:"json",contentType:"application/json",url:e.contextRoot+"api/works/applets/"+s.appletId+"/ganttview/node/move",data:JSON.stringify({id:t,docId:n,newParentId:r,newSequence:i}),success:function(e){s.renderEmptyMessageIfNoData(),$.goSlideMessage(f["\uc21c\uc11c\ubcc0\uacbd\uc774 \uc801\uc6a9\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),s.render()},error:function(e){$.goError(e.responseJSON.message)}})},destroySortable:function(){this.$el.removeClass("tb_stair_edit"),$(".board-tree-nodes.ui-sortable").sortable("destroy"),this.sortableState=!1,this.removeSpaceAtNoChildGroup(),this._triggerRefreshGraphView()},addSpaceAtNoChildGroup:function(){$(".board-tree-nodes:empty").addClass("ui-state-highlight").append("<li class='space'><span class='ic ic_board'></span><span class='box_empty'></span></li>")},removeSpaceAtNoChildGroup:function(){$(".board-tree-nodes.ui-state-highlight").removeClass("ui-state-highlight").empty()},renderEmptyMessageIfNoData:function(){if(t.isUndefined(this.ganttTreeNodes)||this.ganttTreeNodes.length==0){var e="<li class='list empty-message'><div class='item'><span class='desc'>"+a["\ub370\uc774\ud130 \ub4f1\ub85d\uc73c\ub85c \uc77c\uc815\uc744 \uc785\ub825\ud558\uba74 \uadf8\ub798\ud504\uac00 \uadf8\ub824\uc9d1\ub2c8\ub2e4."]+"</span>"+"</div>"+"</li>";$("#gantt_list .summary").empty(),this.$el.empty().addClass("null_data").html(e)}return $.Deferred().resolve()},createNodeElement:function(e,t){return $(this._renderTemplate(this._getTemplateVars(e,t)))},_renderTemplate:function(){var e=r.compile(t.result(this,"template"));return e.render.apply(e,arguments)},_getTemplateVars:function(r,i){function x(e){return t.isEmpty(e)?"-":Array.isArray(e)?e.length>1?e[0].fullName+" "+a["\uc678"]+(e.length-1):e[0].fullName:e.fullName}var s=this.ganttViewModel,o=this._isGroupType(r.nodeType),f=o?r.groupName:r.nodeValue;if(r.appletDocModel){var l=r.appletDocModel.id,p=r.appletDocModel.values,d=r.appletDocModel.status;f=p[s.titleFieldCid];if(t.isUndefined(f))f="["+u["\uc81c\ubaa9\uc5c6\uc74c"]+"]";else{var v=this.fields.findByCid(s.titleFieldCid);f=e.util.htmlToText(v.getDisplayValue(new n.Model(r.appletDocModel)))}var m=p[s.startFieldCid],g=p[s.endFieldCid],y=p[s.userFieldCid],b=p[s.progressFieldCid],w=t.isUndefined(d)?"":d.name,E=t.isUndefined(d)?h:d.color}if(o)var b=r.progress;var S=!t.isEmpty(r.children);return t.extend({nodeId:r.id,nodeType:r.nodeType,seq:r.seq,nodeValue:f,docId:l,parentId:r.parentId,isAdmin:this.isAdmin,iconType:o?"folder":"board",isGroupNode:o,isDocNode:!o,startdate:e.util.isInvalidValue(m)?"-":e.util.shortDate(m),enddate:e.util.isInvalidValue(g)?"-":e.util.shortDate(g),user:x(y),progress:e.util.isInvalidValue(b)?"-":b+"%",hasChildren:S,childrenCount:S?r.children.length:0,statusName:w,statusColor:E,isNew:t.isUndefined(r.id)},i||{lang:c})},_indicateTotalProgress:function(e){if(!e||e.length==0)return;var t=this._calculateProgress(e,0),n=t.progress/t.count,r=Math.round(n*100)/100;$("#ganttTotalProgress").text(r+"%")},_calculateProgress:function(n,r){var i={progress:0,count:0},s=this.ganttViewModel.progressFieldCid;return t.each(n,function(t){if(t.nodeType)if(this._isGroupType(t.nodeType)&&t.children.length>0){var n=this._calculateProgress(t.children,r+1);i.progress+=n.progress,i.count+=n.count;var o=n.progress/n.count,u=Math.round(o*100)/100;t.progress=isNaN(u)?0:u}else if(!this._isGroupType(t.nodeType)){var a=t.appletDocModel.values[s];a&&(i.progress+=e.util.isInvalidValue(a)?0:a,i.count++)}},this),i.count==0&&(i.count=1),i},_isGroupType:function(e){return e===s.GANTT_NODE_TYPE.GROUP},_isDocType:function(e){return e===s.GANTT_NODE_TYPE.DOC}})});