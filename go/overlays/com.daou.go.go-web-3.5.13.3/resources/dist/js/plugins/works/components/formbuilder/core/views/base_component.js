define("works/components/formbuilder/core/views/base_component",function(require){function p(e){return t.util.initCap(e)}function d(e,t){return e["get"+p(t)+"View"]()}var e=require("backbone"),t=require("app"),n=require("works/components/formbuilder/core/component_manager"),r=require("works/components/formbuilder/core/models/component_prop"),i=require("works/components/formbuilder/core/models/user_doc"),s=require("works/models/integration"),o=require("hgn!works/components/formbuilder/core/templates/component"),u=require("works/components/formbuilder/constants"),a=require("works/constants/value_type"),f=require("works/constants/field_type"),l=require("works/constants/component_type"),c=require("i18n!works/nls/works"),h="component";return e.View.extend({type:null,appletId:null,clientId:null,viewType:null,parentCid:null,properties:null,components:[],appletDocModel:null,editable:!1,observer:null,multiple:!1,template:o,componentBodySelector:".component-body",$body:null,initialize:function(e){e=e||{},this.type=e.type||null,this.appletId=e.appletId||null,this.subFormId=e.subFormId||null,this.clientId=null,this.parentCid=null,this.properties=null,this.components=[],this.appletDocModel=null,this.integrationModel=null,this.editable=!1,this.multiple=!1,this.observer=null,this.backupData={},this.isBackuped=!1,this.isMultipleRendered=!0,this.__multipleViews__=[],e.appletDocModel&&(this.docId=e.appletDocModel.id||null),e.clientId&&(this.clientId=e.clientId),e.parentCid&&this.setParentCid(e.parentCid),e.properties&&e.properties instanceof r?this.properties=e.properties:this.properties=new r,e.components&&(this.components=e.components),e.appletDocModel?this.appletDocModel=e.appletDocModel:this.appletDocModel=new i(null,{appletId:this.appletId}),e.integrationModel?this.integrationModel=e.integrationModel:this.integrationModel=new s(null,{appletId:this.appletId}),e.hasOwnProperty("editable")&&(this.editable=e.editable),e.hasOwnProperty("multiple")&&this.setMultiple(e.multiple),e.observer&&(this.observer=e.observer),this.$el.addClass(u.CN_COMPONENT),this.$el.attr("data-is",h),this.$el.attr("data-type",this.getType()),this.$el.attr("data-cid",this.getCid()),this.$el.attr("data-id",this.cid),this.template!=null?(this.$el.addClass("build_box"),this.$el.html(this.template({editable:this.isEditable(),mainForm:t.util.isInvalidValue(this.subFormId)})),this.$body=this.$(this.componentBodySelector)):this.$body=this.$el,this.viewType!=="option"&&!this.editable&&(this.appletDocModel.id&&this.observer&&this.listenTo(this.appletDocModel,"sync",this._onSyncAppletDoc),this._hasRule()&&(this.listenTo(this.observer,"changeValue",this._onChangeValue),this.isMultiple()||this.listenTo(this.observer,"setInitDisplay",this._setInitDisplay))),this.viewType=="form"&&this.type==f.FORMULA&&this.listenTo(this.observer,"setInitDisplay",this._detectFieldForFormula)},setElement:function(t,n){e.View.prototype.setElement.apply(this,arguments),this.template!=null?this.$body=this.$(this.componentBodySelector):this.$body=this.$el},renderNode:function(){this._createOrGetCode();var e,t=this.appletDocModel.get(this.getCid());return this.isMultiple()&&_.isArray(t)&&t.length>0&&this.appletDocModel.set(this.getCid(),t[0],{silent:!0}),this.beforeRender(),!this.$body.parent().length&&this.template!=null&&(this.$el.addClass("build_box"),this.$el.html(this.template({editable:this.isEditable()})),this.$body=this.$(this.componentBodySelector)),this.render(),this.afterRender(),this.type===l.Table&&this.tableDataCorrection(),_.each(this.components,function(e){var t,r,i=n.getInstance(this.viewType);i.isCreated(e)?t=i.getComponent(e.cid):t=i.addComponent(e),this.initChildComponent(t),r=t.getView(),this.appendChildView(r.renderNode())},this),this.isMultiple()&&!this.isEditable()?e=this._renderMultiple(t):e=this,e},tableDataCorrection:function(){var e=_.map(this.components,function(e){return e.cid},this),t=this.appletDocModel.get("values")||{},n=_.map(e,function(e){var n=t[e]||[];return _.isArray(n)||(n=[n]),n.length},this),r=_.max(n)||1;_.each(e,function(e){var n=t[e]||[];_.isArray(n)||(n=[n]);var i=n.length;for(var s=0;s<r-i;s++)n.push(null);var o={};t[e]=n,o.values=t,o[e]=n,this.appletDocModel.set(o,{silent:!0})},this)},initChildComponent:function(e){return e.setViewType(this.viewType),e.setAppletId(this.getAppletId()),e.setSubFormId(this.subFormId),e.setEditable(this.isEditable()),e.attachObserver(this.observer),e.setAppletDocModel(this.appletDocModel),e.setIntegrationModel(this.integrationModel),e},beforeRender:function(){},render:function(){},afterRender:function(){},appendChildView:function(e){var t=[];_.isArray(e)?t=e:t=[e];var n=_.map(t,function(e){return e.el});this.$body.append.apply(this.$body,n)},getComponentView:function(e){return d(e,this.viewType)},getAppletId:function(){return this.appletId},getViewType:function(){return this.viewType},getType:function(){return this.type},getCid:function(){return this.clientId},getParentCid:function(){return this.parentCid},setParentCid:function(e){this.parentCid=e},getProperty:function(e){return this.properties.get(e)},getComponents:function(){return this.components},getParentComponent:function(){var e=n.getInstance(this.viewType);return e.getComponent(this.getParentCid())},isEditable:function(){return this.editable},setEditable:function(e){this.editable=e},isMultiple:function(){return this.multiple},setMultiple:function(e){this.multiple=e},setAppletDocModel:function(e){this.appletDocModel=e},setIntegrationModel:function(e){this.integrationModel=e},resizeWidth:function(e,t){this.$el.outerWidth((e||100)+(t||"%"))},targetResizeHeight:function(e,t){$(e).css("height",t+"px")},createMultipleView:function(e,t,r){if(!this.isMultiple())return;var s=n.getInstance(this.viewType),o=s.getComponent(this.getCid()),u=o.getView(),a=o.getView(!0),f={appletId:this.getAppletId()};this.appletDocModel.id&&_.extend(f,{id:this.appletDocModel.id});var l=new i(e||{},f);return u.listenTo(l,"change",u._onChangeCloneModel),a.setMultiple(!1),a.setAppletDocModel(l),a.renderNode(),_.isUndefined(t)?this.__multipleViews__.push(a):this.__multipleViews__.splice(t,0,a),a},_onChangeCloneModel:function(){if(!this.isMultipleRendered)return;var e=this._getMultipleData();this.appletDocModel.set(this.clientId,e)},_getMultipleData:function(){if(!this.isMultipleRendered)return;var e=[],t=this.appletDocModel.get(this.clientId);return e.push(_.isArray(t)?t[0]:t),_.each(this.getMultipleViews(),function(t){e.push(t.appletDocModel.get(t.clientId))}),e},addMultipleView:function(e){return this.createMultipleView.apply(this,arguments)},getMultipleViews:function(){return _.union([],this.__multipleViews__)},removeMultipleView:function(t){var n=_.findWhere(this.__multipleViews__,{cid:t}),r=_.indexOf(this.__multipleViews__,n);n&&n instanceof e.View&&n.remove(),this.__multipleViews__.splice(r,1)},addClass:function(e){this.$el.addClass(e)},removeClass:function(e){this.$el.removeClass(e)},validate:function(){if(!this._getVisible())return!0},_renderMultiple:function(e){function n(e,t,n){var r=this.getParentComponent();!_.isUndefined(r)&&r.type==l.Table&&_.times(r.getMaxRow()+t,function(){e.push(n)})}var t=[];if(!this.isMultiple())return;return _.isUndefined(e)&&this.appletDocModel.id&&(e=[],n.call(this,e,0,null)),this.type=="select"&&_.isArray(e)&&e.length==1&&n.call(this,e,-1,e[0]),e?(e=_.isArray(e)?e:[e],this.__multipleViews__=[],this.isMultipleRendered=!1,_.each(e,function(e,n){var r={};r[this.getCid()]=e,n===0?t.push(this):t.push(this.createMultipleView(r))},this),this.isMultipleRendered=!0,t):this},_createOrGetCode:function(){var e=this.model.get("code");return!e&&this._isDefaultGenerateTypes()&&(e=this._generateCode()),e},_generateCode:function(){var e=this._generate();return this.model.set("code",e),e},_generate:function(){var e=n.getInstance(this.viewType),t=e.getComponent(this.clientId),r;return this._isPredefinedTypes()?r=t.type:(r=_.uniqueId(t.type+"_"),this._isValidCode(r)||(r=this._generate())),r},_isValidCode:function(e,t){if(!this._isDefaultGenerateTypes()&&e==="")return!0;var n=!0;return n=n&&!this._checkSpace(e),n=n&&!this._checkSpecialCode(e),n=n&&!this._checkInvalidCodeFormat(e),n=n&&!this._checkSpecialCharacter(e),n=n&&!this._checkDupCode(e,t),n},_checkSpace:function(e){return e.search(/\s/)!=-1?!0:!1},_checkSpecialCode:function(e){var t=/applet_id|doc_id|status|creator|updater|create_date|update_date|score|textContent|__/i;return t.test(e)},_checkInvalidCodeFormat:function(e){var t=/^[a-z]+[a-zA-Z0-9_]*/g;return!t.test(e)},_checkSpecialCharacter:function(e){var t=/[~`!@#$%^&*()\-+={\[}\]|\\:;"'<,>.?/]/ig;return t.test(e)},_checkDupCode:function(e,t){var r=n.getInstance(this.viewType),i=r.getComponents(),s=_.filter(i,function(n){if(t===n.getCid())return!1;var r=n.getComponentPropertyModel(),i=r.get("code");return e&&e===i});return s.length>0},_isDefaultGenerateTypes:function(){return this.isFormulableTypes()||this._isPredefinedTypes()},isFormulableTypes:function(){var e=n.getInstance(this.viewType),t=e.getComponent(this.clientId);return t?_.contains(f.FORMULABLE_TYPES,t.type):!1},_isPredefinedTypes:function(){var e=n.getInstance(this.viewType),t=e.getComponent(this.clientId);return t?_.contains(f.PREDEFINED_TYPES,t.type):!1},_setInitDisplay:function(){var e=this._getPropertyModel(),t=e.rule,n=this.getParentComponent(),r=n&&n.type!==l.Canvas&&!n.visible;if(t&&!_.isEmpty(t)||r){var i=this.appletDocModel.get(t.listenComponentId);this._toggleComponent(this._valueCheck({value:i}))}},setDefaultValue:function(){var e=this._getDefaultValue();this.appletDocModel.set(this.clientId,e),this.renderNode(),this.backupData[this.clientId]=e,this._getVisible()||this.appletDocModel.set(this.clientId,null)},_onSyncAppletDoc:function(e){this.backupData[this.clientId]=e.get(this.clientId),this._getVisible()||this.appletDocModel.set(this.clientId,null)},_changeValue:function(e){this.observer.trigger("changeValue",{cid:this.clientId,value:e})},_onChangeValue:function(e){if(!this._ruleCheck(e))return;if(!this._displayCheck(e)){this._toggleComponent(!1);return}this._toggleComponent(this._valueCheck(e))},_hasRule:function(){return!!this._getRule()},_ruleCheck:function(e){e=e||{cid:this.clientId};var t=this._getRule();return t?e.cid==t.listenComponentId:!1},_displayCheck:function(e){return _.isUndefined(e.visible)?this._getComponent(e.cid).visible:e.visible},_valueCheck:function(e){function t(e,t){var n=_.map(e.values,function(e){return _.isObject(e)?e.id:parseInt(e)}),r=_.isObject(t)?t.id:parseInt(t);return _.contains(n,r)}var n=this._getRule(),r;return _.isArray(e.value)?_.each(e.value,function(e){r=t(n,e);if(r)return!1}):r=t(n,e.value),n.isInverse?!r:!!r},_detectFieldForFormula:function(){this._listenToFormulaSource(),this._setContent()},isMasking:function(){var e=this._getComponent();return e?e.isMasking():!1},setMasking:function(e){var t=this._getComponent();t.setMasking(e)},_getVisible:function(){var e=this._getComponent();return e.getVisible()},isHide:function(){if(!this._getVisible())return!0;var e=this.getParentComponent();if(!e)return!1;var t=e.getFormView();return t.isHide()},isShow:function(){return!this.isHide()},_getComponent:function(e){e=e||this.clientId;var t=n.getInstance(this.viewType);return t.getComponent(e)},_getPropertyModel:function(e){e=e||this.clientId;var t=this._getComponent(e);return t?t.properties:undefined},_getDefaultValue:function(){var e=n.getInstance(this.viewType),t=e.getComponent(this.clientId),r=_.contains(f.SELETABLE_TYPES,this.type);if(r){var i=[];return _.each(this.model.get("items"),function(e){var n=t.valueType===a.SELECTS;if(e.selected){if(!n)return i=e.value,!1;i.push(parseInt(e.value))}}),_.isEmpty(i)?null:i}var s=this._getPropertyModel(),o="";return _.contains(a.MULTI_VALUED_TYPES,t.valueType)&&(o=[]),_.contains([a.DATE,a.TIME,a.DATETIME,a.NUMBER],t.valueType)&&(o=null),s.defaultValue||o},_targetIsChild:function(e,t){function r(e){e.cid===t?n=!0:_.each(e.components,function(e){if(e.cid===t)return n=!0,!1;r(e)})}var n=!1;return r(e),n},_getRule:function(e){e=e||this.clientId;var t=this._getPropertyModel(e),n=t.rule||{},r=this._targetIsChild(this._getComponent(this.clientId),n.listenComponentId);return r&&$.goError(c["\uc798\ubabb\ub41c \ub178\ucd9c \uc870\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4. \ub178\ucd9c \uc870\uac74\uc744 \uc218\uc815\ud574 \uc8fc\uc138\uc694."]),t&&!r?t.rule:undefined},_toggleComponent:function(e){var t=this._getComponent(),n=t.getVisible(),r=this.getParentComponent(),i=r&&r.type!==l.Canvas&&!r.visible&&e;if(n===e||i)return;t.setVisible(e),this._componentElementToggle(e),e?this._restore():this._backup(),this.observer.trigger("changeValue",{cid:this.clientId,value:this.appletDocModel.get(this.clientId)}),this.observer.trigger("changeDisplay",{cid:this.clientId,flag:e}),_.each(this.components,function(t){var n=this._getComponent(t.cid);n&&n.getView()._valueToggle(e)},this),_.each(this.__multipleViews__,function(t){t._componentElementToggle(e)}),this.__aggrView__&&this.__aggrView__._componentElementToggle(e)},_valueToggle:function(e){e?this._restore():this._backup(),this.observer.trigger("changeValue",{cid:this.clientId,value:this.appletDocModel.get(this.clientId)}),_.each(this.components,function(t){var n=this._getComponent(t.cid);n&&n.getView()._valueToggle(e)},this)},_componentElementToggle:function(e){var t=this.$el.parent(),n=t.is("td");n&&t.toggle(e),this.$el.toggle(e)},_restore:function(){if(this.getViewType()!=="form"||!this.isBackuped)return;this.appletDocModel.set(this.clientId,this.backupData[this.clientId]),console.log("_show("+this.clientId+", "+this.type+"): "+this.appletDocModel.get(this.clientId)+" / "+this.backupData[this.clientId])},_backup:function(){if(this.getViewType()!=="form")return;var e=this.getFormData();this.backupData=e||{},this.appletDocModel.set(this.clientId,null),this.isBackuped=!0,console.log("_hide("+this.clientId+", "+this.type+"): "+this.appletDocModel.get(this.clientId)+" / "+this.backupData[this.clientId])}})});