define("works/views/app/gantt_view/gantt_graph_view",function(require){var e=require("app"),t=require("underscore"),n=require("backbone"),r=require("i18n!nls/commons"),i=require("i18n!calendar/nls/calendar");require("jquery.ganttView");var s=40,o=2;return n.View.extend({initialize:function(e){this.options=e||{},this.appletId=this.options.appletId,this.ganttViewModel=this.options.ganttViewModel,this.ganttTreeNodes=this.options.ganttTreeNodes},render:function(){function o(){if(e.locale!="en"&&e.locale!="vi")return[i["\uc77c"],i["\uc6d4"],i["\ud654"],i["\uc218"],i["\ubaa9"],i["\uae08"],i["\ud1a0"]]}var t=this,n=this._getGraphHeight();$("#gantt_list_config").height(n-s);var r=$("#gantt_graph").empty();this.opts=r.ganttView({data:this._getGanttData(),contentHeight:n,weekday:o()}),this._unbindEvent(),this._bindEvent(),setTimeout(function(){t.showToday()},100)},_unbindEvent:function(){$("#gantt_list_config, #gantt_graph_contents").off("scroll"),$(".ganttview-slide-container").off("scroll"),$(".bookmark").off("click"),$("#gantt_graph_contents .ganttview-block").off("mouseenter")},_bindEvent:function(){this._bindListGraphScrollSyncEvent(),this._bindResizeEvent(),this._bindBookmarkEvent(),this._bindBehaviorEvent()},_bindListGraphScrollSyncEvent:function(){var e;$("#gantt_list_config, #gantt_graph_contents").on("scroll",function t(){clearTimeout(e);var n=$(this),r=$(n.is("#gantt_list_config")?"#gantt_graph_contents":"#gantt_list_config");r.off("scroll").scrollTop(n.scrollTop()),e=setTimeout(function(){r.on("scroll",t)},100)})},_bindResizeEvent:function(){$(window).on("resize.gantt",t.bind(function(){this._setListAndGraphHeight(),$("#side").trigger("resetFilterHeight")},this))},_bindBookmarkEvent:function(){$(".ganttview-slide-container").on("scroll",$.proxy(function(){this.renderBookmarks()},this)),$(".bookmark").on("click",$.proxy(function(e){this._onClickBookmark(e)},this))},renderBookmarks:function(){function r(e,t){return e.offset().left+e.width()<t.offset().left}function i(e,t){return e.offset().left>t.offset().left+t.width()}var e=$(".ganttview-block"),n=$(".ganttview-slide-container");t.each(e,function(e){var t=$(e).parent().find(".bookmark.left"),s=$(e).parent().find(".bookmark.right");r($(e),n)?(t.show(),t.css("margin-left",n.scrollLeft())):t.hide(),i($(e),n)?(s.show(),s.css("margin-left",n.scrollLeft()+n.width()-s.width())):s.hide()})},_bindBehaviorEvent:function(){var e=this,n=this._getResizableDirection();t.extend(this.opts,{behavior:{clickable:!1,resizableDirection:n,resizable:n!="",draggable:n==="e,w",onResize:function(t){return e._updateDocDates(t)},onDrag:function(t){return e._updateDocDates(t)}}}),$("#gantt_graph_contents .ganttview-block").mouseenter(function(){$(this).hasClass("ui-resizable")||$(this).ganttView("applyBehavior",e.opts)})},_onClickBookmark:function(e){var t=$(e.currentTarget),n=t.parent().find(".ganttview-block");this._moveScrollToTarget(n)},_setListAndGraphHeight:function(){var e=this._getGraphHeight();$("#gantt_list_config").height(e-s),$("#gantt_graph_contents").height(e),$(".ganttview-hzheader-days.week .ganttview-hzheader-day").height(e)},_getGraphHeight:function(){var n=window.innerHeight;e.isAdvancedTheme()||(n-=$(".go_header_advanced").outerHeight(!0)),n-=$(".content_top").outerHeight(!0),t.each($(".content_page > div").not(".container_gantt"),function(e){n-=$(e).outerHeight(!0)});var r=$("#gantt_list").find(".tb-header"),i=r&&r.is(":visible");return n-=i?r.height():this.opts.cellHeight*3+o,n-6},_getGanttData:function(){function r(e){if(e=="-")return null;var t=e.split("-");return new Date(t[0],parseInt(t[1])-1,t[2])}var e=[],n=$("#gantt_list_config li.node");return n.length==0?[]:(t.each(n,function(t){var n={type:$(t).attr("data-type"),id:parseInt($(t).attr("data-id")),series:[]},i={};if(n.type!="GROUP"){var s=r($(t).find(".startdate").text()),o=r($(t).find(".enddate").text());n.name=$(t).find(".board_name").text(),i.id=$(t).data("id"),i.name=$(t).find(".board_name").text(),i.start=s>o?null:s,i.end=s>o?null:o,i.user=$(t).find(".user").text(),i.progress=parseInt($(t).find(".progress").text()),i.status_name=$(t).attr("status-name"),i.status_color=$(t).attr("status-color"),i.parent_id=$(t).attr("parent-id"),i.doc_id=$(t).attr("doc-id")}else n.name=$(t).find(".folder_name").text().trim(),i.name=$(t).find(".folder_name").text().trim(),i.start=null,i.end=null;n.series.push(i),e.push(n)}),e)},_getResizableDirection:function(){function t(e){return e!="create_date"&&e!="update_date"}var e=[];return t(this.ganttViewModel.endFieldCid)&&e.push("e"),t(this.ganttViewModel.startFieldCid)&&e.push("w"),e.join(",")},_updateDocDates:function(t){function f(e,t){return e.indexOf("T")>0?[moment(t).format("YYYY-MM-DD"),e.split("T")[1]].join("T"):moment(t).format("YYYYMMDD")}var n=this._getNodeById(this.ganttTreeNodes,t.id),i=n.appletDocModel,s=i.values[this.ganttViewModel.startFieldCid],o=i.values[this.ganttViewModel.endFieldCid],u={};u[this.ganttViewModel.startFieldCid]=f(s,t.start),u[this.ganttViewModel.endFieldCid]=f(o,t.end);var a=$.Deferred();return $.ajax({type:"PUT",dataType:"json",contentType:"application/json",url:e.contextRoot+"api/works/applets/"+this.appletId+"/docs/"+t.doc_id+"/values",data:JSON.stringify({values:u}),success:$.proxy(function(n){a.resolve(),$.goSlideMessage(r["\uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),e.EventEmitter.trigger("ganttTree","refresh:dates",t)},t),error:function(e){a.reject(),$.goError(e.responseJSON.message)}}),a},_getNodeById:function(e,n){var r=this,i;return t.each(e,function(e){if(e.nodeType=="GROUP"){var t=r._getNodeById(e.children,n);if(t)return i=t,!1}else if(e.id==n)return i=e,!1}),i},_indicateToday:function(e){var t=$("<div></div>").addClass("indicator_today").css("left",e[0].offsetLeft);$(".ganttview-slide-container").append(t)},_moveScrollToTarget:function(e){var t=$(".ganttview-slide-container"),n=e.offset().left-t.offset().left+t.scrollLeft();t.scrollLeft(n-t.width()/2)},showToday:function(){var e=$(".ganttview-hzheader-days .today");$(".indicator_today").length==0&&this._indicateToday(e),this._moveScrollToTarget(e)}})});