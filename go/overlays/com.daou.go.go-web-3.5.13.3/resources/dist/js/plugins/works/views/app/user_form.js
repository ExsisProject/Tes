define("works/views/app/user_form",function(require){var e=require("when"),t=require("works/models/applet_form"),n=require("works/models/applet_doc"),r=require("works/components/masking_manager/models/masking"),i=require("works/collections/fields"),s=require("works/models/integration"),o=require("works/views/app/base_applet"),u=require("works/components/formbuilder/formbuilder"),a=require("works/views/app/doc_content_edit"),f=require("hgn!works/templates/app/user_form"),l=require("i18n!nls/commons"),c=require("i18n!works/nls/works"),h=require("works/constants/value_type"),p=require("works/constants/works");require("jquery.go-popup"),require("jquery.go-preloader");var d={confirm:l["\ud655\uc778"],cancel:l["\ucde8\uc18c"],waitingMsg:c["\uc800\uc7a5\uc911 \uba54\uc138\uc9c0"],privateOptionTitle:c["\ube44\uacf5\uac1c\ub85c \ub4f1\ub85d\ud569\ub2c8\ub2e4."],privateOptionDesc:c["\ube44\uacf5\uac1c \uc635\uc158 \uc124\uba85"]},v=!1;return o.extend({appletFormModel:null,appletDocModel:null,canvasView:null,appletId:null,docId:null,events:{"click .btn-confirm":"_saveAndMove","click .btn-cancel":"_cancel","click .btn-golist":"_goToList"},initialize:function(e){e=e||{},o.prototype.initialize.apply(this,arguments),this.appletFormModel=null,this.appletDocModel=null,this.canvasView=null,this.appletId=null,this.docId=null,this.subFormId=null,this.fieldsOfIntegrationApplet={},this.fields=new i([],{appletId:e.appletId,subFormId:e.subFormId,includeProperty:!0}),e.hasOwnProperty("appletId")&&(this.appletId=e.appletId,this.subFormId=e.subFormId,this.appletFormModel=new t({appletId:e.appletId,subFormId:e.subFormId?e.subFormId:0}),this.masking=new r({appletId:this.appletId}),this.masking.fetch());var s={appletId:this.appletId};e.hasOwnProperty("docId")&&(this.docId=e.docId,s.id=this.docId,s.subFormId=this.subFormId),this.appletDocModel=new n(s,{reset:!0}),this.filters.on("changeFilter.filters",this._onChangeFilter,this)},render:function(){return $.when(o.prototype.render.apply(this,arguments),this.appletFormModel.fetch({statusCode:{403:function(){GO.util.error("403",{msgCode:"403-works-accessibleform"})}}}),this.masking.deferred,this.docId?this.appletDocModel.fetch():$.Deferred().resolve(),this.fields.fetch()).then($.proxy(function(){var e=$.Deferred();return this.fields.getFieldsOfIntegrationApplet().done(_.bind(function(t){this.fieldsOfIntegrationApplet=t,e.resolve()},this)),e},this)).then($.proxy(function(){!this.appletDocModel.isCreator(GO.session("id"))&&this.docId&&this.appletFormModel.mergeMaskingValue(this.masking.get("fieldCids"));var e=new a({baseConfigModel:this.baseConfigModel,appletFormModel:this.appletFormModel,appletDocModel:this.appletDocModel,integrationModel:new s(_.extend(this.fieldsOfIntegrationApplet,{fields:this.fields.toJSON()}))});this.$el.html(e.render().el);if(this.docId&&!this.appletDocModel.isNew()){var t=this.baseConfigModel.isPrivateOptionClosed()||!!this.appletDocModel.isPrivate();this.$("#cbx-privateflag").prop("checked",t)}this.canvasView=e},this))},remove:function(){o.prototype.remove.apply(this,arguments),this.canvasView&&this.canvasView.remove()},_initRender:function(){this.$el.html(f({canUsePrivateOption:this.baseConfigModel.canUsePrivateOption(),isPrivateOptionClosed:this.baseConfigModel.isPrivateOptionClosed(),lang:d}))},_saveAndMove:function(e){function s(){var e,t=this.$("input[name=privateFlag]");return t.length>0?e=t.is(":checked"):e=!1,e}var t=this,n=null;if(v){$.goSlideMessage(d.waitingMsg);return}e.preventDefault();var r=u.getFormData(),i=s.call(this);r&&!_.isEmpty(r)&&(this.appletDocModel.setValue(r),_.isNull(this.subFormId)||this.appletDocModel.setSubFormId(this.subFormId),this.appletDocModel.save({privateFlag:i},{beforeSend:function(){n=$.goPreloader(),v=!0},success:function(){t._goToDetailPage()},error:function(e,t){t.responseJSON&&t.responseJSON.code==="403"?$.goError(t.responseJSON.message):$.goSlideMessage(l["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])},complete:function(){n.release(),v=!1}}))},_cancel:function(e){e.preventDefault(),$.goConfirm(l["\ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],c["\ud3b8\uc9d1 \ucde8\uc18c"],_.bind(function(){GO.router.navigate("works/applet/"+this.appletId+"/home/search",{trigger:!0,pushState:!0})},this))},_goToList:function(e){GO.router.navigate("works/applet/"+this.appletId+"/home/search",{trigger:!0,pushState:!0})},_goToDetailPage:function(){_.isNull(this.subFormId)?GO.router.navigate("works/applet/"+this.appletDocModel.get("appletId")+"/doc/"+this.appletDocModel.get("id")+"/navigate",{trigger:!0}):GO.router.navigate("works/applet/"+this.appletDocModel.get("appletId")+"/doc/"+this.appletDocModel.get("id")+"/navigate/"+this.subFormId,{trigger:!0})},_onChangeFilter:function(){GO.router.navigate("works/applet/"+this.appletId+"/home",!0)}})});