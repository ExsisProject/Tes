(function(){define(function(require){var e=require("jquery"),t=require("backbone"),n=require("text!works/search/templates/mobile/search_result.html"),r=require("text!works/search/templates/mobile/search_result_unit.html"),i=require("views/mobile/m_search_common_result"),s=require("works/collections/fields"),o=require("i18n!nls/commons");require("GO.util");var u=null,a={"\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c":o["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"],"\uac80\uc0c9\uacb0\uacfc":o["\uac80\uc0c9\uacb0\uacfc"]},f=t.Collection.extend({url:function(){return"/api/search/works"}}),l=function(e){return _.map(e.docs.content,function(n){var r=_.findWhere(e.appletSummaries,{id:n.appletId}),i=r.thumbSmall||"",o=r.titleCid||"",u=r.fields,a=new s(u),f=a.getColumnFields(),l=n.values[o]||"",c=f.map(function(e){var r=e.getDisplayValue(new t.Model(n),e.get("properties")),i=_.isArray(r)?r.join(", "):r;return e.get("cid")==o&&(l=i),e.get("label")+": "+i});return{id:n.id,appletId:n.appletId,title:l,createdAt:GO.util.basicDate3(n.values.create_date),content:c,creator:n.values.creator?GO.util.userLabel(n.values.creator):"",appletName:r.name,appletIcon:i}},this)},c=t.View.extend({el:"#searchResultWrap",events:{"vclick li[data-id]":"_getContent"},initialize:function(e){var t=this;this.lastPage=!1,this.pageNo=0,this.options=e,this.$el.off(),this.collection=new f,i.set({collection:this.collection,searchOptions:this.options,renderListFunc:function(e){t._renderContents(e)},renderListMoreFunc:function(e){t._moreList(e)}})},render:function(){return i.fetch(),this.el},_renderContents:function(){var t=this,i=this.collection.toJSON()[0],s=l(i);this.$el.html(Hogan.compile(n).render({lang:a,data:s,highlightTitle:function(){return t._highlighting(this.title,t.options.keyword)},highlightContent:function(){return t._highlighting(this.content.join(),t.options.keyword)},highlightAppletName:function(){return t.options.appletName?t._highlighting(this.appletName,t.options.appletName):this.appletName},resultCount:i.docs.pageInfo.total},{partial:r})),e("#detailSearchToggle").removeClass("on"),this._showResultWrap()},_moreList:function(e){var t=this,n=e.toJSON()[0];if(n.docs.content.length==0)return;this.$el.find("ul:first").append(Hogan.compile(r).render({lang:a,data:l(n),highlightTitle:function(){return t._highlighting(this.title.join(),t.options.keyword)},highlightContent:function(){return t._highlighting(this.content.join(),t.options.keyword)},highlightAppletName:function(){return t.options.appletName?t._highlighting(this.appletName,t.options.appletName):this.appletName}}))},_showResultWrap:function(){e("#simpleSearchWrap").hide(),e("#detailSearchWrap").hide(),e("#searchResultWrap").show()},_highlighting:function(e,t){if(_.isUndefined(e)||e==null)return;return e=e.toString(),e.replace(new RegExp(t,"gi"),'<strong class="txt_key">'+t+"</strong>")},_getContent:function(t){var n=e(t.currentTarget),r=n.attr("data-applet-id"),i=n.attr("data-id");GO.router.navigate("works/applet/"+r+"/doc/"+i,!0)}});return{render:function(e){return u=new c(e),u.render()}}})}).call(this);