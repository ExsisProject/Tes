(function(){define(["when","app","underscore","works/views/app/calendar_view/works_calendar","hgn!works/templates/app/calendar_view/event_layer","i18n!nls/commons","i18n!calendar/nls/calendar","i18n!task/nls/task","jquery.go-popup","jquery.works-calbean"],function(e,t,n,r,i,s,o,u){var a="calbeanview",f=[t.constant("works","EVENT_SHOW_CAL"),a].join("."),l=[t.constant("works","EVENT_HIDE_CAL"),a].join("."),c=[t.constant("works","EVENT_CHANGED_COLOR"),a].join("."),h=[t.constant("works","EVENT_SHOW_EVENT"),a].join("."),p=[t.constant("works","EVENT_CREATE_EVENT"),a].join("."),d=["changed:date",a].join("."),v=["changed:time",a].join("."),m=["changed:view-type",a].join("."),g=r.prototype;return r.extend({name:"Works.CalbeanView",type:"calbean",height:0,queryString:"",initialize:function(e){this.options=e||{},g.initialize.call(this,this.options),this.__initRendered__=!1,this.options=n.extend({date:new Date,startday:0,type:"monthly",lang:t.config("locale"),i18n:{"\uc885\uc77c\uc77c\uc815":o["\uc885\uc77c\uc77c\uc815"],"\uc2dc\uac04":o["\uc2dc\uac04"],"\ub2eb\uae30":s["\ub2eb\uae30"],"\uc804\uc0ac\uc77c\uc815":o["\uc804\uc0ac\uc77c\uc815"]},collection:this.eventsPool},n.pick(this.options,"date","startday","type"),{lazy:!0}),this.calbean=this.$el.calbean(this.options)},render:function(e){return this._getCalendarEvents().done($.proxy(function(t){var n=t.merge();this.calbean.render(n,e)},this)).fail($.proxy(function(){this.calbean.render([],e)},this)),this.__initRendered__=!0,this},delegateEvents:function(e){g.delegateEvents.call(this,e),this.undelegateEvents(),this._delegateCustomEvents(),this._delegateCalbeanEvents()},undelegateEvents:function(){g.undelegateEvents.call(this),$(document).off("."+a),this.calbean.off("."+a)},setDodAddable:function(e){this.isDocAddable=e},setFields:function(e){this.fields=e},resize:function(e){return this.calbean.resize(e),this},changeDate:function(e){var n=this;this.options.date=t.util.toMoment(e).toDate(),this._getCalendarEvents().done(function(e){n.calbean.changeDate(n.options.date,e.merge())})},changeType:function(e){this.calbean.changeViewType(e)},_showPeriod:function(e,t){var n=this;this.showPeriod(t).done(function(){n._getCalendarEvents().done(function(e){n.calbean.resetEvents(e.merge())})})},_hidePeriod:function(e,t){var n=this;this.hidePeriod(t).progress(function(){n.calbean.resetEvents(n.eventsPool.merge())})},_changePeriodColor:function(e,t,n){this.calbean.updatePeriodColor(t,n),this.eventsPool.updateCalendar(t,"color",n,{silent:!0})},_getStartDate:function(e){var n=t.util.toMoment(this.options.date);n=e?n.add("months",e):n;var r=n.clone().startOf("months"),i=r.day()-this.options.startday;return r.subtract("days",i<0?7+i:i)},_getEndDate:function(e){var n=t.util.toMoment(this.options.date);n=e?n.add("months",e):n;var r=n.clone().endOf("months"),i=r.day()-this.options.startday;return r.add("days",7-(i<0?7+i:i)-1)},_getBoundaryDate:function(){return{beforeStartDate:this._getStartDate(-1),beforeEndDate:this._getEndDate(-1),afterStartDate:this._getStartDate(1),afterEndDate:this._getEndDate(1)}},_getCalendarEvents:function(){var e=this._getStartDate(),t=this._getEndDate();return this.getCalendarEvents(e,t,!this.__initRendered__,this.queryString)},_delegateCustomEvents:function(){$(document).on(f,$.proxy(this._showPeriod,this)),$(document).on(l,$.proxy(function(e,t){this._hidePeriod(e,t)},this)),$(document).on(c,$.proxy(this._changePeriodColor,this))},_delegateCalbeanEvents:function(){function e(e,r){var i=e.get("startTime");if(!n.isUndefined(i)){var s=t.util.toMoment(i),o=s.format("YYYY-MM-DD"),u=s.format("HH:mm");r.popupEl.find("#startDate").val(o),r.popupEl.find("#startDate").attr("data-prev",o),r.popupEl.find("#startTime").val(u)}var a=e.get("endTime");if(!n.isUndefined(a)){var a=e.get("endTime"),f=t.util.toMoment(a),l=f.format("YYYY-MM-DD"),c=f.format("HH:mm");r.popupEl.find("#endDate").val(l),r.popupEl.find("#endDate").attr("data-prev",l),r.popupEl.find("#endTime").val(c)}}function r(e,t,r){var i=[r.contextRoot,"api/works/applet",r.appletId,"calendarview/event/move?"].join("/")+$.param(n.extend({periodId:e.get("periodId"),docId:e.get("docId")},t));$.ajax({url:i,type:"PUT",contentType:"application/json",dataType:"json",success:function(e){r.eventsPool.updateEvents(e.data.id,t),r.calbean.resetEvents(r.eventsPool.merge())},error:function(e){r.calbean.render(),$.goError(e.responseJSON.message)}})}this.calbean.on(h,$.proxy(function(n,r,o){var a=this.eventsPool.findEvent(r,o),f=a.toJSON();this.popupEl=$.goPopup({header:" ",pclass:"layer_normal layer_calendar_info",width:500,title:"",contents:i({commonLang:s,reverseCautionLang:u["\uc885\ub8cc\uc77c\uc774 \uc2dc\uc791\uc77c\ubcf4\ub2e4 \uc774\uc804\uc77c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],event:f,isReversed:new Date(f.startTime)>new Date(f.endTime),isTimed:f.timeType==="timed"}),buttons:[{btext:s["\uc0c1\uc138"],btype:"confirm",callback:function(e){var n=window.location.protocol+"//"+window.location.host+t.contextRoot+"app/works/applet/"+a.get("appletId")+"/doc/"+a.get("docId")+"/popup";window.open(n,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")}},{btext:s["\ucde8\uc18c"],btype:"cancel"}]}),this.popupEl.addClass("go_renew"),e(a,this)},this)),this.calbean.on(p,$.proxy(function(e,n){if(!this.isDocAddable)return;var r=["works/applet",n,"doc/new"];t.router.navigate(r.join("/"),{trigger:!0,pushState:!0}),e.stopImmediatePropagation()},this)),this.calbean.on(d,$.proxy(function(e,n,i,s){var o=this,u=o.eventsPool.findEvent(i,i+"_"+n),a=t.util.toMoment(u.get("startTime")),f=t.util.toMoment(s+a.format("THH:mm:ssZZ")),l=f.diff(a,"days"),c=t.util.toMoment(u.get("endTime")),h=c.clone().add("days",l),p={startTime:t.util.toISO8601(f),endTime:t.util.toISO8601(h)};r(u,p,o)},this)),this.calbean.on(v,$.proxy(function(e,t,n,i,s){var o=this,u=this.eventsPool.findEvent(n,t),a={startTime:i,endTime:s};r(u,a,o)},this)),this.calbean.on(m,$.proxy(function(e,n,r){t.router.navigate(["calendar",n,r].join("/"),{trigger:!0,pushState:!0}),e.stopImmediatePropagation()},this))}})})}).call(this);