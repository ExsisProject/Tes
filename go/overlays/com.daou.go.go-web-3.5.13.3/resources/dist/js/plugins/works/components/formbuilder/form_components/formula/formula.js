define("works/components/formbuilder/form_components/formula/formula",function(require){function g(e){var t=Array.prototype.slice.call(arguments,1);return function(){var n=function(){},r,i;return n.prototype=e.prototype,r=new n,i=e.apply(r,t),Object(i)===i?i:r}}function y(t,r){function u(t){return e.util.numberWithCommas(t)}var i=t,s=_.extend({},m,r||{});if(!_.isNumber(t)||_.isNaN(t))return t;if(s.dateValueType!=NaN)if(s.expressionType=="time"){if(s.dateValueType==n.TIME)i=o.timeToTimeDisplayText(i);else if(s.dateValueType==n.DATE||s.dateValueType==n.DATETIME)i=o.dateTimeToTimeDisplayText(i)}else if(s.expressionType=="day"){if(s.dateValueType==n.DATE||s.dateValueType==n.DATETIME)i=o.dateTimeToDayDisplayText(i)}else s.thousandComma&&_.isNumber(t)&&!_.isNaN(t)&&(i=u(i));else i=NaN;return i}var e=require("app"),t=require("works/constants/component_type"),n=require("works/constants/value_type"),r=require("works/components/formbuilder/core/form_component"),i=require("works/components/formbuilder/core/component_registry"),s=require("works/components/formbuilder/core/component_manager"),o=require("works/components/formbuilder/form_components/formula/formula_util"),u=require("works/components/formbuilder/core/views/base_form"),a=require("works/components/formbuilder/core/views/base_detail"),f=require("works/components/formbuilder/core/views/base_option"),l=require("hgn!works/components/formbuilder/form_components/formula/form"),c=require("hgn!works/components/formbuilder/form_components/formula/detail"),h=require("hgn!works/components/formbuilder/form_components/formula/option"),p=require("i18n!works/nls/works"),d=require("i18n!nls/commons");require("jquery.go-popup");var v={"\uc774\ub984":d["\uc774\ub984"],"\uc124\uba85":p["\uc124\uba85"],"\uc774\ub984\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694":p["\uc774\ub984\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694."],"\uc124\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694":p["\uc124\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694."],"\ud234\ud301\uc73c\ub85c \ud45c\ud604":p["\ud234\ud301\uc73c\ub85c \ud45c\ud604"],"\uc790\ub3d9 \uacc4\uc0b0":p["\uc790\ub3d9 \uacc4\uc0b0"],"\uc790\ub3d9\uc785\ub825":p["\uc790\ub3d9\uc785\ub825"],"\uc218\uc2dd":p["\uc218\uc2dd"],"\uc785\ub825 \ub108\ube44 \uc870\uc808":p["\uc785\ub825 \ub108\ube44 \uc870\uc808"],"\uc811\uc0ac \ud45c\uae30":p["\uc811\uc0ac \ud45c\uae30"],"\uc811\ub450\uc0ac":p["\uc811\ub450\uc0ac"],"\uc811\ubbf8\uc0ac":p["\uc811\ubbf8\uc0ac"],"\uc18c\uc218\uc810 \uc790\ub9ac \uc218":p["\uc18c\uc218\uc810 \uc790\ub9ac \uc218"],"1,000 \ub2e8\uc704 \uc27c\ud45c \ud45c\uc2dc":p["1,000 \ub2e8\uc704 \uc27c\ud45c \ud45c\uc2dc"],"\uc774\ub984\uc228\uae30\uae30":p["\uc774\ub984\uc228\uae30\uae30"],"\uc218\uc2dd \ud0c0\uc785":p["\uc218\uc2dd \ud0c0\uc785"],"\uc218\uc2dd \ud0c0\uc785\uc744 \uc120\ud0dd\ud558\uc138\uc694":p["\uc218\uc2dd \ud0c0\uc785\uc744 \uc120\ud0dd\ud558\uc138\uc694"],"\uc22b\uc790 \uacc4\uc0b0":p["\uc22b\uc790 \uacc4\uc0b0"],"\uc77c \uacc4\uc0b0":p["\uc77c \uacc4\uc0b0"],"\uc2dc\uac04 \uacc4\uc0b0":p["\uc2dc\uac04 \uacc4\uc0b0"],"\uc77c":p["\uc77c"],"\uc2dc\uac04":p["\uc2dc\uac04"],"\ubd84":p["\ubd84"],"\uc218\uc2dd \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0":p["\uc218\uc2dd \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0"]},m={thousandComma:!0,width:250,widthUnit:"px",fixType:"postfix",decimalPoints:2,expressionType:"number",expression:""},b={_isPrefix:function(){return this.model.get("fixType")==="prefix"},_isDayOrTimeExpType:function(){return this.model.get("expressionType")=="day"||this.model.get("expressionType")=="time"},_convertDisplayText:function(e){return y(e,this.model.toJSON())}},w=f.extend(_.extend({},{customEvents:{"blur input[name=expression]":"_validateExpression","change select[name=expressionType]":"_updateSelectExpressionType"},renderBody:function(){this.$el.html(h({lang:v,model:this.model.toJSON(),isPrefix:this._isPrefix(),isDayOrTime:this._isDayOrTimeExpType()}))},_updateSelectExpressionType:function(e){var t=$(e.currentTarget);"day"==t.val()||"time"==t.val()?(this.$el.find("li[name=decimalPoints]").hide(),this.$el.find("li[name=thousandComma]").hide()):(this.$el.find("li[name=decimalPoints]").show(),this.$el.find("li[name=thousandComma]").show())},_validateExpression:function(e){var t=$(e.currentTarget),n=t.val();if(this._testInvalidPattern(n)||this._testBanPettern(n))$.goSlideMessage(v["\uc218\uc2dd \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0"]),this.model.set("expression",m.expression),t.val(m.expression)},_testInvalidPattern:function(e){var t=/[^a-zA-Z0-9_\s\.\+\*\-\%\/\(\)]/gi;return t.test(e)},_testBanPettern:function(e){var t=/alert\(|setInterval\(|setTimeout\(|\$\.|_\.|GO\./gi;return t.test(e)},_isPrefix:function(){},_convertDisplayText:function(){}},b)),E=u.extend(_.extend({},{__listening__:{},initialize:function(){u.prototype.initialize.apply(this,arguments),this.__listening__={}},render:function(){var t=this.appletDocModel.get(this.getCid()),n=this._getExpressionLabel(),r=v["\uc790\ub3d9\uc785\ub825"]+(n?"("+n+")":"");this.$body.html(l({clientId:this.clientId,model:this.model.toJSON(),label:e.util.escapeHtml(this.model.get("label")),sourceData:t,displayText:this._convertDisplayText(t),isPrefix:this._isPrefix(),title:r,placeholder:r})),this._listenToFormulaSource(),this.appletDocModel.isNew()&&this._setContent(),this.resizeWidth(this.model.get("width"),this.model.get("widthUnit"))},remove:function(){u.prototype.remove.apply(this,arguments)},getFormData:function(){var e={};return e[this.getCid()]=this._gerSourceData(),e},resizeWidth:function(e,t){this._getInputElement().outerWidth(e+t)},_getExpressionLabel:function(){var e=this._getFormulaSourceAndFormulaComponents(),t=this.model.get("expression"),n=o.getExpressionCodes(t);return _.each(e,function(e){var r=e.properties,i=r.code?r.code.replace(/ /gi,""):r.code;i!=""&&_.indexOf(n,i)>-1&&(t=t.replace(i,r.label))}),t},_getInputElement:function(){return this.$el.find('input[name="'+this.clientId+'"]')},_listenToFormulaSource:function(){_.each(this._getFormulaSourceAndFormulaComponentCids(),function(e){this.appletDocModel.on("change:"+e,$.proxy(function(){this._setContent()},this)),this.__listening__[e]=e},this)},_getFormulaSourceAndFormulaComponents:function(){var e=s.getComponentsByType(t.Formula),n=s.getComponentsByType(t.Date),r=s.getComponentsByType(t.Time),i=s.getComponentsByType(t.Datetime),o=s.getComponentsByType(t.Number);return _.union(o,n,r,i,e)},_getFormulaSourceAndFormulaComponentCids:function(){var e=[];return _.each(this._getFormulaSourceAndFormulaComponents(),function(t){e.push(t.getCid())}),e},_setPlaceholderText:function(){var e=this._getExpressionLabel(),t=v["\uc790\ub3d9\uc785\ub825"]+(e?"("+e+")":"");this._getInputElement().attr("placeholder",t),this._getInputElement().attr("title",t)},_setContent:function(){try{var t=this._getNumberFormulaFunc(),r=this._getInputElement(),i,s=this.model.get("expressionType");this.model.get("dateValueType")==n.TIME?(t=this._getNumberFormulaFunc(),i=t.apply(null,this._convertNumberValueList()),this.model.get("decimalPoints")):"day"==s||"time"==s?(t=this._getDateTypesFormulaFunc(),i=t.apply(null,this._convertNumberValueList()),this.model.get("decimalPoints")):(t=this._getNumberFormulaFunc(),i=e.util.fixFloatingPoint(t.apply(null,this._convertNumberValueList()),this.model.get("decimalPoints")));var o="";this.appletDocModel.set(this.clientId,i),_.isNumber(i)&&!_.isNaN(i)?(o=this._convertDisplayText(i),o===""&&this._setPlaceholderText()):(i=null,this._setPlaceholderText()),r.val(o),r.attr("data-source",i)}catch(u){}},_gerSourceData:function(){var e=this._getInputElement();return parseFloat(e.attr("data-source"))},_getNumberFormulaFunc:function(){var e=this._convertNumberVarList(),t=this.model.get("expression"),n="return "+(t?t:"void(0)")+";",r;e.unshift(Function),e.push(n);try{return r=g.apply(undefined,e),r()}catch(i){return function(){}}},_getDateTypesFormulaFunc:function(){var e=this._convertNumberVarList(),t=this.model.get("expression"),n="return "+(t?t:"void(0)")+";",r;e.unshift(Function),e.push(n);try{return r=g.apply(undefined,e),r()}catch(i){return function(){}}},_converDateToNumberExpression:function(e){e=e.replace(/ /gi,"");var t=e.split(/\-|\+|\(|\)|\{|\}|\[|\]/g);return _.each(t,function(t){var n=parseInt(t);if(_.isNumber(n)&&!_.isNaN(n)){var r=n*1e3*60;e=e.replace(t,r)}}),e},_convertNumberVarList:function(){var e=[];return _.each(this.__listening__,function(t,n){var r=s.getComponent(n);if(r){var i=r.getComponentPropertyModel(),o=i.get("code");o&&o.length>0&&e.push(o)}}),e},_convertNumberValueList:function(){var e=[];return _.each(this.__listening__,function(t){var r=s.getInstance(this.viewType),i=r.getComponent(t),o=r.getComponent(this.clientId),u=this.appletDocModel.get(t),a;if(n.DATE==i.getValueType())if(_.isString(u)&&u.length>0){var f=new Date(u.substring(0,4),u.substring(4,6)-1,u.substring(6,8));a=parseInt(f.getTime())}else a=NaN;else if(n.TIME==i.getValueType())u&&u.length>0?a=this._strTimeToNumMinute(u):a=parseInt(u);else if(n.DATETIME==i.getValueType())if(_.isString(u)&&u.length>0){var f=new Date(u);a=parseInt(f.getTime())}else moment.isMoment(u)?a=parseInt(u.toDate().getTime()):a=NaN;else{var l=i.getView(),c=parseFloat(this.appletDocModel.get(t));a=l.isMultiple()?l.getAggrValue():i.properties.dataType=="PERCENT"?c/100:c}_.isNumber(a)||(a=null),e.push(a)},this),e},_strTimeToNumMinute:function(e){try{var t=e.split(":"),n=parseInt(t[0])*60+parseInt(t[1]);return n}catch(r){return NaN}},_removeComma:function(e){return parseFloat((e||"").replace(/,/gi,""))},_isPrefix:function(){},_convertDisplayText:function(){}},b)),S=a.extend(_.extend({},{render:function(){var t=this._convertDisplayText(this.appletDocModel.get(this.getCid()));this.$body.html(c({model:this.model.toJSON(),label:e.util.escapeHtml(this.model.get("label")),isPrefix:this._isPrefix(),userData:t}))},getTitle:function(){return this._convertDisplayText(this.appletDocModel.get(this.getCid()))},_isPrefix:function(){},_convertDisplayText:function(){}},b)),x=r.define(t.Formula,{name:v["\uc790\ub3d9 \uacc4\uc0b0"],valueType:n.NUMBER,group:"extra",properties:{label:{defaultValue:v["\uc790\ub3d9 \uacc4\uc0b0"]},hideLabel:{defaultValue:!1},guide:{defaultValue:""},guideAsTooltip:{defaultValue:!0},expressionType:{defaultValue:m.expressionType},expression:{defaultValue:m.expression},dateValueType:{defaultValue:""},width:{defaultValue:m.width},widthUnit:{defaultValue:m.widthUnit},unitText:{defaultValue:""},fixType:{defaultValue:m.fixType},decimalPoints:{defaultValue:m.decimalPoints},thousandComma:{defaultValue:m.thousandComma}},OptionView:w,FormView:E,DetailView:S});i.addComponent(x)});