(function(){define(["jquery","underscore","backbone","works/collections/works_events_pool","jquery.go-preloader"],function(e,t,n,r){var i=new r,s=new r,o=new r;return n.View.extend({tagName:"div",id:"calendar-viewport",eventsPool:i,beforePool:s,afterPool:o,initialize:function(e){this.options=e||{},this.appletId=this.options.appletId,this._setAppletIdToPools(),this._registCalViewRef()},_setAppletIdToPools:function(){this.eventsPool.setAppletId(this.appletId),this.beforePool.setAppletId(this.appletId),this.afterPool.setAppletId(this.appletId)},_setFieldToPools:function(e){this.eventsPool.setFields(e),this.beforePool.setFields(e),this.afterPool.setFields(e)},_registCalViewRef:function(){var e="GO_ref_calendar_view";if(!this.name)throw new Error("name \uc18d\uc131\uc774 \ud544\uc694\ud569\ub2c8\ub2e4.");window[e]||(window[e]=this),window[e].name!==this.name&&(window[e].release(),window[e]=this)},release:function(){this.undelegateEvents(),this.remove()},addPeriod:function(e){return this.beforePool.add(e),this.eventsPool.add(e),this.afterPool.add(e),this},clearPeriods:function(){return this.beforePool.clear(),this.eventsPool.clear(),this.afterPool.clear(),this},showPeriod:function(n){var r=e.Deferred(),i=t.isArray(n)?n:[n],s=!1;return t.each(i,function(e,t){this.eventsPool.contains(e)?this.eventsPool.show(e):(this.eventsPool.isCached=!1,this.eventsPool.add(e),this.beforePool.add(e),this.afterPool.add(e),s=!0)},this),s&&r.notify(),r.resolve(),r},hidePeriod:function(n){var r=e.Deferred(),i=t.isArray(n)?n:[n],s=!1;return t.each(i,function(e,t){this.eventsPool.contains(e)&&(this.eventsPool.remove(e),this.beforePool.remove(e),this.afterPool.remove(e),s=!0)},this),s&&r.notify(this),r.resolve(this),r},getCalendarEvents:function(t,n,r,i){var s=this._isContained(t,n),o=this._getBoundaryDate(),u=e.Deferred();this._setFieldToPools(this.fields);if(s&&this.eventsPool.isCached&&!r)u.resolve(this.eventsPool);else if(this.eventsPool.isCached&&!r){var a=this._makeNewPool();this._outOfBoundary(t,n)?this._renewalPools(t,n,i):this._isMoveForward(t)?(this.afterPool=this.eventsPool,this.eventsPool=this.beforePool,this.beforePool=a,this.beforePool.setBoundaryTime(o.beforeStartDate,o.beforeEndDate),this.beforePool.fetch(i)):(this.beforePool=this.eventsPool,this.eventsPool=this.afterPool,this.afterPool=a,this.afterPool.setBoundaryTime(o.afterStartDate,o.afterEndDate),this.afterPool.fetch(i)),this.eventsPool.isFetching?(GO.util.preloader(this.eventsPool.fetching),this.eventsPool.fetching.done(e.proxy(function(){u.resolve(this.eventsPool)},this))):u.resolve(this.eventsPool)}else this.beforePool.setBoundaryTime(o.beforeStartDate,o.beforeEndDate),this.afterPool.setBoundaryTime(o.afterStartDate,o.afterEndDate),this.eventsPool.setBoundaryTime(t,n),u=this.eventsPool.fetch(i),this.beforePool.fetch(i),this.afterPool.fetch(i),GO.util.preloader(u);return u},_makeNewPool:function(){var e=new r;return e.setAppletId(this.appletId),e.setFields(this.fields),t.each(this.eventsPool.getCollections(),function(t){e.add(t.periodId)}),e},_outOfBoundary:function(e,t){var n=moment(this.beforePool.timeMin),r=moment(this.afterPool.timeMax);return e.isBefore(n)||t.isAfter(r)},_renewalPools:function(e,t,n){this.beforePool.setBoundaryTime(e.clone().add("months",-1),t.clone().add("months",-1)),this.eventsPool.setBoundaryTime(e,t),this.afterPool.setBoundaryTime(e.clone().add("months",1),t.clone().add("months",1)),this.beforePool.fetch(n),this.eventsPool.fetch(n),this.afterPool.fetch(n)},_isMoveForward:function(e){var t=moment(this.eventsPool.timeMin);return e-t<=0},_isContained:function(e,t){if(!this.eventsPool.timeMin||!this.eventsPool.timeMax)return!1;var n=moment(this.eventsPool.timeMin),r=moment(this.eventsPool.timeMax);return e-n>=0&&t-r<=0}})})}).call(this);