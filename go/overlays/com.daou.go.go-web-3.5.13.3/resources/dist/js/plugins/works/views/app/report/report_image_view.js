define("works/views/app/report/report_image_view",function(require){var e=require("i18n!works/nls/works");return Backbone.View.extend({initialize:function(e){this.rid=e.rid,this.appletId=e.appletId,this.reportId=e.reportId,this.attachId=e.attachId,this.settings=e.settings,this.attach=e.attach,this.isUpload=!1,this.filePath,this.fileName,this.fileInputKey="#file"+this.rid,this.imgKey="#img"+this.rid,this.imageKey="#image"+this.rid,this.point={curX:0,curY:0}},render:function(){return this._initImageView(),this.attach&&(this.saveImageAttach(this.attach),this._initImageView(),this._renderImage()),this},_initImageView:function(){var t;if(this._hasImage()){var n=this._makeImageUrl(),r=this._calculateWidth(),i=this._calculateHeight();t=Hogan.compile(['<span class="item_image" id="image'+this.rid+'">'+'<span class="thumb">'+'<input type="file" id="file'+this.rid+'" accept="image/*" style="display: none;">'+'<img id="img'+this.rid+'" src="'+n+'" height="'+i+'" width="'+r+'">'+'</span><span class="btn_wrap"></span></span>'].join(""))}else t=Hogan.compile(['<div class="widget_nulldata" id="image'+this.rid+'">'+'<div class="nulldata">'+'  <div class="img"><span class="icx2 ic_box_nulldata"></span></div>'+'<input type="file" id="file'+this.rid+'" accept="image/*" style="display: none;">'+'  <p class="nulldata_tit">'+e["\uc774\ubbf8\uc9c0\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]+'</p><p class="nulldata_txt">'+e["\ub354\ube14\ud074\ub9ad\ud558\uc5ec \uc774\ubbf8\uc9c0\ub97c \ucd94\uac00\ud574\uc8fc\uc138\uc694"]+"</p>"+"</div>"+"</div>"].join(""));this.$el.addClass("item_image"),this.$el.empty(),this.$el.append(t.render()),this._hasImage()&&this._updateStyle(),this._createEvent()},_calculateHeight:function(){return!this.attachId||"EXPANSION"==this.settings.viewType?"100%":this.settings.height>=this.settings.width?"100%":""},_calculateWidth:function(){return!this.attachId||"EXPANSION"==this.settings.viewType?"100%":this.settings.width>=this.settings.height?"100%":""},_createEvent:function(){this._registerImageChangeEvent(),this._registerViewClick()},_registerImageChangeEvent:function(){var t=this;$(this.fileInputKey).on("change",function(n){if(n.target.files.length==0)return;var r=n.target.files[0],i=r.type;if(!_.startsWith(i,"image")){$.goError(e["\uc774\ubbf8\uc9c0 \ud30c\uc77c\ub9cc \uc5c5\ub85c\ub4dc \uac00\ub2a5\ud569\ub2c8\ub2e4"]);return}t.saveImageAttach(r),t._initImageView(),t._renderImage()})},_registerViewClick:function(){var e=this;$(this.imageKey).closest("div").on("dblclick",function(){var t=$(".card_edit").attr("item-rid");e.rid==t&&$(e.fileInputKey).click()})},_hasImage:function(){return this.attach||this.attachId},_makeImageUrl:function(){if(!this.attachId)return"";var e="api/works/applet/"+this.appletId+"/report/"+this.reportId+"/download/"+this.attachId;return GO.contextRoot+e},getFilePath:function(){if(this.filePath)return this.filePath},getFileName:function(){if(this.attach)return this.attach.name;if(this.fileName)return this.fileName},getImageData:function(){if(this.attach)return this.attach},getSettings:function(){return{viewType:this.settings.viewType,existBorder:this.settings.existBorder,height:this.settings.height,width:this.settings.width}},saveImageAttach:function(e){var t=this,n=new FormData;this.attach=e,n.append("file",this.attach),n.append("GOSSOcookie",$.cookie("GOSSOcookie")),$.ajax({url:GO.contextRoot+"api/file",type:"POST",contentType:!1,processData:!1,data:n,success:function(e){var n=typeof e=="string"?JSON.parse(e):e.data;t.isUpload=!0,t.attachId=null,t.filePath=n.filePath}})},updateSettings:function(e){this.settings.viewType=e.viewType,$(this.imgKey).attr("height",""),$(this.imgKey).attr("width",""),e.attach?(this.saveImageAttach(e.attach),this._initImageView(),this._renderImage()):this._updateStyle()},_updateStyle:function(){"EXPANSION"==this.settings.viewType?($(this.imageKey).closest("div").css("display","block"),$(this.imageKey).css("display","inline"),$(this.imageKey).css("vertical-align",""),$(this.imgKey).attr("height","100%"),$(this.imgKey).attr("width","100%")):this.settings.height>=this.settings.width?($(this.imgKey).attr("height","100%"),$(this.imageKey).closest("div").css("display","block"),$(this.imageKey).css("display",""),$(this.imageKey).css("vertical-align","")):this.settings.width>this.settings.height&&($(this.imgKey).attr("width","100%"),$(this.imageKey).closest("div").css("display","table"),$(this.imageKey).css("display","table-cell"),$(this.imageKey).css("vertical-align","middle"));var e=this.settings.existBorder==0?"1px solid #fff":"1px solid #ddd";$("div[item-rid="+this.rid+"] .grid-stack-item-content").css("border",e)},_renderImage:function(){if(!this.attach)return;$(this.imgKey).attr("height",""),$(this.imgKey).attr("width","");var e=new FileReader,t=this;e.onload=function(){var n=new Image;n.onload=function(){$(t.imgKey).attr("src",e.result),t.settings.height=this.height,t.settings.width=this.width,t._updateStyle()},n.src=e.result},e.readAsDataURL(this.attach)}})});