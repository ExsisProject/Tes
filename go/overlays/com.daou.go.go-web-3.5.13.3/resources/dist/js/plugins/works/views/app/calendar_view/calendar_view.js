define("works/views/app/calendar_view/calendar_view",function(require){function w(n){var r=e.session("id")+"-works-"+n,i={viewtype:{storetype:"local","default":"monthly"},basedate:{storetype:"session","default":e.util.toMoment(new Date).format("YYYY-MM-DD")},selectedperiod:{storetype:"local","default":""}},s={};return t.each(i,function(t,n){var i=r+"-calendar-"+n,o=e.util.store,u=o.get(i);u?s[n]=u:(o.set(i,t["default"],{type:t.storetype}),s[n]=t["default"])}),s}var e=require("app"),t=require("underscore"),n=require("when"),r=require("i18n!calendar/nls/calendar"),i=require("i18n!works/nls/works"),s=require("i18n!nls/commons"),o=require("works/libs/util"),u=require("hgn!works/templates/app/calendar_view/calendar_view"),a=require("hgn!works/components/filter/templates/filter"),f=require("works/views/app/base_applet"),l=require("works/views/app/calendar_view/works_calbean"),c=require("calendar/views/color_picker"),h=require("works/views/app/calendar_view/period_editor_popup"),p=require("works/components/filter/views/filter"),d=require("components/backdrop/backdrop"),v=require("works/collections/periods"),m=require("works/collections/fields"),g=e.constant("works","EVENT_CHANGE_CAL_TYPE"),y=moment().lang(e.config("locale")),b={tab_daily:r["\uc77c\uac04"],tab_weekly:r["\uc8fc\uac04"],tab_monthly:r["\uc6d4\uac04"],date_str:y.format(r["YYYY\ub144 MM\uc6d4"]),today:r["\uc624\ub298"],using_period:i["\uc0ac\uc6a9\uc911\uc778 \ud56d\ubaa9"],view_setting:i["\ubcf4\uae30\uc124\uc815"],color_config:s["\uc0c9\uc0c1 \ubcc0\uacbd"],text_prev:s["\uc774\uc804"],text_next:s["\ub2e4\uc74c"],text_all:s["\uc804\uccb4"]};return f.extend({tagName:"div",className:"content_page",calendarView:null,height:0,initialize:function(n){e.util.store.set("applet-viewtype","calendar",{type:"session"}),f.prototype.initialize.apply(this,arguments),this.height=0,this.options=n||{},this.appletId=this.options.appletId,this._setFilterOptions(),this.periodCollection=new v({appletId:this.appletId}),this.periodCollection.fetch({async:!1}),this.periodIds=this.periodCollection.getIds(),this.periods=this.periodCollection.toJSON();var r=o.getSavedSelectedPeriod(this.appletId);this.checkedPeriodIds=!t.isUndefined(r)&&r.length>0?r.split(",").map(Number):[];if(this.checkedPeriodIds.length==0||t.difference(this.checkedPeriodIds,this.periodIds).length>0)this.checkedPeriodIds=this.periodIds,o.saveCheckedPeriod(this.appletId,this.periodIds);this.datastore=w(this.appletId),this.options=t.defaults(this.options,{type:this.datastore.viewtype,date:e.util.toMoment(this.datastore.basedate).toDate(),periods:this.datastore.selectedperiod,startday:0}),this.calendarView=new l(this.options)},_setFilterOptions:function(){this.useCachedCondition=this.options.useCachedCondition,this._fieldSynced=$.Deferred(),this.useCachedCondition||e.util.store.set(e.session("id")+"-"+this.appletId+"-searchObject",{},{type:"session"}),this.fields=new m([],{appletId:this.appletId,type:"accessible",includeProperty:!0,includeDocNoAndProcess:!0}),this.fields.on("sync",this._onSyncFields,this),this.$el.on("changeFilter",t.bind(function(){e.router.navigate("works/applet/"+this.appletId+"/home/search",{replace:!0})},this))},unbindEvent:function(){this.$el.off("click",".tool_bar #using_period"),this.$el.off("click",".tool_bar #view_setting_btn"),this.$el.off("click",".layer_viewsetting input[name='period_id']"),this.$el.off("click",".layer_viewsetting input#check_all"),this.$el.off("click",".layer_viewsetting span.chip"),this.$el.find(".chip").off("changed:period-color"),this.$el.off("click",".tab_nav > li"),this.$el.off("click",".current_date .prev-btn"),this.$el.off("click",".current_date .next-btn"),this.$el.off("click",".current_date .datepicker-btn"),this.$el.off("click",".current_date .today-btn"),this.getTabElement().off(g),this.$el.off("searchByFilter")},bindEvent:function(){this.$el.on("click",".tool_bar #using_period",$.proxy(this._showUsingPeriod,this)),this.$el.on("click",".tool_bar #view_setting_btn",$.proxy(this._showViewSetting,this)),this.$el.on("click",".layer_viewsetting input[name='period_id']",$.proxy(this._changeViewSetting,this)),this.$el.on("click",".layer_viewsetting input#check_all",$.proxy(this._checkAll,this)),this.$el.on("click",".layer_viewsetting span.chip",$.proxy(this._toggleColorPicker,this)),this.$el.on("changed:chip-color.works",".chip",$.proxy(this._bindChangedPeriodColor,this)),this.$el.on("click",".tab_nav > li",$.proxy(this._changeCalendarType,this)),this.$el.on("click",".current_date .prev-btn",$.proxy(this._goToPrev,this)),this.$el.on("click",".current_date .next-btn",$.proxy(this._goToNext,this)),this.$el.on("click",".current_date .datepicker-btn",$.proxy(this._goToDate,this)),this.$el.on("click",".current_date .today-btn",$.proxy(this._goToToday,this)),this._bindTabEvent(),this.$el.on("searchByFilter",$.proxy(function(e,t){this._search(t)},this))},render:function(){$.when(f.prototype.render.apply(this,arguments),this.accessibleForms.length>0?this.fields.fetch():this._renderNoExistForm(this.$el)).then($.proxy(function(){if(this.accessibleForms.length<1)return;return this.calendarView.setFields(this.fields),this.calendarView.setDodAddable(this.share.get("docAddible")),this.isAdmin=this.baseConfigModel.isAdmin(e.session("id")),this.$el.empty().append(u({lang:b,isPeriodEmpty:this._isPeriodEmpty(),isAdmin:this.isAdmin,periods:this.periods})),this.setDateIndicator(),$.datepicker.setDefaults($.datepicker.regional[e.config("locale")]),this.unbindEvent(),this.bindEvent(),this._renderFilterView(),this._adjustCssClass(),this._initTab(),this._initDatepicker(),this._initViewSetting(),this._isPeriodEmpty()&&this.isAdmin&&this._showPeriodEditorPopup(!0),this.el},this))},_renderFilterView:function(){var e=new p({fields:this.fields,appletId:this.appletId,filters:this.filters,isAdmin:this.isAdmin,useDocNo:this.baseConfigModel.attributes.useDocNo,refLink:this.options.refLink,template:a,templateParam:{hideListSetting:!0},useCachedCondition:this.useCachedCondition});this.$el.prepend(e.el),e.render()},_adjustCssClass:function(){var e=this.layoutView.getContentElement();e.removeClass("build_situation"),e.addClass("go_works_situation"),e.addClass("go_attend_situation")},_initTab:function(){return this.getTabElement().find('li[data-type="'+this.options.type+'"]').addClass("on"),this},getTabElement:function(){return this.$el.find(".tab_nav")},_initDatepicker:function(){var e=this;this.$el.find("#calendarDatepicker").datepicker({changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(t){e._changeDate(t)}}),this.$el.find("#calendarDatepicker").datepicker("setDate",this.options.date)},_initViewSetting:function(){var e=this,n=0;this.checkedPeriodIds.forEach(function(r){var i=e.$el.find(".layer_viewsetting input#period_id_"+r);t.isUndefined(i)||(i.prop("checked",!0),n++)}),this.$el.find(".layer_viewsetting input[name='period_id']").length==n&&this.$el.find(".layer_viewsetting input[name='check_all']").prop("checked",!0)},_isPeriodEmpty:function(){return this.options.periods==""},_search:function(e){this.calendarView.queryString=e.queryString,this.calendarView.__initRendered__=!1,n.all([this._fieldSynced]).then($.proxy(function(){this.calendarView.render({height:this.getHeight(),clearOld:!0}),this.$el.append(this.calendarView.el)},this))},_onSyncFields:function(){this._fieldSynced.resolve()},_storeConditions:function(t,n){var r=e.util.store.get(e.session("id")+"-"+this.appletId+"-searchObject")||{};r.filter=n,e.util.store.set(e.session("id")+"-"+this.appletId+"-searchObject",r,{type:"session"})},_bindTabEvent:function(){var e=this.getTabElement();return $(this.getTabElement()).find("li").each(function(t,n){$(e).on(g,function(e,t){$(n).attr("data-type")===t?$(n).addClass("on"):$(n).removeClass("on")})}),this},resize:function(e){typeof e!="undefined"&&this.setHeight(e),this.$el.height(this.height),this.calendarView.resize(this.height)},setHeight:function(e){var t=24;this.height=e-this.getToolbarView().outerHeight()+t},getHeight:function(){return this.height},setDateFields:function(){this.dateFields=t.filter(this.fields.toJSON(),function(e){return e.valueType=="DATE"||e.valueType=="DATETIME"})},_showPeriodEditorPopup:function(e){var t=this;this.dateFields||this.setDateFields(),this.periodEditorPopupView=new h({appletId:this.appletId,periods:this.periods,dateFields:this.dateFields}),this.periodEditorPopupView.render();var n=[];n.push({btext:i["\uc785\ub825\ud654\uba74 \uad00\ub9ac\ub85c \uc774\ub3d9\ud558\uae30"],autoclose:!1,callback:$.proxy(this._goToSettingsUserform,this)}),n.push({btext:s["\uc644\ub8cc"],autoclose:!1,btype:"confirm",callback:$.proxy(t._savePeriods,t)}),n.push({btext:s["\ucde8\uc18c"],callback:$.proxy(e?this._goToListView:"",this)}),$.goPopup({header:i["\uce98\ub9b0\ub354 \ubdf0 \ud56d\ubaa9 \uc120\ud0dd"],title:'<p class="desc">'+i["\uce98\ub9b0\ub354 \ubdf0 \ud56d\ubaa9 \uc120\ud0dd \uc124\uba85"]+"</p>",modal:!0,pclass:"layer_calendar_check layer_normal",width:500,closeCallback:$.proxy(e?this._goToListView:"",this),contents:t.periodEditorPopupView.$el,buttons:n})},_goToListView:function(){e.router.navigate("/works/applet/"+this.appletId+"/home",!0)},_goToSettingsUserform:function(){var t=this;$.goConfirm(i["\uc785\ub825\ud654\uba74 \uad00\ub9ac \ud654\uba74\uc73c\ub85c \uc774\ub3d9"],i["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc740 \uc800\uc7a5\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4. \uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],function(){e.router.navigate("/works/applet/"+t.appletId+"/settings/userform",!0)})},_showUsingPeriod:function(){this._showPeriodEditorPopup()},_savePeriods:function(){this.periodEditorPopupView.savePeriods(this.appletId)},_showViewSetting:function(e){this._bindBackdrop(this.$el.find(".layer_viewsetting"),$(e.currentTarget))},_changeViewSetting:function(e){var n=$(e.currentTarget).val(),r=$(e.currentTarget).prop("checked"),i=this.$el.find(".layer_viewsetting input[name='period_id']:checked"),s=this.$el.find(".layer_viewsetting input#check_all");i.length===0||!r?s.prop("checked",!1):i.length===this.periodIds.length&&s.prop("checked",!0),this.checkedPeriodIds=t.map(i,function(e){return $(e).val()}),o.saveCheckedPeriod(this.appletId,this.checkedPeriodIds),$(document).trigger(r?"show:period":"hide:period",[n])},_bindBackdrop:function(e,t){var n=new d;return n.backdropToggleEl=e,n.linkBackdrop(t),n},_checkAll:function(e){var t=$(e.currentTarget).prop("checked");this.$el.find(".layer_viewsetting input[name='period_id']").prop("checked",t),this.checkedPeriodIds=t?this.periodIds:[],o.saveCheckedPeriod(this.appletId,this.checkedPeriodIds),$(document).trigger(t?"show:period":"hide:period",[this.periodIds])},_toggleColorPicker:function(e){c.show(e.target,"works","left")},_bindChangedPeriodColor:function(t,n){var r=this,i=t.target,o=$(t.currentTarget).closest("div").find("input[name='period_id']").val();$.ajax({type:"PUT",dataType:"json",contentType:"application/json",url:e.config("contextRoot")+"api/works/applet/"+r.appletId+"/period/"+o+"/color/"+n,success:function(e){r._resetPeriodColor(i,n),$(document).trigger("changed:period-color",[o,n])},error:function(e){var t=e.responseJSON.message;$.goSlideMessage(t!=null?t:s["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."],"caution")}})},_resetPeriodColor:function(e,t){return $(e).attr("class",""),$(e).addClass("chip"),$(e).addClass("bgcolor"+t),this},_changeCalendarType:function(t){var n=$(t.currentTarget).is("span")?$(t.currentTarget).parent():$(t.currentTarget),r=n.attr("data-type")||"monthly",i=o.getDateForUrl(r,this.options.date),s=["works/applet",this.appletId,"calendar",r,i].join("/");return this.setCalendarType(r),this.setDateIndicator(),this.getTabElement().trigger(g,[r]),e.router.navigate(s,{trigger:!1,pushState:!0}),this},setCalendarType:function(e){return this.options.type=e,o.saveCalendarType(this.appletId,e),this.resetCalendarView(),this},resetCalendarView:function(){return this.calendarView.changeType(this.getCalendarType()),this},_goToPrev:function(){return this._goToOffset(-1),this},_goToNext:function(){return this._goToOffset(1),this},_goToOffset:function(t){var n={monthly:"months",weekly:"weeks",daily:"days"}[this.getCalendarType()],r=e.util.toMoment(this.options.date).clone().add(n,t);return this._changeDate(r),this},_goToDate:function(){this.$el.find("#calendarDatepicker").trigger("focus")},_goToToday:function(){return this._changeDate(),this},_changeDate:function(t){var n=this.options.type,r=this.options.date=e.util.toMoment(t||new Date).toDate();e.EventEmitter.trigger("common","layout:setOverlay",""),this.calendarView.changeDate(r),o.saveBasedate(r),this.setDateIndicator();var i=["works/applet",this.appletId,"calendar",n,o.getDateForUrl(n,this.options.date)].join("/");return e.router.navigate(i,{trigger:!1,pushState:!0}),e.EventEmitter.trigger("common","layout:clearOverlay",!0),this},setDateIndicator:function(){var t="YYYY.MM.DD",n=e.util.toMoment(this.options.date),r=n.format(t),i=n.format("YYYY.MM"),s=e.util.toMoment(e.util.getStartDateOfWeek(n,this.options.startday)),o=e.util.toMoment(e.util.getEndDateOfWeek(n,this.options.startday)),u={monthly:i,weekly:[s.format(t),o.format(t)].join(" ~ "),daily:r}[this.getCalendarType()];return this.getToolbarView().find("#date-indicator").empty().html(u),this},getCalendarType:function(){return this.options.type},getToolbarView:function(){return this.$el.find(".tool_bar")},getCheckedPeriodIds:function(){return this.checkedPeriodIds},addPeriods:function(){var e=Array.prototype.slice.call(arguments);return t.each(e,function(e){this.calendarView.addPeriod(parseInt(e))},this),this},clearPeriods:function(){this.calendarView.clearPeriods()}})});