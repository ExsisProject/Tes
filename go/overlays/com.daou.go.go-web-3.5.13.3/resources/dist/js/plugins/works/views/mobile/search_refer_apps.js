define("works/views/mobile/search_refer_apps",function(require){var e=require("backbone"),t=require("works/collections/docs"),n=require("works/collections/fields"),r=require("works/components/list_manager/models/list_setting"),i=require("works/models/applet_form"),s=require("works/components/doc_list/views/doc_list"),o=require("works/components/add_viewer/views/add_viewer"),u=require("i18n!nls/commons"),a=require("i18n!works/nls/works"),f={"\uac80\uc0c9":u["\uac80\uc0c9"],"\ub370\uc774\ud130 \uac80\uc0c9":a["\ub370\uc774\ud130 \uac80\uc0c9"]},l=require("hgn!works/templates/mobile/search_refer_apps"),c=require("hgn!works/templates/mobile/cell_of_doclist"),h='<li class="creat data_null"><span class="subject"><span class="txt">'+a["\ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+"</span>"+"</span>"+"</li>";return e.View.extend({id:"search_refer_app_view",attributes:{"data-role":"layer",style:"background:#fff; position:absolute; width:100%; min-height:100%; top:0; left:0; z-index:999; margin-top:54px"},events:{"click input[type='checkbox']":"_docListCellInputBoxClicked","vclick a[data-btn='ok']":"_saveButtonClicked","vclick a[data-btn='cancel']":"_backButtonClicked","vclick a[id='more_button']":"_docsMoreButtonClicked","vclick a[id='btnSearch']":"_searchButtonClicked","keyup #searchKeyword":"_searchKeyUp","vclick a[id='btnSearchReset']":"_searchResetButtonClicked"},appletId:null,referAppletId:null,referModel:null,referDocs:null,referDocsAddType:null,fields:null,selectedDocs:null,optionsForReferModel:null,callbackAddDoc:null,callbackCancel:null,selectedModels:null,addViewer:null,initialize:function(e){var s=e||{};s.hasOwnProperty("referModel")&&(this.referModel=s.referModel,this.referAppletId=s.referModel.attributes.integrationAppletId),s.hasOwnProperty("appletId")&&(this.appletId=s.appletId),s.hasOwnProperty("callbackAddDoc")&&(this.callbackAddDoc=s.callbackAddDoc),s.hasOwnProperty("callbackCancel")&&(this.callbackCancel=s.callbackCancel),s.hasOwnProperty("selectedDocs")&&(this.selectedDocs=s.selectedDocs),this.selectedModels={},this.fieldsOfIntegrationApplet={},this.optionsForReferModel={title:a["\ub370\uc774\ud130 \uac80\uc0c9"],offset:100,btn_ok:u["\ud655\uc778"],btn_cancel:u["\ucde8\uc18c"],btn_more:u["\ub354\ubcf4\uae30"],search_result:u["\uac80\uc0c9\uacb0\uacfc"],search_result_null:u["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"],type:s.type||{},isSingleSelect:s.isSingleSelect||!1},this.setting=new r({},{appletId:this.referAppletId}),this.fields=new n([],{appletId:this.referAppletId,includeProperty:!0,type:"consumers"}),this.appletForm=new i({appletId:this.appletId}),this.referDocs=new t([],{type:"producerDocs",appletId:this.appletId,referAppletId:this.referAppletId,fieldCid:this.referModel.get("integrationFieldCid")}),this.referDocsAddType=new t([],{type:"producerDocs",appletId:this.appletId,referAppletId:this.referAppletId,fieldCid:this.referModel.get("integrationFieldCid")}),this.listenTo(this.referDocsAddType,"sync",this._setAddDocsInList)},render:function(){this.$el.html(l(this.optionsForReferModel)),$.when(this.referDocs.fetch(),this.fields.fetch(),this.setting.fetch(),this.appletForm.fetch()).then($.proxy(function(){return this._fetchIntegrationDatas()},this)).then(_.bind(function(){(this.referDocs===undefined||this.referDocs.length<1)&&this.$el.find("#docListElements").append(h),this._setDocsInList(this.referDocs);var e=this;this.addViewer=new o({removeCallBack:function(t){console.log("_removeCallBackFromAddViewer"+t);var n=$("#docListElements").find("input");_.each(n,function(n){var r=parseInt($(n).val());if(r===t){var i=e._getDoc(r);$(n).attr("checked",!1),delete e.selectedModels[i.id]}}),e.selectedDocs=$.grep(e.selectedDocs,function(e){return e.id!==t})}}),this.$el.find("#addViewer").append(this.addViewer.render().el),_.each(this.selectedDocs,function(t){e.addViewer.add({id:t.id,name:t.name})})},this))},_fetchIntegrationDatas:function(){var e=$.Deferred();return this.fields.getFieldsOfIntegrationApplet().done(_.bind(function(t){this.fieldsOfIntegrationApplet=t,e.resolve()},this)),e},_setDocsInList:function(e){e!==undefined&&e.pageInfo().next?this.$("#more_button").show():this.$("#more_button").hide();var t=this._convertDocListFormatting(e);this.$("#docListElements").empty(),_.each(t,function(e){e.selected&&(this.selectedModels[e.id.toString()]=this._getDoc(e.id)),this.$("#docListElements").append(c({lang:f,doc:e}))},this)},_setSearchDocsInList:function(e){if(e.length===0){this.$el.find("#docListElements").append(h),this.$("#more_button").hide();return}this._setDocsInList(e)},_setAddDocsInList:function(e){if(e.pageNo===0&&e.getKeyword()!==""){this.referDocs.reset(),this.referDocs.add(e.toJSON()),this._setSearchDocsInList(e);return}this.referDocs.length===0?(this.referDocs.reset(),this.referDocs.add(e.toJSON())):(_.each(e.models,function(e){this.referDocs.models.push(e)},this),this.referDocs.length+=e.length),this._setDocsInList(e)},_convertDocListFormatting:function(e){var t=_.clone(e),r=this.referModel.get("integrationFieldCid"),i=new n(this.referModel.get("selectedDisplayFields"));return this.columnFields=this.fields.filter(function(e){return i.findWhere({cid:e.get("cid")})},this),_.map(t.models,function(e){var t="-",n=_.map(this.columnFields,function(n){var i=n.get("columnName")||n.get("label"),s=n.get("cid"),o=this.getColumnData(e,n,!1,!0);return s===r&&(t=o),{visible:!0,label:i,data:o}},this),i=!1;return _.each(this.selectedDocs,function(t){t.id===e.id&&(i=!0)}),{id:e.id,selected:i,columns:n,titleText:t}},this)},_gatColumnClass:function(e,t){return t?"tit_word_break":e.isMultiValueType()?"item_wrap":e.isNumberValueType()?"amount":""},_searchInputTmpl:function(){return Hogan.compile(['<input type="text" id="searchKeyword" class="txt" />','<span class="btn_minor_s" id="searchBtn">','<span class="txt">{{lang.\uac80\uc0c9}}</span>',"</span>"].join("")).render({lang:f})},_saveButtonClicked:function(e){e&&$(e.currentTarget).blur().trigger("focusout"),this.callbackAddDoc(_.values(this.selectedModels)),this._backButtonClicked()},_backButtonClicked:function(e){var t=this;setTimeout(function(){return typeof t.options.backCallback=="function"&&t.options.backCallback(),t.callbackCancel(),t.remove(),e&&e.stopImmediatePropagation(),!1},500)},_docListCellInputBoxClicked:function(e){var t=$(e.currentTarget),n=t.parent().find("span.subject").text(),r=t.val(),i=this._getDoc(r);if(_.isNull(i))return alert(a["\uc720\ud6a8\ud558\uc9c0 \uc54a\uc740 \uc5f0\ub3d9\ubb38\uc11c \uc54c\ub9bc"]),!1;if(t.is(":checked")){var s=this.selectedDocs.length+1>parseInt(this.referModel.get("maxCount"));if(s)return alert(a["\ucd5c\ub300 \uc120\ud0dd \uac1c\uc218\ub97c \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4."]),!1;this.selectedModels[i.id.toString()]=i;var o={id:i.id,name:n,text:n};this.selectedDocs.push(o),this.addViewer.add({id:r,name:n}),this.selectedDocs.length>0&&this.$el.find("#addViewer").show()}else delete this.selectedModels[i.id.toString()],this.addViewer.remove({id:r}),this.selectedDocs=_.filter(this.selectedDocs,function(e){return e.id!==i.id}),this.selectedDocs.length<=0&&this.$el.find("#addViewer").hide()},_getDoc:function(e){var t=null;return _.each(this.referDocs.toJSON(),function(n){n.id==e&&(t=n)}),t},_docsMoreButtonClicked:function(){this.referDocsAddType.pageNo=this.referDocsAddType.pageNo+1,this.referDocsAddType.fetch()},_searchButtonClicked:function(){this.referDocs.pageNo=0,this.referDocs.length=0,this.referDocsAddType.pageNo=0;var e=new n(this.columnFields),t=e.getLinkableTextFields();this.referDocsAddType.queryString=t.map(function(e){return e.get("cid")+':"'+this.$("#searchKeyword").val()+'"'},this).join(" OR "),this.referDocsAddType.fetch()},_searchResetButtonClicked:function(){$("#searchKeyword").val("")},_getUserLabel:function(e){var t=e.position?" "+e.position:"";return e.name+t},_searchKeyUp:function(e){return e.keyCode===13&&this._searchButtonClicked(),!1},getColumnData:s.prototype.getColumnData,getProperties:s.prototype.getProperties})});