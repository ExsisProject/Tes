define("works/components/filter/views/filter_integration",function(require){var e=require("works/constants/condition_type"),t=require("works/components/integration_manager/models/integration"),n=require("works/collections/docs"),r=require("works/collections/fields"),i=require("go-nametags"),s=require("works/components/applet_doc_search/views/applet_doc_search"),o=require("hgn!works/components/filter/templates/filter_integration"),u=require("i18n!works/nls/works"),a=require("i18n!nls/commons"),f={"\uc0ad\uc81c":a["\uc0ad\uc81c"],"\uac80\uc0c9":a["\uac80\uc0c9"],"\ud14d\uc2a4\ud2b8 \uac80\uc0c9":u["\ud14d\uc2a4\ud2b8 \uac80\uc0c9"],"\ub370\uc774\ud130 \uac80\uc0c9":u["\ub370\uc774\ud130 \uac80\uc0c9"]};return Backbone.View.extend({popupView:null,fieldsFetched:null,events:{"change input[type='radio']":"_onChangeRadio","click #appletDocSearch":"_onClickSearch"},initialize:function(e){e=e||{},this.fields=e.fields,this.appletId=e.fields.appletId,this.backupModel=this.model.clone(),this.fieldsFetched=$.Deferred(),this.searchText="",this.listItems=[],this._initSelectData(),this._initIntegrationAppletInfo(this.fields.toJSON()),this.model.get("integrationAppletId")?(this.integrationFields=new r([],{appletId:this.model.get("integrationAppletId"),includeProperty:!0,type:"consumers"}),this.integrationFields.fetch().done($.proxy(function(){this.fieldsFetched.resolve()},this))):this.fieldsFetched.resolve();var i=_.find(this.model.get("selectedDisplayFields"),function(e){return e.cid===this.model.get("integrationFieldCid")},this),s=i?i.valueType:"";this.docs=new n([],{type:"producerDocs",appletId:this.appletId,referAppletId:this.model.get("integrationAppletId"),fieldCid:this.model.get("integrationFieldCid"),fieldValueType:s}),this.integration=new t({appletId:this.appletId}),this.integration.fetch()},render:function(){return this.$el.html(o({lang:f,cid:this.cid,searchText:this.searchText})),this._toggleView(this._getTypeByModel()),this.docTagView=i.create([],{useAddButton:!1,stopPropagation:!0}),_.each(this.listItems,function(e){this._addNameTag(e)},this),this.docTagView.$el.on("nametag:removed",_.bind(this._onNameTagRemoved,this)),this.$("#tagArea").html(this.docTagView.el),$.when(this.integration.deferred,this.fieldsFetched).done($.proxy(function(){this._renderAppletDocSearch()},this)),this},resetView:function(){this.model=this.backupModel,this._initSelectData(),this._toggleView(this._getTypeByModel()),this.$("#textValue").val("")},setModel:function(){var t={id:e.SELECT,text:e.TEXT}[this._getTypeByView()];this.model.set("conditionType",t),this.searchText=this._getSearchKeyword(),this._getTypeByView()==="text"?this.model.set("values",{text:this.searchText}):this.model.set("values",{values:this.listItems})},getPopupEl:function(){return this.popupView},_renderAppletDocSearch:function(){this.appletDocSearchView=new s({model:this.model,docs:this.docs,fieldsOfIntegrationApp:this.integrationFields,integration:this.integration,useToolbar:!1}),this.$("#listArea").html(this.appletDocSearchView.render().el),this.appletDocSearchView.$el.on("onClickListItem",$.proxy(function(e,t){this._addDoc(t)&&this.$el.trigger("onClickListItem",t)},this))},_initSelectData:function(){var e=this.model.get("values").values;e?this.listItems=e:this.searchText=this.model.get("values").text},_initIntegrationAppletInfo:function(e){_.each(e,function(e){this.model.get("fieldCid")===e.cid&&e.properties&&(this.model.set("integrationAppletId",e.properties.integrationAppletId),this.model.set("integrationFieldCid",e.properties.integrationFieldCid),this.model.set("selectedDisplayFields",e.properties.selectedDisplayFields))},this)},_toggleView:function(e){var t={id:"_activateIntegration",text:"_activateText"}[e];this[t]()},_getSearchKeyword:function(){return this._getTypeByView()==="text"?this.$("#textValue").val():_.map(this.listItems,function(e){return e.text}).join(",")},_activateText:function(){this.$("#textFormAbstract"+this.cid).attr("checked",!0),this.$('[data-type="id"]').hide(),this.model.set("conditionType",e.TEXT)},_activateIntegration:function(){this.$("#listFormRelative"+this.cid).attr("checked",!0),this.$('[data-type="id"]').show(),this.model.set("conditionType",e.SELECT)},_onClickSearch:function(){this.appletDocSearchView.search(this.$("#textValue").val())},_onChangeRadio:function(e){var t=$(e.currentTarget).val();this._toggleView(t),this.$("#textValue").val("")},_onNameTagRemoved:function(){this.listItems=this.docTagView.getNameTagList()},_addDoc:function(e){var t=this.docTagView.getNameTag(e.id).length;if(t){$.goMessage(a["\uc774\ubbf8 \ucd94\uac00\ub418\uc5b4 \uc788\uc2b5\ub2c8\ub2e4."]);return}var n=e.values[this.model.get("integrationFieldCid")],r={id:e.id,text:_.isArray()?_.map(n,function(e){return e.text}):n};return this._addNameTag(r),this.listItems.push(r),!0},_addNameTag:function(e){this.docTagView.addTag(e.id,e.text,{attrs:{id:e.id,text:e.text},removable:!0})},_getTypeByView:function(){return this.$('input[type="radio"]:checked').val()},_getTypeByModel:function(){return _.isEmpty(this.model.get("values"))?"text":_.has(this.model.get("values"),"text")?"text":"id"}})});