define("works/views/mobile/user_form",function(require){var e=require("works/views/app/base_applet"),t=require("when"),n=require("works/models/applet_baseconfig"),r=require("works/models/applet_form"),i=require("works/models/applet_doc"),s=require("works/components/masking_manager/models/masking"),o=require("works/collections/fields"),u=require("works/models/integration"),a=require("views/mobile/header_toolbar"),f=require("works/components/formbuilder/formbuilder"),l=require("hgn!works/templates/mobile/user_form"),c=require("i18n!nls/commons"),h=require("i18n!works/nls/works"),p=require("works/constants/value_type"),d=require("works/constants/works");require("jquery.go-preloader");var v={confirm:c["\ud655\uc778"],cancel:c["\ucde8\uc18c"],waitingMsg:h["\uc800\uc7a5\uc911 \uba54\uc138\uc9c0"],privateOptionTitle:h["\ube44\uacf5\uac1c\ub85c \ub4f1\ub85d\ud569\ub2c8\ub2e4."]},m=!1;return e.extend({el:"#content",appletFormModel:null,appletDocModel:null,canvasView:null,appletId:null,docId:null,subFormId:null,initialize:function(e){e=e||{},this.appletId=null,this.baseConfigModel=null,this.pageName=null,this.appletFormModel=null,this.appletDocModel=null,this.canvasView=null,this.docId=null,this.subFormId=null,this.fieldsOfIntegrationApplet={},this.fields=new o([],{appletId:e.appletId,subFormId:e.subFormId,includeProperty:!0}),e.hasOwnProperty("appletId")&&(this.appletId=e.appletId,this.subFormId=e.subFormId,this.baseConfigModel=new n({id:e.appletId}),this.appletFormModel=new r({appletId:e.appletId,subFormId:e.subFormId?e.subFormId:0}),this.masking=new s({appletId:this.appletId}),this.masking.fetch());var t={appletId:this.appletId};e.hasOwnProperty("docId")&&(this.docId=e.docId,t.id=this.docId,t.subFormId=this.subFormId),this.appletDocModel=new i(t),GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","works-save",this._worksSave,this)},render:function(){var e=this,t=this.appletFormModel,n=null;if(m){alert(v.waitingMsg);return}n=$.goPreloader(),m=!0,a.render({title:this.docId?c["\uc218\uc815"]:c["\ub4f1\ub85d"],isClose:!0,actionMenu:[{id:"works-save",text:c["\uc800\uc7a5"],triggerFunc:"works-save"}]}),$.when(e.baseConfigModel.fetch(),e.masking.deferred,e.docId?e.appletDocModel.fetch():$.Deferred().resolve(),e.fields.fetch()).then($.proxy(function(){var e=$.Deferred();return this.fields.getFieldsOfIntegrationApplet().done(_.bind(function(t){this.fieldsOfIntegrationApplet=t,e.resolve()},this)),e},this)).then(function(){return e.appletFormModel.fetch({statusCode:{403:function(){GO.util.linkToCustomError({code:403,message:h["\ud3fc \uc811\uadfc\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+" "+h["\ud3fc \uc811\uadfc\uad8c\ud55c \uc5c6\uc74c \uc124\uba85"]})}}})}).then(function(){e._initRender();var t=$.Deferred();return!e.appletDocModel.isCreator(GO.session("id"))&&e.docId&&e.appletFormModel.mergeMaskingValue(e.masking.get("fieldCids")),t.resolve(),t}).then(function(){e.appletDocModel.isNew()||(e.appletDocModel.isPrivate()?e.$("#privateFlag").prop("checked",!0):e.$("#privateFlag").prop("checked",!1));var r=f.createUserComponent(t.toJSON(),e.appletDocModel,{type:"form"},new u(_.extend(e.fieldsOfIntegrationApplet,{fields:e.fields.toJSON()})));e.canvasView=r.getFormView(),e.canvasView.setElement(e.$("#fb-canvas")),e.canvasView.renderNode(),r.trigger(),n.release(),m=!1})},remove:function(){this.canvasView&&this.canvasView.remove()},_initRender:function(){this.$el.html(l({lang:v,canUsePrivateOption:this.baseConfigModel.canUsePrivateOption(),isPrivateOptionClosed:this.baseConfigModel.isPrivateOptionClosed(),formName:this.appletFormModel.get("name"),mainForm:this.appletFormModel.get("mainForm")}))},_worksSave:function(){var e=this;$(document.activeElement).blur(),setTimeout(function(){e._saveAndMove()},100)},_saveAndMove:function(){function i(){var e,t=this.$("input[name=privateFlag]");return t.length>0?e=t.is(":checked"):e=!1,e}var e=this,t=null;if(m){alert(v.waitingMsg);return}var n=f.getFormData(),r=i.call(this);typeof n=="object"&&_.isEmpty(n)&&(alert(h["\ub4f1\ub85d\ud560 \ub0b4\uc6a9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4. \ubaa9\ub85d\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4."]),GO.router.navigate("works/applet/"+this.appletDocModel.get("appletId")+"/home",{trigger:!0,replace:!0})),n&&!_.isEmpty(n)&&(this.appletDocModel.setValue(n),_.isNull(this.subFormId)||this.appletDocModel.setSubFormId(this.subFormId),this.appletDocModel.save({privateFlag:r},{beforeSend:function(){t=$.goPreloader(),m=!0},success:function(){e._goToDetailPage()},complete:function(){t.release(),m=!1}}))},_cancel:function(e){e.preventDefault(),this._goToDetailPage()},_goToDetailPage:function(){_.isNull(this.subFormId)?GO.router.navigate("works/applet/"+this.appletDocModel.get("appletId")+"/doc/"+this.appletDocModel.get("id"),{trigger:!0,replace:!0}):GO.router.navigate("works/applet/"+this.appletDocModel.get("appletId")+"/doc/"+this.appletDocModel.get("id")+"/"+this.subFormId,{trigger:!0,replace:!0})},_onSyncAppletDoc:function(){this.canvasView.renderNode()}})});