define("works/views/mobile/doc_detail/doc_activity_form",function(require){var e=require("backbone"),t=require("hogan"),n=require("app"),r=require("works/models/applet_activity"),i=require("views/mobile/header_toolbar"),s=require("hgn!works/templates/mobile/doc_detail/doc_activity_form"),o=require("i18n!nls/commons"),u=require("i18n!works/nls/works"),a=require("components/go-fileuploader/mobile");require("jquery.go-preloader");var f=!1,l=t.compile('<li data-path="{{path}}" data-name="{{name}}" data-id="{{id}}"><span class="item_image"><span class="thumb"><img src="{{thumbSmall}}" alt="{{name}}"></span><span class="img_tit">{{name}}</span><span class="txt"> ({{fileSizeStr}})</span><a class="iscroll-tap-highlight"><span class="btn_wrap" data-btntype="attachDelete"><span class="ic ic_del"></span></span></a></span></li>'),c=t.compile('<li data-path="{{attach.path}}" data-name="{{attach.name}}" data-id="{{attach.id}}"><span class="item_file"><span class="ic_file {{style}}"></span><span class="name">{{attach.name}}</span><span class="size"> ({{attach.fileSizeStr}})</span><span class="optional" data-btntype="attachDelete"><a class="wrap_ic_file"><span class="txt ic ic_file_del"></span></a></span></span></li>'),h=e.View.extend({el:"#content",events:{"keyup textarea":"_expandTextarea","vclick span[data-btntype='attachDelete']":"deleteAttach"},initialize:function(e){this.activity=new r(this.options),this.activity.id&&this.activity.fetch({async:!1}),this.$el.off(),GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","activity-save",this.submit,this)},render:function(){i.render({isClose:!0,title:this.activity.get("id")?u["\ud65c\ub3d9\uae30\ub85d \uc218\uc815"]:u["\ud65c\ub3d9\uae30\ub85d \ub4f1\ub85d"],actionMenu:[{id:"activity-save",text:o["\ub4f1\ub85d"],triggerFunc:"activity-save"}]}),this.$el.html(s({activity:this.activity.toJSON(),hasAttach:this.activity.hasAttach(),content:GO.util.br2nl(GO.util.unescapeHtml(this.activity.get("content"))),isMobileApp:GO.config("isMobileApp"),"isAndroidApp?":GO.util.isAndroidApp(),"isOsAndroid?":GO.util.checkOS()=="android"?!0:!1})),this.renderAttach(),this.attachFileUploader()},attachFileUploader:function(){var e={};e.success=$.proxy(function(e){var t="",n="";GO.util.fileUploadErrorCheck(e)&&(t="<strong class='caution'>"+GO.util.serverMessage(e)+"</strong>",n="attachError");var r=typeof e=="string"?JSON.parse(e):e.data;this.$("#attachWrap").show();if($("div.option_display").data("attachable")==="false")return;try{this.attachValidate(r)}catch(i){i.message==="overMaxAttachNumber"&&$("div.option_display").data("attachable","false");return}this.addAttachEl(this.attachParser(r),t,n),$("span[data-btntype=attachDelete]").on("vclick",$.proxy(this.deleteAttach,this))},this),e.error=function(){alert(o["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},e.androidCallFile=$.proxy(function(){this.callFile()},this),a.bind(this.$el.find("#go-fileuploader"),e)},deleteAttach:function(e){return this.$el.find("div.option_display").data("attachable","true"),$(e.currentTarget).closest("li").remove(),!1},attachValidate:function(e){var t=null,r=GO.util.getFileNameAndTypeData(e);GO.config("allowedFileUploadSize")&&(t=GO.config("allowedFileUploadSize")/1024/1024);try{$.goValidation.attachValidate("#attachPart ul li",r,t),GO.session().brandName=="DO_SAAS"&&a.attachFileValidateBySaaS(r.size)}catch(i){var s=i.message;if(s=="AttachSizeException")GO.util.delayAlert(n.i18n(o["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",t));else{if(s=="AttachNumberExceptionBySaaS")throw GO.util.delayAlert(n.i18n(o["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",GO.config("commonAttachConfig").maxAttachNumber)),new Error("overMaxAttachNumber");s=="NotFoundExtException"&&GO.util.delayAlert(o["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},submit:function(){var e=GO.util.escapeHtml(this.$el.find("textarea").val());if(_.isEmpty(e)){alert(GO.i18n(o["{{portlet_title}}\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],"portlet_title",o["\ub0b4\uc6a9"]));return}if(f){alert(u["\uc800\uc7a5\uc911 \uba54\uc138\uc9c0"]);return}f=!0,preloader=$.goPreloader(),this.activity.set({writer:_.pick(GO.session(),"id","name","email","position","thumbnail"),content:e,attaches:a.getAttachInfo("#attachWrap")}),this.activity.save({},{success:function(e){f=!1,history.back()},complete:function(){preloader.release()}})},renderAttach:function(){_.each(this.activity.get("attaches"),function(e){this.addAttachEl(e,"","")},this)},addAttachEl:function(e,t,n){var r=e.extention;e.fileSizeStr=GO.util.getHumanizedFileSize(e.size),GO.util.isImage(r)?$("#imageWrap").append(l.render(e)):$("#fileWrap").append(c.render({attach:e,style:GO.util.getFileIconStyle(e)}))},attachParser:function(e){return{extention:e.fileExt,name:e.fileName,path:e.filePath,size:e.fileSize,thumbSmall:e.thumbnail}},callFile:function(){var e=GO.config("commonAttachConfig").maxAttachSize,t=GO.config("commonAttachConfig").maxAttachNumber,n="";if(!this.fileUploadCountValidate())return!1;t-=this.$("#attachWrap li").size(),GO.util.callFile(e,t,n)},fileUploadCountValidate:function(){var e=$("#attachWrap li").size(),t=GO.config("commonAttachConfig").maxAttachNumber;return e>=t?(alert(n.i18n(o["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",t)),!1):!0},_expandTextarea:function(e){GO.util.textAreaExpand(e)}});return h});