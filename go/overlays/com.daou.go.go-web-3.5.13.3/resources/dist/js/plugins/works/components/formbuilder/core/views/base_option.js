define("works/components/formbuilder/core/views/base_option",function(require){var e=require("hogan"),t=require("works/components/formbuilder/core/component_manager"),n=require("works/components/formbuilder/core/views/base_component"),r=require("calendar/views/color_picker"),i=require("works/collections/fields"),s=require("works/components/filter/collections/filter_conditions"),o=require("works/components/filter/models/filter_condition"),u=require("works/components/filter/views/filter"),a=require("hgn!works/templates/app/_filter_manager"),f=require("works/constants/component_type"),l=require("works/constants/design_component_type"),c=require("i18n!nls/commons"),h=require("i18n!works/nls/works"),p=require("i18n!task/nls/task"),d={"\ucf54\ub4dc":h["\ucf54\ub4dc"],"\ucf54\ub4dc \uc124\uba85":h["\ucf54\ub4dc \uc124\uba85"],"\ucf54\ub4dc \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0":h["\ucf54\ub4dc \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0"],"\ucf54\ub4dc \uac80\uc99d\uc624\ub958 \uc790\ub3d9\uc0dd\uc131 \uc54c\ub9bc":h["\ucf54\ub4dc \uac80\uc99d\uc624\ub958 \uc790\ub3d9\uc0dd\uc131 \uc54c\ub9bc"],"\ub0a0\uc9dc\uc218\uc2dd \uc5f0\uc0b0\uc790 \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0":h["\ub0a0\uc9dc\uc218\uc2dd \uc5f0\uc0b0\uc790 \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0"],"\uc774\ub984":c["\uc774\ub984"],"\uac15\uc870":p["\uac15\uc870"]},v=e.compile(["<li>",'<div><label for="">{{lang.\ucf54\ub4dc}}</label></div>','<div><input type="text" name="code" value="{{code}}" class="txt_mini tool_txt" title="{{lang.\ucf54\ub4dc}}" {{#disabled}}disabled="disabled"{{/disabled}}></div>',"<p> * {{lang.\ucf54\ub4dc \uc124\uba85}}</p>","</li>"].join("")),m=e.compile(["<li>","<div>",'<span class="txt">',"\ub178\ucd9c \uc870\uac74 \uc124\uc815","</span>",'<span class="edit_title_sub" id="addRule">','<i class="ic_works ic_add"></i>',"\uc124\uc815","</span>","</div>",'<div class="wrap_name_tag link_exposure">','<ul class="name_tag" data-el-conditions></ul>',"</div>",'<div class="wrap_input_sub" data-el-not style="display: none;">','<input type="checkbox" class="tool_chk" name="" id="not">','<label for="not">',"NOT(\uc704 \uc870\uac74\uc774 \uc544\ub2cc \uacbd\uc6b0 \ub178\ucd9c)","</label>","</div>","</li>"].join("\n")),g=e.compile(["<li>{{lang.subformOptionDesc}}</li>"].join("\n")),y="0";return n.extend({clientId:null,tagName:"ul",events:function(){return _.extend({},{"blur input[name=label]":"_checkLabel","blur input[name=code]":"_checkCode","keyup input[type=text]:not(.has-custom-event)":"_updateText","focusout input[type=text]:not(.has-custom-event)":"_updateText","click input[type=checkbox]:not(.has-custom-event)":"_updateCheckbox","click input[type=radio]:not(.has-custom-event)":"_updateRadio","click #addRule":"_onClickAddRule","click #not":"_onClickNot","change select:not(.has-custom-event)":"_updateSelect","click [data-color-picker]":"_onClickColorPicker"},_.result(this,"customEvents")||{})},initialize:function(e){e=e||{},this.clientId=e.clientId,this.subFormId=e.subFormId,this.$el.addClass("form-component-option")},render:function(){this._getListenableFields(),this._getUserFields(),this._initConditions();var e=_.contains(l.DESIGN_TYPE,this.options.type),t=GO.util.isInvalidValue(this.subFormId);t?(this.renderBody(),this._renderNameColorPallet(),this._selectOptions(),this._renderRules(),this._isUsingCodeTypes()&&this._renderCode()):e?this.renderBody():(this.$el.empty(),this.$el.append(g.render({lang:{subformOptionDesc:h["\ud558\uc704\ud3fc \uc18d\uc131\ubcc0\uacbd \ubd88\uac00 \uacbd\uace0"]}})))},_renderNameColorPallet:function(){var e=this.$("label:contains("+d["\uc774\ub984"]+")"),t=_.find(e,function(e){return $(e).text()===d["\uc774\ub984"]}),n=this.model.get("color")||y;$(t).after('<span class="optional"><span class="on normalmode chip bgcolor'+n+'" data-color-picker>'+"</span>")},_onClickColorPicker:function(e){this.colorPicker||(this.colorPicker=new r({useAddition:!0,useAdditionInput:!0,additionText:d["\uac15\uc870"]}),this.colorPicker.on("changed:chip-color",_.bind(this._onChangeChipColor,this)),this.colorPicker.on("changed:addition-checkbox",_.bind(this._onChangeBold,this))),this.colorPicker.show(e,"works")},_onChangeBold:function(e){this.model.set("bold",e)},_onChangeChipColor:function(e){this.model.set("color",e),this.$("[data-color-picker]").removeClass(function(e,t){return(t.match(/(^|\s)bgcolor\S+/g)||[]).join(" ")}).addClass("bgcolor"+e)},_getFields:function(){return new i(t.getFields(),{appletId:this.options.appletId})},_getListenableFields:function(){var e=this._getFields();return this.listenableFields=this._getFields(),this.listenableFields.reset(e.getListenableFields().toJSON()),this.listenableFields.deferred.resolve(),this.listenableFields},_getUserFields:function(){var e=this._getFields();return this.userFields=e.getUserFields(),this.userFields.deferred.resolve(),this.userFields},renderBody:function(){},validate:function(){},_updateText:function(e){var t=$(e.currentTarget),n=t.attr("name"),r=t.val(),i=this.model.get(n);this.model.set(n,r),n=="expression"?_.contains(["day","time"],this.model.get("expressionType"))&&_.contains(["*","/","%"],e.key)?(this._initInputText(t,n,i),$.goSlideMessage(d["\ub0a0\uc9dc\uc218\uc2dd \uc5f0\uc0b0\uc790 \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0"])):t.val()!=""&&this._onFormulaPropertiesUpdate():_.contains(["label","guide","defaultValue","unitText"],n)&&this._bracketValidation(t,n,i)},_initInputText:function(e,t,n){e.val(n),this.model.set(t,n)},_bracketValidation:function(e,t,n){var r=/^\[([\s]*[\d\.\+\-]+)+(.)*\]$/g;r.test($.trim(e.val()))&&(this._initInputText(e,t,n),$.goSlideMessage(h["\ub300\uad04\ud638 \uc785\ub825\ud3ec\ub9f7 \uc624\ub958 \uc124\uba85"]))},_updateRadio:function(e){var t=$(e.currentTarget);t.is(":checked")&&this.model.set(t.attr("name"),t.val())},_updateSelect:function(e){var t=$(e.currentTarget);this.model.set(t.attr("name"),t.val())},_updateCheckbox:function(e){var t=$(e.currentTarget),n=t.attr("name"),r=this.model.get(n);_.isUndefined(r)&&(t.attr("data-default")==="true"&&(r=!0),t.attr("data-default")==="false"&&(r=!1)),_.isBoolean(r)?this.model.set(n,t.is(":checked")):_.isArray(r)?this.model.set(n,r.push(t.val())):this.model.set(n,[t.val()])},_onFormulaPropertiesUpdate:function(){var e=this.model.get("expression"),t=this._getComponentsByDateTypesAndFormulaType(),n=[];_.each(t,function(t){var r=t.getComponentPropertyModel(),i=r.get("code")||"";i.length>0&&e.indexOf(i)!=-1&&(t.getType()==f.Formula?n.push(r.get("dateValueType")):n.push(t.getValueType()))},this);var r;_.contains(n,"DATE")&&_.contains(n,"DATETIME")?_.each(n,function(e){if(!_.contains(["DATE","DATETIME"],e))return r=NaN,!1;r="DATETIME"}):_.each(n,function(e,t){if(t>0&&n[t-1]!=e)return r=NaN,!1;r=e}),this.model.set("dateValueType",r)},_selectOptions:function(){var e=this;this.$("select").each(function(){var t=$(this).attr("name"),n=e.model.get(t);n&&$(this).val(n)})},_onClickNot:function(){var e=this.model.get("rule");e.isInverse=this.$("#not").is(":checked"),this.model.set("rule",e)},_onClickAddRule:function(){var e=this.conditions.clone(),t=$.goPopup({header:h["\ub178\ucd9c \uc870\uac74 \uc124\uc815"],buttons:[{btext:c["\ud655\uc778"],btype:"confirm",callback:$.proxy(function(){this._setRules(),this._renderRuleItems(),this._toggleNotCondition()},this)},{btext:c["\ucde8\uc18c"],btype:"normal",callback:$.proxy(function(){this.conditions=e},this)}]}),n=new u({useCheckbox:!1,template:a,buttonText:h["\uc870\uac74\uc124\uc815"],fields:this.listenableFields,conditions:this.conditions,store:!1});t.find(".content").html(n.render().el),t.on("clickOption",$.proxy(function(e,t){var r=this.listenableFields.findWhere({cid:t.value});if(!r)return;var i=new o(r.fieldToCondition());if(_.isEmpty(i))return;this.conditions.each(function(e){e.trigger("unusedItem")}),this.conditions.push(i),n.addConditionButton({valueType:r.get("valueType"),model:i})},this)),t.on("onClickListItem",function(){$.goMessage(c["\ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])})},_renderRuleItems:function(){var e=this.conditions.at(0),t=this.$("[data-el-conditions]");t.empty();if(!e)return;var n=e.get("label")+":"+e.getLabelText();t.append("<li>"+n+"</li>")},_renderRules:function(){this.$el.append(m.render({lang:d})),this._renderRuleItems(),this._toggleNotCondition(),this._setNotCondition()},_toggleNotCondition:function(){this.$("[data-el-not]").toggle(!!this.conditions.length)},_setNotCondition:function(){var e=this.model.get("rule"),t=e?e.isInverse:!1;this.$("#not").prop("checked",t)},_setRules:function(){var e={},t=this.conditions.at(0);if(t){var n=this.$("#not"),r=t.get("values").values;e={listenComponentId:t.get("fieldCid"),isInverse:n.is(":visible")?this.$("#not").is(":checked"):!1,values:r?r:t.get("values")}}this.model.set("rule",e)},_getConditionByCid:function(e){this.listenableFields=this._getListenableFields();var t=this.listenableFields.findWhere({cid:e});return t?new o(t.fieldToCondition()):{}},_initConditions:function(){var e=this.model.get("rule"),t={};this.conditions=new s,e&&(t=this._getConditionByCid(e.listenComponentId),_.isEmpty(t)?this.model.set("rule",{}):(t.set("values",_.isArray(e.values)?{values:e.values}:e.values),this.conditions.push(t)))},_renderCode:function(){var e=this._createOrGetCode();this.$el.append(v.render({lang:d,code:e,disabled:this._isPredefinedTypes()}))},_checkCode:function(){var e=this.$("input[name=code]").val();if(!this._isValidCode(e,this.clientId)){var t=d["\ucf54\ub4dc \uac80\uc99d\uc624\ub958 \uba54\uc2dc\uc9c0"],n=this._getOldCode();n&&this._isValidCode(n,this.clientId)?e=n:(e=this._generateCode(),t.concat(d["\ucf54\ub4dc \uac80\uc99d\uc624\ub958 \uc790\ub3d9\uc0dd\uc131 \uc54c\ub9bc"])),$.goSlideMessage(t),this.model.set("code",e),this.$("input[name=code]").val(e)}},_getOldCode:function(){return _.isUndefined(this.component)||_.isUndefined(this.component.properties)?undefined:this.component.properties.code},_checkLabel:function(){var e=this.$('input[name="label"]');if(e.val()===""){var n=t.getComponent(this.clientId);e.val(n.name),this.model.set("label",n.name)}},_isUsingCodeTypes:function(){var e=t.getComponent(this.clientId);return!!e.valueType},_getComponentsByDateTypesAndFormulaType:function(){var e=t.getComponentsByType(f.Date),n=t.getComponentsByType(f.Time),r=t.getComponentsByType(f.Datetime),i=t.getComponentsByType(f.Formula);return _.union(e,n,r,i)}})});