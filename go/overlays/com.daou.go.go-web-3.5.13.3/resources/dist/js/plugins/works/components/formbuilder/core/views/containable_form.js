define("works/components/formbuilder/core/views/containable_form",function(require){var e=require("works/components/formbuilder/core/component_manager"),t=require("works/components/formbuilder/core/views/base_form"),n=require("works/components/formbuilder/constants"),r="."+n.CN_CONTAINABLE;return require("jquery.ui"),require("jquery.go-popup"),t.extend({initialize:function(){t.prototype.initialize.apply(this,arguments),this.isEditable()&&this.observer&&(this.listenTo(this.observer,n.REQ_REMOVE_COMPONENT,this.afterRemoveComponent),this.listenTo(this.observer,n.EVENT_CLEAR_COMPONENT_SELECTED,this.afterClearComponentSelected))},afterRender:function(){t.prototype.afterRender.apply(this,arguments),this.isEditable()&&this.bindDnDEvents(this.getContainerEl())},getContainerEl:function(){return this.$el},appendChildView:function(e){this.getContainerEl().append(e.el)},bindDnDEvents:function(e){$(e).sortable({items:_.result(this,"sortItems"),placeholder:_.result(this,"sortPlaceholder"),connectWith:_.result(this,"sortConnectWith"),appendTo:_.result(this,"sortAppendTo"),forceHelperSize:_.result(this,"sortForceHelperSize"),tolerance:_.result(this,"sortTolerance"),cursorAt:_.result(this,"sortCursorAt"),helper:_.bind(this.sortHelper,this),start:_.bind(this.sortStart,this),stop:_.bind(this.sortStop,this),receive:_.bind(this.sortReceive,this),remove:_.bind(this.sortRemove,this),change:_.bind(this.sortChange,this),sort:_.bind(this.sortSort,this),out:_.bind(this.sortOut,this),activate:_.bind(this.sortActivate,this),deactivate:_.bind(this.sortDeactivate,this)})},isComponentTypeElement:function(e){return e.is("."+n.CN_COMPONENT_TYPE)},getChildElements:function(){return this.getContainerEl().find("> ."+n.CN_COMPONENT)},getComponentElementPosition:function(e){var t=-1,n=this.getComponentView(e).$el;return this.getChildElements().each(function(e,r){$(r).data("cid")===n.data("cid")&&(t=e)}),t},getOriginalPosition:function(e){var t=-1;return _.each(this.getComponents(),function(n,r){n.cid===e.getCid()&&(t=r)}),t},orderComponent:function(e){var t=this.getComponentElementPosition(e);this.removeComponentItem(e),t>-1&&(this.addComponentItem(e,t),e.setParentCid(this.getCid()),this.observer.trigger(n.REQ_ORDER_COMPOMENT,e,t))},removeComponentItem:function(e){this.getComponents().length>0&&this.isChildComponentItem(e)&&this.components.splice(this.getOriginalPosition(e),1)},addComponentItem:function(e,t){this.components.splice(t,0,e.toJSON())},isChildComponentItem:function(t){var n;if(_.isString(t))n=e.getComponent(t);else{if(!_.isObject(t))throw new Error("Illegal Usage");n=t}return _.filter(this.getComponents(),function(e){return e.cid===n.getCid()}).length>0},afterRemoveComponent:function(t){var n;if(_.isString(t))n=e.getComponent(t);else{if(!_.isObject(t))throw new Error("Illegal Usage");n=t}return this.removeComponentItem(n),n},afterClearComponentSelected:function(){function t(){_.each(this.getComponents(),function(t){var n=e.getComponent(t.cid),r=n.getOptionView();r._initConditions()})}t.call(this)},sortItems:"> ."+n.CN_COMPONENT+":not(.unsortable)",sortPlaceholder:n.CN_PLACEHOLDER,sortConnectWith:r,sortAppendTo:document.body,sortForceHelperSize:!0,sortTolerance:"pointer",sortCursorAt:{left:20},sortHelper:function(t,n){var r=e.getComponent(n.data("cid")),i=r.getComponentPropertyModel();return e.createDragHelper(i.get("name")||r.getComponentName())},sortActivate:function(e,t){},sortDeactivate:function(e,t){},sortStart:function(t,r){r.helper.outerWidth(r.helper.data("width")),r.helper.outerHeight(r.helper.data("height"));if(this.isComponentTypeElement(r.item))return;var i=r.item.data("cid"),s=e.getComponent(i);return this.observer.trigger(n.EVENT_START_SORTING,s.getType()),s},sortStop:function(t,r){var i,s=r.item,o=s.data("cid");if(this.isComponentTypeElement(s)){var u=s.data("component-type");if(o){var a=e.getMainFormComponent(o);i=e.addComponent(a,!0),this.initChildComponent(i)}else i=this.createComponent(u,this.getCid());if(!i)return;var f=this.getComponentView(i);this.$("."+n.CN_COMPONENT_TYPE).replaceWith(f.el),f.renderNode()}else i=e.getComponent(o);return this.orderComponent(i),this.observer.trigger(n.EVENT_STOP_SORTING),i},sortReceive:function(t,n){var r;if(!this.sortCheckAcceptComponent(t,n)){this.revertUnacceptableComponent(t,n);return}if(this.isComponentTypeElement(n.item))return;return r=e.getComponent(n.item.data("cid")),this.orderComponent(r),r},sortRemove:function(t,r){var i=e.getComponent(r.item.data("cid"));return this.observer.trigger(n.REQ_REMOVE_COMPONENT,i,!0),i},sortChange:function(e,t){this.sortChangeHelperAndPlaceholderStyle(e,t)},sortSort:function(e,t){this.sortChangeHelperAndPlaceholderStyle(e,t)},sortOut:function(e,t){t&&t.helper&&(t.helper.removeClass("err_type"),t.helper.find(".icon-helper").removeClass("ic_err")),t&&t.placeholder&&t.placeholder.show()},sortCheckAcceptComponent:function(t,n){var r=e.getComponent(this.getCid()),i,s,o,u=n.item.data("cid"),a=e.getComponent(u);this.isComponentTypeElement(n.item)?i=n.item.data("component-type"):i=a.getType();var f=$("[data-cid="+u+"]"),l=n.placeholder.closest("[data-cid]").attr("data-cid")||n.item.parent().closest("[data-cid]").attr("data-cid")||f.parent().closest("[data-cid]").attr("data-cid"),c=e.getComponent(l),h=a?e.getComponent(a.parentCid).type:null,p=c?c.type:null,d=u?e.isNew(u):!0,v=function(){if(d)return!1;var e=h==="table"||p==="table",t=h!=p;return t&&e};if(v())return!1;var m=a&&c&&(a.type==="table"||a.type==="columns")&&(c.type==="table"||c.type==="column");return m?!1:r.acceptComponent?(s=_.isArray(r.acceptComponent)?r.acceptComponent:[r.acceptComponent],o=_.filter(s,function(e){return e[0]==="!"&&e!=="!"+i?!0:e===i}),o.length>0):!0},revertUnacceptableComponent:function(e,t){this.$("."+n.CN_COMPONENT_TYPE).remove();if(!this.isComponentTypeElement(t.item)){var r=t.sender||e.target;$(r).sortable("cancel")}},sortChangeHelperAndPlaceholderStyle:function(e,t){var n=this.sortCheckAcceptComponent(e,t);t.helper.toggleClass("err_type",!n),t.helper.find(".icon-helper").toggleClass("ic_err",!n),t.placeholder.toggle(n)}})});