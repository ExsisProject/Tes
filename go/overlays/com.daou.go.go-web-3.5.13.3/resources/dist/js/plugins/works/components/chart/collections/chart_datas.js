define("works/components/chart/collections/chart_datas",function(require){var e=require("backbone"),t=require("works/components/formbuilder/form_components/formula/formula_util");return e.Collection.extend({initialize:function(e,t){this.appletId=t.appletId,this.groupByField=t.groupByField,this.aggField=t.aggField,this.chartType=t.chartType,"GAUGE"!==this.chartType&&(this.groupByCid=t.groupByCid,this.subGroupByCid=t.subGroupByCid),this.rangeOption=t.rangeOption,this.subRangeOption=t.subRangeOption,this.aggMethod=t.aggMethod,this.aggCid=t.aggCid||null,this.q=t.q||""},url:function(){return GO.contextRoot+"api/works/applets/"+this.appletId+"/stats?"+this._makeParam()},parse:function(e){return!this.hasDayTimeFormulaField(this.groupByField)&&!this.hasDayTimeFormulaField(this.aggField)?e.data:(_.isUndefined(this.groupByField)||(this.groupByField.isDateTimeToDayFormulaFieldType()?_.each(e.data,function(e){e.name=t.dateTimeToDayDisplayText(e.name)}):this.groupByField.isTimeToTimeFormulaFieldType()?_.each(e.data,function(e){e.name=t.timeToTimeDisplayText(e.name)}):this.groupByField.isDateTimeToTimeFormulaFieldType()&&_.each(e.data,function(e){e.name=t.dateTimeToTimeDisplayText(e.name)})),_.isUndefined(this.aggField)||(this.aggField.isDateTimeToDayFormulaFieldType()?_.each(e.data,function(e){e.value=t.dayToMinuteForDayFormula(e.value)}):this.aggField.isDateTimeToTimeFormulaFieldType()&&_.each(e.data,function(e){e.value=t.timeToMinuteForDayFormula(e.value)})),e.data)},hasDayTimeFormulaField:function(e){return!_.isUndefined(e)&&e.isDayTimeFormulaFieldType()},isMultiSeries:function(){return!!this.subGroupByCid},getMultiSeriesData:function(){var e=this.toJSON(),t={},n=this.getSubLegend();return _.each(e,function(e){_.each(n,function(n){t[n]||(t[n]=[]);var r=_.find(e.value,{name:n});t[n].push(r?r.value:0)})}),t},getSubLegend:function(e){e=e||"";var t=this.toJSON(),n=[];return _.each(t,function(t){_.each(t.value,function(t){n.push(t.name+e)})}),n=_.uniq(n),n},getLabel:function(e){return e=e||this.models,_.map(e,function(e){return e.get("name")})},getPieData:function(){return this.length>=100?_.filter(this.toJSON(),function(e,t){return t<100}):this.toJSON()},getPieLabel:function(){return this.getLabel()},getGaugeData:function(){var e=this.at(0);if(!e)return[];e=e.clone(),e.set("name","");var t=e.get("value");return typeof t=="number"&&e.set("value",parseFloat(t.toFixed(2))),[e.toJSON()]},setQueryString:function(e){this.q=e},_makeParam:function(){var e={aggMethod:this.aggMethod,aggCid:this.aggCid,q:this.q};return this.groupByCid&&(e.groupByCid=this.groupByCid),this.rangeOption&&(e.rangeOption=this.rangeOption),this.subGroupByCid&&(e.subGroupByCid=this.subGroupByCid),this.subRangeOption&&(e.subRangeOption=this.subRangeOption),"PIE"===this.chartType&&(e.sort="VALUE",e.direction="DESC"),$.param(e)}})});