define("works/components/report/view/chart",function(require){var e=require("backbone"),t=require("i18n!works/nls/works"),n={"\ucf64\ubcf4\ucc28\ud2b8 \uc624\ub958":t["\ucf64\ubcf4\ucc28\ud2b8 \uc624\ub958"],"\ub370\uc774\ud130\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.":t["\ub370\uc774\ud130\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],"\ubaa9\ud45c":t["\ubaa9\ud45c"],"\uc774\ubbf8\uc9c0\ub85c \uc800\uc7a5":t["\uc774\ubbf8\uc9c0\ub85c \uc800\uc7a5"],"\ud504\ub808\uc820\ud14c\uc774\uc158":t["\ud504\ub808\uc820\ud14c\uc774\uc158"],"\ubcf5\uc6d0":t["\ubcf5\uc6d0"],"\uaebe\uc740 \uc120\ud615":t["\uaebe\uc740 \uc120\ud615"],"\uc138\ub85c \ub9c9\ub300\ud615":t["\uc138\ub85c \ub9c9\ub300\ud615"],line:"("+t["\uaebe\uc740 \uc120\ud615"]+")",bar:"("+t["\uc138\ub85c \ub9c9\ub300\ud615"]+")",COUNT:t["\uac1c\uc218"],SUM:t["\ud569\uacc4"],AVG:t["\ud3c9\uade0"],MAX:t["\ucd5c\ub300\uac12"],MIN:t["\ucd5c\uc18c\uac12"]},r=require("works/components/chart/collections/chart_datas"),i=require("hgn!works/components/chart/templates/chart"),s={0:["#1d72ec","#7a7a7a","#35c2ff","#7075ff","#98afff","#a5a9b8","#00d1d1","#394cc8","#0a977e","#35444e"],1:["#37abe8","#4fe3b9","#c79aea","#fbd63f","#29cbe4","#c8d5e7","#7dcff6","#8eaaec","#3fe4fb","#6286f3"],2:["#ff9a53","#8e8dd1","#ffcf55","#91b3e7","#a6ba8c","#ebdba4","#fe85a4","#b2adad","#7c738b","#c384db"],3:["#00d1d1","#7a7a7a","#82adad","#4ae562","#b6ebe3","#2da940","#1e838d","#4ffefe","#40ab92","#c3cbcd"]};return e.View.extend({tagName:"section",className:"report_item_chart",events:{click:"_onClickChart"},initialize:function(e){this.options=e||{},this.appletId=e.appletId,this.chartFields=e.chartFields,this.numberFields=e.numberFields,this.useToolbox=e.useToolbox===undefined?!0:e.useToolbox,this.isThumbnail=e.isThumbnail===undefined?!1:e.isThumbnail,this.usePresentation=e.usePresentation===undefined?!0:e.usePresentation,this.isPresentation=e.isPresentation===undefined?!1:e.isPresentation,this.useLink=e.useLink===undefined?!1:e.useLink,this.model.on("change:queryString",this._fetchChartData,this),this.model.on("change:docs",this._onChangeDocs,this),this.chartDatas=new r([],_.extend(this.model.toJSON(),{appletId:this.appletId,groupByField:this.chartFields?this.chartFields.findWhere({cid:this.model.get("groupByCid")}):{},aggField:this.numberFields?this.numberFields.findWhere({cid:this.model.get("aggCid")}):{}})),this.subChartDatas=new r([],_.extend(this.model.toJSON(),{appletId:this.appletId,groupByField:this.chartFields?this.chartFields.findWhere({cid:this.model.get("groupByCid")}):{},aggMethod:this.model.get("subAggMethod"),aggCid:this.model.get("subAggCid"),aggField:this.numberFields?this.numberFields.findWhere({cid:this.model.get("subAggCid")}):{}})),this.isInitResize=!1,this.settingId=e.settingId},render:function(){return this.$el.html(i),this.chartEl=this.$("div.card_wrapper"),this},_onClickChart:function(){this.isThumbnail&&this.$el.trigger("navigateChart",this.model)},_bindResize:function(){if(this.isInitResize)return;this.isInitResize=!0,$(window).on("resize",_.bind(function(){setTimeout($.proxy(function(){this.chart.resize()},this),300)},this))},_fetchChartData:function(){this.chartDatas.setQueryString(this.model.get("queryString")),this.model.get("combination")?(this.subChartDatas.setQueryString(this.model.get("queryString")),$.when(this.chartDatas.fetch(),this.subChartDatas.fetch()).done(_.bind(function(){this._onSyncChartDatas()},this))):this.chartDatas.fetch().done(_.bind(function(){this._onSyncChartDatas()},this))},fetchChartDatas:function(){this._fetchChartData()},_onChangeDocs:function(){this._fetchChartData()},_onSyncChartDatas:function(){var e=this.model.get("chartType");e==="COLUMN"?this._renderBarChart():e==="LINE"?this._renderBarChart(e):e==="PIE"?this._renderPieChart():e==="GAUGE"&&this._renderGaugeChart(),this._bindResize(),setTimeout($.proxy(function(){$(window).trigger("resize")},this),100)},_renderBarChart:function(e){e=e==="LINE"?"line":"bar";var t={},r=this.chartDatas.toJSON(),i=this.chartDatas.getLabel(),s=this.model.get("stack"),o=this.model.get("combination"),u=this.subChartDatas.isMultiSeries(),a=u?this._getMultiSeries(this.chartDatas.getMultiSeriesData(),e,s):[{type:e,stack:"stack",data:r,itemStyle:this._seriesItemStyle(e,s)}];if(o){var f=e==="line"?"bar":"line",l=this.model.get("subStack"),c=this.subChartDatas.isMultiSeries()?this._getMultiSeries(this.subChartDatas.getMultiSeriesData(),f,l,n[f],1,o):[{yAxisIndex:1,type:f,combination:!0,stack:"subStack",data:this.subChartDatas.toJSON(),itemStyle:this._seriesItemStyle(f,l,o)}];a=_.union(a,c)}t.title=this._getChartTitle(),t=_.extend(t,this._commonOption(),{tooltip:{position:"inside",trigger:"axis",axisPointer:{type:"shadow"},formatter:_.bind(function(e){var t=_.map(e,function(e){var t=u?e.seriesName:e.name;!u&&f===e.seriesType&&(t+=n[e.seriesType]);var r=e.value;return typeof t=="number"&&(t=GO.util.numberWithCommas(t)),typeof r=="number"&&(r=GO.util.numberWithCommas(parseFloat(r.toFixed(2)))),t+" : "+r},this);if(u){var r=e[0]||{};t.unshift(u?r.name:r.seriesName)}return t.join("<br>")},this),textStyle:this._fontFamily()},toolbox:this.useToolbox?{show:!this.isThumbnail,orient:"horizontal",x:"left",y:"top",feature:this._getFeature(),textStyle:this._fontFamily(),color:"#9d9d9d"}:!1,calculable:!0,dataZoom:this.isThumbnail?!1:{show:!0,height:20,bottom:30},xAxis:[{type:"category",data:i,axisLabel:{formatter:_.bind(function(e){return this.isThumbnail?"":(typeof e=="number"&&(e=GO.util.numberWithCommas(e)),e)},this),textStyle:this._fontFamily()}}],yAxis:this._getYAxis(),series:a,grid:this._getGridOption()});if(u&&!this.isThumbnail){var h=this.chartDatas.getSubLegend();if(this.model.get("combination")){var p=this.subChartDatas.getSubLegend(n[f]);h=_.union(h,p)}_.extend(t,{legend:{type:"scroll",data:h,bottom:0}})}this.chart=echarts.init(this.chartEl[0]),this.chart.setOption(t)},_renderPieChart:function(){var e=this.chartDatas.getPieData(),t=this.chartDatas.getPieLabel(),n=e.length<=30,r=this._isShowValue(),i=_.extend(this._commonOption(),{title:{text:this.model.get("title"),x:"center",textStyle:_.extend(this._fontFamily(),this._titleFontSize())},tooltip:{trigger:"item",formatter:function(e){var t=e.name,n=e.value;return typeof t=="number"&&(t=GO.util.numberWithCommas(t)),typeof n=="number"&&(n=GO.util.numberWithCommas(parseFloat(n.toFixed(2)))),t+" : "+n+"("+e.percent+"%)"},textStyle:this._fontFamily()},legend:{show:!this.isThumbnail,type:"scroll",bottom:0,data:t,textStyle:this._fontFamily()},toolbox:GO.util.isMobile()?!1:{show:!this.isThumbnail,orient:"horizontal",x:"left",y:"top",feature:this._getFeature(),textStyle:this._fontFamily(),color:"#9d9d9d"},calculable:!0,series:[{type:"pie",radius:"55%",center:["50%","50%"],itemStyle:{normal:{label:{show:!this.isThumbnail&&n,formatter:function(e){var t=e.name,n=e.value;return typeof t=="number"&&(t=GO.util.numberWithCommas(t)),typeof n=="number"&&(n=GO.util.numberWithCommas(parseFloat(n.toFixed(2)))),r?t+"\n"+n+" ("+e.percent+"%)":n},textStyle:this._fontFamily()},labelLine:{show:!this.isThumbnail&&n}}},data:e}]});this.chart=echarts.init(this.chartEl[0]),this.chart.setOption(i)},_renderGaugeChart:function(){var e=100,t=1/(e/120),r=this.model.get("goal"),i=this.chartDatas.getGaugeData(),o=this._isShowValue(),u=this.isThumbnail,a=this.model.get("theme")+""||"0",f=s[a],l=_.extend(this._commonOption(),{title:{text:this.model.get("title"),x:"center",textStyle:_.extend(this._fontFamily(),this._titleFontSize(14))},tooltip:{formatter:function(e){var t=parseFloat(e.value*100/r).toFixed(1)+"%";return GO.util.numberWithCommas(e.value)+"("+t+")"}},toolbox:GO.util.isMobile()?!1:{show:!this.isThumbnail,orient:"horizontal",x:"left",y:"top",feature:this._getFeature(),textStyle:this._fontFamily(),color:"#9d9d9d"},series:[{type:"gauge",startAngle:180,endAngle:0,max:r*t,center:["50%","75%"],axisLine:{lineStyle:{color:[[.833,f[0]],[1,f[2]]]}},splitNumber:12,axisLabel:{formatter:function(e){if(u)return"";switch(e+""){case r+"":return n["\ubaa9\ud45c"]+"\n"+GO.util.numberWithCommas(r);default:return""}},textStyle:{fontSize:15,fontWeight:"bolder"}},pointer:{width:4},title:{show:!0,offsetCenter:[0,"-60%"],textStyle:{color:"#fff",fontSize:30}},detail:{show:!0,borderWidth:0,offsetCenter:[0,"-130%"],formatter:function(e){if(o&&!u){var t=parseFloat(e*100/r).toFixed(1)+"%";return GO.util.numberWithCommas(e)+"("+t+")"}return""},textStyle:{color:"auto",fontSize:30}},data:i}]});this.chart=echarts.init(this.chartEl[0]),this.chart.setOption(l,!0)},_showPresentationMode:function(){this.$el.trigger("showPresentationMode",this.model)},_goToAppletHome:function(){console.log("_goToAppletHome"),GO.router.navigate("works/applet/"+this.appletId+"/home",!0)},_commonOption:function(){var e=this.model.get("theme")+""||"0";return{loadingText:"loading..",noDataLoadingOption:{text:n["\ub370\uc774\ud130\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],effect:"whirling"},color:s[e],renderAsImage:this.isThumbnail}},_fontFamily:function(){return{fontFamily:"Noto Sans KR, \ub9d1\uc740 \uace0\ub515, \ub3cb\uc6c0, malgun gothic, dotum, AppleGothic, Helvetica, sans-serif"}},_titleFontSize:function(e){return{fontSize:e}},_titleFontColor:function(e){return{color:e}},_getChartTitle:function(){var e=[{text:this.model.get("title"),x:"center",y:"top",textStyle:_.extend(this._fontFamily(),this._titleFontSize(14))}];if(this.model.get("combination")&&this.chartDatas.length!=this.subChartDatas.length){var t;this.chartDatas.length>this.subChartDatas.length?t=this.subChartDatas.aggField:t=this.chartDatas.aggField;var r=t?t.get("label"):"";e.push({text:r+" "+n["\ucf64\ubcf4\ucc28\ud2b8 \uc624\ub958"],x:"center",y:"bottom",textStyle:_.extend(this._fontFamily(),this._titleFontSize(9),this._titleFontColor("red"))})}return e},_getMultiSeries:function(e,t,n,r,i,s){i=i||0;if(_.isEmpty(e))return{type:t,data:[]};var o=this._seriesItemStyle(t,n,s);return _.map(e,function(e,s){return{yAxisIndex:i,name:r?s+r:s,type:t,data:e,stack:n?t:!1,itemStyle:o}})},_getGridOption:function(){return this.isThumbnail?{x:0,y:0,x2:0,y2:0}:{y:60,y2:80}},_getFeature:function(){return{magicType:{show:this.isPresentation&&this._isBarOrLine(),title:{line:n["\uaebe\uc740 \uc120\ud615"],bar:n["\uc138\ub85c \ub9c9\ub300\ud615"]},type:["line","bar"]},restore:{show:this.isPresentation&&(this._isBarOrLine()||this._isPie()),title:n["\ubcf5\uc6d0"]},saveAsImage:{show:!GO.util.msie()&&this.isPresentation,title:n["\uc774\ubbf8\uc9c0\ub85c \uc800\uc7a5"],lang:[n["\uc774\ubbf8\uc9c0\ub85c \uc800\uc7a5"]]},myShowLink:{show:this.useLink,title:t["\ud574\ub2f9 \uc571\uc73c\ub85c \uc774\ub3d9"],lang:[t["\ud574\ub2f9 \uc571\uc73c\ub85c \uc774\ub3d9"]],icon:"image://"+GO.util.locationOrigin()+"/resources/images/ic_access.png",onclick:_.bind(this._goToAppletHome,this)}}},_isBarOrLine:function(){var e=this.model.get("chartType");return e==="COLUMN"||e==="LINE"},_isPie:function(){return this.model.get("chartType")==="PIE"},_isShowValue:function(){return this.isPresentation},_labelValueOption:function(e,t,n){return n||t?!1:{show:!0,position:"top",formatter:function(e){var t=e.value;return typeof t=="number"&&(t=GO.util.numberWithCommas(parseFloat(t.toFixed(2)))),t=="0"?"":t}}},_seriesItemStyle:function(e,t,n){var r={};return e==="line"&&t&&(r.normal={areaStyle:{type:"default"}}),this._isShowValue()&&(r.normal||(r.normal={}),r.normal.label=this._labelValueOption(e,t,n)),r},_getYAxis:function(){var e=this.model.get("combination"),t=[this._getYAxisItem(this.chartDatas,e)];return e&&t.push(this._getYAxisItem(this.subChartDatas,!0)),t},_getYAxisItem:function(e,t){return{name:this._getYAxisName(e),type:"value",splitNumber:t?5:null,axisLabel:{rotate:30,formatter:_.bind(function(e){return this.isThumbnail?"":(typeof e=="number"&&(e=GO.util.numberWithCommas(e)),e.length>12&&(e=e.substr(0,10)+".."),e)},this),textStyle:this._fontFamily()}}},_getYAxisName:function(e){if(!_.isUndefined(e.aggField)&&e.aggField.isDayTimeFormulaFieldType())return t["\ubd84"];var r="";return e.aggMethod&&(r+=n[e.aggMethod]),e.aggField&&(r+="("+e.aggField.get("label")+")"),r}})});