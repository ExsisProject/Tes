define("works/components/formbuilder/core/views/form_design",function(require){var e=require("backbone"),t=require("when"),n=require("works/components/formbuilder/core/component_manager"),r=require("hgn!works/components/formbuilder/core/templates/form_design"),i=require("works/components/formbuilder/constants"),s=require("app"),o=require("i18n!nls/commons"),u=require("i18n!works/nls/works");require("jquery.go-popup");var a=function(){return t.promise.apply(this,arguments)},f={pageTitle:u["\uc785\ub825\ud654\uba74 \uad00\ub9ac"],save:o["\uc800\uc7a5"],cancel:o["\ucde8\uc18c"],goToSettingsHome:u["\uad00\ub9ac \ud648\uc73c\ub85c \uc774\ub3d9"],goToAppHome:u["\uc571 \ud648\uc73c\ub85c \uc774\ub3d9"],formDelete:u["\ud3fc \uc0ad\uc81c"]};return e.View.extend({className:"go_content build_situation build_multi_form",observer:null,contentTopView:null,canvasView:null,appletId:null,model:null,events:{"click [el-form-tab]":"_changeForm","click [el-form-create-tab]":"_createForm","click .btn-save":"_saveFormModel","click .btn-cancel":"_cancelEditForm","click .btn-goto-settings-home":"_goToSettingsHome","click .btn-goto-app-home":"_goToAppHome","click .btn-subform-delete":"_subformDelete"},initialize:function(e){e=e||{},this.observer=null,e.hasOwnProperty("observer")&&(this.observer=e.observer),this.appletId=null,e.hasOwnProperty("appletId")&&(this.appletId=e.appletId,this.mainForm=e.appletFormModel.mainForm,this.subFormId=e.appletFormModel.subFormId),this.appletFormModel=e.appletFormModel,this.mainFormModel=e.mainFormModel,this._freezingFormData(),this._initRender(),this._initCanvasView(),this.listenTo(this.observer,i.REQ_ORDER_COMPOMENT,this._orderComponent),this.listenTo(this.observer,i.REQ_REMOVE_COMPONENT,this._removeComponent),this.listenTo(this.observer,i.REQ_COPY_COMPONENT,this._copyComponent),this.listenTo(this.observer,i.REQ_UPDATE_COMPONENT,this._updateComponent),this.listenTo(this.observer,i.EVENT_UPDATE_FORM_ACCESS_SETTING,this._updateFormAccessModel)},render:function(){this.$(".canvas-container").prepend(this.canvasView.el),this.canvasView.renderNode(),this.observer.trigger("setInitDisplay"),this._bindDocumentClickEvent()},remove:function(){e.View.prototype.remove.apply(this,arguments),this.canvasView.remove(),$(document).off(i.EVENT_SELECT_COMPONENT)},resize:function(e){this.$el.outerHeight(e)},setContenTopElement:function(e){this.$(".content_top").replaceWith(e)},_freezingFormData:function(){this.originComponentData=s.util.clone(this.model.toJSON(),!0),this.originFormData=s.util.clone(this.appletFormModel,!0)},_initRender:function(){this.$el.empty(),this.$el.append(r({lang:f,mainForm:this.mainForm}))},_initCanvasView:function(){n.init(this.model.toJSON(),{type:"form"}),this.mainFormModel&&n.initMainForm(this.mainFormModel.get("data"),!0);var e=n.getComponent(this.model.get("cid"));e.setAppletId(this.appletId),s.util.isValidValue(this.subFormId)&&e.setSubFormId(this.subFormId),e.setEditable(!0),e.attachObserver(this.observer),this.canvasView=e.getFormView()},_bindDocumentClickEvent:function(){function n(e){return $(e).closest(".build_box")}function r(e){var t=n(e);return t.length>0&&t.hasClass("select")}function s(e){return $(e).closest(".component-option").length>0}function o(e){return $(e).hasClass("prevent-component-select")}function u(e){return $(e).closest("#gpopupLayer").length>0}function a(e){return $(e).closest("div#ui-datepicker-div").length>0}var e=this.observer,t="on";$(document).on(i.EVENT_SELECT_COMPONENT,function(f){var l,c,h=f.relatedTarget;if($("#popOverlay").is(h)||$(".layer_pallete").find(h).length)return;r(h)||s(h)||o(h)||u(h)||a(h)||(l=n(h),c=l.data("cid"),$(".canvas-container").find("."+t).removeClass(t),e.trigger(i.EVENT_CLEAR_COMPONENT_SELECTED,c),l.length>0&&(l.addClass(t),e.trigger(i.EVENT_COMPONENT_SELECTED,c))),f.stopImmediatePropagation()})},_updateComponent:function(e){var t=n.getComponent(e);this.model.update(t.toJSON())},_updateFormAccessModel:function(e){var t=this;_.each(e,function(e,n){t.appletFormModel[n]=e})},_orderComponent:function(e,t){var r;_.isString(e)?r=n.getComponent(e):r=e;var i=this.model.order(r.toJSON(),t);if(i){var s=n.getComponent(i.cid);s.components=i.components}},_removeComponent:function(e,t){var r;_.isString(e)?r=n.getComponent(e):r=e,this.model.remove(r.toJSON(),t||!1)},_copyComponent:function(e){},_reloadCanvasView:function(){this.canvasView.remove(),this.canvasView=null,this._initCanvasView(),this.render()},_saveFormModel:function(e){var t=!_.isEqual(this.originFormData,this.appletFormModel),n=!_.isEqual(this.originComponentData,this.model.toJSON());t||n?(e.preventDefault(),this.__save(),e.stopPropagation()):$.goSlideMessage(u["\ubcc0\uacbd\ub41c \ub0b4\uc6a9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])},__save:function(){if(this._validateComponent()){var e=this;e.subFormId?e._saveCallBack():$("[el-form-tab]").length>1?$.goConfirm(u["\uba54\uc778 \ud3fc\uc5d0 \ubcc0\uacbd\uc0ac\ud56d\uc774 \uc788\uc2b5\ub2c8\ub2e4."],u["\uba54\uc778 \ud3fc \ubcc0\uacbd \uc548\ub0b4"],function(){e._saveCallBack()},function(){return!1},o["\ud655\uc778"]):e._saveCallBack()}},_saveCallBack:function(){var e=this;(new a(_.bind(function(t,n){e.observer.trigger(i.REQ_SAVE,e.model.toJSON(),t,n)},e))).then(_.bind(function(){e.observer.trigger(i.EVENT_CLEAR_COMPONENT_SELECTED),_.map(n.getComponents(),function(t){var n=e.model.search(t.getCid());n&&n.properties&&t.setProperties(n.properties)},e),e._freezingFormData()},e)).otherwise(function(e){console.log(e.stack)})},_subformDelete:function(e){e.preventDefault();var t=this.appletId,n=this.subFormId;this.observer.trigger(i.REQ_DELETE_SUBFORM,{appletId:t,subFormId:n})},_validateComponent:function(){var e=this.model.checkValidate();return e?($.goSlideMessage(e,"caution"),!1):!0},_cancelEditForm:function(e){var t=!_.isEqual(this.originFormData,this.appletFormModel),n=!_.isEqual(this.originComponentData,this.model.toJSON());t||n?(e.preventDefault(),$.goConfirm(o["\ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],u["\ud3fc\ube4c\ub354 \ud3b8\uc9d1 \ucde8\uc18c"],_.bind(function(){this.model.set(s.util.clone(this.originComponentData,!0),{silent:!0}),this._reloadCanvasView()},this))):$.goSlideMessage(u["\ubcc0\uacbd\ub41c \ub0b4\uc6a9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])},_goToSettingsHome:function(e){e.preventDefault(),this.observer.trigger(i.REQ_GOTO_SETTINGS_HOME)},_goToAppHome:function(e){e.preventDefault(),this.observer.trigger(i.REQ_GOTO_APP_HOME)},_changeForm:function(e){var t=$(e.currentTarget).attr("data-id"),n={selectFormId:t,message:u["\ud3fc \uc774\ub3d9 \uacbd\uace0"],eventType:i.REQ_CHANGE_FORM};this.__confirmAndTriggerEvent(n)},_createForm:function(){var e={message:u["\ud3fc \uc0dd\uc131 \uacbd\uace0"],eventType:i.REQ_CREATE_FORM};this.__confirmAndTriggerEvent(e)},__confirmAndTriggerEvent:function(e){var t=!_.isEqual(this.originFormData,this.appletFormModel),n=!_.isEqual(this.originComponentData,this.model.toJSON()),r=e.selectFormId,s=e.eventType,a=this.mainForm?u["\uba54\uc778 \ud3fc\uc5d0 \ubcc0\uacbd\uc0ac\ud56d\uc774 \uc788\uc2b5\ub2c8\ub2e4."]:"",f=this.mainForm?u["\uba54\uc778 \ud3fc \ubcc0\uacbd"]+"<br/>"+e.message:e.message,l=!1;s==i.REQ_CHANGE_FORM&&(l=r=="tab_main"&&this.mainForm?!0:this.subFormId==r);if(l)return;if(t||n){var c=this;this.popupView=$.goPopup({pclass:"layer_normal",header:a,contents:f,buttons:[{btext:o["\uc800\uc7a5"],btype:"confirm",callback:$.proxy(function(){c._validateComponent()&&c._saveCallBack(),r?this.observer.trigger(s,r):this.observer.trigger(s)},this)},{btext:u["\uc800\uc7a5\ud558\uc9c0 \uc54a\uace0 \uc774\ub3d9"],callback:$.proxy(function(){r?this.observer.trigger(s,r):this.observer.trigger(s)},this)}]})}else r?this.observer.trigger(s,r):this.observer.trigger(s)}})});