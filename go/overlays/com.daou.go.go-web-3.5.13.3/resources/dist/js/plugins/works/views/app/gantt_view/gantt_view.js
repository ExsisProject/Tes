define("works/views/app/gantt_view/gantt_view",function(require){var e=require("app"),t=require("works/views/app/base_applet"),n=require("works/components/filter/views/filter"),r=require("works/views/app/gantt_view/field_setting_popup"),i=require("works/views/app/gantt_view/gantt_list_view"),s=require("works/views/app/gantt_view/gantt_graph_view"),o=require("works/collections/docs"),u=require("works/components/applet_doc_search/views/applet_doc_search"),a=require("works/collections/fields"),f=require("hgn!works/templates/app/gantt_view/gantt_view"),l=require("hgn!works/components/filter/templates/filter"),c=require("works/constants/works"),h=require("i18n!nls/commons"),p=require("i18n!works/nls/works"),d=require("i18n!board/nls/board"),v=require("i18n!contact/nls/contact"),m={"\uc21c\uc11c\ubc14\uafb8\uae30":h["\uc21c\uc11c\ubc14\uafb8\uae30"],"\ub370\uc774\ud130\ubd88\ub7ec\uc624\uae30":p["\ub370\uc774\ud130 \ubd88\ub7ec\uc624\uae30"],"\uadf8\ub8f9\ucd94\uac00":v["\uadf8\ub8f9\ucd94\uac00"],"\ubaa8\ub450\ub2eb\uae30":d["\ubaa8\ub450 \ub2eb\uae30"],"\uc811\uae30":h["\uc811\uae30"],"\ud3b4\uae30":h["\ud3b4\uae30"],"\uc0ac\uc6a9\uc911\uc778\ud56d\ubaa9":p["\uc0ac\uc6a9\uc911\uc778 \ud56d\ubaa9"],"\uc624\ub298":h["\uc624\ub298"]};return require("jquery.go-preloader"),t.extend({className:"content_page",events:{"click a.btnToggleNodes":"_onClickToggleNodes","click a.btnGroupAdd":"_onClickGroupAdd","click a.btnSortable":"_onClickSortableToggle","click a.btnBringDocNodes":"_onClickBringDocNodes","click #fieldSettingBtn":"_showFieldSettingPopup","click #today":"_showToday","click .toggleListView":"_toggleListView"},initialize:function(n){e.util.store.set("applet-viewtype","gantt",{type:"session"}),t.prototype.initialize.apply(this,arguments),this.options=n||{},this.appletId=this.options.appletId,this._setFilterOptions()},_setFilterOptions:function(){this.useCachedCondition=this.options.useCachedCondition,this.useCachedCondition||e.util.store.set(e.session("id")+"-"+this.appletId+"-searchObject",{},{type:"session"}),this._fieldSynced=$.Deferred(),this.fields=new a([],{appletId:this.appletId,type:"accessible",includeProperty:!0,includeDocNoAndProcess:!0}),this.fields.on("sync",this._onSyncFields,this)},_onSyncFields:function(){this._fieldSynced.resolve()},render:function(){this.preloader=$.goPreloader(),this.preloader.render(),$.when(t.prototype.render.apply(this,arguments),this.accessibleForms.length>0?this.fields.fetch():this._renderNoExistForm(this.$el)).then($.proxy(function(){if(this.accessibleForms.length<1)return;this.isAdmin=this.baseConfigModel.isAdmin(e.session("id")),this._unbindEvent(),this._bindEvent(),this._renderFilterView(),this._adjustCssClass(),$.when(this.sideView._ganttViewSynced).then($.proxy(function(){this.ganttViewModel=this.sideView.ganttViewModel,!this.ganttViewModel.hasRequiredFields()&&this.isAdmin?this._showFieldSettingPopup(this.ganttViewModel):!this.ganttViewModel.hasRequiredFields()&&!this.isAdmin&&$.goPopup({header:p["\uac04\ud2b8 \ubdf0\ub97c \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]+"<br>"+h["\uc6b4\uc601\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."]})},this))},this))},_unbindEvent:function(){this.$el.off("searchByFilter"),this.$el.off("changeFilter"),e.EventEmitter.off("ganttTree")},_bindEvent:function(){this.$el.on("searchByFilter",$.proxy(function(e,t){this._search(t)},this)),this.$el.on("changeFilter",_.bind(function(){e.router.navigate("works/applet/"+this.appletId+"/home/search",{replace:!0})},this)),e.EventEmitter.on("ganttTree","refresh:listAndGraph",function(){this._renderListAndGraphView()},this),e.EventEmitter.on("ganttTree","refresh:graph",function(){this._renderGraphView()},this)},_search:function(e){this.queryString=_.isUndefined(e)?"":e.queryString,$.when(this._fieldSynced,this.sideView._ganttViewSynced).then($.proxy(function(){this.$el.find(".gantt_tool_bar").length==0&&this.$el.append(f({lang:m,isAdmin:this.isAdmin})),this._renderListAndGraphView()},this))},_renderListAndGraphView:function(){var e=this;$.when(this._renderListView(),this._renderGraphView()).then(function(){e.preloader.release()})},_renderListView:function(){this.listView=new i({appletId:this.appletId,isAdmin:this.isAdmin,fields:this.fields,ganttViewModel:this.sideView.ganttViewModel,queryString:this.queryString}),this.listView.render()},_renderGraphView:function(){this.graphView=new s({appletId:this.appletId,ganttViewModel:this.sideView.ganttViewModel.toJSON(),ganttTreeNodes:this.listView.ganttTreeConfigView.ganttTreeNodes}),this.graphView.render()},_renderFilterView:function(){this.filterView=new n({fields:this.fields,appletId:this.appletId,filters:this.filters,isAdmin:this.isAdmin,useDocNo:this.baseConfigModel.attributes.useDocNo,template:l,templateParam:{hideListSetting:!0},useCachedCondition:this.useCachedCondition}),this.$el.prepend(this.filterView.el),this.filterView.render()},_adjustCssClass:function(){var e=this.layoutView.getContentElement();e.removeClass("build_situation"),e.addClass("go_works_situation")},_showFieldSettingPopup:function(){this.fieldSettingPopup=new r({appletId:this.appletId,fields:this.fields.getColumnFields().toJSON(),ganttViewModel:this.ganttViewModel}),this.fieldSettingPopup.render();var e=this,t=[];t.push({btext:p["\uc785\ub825\ud654\uba74 \uad00\ub9ac\ub85c \uc774\ub3d9\ud558\uae30"],autoclose:!1,callback:$.proxy(this._goToSettingsUserform,this)});var n=this.baseConfigModel.attributes.useGanttView;t.push({btext:h["\uc644\ub8cc"],btype:"confirm",autoclose:!1,callback:$.proxy(n?this._saveFieldSetting:this._createGanttView,this)}),t.push({btext:h["\ucde8\uc18c"],callback:$.proxy(n?"":this._goToListView,this)}),$.goPopup({header:p["\uac04\ud2b8 \ubdf0 \ud56d\ubaa9 \uc120\ud0dd"],title:'<p class="desc">'+p["\uac04\ud2b8 \ubdf0 \ud56d\ubaa9 \uc120\ud0dd \uc124\uba85"]+"</p>",pclass:"layer_normal layer_gantt_set",modal:!0,closeCallback:$.proxy(n?"":this._goToListView,this),width:400,contents:e.fieldSettingPopup.$el,buttons:t})},_goToSettingsUserform:function(){var t=this;$.goConfirm(p["\uc785\ub825\ud654\uba74 \uad00\ub9ac \ud654\uba74\uc73c\ub85c \uc774\ub3d9"],p["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc740 \uc800\uc7a5\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4. \uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],function(){e.router.navigate("/works/applet/"+t.appletId+"/settings/userform",!0)})},_goToListView:function(){e.router.navigate("/works/applet/"+this.appletId+"/home",!0)},_saveFieldSetting:function(){var t=this,n=this._getFieldSettingFromPopup(),r=this._validateFieldSetting(n);r&&$.ajax({type:"PUT",dataType:"json",async:!1,contentType:"application/json",url:e.contextRoot+"api/works/applets/"+this.appletId+"/ganttview/setting/fields",data:JSON.stringify(n),success:function(n){e.router.navigate("works/applet/"+t.appletId+"/gantt",!0),$.goMessage(h["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(e){var t=JSON.parse(e.responseText);$.goMessage(t&&t.message?t.message:h["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})},_getFieldSettingFromPopup:function(){var e=this.fieldSettingPopup.$el;return{titleFieldCid:e.find("#title_setting option:selected").val(),startFieldCid:e.find("#startdate_setting option:selected").val(),endFieldCid:e.find("#enddate_setting option:selected").val(),userFieldCid:e.find("#user_setting option:selected").val(),progressFieldCid:e.find("#progress_setting option:selected").val()}},_validateFieldSetting:function(e){return!e.titleFieldCid||!e.startFieldCid||!e.endFieldCid?($.goSlideMessage(h["\ud544\uc218\ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."]),!1):e.startFieldCid==e.endFieldCid?($.goSlideMessage(p["\uc2dc\uc791\ub0a0\uc9dc\uc640 \uc885\ub8cc\ub0a0\uc9dc\uac00 \ub3d9\uc77c\ud558\uc5ec \ub370\uc774\ud130\ub97c \ud45c\uc2dc\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1):!0},_createGanttView:function(){var t=this,n=this._getFieldSettingFromPopup(),r=this._validateFieldSetting(n);r&&$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:e.contextRoot+"api/works/applets/"+this.appletId+"/ganttview",data:JSON.stringify(n),success:function(n){e.router.navigate("works/applet/"+t.appletId+"/gantt",!0),$.goSlideMessage(e.i18n(p["\ucd5c\uc801\ud654\ub41c \uac04\ud2b8 \ubdf0 \uc0ac\uc6a9\uc744 \uc704\ud574 \ub9e4\ud551\ud55c \ucef4\ud3ec\ub10c\ud2b8\uc758 \ucd5c\uadfc \ub4f1\ub85d \ub370\uc774\ud130 \uae30\uc900\uc73c\ub85c {{arg0}}\uac1c\uae4c\uc9c0\ub9cc \uadf8\ub824\uc9d1\ub2c8\ub2e4."],{arg0:c.GANTT_VIEW_DOC_NODE_MAX_COUNT}))},error:function(n){e.router.navigate("works/applet/"+t.appletId+"/home",!0),$.goAlert(n.responseJSON.message)}})},_onClickToggleNodes:function(e){this.listView.onClickToggleNodes(e)},_onClickGroupAdd:function(e){this.listView.onClickAddGroup(e)},_onClickSortableToggle:function(e){this.listView.onClickSortableToggle(e)},_onClickBringDocNodes:function(){if(this.$el.find("#totalDocNodeCount").text()>=c.GANTT_VIEW_DOC_NODE_MAX_COUNT)return $.goConfirm(e.i18n(p["\uac04\ud2b8 \ubdf0\uc5d0\uc11c \ubcfc \uc218 \uc788\ub294 \ub370\uc774\ud130\uc758 \uac1c\uc218\ub294 \ucd5c\ub300 {{arg0}}\uac1c \uc785\ub2c8\ub2e4."],{arg0:c.GANTT_VIEW_DOC_NODE_MAX_COUNT})+" "+p["\uc774\ubbf8 \ucd94\uac00\ud55c \ub370\uc774\ud130\ub97c \uc81c\uac70\ud55c \ud6c4 [\ub370\uc774\ud130 \ubd88\ub7ec\uc624\uae30]\ub97c \uc774\uc6a9\ud574 \uc8fc\uc138\uc694."]);this.popupView=$.goPopup({pclass:"layer_normal layer_app_search",header:p["\ub370\uc774\ud130 \ubd88\ub7ec\uc624\uae30"],buttons:[{btext:h["\ub2eb\uae30"]}]});var t=new u({model:this._getModelForSelfIntegration(),docs:this._getDocsForSelfIntegration(),fieldsOfIntegrationApp:this.fields,selfIntegration:!0,pageSize:10});this.popupView.find("div.content").html(t.render().el),this.popupView.on("onClickListItem",$.proxy(function(e,t){this._addDocNode(t)},this)),t.on("rendered:appletDocSearch",_.bind(this.popupView.reoffset))},_getModelForSelfIntegration:function(){var e=new Backbone.Model;e.set("integrationFieldCid",this.ganttViewModel.get("titleFieldCid")),e.set("integrationAppletId",this.appletId);var t=[];return t.push({cid:this.ganttViewModel.get("titleFieldCid")}),t.push({cid:this.ganttViewModel.get("startFieldCid")}),t.push({cid:this.ganttViewModel.get("endFieldCid")}),e.set("selectedDisplayFields",t),e},_getDocsForSelfIntegration:function(){return new o([],{type:"base",appletId:this.appletId,referAppletId:this.appletId,fieldCid:this.ganttViewModel.get("titleFieldCid")})},_addDocNode:function(t){var n=this;$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:e.contextRoot+"api/works/applets/"+this.appletId+"/ganttview/doc/"+t.id,success:function(e){n._renderListAndGraphView(),$("#gantt_list_config").scrollTop($("#gantt_list_config")[0].scrollHeight),$.goSlideMessage(h["\ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(e){$.goError(e.responseJSON.message)}})},_showToday:function(){this.graphView.showToday()},_toggleListView:function(){var e=this.$el.find("#gantt_list");e.css("display")=="none"?(this.$el.find(".btn_gantt_unfold").hide(),this.$el.find(".btn_gantt_fold").show(),e.show(),this.$el.find(".gantt_tool_bar .critical").show()):(this.$el.find(".btn_gantt_fold").hide(),this.$el.find(".btn_gantt_unfold").show(),e.hide(),this.$el.find(".gantt_tool_bar .critical").hide()),this.graphView.renderBookmarks()}})});