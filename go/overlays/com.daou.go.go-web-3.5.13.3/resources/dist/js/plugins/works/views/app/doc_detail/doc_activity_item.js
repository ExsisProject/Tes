define("works/views/app/doc_detail/doc_activity_item",function(require){function c(){this.contentViewer=s.init({$el:this.$("#activityContent"),content:this.model.get("content")})}function h(e){var t=this,n=e?"viewModeAttachArea":"editModeAttachArea",r=null;e?r=i.create(null,this.model.get("attaches"),function(e){return GO.contextRoot+"api/works/activity/"+t.model.id+"/download/"+e.id}):r=i.create(null,this.model.get("attaches"),null,"edit"),r.done(function(r){t.$("#"+n).replaceWith(r.el),r.$el.addClass(e?"feed origin":""),r.$el.attr({id:n,"data-type":e?"view":""})})}function p(e){var t=this,e={el:"#file-control-activity-"+this.model.get("id"),context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+a.attach+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie")},i=parseInt(GO.config("commonAttachConfig").maxAttachSize),s=i*1024*1024,o=parseInt(GO.config("commonAttachConfig").maxAttachNumber);(new r(e)).queue(function(e,t){}).start(function(e,r){if(!GO.config("attachFileUpload"))return $.goAlert(n["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1;if(t.isSaaS){if(s<r.size)return $.goMessage(GO.i18n(n["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",i)),!1;t.totalAttachSize+=r.size;var u=$("#editModeAttachArea").find("li").size()+t.totalAttachCount+1;if(o<u)return $.goMessage(GO.i18n(n["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",o)),!1;t.totalAttachCount++}}).progress(function(e,t){}).success(function(e,n,r){var i=GO.util.isImage(n.data.fileExt),s=t.$("#editModeAttachArea"),o=i?"ul.img_wrap":"ul.file_wrap";r.attr("data-hostId",n.data.hostId),r.attr("data-size",n.data.fileSize);if(GO.util.fileUploadErrorCheck(n))r.find(".item_file").append("<strong class='caution'>"+GO.util.serverMessage(n)+"</strong>"),r.addClass("attachError");else if(GO.util.isFileSizeZero(n))return $.goAlert(GO.util.serverMessage(n)),!1;s.find(o).show().append(r),t.resetAttachSizeAndCount()}).complete(function(e,t){}).error(function(e,r){r.jqXHR&&(r.jqXHR.statusText=="abort"?$.goAlert(n["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):$.goAlert(n["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."]),t.resetAttachSizeAndCount())})}function d(e){$("#"+this.editorId).goWebEditor({contextRoot:GO.config("contextRoot"),lang:GO.session("locale"),editorValue:e}),this.editor=GO.Editor}var e=require("hgn!works/templates/app/doc_detail/doc_activity_item"),t=require("i18n!task/nls/task"),n=require("i18n!nls/commons"),r=require("file_upload"),i=require("attach_file"),s=require("content_viewer"),o=require("comment"),u=require("views/profile_card");require("go-webeditor/jquery.go-webeditor"),require("jquery.go-preloader");var a={commentWrite:t["\ub313\uae00\uc4f0\uae30"],edit:n["\uc218\uc815"],attach:n["\ud30c\uc77c \ucca8\ubd80"],save:n["\uc800\uc7a5"],cancel:n["\ucde8\uc18c"],count:t["\uac1c"],comment:n["\ub313\uae00"],showAll:t["\ubaa8\ub450 \ubcf4\uae30"],fold:n["\uc811\uae30"]},f=!1,l=Backbone.View.extend({initialize:function(e){this.model=e.model,this.appletId=e.appletId,this.docId=e.docId,this.model.set("appletId",this.appletId),this.model.set("docId",this.docId),this.editorId="activityEditor"+this.model.get("id"),this.isSaaS=GO.session().brandName=="DO_SAAS",this.totalAttachSize=0,this.totalAttachCount=0},tagName:"li",events:{"click span.ic_del":"attachDelete","click #editActivity":"showEditForm","click #closeEditorBnt":"closeEditForm","click #deleteActivity":"confirmDelete","click #editActivityBtn":"submitActivity","click #showAllComment":"showAllComment","click #foldComment":"foldComment","click a[data-userid]":"showProfileCard","click span[data-tag=profile]":"showProfileCard"},render:function(){var t=this;this.$el.html(e({lang:a,data:this.model.toJSON(),snsDate:{date:GO.util.snsDate(this.model.modifyTime()),modifyFlag:this.model.isModify()},commentCount:this.model.get("commentCount"),commentPresent:this.model.commentPresent(),isDisplayComment:this.model.commentPresent(),hasMoreComment:this.model.hasMoreComment(),content:this.model.get("content")})),c.call(this),h.call(this,!0),this.commentView=o.init({el:this.$el.find("#activityReply"),typeUrl:"works/activity",typeId:this.model.get("id"),isPrintMode:!1,rootId:this.model.get("id"),rootUrl:"works/activity",isReply:!1,isWritable:!0}),this.commentView.render(),this.commentView.setComments(this.model.get("comments")),this.commentView.renderList(),this.$el.on("comment:change",function(e,n,r){var i=r>3;t.$("#foldComment").toggle(i),t.$("#showAllComment").hide(),t.$("span.num").text(r?r:"")})},getContent:function(){var e=this.editor.getInstance(this.editorId).getContent();return e==""||$.trim(e)=="<br>"?"":e},attachDelete:function(e){$(e.target).parents("li[data-name]").hide()},showEditForm:function(){var e=this.contentViewer.getContent();this.editor?this.editor.getInstance(this.editorId).setContent(e):(d.call(this,e),p.call(this)),this.$el.find("div[data-type=edit]").show(),this.$el.find("div[data-type=view]").hide(),h.call(this,!1),this.contentViewer.hide()},submitActivity:function(){if(!GO.Editor.getInstance(this.editorId).validate())return $.goError(n["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=this,t=this.model.get("attaches").length,r=this.getContent();if(f)return;f=!0,this.model.set({content:r,attaches:this.getAttaches()}),this.model.save({},{success:function(n){e.$el.trigger("change:log"),e.trigger("change:attach",n.get("attaches").length-t),e.contentViewer.setContent(n.get("content")),e.contentViewer.render(),e.closeEditForm(),f=!1,h.call(e,!0)},complete:function(){},error:function(e,t){f=!1,$.goError(t.responseJSON.message)}})},closeEditForm:function(){this.$el.find("div[data-type=edit]").hide(),this.$el.find("div[data-type=view]").show(),this.$el.find("div.tool_bar").css("display",""),this.contentViewer.show(),this.editor.getInstance(this.editorId).setContent(" "),this.$el.find("#editModeFileWrap").find("li:hidden").show(),h.call(this,!0)},getAttaches:function(){var e=[];return _.each(this.$el.find("#editModeAttachArea").find("li:not(.attachError)"),function(t){if($(t).is(":hidden")){$(t).remove();return}e.push({id:$(t).attr("data-id")||null,path:$(t).attr("data-path"),name:$(t).attr("data-name"),hostId:$(t).attr("data-hostId")})}),e},confirmDelete:function(){var e=this;$.goPopup({title:t["\ud65c\ub3d9\uae30\ub85d \uc0ad\uc81c"],message:t["\ud65c\ub3d9\uae30\ub85d \uc0ad\uc81c \uc124\uba85"],buttons:[{btype:"confirm",btext:n["\ud655\uc778"],callback:function(){e.destroyActivity()}},{btext:n["\ucde8\uc18c"],callback:function(){}}]})},destroyActivity:function(){var e=this,t=this.model.get("attaches").length;this.model.destroy({success:function(){e.$el.trigger("change:log"),e.trigger("change:attach",0-t),e.trigger("change:activity",!0),e.$el.remove()},error:function(e,t){$.goError(t.responseJSON.message)}})},showAllComment:function(){if(this.commentView.isAll)this.$("#activityReply").find("li").show(),this.$("#foldComment").show(),this.$("#showAllComment").hide();else{var e=this;this.commentView.fetchComments(!0).done(function(t){t.data.length>3&&e.$("#foldComment").show(),e.$el.find("#showAllComment").hide(),e.commentView.isAll=!0})}},foldComment:function(){var e=this.commentView.collection.length-3;this.$("#activityReply").find("li:lt("+e+")").hide(),this.$("#foldComment").hide(),this.$("#showAllComment").show()},showProfileCard:function(e){var t=$(e.currentTarget).attr("data-userid");u.render(t,e.currentTarget)},getViewedTotalAttachSize:function(e){var t=0;return $(e).find("li").each(function(e,n){t+=parseInt(n.getAttribute("data-size"),0)}),t},resetAttachSizeAndCount:function(){this.isSaaS&&(this.totalAttachSize=0,this.totalAttachCount=0)}});return l});