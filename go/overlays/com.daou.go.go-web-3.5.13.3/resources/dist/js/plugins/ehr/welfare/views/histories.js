(function(){define(["backbone","app","hgn!welfare/templates/histories","i18n!welfare/nls/welfare","i18n!nls/commons","welfare/views/title","jquery.go-grid"],function(e,t,n,r,i,s){var o={"\uc774\ub984":i["\uc774\ub984"],"\ubd80\uc11c\uba85":i["\ubd80\uc11c\uba85"],"\uc0ac\uc6a9\uc77c":r["\uc0ac\uc6a9\uc77c"],"\uc0ac\uc6a9 Point":r["\uc0ac\uc6a9 Point"],"\ubd84\ub958":r["\ubd84\ub958"],"\uac70\ub798\ucc98":r["\uac70\ub798\ucc98"],"\ubcf5\uc9c0\ud3ec\uc778\ud2b8 \ub370\uc774\ud130 \uc5c6\uc74c":r["\ubcf5\uc9c0\ud3ec\uc778\ud2b8 \ub370\uc774\ud130 \uc5c6\uc74c"],"\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc":i["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"]},u=e.View.extend({events:{"click #preDate":"preDate","click #nextDate":"nextDate","click #calArea":"showCalendar","keyup #searchKeyword":"enterSearch","click #searchBtn":"clickSearch","click #xlsxDownBtn":"xlsxDownload"},initialize:function(){this.$el.off()},render:function(){var e=t.util.toMoment(),r=t.util.shortDateMonth(e),i=t.util.calDate(r,"months",-1),u=t.util.calDate(r,"months",1);return this.$el.html(n({lang:o,searchDate:r,preDate:t.util.customDate(i,"YYYY-MM"),nextDate:t.util.customDate(u,"YYYY-MM")})),this.$el.find("header.content_top").html((new s).render("\uc804\uc0ac \ubcf5\uc9c0\ud3ec\uc778\ud2b8").el),this.renderList(),this.initDatePicker(),this.initSearchDatePicker(),this},renderList:function(){var e=t.contextRoot+"api/ehr/welfare/histories",n=this;this.list=$.goGrid({el:this.$el.find("#welfare_list"),method:"GET",destroy:!0,url:e,params:this.getParam(),emptyMessage:"<p class='data_null'> <span class='ic_data_type ic_no_data'></span><span class='txt'>"+o["\ubcf5\uc9c0\ud3ec\uc778\ud2b8 \ub370\uc774\ud130 \uc5c6\uc74c"]+"</span>"+"</p>",checkbox:!0,defaultSorting:[[2,"desc"]],columns:[{mData:"userName",sWidth:"130px",sClass:"",bSortable:!1,fnRender:function(e){var t=e.aData;return t.userName}},{mData:"deptName",sWidth:"130px",sClass:"",bSortable:!1},{mData:"eventDate",sWidth:"130px",sClass:"",bSortable:!1},{mData:null,sWidth:"130px",sClass:"money",bSortable:!1,fnRender:function(e){return t.util.numberWithCommas(e.aData.usedPoint)}},{mData:null,sWidth:"130px",sClass:"",bSortable:!1,fnRender:function(e){var t=e.aData;return t.description==null?"":t.description}},{mData:"title",sWidth:"130px",sClass:"",bSortable:!1}],fnDrawCallback:function(e,t,r){$(window).scrollTop(0),$($("div.tool_bar")[0]).addClass("calendar_tool_bar");var i=$($("div.tool_bar")[0]);i.prepend($("#excel_download_area").show()),i.append($("#dateBtns").show()),n.list.tables.find("tbody .money").attr("style","text-align : right !important"),n.list.tables.find("tbody tr td:first-child").attr("style","text-align : center!important"),$("div.custom_bottom").css({height:"1px"})}})},xlsxDownload:function(){var e=t.contextRoot+"api/ehr/welfare/histories/download",n=this.$el.find("#searchDate").attr("data-date"),r=t.util.toMoment(n).startOf("years").format("YYYY-MM-DD"),i=t.util.toMoment(n).endOf("years").format("YYYY-MM-DD"),s={offset:9999999,page:0,property:"eventDate",direction:"desc",startDate:r,endDate:i};window.location.href=e+"?"+$.param(s)},enterSearch:function(e){if(e.keyCode!="13")return;this.search()},clickSearch:function(){this.search()},search:function(){var e=this.$el.find("#searchStartDate").val(),t=this.$el.find("#searchEndDate").val(),n=this.$el.find("#searchTypes").val(),r=this.$el.find("#searchKeyword").val();this.reloadList(e,t,n,r)},getParam:function(){var e=this.$el,t=this.$el.find("#searchDate").data("date"),n={};return n.deptId=this.deptId,$.extend(n,this.getMonthOfStartAndEnd(t)),n},getMonthOfStartAndEnd:function(e){var n=t.util.toMoment(e);return{startDate:t.util.customDate(n.startOf("months"),"YYYY-MM-DD"),endDate:t.util.customDate(n.endOf("months"),"YYYY-MM-DD")}},preDate:function(e){var t=$(e.currentTarget);this.changeMonth(t.attr("data-date"))},nextDate:function(e){var t=$(e.currentTarget);this.changeMonth(t.attr("data-date"))},reloadList:function(e,t,n,r){this.list.tables.customParams={searchField:n,keyword:r,startDate:e,endDate:t,deptId:this.deptId},this.list.tables.fnClearTable()},showCalendar:function(){this.$el.find("#calBtn").focus()},initDatePicker:function(){var e=this.$el.find("#calBtn");$.datepicker.setDefaults($.datepicker.regional[t.config("locale")]),e.datepicker({dateFormat:"yy-mm",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:$.proxy(function(e){this.changeMonth(e+"")},this)})},changeMonth:function(e){$("#preDate").attr("data-date",t.util.formatDatetime(t.util.calDate(e,"months",-1),null,"YYYY-MM")),$("#searchDate").attr("data-date",t.util.formatDatetime(e,null,"YYYY-MM")),$("#searchDate").text(t.util.formatDatetime(e,null,"YYYY-MM")),$("#nextDate").attr("data-date",t.util.formatDatetime(t.util.calDate(e,"months",1),null,"YYYY-MM"));var n=t.util.toMoment(e),r=t.util.customDate(n.startOf("months"),"YYYY-MM-DD"),i=t.util.customDate(n.endOf("months"),"YYYY-MM-DD");this.reloadList(r,i)},initSearchDatePicker:function(){var e=this.$el.find("#searchStartDate"),n=t.util.now(),r=n.startOf("months").format("YYYY-MM-DD"),i=n.endOf("months").format("YYYY-MM-DD");e.val(r),$.datepicker.setDefaults($.datepicker.regional[t.config("locale")]),e.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){s.datepicker("option","minDate",e)}});var s=this.$el.find("#searchEndDate");s.val(i),s.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",minDate:r})}});return u})})();