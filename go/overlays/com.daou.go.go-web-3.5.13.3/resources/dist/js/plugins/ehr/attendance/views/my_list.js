define(["backbone","app","attendance/collections/records","attendance/models/record","attendance/models/auth","attendance/views/title","attendance/views/statusPopup","attendance/views/attndInfoPopup","attendance/views/attndDeleteStatusTerm","hgn!attendance/templates/list","hgn!attendance/templates/item","hgn!attendance/templates/toolbar","hgn!attendance/templates/log_item","i18n!nls/commons","i18n!attendance/nls/attendance"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v={label_confirm:p["\ud655\uc778"],label_cancel:p["\ucde8\uc18c"],label_delete:p["\uc0ad\uc81c"],label_status:p["\uc0c1\ud0dc"],label_select:p["\uc120\ud0dd"],label_contents:p["\ub0b4\uc6a9"],label_collapse:p["\uc811\uae30"],label_expand:p["\ud3bc\uce58\uae30"],label_manage:p["\uad00\ub9ac"],label_prev:p["\uc774\uc804"],label_next:p["\ub2e4\uc74c"],label_today:p["\uc624\ub298"],label_attendance:d["\ucd9c\uadfc\ubd80"],label_clockInTime:d["\ucd9c\uadfc"],label_clockOutTime:d["\ud1f4\uadfc"],label_status:d["\uc0c1\ud0dc"],label_workingTime:d["\uadfc\ubb34\uc2dc\uac04"],label_unconfirm:d["\ubbf8\ud655\uc778"],label_completeInTime:d["\ucd9c\uadfc\uc644\ub8cc"],label_completeOutTime:d["\ud1f4\uadfc\uc644\ub8cc"],label_deptManage:d["\ubd80\uc11c\ubcc4 \uadfc\ud0dc\uad00\ub9ac"],label_compManage:d["\uc804\uc0ac \uadfc\ud0dc\uad00\ub9ac"],label_attndStatus:d["\uadfc\ud0dc\ud604\ud669"],label_attndStatistics:d["\uadfc\ud0dc\ud1b5\uacc4"],label_myAttendance:d["\ub0b4 \uadfc\ud0dc"],label_myAttendanceStatus:d["\ub0b4 \uadfc\ud0dc \ud604\ud669"],label_manageAttendance:d["\uadfc\ud0dc \uad00\ub9ac"],label_date:d["\ub0a0\uc9dc"],label_time:d["\uc2dc\uac04"],label_statusDesc:d["\uc0c1\ud0dc\uc5d0 \ub300\ud55c \uac04\ub2e8\ud55c \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."],label_listDownload:d["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],label_normal:d["\uc815\uc0c1"],label_late:d["\uc9c0\uac01"],label_modify:d["\uc218\uc815"],label_actionLogs:p["\ubcc0\uacbd\uc774\ub825"],label_more:p["\ub354\ubcf4\uae30"],label_attndInfo:d["\uc704\uce58 \uc815\ubcf4"],label_allNight:d["\ucca0\uc57c"],label_delete_status_term:d["\uc0c1\ud0dc\uc77c\uad04\uc0ad\uc81c"]},m=e.View.extend({events:{"click #attndMyList td span.ic_gps":"showAttndInfo","click #attndMyList td.status":"addStatus","click #attndMyList td.status li":"modifyStatus","click #attndMyList td.valid":"addInOut","click #attndMyList td.go span.none":"addInOut","click #attndMyList td.leave span.none":"addInOut","click #attndMyList td.go span.time":"modifyInOut","click #attndMyList td.leave span.time":"modifyInOut","click #prevMonth":"movePrevMonth","click #nextMonth":"moveNextMonth","click #todayMonth":"moveTodayMonth","click #attndCalBtn":"clickCalendar","click #moveBack":"moveBack","click #attndMyList th span":"sortBy","click #attndListDownload":"listDownload","click #attndStatusDeleteTerm":"deleteStatusTerm","click #moreLog":"moreLog"},initialize:function(s){this.options=s||{},this.options.userid?this.userid=this.options.userid:this.userid=GO_Session.id,this.month=moment(),this.auth=new i({userid:this.userid}),this.auth.fetch({async:!1}),this.records=new n({month:this.month,userid:this.userid}),this.records.remove(0),this.records.fetch({async:!1}),this.records.getRecords(),this.logs=new e.Collection,this.logs.url=t.contextRoot+"api/ehr/attnd/user/"+this.userid+"/month/"+this.month.format("YYYY-MM")+"/actionlog",this.logs.fetch({async:!1}),this.userInfo=new e.Model,this.userInfo.url=t.contextRoot+"api/user/profile/"+this.userid,this.userInfo.fetch({async:!1}),this.recordGroup=new r,this.recordGroup.fetch({url:t.contextRoot+"api/ehr/attnd/record",async:!1});var o=this;t.EventEmitter.off("attnd","change:clockInOutStatus"),t.EventEmitter.on("attnd","change:clockInOutStatus",function(){this.records=new n({month:this.month,userid:this.userid}),this.records.fetch({async:!1}),this.records.getRecords(),this.sortRender(),this.$el.find("#attendActivityLogs ul.type_simple_list").empty(),this.logs.url=t.contextRoot+"api/ehr/attnd/user/"+this.userid+"/month/"+this.month.format("YYYY-MM")+"/actionlog",this.logs.fetch({async:!1}),this.renderActivityLogs()},this)},listDownload:function(){var e={month:this.month.format("YYYY-MM"),userid:this.userid};window.location.href=t.contextRoot+"api/ehr/attnd/download/record?"+$.param(e)},deleteStatusTerm:function(){var e=this;this.popupEl=$.goPopup({header:v.label_delete_status_term,lang:v,modal:!0,pclass:"layer_normal layer_go_status",contents:"",buttons:[{btype:"caution",btext:v.label_delete,autoclose:!1,callback:function(){var t=e.popupEl.find("#AttendStatusSelect option:selected"),n=t.attr("data-id");_.isNull(n)||_.isUndefined(n)?$.goMessage(d["\uc0c1\ud0dc\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]):(e.popupEl.close(),r.deleteStatusTermReqest())}},{btype:"close",btext:v.label_cancel,autoclose:!0,callback:function(){}}]});var t=this.month.format("YYYY-MM-01"),n={firstDate:this.records.getByLogDate(t),userid:this.userid},r=new a(n);this.popupEl.find("div.content").html(r.render().el)},moveBack:function(){window.history.back()},clickCalendar:function(){$("#calendarDatepicker").trigger("focus")},sortBy:function(e){var t=$(e.currentTarget),n=t.attr("sort-data"),r=this.records.sortBy(function(e){return n=="clockInTime"||n=="clockOutTime"?e.get(n)!=null?e.get(n).split("T")[1]:"":e.get(n)});t.attr("sort-direction")=="asc"?(t.closest("th").hasClass("sorting_asc")&&t.closest("th").removeClass("sorting_asc").addClass("sorting_desc"),t.attr("sort-direction","desc")):(t.closest("th").hasClass("sorting_desc")&&t.closest("th").removeClass("sorting_desc").addClass("sorting_asc"),t.attr("sort-direction","asc"));if(n=="logDate")t.attr("sort-direction")=="desc"&&r.reverse(),this.records.reset(r);else{var i=[],s=[];_.each(r,function(e){e.get("id")?i.push(e):s.push(e)},this);var o=[],u=[];_.each(i,function(e){e.get(n)?o.push(e):u.push(e)},this),t.attr("sort-direction")=="desc"&&o.reverse();var a=$.merge(o,u),f=$.merge(a,s);this.records.reset(f)}this.$el.find("#attndMyList tbody").empty(),this.renderItems()},sortRender:function(){var e=this.records.sortBy(function(e){return e.get("logDate")}),t=_.map(e,function(e){return e.cid}),n=[];_.each(t,function(e){n.push(_.findWhere(this.records.models,{cid:e}))},this),this.records.reset(n),this.$el.find("#attndMyList tbody").empty(),this.renderItems()},initDatePicker:function(){var e=this;$.datepicker.setDefaults($.datepicker.regional[t.config("locale")]),this.$el.find("#calendarDatepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(t){e.month=moment(t),e.records=new n({month:e.month,userid:e.userid}),e.records.remove(0),e.records.fetch({async:!1}),e.records.getRecords(),e.render()}}),$("#moveBack").hide()},movePrevMonth:function(){this.month.subtract(1,"month"),this.records=new n({month:this.month,userid:this.userid}),this.records.remove(0),this.records.fetch({async:!1}),this.records.getRecords(),this.render(),this.logs.url=t.contextRoot+"api/ehr/attnd/user/"+this.userid+"/month/"+this.month.format("YYYY-MM")+"/actionlog",this.logs.fetch({async:!1}),this.$el.find("#attendActivityLogs ul.type_simple_list").empty(),this.renderActivityLogs(),$("#moveBack").hide()},moveNextMonth:function(){this.month.add(1,"month"),this.records=new n({month:this.month,userid:this.userid}),this.records.remove(0),this.records.fetch({async:!1}),this.records.getRecords(),this.render(),this.logs.url=t.contextRoot+"api/ehr/attnd/user/"+this.userid+"/month/"+this.month.format("YYYY-MM")+"/actionlog",this.logs.fetch({async:!1}),this.$el.find("#attendActivityLogs ul.type_simple_list").empty(),this.renderActivityLogs(),$("#moveBack").hide()},moveTodayMonth:function(){this.month=moment(),this.records=new n({month:this.month,userid:this.userid}),this.records.remove(0),this.records.fetch({async:!1}),this.records.getRecords(),this.render(),this.logs.url=t.contextRoot+"api/ehr/attnd/user/"+this.userid+"/month/"+this.month.format("YYYY-MM")+"/actionlog",this.logs.fetch({async:!1}),this.$el.find("#attendActivityLogs ul.type_simple_list").empty(),this.renderActivityLogs(),$("#moveBack").hide()},addInOut:function(e){var t=this,n=$(e.currentTarget),r=n.closest("tr").attr("data-item-date"),i=n.closest("td").attr("data-type");if((n.hasClass("none")||n.find("span").hasClass("none"))&&!this.auth.hasTimeEditAuth())return;var s={record:this.records.getByLogDate(r),action:"create",type:"inout",option:i,userid:this.userid};if(s.record.isAfter()&&!s.record.isToday())return;if(i=="in"&&s.record.getUserClockInTime()||0)return;if(i=="out"&&s.record.getUserClockOutTime()||0)return;var u=i=="in"?v.label_clockInTime:v.label_clockOutTime;this.popupEl=$.goPopup({header:u,lang:v,modal:!0,pclass:"layer_normal layer_go_status",contents:"",buttons:[{btype:"confirm",btext:v.label_confirm,autoclose:!1,callback:function(){a.addInOut(),t.popupEl.close()}},{btype:"close",btext:v.label_cancel,autoclose:!0,callback:function(){}}]});var a=new o(s);this.popupEl.find("div.content").html(a.render().el)},modifyInOut:function(e){e.stopPropagation();if(!this.auth.hasTimeEditAuth())return;var t=this,n=$(e.currentTarget),r=n.closest("tr").attr("data-item-date"),i=n.attr("status-id"),s=n.closest("td").attr("data-type");n.attr("data-type")=="allNight"&&(s="out");var u={record:this.records.getByLogDate(r),action:"modify",type:"inout",option:s,userid:this.userid,recordGroup:this.recordGroup},a=s=="in"?v.label_clockInTime:v.label_clockOutTime;this.popupEl=$.goPopup({header:a,lang:v,modal:!0,pclass:"layer_normal layer_go_status",contents:"",buttons:[{btype:"confirm",btext:v.label_confirm,autoclose:!1,callback:function(){f.modifyInOut(),t.popupEl.close()}},{btype:"caution",btext:v.label_delete,autoclose:!0,callback:function(){f.deleteInOut(),t.popupEl.close()}},{btype:"close",btext:v.label_cancel,autoclose:!0,callback:function(){}}]});var f=new o(u);this.popupEl.find("div.content").html(f.render().el)},addStatus:function(e){if(!this.auth.hasStatusEditAuth())return;var t=this;this.popupEl=$.goPopup({header:v.label_status,lang:v,modal:!0,pclass:"layer_normal layer_go_status",contents:"",buttons:[{btype:"confirm",btext:v.label_confirm,autoclose:!1,callback:function(){i.addStatus(),t.popupEl.close()}},{btype:"close",btext:v.label_cancel,autoclose:!0,callback:function(){}}]});var n=$(e.currentTarget).closest("tr").attr("data-item-date"),r={record:this.records.getByLogDate(n),action:"create",type:"status",userid:this.userid,recordGroup:this.recordGroup},i=new o(r);this.popupEl.find("div.content").html(i.render().el)},modifyStatus:function(e){e.stopPropagation();if(!this.auth.hasStatusEditAuth())return;var t=this,n=$(e.currentTarget),r=n.closest("tr").attr("data-item-date"),i=n.attr("status-id"),s=n.attr("data-id");if(n.attr("data-type")=="allNight"){this.modifyInOut(e);return}var u={record:this.records.getByLogDate(r),action:"modify",type:"status",option:s,userid:this.userid,recordGroup:this.recordGroup},a=new o(u);this.popupEl=$.goPopup({header:v.label_status,lang:v,modal:!0,pclass:"layer_normal layer_go_status",contents:"",buttons:[{btype:"confirm",btext:v.label_confirm,autoclose:!1,callback:function(){a.modifyStatus(),t.popupEl.close()}},{btype:"caution",btext:v.label_delete,autoclose:!0,callback:function(){a.deleteStatus(),t.popupEl.close()}},{btype:"close",btext:v.label_cancel,autoclose:!0,callback:function(){}}]}),this.popupEl.find("div.content").html(a.render().el)},showAttndInfo:function(e){e.stopPropagation();var t=$(e.currentTarget),n=t.closest("tr").attr("data-item-date"),r=t.closest("td").attr("data-type"),i={record:this.records.getByLogDate(n),action:"attndinfo",option:r},s=new u(i);this.popupEl=$.goPopup({header:v.label_attndInfo,lang:v,modal:!0,width:304,pclass:"layer_normal layer_attend_gps",contents:"",buttons:[{btype:"confirm",btext:v.label_confirm,autoclose:!0,callback:function(){}}]}),this.popupEl.find("div.content").html(s.render().el)},render:function(){this.$el.html(f({lang:v}));var e=new s;return this.$el.find("header.content_top").html(e.render("\uadfc\ud0dc\ud604\ud669").el),this.renderHeader(),this.initDatePicker(),this.renderActivityLogs(),this.sortRender(),$("body").trigger("ehr.myListRender"),this},renderHeader:function(){var e=c({lang:v,month:this.month.format("YYYY.MM"),isDeleteStatus:this.auth.hasStatusEditAuth(),isManage:this.options.userid||0?!0:!1,name:this.userInfo.get("name"),info:this.userInfo.get("deptMembers")[0]});this.$el.find("section#attndToolbar").html(e)},renderItems:function(){var e=this;this.records.each(function(n){e.$el.find("#attndMyList tbody").append(l({lang:v,record:n,hasTimeEditAuth:e.auth.hasTimeEditAuth(),hasStatusEditAuth:e.auth.hasStatusEditAuth(),isHoliday:n.isHoliday(),isClockInTimeEdited:n.isClockInTimeEdited(),isClockOutTimeEdited:n.isClockOutTimeEdited(),isLate:n.isLate(),isBefore:n.isBefore(),isAfter:n.isAfter(),hasDateStatus:n.hasDateStatus(),isToday:n.isToday(),isSunday:n.isSunday(),isSatday:n.isSatday(),isDayOff:n.isDayOff(),workingTime:n.getUserWorkingTime(),formattedLogDate:n.getLogDateMMddDD(),logDate:n.getLogDate(),userClockInTime:n.getUserClockInTime(),userClockOutTime:n.getUserClockOutTime(),hasUserClockInTime:n.hasUserClockInTime(),hasUserClockOutTime:n.hasUserClockOutTime(),isUseGPS:t.config("mobileConfig").useAttndRecordGps,hasId:n.hasId(),statuses:function(){var e=n.getStatuses();return _.each(e,function(e,t,n){e.companyStatus.type=="time"&&(e.formattedTime=moment(e.startDate).zone(e.startDate).format("HH:mm")+"~"+moment(e.endDate).zone(e.startDate).format("HH:mm")),t==n.length-1&&(e.isLast=!0)},this),e}}))})},renderActivityLogs:function(){var e=this;this.$el.find("header.single_title span.num").text(this.logs.page.total),_.each(this.logs.models,function(e){var n=h({lang:v,log:e.toJSON(),messages:e.get("message").split("\n"),date:t.util.basicDate(e.get("createdAt"))});this.$el.find("section#attendActivityLogs ul.type_simple_list").append(n)},this),this.isEnd()?this.$el.find("#moreLog").hide():this.$el.find("#moreLog").show(),this.logs.models.length==0?this.$el.find("#attendActivityLogs").hide():this.$el.find("#attendActivityLogs").show()},moreLog:function(e){var n=this,r=this.logs.page.page+1;this.logs.url=t.contextRoot+"api/ehr/attnd/user/"+this.userid+"/month/"+this.month.format("YYYY-MM")+"/actionlog?"+$.param({page:r}),this.logs.fetch({success:function(e){n.renderActivityLogs()}})},isEnd:function(){return this.$el.find("#attendActivityLogs").find("li").length==this.logs.page.total}});return m});