define("timeline/views/user/history_popup",function(require){var e=require("backbone"),t=require("app"),n=require("hgn!timeline/templates/user/history_popup_form"),r=require("i18n!nls/commons"),i=require("i18n!timeline/nls/timeline"),s=require("timeline/models/history");require("jquery.go-popup");var o=e.View.extend({initialize:function(){this.targetUserId=this.options.targetUserId,this.dayInfo=this.options.dayInfo,this.historyId=this.options.historyId,this.data=this.options.data,this.isNew=_.isUndefined(this.data.id)?!0:!1,console.log("day info : "+this.dayInfo+" userId : "+this.targetUserId)},render:function(){function o(){var t=[];return this.isNew||t.push({btext:r["\uc0ad\uc81c"],btype:"btn_caution_s",callback:_.bind(function(t){e.delete()},this)}),t.push({btext:r["\uc800\uc7a5"],btype:"confirm",callback:_.bind(function(t){e.save()},this)},{btext:r["\ucde8\uc18c"],btype:"cancel",callback:function(e){s.close()}}),t}var e=new h({targetUserId:this.targetUserId,dayInfo:this.dayInfo,data:this.data}),t=o.call(this),n=this.isNew?i["\uc0c1\ud0dc \ub4f1\ub85d"]:i["\uc0c1\ud0dc \uc0c1\uc138"],s=$.goPopup({header:n,pclass:"layer_normal layer_attend_status",modal:!0,contents:e.$el,buttons:t});e.render(),s.reoffset()}}),u=e.Collection.extend({url:t.contextRoot+"api/timeline/status"}),a=24,f=60,l=_.range(0,a).map(function(e){return e<10?"0"+e:e}),c=_.range(0,f).map(function(e){return e<10?"0"+e:e}),h=e.View.extend({events:{"click #isNightWork":"showNightWorkDescription"},initialize:function(){this.targetUserId=this.options.targetUserId,this.dayInfo=this.options.dayInfo,this.collection=new u,this.collection.fetch().done(_.bind(this.render,this)),this.model=new s(_.extend(this.options.data,{targetUserId:this.targetUserId,baseDate:this.dayInfo.day}))},render:function(){var e=this;this.$el.html(n({CommonLang:r,TimelineLang:i,data:this.model.toJSON(),isNew:this.model.isNew(),status:this.collection.toJSON(),HOUR:l,MINUTE:c,isSelected:function(){return e.model.isNew()?!1:e.model.getStatusId()==this.id},isCheckTimeHour:function(){return e.model.isCheckTimeHour(this)},isCheckTimeMinute:function(){return e.model.isCheckTimeMinute(this)}})),this.initDatePicker()},initDatePicker:function(){var e=this.$el.find("#timelineDatePicker");this.model.get("isNightWork")?e.val(this.model.checkTimeDate()):e.val(this.dayInfo.day),e.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:""})},getVariable:function(){var e=this.$el;return{checkTime:moment(e.find("#timelineDatePicker").val()+" "+e.find("#checkTimeHour").val()+":"+e.find("#checkTimeMinute").val()).toISOString(),content:e.find("#content").val(),reason:e.find("#reason").val(),isNightWork:e.find("#isNightWork").is(":checked"),timelineStatus:{id:e.find("#status").val()}}},showNightWorkDescription:function(){this.$el.find("#nightWorkDescription").toggle()},save:function(){var e=this.model.isNew();if(!e){var n=this.$el.find("#reason").val();if(_.isEmpty(n))throw $.goError(i["\uc0ac\uc720\ub97c\uc785\ub825\ud574\uc8fc\uc138\uc694"]),new Error(i["\uc0ac\uc720\ub97c\uc785\ub825\ud574\uc8fc\uc138\uc694"])}this.model.save(this.getVariable()).done(function(){var n=r["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."];e||r["\uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],$.goMessage(n),t.EventEmitter.trigger("timeline","change:data")}).fail(function(e){e.responseJSON&&e.responseJSON.message?$.goMessage(e.responseJSON.message):$.goMessage(r["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])})},"delete":function(){var e=this.$el.find("#reason").val();if(_.isEmpty(e))throw $.goError(i["\uc0ac\uc720\ub97c\uc785\ub825\ud574\uc8fc\uc138\uc694"]),new Error(i["\uc0ac\uc720\ub97c\uc785\ub825\ud574\uc8fc\uc138\uc694"]);$.ajax({url:this.model.url(),data:JSON.stringify({reason:e}),type:"delete",async:!0,dataType:"json",contentType:"application/json",success:function(){$.goMessage(r["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.EventEmitter.trigger("timeline","change:data")}})}});return o});