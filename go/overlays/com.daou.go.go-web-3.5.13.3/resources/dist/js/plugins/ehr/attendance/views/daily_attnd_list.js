(function(){define(["backbone","app","hgn!attendance/templates/daily_attnd_list","i18n!nls/commons","i18n!attendance/nls/attendance","models/dept_profile","jquery.go-grid"],function(e,t,n,r,i,s){function l(e){var t="00";return t.substring(0,t.length-e.length)+e}function c(e){return moment().add(-1,"days").isBefore(e,"day")}var o={label_down_list:i["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],label_pre:r["\uc774\uc804"],label_next:r["\ub2e4\uc74c"],label_today:r["\uc624\ub298"],label_move_date:i["\ub0a0\uc9dc \uc774\ub3d9"],label_include_sub_dept:i["\ud558\uc704\ubd80\uc11c \ud3ec\ud568"],label_dept_name:r["\ubd80\uc11c\uba85"],label_dept_member:r["\ubd80\uc11c\uc6d0"],label_go_to_work:i["\ucd9c\uadfc"],label_IP:i.IP,label_GPS:i.GPS,label_go_home:i["\ud1f4\uadfc"],label_working_hour:i["\uadfc\ubb34\uc2dc\uac04"],label_status:i["\uc0c1\ud0dc"],label_memo:i["\uba54\ubaa8"],label_normal:i["\uc815\uc0c1"],label_late:i["\uc9c0\uac01"],label_modify:i["\uc218\uc815"],label_daily:i["\uc77c\uac04"],label_monthly:i["\uc6d4\uac04"],label_group:i["\uadf8\ub8f9"],label_select:r["\uc120\ud0dd"],"\ud558\uc704\ubd80\uc11c\uc120\ud0dd":r["\ud558\uc704 \ubd80\uc11c \uc120\ud0dd"]},u=e.Collection.extend({url:t.contextRoot+"api/ehr/attnd/groups"}),a=e.Collection.extend({url:t.contextRoot+"api/ehr/attnd/company/statuses"}),f=e.View.extend({events:{"click #xlsxDownBtn":"downExcel","click #preDate":"movePreDate","click #nextDate":"moveNextDate","click #todayBtn":"moveToday","click #attndCalBtn":"attndCalBtn","click #subDeptCheck":"includeSubDeptee","keydown #searchKeyword":"searchKeyboardEvent","click #searchBtn":"search","click ul.tab_nav li.monthly":"changeTab","change #searchTypes":"changeSearchType","change #search_group_filter":"search","change #attnd_descendant_dept":"changeDept","change #search_status_filter":"search"},initialize:function(n){this.$el.off(),this.options=n||{},this.isCompanyAttnd=this.options.isCompanyAttnd,this.isUseGPS=t.config("mobileConfig").useAttndRecordGps,this.deptid=this.options.deptid,this.groups=new u,this.groups.fetch({async:!1}),this.descendantDept=this.options.descendantDept,_.isUndefined(this.deptid)||this.descendantDept.length==0?(this.dept=new e.Model,this.hasDescendantSelect=!1):(this.dept=s.read(this.deptid),this.hasDescendantSelect=!0),this.companyStatus=new a,this.companyStatus.fetch({async:!1})},render:function(){var e=t.util.formatDatetime(t.util.toISO8601(t.util.now()),null,"YYYY-MM-DD");this.$el.html(n({lang:o,searchdate:e,preDate:t.util.formatDatetime(t.util.calDate(e,"days",-1),null,"YYYY-MM-DD"),nextDate:t.util.formatDatetime(t.util.calDate(e,"days",1),null,"YYYY-MM-DD"),isCompanyAttnd:this.isCompanyAttnd,isUseGPS:this.isUseGPS,groups:this.groups.toJSON(),companyStatus:this.companyStatus.toJSON(),descendantDept:this.descendantDept.toJSON(),hasDescendantSelect:this.hasDescendantSelect,dept:this.dept.toJSON()}));var r=this;return r.renderTable(),r.initDatePicker(),$("body").trigger("ehr.attndListRender"),this},initDatePicker:function(){var e=this,n=e.$el.find("#deptAttndCalendar");$.datepicker.setDefaults($.datepicker.regional[t.config("locale")]),n.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(t){e.gridTableReload(t)}})},getColumns:function(e){var n={mData:"userName",sClass:"name",sWidth:"100px",bSortable:!0,fnRender:function(e){var t=[];return t.push("<span data-id="+e.aData.userId+">"),t.push("<a class='detail'>"+e.aData.userName+"</a>"),t.push("<a class='popup' style='cursor: pointer;'><span class='ic_classic ic_blank' title='\ud31d\uc5c5\ubcf4\uae30'></span></a>"),t.push("</span>"),t.join("")}},r={mData:"deptName",sClass:"department",sWidth:"180px",bSortable:!1,fnRender:function(e){return e.aData.deptName}},i={mData:"clockInTime",sClass:"go",sWidth:"100px",bSortable:!0,fnRender:function(e){var t="";e.aData.editedClockInTime?t="modify":e.aData.late&&(t="late");if(e.aData.clockInTime!=null){var n=moment(e.aData.clockInTime).zone(e.aData.clockInTime).format("HH:mm:ss");return"<span class='time "+t+"'>"+n+"</span>"}return c(e.aData.logDate)?"":"<span class='time'>-</span>"}},s={mData:"clockInIp",sClass:"go_ip",sWidth:"100px",bSortable:!1,fnRender:function(e){return e.aData.clockInIp}},o={mData:null,sClass:"go_gps",sWidth:"180px",bSortable:!1,fnRender:function(e){return e.aData.clockInLatitude!=null&&e.aData.clockInLongitude!=null?e.aData.clockInLatitude+","+e.aData.clockInLongitude:"-"}},u={mData:"clockOutTime",sClass:"leave",sWidth:"100px",bSortable:!0,fnRender:function(e){var t="";e.aData.editedClockOutTime&&(t="modify");if(e.aData.clockOutTime!=null){var n=moment(e.aData.clockOutTime).zone(e.aData.clockOutTime).format("HH:mm:ss");return"<span class='time "+t+"'>"+n+"</span>"}return c(e.aData.logDate)?"":"<span class='time'>-</span>"}},a={mData:"clockOutIp",sClass:"leave_ip",sWidth:"100px",bSortable:!1,fnRender:function(e){return e.aData.clockOutIp}},f={mData:null,sClass:"leave_gps",sWidth:"140px",bSortable:!1,fnRender:function(e){return e.aData.clockOutLatitude!=null&&e.aData.clockOutLongitude!=null?e.aData.clockOutLatitude+","+e.aData.clockOutLongitude:"-"}},h={mData:"workingTime",sClass:"time",sWidth:"100px",bSortable:!0,fnRender:function(e){var t=e.aData.workingTime;if(t==null)return"";var n=parseInt(t/3600)+"",r=parseInt(t%3600/60)+"",i=parseInt(t%60)+"";return l(n)+":"+l(r)+":"+l(i)}},p={mData:null,sClass:"status",bSortable:!1,fnRender:function(e){var n="<ul>";return e.aData.statuses!=null&&e.aData.statuses.length>0?$.each(e.aData.statuses,function(e,r){n+="<li class='last'><p class='tit'>"+r.companyStatus.name+" ",r.companyStatus.type=="time"&&(n+=t.util.customDate(r.startDate,"HH:mm:ss")+"~"+t.util.customDate(r.endDate,"HH:mm:ss")),n+="</p><p class='con'>"+r.memo+"</p>"+"</li> "}):n+="<li class='last'><p class='tit'>  </p><p class='con'>  </p></li> ",n}},d=[];return d[d.length]=n,d[d.length]=r,d[d.length]=i,d[d.length]=s,e&&(d[d.length]=o),d[d.length]=u,d[d.length]=a,e&&(d[d.length]=f),d[d.length]=h,d[d.length]=p,d},renderTable:function(){var e=this,n="",r=t.router.getSearch(),s={searchdate:r.searchdate!=undefined?r.searchdate:t.util.formatDatetime(t.util.toISO8601(t.util.now()),null,"YYYY-MM-DD"),page:r.page!=undefined?r.page:0,offset:r.offset!=undefined?r.offset:30,property:r.peroperty!=undefined?r.peroperty:"userName",direction:r.direction!=undefined?r.direction:"asc",searchtype:r.searchtype!=undefined?r.searchtype:"",keyword:r.keyword!=undefined?r.keyword:""};this.isCompanyAttnd?n=t.contextRoot+"api/ehr/attnd/company/record":(n=t.contextRoot+"api/ehr/attnd/deptmember/record",$.extend(s,{deptid:e.deptid,includesubdept:!1}));var o=$.goGrid({el:e.$el.find("#deptAttndListWapper"),method:"GET",pageUse:!0,url:n,emptyMessage:"<p class='data_null'> <span class='ic_data_type ic_no_data'></span><span class='txt'>"+i["\uadfc\ud0dc\ud604\ud669\uc774 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]+"</span>"+"</p>",defaultSorting:[[0,"asc"]],params:s,lengthMenu:[30,50,70,100,200,300,400,500],columns:this.getColumns(this.isUseGPS),fnDrawCallback:function(n,r,i){$(window).scrollTop(0),$("div.tool_bar .custom_header").parent("div").addClass("calendar_tool_bar"),$("div.tool_bar .custom_header").after($("#attnd_tab").show()),$("#attnd_tab").after($("#dateBtns").show()),$("div.tool_bar .custom_bottom").append($("#attndLabel").show()).css("width","30%"),e.changeUrl(i),e.$el.find("td a.detail").on("click",function(e){var n=$(e.currentTarget),r=n.closest("span").attr("data-id"),i=t.router.getSearch();t.router.navigate("ehr/attendance/"+r+"/my?"+$.param(i),{trigger:!0})}),e.$el.find("td a.popup").on("click",function(e){var n=$(e.currentTarget),r=n.closest("span").attr("data-id"),i=t.router.getSearch(),s=window.location.protocol+"//"+window.location.host+t.contextRoot+"app/ehr/attendance/"+r+"/my/popup";window.open(s,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")})}});this.deptAttndFormsTable=o.tables},changeTab:function(){this.trigger("click:monthlytab")},downExcel:function(){var e={searchdate:$("#searchDate").attr("data-date")};this.isCompanyAttnd?window.location.href=t.contextRoot+"api/ehr/attnd/download/company/record?"+$.param(e):($.extend(e,{deptid:this.deptid,includesubdept:$("#subDeptCheck").is(":checked")}),window.location.href=t.contextRoot+"api/ehr/attnd/download/deptmember/record?"+$.param(e))},movePreDate:function(){this.gridTableReload($("#preDate").attr("data-date"))},moveNextDate:function(){this.gridTableReload($("#nextDate").attr("data-date"))},moveToday:function(){this.gridTableReload(t.util.formatDatetime(t.util.toISO8601(t.util.now()),null,"YYYY-MM-DD"))},attndCalBtn:function(){$("#deptAttndCalendar").trigger("focus")},includeSubDeptee:function(){this.deptAttndFormsTable.setParam("includesubdept",$("#subDeptCheck").is(":checked"))},searchKeyboardEvent:function(e){e.keyCode==13&&this.search()},search:function(){var e=this,t=$("#searchTypes").val(),n=this.$el.find("#searchKeyword"),r="";t=="group"?r=this.$el.find("#search_group_filter").val():t=="status"?r=this.$el.find("#search_status_filter").val():r=n.val(),this.deptAttndFormsTable.customParams={searchtype:t,keyword:r,searchdate:$("#searchDate").attr("data-date")},this.deptAttndFormsTable.fnClearTable()},changeDept:function(e){var t=$(e.currentTarget),n=t.val();this.deptAttndFormsTable.customParams={deptid:n},this.deptAttndFormsTable.fnClearTable()},gridTableReload:function(e){$("#preDate").attr("data-date",t.util.formatDatetime(t.util.calDate(e,"days",-1),null,"YYYY-MM-DD")),$("#searchDate").attr("data-date",t.util.formatDatetime(e,null,"YYYY-MM-DD")),$("#searchDate").text(t.util.formatDatetime(e,null,"YYYY-MM-DD")),$("#nextDate").attr("data-date",t.util.formatDatetime(t.util.calDate(e,"days",1),null,"YYYY-MM-DD")),this.deptAttndFormsTable.customParams={searchtype:null,keyword:null,searchdate:e},this.deptAttndFormsTable.fnClearTable()},changeUrl:function(e){var n=t.router.getUrl().split("?")[0]+"?"+$.param(e);t.router.navigate(n,{trigger:!1,replace:!0})},changeSearchType:function(e){var t=$(e.currentTarget);this.$el.find("#searchKeyword").val(""),this.$el.find("#search_status_filter").val("").attr("selected","selected"),this.$el.find("#search_group_filter").val("").attr("selected","selected"),t.val()=="group"?(this.$el.find("#search_group_filter").show(),this.$el.find("#search_status_filter").hide(),this.$el.find("#keyword_section").hide()):t.val()=="status"?(this.$el.find("#search_status_filter").show(),this.$el.find("#search_group_filter").hide(),this.$el.find("#keyword_section").hide()):(this.$el.find("#keyword_section").show(),this.$el.find("#search_group_filter").hide(),this.$el.find("#search_status_filter").hide())}});return f})})();