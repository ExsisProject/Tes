define(["backbone","hgn!attendance/templates/popup","hgn!attendance/templates/popup_content","attendance/collections/companyStatuses","i18n!nls/commons","i18n!attendance/nls/attendance","app"],function(e,t,n,r,i,s,o){var u={label_confirm:i["\ud655\uc778"],label_cancel:i["\ucde8\uc18c"],label_status:i["\uc0c1\ud0dc"],label_select:i["\uc120\ud0dd"],label_contents:i["\ub0b4\uc6a9"],label_date:s["\ub0a0\uc9dc"],label_time:s["\uc2dc\uac04"],label_statusDesc:s["\uc0c1\ud0dc\uc5d0 \ub300\ud55c \uac04\ub2e8\ud55c \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."],label_clockInTime:s["\ucd9c\uadfc"],label_clockOutTime:s["\ud1f4\uadfc"],label_useAllNight:s["\ucca0\uc57c"]},a=o.BaseView.extend({tagName:"table",className:"form_type go_form_basic",events:{"change #AttendStatusSelect":"changeStatus","change #useAllNight":"changeUseAllNight"},initialize:function(e){if(e||0)this.record=e.record,this.action=e.action,this.type=e.type,this.option=e.option,this.userid=e.userid,this.useFlexibleTime=!0,e.recordGroup!=null&&(this.useFlexibleTime=e.recordGroup.useFlexibleTime());this.companyStatuses=new r,this.companyStatuses.fetch({async:!1})},render:function(){var e=t({id:this.option,date:moment(this.record.getLogDate()).format("YYYY-MM-DD[(]dd[)]"),logDate:moment(this.record.getLogDate()).format("YYYY-MM-DD"),status:this.companyStatuses.toJSON(),isStatusType:this.type=="status",isIn:this.option=="in",isOut:this.option=="out",isAllNight:this.record.isUseAllNight(),useFlexibleTime:this.useFlexibleTime,lang:u});return this.$el.html(e),this.changeUseAllNight(null),this.action=="modify"&&this.databind(),this},databind:function(){if(this.type=="status"){var e=this.record.getStatusById(this.option).companyStatus.type,t=this.record.getStatusById(this.option).companyStatus.id,n=this.$el.find("#AttendStatusSelect option[data-id="+t+"]").attr("selected",!0);this.renderOption(e),this.$el.find("#statusContent").text(this.record.getStatusById(this.option).memo)}else if(this.type=="inout")if(this.option=="in"){var r=moment(this.record.getUserClockInTime(),"HH:mm:ss");this.$el.find("#InOutSelectHour option[value="+r.format("HH")+"]").attr("selected",!0),this.$el.find("#InOutSelectMin option[value="+r.format("mm")+"]").attr("selected",!0),this.$el.find("#InOutSelectSec option[value="+r.format("ss")+"]").attr("selected",!0)}else{var r=moment(this.record.getUserClockOutTime(),"HH:mm:ss");this.$el.find("#InOutSelectHour option[value="+r.format("HH")+"]").attr("selected",!0),this.$el.find("#InOutSelectMin option[value="+r.format("mm")+"]").attr("selected",!0),this.$el.find("#InOutSelectSec option[value="+r.format("ss")+"]").attr("selected",!0)}},renderOption:function(e){var t=this,r=n({lang:u,isCreate:this.action=="create",isModify:this.action=="modify",isDateType:function(){return e=="date"},isTimeType:function(){return e=="time"}});this.$el.find("#StatusOptionBox").html(r);if(this.action=="modify")if(e=="date")this.$el.find("#startDate").val(moment(this.record.getLogDate()).format("YYYY-MM-DD"));else{var i=this.record.getStatusById(this.option).startDate,s=this.record.getStatusById(this.option).endDate,a=moment(i).zone(i).format("HH"),f=moment(i).zone(i).format("mm"),l=moment(s).zone(s).format("HH"),c=moment(s).zone(s).format("mm");this.$el.find("#startTimeHour option[value="+a+"]").attr("selected",!0),this.$el.find("#startTimeMin option[value="+f+"]").attr("selected",!0),this.$el.find("#endTimeHour option[value="+l+"]").attr("selected",!0),this.$el.find("#endTimeMin option[value="+c+"]").attr("selected",!0)}else this.action=="create"&&($("#startDate").val(moment(this.record.getLogDate()).format("YYYY-MM-DD")),$("#endDate").val(moment(this.record.getLogDate()).format("YYYY-MM-DD")),$("#startTimeHour").val(o.util.now().format("HH")),$("#endTimeHour").val(o.util.now().add(1,"hours").format("HH")));this.$el.find("#startDate").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){$("#startDate").val(e)}}),this.$el.find("#endDate").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){$("#endDate").val(e)}})},changeStatus:function(e){var t=this,n=$(e.currentTarget).find("option:selected").attr("data-type");this.renderOption(n)},changeUseAllNight:function(e){var t=this,n=moment(this.$el.find("#popupTitle").attr("data-log-date"));this.$el.find("#useAllNight").is(":checked")&&n.add(1,"day"),this.$el.find("#popupTitle").html(n.format("YYYY-MM-DD[(]dd[)]"))},addInOut:function(){var e=this.record,t=this.action,n=this.type,r=this.option;r=="in"?e.setClockInTime(this.$el.find("#InOutSelectHour").val(),this.$el.find("#InOutSelectMin").val(),this.$el.find("#InOutSelectSec").val()):r=="out"&&e.setClockOutTime(this.$el.find("#InOutSelectHour").val(),this.$el.find("#InOutSelectMin").val(),this.$el.find("#InOutSelectSec").val(),this.$el.find("#useAllNight").is(":checked")),e.url=o.contextRoot+"api/ehr/attnd/user/"+this.userid+"/record/"+e.id,e.save({},{type:"PUT",async:!1,success:function(e,t){t.code=="200"&&($.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.EventEmitter.trigger("attnd","change:clockInOutStatus"),o.EventEmitter.trigger("attnd","change:clockInOutStatusSide"))},error:function(t,n){n.status==403?$.goMessage(i["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]):($.goMessage(n.responseJSON.message),r=="in"?e.set("clockInTime",undefined):r=="out"&&e.set("clockOutTime",undefined))}})},modifyInOut:function(){var e=this.record,t=this.action,n=this.type,r=this.option,u=moment(this.record.getLogDate()).set("hour",this.$el.find("#InOutSelectHour").val()).set("minute",this.$el.find("#InOutSelectMin").val()).set("seconds",this.$el.find("#InOutSelectSec").val());if(r=="in"){if(u.isAfter(moment(e.get("clockOutTime")))){$.goMessage(s["\ucd9c\uadfc\uc2dc\uac04\uc740 \ud1f4\uadfc\uc2dc\uac04\ubcf4\ub2e4 \ub2a6\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}e.setClockInTime(this.$el.find("#InOutSelectHour").val(),this.$el.find("#InOutSelectMin").val(),this.$el.find("#InOutSelectSec").val())}else if(r=="out"){if(u.isBefore(moment(e.get("clockInTime")))&&!this.$el.find("#useAllNight").is(":checked")){$.goMessage(s["\ud1f4\uadfc\uc2dc\uac04\uc740 \ucd9c\uadfc\uc2dc\uac04\ubcf4\ub2e4 \ube60\ub97c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}e.setClockOutTime(this.$el.find("#InOutSelectHour").val(),this.$el.find("#InOutSelectMin").val(),this.$el.find("#InOutSelectSec").val(),this.$el.find("#useAllNight").is(":checked"))}e.url=o.contextRoot+"api/ehr/attnd/user/"+this.userid+"/record/"+e.id,e.save({},{type:"PUT",async:!1,success:function(e,t){t.code=="200"&&($.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.EventEmitter.trigger("attnd","change:clockInOutStatus"),o.EventEmitter.trigger("attnd","change:clockInOutStatusSide"))},error:function(e,t){t.status==403?$.goMessage(i["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]):$.goMessage(t.responseJSON.message)}})},deleteInOut:function(){var e=this.record,t=this.action,n=this.type,r=this.option;r=="in"?e.set("clockInTime",null):r=="out"&&(e.set("clockOutTime",null),e.set("useAllNight",!1)),e.url=o.contextRoot+"api/ehr/attnd/user/"+this.userid+"/record/"+e.id,e.save({},{type:"PUT",async:!1,success:function(e,t){t.code=="200"&&($.goMessage(i["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.EventEmitter.trigger("attnd","change:clockInOutStatus"),o.EventEmitter.trigger("attnd","change:clockInOutStatusSide"))},error:function(e,t){t.status==403?$.goMessage(i["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]):$.goMessage(t.responseJSON.message)}})},addStatus:function(){var t=new e.Model,n=this.$el.find("#AttendStatusSelect option:selected"),r=n.attr("data-type"),s=n.attr("data-id"),u=n.val();if(!r||0){$.goMessage("\uc0c1\ud0dc\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694.");return}if(r=="date")t.set("startDate",o.util.toISO8601(moment(this.$el.find("#startDate").val(),"YYYY-MM-DD")),{silent:!0}),t.set("endDate",o.util.toISO8601(moment(this.$el.find("#endDate").val(),"YYYY-MM-DD")),{silent:!0});else{var a=moment(this.$el.find("#popupTitle").attr("data-log-date"));t.set("startDate",o.util.toISO8601(a.hour(this.$el.find("#startTimeHour option:selected").val()).minute(this.$el.find("#startTimeMin option:selected").val())),{silent:!0}),t.set("endDate",o.util.toISO8601(a.hour(this.$el.find("#endTimeHour option:selected").val()).minute(this.$el.find("#endTimeMin option:selected").val())),{silent:!0})}t.set("companyStatus",{name:u,type:r,id:s},{silent:!0}),t.set("memo",this.$el.find("#statusContent").val(),{silent:!0});if(t.get("memo").length>255){$.goError(o.i18n(i["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],{arg1:255}));return}t.url=o.contextRoot+"api/ehr/attnd/user/"+this.userid+"/status",t.save({},{type:"POST",async:!1,success:function(e,t){t.code=="200"&&($.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.EventEmitter.trigger("attnd","change:clockInOutStatus"))},error:function(e,t){t.status==403?$.goMessage(i["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]):$.goMessage(t.responseJSON.message)}})},modifyStatus:function(t){var n=this,t=t,r=this.record,s=this.action,u=this.type,a=this.option,f=new e.Model,l=this.$el.find("#AttendStatusSelect option:selected"),c=l.attr("data-type"),h=l.attr("data-id"),p=l.val();if(!c||0){$.goMessage("\uc0c1\ud0dc\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694.");return}if(c=="date")f.set("startDate",o.util.toISO8601(moment(this.$el.find("#startDate").val(),"YYYY-MM-DD")),{silent:!0}),f.set("endDate",o.util.toISO8601(moment(this.$el.find("#startDate").val(),"YYYY-MM-DD")),{silent:!0});else{var d=moment(this.$el.find("#popupTitle").attr("data-log-date"));f.set("startDate",o.util.toISO8601(d.hour(this.$el.find("#startTimeHour option:selected").val()).minute(this.$el.find("#startTimeMin option:selected").val())),{silent:!0}),f.set("endDate",o.util.toISO8601(d.hour(this.$el.find("#endTimeHour option:selected").val()).minute(this.$el.find("#endTimeMin option:selected").val())),{silent:!0})}f.set("companyStatus",{name:p,type:c,id:h},{silent:!0}),f.set("memo",this.$el.find("#statusContent").val(),{silent:!0});if(f.get("memo").length>255){$.goError(o.i18n(i["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],{arg1:255}));return}f.url=o.contextRoot+"api/ehr/attnd/user/"+this.userid+"/status/"+a,f.save({},{type:"PUT",async:!1,success:function(e,t){t.code=="200"&&($.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.EventEmitter.trigger("attnd","change:clockInOutStatus"))},error:function(e,t){t.status==403?$.goMessage(i["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]):$.goMessage(t.responseJSON.message)}})},deleteStatus:function(){var t=this.record,n=this.action,r=this.type,s=this.option,u=new e.Model;u.url=o.contextRoot+"api/ehr/attnd/user/"+this.userid+"/status/"+s,u.save({},{type:"DELETE",async:!1,success:function(e,t){t.code=="200"&&($.goMessage(i["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.EventEmitter.trigger("attnd","change:clockInOutStatus"))},error:function(e,t){t.status==403?$.goMessage(i["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]):$.goMessage(t.responseJSON.message)}})}});return a});