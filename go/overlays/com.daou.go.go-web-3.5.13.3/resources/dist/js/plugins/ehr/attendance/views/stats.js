(function(){define(["backbone","app","attendance/views/title","hgn!attendance/templates/stats","hgn!attendance/templates/stats_list","i18n!nls/commons","i18n!attendance/nls/attendance","models/dept_profile","jquery.go-grid"],function(e,t,n,r,i,s,o,u){function c(e){var t,n,r;return t=e/3600,n=e%3600/60,r=e%3600%60,myDate=new Date,myDate.setHours(t,n,r),myDate}function h(e,n){var r=e.split("-"),i=new Date(r[0],r[1]-1,r[2]),s=new Date(i.valueOf()-864e5*n);return t.util.customDate(s,"YYYY-MM-DD")}var a=e.Collection.extend({initialize:function(e){this.deptId=e.deptId},url:function(){return t.contextRoot+"api/department/descendant/"+this.deptId}}),f={label_stats_period:o["\uac80\uc0c9\uae30\uac04"],label_stats_day:o["\uc77c"],label_stats_week:o["\uc8fc"],label_stats_month:o["\uc6d4"],label_stats_state:o["\uadfc\ud0dc \uc0c1\ud0dc"],label_stats_late:o["\uc9c0\uac01"],label_stats_allnight:o["\ucca0\uc57c"],label_stats_search:o["\uac80\uc0c9"],label_down_list:o["\uc0c1\uc138\ub0b4\uc5ed \ub2e4\uc6b4\ub85c\ub4dc"],label_dept_name:s["\ubd80\uc11c\uba85"],label_dept_member:s["\ubd80\uc11c\uc6d0"],label_dept_group:o["\uadf8\ub8f9"],label_stats_all:o["\uc804\uccb4"],label_stats_ave_go:o["\ud3c9\uade0\ucd9c\uadfc"],label_stats_ave_leave:o["\ud3c9\uade0\ud1f4\uadfc"],label_stats_ave_time:o["\ud3c9\uade0\uadfc\ubb34"],label_stats_target:o["\ub300\uc0c1"],label_stats_title:o["\ubd80\uc11c \uadfc\ud0dc\ud1b5\uacc4"],label_all_stats_title:o["\uc804\uc0ac \uadfc\ud0dc\ud1b5\uacc4"],label_stats_group_message:o["\uadf8\ub8f9\uc744 \uc120\ud0dd\ud574\uc8fc\uc138\uc694."],label_stats_group_select:o["\uc120\ud0dd"],"\ud558\uc704\ubd80\uc11c\uc120\ud0dd":s["\ud558\uc704 \ubd80\uc11c \uc120\ud0dd"]},l=e.View.extend({events:{"click #statsDay":"statsDayClick","click #statsWeek":"statsWeekClick","click #statsMonth":"statsMonthClick","change #statsSearchTypes":"statsSearchTypesChange","click #statsStateAll":"statsStateAllClick","click input[name=stateCheck]":"stateCheckClick","click #statsSearch":"statsSearchClick","click #attndCalBtn":"attndCalBtn","keyup #statsSearchInput":"statsSearchInputEnter","click #downloadxlsx":"downloadxlsx"},initialize:function(t){this.$el.off(),this.selectedDate,this.deptid=_.isUndefined(t)?undefined:t.deptid,_.isUndefined(this.deptid)?(this.dept=new e.Model,this.descendantDept=new e.Collection):(this.dept=u.read(this.deptid),this.descendantDept=new a({deptId:this.deptid}),this.descendantDept.fetch({async:!1})),t==undefined||this.descendantDept.length==0?this.hasDescendantSelect=!1:this.hasDescendantSelect=!0},render:function(){var e=this;this.$el.html(r({lang:f,descendantDept:this.descendantDept.toJSON(),hasDescendantSelect:this.hasDescendantSelect,dept:this.dept.toJSON()}));var t="";this.deptid==undefined?t=o["\uc804\uc0ac \uadfc\ud0dc\ud1b5\uacc4"]:(t=o["\ubd80\uc11c \uadfc\ud0dc\ud1b5\uacc4"],e.$el.find("#targetTr").hide());var i=new n;this.$el.find("header.content_top").html(i.render(t).el);var s=moment().format("YYYY-MM-DD"),u=h.call(this,s,1);return e.$el.find("#statsStartDate").text(u),e.selectedDate=u,e.initDatePicker(),e.setTagetGroupInfo(),e.setStateInfo(),$("body").trigger("ehr.statListRender"),this},initDatePicker:function(){var e=this,n=e.$el.find("#calendarDatepicker");$.datepicker.setDefaults($.datepicker.regional[t.config("locale")]),n.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(t){e.selectedDate=t,$.each(e.$el.find("#statsDayWeekMonth").children(),function(n,r){if($(this).hasClass("select")){var i=$(this).attr("id");if(i=="statsDay")e.$el.find("#statsStartDate").text(t);else if(i=="statsWeek"){var s=moment(t).clone(),o=s.clone().day(0).format("YYYY-MM-DD"),u=s.clone().day(6).format("YYYY-MM-DD");e.$el.find("#statsStartDate").text(o),e.$el.find("#statsEndDate").text(u)}else if(i=="statsMonth"){var s=t,a=s.split("-"),f=a[0]+"-"+a[1];e.$el.find("#statsStartDate").text(f)}}})}}),e.$el.find("#calendarDatepicker").trigger("focus")},attndCalBtn:function(){$("#calendarDatepicker").trigger("focus")},statsDayClick:function(){$("#statsEndDateSpan").hide(),$("#statsWeek").removeClass("select"),$("#statsMonth").removeClass("select"),$("#statsDay").addClass("select"),$("#statsStartDate").text(this.selectedDate)},statsWeekClick:function(){$("#statsEndDateSpan").show(),$("#statsDay").removeClass("select"),$("#statsMonth").removeClass("select"),$("#statsWeek").addClass("select");var e=moment(this.selectedDate).clone(),t=e.clone().day(0).format("YYYY-MM-DD"),n=e.clone().day(6).format("YYYY-MM-DD");$("#statsStartDate").text(t),$("#statsEndDate").text(n)},statsMonthClick:function(){$("#statsEndDateSpan").hide(),$("#statsDay").removeClass("select"),$("#statsWeek").removeClass("select"),$("#statsMonth").addClass("select");var e=this.selectedDate,t=e.split("-"),n=t[0]+"-"+t[1];$("#statsStartDate").text(n)},statsSearchTypesChange:function(){var e=$("#statsSearchTypes").val();this.$el.find("#statsSearchInput").val(""),this.$el.find("#statsGroupSelect").val("selectIng").attr("selected","selected"),e=="group"?($("#statsSearchInput").hide(),$("#statsGroupSelect").show()):($("#statsGroupSelect").hide(),$("#statsSearchInput").show())},statsStateAllClick:function(){var e=this;e.$el.find("#statsStateAll").is(":checked")?e.$el.find("input[name=stateCheck]").prop("checked",!0):e.$el.find("input[name=stateCheck]").prop("checked",!1)},stateCheckClick:function(){var e=this;$.each(e.$el.find("input[name=stateCheck]"),function(t,n){$(this).is(":checked")||e.$el.find("#statsStateAll").prop("checked",!1)})},setTagetGroupInfo:function(){var e=this,n=t.contextRoot+"api/ehr/attnd/groups";$.go(n,"",{qryType:"GET",contentType:"application/json",responseFn:function(e){if(e.code==200){var t=e.data,n="";$.each(t,function(e,t){n+="<option value='"+t.id+"'>"+t.name+"</option>"}),$("#statsGroupSelect").append(n)}},error:function(e){}})},setStateInfo:function(){var e=this,n=t.contextRoot+"api/ehr/attnd/company/statuses";$.go(n,"",{qryType:"GET",contentType:"application/json",responseFn:function(t){if(t.code==200){var n=t.data,r=n.length,i=Math.ceil((r+3)/5),s="";for(var o=0;o<i-1;o++)s+=" <tr></tr>",$("#statsStateTbody").append(s),s="";$.each(n,function(e,t){for(var n=0;n<i;n++){trLength=$("#statsStateTbody tr:eq("+n+")").children().length;if(trLength<5){s+="<td class='statsTd'><input type='checkbox' name='stateCheck' value="+t.fieldName+" data-name="+t.name+">"+"<span>"+t.name+"</span></td>",$("#statsStateTbody tr:eq("+n+")").append(s),s="";break}}})}e.statsStateAllClick()},error:function(e){}})},statsSearchInputEnter:function(e){var t=this;e=e||window.event;var n=e.which?e.which:e.keyCode;n==13&&t.statsSearchClick()},statsSearchClick:function(){var e=this,t=this.getParams(),n=this.getUrl();t.fail!="fail"&&e.renderTable(t,n)},getUrl:function(){var e={};e.statsDay="api/ehr/attnd/stat/daily",e.statsWeek="api/ehr/attnd/stat/weekly",e.statsMonth="api/ehr/attnd/stat/monthly";var t=$("#statsDayWeekMonth a.select").attr("id");return e[t]},getParams:function(){var e={},t=$("#statsDayWeekMonth a.select").attr("id");t=="statsDay"?e.basedate=$("#statsStartDate").text():t=="statsWeek"?(e.startdate=$("#statsStartDate").text(),e.enddate=$("#statsEndDate").text()):t=="statsMonth"&&(e.basedate=$("#statsStartDate").text());if(this.deptid==undefined){var n=$("#statsSearchTypes").val();e.searchtype=n;if(n=="user"||n=="dept")e.keyword=$("#statsSearchInput").val();else if(n=="group"){var r=$("#statsGroupSelect option:selected").val();r=="selectIng"?($.goMessage(o["\uadf8\ub8f9\uc744 \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]),e.fail="fail"):e.keyword=$("#statsGroupSelect").val()}}else if(this.deptid!=undefined)if(this.hasDescendantSelect){var i=$("#descendant").val();e.deptid=i}else e.deptid=this.deptid;return e},renderTable:function(e,n){var r=this;this.$el.find("#statsListInfo").html(i({lang:f})),$("#downloadxlsx").show(),$("#statsListInfoHeadTr .customField").remove();var s=function(){var e=[{mData:"user.name",sClass:"name align_c",bSortable:!0,fnRender:function(e){return e.aData.user.name}},{mData:"depts",sClass:"department align_c",bSortable:!1,fnRender:function(e){var t="";return e.aData.depts!=null&&($.each(e.aData.depts,function(e,n){t+=n.name+","}),t=t.substring(0,t.length-1)),t}},{mData:"clockInTime",sClass:"go align_c",bSortable:!0,fnRender:function(e){if(e.aData.clockInTime!=null){var n=c.call(this,e.aData.clockInTime);return"<span class='time'>"+t.util.customDate(n,"HH:mm:ss")}return"<span class='time'>-</span>"}},{mData:"clockOutTime",sClass:"leave align_c",bSortable:!0,fnRender:function(e){if(e.aData.clockOutTime!=null){var n=c.call(this,e.aData.clockOutTime);return"<span class='time'>"+t.util.customDate(n,"HH:mm:ss")}return"<span class='time'>-</span>"}},{mData:"workingTime",sClass:"time align_c",bSortable:!0,fnRender:function(e){if(e.aData.workingTime!=null){var n=c.call(this,e.aData.workingTime);return"<span class='time'>"+t.util.customDate(n,"HH:mm:ss")}return"<span class='time'>-</span>"}}];return $.each(r.$el.find("input[name=stateCheck]"),function(t,n){var r="";if($(this).is(":checked")){var i=n.value,s={mData:i,sClass:"customField align_c",bSortable:!0};e.push(s),r+="<th class='sorting customField' style='width:50px'><span class='title_sort'>"+$(this).attr("data-name")+"<ins class='ic'></ins>"+"</span></th>"}$("#statsListInfoHeadTr").append(r)}),e}();r.statsList=$.goGrid({el:r.$el.find("#stat_table"),method:"GET",pageUse:!0,url:t.contextRoot+n,lengthMenu:[30,50,70,100,200,300,400,500],emptyMessage:"<p class='data_null'> <span class='txt'>"+o["\uac80\uc0c9\uacb0\uacfc\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]+"</span>"+"</p>",defaultSorting:[[0,"asc"]],params:e,columns:s,fnDrawCallback:function(e,t,n){r.$el.has("#taskListScroll").length==0&&r.statsList.tables.wrapAll('<div id="taskListScroll" style="overflow-x:scroll" />'),$(window).scrollTop(0)}})},downloadxlsx:function(){var e=this.statsList.listParams;e.offset=null,e.page=null;var n=$("#statsDayWeekMonth a.select").attr("id"),r={};r.statsDay="api/ehr/attnd/stat/daily/download",r.statsWeek="api/ehr/attnd/stat/weekly/download",r.statsMonth="api/ehr/attnd/stat/monthly/download",window.location.href=t.contextRoot+r[n]+"?"+$.param(e)}});return l})})();