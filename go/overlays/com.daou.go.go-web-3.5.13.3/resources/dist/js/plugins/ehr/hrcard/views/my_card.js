define(["backbone","app","hogan","hrcard/views/detail/profile","hrcard/views/detail/tabMenu","hrcard/views/detail/tabView","hrcard/models/hrInfo","hrcard/collections/info_list","hgn!hrcard/templates/my_card","i18n!hrcard/nls/hrcard","i18n!nls/commons","i18n!calendar/nls/calendar"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h={label_title:f["\uc778\uc0ac\uc815\ubcf4"],label_date_alert:f["\ub0a0\uc9dc\ud615\uc2dd\uc744\ub9de\ucdb0\uc8fc\uc138\uc694."],label_save:l["\uc800\uc7a5"],label_cancel:l["\ucde8\uc18c"],label_date_validation:c["\ub05d\uc2dc\uac04\uc740 \uc2dc\uc791\uc2dc\uac04\ubcf4\ub2e4 \uc774\uc804\uc73c\ub85c \ub4f1\ub85d\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]},p=e.View.extend({events:{"click ul.tab_menu li":"changeTab","click #hrcard_btn_submit":"hrcardSubmit","click #hrcard_btn_cancel":"hrcardCancel","click #foldTab":"foldTab","click #unfoldTab":"unfoldTab"},initialize:function(e){this.options=e||{},this.options.userid?this.userid=this.options.userid:this.userid=GO_Session.id},render:function(){var e=this,t={userid:this.userid};this.$el.html(a({lang:h}));var n=new r({userid:this.userid});this.$el.find("div.ehr_basic_info").html(n.render().el);var s=new i(t);this.$el.find("div.tab_menu_wrap").html(s.render("basic").el);var o=function(){e.$el.find("ul.tab_menu li:eq(0)").trigger("click")};return this.callHrcardModel(o),this.activityRender(t),this},callHrcardModel:function(e){var n=this;this.hrcardModel=new o({userid:this.userid}),this.hrcardModel.fetch({success:function(t,r){e(),n.editable=t.get("editable"),n.editable!=1?$("div.page_action_wrap").hide():$("div.page_action_wrap").show(),n.allowTabCheck()},statusCode:{403:function(){t.util.error("403")},404:function(){t.util.error("404",{msgCode:"400-common"})},500:function(){t.util.error("500")}}})},allowTabCheck:function(){var e=this,t=[];$("ul.tab_menu li").each(function(e,n){t.push($(n).attr("id"))}),$("ul.tab_menu li").hide(),$.each(t,function(t,n){$.each(e.hrcardModel.get(n),function(e,t){typeof e=="string"?t.useColumn&&$("#"+n).show():$.each(t,function(e,t){if(e=="dataId")return!0;t.useColumn&&$("#"+n).show()})})})},unfoldTab:function(){var e=this;$("#foldTab").show(),$("#unfoldTab").hide();var t=[];$("ul.tab_menu li").each(function(e,n){t.push($(n).attr("id"))}),$("div.ehr_con_wrap").html(""),$("div.page_action_wrap").hide();var n="";$.each(t,function(t,n){var r={userid:e.userid,tabType:n,data:e.hrcardModel.get(n),editable:!1},i=new s(r);$("div.ehr_con_wrap").append(i.render().el)}),$("div.ehr_con_wrap h3.tab_title").show()},foldTab:function(){$("#foldTab").hide(),$("#unfoldTab").show();var e=$("ul.tab_menu li.active").attr("id");this.$el.find("#"+e).trigger("click"),this.editable?$("div.page_action_wrap").show():$("div.page_action_wrap").hide(),$("div.ehr_con_wrap h3.tab_title").hide()},tabRender:function(e){var t=new s(e);$("div.ehr_con_wrap").html(t.render().el),this.editable?$("div.page_action_wrap").show():$("div.page_action_wrap").hide(),$("#foldTab").hide(),$("#unfoldTab").show(),this.activityRender(e)},toggleTab:function(e){_.each(e.closest("ul").find("li"),function(e,t){$(e).removeClass("active")}),e.addClass("active")},changeTab:function(e){var t=$(e.currentTarget);this.tabType=t.attr("id"),this.toggleTab(t);var n={userid:this.userid,tabType:this.tabType,data:this.hrcardModel.get(t.attr("id")),editable:this.hrcardModel.get("editable")||!1};this.tabRender(n)},activityRender:function(e){require(["hrcard/views/detail/activity_log"],function(t){var n=new t(e);$("section#hrcardActivity").html(n.render().el)})},hrcardSubmit:function(){this.tabType=="basic"||this.tabType=="detail"?this.save():this.saveAll()},hrcardCancel:function(){this.$el.find("#"+this.tabType).trigger("click")},save:function(){if(!this.isRightDate()){$.goMessage(h.label_date_alert,"caution");return}var e=this,n=new o,r=t.util.serializeForm($("#data_form"));n.setFromFormData(r,this.tabType);var i=n.isValid();i||$.goMessage(h.label_date_validation),n.url=[t.contextRoot+"api/ehr/hrcard/info",this.userid].join("/"),n.save({},{type:"PUT",async:!1,success:function(t,n){if(n.code=="200"){$.goMessage(l["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]);var r=function(){e.$el.find("#"+e.tabType).trigger("click")},i={userid:e.userid};e.callHrcardModel(r),e.activityRender(i)}},error:function(e,t){$.goMessage(t.responseJSON.message)}})},saveAll:function(){if(!this.isRightDate()){$.goMessage(h.label_date_alert,"caution");return}var n=this;this.validate=!0;var r={},i=new u({userid:this.userid,tabType:this.tabType});i.reset(),_.each($("div.viewForm tr.dataRow"),function(e,t){var r=$(e).attr("data-id"),s={};s.dataId=r==""?null:r,_.each($(e).find("input"),function(e,t){var n=$(e).val();n!=""&&(s[$(e).attr("name")]=n)}),_.each($(e).find("select"),function(e,t){var n=$(e).val();n!=""&&(s[$(e).attr("name")]=n)});if(s.length!=0){var u=new o;u.set(s);var a=u.isValidation(s,n.tabType);if(!a)return n.validate=!1,!1;i.add(u)}});if(!this.validate){$.goMessage(h.label_date_validation);return}r[this.tabType]=i;var s=new e.Model;s.set(r),s.url=[t.contextRoot+"api/ehr/hrcard/info",this.userid].join("/"),s.save({},{type:"PUT",async:!1,success:function(e,t){if(t.code=="200"){$.goMessage(l["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]);var r=function(){n.$el.find("#"+n.tabType).trigger("click")};n.callHrcardModel(r)}},error:function(e,t){$.goMessage(t.responseJSON.message)}})},isRightDate:function(){var e=!0,t=/^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/;return $("input.hasDatepicker").each(function(n,r){var i=$(r).val();if(i!=""&&i.match(t)==null)return e=!1,!1}),e}});return p});