define("timeline/views/mobile/user/history",function(require){var e=require("backbone"),t=require("timeline/models/auth"),n=require("timeline/models/history"),r=require("views/mobile/header_toolbar"),i=require("hgn!timeline/templates/mobile/user/history_regist"),s=require("hgn!timeline/templates/mobile/user/history_detail"),o=require("i18n!timeline/nls/timeline"),u=require("i18n!nls/commons"),a=_.range(0,24).map(function(e){return e<10?"0"+e:e}),f=_.range(0,60).map(function(e){return e<10?"0"+e:e}),l=e.Collection.extend({url:GO.contextRoot+"api/timeline/status"}),c=e.View.extend({bindEvent:function(){var e=this;$("#modifyBtn").click(function(t){e.modify(t)}),$("#deleteBtn").click(function(t){e.delete(t)})},unbindEvent:function(){$("#modifyBtn").unbind("click"),$("#deleteBtn").unbind("click")},initialize:function(e){this.options=e,this.baseDate=this.options.baseDate?this.options.baseDate:moment().format("YYYY-MM-DD"),this.targetUserId=this.options.targetUserId,this.historyId=this.options.historyId,this.type=this.options.type,this.authModel=new t(GO.util.store.get("timeline.auth")),this.isCreatable=this.authModel.isCreatable(),this.isEditable=this.authModel.isEditable(),this.isDeletable=this.authModel.isDeletable(),this.isReadable=this.authModel.isReadable(),this.isViewMode=this.type==="view"?!0:!1,this.isCreateMode=this.type==="create"?!0:!1,this.isUpdateMode=this.type==="update"?!0:!1,this.isDeleteMode=this.type==="delete"?!0:!1,this.isCreateMode?this.model=new n({targetUserId:this.targetUserId,baseDate:this.baseDate}):this.model=new n({id:this.historyId,targetUserId:this.targetUserId,baseDate:this.baseDate}),this.isViewMode||(this.statusCollection=new l),GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","timeline-movecreate",this.moveCreatePage,this),GO.EventEmitter.on("trigger-action","timeline-movemodify",this.moveModifyPage,this),GO.EventEmitter.on("trigger-action","timeline-movedelete",this.moveDeletePage,this),GO.EventEmitter.on("trigger-action","timeline-save",this._save,this),GO.EventEmitter.on("trigger-action","timeline-delete",this._delete,this)},render:function(){this.unbindEvent(),this.$el.empty(),this.renderTitleToolbar(),this.isCreateMode?this._renderCreateView():this.isUpdateMode?this._renderUpdateView():this.isViewMode?this._renderDetailView():this.isDeleteMode&&this._renderDeleteView(),this.bindEvent()},moveCreatePage:function(){GO.router.navigate("ehr/timeline/history/create",{trigger:!0,pushState:!0})},moveModifyPage:function(){GO.router.navigate("ehr/timeline/history/"+this.historyId+"/update/"+this.targetUserId+"/"+this.baseDate,{trigger:!0,pushState:!0})},moveDeletePage:function(){GO.router.navigate("ehr/timeline/history/"+this.historyId+"/delete/"+this.targetUserId+"/"+this.baseDate,{trigger:!0,pushState:!0})},_goTimelineHome:function(){GO.router.navigate("ehr",{trigger:!0,pushState:!0})},_renderCreateView:function(){this.isCreatable||this._goTimelineHome(),this.statusCollection.fetch().done(_.bind(this._renderRegist,this))},_renderUpdateView:function(){this.isEditable||this._goTimelineHome(),this.statusCollection.fetch().done(_.bind(this._renderRegist,this))},_renderDeleteView:function(){this.isDeletable||this._goTimelineHome(),this.statusCollection.fetch().done(_.bind(this._renderRegist,this))},_renderRegist:function(){var e=GO.util.now(),t=GO.util.getIntervalTime(e).format("HH:mm"),n=t.split(":")[0],r=t.split(":")[1],s=_.isEmpty(this.baseDate)?e.format("YYYY-MM-DD"):this.baseDate;if(this.isUpdateMode||this.isDeleteMode)this.model.fetch({async:!1,error:function(e,t){GO.util.error("404",{msgCode:"400-common"});return}}),this.model.isNightWork()?s=moment(this.model.get("baseDate")).add("days",1).format("YYYY-MM-DD"):s=this.model.get("baseDate");var l=this;$(".content_page").html(i({CommonLang:u,TimelineLang:o,data:this.model.toJSON(),isNew:this.model.isNew(),status:this.statusCollection.toJSON(),HOUR:a,MINUTE:f,isSelected:function(){return l.model.isNew()?!1:l.model.get("timelineStatus")["id"]==this.id},isCheckTimeHour:function(){return l.type==="create"?this==n:l.model.isCheckTimeHour(this)},isCheckTimeMinute:function(){return l.type==="create"?this==r:l.model.isCheckTimeMinute(this)}})),this._initDatePicker(s),$("#isNightWork").unbind("click"),$("#isNightWork").click(function(e){l.changeNight(e)})},_renderDetailView:function(){this.model.fetch({async:!1,error:function(e,t){GO.util.error("404",{msgCode:"400-common"});return}}),this.isReadable||this._goTimelineHome();var e=this;$(".content_page").html(s({TimelineLang:o,CommonLang:u,data:this.model.toJSON(),checkTimeDate:function(){return e.model.checkTimeDate()},checkTimeHour:function(){return e.model.checkTimeHour()},checkTimeMinute:function(){return e.model.checkTimeMinute()},statusName:function(){return e.model.getStatusName()}}))},renderTitleToolbar:function(){var e=this,t=o["\uc0c1\ud0dc \uc0c1\uc138"];this.isCreateMode?t=o["\uc0c1\ud0dc \ub4f1\ub85d"]:this.isUpdateMode?t=o["\uc0c1\ud0dc \uc218\uc815"]:this.isDeleteMode&&(t=o["\uc0c1\ud0dc \uc0ad\uc81c"]);var n={title:t,actionMenu:this.getUseMenus()};this.isViewMode?(n.isPrev=!0,n.prevCallback=function(){window.history.length==1?e._goTimelineHome():window.history.back()}):n.isClose=!0,this.headerToolbarView=r,this.headerToolbarView.render(n)},getUseMenus:function(){var e=[],t={"\uc218\uc815\uc774\ub3d9":{id:"timeline-movemodify",text:u["\uc218\uc815"],triggerFunc:"timeline-movemodify",inMoreBtn:!0},"\uc0ad\uc81c\uc774\ub3d9":{id:"timeline-movedelete",text:u["\uc0ad\uc81c"],triggerFunc:"timeline-movedelete",inMoreBtn:!0},"\uc0ad\uc81c":{id:"timeline-delete",text:u["\uc0ad\uc81c"],triggerFunc:"timeline-delete"},"\ud655\uc778":{id:"timeline-save",text:u["\ud655\uc778"],triggerFunc:"timeline-save"}};return this.isViewMode?(this.authModel.isEditable()&&e.push(t.\uc218\uc815\uc774\ub3d9),this.authModel.isDeletable()&&e.push(t.\uc0ad\uc81c\uc774\ub3d9)):this.isDeleteMode?e.push(t.\uc0ad\uc81c):e.push(t.\ud655\uc778),e},_initDatePicker:function(e){var t=$("#timelineDatePicker");t.val(e),t.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:""})},_validateReason:function(e){return _.isEmpty(e)?(GO.util.delayAlert(o["\uc0ac\uc720\ub97c\uc785\ub825\ud574\uc8fc\uc138\uc694"]),$("textarea#reason").focus(),GO.util.appLoading(!1),!1):!0},_save:function(){GO.util.appLoading(!0);var e=this.model.isNew(),t=u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."];if(!e){var n=$("#reason").val();if(!this._validateReason(n))return;t=u["\uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]}this.model.save(this.getVariable()).done(function(){GO.util.delayAlert(t),GO.util.appLoading(!1),GO.router.navigate("ehr",{trigger:!0,pushState:!0})}).fail(function(e){e.responseJSON&&e.responseJSON.message?GO.util.delayAlert(e.responseJSON.message):GO.util.delayAlert(u["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),GO.util.appLoading(!1)})},_delete:function(){var e=$("#reason").val();if(!this._validateReason(e))return;confirm(u["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])&&(GO.util.appLoading(!0),$.ajax({url:this.model.url(),data:JSON.stringify({reason:e}),type:"delete",async:!0,dataType:"json",contentType:"application/json",success:function(){GO.util.delayAlert(u["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),GO.util.appLoading(!1),GO.router.navigate("ehr",{trigger:!0,pushState:!0})},error:function(){GO.util.delayAlert(u["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."]),GO.util.appLoading(!1)}}))},changeNight:function(e){$("#nightWorkDescription").toggle()},getVariable:function(){return{checkTime:moment($("#timelineDatePicker").val()+" "+$("#checkTimeHour").val()+":"+$("#checkTimeMinute").val()).toISOString(),content:$("textarea#content").val(),reason:$("textarea#reason").val(),isNightWork:$("#isNightWork").is(":checked"),timelineStatus:{id:$("#status").val()}}}});return c});