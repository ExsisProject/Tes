define("timeline/views/user/main",function(require){var e=require("backbone"),t=require("hgn!timeline/templates/user/main"),n=require("i18n!timeline/nls/timeline"),r=require("i18n!nls/commons"),i=require("timeline/views/user/summary"),s=require("timeline/views/user/change_history"),o=require("timeline/views/user/month"),u=require("underscore"),a=require("models/user_profile"),f=require("timeline/helpers/user/local_storage"),l=e.View.extend({events:{"click #prevMonth":"prevMonth","click #nextMonth":"nextMonth","click #currentMonth":"currentMonth","click #baseDate":"showCal"},initialize:function(e){this.options=e,this.date=new Date,this.baseDate=GO.util.customDate(this.date,"YYYY-MM-DD"),this.options.baseDate=this.baseDate;if(!!this.options.userId&&!!this.getUrlParams().popup){this.popupUserStat(this.options.userId),window.history.go(-1);return}this.summaryView=new i(this.options),this.historyView=new s(this.options),this.monthView=new o(this.options),f.setSelectedDay(GO.util.customDate(this.date,"YYYY-MM-DD")),this.updateBaseDate(),GO.EventEmitter.on("timeline","change:data",function(){this.renderContent()},this)},popupUserStat:function(e){if(!e)return;window.open("/app/ehr/timeline/userstat/"+e,e,"scrollbars=yes,resizable=yes,width=1280,height=640")},getUrlParams:function(){var e={};return window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,n,r){e[n]=r}),this.queryParams=e,this.queryParams},updateBaseDate:function(){this.baseDate=GO.util.customDate(this.date,"YYYY-MM-DD"),this.options.baseDate=this.baseDate,this.viewDate=GO.util.customDate(this.date,"YYYY.MM"),f.setSelectedDay(GO.util.customDate(this.date,"YYYY-MM-DD")),this.changeBaseDate()},render:function(){if(!!this.options.userId&&!!this.getUrlParams().popup)return"";this.$el.html(t({userNameAndDeptName:u.bind(function(){var e=GO.session().id;if(this.options.userId==e)return"";var t=a.read(this.options.userId),n=t.get("name"),r=u.chain(t.get("deptMembers")).map(function(e){return e.deptName}).join(",").value();return"("+r+" - "+n+")"},this),TimelineLang:n,CommonLang:r,baseDate:this.viewDate})),this.$el.find("#summary").html(this.summaryView.$el),this.$el.find("#month").html(this.monthView.$el),this.$el.find("#history").html(this.historyView.$el),this.renderContent(),this.initDatePicker()},renderContent:function(){this.summaryView.render(),this.monthView.render(this.baseDate),this.historyView.refresh()},prevMonth:function(){this.date=moment(this.date).subtract(1,"months"),this.updateBaseDate()},nextMonth:function(){this.date=moment(this.date).add(1,"months"),this.updateBaseDate()},showCal:function(){var e=this.$el.find("#calendarDatepicker");e.attr("autocomplete","off"),e.trigger("focus")},initDatePicker:function(){this.$el.find("#calendarDatepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:u.bind(function(e){this.date=e,this.updateBaseDate()},this)})},currentMonth:function(){this.date=new Date,this.updateBaseDate()},changeBaseDate:function(){GO.EventEmitter.trigger("common","layout:setOverlay",!0),f.initWeeks(),this.$el.find("#baseDate").html(this.viewDate),this.summaryView.changeBaseDate(moment(this.date)),this.historyView.changeBaseInfo(this.viewDate,this.options.userId),this.monthView.render(this.baseDate,this.options.userId),GO.EventEmitter.trigger("common","layout:clearOverlay",!0)}});return l});