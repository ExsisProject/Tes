define("timeline/views/mobile/user/main",function(require){var e=require("backbone"),t=require("timeline/models/auth"),n=require("amplify"),r=require("views/mobile/header_toolbar"),i=require("timeline/views/mobile/user/summary"),s=require("timeline/views/mobile/user/month"),o=require("ehr/common/models/side"),u=require("hgn!timeline/templates/mobile/user/main"),a=require("i18n!timeline/nls/timeline"),f=require("i18n!nls/commons"),l={label_clockIn:a["\ucd9c\uadfc\ud558\uae30"],label_clockOut:a["\ud1f4\uadfc\ud558\uae30"],label_clockInTime:a["\ucd9c\uadfc\uc2dc\uac04"],label_clockOutTime:a["\ud1f4\uadfc\uc2dc\uac04"],label_status_change:a["\uadfc\ubb34"]+a["\uc0c1\ud0dc"],label_record_gps_warning:a["\uc704\uce58\uc815\ubcf4 \ubbf8\ub3d9\uc758 \uacbd\uace0"]},c=e.View.extend({bindEvent:function(){var e=this;$("#currentMonth").click(function(t){e.moveToday(t)}),$("#prevMonth").click(function(t){e.prevMonth(t)}),$("#nextMonth").click(function(t){e.nextMonth(t)}),$("#workIn").click(function(t){e.clickWorkIn(t)}),$("#workOut").click(function(t){e.clickWorkOut(t)}),$("#statusList").change(function(t){e.changeStatus(t)})},unbindEvent:function(){$("#currentMonth").unbind("click"),$("#prevMonth").unbind("click"),$("#nextMonth").unbind("click"),$("#workIn").unbind("click"),$("#workOut").unbind("click"),$("#statusList").unbind("change")},initialize:function(e){this.options=e,this.date=new Date,this.baseDate=GO.util.customDate(this.date,"YYYY-MM-DD"),this.options.baseDate=this.baseDate,this.authModel=new t(GO.util.store.get("timeline.auth")),this.summaryView=new i(this.options),this.monthView=new s(this.options),this.time=moment(),this.side=new o,this.requestInfo={userId:this.options.userId,baseDate:moment().format("YYYY-MM-DD")},this.setLocation(),GO.EventEmitter.on("timeline","change:data",function(){this.render()},this)},render:function(){this.dataFetch(),this.$el.empty();var e=this.authModel.fetch({data:this.requestInfo});$.when(e).done(_.bind(function(){GO.util.store.set("timeline.auth",this.authModel.toJSON()),this.isCreatable=this.authModel.isCreatable(),this.renderTitleToolbar()},this)),$(".content_page").html(u({TimelineLang:a,CommonLang:f,baseDate:moment(this.baseDate).format("YYYY.MM"),timeline:this.side.getTimeline(),lang:l})),this.side.isTimelineActive()&&(this.setDateTime(),this.renderStatusList(),this.setCheckInOutTime(),this.isNightWork=this.side.getTimeline().nightWork),$("#summary").html(this.summaryView.$el),this.summaryView.render(),this.hideStateChangeableBtns(),$("#month").html(this.monthView.$el),this.monthView.render(this.convertServerFormat(this.baseDate)),this.unbindEvent(),this.bindEvent()},renderTitleToolbar:function(){var e=GO.session().id==this.options.userId?a["\ub0b4 \uadfc\ud0dc \ud604\ud669"]:"",t={title:e,isList:!0,isSideMenu:!0,isHome:!0};this.isCreatable&&(t.isWriteBtn=!1,t.writeBtnCallback=function(){GO.router.navigate("ehr/timeline/history/create",{trigger:!0,pushState:!0})}),this.headerToolbarView=r,this.headerToolbarView.render(t)},hideStateChangeableBtns:function(){this.side.isTimelineActive()&&(this.side.isTimelineSyncActive()||!this.side.isTimelineHasGroup()||!this.summaryView.model.group.isMobileAllow())&&($("select#statusList").hide(),$("div.btn_attend").hide())},changeStatus:function(e){var t=this,n=$("#statusList option:selected").val();$.ajax({type:"POST",dataType:"json",async:!1,url:GO.contextRoot+"api/ehr/timeline/status?"+$.param(this.getRequestInfo()),contentType:"application/json",data:JSON.stringify(_.extend(this.getVariable(n),this.location)),success:function(e){t.dataFetch(),GO.EventEmitter.trigger("timeline","change:data",function(){console.log("\uc0c1\ud0dc\ubcc0\uacbd")})},error:function(e){var t=e.responseJSON.message;t!=null?$.goSlideMessage(t,"caution"):$.goSlideMessage(adminLang["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."],"caution")}})},getRequestInfo:function(){return this.requestInfo},getVariable:function(e){return{checkTime:this.time.toISOString(),timelineStatus:{id:e},isNightWork:this.isNightWork,workingDay:this.isNightWork?this.time.subtract(1,"days").format("YYYY-MM-DD"):this.time.format("YYYY-MM-DD")}},dataFetch:function(){this.side.fetch({async:!1})},clickWorkIn:function(e){var t=this;if(!this.isRecordClock()){GO.util.delayAlert(a["\uc704\uce58\uc815\ubcf4 \ubbf8\ub3d9\uc758 \uacbd\uace0"]);return}if($(e.currentTarget).hasClass("off")||this.isEmptyLocation())return;$.ajax({type:"POST",dataType:"json",async:!1,url:GO.contextRoot+"api/ehr/timeline/status/clockIn?"+$.param(this.getRequestInfo()),contentType:"application/json",data:JSON.stringify(_.extend(this.getVariable(),this.location)),success:function(n){$(e.currentTarget).addClass("off"),t.dataFetch(),GO.EventEmitter.trigger("timeline","change:data",function(){},this)},error:function(e){var t=e.responseJSON.message;t!=null?alert(t):alert(adminLang["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."])}})},workOut:function(e){var t=this;$.ajax({type:"POST",dataType:"json",async:!1,url:GO.contextRoot+"api/ehr/timeline/status/clockOut?"+$.param(this.getRequestInfo()),contentType:"application/json",data:JSON.stringify(_.extend(this.getVariable(),this.location)),success:function(n){$(e.currentTarget).addClass("off"),t.dataFetch(),GO.EventEmitter.trigger("timeline","change:data",function(){console.log("\ud1f4\uadfc")},this)},error:function(e){var t=e.responseJSON.message;t!=null?alert(t):alert(adminLang["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."])}})},clickWorkOut:function(e){var t=this;if(!this.isRecordClock()){GO.util.delayAlert(a["\uc704\uce58\uc815\ubcf4 \ubbf8\ub3d9\uc758 \uacbd\uace0"]);return}if($(e.currentTarget).hasClass("off")||this.isEmptyLocation())return;if(t.isNightWork){var n='<p class="q">'+l.label_night_work_check+"</p>"+'<p class="add">'+l.label_night_work_description+"</p>";$.goPopup({width:400,title:"",pclass:"layer_confim layer_colleage layer_confim_attend",contents:n,buttons:[{btext:l.label_clockOutTime,btype:"confirm",autoclose:!0,callback:function(n){t.workOut(e)}},{btext:l.label_clockInTime,btype:"normal",autoclose:!0,callback:function(n){t.isNightWork=!1,t.clickWorkIn(e)}}]})}else this.workOut(e)},storeData:function(e,t){return n.store(e,t,{type:window.sessionStorage?"sessionStorage":null})},getStoredData:function(e){return window.sessionStorage?n.store.sessionStorage(e):n.store(e)},setDateTime:function(){var e=this.time.format("YYYY[-]MM[-]DD[(]ddd[)]");$("#date").text(e)},renderStatusList:function(){var e=this.side.getTimeline().timelineStatusList;$(e).each(function(e,t){$("#statusList").append("<option class='timelineStatus' value="+t.id+">"+t.name+"</option>")});var t=this.side.getTimeline().myStatus;t&&t.id&&t.timelineCode!="CLOCK_IN"&&t.timelineCode!="CLOCK_OUT"&&$("#statusList").val(t.id).prop("selected",!0)},setCheckInOutTime:function(){this.side.getTimeline().workInTime&&($("#workIn").removeClass("on"),$("#workIn").addClass("off"),$("#workInTime").text(this.side.getTimeline().workInTime)),this.side.getTimeline().workOutTime&&($("#workOut").removeClass("on"),$("#workOut").addClass("off"),$("#workOutTime").text(this.side.getTimeline().workOutTime))},moveToday:function(e){this.baseDate=moment(),this.changeBaseDate()},prevMonth:function(){this.baseDate=moment(this.baseDate).add("month",-1).format("YYYY-MM"),this.changeBaseDate()},nextMonth:function(){this.baseDate=moment(this.baseDate).add("month",1).format("YYYY-MM"),this.changeBaseDate()},changeBaseDate:function(e){$("#baseDate").html(moment(this.baseDate).format("YYYY.MM")),e==="refresh"?this.summaryView.render(this.convertServerFormat(this.baseDate)):this.summaryView.changeBaseDate(moment(this.baseDate)),this.monthView.render(this.convertServerFormat(this.baseDate),this.options.userId)},convertServerFormat:function(e){return moment(e).format("YYYY-MM-DD")},setLocation:function(){var e=this;navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){e.location={checkLatitude:t.coords.latitude,checkLongitude:t.coords.longitude}},function(t){e.positionErrorMsg=t.code===1?a["http\uc5d0\uc11c\uc758 gps\uc2e4\ud328 \uba54\uc2dc\uc9c0"]:a["\uc704\uce58 \uc815\ubcf4\ub97c \uac00\uc838\uc624\uc9c0 \ubabb\ud588\uc2b5\ub2c8\ub2e4."],e.location=null},{timeout:5e3})},isEmptyLocation:function(){return this.location?!1:(_.isUndefined(this.positionErrorMsg)&&(this.positionErrorMsg=a["\uc704\uce58 \uc815\ubcf4\ub97c \uac00\uc838\uc624\uc9c0 \ubabb\ud588\uc2b5\ub2c8\ub2e4."]),alert(this.positionErrorMsg),!0)},isRecordClock:function(){var e,t;return $.ajax({type:"GET",async:!1,url:GO.contextRoot+"api/ehr/timeline/record/gps",success:function(t){e=t.data.data},error:function(e){var t=e.responseJSON.message;t!=null?alert(t):alert(adminLang["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."])}}),e==0?!0:($.ajax({type:"GET",async:!1,url:GO.contextRoot+"api/agreement/gps",success:function(e){t=e.data.agreement},error:function(e){var t=e.responseJSON.message;t!=null?alert(t):alert(adminLang["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."])}}),t)}});return c});