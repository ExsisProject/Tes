define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("hgn!ehr/common/templates/side"),i=require("ehr/common/models/side"),s=require("attendance/views/statusPopup"),o=require("i18n!nls/commons"),u=require("i18n!timeline/nls/timeline"),a=require("i18n!admin/nls/admin"),f=require("i18n!attendance/nls/attendance"),l=require("i18n!vacation/nls/vacation"),c=require("i18n!welfare/nls/welfare"),h=require("amplify"),p=require("timeline/components/views/guide_layer"),d=require("components/backdrop/backdrop"),v=null,m=t.Model.extend({url:function(){return GO.contextRoot+"api/ehr/timeline/status"}}),g={label_clockIn:u["\ucd9c\uadfc\uc2dc\uac04"],label_clockOut:u["\ud1f4\uadfc\uc2dc\uac04"],label_unregistered:u["\ubbf8\ub4f1\ub85d"],label_weekSum:u["\uc8fc\uac04 \ub204\uc801 \uadfc\ubb34\uc2dc\uac04"],label_confirm:o["\ud655\uc778"],label_cancel:o["\ucde8\uc18c"],label_status:o["\uc0c1\ud0dc"],label_select:o["\uc120\ud0dd"],label_contents:o["\ub0b4\uc6a9"],label_collapse:o["\uc811\uae30"],label_expand:o["\ud3bc\uce58\uae30"],label_manage:o["\uad00\ub9ac"],label_clockInTime:u["\ucd9c\uadfc\ud558\uae30"],label_clockOutTime:u["\ud1f4\uadfc\ud558\uae30"],label_status_change:u["\uadfc\ubb34\uc0c1\ud0dc\ubcc0\uacbd"],label_night_work_check:u["\ub2a6\uc740 \ud1f4\uadfc \uccb4\ud06c"],label_night_work_description:u["\ub2a6\uc740 \ud1f4\uadfc \uc124\uba85"],label_unconfirm:f["\ubbf8\ud655\uc778"],label_completeInTime:f["\ucd9c\uadfc\uc644\ub8cc"],label_completeOutTime:f["\ud1f4\uadfc\uc644\ub8cc"],label_deptManage:u["\ubd80\uc11c \uadfc\ud0dc\uad00\ub9ac"],label_compManage:f["\uc804\uc0ac \uadfc\ud0dc\uad00\ub9ac"],label_attndStatus:f["\uadfc\ud0dc\ud604\ud669"],label_attndStatistics:f["\uadfc\ud0dc\ud1b5\uacc4"],label_myAttendance:f["\ub0b4 \uadfc\ud0dc"],label_myAttendanceStatus:f["\ub0b4 \uadfc\ud0dc \ud604\ud669"],label_manageAttendance:f["\uadfc\ud0dc\uad00\ub9ac"],label_date:f["\ub0a0\uc9dc"],label_time:f["\uc2dc\uac04"],label_statusDesc:f["\uc0c1\ud0dc\uc5d0 \ub300\ud55c \uac04\ub2e8\ud55c \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."],label_register:f["\ub4f1\ub85d"],label_myHrInfo:f["\ub0b4 \uc778\uc0ac\uc815\ubcf4"],label_deptAttndStatus:f["\ubd80\uc11c \uadfc\ud0dc\ud604\ud669"],label_deptAttndStatistics:f["\ubd80\uc11c \uadfc\ud0dc\ud1b5\uacc4"],label_deptHrInfo:f["\ubd80\uc11c \uc778\uc0ac\uc815\ubcf4"],label_compAttndStatus:f["\uc804\uc0ac \uadfc\ud0dc\ud604\ud669"],label_compAttndStatistics:f["\uc804\uc0ac \uadfc\ud0dc\ud1b5\uacc4"],label_compHrInfo:f["\uc804\uc0ac \uc778\uc0ac\uc815\ubcf4"],label_compVacationHistory:l["\uc804\uc0ac \uc5f0\ucc28\ud604\ud669"],label_deptVacationHistory:l["\ubd80\uc11c \uc5f0\ucc28\ud604\ud669"],label_myVacationInfo:l["\ub0b4 \uc5f0\ucc28 \ub0b4\uc5ed"],label_companyWelfare:c["\uc804\uc0ac \ubcf5\uc9c0\ud3ec\uc778\ud2b8"],label_myWelfareInfo:c["\ub0b4 \ubcf5\uc9c0\ud3ec\uc778\ud2b8"],label_compVacationUsageHistory:l["\uc804\uc0ac \uc5f0\ucc28 \uc0ac\uc6a9\ub0b4\uc5ed"],label_deptVacationUsageHistory:l["\ubd80\uc11c \uc5f0\ucc28 \uc0ac\uc6a9\ub0b4\uc5ed"]},y=GO.session("loginId")+"-attendance-timer",b=GO.session("loginId")+"-ehr-mine-toggle",w=GO.session("loginId")+"-ehr-dept-toggle",E=GO.session("loginId")+"-ehr-company-toggle",S=t.View.extend({el:"#side",events:{"click .lnb span.ic_side":"slideToggle","click .lnb span.txt":"slideToggle","click #workIn":"clickWorkIn","click #workOut":"clickWorkOut","click #changeStatus":"showStatuslist","click span#myTimelineStatus":"moveMyTimelineStatus","click li.timelineStatus":"changeStatus","click .dept_record":"moveTimelineDeptStats","click .dept_dashboard":"moveTimelineDeptDashboard","click .company_record":"moveTimelineCompanyStats","click #myHrcardInfo":"moveMyHrcardInfo","click #myVacationInfo":"moveMyVacationInfo","click #hrCardMngBtn":"moveHrCardMng","click #vacationMngBtn":"moveVacationMng","click #welfareMngBtn":"moveWelfareMng","click #myWelfareInfo":"moveMyWelfare","click .dashboard":"moveTimelineDashboard","click .analysis":"moveAttndRecord"},initialize:function(){this.$el.off(),this.status=new m,this.side=new i,GO.EventEmitter.on("timeline","change:data",_.bind(this.render,this))},getRequestInfo:function(){return this.requestInfo},dataFetch:function(){this.side.fetch({async:!1}),this.time=this.side.moment(),this.requestInfo={userId:GO.session("id"),baseDate:this.time.format("YYYY-MM-DD")}},showStatuslist:function(){this.backdropView||(this.backdropView=new d,this.backdropView.backdropToggleEl=e("div[el-backdrop]"),this.backdropView.linkBackdrop(e("#changeStatus")))},getVariable:function(e){var t=this.getCurrentTime();return{checkTime:t.toISOString(),timelineStatus:{id:e},isNightWork:this.isNightWork,workingDay:this.isNightWork?this.time.subtract(1,"days").format("YYYY-MM-DD"):this.time.format("YYYY-MM-DD")}},clickWorkIn:function(t){if(e(t.currentTarget).hasClass("off"))return;e.ajax({type:"POST",dataType:"json",async:!1,url:GO.contextRoot+"api/ehr/timeline/status/clockIn?"+e.param(this.getRequestInfo()),contentType:"application/json",data:JSON.stringify(this.getVariable()),success:function(e){GO.EventEmitter.trigger("timeline","change:data")},error:function(t){var n=t.responseJSON.message;n!=null?e.goSlideMessage(n,"caution"):e.goSlideMessage(a["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."],"caution")}})},clickWorkOut:function(t){var n=this;if(e(t.currentTarget).hasClass("off"))return;this.side.fetch({async:!1}),this.isNightWork=this.side.getTimeline().nightWork;if(this.isNightWork){var r='<p class="q">'+g.label_night_work_check+"</p>"+'<p class="add">'+g.label_night_work_description+"</p>";e.goPopup({width:400,title:"",pclass:"layer_confim layer_colleage layer_confim_attend",contents:r,buttons:[{btext:g.label_clockOutTime,btype:"confirm",autoclose:!0,callback:function(e){n.workOut(t)}},{btext:g.label_clockInTime,btype:"normal",autoclose:!0,callback:function(e){n.isNightWork=!1,n.clickWorkIn(t)}}]})}else this.workOut(t)},workOut:function(t){e.ajax({type:"POST",dataType:"json",async:!1,url:GO.contextRoot+"api/ehr/timeline/status/clockOut?"+e.param(this.getRequestInfo()),contentType:"application/json",data:JSON.stringify(this.getVariable()),success:function(e){GO.EventEmitter.trigger("timeline","change:data")},error:function(t){var n=t.responseJSON.message;n!=null?e.goSlideMessage(n,"caution"):e.goSlideMessage(a["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."],"caution")}})},changeStatus:function(t){var n=e(t.currentTarget).find("span").attr("data-code");this.backdropView=null,e.ajax({type:"POST",dataType:"json",async:!1,url:GO.contextRoot+"api/ehr/timeline/status?"+e.param(this.getRequestInfo()),contentType:"application/json",data:JSON.stringify(this.getVariable(n)),success:function(e){GO.EventEmitter.trigger("timeline","change:data")},error:function(t){var n=t.responseJSON.message;n!=null?e.goSlideMessage(n,"caution"):e.goSlideMessage(a["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."],"caution")}})},getCurrentTime:function(){var e=this.$el.find("#timer").text(),t=e.split(":"),n=moment().hour(t[0]).minute(t[1]).second(t[2]);return n},selectSideMenu:function(){var e;this.$el.find("p.on").removeClass("on");var t=n.router.getUrl().split("/");if(t[2]=="my"||t[1]=="hrcard"&&t[3]==GO.session("id"))e=this.$el.find('ul.side_depth p[data-folder-type="'+t[1]+'"]');else if(t[2]=="company"||!t[3]){var r=t[3]?t[3]:t[2];e=this.$el.find('ul.side_depth li.company p[data-navi="'+r+'"]')}else t[1]=="vacation"?e=this.$el.find('ul.side_depth li[data-deptid="'+t[2]+'"] li[data-folder-type="'+t[1]+'"] p[data-navi="'+t[3]+'"]'):e=this.$el.find('ul.side_depth li[data-deptid=  "'+t[3]+'"] li[data-folder-type="'+t[1]+'"] p[data-navi="'+t[2]+'"]');e.length&&e.addClass("on")},setGadgetBtnVisibility:function(){this.side.isTimelineActive()&&(this.side.isTimelineSyncActive()||!this.side.isTimelineHasGroup())&&(e("div.function_btn_wrap").hide(),e("div.works_state").hide())},renderTimer:function(){var e=this.time.format("HH:mm:ss");this.$el.find("#timer").text(e)},setTimerInterval:function(){var e=this,t=this.getStoredData(y);t&&clearInterval(t);var n=setInterval(function(){e.time=e.time.add(1,"seconds"),e.renderTimer()},1e3);this.storeData(y,n)},setDateTime:function(){var e=this.time.format("YYYY[-]MM[-]DD[(]ddd[)]");this.$el.find("#date").text(e)},render:function(){this.dataFetch(),this.renderTimer();var t=this.getStoredData(b),n=this.getStoredData(w),i=this.getStoredData(E),s=r({contextRoot:GO.contextRoot,lang:g,TimelineLang:u,data:this.side.toJSON(),timeline:this.side.getTimeline(),isMineOpen:_.isUndefined(t)?!0:t,isDeptOpen:_.isUndefined(n)?!0:n,isCompanyOpen:_.isUndefined(i)?!0:i,hrcard:this.side.getHrcard(),vacation:this.side.getVacation(),welfare:this.side.getWelfare(),isEhrActive:this.side.isEhrActive(),isEhrManager:this.side.isEhrManager(),hasDepts:this.side.hasDepts(),useDeptSituationAndStats:this.side.useDeptSituationAndStats(),appName:GO.util.getAppName("ehr"),email:GO.session("email"),hasActiveDeptEhr:function(){var e=this.timeline.active,t=this.hrcard.active,n=this.vacation.active;return e||t||n}});this.$el.html(s),this.side.isTimelineActive()&&(this.renderTimer(),this.setTimerInterval(),this.setDateTime(),this.renderStatusList(),this.setCheckInOutTime(),this.setMyStatus(),this.setTotalTime(),this.setGuide(),this.isNightWork=this.side.getTimeline().nightWork),this.selectSideMenu(),this.setGadgetBtnVisibility(),e("body").trigger("ehr.sideRender")},renderStatusList:function(){var t=this.side.getTimeline().timelineStatusList;e(t).each(function(t,n){e("#statusList").append("<li class='timelineStatus'><span class=\"txt \" data-code="+n.id+">"+n.name+"</span></li>")})},setMyStatus:function(){var t=this.side.getTimeline().myStatus;t&&t.id&&t.timelineCode!="CLOCK_IN"&&t.timelineCode!="CLOCK_OUT"&&(e("#changeStatus").find("span.txt").text(this.side.getTimeline().myStatus.name+"\u00a0\u00a0"),e("#changeStatus").find("span.txt").append('<span class="ic_side ic_show_down"></span>'))},setCheckInOutTime:function(){this.side.getTimeline().workInTime&&(e("#workIn").removeClass("on"),e("#workIn").addClass("off"),e("#workInTime").text(this.side.getTimeline().workInTime)),this.side.getTimeline().workOutTime&&(e("#workOut").removeClass("on"),e("#workOut").addClass("off"),e("#workOutTime").text(this.side.getTimeline().workOutTime))},setTotalTime:function(){if(this.side.getTimeline().totalTime){var t=this.side.getTimeline().totalTime;e("#weeklyTotalTime").text(t)}},setGuide:function(){var t=new p;this.$el.find("#guide").html(t.$el),t.render(),e("#guideBadge").draggable({containment:"body"})},getTimeString:function(e){var t=e/36e5,n=e%36e5/6e4;return this.padDigits(parseInt(t),2)+"h "+this.padDigits(parseInt(n),2)+"m"},padDigits:function(e,t){return Array(Math.max(t-String(e).length+1,0)).join(0)+e},slideToggle:function(t){var n=e(t.currentTarget),r=n.parents("h1"),i=r.find(".ic_hide_up"),s=this;r.next("ul").slideToggle("fast",function(){e(this).css("display")=="block"?(r.removeClass("folded"),i.attr("title",g.label_collapse)):(r.addClass("folded"),i.attr("title",g.label_expand));var t=r.hasClass("mine"),n=r.hasClass("org"),o=r.hasClass("company"),u=!r.hasClass("folded");t?s.storeData(b,u):n?s.storeData(w,u):o&&s.storeData(E,u)})},addAttndStatus:function(t){var n=this;this.popupEl=e.goPopup({header:g.label_status_change,lang:g,width:810,modal:!0,pclass:"layer_normal layer_go_status",contents:"",buttons:[{btype:"confirm",btext:g.label_register,autoclose:!1,callback:function(){i.addStatus(),n.popupEl.close()}},{btype:"close",btext:g.label_cancel,autoclose:!0,callback:function(){}}]});var r={record:this.record,action:"create",type:"status",userid:GO_Session.id},i=new s(r);this.popupEl.find("div.content").html(i.render().el)},storeData:function(e,t){return h.store(e,t,{type:window.sessionStorage?"sessionStorage":null})},getStoredData:function(e){return window.sessionStorage?h.store.sessionStorage(e):h.store(e)},moveMyTimelineStatus:function(e){GO.router.navigate("ehr/timeline/my",{trigger:!0})},moveAttndRecord:function(t){e(t.currentTarget).hasClass("prev_company_attnd")?GO.router.navigate("ehr/attendance/companylist",{trigger:!0}):e(t.currentTarget).hasClass("prev_org_attnd")&&GO.router.navigate("ehr/attendance/deptlist/"+e(t.currentTarget).closest("li.org").attr("data-deptid"),{trigger:!0})},moveTimelineDeptDashboard:function(t){var n=e(t.currentTarget).closest("li.org").attr("data-deptid");if(!n)return;GO.router.navigate("ehr/timeline/dept/dashboard/"+n,{trigger:!0})},moveTimelineDeptStats:function(t){var n=e(t.currentTarget).closest("li.org").attr("data-deptid");n?GO.router.navigate("ehr/timeline/deptstats/"+n,{trigger:!0}):GO.router.navigate("ehr/attendance/alldepstats/",{trigger:!0})},moveTimelineCompanyStats:function(){GO.router.navigate("ehr/timeline/companystats/",{trigger:!0})},moveTimelineDashboard:function(){GO.router.navigate("ehr/timeline/dashboard",{trigger:!0})},moveMyHrcardInfo:function(e){GO.router.navigate("ehr/hrcard/detail/"+GO.session("id"),{trigger:!0})},moveHrCardMng:function(){GO.router.navigate("ehr/hrcard/hrcardmanage",{trigger:!0})},moveMyVacationInfo:function(){GO.router.navigate("ehr/vacation/my",{trigger:!0})},moveMyWelfare:function(){GO.router.navigate("ehr/welfare/my",{trigger:!0})},moveVacationMng:function(){GO.router.navigate("ehr/vacation/config",{trigger:!0})},moveWelfareMng:function(){GO.router.navigate("ehr/welfare/config",{trigger:!0})},getAccountUseEhrOption:function(){var e=this.side.getHrcard();return _.isEmpty(e)?!1:e.accountUseEhr}},{render:function(){return v==null&&(v=new S,v.render()),v}});return GO.router.on("route",function(){v=null},this),S});