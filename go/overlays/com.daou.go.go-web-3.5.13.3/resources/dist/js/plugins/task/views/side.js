(function(){define(["backbone","app","i18n!nls/commons","i18n!task/nls/task","hgn!task/templates/side","task/collections/task_department_folders","models/dept_root","models/dept_tree","task/views/side_dept","task/views/side_folder","favorite","admin/models/task_config","amplify","task/components/task_dept_tree/task_dept_tree","task/models/task_dept_auth"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v=Hogan.compile('<li class="assigned" data-item="subDeptFolder"><p class="title"><a><ins class="ic"></ins><span class="txt" title="{{lang.subTask}}">{{lang.subTask}}</span></a></p></li>'),m=Hogan.compile('<li class="closed" data-item="closedFolder"><p class="title"><a><ins class="ic"></ins><span class="txt" title="{{lang.endTask}}">{{lang.endTask}}</span></a></p></li>'),g={task:n["\uc5c5\ubb34"],newTask:r["\uc0c8 \uc5c5\ubb34"],orgTaskCondition:r["\uc870\uc9c1\ub3c4\ubcc4 \uc5c5\ubb34\ud604\ud669"],deptFolder:r["\ubd80\uc11c\ubcc4 \uc5c5\ubb34 \ud3f4\ub354"],addFolder:r["\uc5c5\ubb34 \ud3f4\ub354 \ucd94\uac00"],subTask:r["\ud558\uc704 \ubd80\uc11c \uc5c5\ubb34 \ud3f4\ub354"],companyFolder:r["\uc804\uc0ac \uc5c5\ubb34 \ud3f4\ub354"],emptyDept:r["\uc18c\uc18d\ub41c \ubd80\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],contactAdmin:r["\uad00\ub9ac\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."],endTask:r["\uc911\uc9c0\ub41c \uc5c5\ubb34 \ud3f4\ub354"],fold:n["\uc811\uae30"],outspread:n["\ud3bc\uce58\uae30"],deletedDept:n["\uc0ad\uc81c\ub41c \ubd80\uc11c"]},y=GO.session("loginId")+"-task-company-toggle",b=GO.session("loginId")+"-task-dept-toggle",w=GO.session("loginId")+"-task-tree-toggle",E=p.TaskDeptsTreeMenuView,S=e.View.extend({el:"#side",events:{"click #newTask":"newTaskAction","click h1[data-tag=fold]":"fold","click li[data-item=subDeptFolder]":"goSubDeptFolder","click li[data-item=closedFolder]":"goClosedFolder","click #side_favorite li[data-item]":"highlightFavorite","click #createFolderBtn":"goCreateFolder","click #goTaskHome":"goTaskHome","click a.node-value":"goTaskCalendar"},initialize:function(){this.taskDeptTreeView=null,this.deptRoot=new o,this.$el.off(),this.deptFolders=new s({type:"dept"}),this.companyFolders=new s({type:"public"}),this.taskDeptsAuth=new d,this.model=c.read({admin:!1}).toJSON(),GO.config("attachNumberLimit",this.model.attachNumberLimit),GO.config("attachSizeLimit",this.model.attachSizeLimit),GO.config("maxAttachNumber",this.model.maxAttachNumber),GO.config("maxAttachSize",this.model.maxAttachSize),GO.config("excludeExtension",this.model.excludeExtension?this.model.excludeExtension:""),GO.config("priorityTask",this.model.priorityTask)},render:function(){this.deptRoot.fetch({async:!1}),this.lastDeptId=GO.util.store.get("deptTreeId")==null?this.deptRoot.id:GO.util.store.get("deptTreeId"),this.deptsTree=new u({deptId:this.lastDeptId});var e=this.deptFolders.fetch(),t=this.deptsTree.fetch(),n=this.companyFolders.fetch(),r=this.getFolderPresent(),s=this.taskDeptsAuth.fetch(),o=this;$.when(e,t,n,r,s).done(function(){var e=o.taskDeptsAuth.get("true");o.$el.html(i({lang:g,folderPresent:o.deptFolders.folderPresent(),deptPresent:o.deptFolders.deptPresent(),companyFolderPresent:o.companyFolders.deptPresent(),isDeptOpen:o.getStoredCategoryIsOpen(b),isCompanyOpen:o.getStoredCategoryIsOpen(y),isTreeOpen:o.getStoredCategoryIsOpen(w),isDeptTaskPriority:GO.config("priorityTask"),isTaskDeptVisle:e,appName:GO.util.getAppName("task")}));if(e){var t=null;o.taskDeptTreeView==null?t=o.deptsTree.toJSON():t=o.taskDeptTreeView.taskTreeNodes[0],o.taskDeptTreeView=o.renderInitTaskTree(t),$("#sideTaskDeptTree").append(o.taskDeptTreeView.el)}else GO.util.store.set("deptTreeId",o.deptRoot.id);o.renderDeptView(o.deptFolders,$("#sideDeptList"),!0),o.renderDeptView(o.companyFolders,$("#companyList"),!1),o.renderFavorite(),o.renderHighlight()})},renderHighlight:function(){var e=GO.util.store.get("sideItem");this.$("li[data-item="+e+"]").find("p:first").addClass("on"),GO.util.store.set("sideItem",null,{type:"session"})},renderFavorite:function(){var e=this,t=l.create({el:"#side_favorite",url:GO.config("contextRoot")+"api/task/folder/favorite",type:"task",liClass:"task",link:function(e){return"task/folder/"+e.get("id")+"/task"},overrideDataSet:function(t){return{id:t.get("id"),name:t.get("name"),newMark:e.isNew(t.get("taskCreatedAt")),privateMark:e.isPrivate(t)}}});t.$el.on("refresh",function(){t.reload()})},getFolderPresent:function(){var e=this;return $.ajax({type:"GET",dataType:"json",url:GO.contextRoot+"api/task/folder/present",success:function(t){e.folderPresent=t.data},error:function(e){$.goError(e.responseJSON.message)}})},newTaskAction:function(){var e=GO.util.store.get("taskFolderId"),n="";e?n="task/folder/"+e+"/create":n="task/create";var r=function(){t.router.navigate(n,!0)};GO.util.editorConfirm(r)},renderDeptView:function(e,t,n){var r=this;_.each(e.models,function(e){var r=new a({dept:e,isDeptList:n});t.append(r.render().el),r.renderFolders()},this),n&&(this.folderPresent.stoppedFolders&&t.append(m.render({lang:g})),(this.folderPresent.subdeptLiveFolders||this.folderPresent.subdeptStoppedFolders)&&t.append(v.render({lang:g})))},renderInitTaskTree:function(e){var t=new E({lastId:this.lastDeptId,nodes:[e],deptId:e.data.id,parentId:e.data.parentId==null?0:e.data.parentId});return t.render(),t},fold:function(e){var t=$(e.currentTarget),r=t.attr("data-type"),i=t.find("span.ic_side");t.hasClass("folded")?(t.removeClass("folded"),i.attr("title",n["\uc811\uae30"]),$("#"+r).slideDown(200)):(t.addClass("folded"),i.attr("title",n["\ud3bc\uce58\uae30"]),$("#"+r).slideUp(200));var s=t.hasClass("company"),o=t.hasClass("org"),u=t.hasClass("tree"),a=!t.hasClass("folded");s?this.storeCategoryIsOpen(y,a):o?this.storeCategoryIsOpen(b,a):u&&this.storeCategoryIsOpen(w,a)},goSubDeptFolder:function(){var e=this,n=function(){var n=e.folderPresent.subdeptLiveFolders?"Live":"Stopped";GO.util.store.set("taskFolderId",null,{type:"session"}),GO.util.store.set("sideItem","subDeptFolder",{type:"session"}),t.router.navigate("task/dept/sub/"+n,!0),$(document).scrollTop(0)};GO.util.editorConfirm(n)},goCreateFolder:function(e){var n=function(){GO.util.store.set("taskFolderId",null,{type:"session"}),t.router.navigate("task/folder/create",!0),$(document).scrollTop(0)};GO.util.editorConfirm(n)},goTaskHome:function(){var e=function(){GO.util.store.set("taskFolderId",null,{type:"session"}),t.router.navigate("task",!0),$(document).scrollTop(0)};GO.util.editorConfirm(e)},goClosedFolder:function(e){var n=function(){GO.util.store.set("taskFolderId",null,{type:"session"}),GO.util.store.set("sideItem","closedFolder",{type:"session"}),t.router.navigate("task/dept/close",!0),$(document).scrollTop(0)};GO.util.editorConfirm(n)},goTaskCalendar:function(e){var t=$(e.currentTarget).data("id");GO.util.store.set("deptTreeId",t,null);var n="task/depts/"+t;GO.router.navigate(n,!0)},highlightFavorite:function(e){var t=$(e.currentTarget).attr("data-id");GO.util.store.set("sideItem","favorite"+t,{type:"session"})},isNew:function(e){return e?GO.util.isCurrentDate(e,1):!1},getDeptShares:function(e){return _.filter(e.nodes,function(e){return _.contains(["department","subdepartment"],e.nodeType)})},isPrivate:function(e){var t=this.getDeptShares(e.get("share")),n=_.find(t,function(t){return t.nodeId==e.get("deptId")},this);return n?n.members.length?!0:!1:!1},getStoredCategoryIsOpen:function(e){var t="";return window.sessionStorage?t=h.store.sessionStorage(e):t=h.store(e),t==undefined&&(t=!0),t},storeCategoryIsOpen:function(e,t){return h.store(e,t,{type:window.sessionStorage?"sessionStorage":null})}},{__instance__:null,render:function(){this.__instance__===null&&(this.__instance__=new this.prototype.constructor),this.__instance__.render()}});return S})}).call(this);