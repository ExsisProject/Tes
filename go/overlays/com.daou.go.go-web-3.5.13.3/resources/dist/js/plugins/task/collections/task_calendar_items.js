define(function(require){var e=require("moment"),t=require("matrix/collections/matrix_collection");return t.extend({initialize:function(e,t){this.deptId=t.deptId,this.rangeType=t.rangeType||"week",this.setRangeType(this.rangeType),this.page=0,this.offset=20},url:function(){return GO.contextRoot+"api/task/depts/"+this.deptId+"?"+this._getParam()},parse:function(t){return t.page&&this._setPageInfo(t),_.each(t.data,function(t){_.each(t.tasks,function(t){!t.beginDate&&t.dueDate&&(t.beginDate=e(t.dueDate).startOf("day").format("YYYY-MM-DDTHH:mm:ss.SSSZ")),t.beginDate&&!t.dueDate&&(t.dueDate=e(t.beginDate).endOf("day").format("YYYY-MM-DDTHH:mm:ss.SSSZ"))})}),_.map(t.data,function(e){return{rowKey:e.member.id,rowTitle:e.member.name,rowSubTitle:e.member.position||"",values:this.initMatrixItems(e.tasks,{startTimeKey:"beginDate",endTimeKey:"dueDate"})}},this)},changeTimeCallback:function(){this.page=0,this.setRangeFromMatrix(),this.fetch()},setRangeType:function(e){this.rangeType=e,this.setRange()},setRangeFromMatrix:function(){this.fromDate=this.matrix.get("startTime"),this.toDate=this.matrix.get("endTime")},setRange:function(){this.fromDate=e().startOf(this.rangeType).format("YYYY-MM-DDTHH:mm:ss.SSSZ"),this.toDate=e().endOf(this.rangeType).format("YYYY-MM-DDTHH:mm:ss.SSSZ")},hasMore:function(){return!this.lastPage},getFullIndex:function(e){return this.page*this.offset+e},_getParam:function(){return $.param({fromDate:this.fromDate,toDate:this.toDate,page:this.page,offset:this.offset})},_setPageInfo:function(e){_.each(e.page,function(e,t){this[t]=e},this)}})});