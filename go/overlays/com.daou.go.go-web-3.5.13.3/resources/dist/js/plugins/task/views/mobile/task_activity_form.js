(function(){define(["backbone","hogan","app","admin/models/task_config","i18n!nls/commons","i18n!task/nls/task","hgn!task/templates/mobile/task_activity_form","task/models/task_activity","views/mobile/header_toolbar","components/go-fileuploader/mobile"],function(e,t,n,r,i,s,o,u,a,f){var l=!1,c=t.compile('<li data-path="{{path}}" data-name="{{name}}" data-id="{{id}}"><span class="item_image"><span class="thumb"><img src="{{thumbSmall}}" alt="{{name}}"></span><span class="img_tit">{{name}}</span><span class="txt"> ({{fileSizeStr}})</span><a class="iscroll-tap-highlight"><span class="btn_wrap" data-btntype="attachDelete"><span class="ic ic_del"></span></span></a></span></li>'),h=t.compile('<li data-path="{{attach.path}}" data-name="{{attach.name}}" data-id="{{attach.id}}"><span class="item_file"><span class="ic_file {{style}}"></span><span class="name">{{attach.name}}</span><span class="size"> ({{attach.fileSizeStr}})</span><span class="optional" data-btntype="attachDelete"><a class="ic_classic ic ic_del"></a></span></span></li>'),p=e.View.extend({el:"#content",events:{"keyup textarea":"_expandTextarea","vclick span[data-btntype='attachDelete']":"deleteAttach"},initialize:function(){this.activity=new u(this.options),this.activity.id&&this.activity.fetch({async:!1}),this.$el.off(),this.headerBindEvent()},headerBindEvent:function(){GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","task-save",this.submit,this)},render:function(){a.render({title:this.activity.get("id")?s["\ud65c\ub3d9\uae30\ub85d \uc218\uc815"]:s["\ud65c\ub3d9\uae30\ub85d \ub4f1\ub85d"],isClose:!0,actionMenu:[{id:"task-save",text:i["\ub4f1\ub85d"],triggerFunc:"task-save"}]}),this.$el.html(o({activity:this.activity.toJSON(),hasAttach:this.activity.hasAttach(),content:GO.util.unescapeHtml(this.activity.get("content")),isMobileApp:GO.config("isMobileApp")})),this.renderAttach(),this.configModel=r.read({admin:!1}),this.attachFileUploader()},attachFileUploader:function(){var e={};e.success=$.proxy(function(e){var t=typeof e=="string"?JSON.parse(e):e.data;this.$("#attachWrap").show();if($("div.option_display").data("attachable")==="false")return;try{this.attachValidate(t)}catch(n){n.message==="overMaxAttachNumber"&&$("div.option_display").data("attachable","false");return}this.addAttachEl(this.attachParser(t)),$("span[data-btntype=attachDelete]").on("vclick",$.proxy(this.deleteAttach,this))},this),e.error=function(){alert(i["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},e.androidCallFile=$.proxy(function(){this.callFile()},this),f.bind(this.$el.find("#go-fileuploader"),e)},deleteAttach:function(e){return this.$el.find("div.option_display").data("attachable","true"),$(e.currentTarget).closest("li").remove(),!1},submit:function(){if(l)return;this.activity.set({writer:_.pick(GO.session(),"id","name","email","position","thumbnail"),content:GO.util.escapeHtml(this.$el.find("textarea").val()),attaches:f.getAttachInfo("#attachWrap")}),this.activity.save({},{success:function(e){console.log(e.id),l=!0,n.router.navigate("task/"+e.taskId+"/detail",!0)},complete:function(){l=!1}})},renderAttach:function(){_.each(this.activity.get("attaches"),function(e){this.addAttachEl(e)},this)},addAttachEl:function(e){var t=e.extention;e.fileSizeStr=GO.util.getHumanizedFileSize(e.size),GO.util.isImage(t)?$("#imageWrap").append(c.render(e)):$("#fileWrap").append(h.render({attach:e,style:GO.util.getFileIconStyle(e)}))},attachValidate:function(e){var t=GO.util.getFileNameAndTypeData(e),r=this.configModel.get("attachSizeLimit")?this.configModel.get("maxAttachSize"):-1,s=this.configModel.get("attachNumberLimit")?this.configModel.get("maxAttachNumber"):-1,o=this.configModel.get("excludeExtension")==undefined?"":this.configModel.get("excludeExtension");this.configModel.get("attachSizeLimit")?r=this.configModel.get("maxAttachSize"):GO.config("allowedFileUploadSize")&&(r=GO.config("allowedFileUploadSize")/1024/1024);try{$.goValidation.attachValidate("#attachWrap ul li",t,r,s,o)}catch(u){var a=u.message;if(a=="ExtentionException")GO.util.delayAlert(n.i18n(i["\ud655\uc7a5\uc790\uac00 \ub561\ub561\uc778 \uac83\ub4e4\uc740 \ucca8\ubd80 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],"arg1",o));else if(a=="AttachSizeException")GO.util.delayAlert(n.i18n(i["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",r));else{if(a=="AttachNumberException")throw GO.util.delayAlert(n.i18n(i["\ucca8\ubd80 \ud30c\uc77c \uac1c\uc218\ub97c \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4."],"arg1",s)),new Error("overMaxAttachNumber");if(a=="AttachNumberExceptionBySaaS")throw GO.util.delayAlert(n.i18n(i["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",s)),new Error("overMaxAttachNumber");(a="NotFoundExtException")&&GO.util.delayAlert(i["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},callFile:function(){var e=-1;this.configModel.get("attachSizeLimit")?e=this.configModel.get("maxAttachSize"):GO.config("allowedFileUploadSize")&&(e=GO.config("allowedFileUploadSize")/1024/1024);var t=this.configModel.get("attachNumberLimit")?this.configModel.get("maxAttachNumber"):-1,n=this.configModel.get("excludeExtension");if(!this.fileUploadCountValidate())return!1;this.configModel.get("attachNumberLimit")&&(t-=$("#attachWrap li").size()),GO.util.callFile(e,t,n)},fileUploadCountValidate:function(){if(this.configModel.get("attachNumberLimit")){var e=$("#attachWrap li").size(),t=this.configModel.get("maxAttachNumber");if(e>=t)return GO.util.delayAlert(n.i18n(i["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",t)),!1}return!0},attachParser:function(e){return{extention:e.fileExt,name:e.fileName,path:e.filePath,size:e.fileSize,thumbSmall:e.thumbnail}},_expandTextarea:function(e){GO.util.textAreaExpand(e)}});return p})}).call(this);