(function(){define(["backbone","hogan","app","i18n!nls/commons","i18n!task/nls/task","hgn!task/templates/task_activity","task/views/task_activity_item","task/collections/task_activities","task/models/task_activity","file_upload","go-webeditor/jquery.go-webeditor","jquery.go-preloader","go-fancybox"],function(e,t,n,r,i,s,o,u,a,f){var l={activity:i["\ud65c\ub3d9\uae30\ub85d"],attach:r["\ucca8\ubd80\ud30c\uc77c"],writeActivity:i["\ud65c\ub3d9\uae30\ub85d \uc4f0\uae30"],addAttach:r["\ud30c\uc77c \ucca8\ubd80"],regist:r["\ub4f1\ub85d"],cancel:r["\ucde8\uc18c"],save:r["\ub2e4\uc6b4\ub85c\ub4dc"],preview:r["\ubbf8\ub9ac\ubcf4\uae30"]},c=t.compile('<li data-name="{{name}}" data-id="{{id}}"><span class="item_file"><span class="ic_file {{style}}"></span><span class="name"><a href="{{downloadPath}}">{{file.name}}</a></span><span class="size">({{fileSize}})</span>{{#isPreviewable}}{{#isImage}}<a href="{{downloadPath}}" class="fancybox-thumbs fancybox-button" data-fancybox-group="{{imageGroupId}}" data-bypass="" title="{{file.name}}"><span class="btn_fn4"><span class="txt">{{lang.preview}}</span></span></a>{{/isImage}}{{^isImage}}<a class="btn-preview btn_fn4" data-id="{{file.encrypt}}" data-bypass=""><span class="btn-text txt">{{lang.preview}}</span></a>{{/isImage}}{{/isPreviewable}}<a href="{{downloadPath}}"><span class="btn_fn4"><span class="txt">{{lang.save}}</span></span></a></span></li>'),h=e.View.extend({events:{"click #fileWrap span.ic_del":"attachDelete","click #writeActivity":"writeActivity","click #editorToggle":"editorToggleListener","click #closeEditor":"editorToggleListener","click li[data-tag=activityTab]":"activityTabToggleAction","click #attachArea a.btn-preview":"preview"},initialize:function(e){this.taskId=e.taskId,this.activities=new u({taskId:this.taskId}),this.dept=e.dept,this.isPrint=e.isPrint,this.isChangeAttach=!0;var t=this;this.$el.on("change:attach",function(e,n){t.isChangeAttach=!0,t.changeAttachCount(n)})},dataFetch:function(){var e=$.Deferred(),t=this.activities.fetch();return $.when(t).done(function(){e.resolve(this)}),e},render:function(){return this.$el.addClass("activity_type"),this.$el.html(s({lang:l,fileCount:this.getAttachCount(this.activities.models),activityCount:this.activities.models.length,activityPresent:this.activities.models.length>0,dept:this.dept,isPrint:this.isPrint})),this.activities.models.length==0?this.initSmartEditor():this.$("div[data-area=editor]").hide(),this.initFileUpload(),this.renderActivities(),this.renderAttach(),this.allowAction=!0,this},getAttachCount:function(e){var t=0;return _.each(e,function(e){t+=e.get("attaches").length;var n=e.get("comments");_.each(n,function(e){t+=e.attaches.length})}),t},fetchActivities:function(){var e=this;this.activities.fetch({success:function(){var t=parseInt(e.$("#activityCount").text())-1;e.$("#activityCount").text(t),t||(e.$("#activityCount").hide(),e.toggleEditor(!0))}})},attachDelete:function(e){$(e.target).parents("li").remove()},getContent:function(){var e=GO.Editor.getInstance("editor").getContent();return e==""||$.trim(e)=="<br>"?"":e},writeActivity:function(){if(!GO.Editor.getInstance("editor").validate())return $.goError(r["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=this;if(!this.allowAction)return;this.allowAction=!1;var t=this.getContent();if(t==""){this.allowAction=!0;return}var n=new a({taskId:this.taskId});n.set({content:t,attaches:this.getActivityAttaches(),writer:_.pick(GO.session(),"id","name","email","position","thumbnail")}),n.save({},{success:function(t){e.activities.fetch({success:function(){e.isChangeAttach=!0,e.$el.trigger("change:log"),e.renderActivity(t)}}),e.allowAction=!0},error:function(t,n){$.goError(n.responseJSON.message),e.allowAction=!0}})},renderActivity:function(e){var t=this.initActivityItem(e),n=this.activities.length||0;$("#activityList").prepend(t.el),t.render(),$("#activityCount").show().text(n),$("#attachCount").text(parseInt($("#attachCount").text())+e.get("attaches").length),GO.Editor.getInstance("editor").setContent(" "),$("#fileWrap").find("li").remove(),this.toggleEditor(!1)},initActivityItem:function(e){var t=new o({model:e,taskId:this.taskId,dept:this.dept,isPrint:this.isPrint}),n=this;return t.on("change:activity",function(){n.fetchActivities()}),t.on("change:attach",function(e){n.isChangeAttach=!0,n.changeAttachCount(e)}),t},editorToggleListener:function(e){var t=typeof e=="object"?GO.util.toBoolean($(e.currentTarget).attr("data-display")):e;this.toggleEditor(t)},toggleEditor:function(e){var t=$("div[data-area=editor]"),n=$("#editorToggle");this.editor||this.initSmartEditor();if(e){n.hide(),t.show();var r=$("li[data-type=activity]");this.toggleActivityTab(r)}else n.show(),t.hide()},activityTabToggleAction:function(e){var t=$(e.currentTarget);this.toggleActivityTab(t)},toggleActivityTab:function(e){var t=this,n=e.attr("data-type");if(this.activityTab==n)return;this.activityTab=n,$("li[data-tag=activityTab]").removeClass("active"),e.addClass("active"),n=="activity"?(this.activities.length||($("div[data-area=editor]").show(),$("#editorToggle").hide()),$("#activityArea").show(),$("#attachArea").hide()):($("div[data-area=editor]").hide(),$("#editorToggle").show(),$("#activityArea").hide(),$("#attachArea").show(),this.isChangeAttach?this.activities.fetch().done(function(){t.renderAttach()}):this.renderAttach())},renderAttach:function(){var e=[];this.$("#attachList").find("li").remove(),_.each(this.activities.models,function(t){this.addAttachElement(t.attributes,e),_.each(t.get("comments"),function(t){this.addAttachElement(t,e)},this)},this),this.sortCreatedAtDesc(e),_.each(e,function(e){this.$("#attachList").append(c.render(e))},this),$.proxy($(".fancybox-thumbs").goFancybox(),this)},addAttachElement:function(e,t){var n=e.commentCount>=0?e.id:e.ownerId+"/comment/"+e.id;_.each(e.attaches,function(e){t.push({lang:l,file:e,fileSize:GO.util.getHumanizedFileSize(e.size),style:GO.util.getFileIconStyle(e),downloadPath:GO.contextRoot+"api/task/activity/"+n+"/download/"+e.id,imageGroupId:this.cid,isPreviewable:e.preview&&e.encrypt,isImage:GO.util.isImage(e.extention)})},this)},sortCreatedAtDesc:function(e){e.sort(function(e,t){return new Date(e.file.createdAt)>=new Date(t.file.createdAt)?-1:1})},preview:function(e){GO.util.preview($(e.currentTarget).attr("data-id"))},renderActivities:function(){return _.each(this.activities.models,function(e){var t=this.initActivityItem(e);$("#activityList").append(t.el),t.render()},this),this},getActivityAttaches:function(){var e=[];return _.each($("#fileWrap").find("li:not(.attachError)"),function(t){e.push({path:$(t).attr("data-path"),name:$(t).attr("data-name"),hostId:$(t).attr("data-hostId")})}),e},changeAttachCount:function(e){var t=this.$el.find("#attachCount"),n=parseInt(t.text());t.text(n+e)},initSmartEditor:function(){if(this.isPrint)return;if(this.dept.deletedDept)return;this.$("#editor").goWebEditor({contextRoot:GO.config("contextRoot"),lang:GO.session("locale"),height:"300px"}),this.editor=GO.Editor},initFileUpload:function(e){if(this.dept.deletedDept)return;var t=this,e={el:"#file-control",context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+l.addAttach+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie")};(new f(e)).queue(function(e,t){}).start(function(e,t){if(!GO.config("attachFileUpload"))return $.goAlert(r["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1;if(GO.config("excludeExtension")!=""){var i=$.inArray(t.type.substr(1).toLowerCase(),GO.config("excludeExtension").split(","));if(i>=0)return $.goMessage(n.i18n(r["\ud655\uc7a5\uc790\uac00 \ub561\ub561\uc778 \uac83\ub4e4\uc740 \ucca8\ubd80 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],"arg1",GO.config("excludeExtension"))),!1}if(GO.config("attachSizeLimit")){var s=t.size/1024/1024,o=GO.config("maxAttachSize");if(o<s)return $.goMessage(n.i18n(r["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",o)),!1}if(GO.config("attachNumberLimit")){var u=$("#fileWrap").find("li").size(),a=GO.config("maxAttachNumber");if(a<=u)return $.goMessage(n.i18n(r["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",a)),!1}}).progress(function(e,t){}).success(function(e,n,r){var i=GO.util.isImage(n.data.fileExt),s=t.$("#fileWrap"),o=i?"ul.img_wrap":"ul.file_wrap";if(GO.util.fileUploadErrorCheck(n))r.find(".item_file").append("<strong class='caution'>"+GO.util.serverMessage(n)+"</strong>"),r.addClass("attachError");else if(GO.util.isFileSizeZero(n))return $.goAlert(GO.util.serverMessage(n)),!1;r.attr("data-hostId",n.data.hostId),s.find(o).show().append(r)}).complete(function(e,t){console.info(t)}).error(function(e,t){console.info(t)})}});return h})}).call(this);