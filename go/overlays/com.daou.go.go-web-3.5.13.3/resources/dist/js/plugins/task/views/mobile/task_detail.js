(function(){define(["backbone","hogan","app","i18n!nls/commons","i18n!task/nls/task","hgn!task/templates/mobile/task_detail","task/models/task_folder","task/models/task","views/mobile/header_toolbar","attach_file"],function(e,t,n,r,i,s,o,u,a,f){var l={move:r["\uc774\ub3d9"],"delete":r["\uc0ad\uc81c"],list:r["\ubaa9\ub85d"],summary:i["\uc5c5\ubb34 \uac1c\uc694"],regist:r["\ub4f1\ub85d"],edit:r["\uc218\uc815"],type:i["\uc720\ud615"],assignee:i["\ub2f4\ub2f9\uc790"],dueDate:i["\uae30\ud55c"],delay:i["\uc9c0\uc5f0"],tag:i["\ubd84\ub958"],referer:i["\ucc38\uc870\uc790"],detail:i["\uc5c5\ubb34\uc0c1\uc138"],attach:i["\ucca8\ubd80\ud30c\uc77c"],count:i["\uac1c"],save:r["\uc800\uc7a5"],folder:i["\ud3f4\ub354"],emptyValue:i["\ubbf8\uc9c0\uc815"],selectFolder:i["\uc5c5\ubb34\ub97c \uc774\ub3d9\uc2dc\ud0ac \ud3f4\ub354\ub97c \uc120\ud0dd\ud558\uc138\uc694"],close:r["\ub2eb\uae30"],open:r["\uc5f4\uae30"],activity:i["\ud65c\ub3d9\uae30\ub85d"],changeState:i["\uc0c1\ud0dc\ubcc0\uacbd"],approver:i["\uc2b9\uc778\uc790"],notAuthorized:i["\uc5f4\ub78c \uad8c\ud55c\uc774 \uc5c6\ub294 \uc5c5\ubb34\uc785\ub2c8\ub2e4"]},c=e.View.extend({events:{"change #taskAction":"taskAction","vclick #copyUrl":"copyUrl"},initialize:function(e){this.task=new u(e),this.headerBindEvent()},headerBindEvent:function(){GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","task-activity-write",this.goActivityWrite,this),GO.EventEmitter.on("trigger-action","task-activity",this.goActivity,this),GO.EventEmitter.on("trigger-action","task-modify",this.goTaskEdit,this),GO.EventEmitter.on("trigger-action","task-delete",this.deleteTask,this),GO.EventEmitter.on("trigger-action","task-change",this.taskAction,this)},dataFetch:function(){var e=this,t=$.Deferred();return this.task.fetch({success:function(n){var r=n.getAction();e.folder=new o({id:n.get("folderId")}),$.when(r,e.folder.fetch()).done(function(){t.resolve(e)})},error:function(e,t){GO.util.linkToErrorPage(t)}}),t},render:function(){a.render({isPrev:!0,actionMenu:this.getUseMenus()});var e={content:GO.util.escapeXssFromHtml(this.task.get("content")),lang:l,folder:this.folder.toJSON(),data:$.extend(this.task.toJSON(),{}),createdAt:GO.util.basicDate(this.task.get("createdAt")),hasDueDate:!_.isEmpty(this.task.getBeginDate())||!_.isEmpty(this.task.getDueDate()),beginDate:this.task.getBeginDate(),dueDate:this.task.getDueDate(),tagLabel:this.task.getTagLabel()};return this.$el.addClass("go_renew"),this.$el.html(s(e)),this.$("#taskContent").css("overflow-x","auto"),this.renderApproverView(),this.renderFieldView(),this.renderAttachView(),this},getUseMenus:function(){var e=[],t={"\ud65c\ub3d9\uae30\ub85d\ub4f1\ub85d":{id:"task-activity-write",text:i["\ud65c\ub3d9\uae30\ub85d"],triggerFunc:"task-activity-write"},"\ud65c\ub3d9\uae30\ub85d":{id:"task-activity",text:i["\ud65c\ub3d9\uae30\ub85d"],cls:"btn_comments",triggerFunc:"task-activity"},"\uc218\uc815":{id:"task-modify",text:r["\uc218\uc815"],triggerFunc:"task-modify",inMoreBtn:!0},"\uc0ad\uc81c":{id:"task-delete",text:r["\uc0ad\uc81c"],triggerFunc:"task-delete",inMoreBtn:!0}};this.task.hasAction()&&(e.push({selectId:"taskAction",text:i["\uc0c1\ud0dc\ubcc0\uacbd"],selectTriggerFunc:"task-change"}),this.task.actions.forEach(function(t){e.push({selectId:"taskAction",id:t.id,text:t.name})}));var n=this.task.toJSON();return this.task.hasActivity()?(t.\ud65c\ub3d9\uae30\ub85d.commentsCount=n.activityCount,e.push(t.\ud65c\ub3d9\uae30\ub85d)):e.push(t.\ud65c\ub3d9\uae30\ub85d\ub4f1\ub85d),n.actions.updatable&&e.push(t.\uc218\uc815),n.actions.removable&&e.push(t.\uc0ad\uc81c),e},renderApproverView:function(){if(!this.task.get("issueType").approver)return;this.makeApproverView()},makeApproverView:function(){var e=this.task.get("approver");if(!e)return;var t=[e.name,e.position].join(" "),n='<tr id="approver"><th><span class="title">'+i["\uc2b9\uc778\uc790"]+"</span></th>"+'<td><span class="txt">'+t+"</span></td>"+"</tr>";$("tr#approver").replaceWith(n)},renderFieldView:function(){var e=this._getFields(this.folder.get("fields")).join(""),t=this._getFields(this.task.get("issueType").fields).join("");$("#fieldArea").replaceWith(e.concat(t))},_getFields:function(e){var t=[];return _.each(e,function(e){if(e.type=="SELECT")t.push(this.makeSelectField(e));else if(e.type=="BOOLEAN")t.push(this.makeBooleanField(e));else{if(e.type!="TEXT")return;t.push(this.makeTextField(e))}},this),t},makeSelectField:function(e){var n=this._getTaskFieldValue(e),r='<dt><span class="txt">{{field.name}}</span></dt><dd>{{taskFieldValue.value}}</dd>';return t.compile(r).render({field:e,taskFieldValue:n})},makeBooleanField:function(e){var n=this._getTaskFieldValue(e),r='<dt><span class="txt">{{field.name}}</span></dt><dd><input type="checkbox" {{#taskFieldValue}}checked{{/taskFieldValue}} disabled><label>{{field.message}}</label></dd>';return t.compile(r).render({field:e,taskFieldValue:GO.util.toBoolean(n.value)})},makeTextField:function(e){var n=this._getTaskFieldValue(e);if(!n||!n.value)return"";var r='<dt><span class="txt">{{field.name}}</span></dt><dd>{{taskFieldValue.value}}</dd>';return t.compile(r).render({field:e,taskFieldValue:n})},_getTaskFieldValue:function(e){return _.find(this.task.get("fieldValues"),function(t){return t.fieldId==e.id})},renderAttachView:function(){var e=this;this.attachView=f.create("#attachArea",this.task.get("attaches"),function(t){return GO.config("contextRoot")+"api/task/"+e.task.id+"/download/"+t.id})},taskAction:function(e){var t=this,n=$("#taskAction").val();if(!n)return;$.ajax({type:"PUT",dataType:"json",url:GO.contextRoot+"api/task/"+this.task.get("id")+"/action/"+n,success:function(e){t.task.fetch({success:function(e){e.getAction().done(function(){t.render(),alert(r["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])})}})}})},goTaskEdit:function(){if(/<.*>.*<\/.*>/.test(this.task.get("content"))){alert(i["PC\uc5d0\uc11c \ub4f1\ub85d\ud55c \uc5c5\ubb34\ub294 \ubaa8\ubc14\uc77c\uc5d0\uc11c \uc218\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}n.router.navigate("task/"+this.task.get("id"),!0)},goActivityWrite:function(){n.router.navigate("task/"+this.task.id+"/create",!0)},goActivity:function(){n.router.navigate("task/"+this.task.id+"/activities",!0)},deleteTask:function(){var e=this;confirm(GO.util.unescapeHtml(i["\uc5c5\ubb34 \uc0ad\uc81c \uc124\uba85"]))&&this.task.destroy().done(function(){n.router.navigate("task/folder/"+e.folder.get("id")+"/task",!0)})},copyUrl:function(e){GO.util.copyUrl(e)}});return c})}).call(this);