(function(){define(["backbone","hogan","app","i18n!nls/commons","i18n!task/nls/task","i18n!calendar/nls/calendar","hgn!task/templates/task","hgn!task/templates/task_partial","task/models/task","task/models/task_folder","calendar/models/event","task/collections/task_departments","task/collections/task_folders","task/views/task_title","go-nametags","file_upload","go-calendar","jquery.go-sdk","jquery.go-orgslide","go-webeditor/jquery.go-webeditor","jquery.calbean"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g={task:r["\uc5c5\ubb34"],regist:r["\ub4f1\ub85d"],edit:r["\uc218\uc815"],"delete":r["\uc0ad\uc81c"],location:r["\uc704\uce58"],selectDept:i["\ubd80\uc11c \uc120\ud0dd"],selectFolder:i["\ud3f4\ub354 \uc120\ud0dd"],title:r["\uc81c\ubaa9"],"private":r["\ube44\uacf5\uac1c"],assignee:i["\ub2f4\ub2f9\uc790"],dueDate:i["\uae30\ud55c"],dueDateDesc:i["\uae30\ud55c \uc124\uba85"],tag:i["\ubd84\ub958"],referer:i["\ucc38\uc870\uc790"],refererDesc:i["\ucc38\uc870\uc790 \uc124\uba85"],approver:i["\uc2b9\uc778\uc790"],approverDesc:i["\uc2b9\uc778\uc790 \uc124\uba85"],detail:i["\uc0c1\uc138\ub0b4\uc6a9"],cancel:r["\ucde8\uc18c"],type:i["\uc720\ud615"],privateDesc:i["\ube44\uacf5\uac1c \uc124\uba85"],addAttach:r["\ud30c\uc77c \ucca8\ubd80"],addCalEvent:r["\uce98\ub9b0\ub354\uc5d0 \uc77c\uc815 \ub4f1\ub85d"],calendar:r["\uce98\ub9b0\ub354"]},y=e.View.extend({events:{"change #deptList":"departmentCheck","change #folderList":"folderCheck","change #typeList":"typeCheck","click span.ic_del":"attachDelete","click #addCalendarEvent":"addCalendarEvent","click .ic_edit":"editCalendarEvent","click .ic_basket_bx":"deleteCalendarEvent","click #submitTask":"submitTask","click #goBackTask":"goBack"},initialize:function(e){this.options=e||{},this.task=new a(this.options),this.isCreate=this.options.id?!1:!0,this.editable={}},dataFetch:function(){var e=this,t=$.Deferred(),n=$.Deferred(),r=$.Deferred(),i=$.Deferred(),s=$.Deferred(),o=$.Deferred();this.task.id?this.task.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}}}).done(function(){o.resolve()}):o.resolve(),o.done(function(o){e.task.get("calendarEvent")&&(e.task.calendarEvent=new l(e.task.get("calendarEvent"))),e.folder=new f({id:e.options.folderId||e.task.get("folderId")||null}),e.folder.id?e.folder.fetch().done(function(){r.resolve()}):r.resolve(),r.done(function(n){e.task.id||e.task.set({folderId:e.folder.id||null,issueType:e.folder.defaultType()}),e.getEditable().done(function(){t.resolve()})}),e.departments=new c({type:"dept"}),e.departments.fetch().done(function(){n.resolve()}),$.when(r,n).done(function(){e.deptId=e.departments.isOneTeam()?e.departments.first().id:e.folder.get("deptId")||null,e.folders=new h,e.folders.setDeptId(e.deptId),e.deptId?i=e.folders.fetch({success:function(){e.folders.isOneFolder()&&!e.task.get("folderId")?(e.task.set({folderId:e.folders.first().id}),e.folder.id?s.resolve():(e.folder=new f({id:e.folders.first().id}),e.folder.fetch().done(function(){s.resolve()}))):s.resolve()}}):(e.folders.reset([]),i.resolve(),s.resolve())})});var u=$.Deferred();return $.when(t,n,s).done(function(){u.resolve(e)}),u},render:function(){this.renderCompleted=!0,this.$el.addClass("go_renew"),this.$el.html(o(this.getRenderData()));var e=new p({title:r["\uc5c5\ubb34"]+" "+(this.task.id?r["\uc218\uc815"]:r["\ub4f1\ub85d"])});return this.$el.find(".content_top").html(e.el),e.render(),this.partialRender(),this.initSmartEditor(),this.initFileUpload(),this.toggleTypeView(),this.setSelectData(),$("input[placeholder]").placeholder(),this.allowAction=!0,this},partialRender:function(){this.$el.find("tr[data-tag=partial]").remove(),this.$("#partialArea").replaceWith(u(this.getRenderData())),$.datepicker.setDefaults($.datepicker.regional[GO.config("locale")]),this.renderNameTagView("assignees"),this.renderNameTagView("referers"),this.renderDatepicker(),this.renderTagView(),this.renderField(this.folder.get("fields"),$("#folderFieldArea")),this.renderField(this.folder.getCurrentTypeFields($("#typeList").val()),$("#typeFieldArea")),this.renderApproverView()},getEditable:function(){var e=this,t=$.Deferred();return this.task.getEditableAttribute().done(function(n){e.editable=n,t.resolve()}),t},getRenderData:function(){var e=!0;this.task.hasEvent()&&(e=!1);var t=!0;return this.task.getCalendarEventCreator()&&(t=this.task.getCalendarEventCreator().id==GO.session().id),{lang:g,isAvailableCalendar:GO.isAvailableApp("calendar"),isCreate:this.task.id?!1:!0,showAddEventBtn:e,data:$.extend(this.task.toJSON(),{}),folder:this.folder.toJSON(),beginDate:this.task.getShortBeginDate(),dueDate:this.task.getShortDueDate(),departments:this.departments.toJSON(),folders:this.folders.toJSON(),editable:this.editable,files:this.task.getFiles(),images:this.task.getImages(),start:this.task.getEventStartDate(),end:this.task.getEventEndDate(),eventSummary:this.task.getEventSummary(),eventLocation:this.task.getEventLocation(),eventType:this.task.getEventType(),calendarId:this.task.getCalendarId(),eventId:this.task.getEventId(),timeType:this.task.getCalendarTimeType(),isEventEditable:t}},departmentCheck:function(){this.folder.id?this.typeChangeAlert("department"):this.changeDept()},folderCheck:function(){this.folder.id?this.typeChangeAlert("folder"):this.changeFolder()},typeCheck:function(){this.typeChangeAlert("type")},changeDept:function(){var e=this,t=$.Deferred();this.deptId=$("#deptList").val(),this.folders=new h,this.folders.setDeptId(this.deptId),this.deptId?t=this.folders.fetch():(this.folders.reset([]),t.resolve()),t.done(function(){e.renderFolderList(e.folders),e.changeFolder()})},changeFolder:function(){var e=this,t=$("#folderList").val(),n=$.Deferred();this.folder=new f({id:t}),t?n=this.folder.fetch():n.resolve(),n.done(function(){e.task.set({folderId:t,issueType:e.folder.defaultType()}),e.renderTypeView(),e.getEditable().done(function(){e.redrawTaskView()})})},changeType:function(){var e=$("#typeList").val();this.task.set({issueType:this.folder.findIssueType(e)});var t=this;this.getEditable().done(function(){t.redrawTaskView()})},toggleTypeView:function(){$("#typeList").find("option").length>1?$("#typeArea").show():$("#typeArea").hide()},renderFolderList:function(e){var n="{{#folders}}{{^separator}}<option value={{id}} {{#currentFolder}}selected{{/currentFolder}}>{{name}}</option>{{/separator}}{{/folders}}",r=$("select#folderList");r.find("option:gt(0)").remove(),r.append(t.compile(n).render({folders:e.toJSON()}))},renderTypeView:function(){$("#typeList").find("option").remove();var e=t.compile("<option value={{issueType.id}}>{{issueType.name}}</option>");_.each(this.folder.getIssueTypes(),function(t){$("#typeList").append(e.render({issueType:t}))}),$("#typeList").val(this.task.get("issueType").id)},typeChangeAlert:function(e){var t=this,n=e=="type"?i["\uc720\ud615 \ubcc0\uacbd \uacbd\uace0"]:i["\uc704\uce58 \ubcc0\uacbd \uacbd\uace0"],s=$.goPopup({contents:n,buttons:[{btext:r["\ud655\uc778"],callback:function(){e=="department"?t.changeDept():e=="folder"?t.changeFolder():e=="type"&&t.changeType()}},{btext:r["\ucde8\uc18c"]}]});s.find("a.btn_minor_s:last").bind("click",function(){t.revert(e)}),s.find("a.btn_layer_x").bind("click",function(){t.revert(e)})},revert:function(e){e=="department"?this.revertDept():e=="folder"?this.revertFolder():e=="type"&&this.revertType()},revertDept:function(){$("#deptList").val(this.deptId)},revertFolder:function(){$("#folderList").val(this.task.get("folderId"))},revertType:function(){$("#typeList").val(this.task.get("issueType").id)},setSelectData:function(){$("#deptList").val(this.deptId),$("#folderList").val(this.task.get("folderId"))},redrawTaskView:function(){var e=$("#taskName").val(),t=$("#dueDate").val(),n=$("#beginDate").val();this.partialRender(),$("#taskName").val(e),$("#dueDate").val(t),$("#beginDate").val(n),this.toggleTypeView()},getEditableAttributeByType:function(e){return e=="assignees"?this.editable.ASSIGNEE:e=="referers"?this.editable.REFERER:e=="approver"?this.editable.APPROVER:!0},renderNameTagView:function(e){var t=this.getEditableAttributeByType(e),n=this,r=d.create({},{useAddButton:t});$("#"+e).html(r.el);if(e=="approver"){var i=this.task.id?this.task.get("approver"):this.folder.get("approver");i&&r.addTag(i.id,i.name+" "+i.position||"",{removable:t})}else{var s=this.task.id?this.task.get(e):this.folder.get(e);_.each(s,function(e){r.addTag(e.id,e.name+" "+e.position||"",{removable:t})},this)}if(!this.task.id&&e=="assignees"&&this.folder.get("defaultAssignee")){var o=this._getSessionUser();r.addTag(o.id,o.name+" "+o.position||"",{removable:t})}r.$el.on("nametag:clicked-add",function(r,i){$.goOrgSlide(n.getOrgOption(i,t,e))})},getOrgOption:function(e,t,n){var s="";n=="assignees"?s=i["\ub2f4\ub2f9\uc790"]:n=="approver"?s=i["\uc2b9\uc778\uc790"]:n=="referers"&&(s=i["\ucc38\uc870\uc790"]);var o={header:s+" "+r["\uc120\ud0dd"],memberTypeLabel:s,externalLang:r,contextRoot:GO.contextRoot,isBatchAdd:!0,callback:$.proxy(function(i){var s=_.isArray(i)?i:[i];if(s[0].type=="org")return;if(n=="approver"){var o=$("#approver").find("li[data-id]").first();o.length&&$.goMessage(r["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.remove()}e.addTags(s,{removable:t,attr:i}),this.removeDefaultAssignee()},this)};n=="approver"&&(o.isOnlyOneMember=!0);if(this.folder.isCompanyShare()){var u=this.folder.getDomainCodeShares();if(u.length){var a=_.pluck(u,"nodeId");o.type="domaincode",o.includeLoadIds=a}else o.type="list"}else o.circle=this.folder.get("share"),o.type="circle",o.method="POST",o.isBatchAdd=!1;return o},isAssigneeType:function(){return this.folder.id?this.editable.ASSIGNEE:!1},removeDefaultAssignee:function(){this.$("#assignees").find("li[data-id='0']").remove()},renderDatepicker:function(){$("#beginDate").datepicker({yearSuffix:"",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,beforeShow:function(e,t){t.dpDiv.attr("data-layer","");var n=!0;$(document).trigger("showLayer.goLayer",n)},onClose:function(){var e=!0;$(document).trigger("hideLayer.goLayer",e)}}),$("#dueDate").datepicker({yearSuffix:"",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,beforeShow:function(e,t){t.dpDiv.attr("data-layer","");var n=!0;$(document).trigger("showLayer.goLayer",n)},onClose:function(){var e=!0;$(document).trigger("hideLayer.goLayer",e)}})},renderTagView:function(){var e=t.compile('<div class="list_wrap"><ul class="side_depth">{{#tags}}<li id={{.}}><p class="title"><a><span class="txt">{{.}}</span></a></p></li>{{/tags}}</ul></div>'),n=this.task.id?this.editable.TAG:!0,s=this,o=d.create({},{useAddButton:n}),u=this.task.get("tags");$("#tag").html(o.el),_.each(u,function(e){o.addTag(e,e,{removable:n})},this),o.$el.on("nametag:clicked-add",function(t){var n=$.goPopup({header:i["\ubd84\ub958 \ucd94\uac00"],width:300,contents:e.render({tags:s.folder.get("tags")}),buttons:[{btext:r["\ub2eb\uae30"]}]}),u=_.map($("ul#tag").find("li[data-id]"),function(e){return $(e).find("span.txt").text()});$(n).find("li").on("click",function(){var e=this.getAttribute("id"),t=$(this).find("span").text();_.contains(u,e)||($.goMessage(i["\ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),u.push(t)),o.addTag(e,t,{removable:!0})})})},renderField:function(e,t){if(!this.folder.id)return;var n=this._getFields(e).join("");t.replaceWith(n)},renderApproverView:function(){if(!this.folder.id)return;var e=this.folder.findIssueType($("#typeList").val());if(!e||!e.approver)return;this.makeApproverView(),this.renderNameTagView("approver")},makeApproverView:function(){var e='<tr data-tag="partial"><th><span class="title">'+i["\uc2b9\uc778\uc790"]+' <span class="help">&nbsp;'+'<span class="tool_tip">'+i["\uc2b9\uc778\uc790 \uc124\uba85"]+'<i class="tail_left"></i></span>'+"</span>"+"</span>"+"</th>"+"<td>"+'<div class="wrap_name_tag">'+'<ul id="approver" class="name_tag">'+"</ul>"+"</div>"+"</td>"+"</tr>";$("tr.line").before(e)},attachDelete:function(e){$(e.target).parents("li").remove()},deleteCalendarEvent:function(){this.task.calendarEvent=null,$("#calendarEvent").hide(),$("#calendarEvent span#start").text(""),$("#calendarEvent span#end").text(""),$("#calendarEvent span#eventSummary").attr("data-summary",""),$("#calendarEvent span#eventSummary").attr("data-location",""),$("#calendarEvent span#eventSummary").attr("data-calendarid",""),$("#calendarEvent span#eventSummary").attr("data-timeType",""),$("#calendarEvent span#eventSummary").attr("data-id",""),$("#addCalendarEvent").show()},addCalendarEvent:function(){var e=$("#beginDate").val(),t=$("#dueDate").val();e||(e=t),t||(t=e);if(e>t)return $.goError(i["\uc885\ub8cc\uc77c\uc774 \uc2dc\uc791\uc77c\ubcf4\ub2e4 \uc774\uc804\uc77c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],$("#dateError"),!1,!0),$(document).scrollTop(0),!1;var n={startDate:e,endDate:t,summary:$("#taskName").val(),isAllDay:$("#beginDate").val()==$("#dueDate").val()?!0:!1};this._makeCalendarLayer(n)},editCalendarEvent:function(){var e={startDate:GO.util.shortDate($("#start").attr("data-modify-date")),startTime:GO.util.hourMinute($("#start").attr("data-modify-date")),endDate:GO.util.shortDate($("#end").attr("data-modify-date")),endTime:GO.util.hourMinute($("#end").attr("data-modify-date")),summary:$("#eventSummary").attr("data-summary"),location:$("#eventSummary").attr("data-location"),calendarId:$("#eventSummary").attr("data-calendarid"),type:$("#eventSummary").attr("data-type"),isAllDay:$("#eventSummary").attr("data-timeType")=="allday"?!0:!1};this._makeCalendarLayer(e)},_makeCalendarLayer:function(e){var t=this;m.addSimpleEvent({contextRoot:GO.config("contextRoot"),session:GO.session(),timeType:e.isAllDay?"allday":"timed",startDate:e.startDate,startTime:e.startTime,endDate:e.endDate,endTime:e.endTime,summary:e.summary,location:e.location,calendarId:e.calendarId,type:e.type,modal:!0,returnType:"related",afterAddEvent:function(e){t.task.calendarEvent==undefined||t.task.calendarEvent==null?t.task.calendarEvent=new l(e):(t.task.calendarEvent.set("calendarId",e.calendarId),t.task.calendarEvent.set("endTime",e.endTime),t.task.calendarEvent.set("location",e.location),t.task.calendarEvent.set("startTime",e.startTime),t.task.calendarEvent.set("summary",e.summary),t.task.calendarEvent.set("timeType",e.timeType),t.task.calendarEvent.set("type",e.type),t.task.calendarEvent.set("visibility",e.visibility)),$("#calendarEvent span#eventSummary").attr("data-id")&&t.task.calendarEvent.set("id",$("#calendarEvent span#eventSummary").attr("data-id")),$("#addCalendarEvent").hide(),$("#calendarEvent").show(),$("#calendarEvent span#start").text(GO.util.basicDate(e.startTime)),$("#calendarEvent span#end").text(GO.util.basicDate(e.endTime)),$("#calendarEvent span#start").attr("data-modify-date",GO.util.toMoment(e.startTime,"YYYY-MM-DD (ddd) HH:mm").format("YYYY-MM-DD HH:mm")),$("#calendarEvent span#end").attr("data-modify-date",GO.util.toMoment(e.endTime,"YYYY-MM-DD (ddd) HH:mm").format("YYYY-MM-DD HH:mm")),$("#calendarEvent span#eventSummary").attr("data-summary",e.summary),$("#calendarEvent span#eventSummary").attr("data-location",e.location),$("#calendarEvent span#eventSummary").attr("data-calendarid",e.calendarId),$("#calendarEvent span#eventSummary").attr("data-timeType",e.timeType),$("#calendarEvent span#eventSummary").attr("data-type",e.type)},onCreateError:function(e){var t={"required:summary":s["\uc77c\uc815\uba85\uc744 \uc785\ub825\ud558\uc138\uc694"],"max:summary":GO.i18n(s["\uc77c\uc815\uba85\uc740 {{max}}\uc790 \uc774\ud558\ub85c \uc785\ub825\ud574 \uc8fc\uc2ed\uc2dc\uc624"],"max",500)};$.goMessage(t[e]||s["\uc77c\uc815 \ub4f1\ub85d\uc2dc \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4"])},lang:{"\ub0b4 \uce98\ub9b0\ub354":s["\ub0b4 \uce98\ub9b0\ub354"],"\uc77c\uc815 \ub4f1\ub85d":s["\uc77c\uc815 \ub4f1\ub85d"],"\uc77c\uc815\uba85":s["\uc77c\uc815\uba85"],"\uc77c\uc2dc":s["\uc77c\uc2dc"],"\uc2dc\uac04":s["\uc2dc\uac04"],"\uc885\uc77c":s["\uc885\uc77c"],"\ud655\uc778":r["\ud655\uc778"],"\ucde8\uc18c":r["\ucde8\uc18c"],"\uc77c\uc815\uc0c1\uc138 \uc785\ub825":s["\uc77c\uc815\uc0c1\uc138 \uc785\ub825"],"\uae30\ubcf8 \uce98\ub9b0\ub354 \uc774\ub984":s["\uce98\ub9b0\ub354 \uae30\ubcf8\uc774\ub984"],"\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc":s["\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc"],"\ubd84":s["\ubd84"],"\uc7a5\uc18c":s["\uc7a5\uc18c"],"\uc804\uc0ac\uc77c\uc815":s["\uc804\uc0ac\uc77c\uc815"],"\uc54c\ub9bc\uba54\uc77c \ud655\uc778":s["\uc54c\ub9bc\uba54\uc77c \ud655\uc778"],"\uc77c\uc815\ub4f1\ub85d\uc5d0 \ub300\ud55c \uc54c\ub9bc\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?":s["\uc77c\uc815\ub4f1\ub85d\uc5d0 \ub300\ud55c \uc54c\ub9bc\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"\ubcf4\ub0b4\uae30":r["\ubcf4\ub0b4\uae30"],"\ubcf4\ub0b4\uc9c0 \uc54a\uc74c":s["\ubcf4\ub0b4\uc9c0 \uc54a\uc74c"]}})},goBack:function(){window.history.back()},submitTask:function(){if(!GO.Editor.getInstance("editor").validate())return $.goError(r["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=this;if(!this.allowAction)return;this.allowAction=!1;var t=this.task.calendarEvent?this.task.calendarEvent.toJSON():null,i={folderId:$("#folderList").val(),name:$("#taskName").val(),issueType:this.folder.findIssueType($("#typeList").val()),beginDate:this._getBeginDate(),dueDate:this._getDueDate(),tags:this._getTags(),creator:this._getCreator(),lasModifier:this._getSessionUser(),privateTask:$("#privateTask").is(":checked"),status:{name:"status",start:!1,end:!1,doing:!1},activityCount:this.task.get("activityCount"),fieldValues:this._getFieldValues(),attaches:this._getFiles(),content:this.getContent(),assignees:this._getUserInfo("assignees"),referers:this._getUserInfo("referers"),approver:this._getUserInfo("approver"),updatedAt:this.task.getUpdatedAt(),calendarEvent:t};if(this.validate(i)==0){this.allowAction=!0;return}this.task.set(i),this.task.save({},{success:function(e){GO.util.store.set("taskFolderId",null,{type:"session"}),n.router.navigate("task/"+e.id+"/detail",!0)},error:function(t,n){$.goError(n.responseJSON.message),e.allowAction=!0}})},getContent:function(){var e=GO.Editor.getInstance("editor").getContent();return e==""||$.trim(e)=="<br>"?"":e},validate:function(e){if(!e.folderId||!this.folder.id)return $.goError(i["\ud3f4\ub354\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],$("#folderError"),!1,!0),$(document).scrollTop(0),!1;if(e.name.length>64||e.name.length<2)return $.goError(i["\uc81c\ubaa9\uc740 2\uc790 \uc774\uc0c1, 64\uc790 \uc774\ud558 \uc785\ub825 \uac00\ub2a5\ud569\ub2c8\ub2e4."],$("#taskName"),!1,!0),$(document).scrollTop(0),!1;if(this.folder.get("tagRequired")&&e.tags.length==0)return $.goError(i["\ubd84\ub958\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],$("#tagError"),!1,!0),$(document).scrollTop(0),!1;if(e.beginDate.length!=0&&e.dueDate.length!=0){var t=new Date(e.beginDate),n=new Date(e.dueDate);if(t>n)return $.goError(i["\uc885\ub8cc\uc77c\uc774 \uc2dc\uc791\uc77c\ubcf4\ub2e4 \uc774\uc804\uc77c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],$("#dateError"),!1,!0),$(document).scrollTop(0),!1}if(!this.customFieldValidate())return!1},customFieldValidate:function(){var e=!0;return _.each(this.folder.getRequiredSelectFields(),function(t){var n=t.id,i=$("tr#field"+n+"[data-field=customField]").find("select");i.val()==""&&(e=!1,$.goError(r["\ud544\uc218\ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],i,!1,!0))}),_.each(this.folder.getRequiredTextFields(),function(t){var n=t.id,i=$("tr#field"+n+"[data-field=customField]").find("input");i.val()==""&&(e=!1,$.goError(r["\ud544\uc218\ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],i,!1,!0))}),_.each(this.folder.getTextFields(),function(t){var n=t.id,i=$("tr#field"+n+"[data-field=customField]").find("input");i.val().length>200&&(e=!1,$.goError(GO.i18n(r["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],{arg1:200}),i,!1,!0))}),e},_getFieldValues:function(){var e=[];return _.each(this.$el.find("tr[data-field=customField]"),function(t){var n=$(t),r=n.attr("data-type").toUpperCase();if(r=="SELECT")e.push(this._getSelectFieldValue(n));else if(r=="BOOLEAN")e.push(this._getBooleanFieldValue(n));else{if(r!="TEXT")return;e.push(this._getTextFieldValue(n))}},this),e},_getBeginDate:function(){return $("#beginDate").val()?GO.util.searchStartDate(GO.util.toMoment($("#beginDate").val())):""},_getDueDate:function(){return $("#dueDate").val()?GO.util.searchEndDate(GO.util.toMoment($("#dueDate").val())):""},_getTags:function(){var e=[];return _.each($("#tag").find("li[data-id]"),function(t){e.push($(t).find("span.name").text())}),e},_getCreator:function(){return this.task.id?this.task.creator:this._getSessionUser()},_getSessionUser:function(){return _.pick(GO.session(),"id","name","email","position","thumbnail")},_getFiles:function(){var e=[];return _.each($("#editorArea").find("li:not(.attachError)"),function(t){e.push({id:$(t).attr("data-id")||null,path:$(t).attr("data-path"),name:$(t).attr("data-name"),hostId:$(t).attr("data-hostId")})}),e},_getUserInfo:function(e){if(e=="approver"){var t=$("#"+e).find("li[data-id]");return t.length?{id:t.attr("data-id")}:null}var n=[];return _.each($("#"+e).find("li[data-id]"),function(e){var t=$(e).attr("data-id");if(t==0)return!1;n.push({id:t})}),n},_getFields:function(e){var t=[];return _.each(e,function(e){if(e.type=="SELECT")t.push(this._makeSelectFieldEl(e));else if(e.type=="BOOLEAN")t.push(this._makeBooleanFieldEl(e));else{if(e.type!="TEXT")return;t.push(this._makeTextFieldEl(e))}},this),t},_makeSelectFieldEl:function(e){var n=this._getFieldValue(e),i=['<option value="">'+r["\uc120\ud0dd"]+"</option>"],s=this.task.id?n.value:n.defaultValue;_.each(e.options,function(e){var t=e==s?" selected":"";i.push("<option "+t+">"+e+"</option>")},this);var o='<tr data-tag="partial" id="field{{field.id}}" data-fieldId="{{field.id}}" data-field="customField" data-type="select"><th><span class="title">{{field.name}}</span>{{#field.required}}<ins class="asterisk">*</ins>{{/field.required}}</th><td><span class="wrap_select"><select {{^editable.FIELD}}disabled="disabled"{{/editable.FIELD}}>'+i.join("")+"</select>"+"</span>"+"</td>"+"</tr>";return t.compile(o).render({field:e,editable:this.editable})},_makeBooleanFieldEl:function(e){var n=this._getFieldValue(e),r=this.isCreate?n.defaultValue:n.value,i='<tr data-tag="partial" id="field{{field.id}}" data-fieldId="{{field.id}}" data-field="customField" data-type="boolean"><th><span class="title">{{field.name}}</span>{{#field.required}}<ins class="asterisk">*</ins>{{/field.required}}</th><td><span class="wrap_option"><input type="checkbox" {{#taskFieldValue.value}}checked{{/taskFieldValue.value}} {{^editable.FIELD}}disabled="disabled"{{/editable.FIELD}}><label>{{field.message}}</label></span></td></tr>';return t.compile(i).render({field:e,taskFieldValue:{value:GO.util.toBoolean(r)},editable:this.editable})},_makeTextFieldEl:function(e){var n=this._getFieldValue(e),r='<tr data-tag="partial" id="field{{field.id}}" data-fieldId="{{field.id}}" data-field="customField" data-type="text"><th><span class="title">{{field.name}}</span>{{#field.required}}<ins class="asterisk">*</ins>{{/field.required}}</th><td><div class="wrap_txt"><input class="txt w_max" type="text"value="{{taskFieldValue.value}}"placeholder="{{taskFieldValue.message}}"{{^editable.FIELD}}disabled="disabled"{{/editable.FIELD}}></div></td></tr>';return t.compile(r).render({field:e,taskFieldValue:{value:n.value,message:e.message},editable:this.editable})},_getSelectFieldValue:function(e){return{fieldId:e.attr("data-fieldId"),value:e.find("option:selected").val()}},_getBooleanFieldValue:function(e){return{fieldId:e.attr("data-fieldId"),value:e.find("input").is(":checked")}},_getTextFieldValue:function(e){var t=e.find("input"),n=t.val();return t.attr("placeholder")==n&&(n=""),{fieldId:e.attr("data-fieldId"),value:n}},_getFieldValue:function(e){if(this.isCreate)return e;var t=this.task.get("fieldValues");if(t.length==0)return e;var n=_.find(t,function(t){return t.fieldId==e.id});return n||{value:e.defaultValue||""}},_isNotSelectFolder:function(){return $("select#folderList").val()==""},_isFolderSelect:function(){return $("#folderList").val()!=""},editorCallback:function(){if(!this.isCreate&&!this.editable.CONTENT){var e=document.getElementsByTagName("iframe")[0],t=e.contentWindow.document,n=t.getElementsByTagName("iframe")[0],r=n.contentWindow.document;r.body.contentEditable="false"}GO.Editor.getInstance("editor").setContent(this.task.get("content")||"")},initSmartEditor:function(){$("#editor").goWebEditor({contextRoot:GO.config("contextRoot"),lang:GO.session("locale"),onLoad:_.bind(this.editorCallback,this)})},initFileUpload:function(e){if(!this.editable.CONTENT)return;var t=this,e={el:"#file-control",context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+g.addAttach+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie")};(new v(e)).queue(function(e,t){}).start(function(e,t){if(!GO.config("attachFileUpload"))return $.goAlert(r["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1;if(GO.config("excludeExtension")!=""){var i=$.inArray(t.type.substr(1).toLowerCase(),GO.config("excludeExtension").split(","));if(i>=0)return $.goMessage(n.i18n(r["\ud655\uc7a5\uc790\uac00 \ub561\ub561\uc778 \uac83\ub4e4\uc740 \ucca8\ubd80 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],"arg1",GO.config("excludeExtension"))),!1}if(GO.config("attachSizeLimit")){var s=t.size/1024/1024,o=GO.config("maxAttachSize");if(o<s)return $.goMessage(n.i18n(r["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",o)),!1}if(GO.config("attachNumberLimit")){var u=$("#fileWrap").children().size()+$("#img_wrap").children().size(),a=GO.config("maxAttachNumber");if(a<=u)return $.goMessage(n.i18n(r["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",a)),!1}}).progress(function(e,t){}).success(function(e,n,r){var i=GO.util.isImage(n.data.fileExt),s=t.$("#editorArea");r.attr("data-hostId",n.data.hostId);if(GO.util.fileUploadErrorCheck(n))r.find(".item_file").append("<strong class='caution'>"+GO.util.serverMessage(n)+"</strong>"),r.addClass("attachError");else if(GO.util.isFileSizeZero(n))return $.goAlert(GO.util.serverMessage(n)),!1;i?s.find("ul.img_wrap").append(r):s.find("ul.file_wrap").append(r)}).complete(function(e,t){console.info(t)}).error(function(e,t){console.info(t)})}});return y})}).call(this);