(function(){define(["backbone","hogan","app","i18n!nls/commons","i18n!task/nls/task","i18n!board/nls/board","i18n!calendar/nls/calendar","i18n!todo/nls/todo","hgn!task/templates/task_list","task/models/task_folder","task/models/task","task/collections/tasks","task/views/task_title","task/views/task_post_move","task/views/share_info_popup","task/views/side","grid","jquery.go-grid"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g={addr:i["\ud3f4\ub354 \uc8fc\uc18c"],copy:r["\ubcf5\uc0ac"],search:r["\uac80\uc0c9"],showShareInfo:i["\uacf5\uac1c/\uacf5\uc720 \ud604\ud669 \ubcf4\uae30"],admin:i["\uc6b4\uc601\uc790"],state:i["\uc0c1\ud0dc"],title:r["\uc81c\ubaa9"],content:i["\uc81c\ubaa9+\ub0b4\uc6a9"],dueDate:i["\uae30\ud55c"],assignee:i["\ub2f4\ub2f9\uc790"],creator:i["\ub4f1\ub85d\uc790"],notAuthorized:i["\uc5f4\ub78c \uad8c\ud55c\uc774 \uc5c6\ub294 \uc5c5\ubb34\uc785\ub2c8\ub2e4"]},y=e.View.extend({events:{"click #favorite":"toggleFavorite","click #copyUrl":"copyUrl","click #shareInfoBtn":"shareInfoPopup","click #folderInfoToggleBtn":"toggleFolderInfo","click a[data-type=task]":"goTaskDetail","click span[data-type=task]":"goTaskDetail"},initialize:function(e){this.options=e||{},this.folder=new f(this.options),this.tasks=new c([],{folderId:this.folder.id}),this.bindFavorite()},dataFetch:function(){var e=this,t=$.Deferred();return this.folder.fetch({statusCode:{400:function(){e.folder.clear(),n.router.navigate("task",!0)},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}},success:function(n){n.get("actions").writable&&GO.util.store.set("taskFolderId",n.id,{type:"session"}),n.getDepartment().done(function(n){e.department=n.data,t.resolve()})}}),t},render:function(){if(!this.folder.id)return;this.$el.addClass("go_renew"),this.$el.html(a({lang:g,folder:this.folder.toJSON(),dept:this.department,hasAdmin:this.folder.hasAdmin(),adminLabel:this.folder.adminLabel(),url:this.folderAddress(),description:GO.util.escapeHtml(this.folder.get("description"))}));var e=new h({title:this.folder.get("name"),subTitle:this.department.name,count:this.folder.get("taskCount"),hasFavorite:!0,isFavorite:this.folder.get("favorite")});this.$el.find(".content_top").html(e.el),e.render(),this.renderGrid();var t=this.$("#detailFolderInfo");return t.toggle(!this.getFolderStatus()),$("#searchKeyword").placeholder(),this},bindFavorite:function(){var e=this;$("#side_favorite").on("changeFavorite",function(t,n){var r=!1;$.each(n,function(t,n){if(n.get("id")==e.folder.id){r=!0;return}}),r||e.$el.find("#favorite").addClass("ic_star_off").attr("value",!1)})},toggleFolderInfo:function(e){$(e.currentTarget).find("span").toggleClass("ic_open").toggleClass("ic_close");var t=this.$("#detailFolderInfo"),n=t.is(":visible");t.toggle(!n);var r="taskInfo_"+GO.session("id")+"_"+this.id;GO.util.store.set(r,n,{type:"local"})},getFolderStatus:function(){var e="taskInfo_"+GO.session("id")+"_"+this.id;return GO.util.store.get(e)||!1},shareInfoPopup:function(){var e=$.goPopup({modal:!0,pclass:"layer_normal layer_public_list",header:i["\uacf5\uac1c/\uacf5\uc720 \ud604\ud669"],width:500,top:"30%",modal:!1,contents:"<div id='sharePopupContent' calss='content'></div>",buttons:[{btext:r["\ud655\uc778"],btype:"confirm",callback:function(){}}]}),e=new d({folder:this.folder,parent:e});e.render()},goCreateTask:function(){GO.util.store.set("taskFolderId",null,{type:"session"}),GO.util.store.set("sideItem","departmentFolder"+this.folder.id,{type:"session"}),n.router.navigate("task/folder/"+this.folder.get("id")+"/create",!0)},goTaskDetail:function(e){GO.util.store.set("taskFolderId",null,{type:"session"}),GO.util.store.set("sideItem","departmentFolder"+this.folder.id,{type:"session"});var t=e.currentTarget.getAttribute("data-id"),r=this.getSearch();n.router.navigate("task/"+t+"/detail"+r,!0)},getQueryString:function(){var e="";return _.each($("input[type=checkbox][data-id]:checked"),function(t){e=e+"id="+$(t).attr("data-id")+"&"}),e},isNotSelected:function(){var e=this.$("input[type=checkbox][data-id]:checked");return e.length?!1:!0},postBoard:function(){var e=this._getCheckedData();if(e.length<=0){$.goMessage(i["\uc120\ud0dd\ub41c \uc5c5\ubb34\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var t=[];$.each(e,function(e,n){t.push(n.id)});var n=new p({taskIds:t,deptId:this.department.id,url:GO.contextRoot+"api/linkage/task/post"});n.render()},_getCheckedData:function(){var e=this.gridView.getCheckedIds();return _.map(e,function(e){var t=this.tasks.get(e);return t.toJSON()},this)},confirmDelete:function(){if(this.isNotSelected())return;var e=this;$.goPopup({title:i["\uc5c5\ubb34 \uc0ad\uc81c"],message:i["\uc5c5\ubb34 \uc0ad\uc81c \uc124\uba85"],buttons:[{btype:"confirm",btext:r["\ud655\uc778"],callback:function(){e.deleteTask()}},{btext:r["\ucde8\uc18c"],callback:function(){}}]})},csvDownLoad:function(){var e=this.options.id,t="api/task/download/"+e+"?";GO.util.downloadCsvFile(t+"?"+this.tasks.makeParam())},deleteTask:function(){var e=this;$.ajax({type:"DELETE",dataType:"json",url:GO.contextRoot+"api/task?"+e.getQueryString(),success:function(t){v.render(),$.goMessage(r["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),e.gridView.collection.fetch()},error:function(e){$.goError(e.responseJSON.message)}})},getSearch:function(){var e=GO.router.getSearch(),t=e.keyword;delete e.keyword;var n="";return $.isEmptyObject(e)||(n="?keyword="+encodeURIComponent(t)+"&"+$.param(e)),n},renderGrid:function(){var e=this,t=[],a=[];this.gridView=new m({el:"#taskListWapper",collection:this.tasks,tableClass:"type_normal list_task list_task001 dataTable",columns:[{name:"statusName",className:"state",label:i["\uc0c1\ud0dc"],sortable:!0,render:function(e){var t=e.get("status");if(e.isReadable()){var n=t.end?"finished":"etc";return'<span class="state '+n+'">'+t.name+"</span>"}return"<span>-</span>"}},{name:"name",className:"list_subject",label:r["\uc81c\ubaa9"],sortable:!0,render:function(e){var n=e.get("privateTask")?'<span class="ic_classic ic_lock"></span>':"",r=e.get("read");r||a.push(e.id);if(e.isReadable()){var s='<a data-move data-type="task" data-id="'+e.id+'">'+n+"\n"+'<span class="txt">'+e.get("name")+"</span>"+"</a>";return e.hasActivity()&&(s=s+'<span data-move data-type="task" data-id="'+e.id+'" class="btn_wrap btn_activity">'+'<span class="ic_classic ic_activvity"></span>'+'<span class="txt_b">'+i["\ud65c\ub3d9\uae30\ub85d"]+"</span>"+'<span class="num">'+e.get("activityCount")+"</span>"+"</span>"),s}return t.push(e.id),"<a>"+n+"<span> "+i["\uc5f4\ub78c \uad8c\ud55c\uc774 \uc5c6\ub294 \uc5c5\ubb34\uc785\ub2c8\ub2e4"]+"</span></a>"}},{name:"beginDate",className:"date",label:o["\uc2dc\uc791\uc77c"],sortable:!0,render:function(e){if(e.isReadable()){var t=e.get("beginDate")?GO.util.basicDate2(e.get("beginDate")):"-";return"<span class='date'>"+t+"</span>"}return"<span>-</span>"}},{name:"dueDate",className:"date",label:u["\uae30\ud55c\uc77c"],sortable:!0,render:function(e){if(e.isReadable()){var t=e.get("dueDate")?GO.util.basicDate2(e.get("dueDate")):"-",n=e.get("dueDate")&&e.get("delay")?"date delay":"date";return"<span class='"+n+"'>"+t+"</span>"}return"<span>-</span>"}},{name:"assignees",className:"name",label:i["\ub2f4\ub2f9\uc790"],render:function(e){if(e.isReadable()){var t=e.get("assignees").length,n=e.assigneeLabel(i["\uc678"],r["\uba85"]),s=e.firstAssignee(),o=s?s.id:"",u='<a href="javascript:;"><span class="txt" data-size="'+t+'" data-id="'+o+'" data-profile>'+n+"</span>"+"<a/>";return u}return"<span>-</span>"}},{name:"creator",className:"name",label:i["\ub4f1\ub85d\uc790"],render:function(e){if(e.isReadable()){var t=e.get("creator"),n=e.creatorLabel(),r='<a href="javascript:;"><span class="txt" data-id="'+t.id+'"  data-profile>'+n+"</span>"+"<a/>";return r}return"<span>-</span>"}}],drawCallback:function(n){$(t).each(function(t,n){e.$el.find('input[type="checkbox"][data-id="'+n+'"]').remove()}),$(a).each(function(t,n){e.$el.find('tr[data-id="'+n+'"]').addClass("read_no")})},buttons:[{render:function(){return e.folder.get("actions").writable?'<a class="btn_tool" data-button><span class="ic_toolbar plus"></span><span class="txt">'+i["\uc5c5\ubb34 \ub4f1\ub85d"]+"</span>"+"</a>":""},onClick:function(){e.goCreateTask()}},{render:function(){return GO.isAvailableApp("board")?'<a class="btn_tool" data-button><span class="ic_toolbar board"></span><span class="txt_caution">'+s["\uac8c\uc2dc\ud310 \uac8c\uc2dc"]+"</span>"+"</a>":""},onClick:function(){e.postBoard()}},{render:function(){return e.folder.get("actions").managable?'<a class="btn_tool" data-button><span class="ic_toolbar del"></span><span class="txt_caution">'+r["\uc0ad\uc81c"]+"</span>"+"</a>":""},onClick:function(){e.confirmDelete()}},{render:function(){return e.folder.get("actions").managable?'<a class="btn_tool" data-button><span class="ic_toolbar download"></span><span class="txt_caution">'+r["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"]+"</span>"+"</a>":""},onClick:function(){e.csvDownLoad()}}],searchOptions:[{value:"TITLE",label:r["\uc81c\ubaa9"]},{value:"CONTENT",label:i["\uc81c\ubaa9+\ub0b4\uc6a9"]},{value:"STATUS",label:i["\uc0c1\ud0dc"]},{value:"ASSIGNEE",label:i["\ub2f4\ub2f9\uc790"]},{value:"CREATOR",label:i["\ub4f1\ub85d\uc790"]}]}),this.gridView.render(),this.tasks.fetch({statusCode:{400:function(){e.folder.clear(),n.router.navigate("task",!0)},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}}})},toggleFavorite:function(e){var t=$(e.currentTarget),n=GO.util.toBoolean(t.attr("value")),r={dataType:"json",url:GO.contextRoot+"api/task/folder/"+this.folder.id+"/favorite",error:function(e){$.goError(e.responseJSON.message)}};n?(r.type="DELETE",r.success=function(){t.removeClass("ic_star").addClass("ic_star_off").val("false"),$("#side_favorite").trigger("refresh")}):(r.type="POST",r.success=function(){t.removeClass("ic_star_off").addClass("ic_star").val("true"),$("#side_favorite").trigger("refresh")}),$.ajax(r)},copyUrl:function(){var e=navigator.userAgent.toLowerCase(),t=this.folderAddress();e.indexOf("msie")!=-1?(window.clipboardData.setData("Text",t),$.goMessage(i["\uc5c5\ubb34 \ud3f4\ub354 \ub9c1\ud06c\ubcf5\uc0ac \uc644\ub8cc \uba54\uc2dc\uc9c0"])):temp=prompt(i["\uc5c5\ubb34 \ud3f4\ub354 \ub9c1\ud06c\ubcf5\uc0ac \uc548\ub0b4 \uba54\uc2dc\uc9c0"],t)},folderAddress:function(){return GO.router.getRootUrl()+"task/folder/"+this.folder.id+"/task"}});return y})}).call(this);