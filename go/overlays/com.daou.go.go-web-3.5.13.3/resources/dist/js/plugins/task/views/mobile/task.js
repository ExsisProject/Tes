(function(){define(["backbone","hogan","app","i18n!nls/commons","i18n!task/nls/task","hgn!task/templates/mobile/task","hgn!task/templates/mobile/task_partial","task/models/task","task/models/task_folder","task/collections/task_departments","task/collections/task_folders","views/mobile/header_toolbar","views/mobile/m_org","admin/models/task_config","attach_file","formspy","components/go-fileuploader/mobile","jquery.go-sdk","jquery.go-orgslide","jquery.progressbar","GO.util"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g={task:r["\uc5c5\ubb34"],regist:r["\ub4f1\ub85d"],edit:r["\uc218\uc815"],location:r["\uc704\uce58"],selectDept:i["\ubd80\uc11c \uc120\ud0dd"],selectFolder:i["\ud3f4\ub354 \uc120\ud0dd"],title:r["\uc81c\ubaa9"],"private":r["\ube44\uacf5\uac1c"],assignee:i["\ub2f4\ub2f9\uc790"],dueDate:i["\uae30\ud55c"],dueDateDesc:i["\uae30\ud55c \uc124\uba85"],tag:i["\ubd84\ub958"],referer:i["\ucc38\uc870\uc790"],approver:i["\uc2b9\uc778\uc790"],detail:i["\uc0c1\uc138\ub0b4\uc6a9"],cancel:r["\ucde8\uc18c"],type:i["\uc720\ud615"],privateDesc:i["\ube44\uacf5\uac1c \uc124\uba85"],addAttach:r["\ud30c\uc77c \ucca8\ubd80"],add:r["\ucd94\uac00"],assignees:i["\ub2f4\ub2f9\uc790"],approver:i["\uc2b9\uc778\uc790"],referers:i["\ucc38\uc870\uc790"]},y=t.compile('<li data-id="{{name}}"><span class="name">{{name}}</span><span class="btn_wrap"><span class="ic ic_del"></span></span></li>'),b=t.compile('{{#data}}<li data-id="{{id}}" data-name="{{name}}" data-position="{{position}}"><span class="name">{{name}} {{position}}</span><span class="btn_wrap"><span class="ic ic_del"></span></span></li>{{/data}}'),w=e.View.extend({el:"#content",events:{"change #deptList":"departmentCheck","change #folderList":"folderCheck","change #typeList":"typeCheck","change #tagSelect":"tagSelect","vclick a[data-tag=callOrg]":"callOrg","vclick #submitTask":"submitTask","vclick #goBackTask":"goBack","vclick span.ic_del":"deleteUser","keyup textarea":"_expandTextarea"},initialize:function(e){this.options=e||{},this.task=new u(this.options),this.isCreate=this.options.id?!1:!0,this.$el.off(),this.configModel=p.read({admin:!1}),this.headerBindEvent()},headerBindEvent:function(){GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","task-save",this.submitTask,this)},dataFetch:function(){var e=this,t=null,n=null,r=null,i=$.Deferred(),s=$.Deferred(),o=this.task.id?this.task.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}}}):$.Deferred().resolve();o.done(function(o){e.folder=new a({id:e.options.folderId||e.task.get("folderId")||null}),r=e.folder.id?e.folder.fetch():$.Deferred().resolve(),r.done(function(){e.task.id||e.task.set({folderId:e.folder.id||null,issueType:e.folder.defaultType(),assignees:[e._getSessionUser()]}),t=e.getEditable()}),e.departments=new f({type:"dept"}),n=e.departments.fetch(),$.when(r,n).done(function(){e.deptId=e.departments.isOneTeam()?e.departments.first().id:e.folder.get("deptId")||null,e.folders=new l,e.folders.setDeptId(e.deptId),e.deptId?i=e.folders.fetch({success:function(){e.folders.isOneFolder()&&!e.task.get("folderId")?(e.task.set({folderId:e.folders.first().id}),e.folder.id?s.resolve():(e.folder=new a({id:e.folders.first().id}),e.folder.fetch().done(function(){s.resolve()}))):s.resolve()}}):(e.folders.reset([]),i.resolve(),s.resolve())})});var u=$.Deferred();return $.when(t,n,s).done(function(){u.resolve(e)}),u},render:function(){return c.render({isClose:!0,title:this.task.id?i["\uc5c5\ubb34 \uc218\uc815"]:i["\uc5c5\ubb34 \ub4f1\ub85d"],actionMenu:[{id:"task-save",text:r["\ub4f1\ub85d"],triggerFunc:"task-save"}]}),this.$el.html(s(this.getRenderData())),!this.isCreate&&this.task.get("attaches").length>0&&($("#attachWrap").show(),d.edit("#fileWrap",this.task.get("attaches"),{},this.editable.CONTENT)),this.partialRender(),this.toggleTypeView(),this.setSelectData(),this.$el.addClass("write"),this.attachFileUploader(),this},attachFileUploader:function(){var e={};e.success=$.proxy(function(e){var t=this,n=typeof e=="string"?JSON.parse(e):e.data;n.mode="edit",$("#attachWrap").show();var r=d.makeTempItem(n);return r.done(function(e){if($("div.option_display").data("attachable")==="false")return;try{t.attachValidate(n)}catch(r){r.message==="overMaxAttachNumber"&&$("div.option_display").data("attachable","false");return}GO.util.isImage(n.fileExt)?$("#imageWrap").append(e.$el):$("#fileWrap").append(e.$el),e.$el.on("removedFile",function(e,t){var n=t.el;n.preventDefault(),$(n.currentTarget).parents("li").first().remove(),$("div.option_display").data("attachable","true"),$("#attachWrap").find("li").size()<1&&$("#attachWrap").hide()})}),r.promise()},this),e.error=function(){alert(r["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},e.androidCallFile=$.proxy(function(){this.callFile()},this),m.bind(this.$el.find("#go-fileuploader"),e)},initFormSpy:function(){this.formSpy=new v(this.$("form"))},partialRender:function(){this.$el.find("tr[data-tag=partial]").remove(),$("#partialArea").replaceWith(o(this.getRenderData())),$.datepicker.setDefaults($.datepicker.regional[GO.config("locale")]),this.renderDatepicker(),this.renderField(this.folder.get("fields"),$("#folderFieldArea")),this.renderField(this.folder.getCurrentTypeFields($("select#typeList").val()),$("#typeFieldArea")),this.initFormSpy()},callOrg:function(e){var t=[],n=$(e.currentTarget).attr("data-type");_.each($("#"+n+" li"),function(e){t.push({id:$(e).attr("data-id"),username:$(e).attr("data-name"),position:$(e).attr("data-position")})});var r=this;setTimeout(function(){r.$el.hide(),r.orgRender(t,n)},500)},orgRender:function(e,t){var n=t=="approver"?!0:!1;this.orgView=new h({type:"circle",circle:this.folder.get("share"),isSingleSelect:n}),$(document).scrollTop(0);var i=this;this.orgView.render({title:g[t]+" "+r["\ucd94\uac00"],checkedUser:e,callback:function(e){i.$el.show();var n=b.render({data:e});return $("#"+t).html(n),!1},backCallback:function(){i.$el.show()}})},makeTitleOption:function(){var e=this;return{name:this.task.id?i["\uc5c5\ubb34 \uc218\uc815"]:i["\uc5c5\ubb34 \ub4f1\ub85d"],isPrev:!0,isIscroll:!1,isLeftCancelBtn:{text:i["\ucde8\uc18c"]},rightButton:{callback:function(t){setTimeout(function(){e.submitTask()},100)},text:r["\ub4f1\ub85d"]}}},getEditable:function(){var e=this,t=$.Deferred();return this.task.getEditableAttribute().done(function(n){e.editable=n,t.resolve()}),t},getRenderData:function(){return{lang:g,isCreate:this.isCreate,data:$.extend(this.task.toJSON(),{}),folder:this.folder.id?this.folder.toJSON():null,departments:this.departments.toJSON(),folders:this.folders.toJSON(),editable:this.editable,files:this.task.getFiles(),images:this.task.getImages(),assignees:this.getAssignees(),isApprover:this.isApprover(),isMobileApp:GO.config("isMobileApp"),isAndroidApp:GO.util.isAndroidApp(),content:GO.util.unescapeHtml(this.task.get("content")),beginDate:this.task.getShortBeginDate(),dueDate:this.task.getShortDueDate()}},departmentCheck:function(){this.folder.id?this.typeChangeAlert("department"):this.changeDept()},folderCheck:function(){this.folder.id?this.typeChangeAlert("folder"):this.changeFolder()},typeCheck:function(){this.typeChangeAlert("type")},changeDept:function(){var e=this,t=$.Deferred();this.deptId=$("#deptList").val(),this.folders=new l,this.folders.setDeptId(this.deptId),this.deptId?this.folders.fetch({success:function(){t.resolve()}}):(this.folders.reset([]),t.resolve()),t.done(function(){e.renderFolderList(e.folders),e.changeFolder()})},changeFolder:function(){var e=this,t=$("#folderList").val(),n=$.Deferred();this.folder=new a({id:t}),t?n=this.folder.fetch():n.resolve(),n.done(function(){e.task.set({folderId:t,issueType:e.folder.defaultType()}),e.renderTypeView(),e.getEditable().done(function(){e.redrawTaskView()})})},changeType:function(){var e=$("#typeList").val();this.task.set({issueType:this.folder.findIssueType(e)});var t=this;this.getEditable().done(function(){t.redrawTaskView()})},toggleTypeView:function(){$("#typeList").find("option").length>1?$("#typeArea").show():$("#typeArea").hide()},renderFolderList:function(e){var n="{{#folders}}{{^separator}}<option value={{id}} {{#currentFolder}}selected{{/currentFolder}}>{{name}}</option>{{/separator}}{{/folders}}",r=$("select#folderList");r.find("option:gt(0)").remove(),r.append(t.compile(n).render({folders:e.toJSON()}))},renderTypeView:function(){$("#typeList").find("option").remove();var e=t.compile("<option value={{issueType.id}}>{{issueType.name}}</option>");_.each(this.folder.getIssueTypes(),function(t){$("#typeList").append(e.render({issueType:t}))}),$("#typeList").val(this.task.get("issueType").id)},typeChangeAlert:function(e){var t=e=="type"?i["\uc720\ud615 \ubcc0\uacbd \uacbd\uace0"]:i["\uc704\uce58 \ubcc0\uacbd \uacbd\uace0"];confirm(t.replace("<br>"," "))?e=="department"?this.changeDept():e=="folder"?this.changeFolder():e=="type"&&this.changeType():this.revert(e)},revert:function(e){e=="department"?this.revertDept():e=="folder"?this.revertFolder():e=="type"&&this.revertType()},revertDept:function(){var e=this;setTimeout(function(){$("#deptList").val(e.deptId)},100)},revertFolder:function(){var e=this;setTimeout(function(){$("#folderList").val(e.task.get("folderId"))},100)},revertType:function(){var e=this;setTimeout(function(){$("#typeList").val(e.task.get("issueType").id)},100)},setSelectData:function(){$("#deptList").val(this.deptId),$("#folderList").val(this.task.get("folderId"))},redrawTaskView:function(){var e=$("#taskName").val(),t=$("#dueDate").val(),n=$("#beginDate").val();this.partialRender(),$("#taskName").val(e),$("#dueDate").val(t),$("#beginDate").val(n),this.toggleTypeView()},renderDatepicker:function(){$("#beginDate").datepicker({yearSuffix:"",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0}),$("#dueDate").datepicker({yearSuffix:"",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0})},renderField:function(e,t){if(!this.folder.id)return;var n=this._getFields(e).join("");t.replaceWith(n)},isApprover:function(){if(!this.folder.id)return!1;var e=this.folder.findIssueType($("select#typeList").val());return!e||!e.approver?!1:!0},attachDelete:function(e){$(e.target).parents("li").remove(),$("#attachWrap").find("li").length||$("#attachWrap").hide()},goBack:function(){window.history.back()},tagSelect:function(e){var t=$(e.currentTarget),n=t.val();if(n==g.add)return;var r=_.map($("ul#tag").find("li[data-id]"),function(e){return $(e).find("span.name").text()});if(!_.contains(r,n)){var i=y.render({name:n});this.$("#tag").append(i)}t.val("")},submitTask:function(){var e={folderId:$("#folderList").val(),name:$("#taskName").val(),issueType:this.folder.findIssueType(this.$("#typeList").val()),dueDate:this._getDueDate(),beginDate:this._getBeginDate(),tags:this._getTags(),creator:this._getCreator(),lasModifier:this._getSessionUser(),privateTask:$("#privateTask").is(":checked"),status:{name:"status",start:!1,end:!1,doing:!1},activityCount:this.task.get("activityCount"),fieldValues:this._getFieldValues(),attaches:m.getAttachInfo("#attachWrap"),content:GO.util.escapeHtml(this.$el.find("textarea").val()),assignees:this._getUserInfo("assignees"),referers:this._getUserInfo("referers"),approver:this._getUserInfo("approver"),updatedAt:this.task.getUpdatedAt()};if(this.validate(e)==0)return;this.task.set(e),this.task.save({},{success:function(e){console.log(e.id),n.router.navigate("task/"+e.id+"/detail",!0)},error:function(){console.log("error")}})},validate:function(e){if(!e.folderId||!this.folder.id)return alert(i["\ud3f4\ub354\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],""),!1;if(e.name.length>64||e.name.length<2)return alert(i["\uc81c\ubaa9\uc740 2\uc790 \uc774\uc0c1, 64\uc790 \uc774\ud558 \uc785\ub825 \uac00\ub2a5\ud569\ub2c8\ub2e4."],""),!1;if(this.folder.get("tagRequired")&&e.tags.length==0)return alert(i["\ubd84\ub958\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],""),!1;if(e.beginDate.length!=0&&e.dueDate.length!=0){var t=new Date(e.beginDate),n=new Date(e.dueDate);if(t>n)return alert(i["\uc885\ub8cc\uc77c\uc774 \uc2dc\uc791\uc77c\ubcf4\ub2e4 \uc774\uc804\uc77c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],""),!1}if(!this.customFieldValidate())return!1},customFieldValidate:function(){var e=!0;return _.each(this.folder.getRequiredSelectFields(),function(t){var n=t.id,i=$("tr#field"+n+"[data-field=customField]").find("select");if(i.val()=="")return e=!1,alert(r["\ud544\uc218\ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."]),!1}),_.each(this.folder.getRequiredTextFields(),function(t){var n=t.id,i=$("tr#field"+n+"[data-field=customField]").find("input");if(i.val()=="")return e=!1,alert(r["\ud544\uc218\ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."]),!1}),_.each(this.folder.getTextFields(),function(t){var n=t.id,i=$("tr#field"+n+"[data-field=customField]").find("input");if(i.val().length>200)return e=!1,alert(GO.i18n(r["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],{arg1:200})),!1}),e},_getFieldValues:function(){var e=[];return _.each(this.$el.find("tr[data-field=customField]"),function(t){var n=$(t),r=n.attr("data-type").toUpperCase();if(r=="SELECT")e.push(this._getSelectFieldValue(n));else if(r=="BOOLEAN")e.push(this._getBooleanFieldValue(n));else{if(r!="TEXT")return;e.push(this._getTextFieldValue(n))}},this),e},_getDueDate:function(){return $("#dueDate").val()?GO.util.searchEndDate(GO.util.toMoment($("#dueDate").val())):""},_getBeginDate:function(){return $("#beginDate").val()?GO.util.searchStartDate(GO.util.toMoment($("#beginDate").val())):""},_getTags:function(){var e=[];return _.each($("#tag").find("li[data-id]"),function(t){e.push($(t).find("span.name").text())}),e},_getCreator:function(){return this.isCreate?this._getSessionUser():this.task.creator},_getSessionUser:function(){return _.pick(GO.session(),"id","name","email","position","thumbnail")},_getUserInfo:function(e){if(e=="approver"){var t=$("#"+e).find("li[data-id]");return t.length?{id:t.attr("data-id")}:null}var n=[];return _.each($("#"+e).find("li[data-id]"),function(e){n.push({id:$(e).attr("data-id")})}),n},_getFields:function(e){var t=[];return _.each(e,function(e){if(e.type=="SELECT")t.push(this._makeSelectFieldEl(e));else if(e.type=="BOOLEAN")t.push(this._makeBooleanFieldEl(e));else{if(e.type!="TEXT")return;t.push(this._makeTextFieldEl(e))}},this),t},_makeSelectFieldEl:function(e){var n=this._getFieldValue(e),i=['<option value="">'+r["\uc120\ud0dd"]+"</option>"],s=this.isCreate?n.defaultValue:n.value;_.each(e.options,function(e){var t=e==s?" selected":"";i.push("<option "+t+">"+e+"</option>")},this);var o='<tr data-tag="partial" id="field{{field.id}}" data-fieldId="{{field.id}}" data-field="customField" data-type="select"><th><span class="title">{{field.name}}</span>{{#field.required}}<ins class="asterisk">*</ins>{{/field.required}}</th><td><select {{^editable.FIELD}}disabled="disabled"{{/editable.FIELD}}>'+i.join("")+"</select>"+"</td>"+"</tr>";return t.compile(o).render({field:e,editable:this.editable})},_makeBooleanFieldEl:function(e){var n=this._getFieldValue(e),r=this.isCreate?n.defaultValue:n.value,i='<tr data-tag="partial" id="field{{field.id}}" data-fieldId="{{field.id}}" data-field="customField" data-type="boolean"><th><span class="title">{{field.name}}</span>{{#field.required}}<ins class="asterisk">*</ins>{{/field.required}}</th><td><span class="option_wrap"><input type="checkbox" {{#taskFieldValue.value}}checked{{/taskFieldValue.value}} {{^editable.FIELD}}disabled="disabled"{{/editable.FIELD}}><label>{{field.message}}</label></span></td></tr>';return t.compile(i).render({field:e,taskFieldValue:{value:GO.util.toBoolean(r)},editable:this.editable})},_makeTextFieldEl:function(e){var n=this._getFieldValue(e),r='<tr data-tag="partial" id="field{{field.id}}" data-fieldId="{{field.id}}" data-field="customField" data-type="text"><th><span class="title">{{field.name}}</span>{{#field.required}}<ins class="asterisk">*</ins>{{/field.required}}</th><td><div class="ipt_wrap"><input class="input w_max" type="text" value="{{taskFieldValue.value}}" placeholder="{{taskFieldValue.message}}"{{^editable.FIELD}}disabled="disabled"{{/editable.FIELD}}></div></td></tr>',i=t.compile(r).render({field:e,taskFieldValue:{value:n.value,message:e.message},editable:this.editable});return i},_getSelectFieldValue:function(e){return{fieldId:e.attr("data-fieldId"),value:e.find("option:selected").text()}},_getBooleanFieldValue:function(e){return{fieldId:e.attr("data-fieldId"),value:e.find("input").is(":checked")}},_getTextFieldValue:function(e){return{fieldId:e.attr("data-fieldId"),value:e.find("input").val()}},_getFieldValue:function(e){if(this.isCreate)return e;var t=this.task.get("fieldValues");if(t.length==0)return e;var n=_.find(t,function(t){return t.fieldId==e.id});return n||{value:e.defaultValue||""}},getAssignees:function(){return this.isCreate?[GO.session()]:this.task.get("asignees")},attachValidate:function(e){var t=GO.util.getFileNameAndTypeData(e),i=this.configModel.get("attachSizeLimit")?this.configModel.get("maxAttachSize"):-1,s=this.configModel.get("attachNumberLimit")?this.configModel.get("maxAttachNumber"):-1,o=this.configModel.get("excludeExtension")==undefined?"":this.configModel.get("excludeExtension");this.configModel.get("attachSizeLimit")?i=this.configModel.get("maxAttachSize"):GO.config("allowedFileUploadSize")&&(i=GO.config("allowedFileUploadSize")/1024/1024);try{$.goValidation.attachValidate("#attachWrap li",t,i,s,o),GO.session().brandName=="DO_SAAS"&&m.attachFileValidateBySaaS(t.size)}catch(u){var a=u.message;if(a=="ExtentionException")alert(n.i18n(r["\ud655\uc7a5\uc790\uac00 \ub561\ub561\uc778 \uac83\ub4e4\uc740 \ucca8\ubd80 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],"arg1",o));else if(a=="AttachSizeException")alert(n.i18n(r["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",i));else{if(a=="AttachNumberException")throw alert(n.i18n(r["\ucca8\ubd80 \ud30c\uc77c \uac1c\uc218\ub97c \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4."],"arg1",s)),new Error("overMaxAttachNumber");if(a=="AttachNumberExceptionBySaaS")throw alert(n.i18n(r["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",s)),new Error("overMaxAttachNumber");a=="NotFoundExtException"&&alert(r["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},callFile:function(){var e=-1;this.configModel.get("attachSizeLimit")?e=this.configModel.get("maxAttachSize"):GO.config("allowedFileUploadSize")&&(e=GO.config("allowedFileUploadSize")/1024/1024);var t=this.configModel.get("attachNumberLimit")?this.configModel.get("maxAttachNumber"):-1,n=this.configModel.get("excludeExtension");if(!this.fileUploadCountValidate())return!1;this.configModel.get("attachNumberLimit")&&(t-=$("#attachWrap li").size()),GO.util.callFile(e,t,n)},fileUploadCountValidate:function(){if(this.configModel.get("attachNumberLimit")){var e=$("#attachWrap li").size(),t=this.configModel.get("maxAttachNumber");if(e>=t)return alert(n.i18n(r["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",t)),!1}return!0},deleteUser:function(e){$(e.currentTarget).parents("li").remove()},_expandTextarea:function(e){GO.util.textAreaExpand(e)}});return w})}).call(this);