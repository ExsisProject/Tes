define(function(require){var e=require("matrix/constants/matrix_event"),t=require("i18n!nls/commons"),n=require("i18n!calendar/nls/calendar"),r=require("i18n!task/nls/task"),i=require("i18n!works/nls/works"),s=require("backbone"),o=require("views/profile_card"),u=require("task/views/task_matrix"),a=require("task/views/task_title"),f=require("task/collections/task_calendar_items"),l=require("models/dept_profile"),c=require("hgn!task/templates/task_calendar"),h={"\ub354 \ubcf4\uae30":r["\ub354 \ubcf4\uae30"]};return s.View.extend({events:{"click li[data-nav-type]":"_onClickNav","click #moreButton":"_onClickMoreButton","click #home":"_onClickHomeButton","click td[data-row-head]":"_profile"},initialize:function(e){this.navType=GO.util.store.get(GO.session("id")+"-last-task-calendar")||"week",this.deptId=e.deptId,this.deptProfile=l.init({id:this.deptId}),this.listenTo(this.deptProfile,"sync",this._onSyncDept),this.deptProfile.fetch(),this._initMatrix()},render:function(){return this.$el.html(c({lang:h})),this.$("header.content_top").html((new a({title:""})).render().el),this.$("span.meta").html(['<span id="home" class="action">','<a class="btn_fn6">'+r["\ub098\uc758 \uc5c5\ubb34 \ud604\ud669 \ubcf4\uae30"]+"</a>","</span>"].join("")),this.$("div[data-matrix-area]").html(this.matrixView.el),this},_initMatrix:function(){var n=function(){var e=this.model.get("privateTask")?'<span class="ic_classic ic_lock"></span>':"",t=this.model.get("delay")?'<span style="color: red;">'+this.model.get("name")+"</span>":this.model.get("name");return{content:e+t,title:this.model.get("name")}};this.collection=new f([],{deptId:this.deptId}),this.collection.setRangeType(this.navType),this.listenTo(this.collection,"sync",this._onSyncCollection),this.matrixView=new u({matrix:{type:"week",gridUnit:"days",gridValue:1,startTime:moment(new Date).startOf(this.navType).format("YYYY-MM-DDTHH:mm:ss.sssZ"),endTime:moment(new Date).endOf(this.navType).add(1,"millisecond").format("YYYY-MM-DDTHH:mm:ss.sssZ"),useGrid:!0,navigationInterval:this.navType,contentRenderer:n},leftToolbar:this._toolbarTemplate(),collection:this.collection,emptyMessage:i["\ub370\uc774\ud130\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"],matrixHeader:t["\uc774\ub984"]}),this.matrixView.$el.on(e.RENDER_DONE,$.proxy(function(){this._markNav()},this)),this.matrixView.$el.on(e.ITEM_CLICK,$.proxy(function(e,t){var n=t.target.data("model"),r=GO.contextRoot+"app/task/"+n.id+"/detail";window.open(r,"_blank")},this)),this.matrixView.$el.on(e.ROW_CLICK,$.proxy(function(){GO.router.navigate("task/create",!0)},this))},_toolbarTemplate:function(){var e=Hogan.compile(['<ul class="tab_nav">','<li class="first" data-nav-type="day">',"<span>"+n["\uc77c\uac04"]+"</span>","</li>",'<li class="last" data-nav-type="week">',"<span>"+n["\uc8fc\uac04"]+"</span>","</li>","</ul>"].join(""));return e.render()},_onClickNav:function(e){var t=$(e.currentTarget),n=t.attr("data-nav-type");if(n==this.navType)return;this.navType=n,GO.util.store.set(GO.session("id")+"-last-task-calendar",n);var r=this.matrixView.getMatrix();r.setInterval(n),r.initMatrix(!0),this.collection.setRangeType(n),this.matrixView.fetch()},_markNav:function(){var e=this.matrixView.getMatrix(),t=e.get("navigationInterval");this.matrixView.$("li[data-nav-type]").removeClass("on"),this.matrixView.$('li[data-nav-type="'+t+'"]').addClass("on")},_onSyncCollection:function(){this.$("#moreButton").toggle(this.collection.hasMore())},_onClickMoreButton:function(){this.collection.page++,this.collection.fetch()},_onSyncDept:function(){this.$("h1").find("span.txt").html(this.deptProfile.get("name"))},_onClickHomeButton:function(){GO.router.navigate("task/home",!0)},_profile:function(e){e.stopPropagation();var t=e.currentTarget,n=$(t).attr("data-row-head");if(!n)return;o.render(n,t)}})});