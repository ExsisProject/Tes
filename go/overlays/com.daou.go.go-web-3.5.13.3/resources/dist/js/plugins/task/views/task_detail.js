(function(){define(["backbone","hogan","app","i18n!nls/commons","i18n!task/nls/task","i18n!board/nls/board","i18n!calendar/nls/calendar","hgn!task/templates/task_detail","task/models/task_folder","task/models/task","task/views/task_title","task/views/task_post_move","task/views/task_activity","task/views/task_log","attach_file","content_viewer","jquery.go-preloader"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m={move:r["\uc774\ub3d9"],"delete":r["\uc0ad\uc81c"],list:r["\ubaa9\ub85d"],print:r["\uc778\uc1c4"],summary:i["\uc5c5\ubb34 \uac1c\uc694"],regist:r["\ub4f1\ub85d"],edit:r["\uc218\uc815"],type:i["\uc720\ud615"],assignee:i["\ub2f4\ub2f9\uc790"],dueDate:i["\uae30\ud55c"],delay:i["\uc9c0\uc5f0"],tag:i["\ubd84\ub958"],referer:i["\ucc38\uc870\uc790"],detail:i["\uc5c5\ubb34\uc0c1\uc138"],attach:r["\ucca8\ubd80\ud30c\uc77c"],count:i["\uac1c"],save:r["\uc800\uc7a5"],folder:i["\ud3f4\ub354"],emptyValue:i["\ubbf8\uc9c0\uc815"],emptyFile:i["\ucca8\ubd80\ud30c\uc77c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],selectFolder:i["\uc5c5\ubb34\ub97c \uc774\ub3d9\uc2dc\ud0ac \ud3f4\ub354\ub97c \uc120\ud0dd\ud558\uc138\uc694"],preview:r["\uc778\uc1c4 \ubbf8\ub9ac\ubcf4\uae30"],activity:i["\ud65c\ub3d9\uae30\ub85d"],history:i["\ubcc0\uacbd\uc774\ub825"],cancel:r["\ucde8\uc18c"],post:s["\uac8c\uc2dc\ud310 \uac8c\uc2dc"]},g=t.compile('<p class="desc">{{lang.selectFolder}}</p><div><dl><dt>{{lang.folder}}</dt><dd><select>{{#folders}}<option id="{{id}}">{{name}}</option>{{/folders}}</select></dd></dl></div>'),y=e.View.extend({events:{"click span[data-tag=toggle]":"toggleView","click a[data-tag=action]":"taskAction","click #moveTask":"moveTaskPopup","click #deleteTask":"confirmDelete","click #postTask":"postBoard","click #taskEditBtn":"goTaskEdit","click #goToListBtn":"goList","click #taskPrint":"printPopup","click #closePopup":"closePopup","click #print":"print"},initialize:function(e){var t=this;this.options=e||{},this.task=new f(this.options),this.isPrint=this.options.isPrint,this.$el.on("change:log",function(){t.logView.logs.setPage(0),t.logView.render()})},dataFetch:function(){var e=this,t=$.Deferred();return this.task.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}},success:function(n){n.isReadable()||window.history.back();var r=n.getAction();e.folder=new a({id:n.get("folderId")}),e.folder.fetch({success:function(n){e.isPrint||GO.util.store.set("taskFolderId",n.id,{type:"session"});var i=n.getDepartment();i.done(function(t){e.dept=t.data}),$.when(r,i).done(function(){t.resolve(e)})}})}}),t},render:function(){var e={lang:m,isAvailableBoard:GO.isAvailableApp("board"),referers:this._userNameHelper("referers"),approver:this._userNameHelper("approver"),folder:this.folder.toJSON(),data:$.extend(this.task.toJSON(),{}),fileInfo:this._getFilesInfo(),dept:this.dept,actions:this.task.actions,createdAt:GO.util.basicDate(this.task.get("createdAt")),beginDate:this.task.getBeginDate()||null,dueDate:this.task.getDueDate()||null,isDelay:this.task.get("delay"),tagLabel:this.task.getTagLabel()||null,content:GO.util.convertMSWordTag(this.task.get("content")),status:this.task.get("status").end?"finished":"ongoing",isMultiType:this.folder.isMultiType(),isPrint:this.isPrint,hasEvent:this.task.hasEvent(),calendarEventInfo:this._getCalendarEventInfo()};this.$el.html(u(e));var t=new l({title:this.folder.get("name"),subTitle:this.dept.name,isPrivate:this.folder.get("privateTask")});this.$el.find(".content_top").html(t.el),t.render(),this.renderApproverView(),this.renderFieldView(),this.renderActivityView(),this.renderLogView(),this.isPrint||this.renderContentViewer();var n=this;return d.create("#attachArea",this.task.get("attaches"),function(e){return GO.contextRoot+"api/task/"+n.task.id+"/download/"+e.id}),this.setStyle(),this.allowAction=!0,this},setStyle:function(){var e=this.isPrint?"layer_normal layer_task_print popup":"go_renew";this.$el.addClass(e),this.$el.find("div.task_type").css("overflow-x","auto")},taskAction:function(e){var t=this;if(!this.allowAction)return;this.allowAction=!1;var n=$(e.currentTarget).attr("data-actionId"),i=$.ajax({type:"PUT",dataType:"json",url:GO.contextRoot+"api/task/"+this.task.get("id")+"/action/"+n,success:function(e){$.goMessage(r["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.task.fetch({success:function(e){e.getAction().done(function(){t.render()})}}),this.allowAction=!0},error:function(e){$.goError(e.responseJSON.message),this.allowAction=!0}}),s=$.goPreloader();i.progress(function(){s.render()}),i.always(function(){s.release()})},goTaskEdit:function(){GO.util.store.set("taskFolderId",null,{type:"session"}),n.router.navigate("task/"+this.task.get("id"),!0)},isFullSearch:function(){var e=GO.router.getSearch();return!_.isEmpty(e)&&!_.has(e,"page")},goList:function(){GO.util.store.set("taskFolderId",null,{type:"session"}),GO.util.store.set("sideItem","departmentFolder"+this.folder.id,{type:"session"});var e=this.serializeObj(GO.router.getSearch()),t=e?"?"+e:"";this.isFullSearch()?n.router.navigate("task/search"+t,!0):n.router.navigate("task/folder/"+this.folder.get("id")+"/task"+t,!0)},serializeObj:function(e){var t=[];for(var n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},printPopup:function(){var e=GO.contextRoot+"app/task/"+this.task.get("id")+"/print";window.open(e,"","location=no, directories=no, resizable=yes, status=no, toolbar=no, menubar=no, width=1280, height=650, left=0, top=0, scrollbars=yes")},closePopup:function(){window.close()},print:function(){window.print()},renderApproverView:function(){if(!this.task.get("issueType").approver)return;this.makeApproverView()},makeApproverView:function(){var e=this.task.get("approver");if(!e)return;var t=[e.name,e.position||""].join(" "),n='<tr id="approver"><th><span class="title">'+i["\uc2b9\uc778\uc790"]+"</span></th>"+'<td><span class="txt">'+t+"</span></td>"+"</tr>";$("tr#approver").replaceWith(n)},renderActivityView:function(){var e=this,t=new h({taskId:this.task.get("id"),isPrint:this.isPrint,dept:this.dept});t.dataFetch().done(function(n){e.$("#taskSection").append(t.el),t.render()})},renderFieldView:function(){var e=this._getFields(this.folder.get("fields")).join(""),t=this._getFields(this.task.get("issueType").fields).join("");$("#fieldArea").replaceWith(e.concat(t))},renderLogView:function(){this.logView=new p({taskId:this.task.get("id")}),$("#logSection").append(this.logView.el),this.logView.render()},renderContentViewer:function(){v.init({$el:this.$("#contentArea"),content:GO.util.convertMSWordTag(this.task.get("content"))})},toggleView:function(e){var t=$(e.currentTarget),n=t.find("span"),r=t.attr("data-type");n.hasClass("ic_close")?$("#"+r).slideUp(300):$("#"+r).slideDown(300),n.toggleClass("ic_close"),n.toggleClass("ic_open")},moveTaskPopup:function(){var e=this.folder.getMovableFolders();e.done(function(e){$.goPopup({header:i["\uc5c5\ubb34 \uc774\ub3d9"],width:320,contents:g.render({folders:self.folder.getMovableFolders()}),buttons:[{btext:r["\uc774\ub3d9"],btype:"confirm"}],pclass:"layer_normal layer_item_move"})}).fail(function(e){$.goError(e.responseJSON.message)})},postBoard:function(){var e=new c({taskIds:this.task.id,deptId:this.dept.id,url:GO.contextRoot+"api/linkage/task/post"});e.render()},confirmDelete:function(){var e=this;$.goPopup({title:i["\uc5c5\ubb34 \uc0ad\uc81c"],message:i["\uc5c5\ubb34 \uc0ad\uc81c \uc124\uba85"],buttons:[{btype:"confirm",btext:r["\ud655\uc778"],callback:function(){e.deleteTask()}},{btext:r["\ucde8\uc18c"],callback:function(){}}]})},deleteTask:function(){$.goMessage(r["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),this.task.destroy(),this.goList()},_getCalendarEventInfo:function(){return"* "+this.task.getEventStartDate()+" ~ "+this.task.getEventEndDate()+" "+o["\uce98\ub9b0\ub354 \uc77c\uc815 \ub4f1\ub85d\ub428"]},_getFilesInfo:function(){var e=[],t=0;return _.each(this.task.get("attaches"),function(n){n.fileSizeString=GO.util.getHumanizedFileSize(n.size),n.downloadPath=GO.contextRoot+"api/task/"+this.task.get("id")+"/download/"+n.id,n.style=GO.util.getFileIconStyle(n),n.isImageType=GO.util.isImage(n.extention),e.push(n),t+=n.size},this),{size:GO.util.getHumanizedFileSize(t),count:this.task.get("attaches").length,files:e,filePresent:this.task.get("attaches").length?!0:!1}},_userNameHelper:function(e){var t=null;if(e=="approver")t=this.task.get(e);else{var n=_.map(this.task.get(e),function(e){return e.name+" "+e.position||""});t=n.length?n.join(", "):i["\ubbf8\uc9c0\uc815"]}return t},_getFields:function(e){var t=[];return _.each(e,function(e){if(e.type=="SELECT")t.push(this._selectField(e));else if(e.type=="BOOLEAN")t.push(this._booleanField(e));else{if(e.type!="TEXT")return;t.push(this._textField(e))}},this),t},_selectField:function(e){var n=this._getTaskFieldValue(e);if(!n||!n.value)return"";var r='<tr><th><span class="title">{{field.name}}</span></th><td><span class="txt">{{value}}</span></td></tr>';return t.compile(r).render({field:e,value:n.value})},_booleanField:function(e){var n=this._getTaskFieldValue(e);if(!n)return"";var r='<tr><th><span class="title">{{field.name}}</span></th><td><span class="wrap_option"><input type="checkbox" {{#value}}checked{{/value}} disabled><label>{{field.message}}</label></span></td></tr>';return t.compile(r).render({field:e,value:GO.util.toBoolean(n.value)})},_textField:function(e){var n=this._getTaskFieldValue(e);if(!n||!n.value)return"";var r='<tr><th><span class="title">{{field.name}}</span></th><td><span class="txt">{{value}}</span></td></tr>';return t.compile(r).render({field:e,value:n.value})},_getTaskFieldValue:function(e){return _.find(this.task.get("fieldValues"),function(t){return t.fieldId==e.id})}});return y})}).call(this);