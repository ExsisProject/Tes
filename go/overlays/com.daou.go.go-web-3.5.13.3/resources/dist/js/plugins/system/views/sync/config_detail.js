define(function(require){var e=require("backbone"),t=require("hgn!system/templates/sync/config_detail"),n=require("system/models/sync/config_query_model"),r=require("hgn!system/templates/sync/config_jdbc"),i=require("i18n!admin/nls/admin"),s=require("i18n!nls/commons"),o={label_sync_header_title:i["\ub3d9\uae30\ud654 \uc124\uc815"],label_sync_query_id:i["\uc544\uc774\ub514"],label_sync_company_name:i["\ud68c\uc0ac\uba85"],label_choice:i["\ud56d\ubaa9 \uc120\ud0dd"],label_sync_query_type:i["Query Type"],label_sync_key_columns:i["Key Columns"],label_sync_query:i.Query,label_jdbclist_null_message:i["\ud574\ub2f9\ub418\ub294 \ud68c\uc0ac\uc758 JDBC TEMPLATE\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],label_save:s["\uc800\uc7a5"],label_cancel:s["\ucde8\uc18c"],label_success_message:i["\uc815\uc0c1\uc801\uc73c\ub85c \ubc18\uc601 \ub418\uc5c8\uc2b5\ub2c8\ub2e4."],label_fail_message:s["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."],label_error_message_company_name:i["\ud68c\uc0ac\uba85\uc774 \uc120\ud0dd\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],label_error_message_jdbc_name:i["JDBC \uc124\uc815\uba85\uc774 \uc120\ud0dd\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],label_error_message_query_type:i["QueryType\uac00 \uc120\ud0dd\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],label_error_message_key_columns:i["Key Columns\uac00 \uc815\uc758\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],label_error_message_query:i["Query\uac00 \uc815\uc758\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],label_same_query_type_error_message:i["\ud574\ub2f9 \ud68c\uc0ac\uc5d0 \ub3d9\uc77c\ud55c QueryType\uc774 \uc874\uc7ac\ud569\ub2c8\ub2e4."]},u=[{type:"USER"},{type:"DEPARTMENT"},{type:"DEPTMEMBER"},{type:"DUTY"},{type:"POSITION"},{type:"GRADE"},{type:"USERGROUP"},{type:"LINKUSERGROUP"},{type:"CONTACTGROUP"},{type:"CONTACT"}],a=e.Collection.extend({url:GO.contextRoot+"ad/api/sync/query/jdbckey/",getData:function(){var e=this.toJSON();return _.isEmpty(e)&&e.unshift({id:"",configName:o.label_choice}),e}}),f=e.View.extend({initialize:function(){this.companies=this.options.companies,_.isUndefined(this.options.model)?(this.model=new n,this.isNew=!0):(this.model=this.options.model,this.isNew=!1)},render:function(){var e=this,n=this.model.toJSON(),r=t({data:n,lang:o,types:u,isSelectedType:function(){if(_.isEmpty(n.queryType))return;return this.type==n.queryType},companies:this.companies,isSelectedCompany:function(){if(_.isEmpty(n.companyName))return;return this.name==n.companyName}});this.popup=$.goPopup({async:!1,header:o.label_sync_header_title,width:500,contents:r,buttons:[{btext:o.label_save,btype:"confirm",autoclose:!1,callback:function(){e._saveQuery()}},{btext:o.label_cancel}]}),this.popup.find("#pop_company").on("change",e._refreshJdbcName),this._refreshJdbcName(n)},_saveQuery:function(){try{this._validateQueryData()}catch(e){$.goError(e);return}var t=this,n=$(".sync_add_table");this.model.save({companyId:n.find("#pop_company").val(),jdbcId:n.find("#pop_jdbc_name").val(),keyColumns:n.find("#pop_query_columns").val(),queryType:n.find("#pop_query_type").val(),query:n.find("#pop_query").val()},{success:function(){$.goMessage(o.label_success_message),$(".syncMainView").trigger("refresh"),t.popup.close()},error:function(e,t){t.responseJSON.message=="sameQueryType"?$.goError(o.label_same_query_type_error_message):$.goError(o.label_fail_message)}})},_refreshJdbcName:function(e){var t=$("#pop_company").val();this.jdbcList=new a,this.isNew||this.jdbcList.fetch({data:$.param({company_id:t}),async:!1});var n=this.isNew?"":e.jdbcId;$("#pop_jdbc_name").html(r({lang:o,jdbcs:this.jdbcList.getData(),isSelectedJdbc:function(){return this.id==n}}))},_validateQueryData:function(){if(_.isEmpty($("#pop_company option:selected").val()))throw o.label_error_message_company_name;if(_.isEmpty($("#pop_jdbc_name option:selected").val()))throw o.label_error_message_jdbc_name;if(_.isEmpty($("#pop_query_type option:selected").val()))throw o.label_error_message_query_type;if(_.isEmpty($("#pop_query_columns").val()))throw o.label_error_message_key_columns;if(_.isEmpty($("#pop_query").val()))throw o.label_error_message_query}});return f});