define(["jquery","backbone","app","admin/models/install_info","hgn!system/templates/domain_create","hgn!system/templates/domain_modify","system/models/mailDomainModel","system/models/licenseModel","system/models/installInfoModel","i18n!nls/commons","i18n!admin/nls/admin","jquery.go-orgslide","jquery.go-sdk","jquery.go-validation","swfupload","swfupload.plugin"],function(e,t,n,r,i,s,o,u,r,a,f){var l={label_domain_info:f["\ub3c4\uba54\uc778 \uae30\ubcf8\uc815\ubcf4"],label_domain:f["\ub3c4\uba54\uc778 \uba85"],label_add:a["\ucd94\uac00"],label_delete:a["\uc0ad\uc81c"],label_virtual_domain:f["\uac00\uc0c1\ub3c4\uba54\uc778"],label_modify:a["\uc218\uc815"],label_cancel:a["\ucde8\uc18c"],label_save:a["\uc800\uc7a5"],label_user_virtual_domain:f["\uc0ac\uc6a9\uc790 \ubcc4 \uac00\uc0c1\ub3c4\uba54\uc778"],label_mode:f["\ub85c\uadf8\uc778 \ubc29\ubc95"],label_id:f["\uc544\uc774\ub514"],label_employeenum:f["\uc778\uc2dd\ubc88\ud638(\uc0ac\ubc88/\ud559\ubc88)"],label_prev:a["\uc774\uc804"],label_save_next:f["\uc800\uc7a5 \ud6c4 \ub2e4\uc74c"],label_domain_name_help:f["\ub3c4\uba54\uc778 \uba85 \uc124\uba85"],label_web_address_help:f["\uc6f9\uc8fc\uc18c \uc124\uba85"],label_virtual_domain_help:f["\uac00\uc0c1 \ub3c4\uba54\uc778 \uc124\uba85"],label_user_virtual_domain_help:f["\uc0ac\uc6a9\uc790\ubcc4 \uac00\uc0c1 \ub3c4\uba54\uc778 \uc124\uba85"]},c=null,h=n.BaseView.extend({initialize:function(e){this.options=e||{},this.domainId=this.options.domainId,this.modUserCount=0,this.licenseModel=u.read(),this.installInfoModel=r.read(),this.unbindEvent(),this.bindEvent()},unbindEvent:function(){this.$el.off("click","#btn_ok"),this.$el.off("click","#btn_modify"),this.$el.off("click","#btn_cancel"),this.$el.off("click","span#btn_add_virtualDomain"),this.$el.off("click","span#btn_add_user_virtualDomain"),this.$el.off("click","span#btn_delete_virtualDomain"),this.$el.off("click","span#btn_delete_user_virtualDomain"),this.$el.off("click","span.editable"),this.$el.off("keyup","#mailDomain")},bindEvent:function(){this.$el.on("click","#btn_ok",e.proxy(this.domainSave,this)),this.$el.on("click","#btn_modify",e.proxy(this.domainModify,this)),this.$el.on("click","#btn_cancel",e.proxy(this.domainCancel,this)),this.$el.on("click","span#btn_add_virtualDomain",e.proxy(this.addVirtualDomain,this)),this.$el.on("click","span#btn_add_user_virtualDomain",e.proxy(this.addUserVirtualDomain,this)),this.$el.on("click","span#btn_delete_virtualDomain",e.proxy(this.deleteVirtualDomains,this)),this.$el.on("click","span#btn_delete_user_virtualDomain",e.proxy(this.deleteUserVirtualDomains,this)),this.$el.on("click","span.editable",e.proxy(this.changeInput,this)),this.$el.on("keyup","#mailDomain",e.proxy(this.avilableMailDomain,this))},render:function(){var t,r=this.installInfoModel.toJSON(),u=this._canSelectEmpNoLoginMode();this.$el.empty(),this.domainId?(this.mailDomainModel=o.get(this.domainId),this.domainData=this.mailDomainModel.toJSON(),e(".breadcrumb .path").html(f["\ub3c4\uba54\uc778/\uc0ac\uc774\ud2b8 \uad00\ub9ac > \ub3c4\uba54\uc778 \uc218\uc815"]),t=s({domainInfo:this.domainData,lang:l,isInstalled:r.installed,canSelectEmpNoLoginMode:u}),this.$el.html(t),this.setDomainModifyData(this.domainData)):(r.installedDomainSeq!=null&&(r.installState=="site"||r.installState=="domain")&&n.router.navigate("domain/modify/"+r.installedDomainSeq,{trigger:!0,replace:!0}),e(".breadcrumb .path").html(f["\ub3c4\uba54\uc778/\uc0ac\uc774\ud2b8 \uad00\ub9ac > \ub3c4\uba54\uc778 \ucd94\uac00"]),t=i({lang:l,isInstalled:r.installed,canSelectEmpNoLoginMode:u}),this.$el.html(t)),r.installed||(this.setDominMultiBox("virtualDomains"),this.setDominMultiBox("userVirtualDomains"))},setDomainModifyData:function(t){this.$el.find("#loginMode").val(t.loginMode);var n=t.virtualDomains,r=t.userVirtualDomains;for(var i=0;i<n.length;i++)e("#virtualDomains").append('<OPTION value="'+n[i]+'">'+n[i]+"</OPTION>");for(var i=0;i<r.length;i++)e("#userVirtualDomains").append('<OPTION value="'+r[i]+'">'+r[i]+"</OPTION>")},setDominMultiBox:function(t){e("#"+t+" > option").length>0?e("#"+t).show():e("#"+t).hide()},changeInput:function(t){t.stopPropagation();var n=e(t.target),r;n.hasClass("ic_edit")?(r=n.parent().parent(),r.hide(),r.next().show()):(n.hide(),n.next().show())},makeConfirmMsg:function(t,n,r){e.goConfirm(t,"",n,a["\ud655\uc778"],r)},avilableMailDomain:function(t){t.stopPropagation(),this.chackAddedDomains(e("#mailDomain").val().toLowerCase(),!0)||this.showValidateMsg("mailDomain",f["\ub3d9\uc77c\ud55c \ub3c4\uba54\uc778\uc774 \uc874\uc7ac\ud569\ub2c8\ub2e4."])},addVirtualDomain:function(t){t.stopPropagation();var n=e("#addVirtualDomain").attr("value").toLowerCase(),r=this.installInfoModel.toJSON();e("#virtualDomains > option").attr("selected",!1),this.validateVirtualDomains(n,"addVirtualDomain","virtualDomains"),r.installed||this.setDominMultiBox("virtualDomains")},addUserVirtualDomain:function(t){t.stopPropagation();var n=e("#addUserVirtualDomain").attr("value").toLowerCase(),r=this.installInfoModel.toJSON();e("#userVirtualDomains > option").attr("selected",!1),this.validateVirtualDomains(n,"addUserVirtualDomain","userVirtualDomains"),r.installed||this.setDominMultiBox("userVirtualDomains")},validateVirtualDomains:function(t,n,r){var i=this,s=!0;if(t==""){i.showValidateMsg(n,f["\uac00\uc0c1\ub3c4\uba54\uc778\uc744 \uc785\ub825\ud558\uc138\uc694."]);return}if(!e.goValidation.isCheckLength(1,128,t)){i.showValidateMsg(n,f["\uac00\uc0c1\ub3c4\uba54\uc778\uc758 \ud615\uc2dd\uc774 \uc798\ubabb\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]);return}if(!e.goValidation.isValidDomain(t)){i.showValidateMsg(n,f["\uac00\uc0c1\ub3c4\uba54\uc778\uc758 \ud615\uc2dd\uc774 \uc798\ubabb\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]);return}e("#"+r+" option").each(function(){if(e(this).val()==t)return i.showValidateMsg(n,f["\uc774\ubbf8 \uc874\uc7ac\ud558\ub294 \uac00\uc0c1 \ub3c4\uba54\uc778 \uc785\ub2c8\ub2e4."]),e(this).attr("selected",!0),s=!1,!1});if(!this.chackAddedDomains(t,!1)){i.showValidateMsg(n,f["\uc774\ubbf8 \uc874\uc7ac\ud558\ub294 \uac00\uc0c1 \ub3c4\uba54\uc778 \uc785\ub2c8\ub2e4."]);return}var o=this.checkDuplicated(t,"");if(o)return i.showValidateMsg(n,f["\uc774\ubbf8 \uc874\uc7ac\ud558\ub294 \uac00\uc0c1 \ub3c4\uba54\uc778 \uc785\ub2c8\ub2e4."]),e("#"+n+"").focus(),!1;s==1&&(e("#"+r+"").append('<OPTION value="'+t+'">'+t+"</OPTION>"),e("#"+n+"").val(""))},deleteVirtualDomains:function(t){t.stopPropagation();var n=document.formDomainConfig.virtualDomains;for(var r=0;r<n.options.length;)if(n.options[r].selected){if(!this.isErasableVirtualDomain(n.options[r].value)){e.goAlert(f["\uac00\uc0c1\ub3c4\uba54\uc778 \uc0ad\uc81c \ubabb\ud568"],"","");break}n.removeChild(n.options[r])}else r++},deleteUserVirtualDomains:function(t){t.stopPropagation();var n=document.formDomainConfig.userVirtualDomains;for(var r=0;r<n.options.length;)if(n.options[r].selected){if(!this.isErasableUserVirtualDomain(n.options[r].value)){e.goAlert(f["\uac00\uc0c1\ub3c4\uba54\uc778 \uc0ad\uc81c \ubabb\ud568"],"","");break}n.removeChild(n.options[r])}else r++},checkValidation:function(t,n){var r=this,i="",s=!0;return n=="mod"&&(i=this.domainData.mailDomain),e.each(t.serializeArray(),function(t,n){if(n.name=="mailDomain"&&!e.goValidation.isCheckLength(1,128,n.value))return r.showValidateMsg(n.name,f["\ub3c4\uba54\uc778 \uba85\uc744 \uc785\ub825\ud558\uc138\uc694."]),s=!1,!1;if(n.name=="mailDomain"&&!e.goValidation.isValidDomain(n.value))return r.showValidateMsg(n.name,f["\ub3c4\uba54\uc778 \ud615\uc2dd\uc774 \uc798\ubabb\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),s=!1,!1;if(n.name=="mailDomain"&&r.checkDuplicated(n.value,i))return r.showValidateMsg(n.name,f["\ub3d9\uc77c\ud55c \ub3c4\uba54\uc778\uc774 \uc874\uc7ac\ud569\ub2c8\ub2e4."]),s=!1,!1}),s?!0:!1},makeModel:function(t,n){return n.set("virtualDomains",[],{silent:!0}),n.set("userVirtualDomains",[],{silent:!0}),e.each(t.serializeArray(),function(t,r){r.name=="mailDomain"&&(r.value=e("#mailDomain").val().toLowerCase()),r.name=="virtualDomains"&&(r.value=e("#virtualDomains").val()),r.name=="userVirtualDomains"&&(r.value=e("#userVirtualDomains").val()),r.name=="loginMode"&&(r.value=e("#loginMode option:checked").val()),n.set(r.name,r.value,{silent:!0})}),n},domainSave:function(t){t.stopPropagation();var r=this.installInfoModel.toJSON();e(".go_alert").empty(),this.model=o.create(),this.model.clear();var i=this,s=!0,u=this.$el.find("form[name=formDomainConfig]");e("#virtualDomains > option").attr("selected","selected"),e("#userVirtualDomains > option").attr("selected","selected"),s=i.checkValidation(u,"new");if(!s)return!1;this.model=this.makeModel(u,this.model),GO.EventEmitter.trigger("common","layout:setOverlay",""),this.model.save({},{type:"POST",success:function(t,s){s.code=="200"&&(e.goMessage(a["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),r.installed?n.router.navigate("system/domain",{trigger:!0}):(i.changeInstallState(),n.router.navigate("site/create",{trigger:!0})),GO.EventEmitter.trigger("common","layout:clearOverlay",!0))},error:function(t,n){var r=JSON.parse(n.responseText);e.goMessage(r.message),e("#WEBMAIL").attr("disabled",!0),GO.EventEmitter.trigger("common","layout:clearOverlay",!0)}})},domainModify:function(t){t.stopPropagation();var r=this.installInfoModel.toJSON();e(".go_alert").empty();var i=this,s=!0,o=this.$el.find("form[name=formDomainConfig]"),u=GO.contextRoot+"ad/api/system/domain/"+this.domainId;e("#virtualDomains > option").attr("selected","selected"),e("#userVirtualDomains > option").attr("selected","selected"),s=i.checkValidation(o,"mod");if(!s)return!1;var f=this.makeModel(o,this.mailDomainModel);GO.EventEmitter.trigger("common","layout:setOverlay",""),e.go(u,JSON.stringify(f),{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200&&(e.goMessage(a["\uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),r.installed?n.router.navigate("system/domain",{trigger:!0}):n.router.navigate("site/create",{trigger:!0}),GO.EventEmitter.trigger("common","layout:clearOverlay",!0))},error:function(t){var n=JSON.parse(t.responseText);e.goMessage(n.message),e("#WEBMAIL").attr("disabled",!0),GO.EventEmitter.trigger("common","layout:clearOverlay",!0)}})},domainCancel:function(e){e.stopPropagation(),this.render()},checkDuplicated:function(t,n){var r=GO.contextRoot+"ad/api/system/domain/duplicated",i=!0,s={domain:t,exclude:n};return e.go(r,s,{qryType:"GET",async:!1,responseFn:function(e){e.code==200&&e.data.duplicated?(this.showValidateMsg("mailDomain",f["\ub3d9\uc77c\ud55c \ub3c4\uba54\uc778\uc774 \uc874\uc7ac\ud569\ub2c8\ub2e4."]),i=!0):i=!1},error:function(t){var n=JSON.parse(t.responseText);e.goMessage(n.message)}}),i},changeInstallState:function(){var t=GO.contextRoot+"ad/api/system/change/state/site";e.go(t,"",{qryType:"GET",responseFn:function(e){},error:function(e){}})},isErasableUserVirtualDomain:function(t){if(this.domainId=="")return!0;var n,r=GO.contextRoot+"ad/api/system/uservirtualdomain",i={domainId:this.domainId,deleteVirtualId:t};return e.go(r,i,{qryType:"GET",async:!1,responseFn:function(e){e.code==200&&(n=e.data)},error:function(e){n=!1}}),n},isErasableVirtualDomain:function(t){if(this.domainId==""||this.domainId==undefined)return!0;var n,r=GO.contextRoot+"ad/api/system/virtualdomain",i={domainId:this.domainId,deleteVirtualId:t};return e.go(r,i,{qryType:"GET",async:!1,responseFn:function(e){e.code==200&&(n=e.data)},error:function(t){var n=JSON.parse(t.responseText);e.goMessage(n.message)}}),n},showValidateMsg:function(t,n){e("#"+t).focus(),e("#"+t+"Validate").html(n)},chackAddedDomains:function(t,n){var r=[],i=!0;if(!n){var s=e("#mailDomain").val().toLowerCase();r.push(s)}return e.each(e("#virtualDomains option"),function(t){r.push(e(this).val())}),e.each(e("#userVirtualDomains option"),function(t){r.push(e(this).val())}),e.each(r,function(e){r[e]==t&&(i=!1)}),i},_canSelectEmpNoLoginMode:function(){var t=!0;return e.ajax({type:"GET",async:!1,dataType:"json",url:GO.contextRoot+"ad/api/system/domain/setting",success:function(e){e.code==200&&(t=e.data=="off")},error:function(t){e.goError(t.responseJSON.message)}}),t}},{create:function(e){return c=new h({el:e.el?e.el:"#layoutContent",domainId:e?e.domainId:""}),c.domainId=e?e.domainId:"",c.render()}});return{render:function(e){var t=h.create(e);return t}}});