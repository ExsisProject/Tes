define(function(require){var e=require("backbone"),t=require("hgn!system/templates/database/db_detail"),n=require("i18n!admin/nls/admin"),r=require("i18n!nls/commons"),i={label_db_header_config:r["\uc811\uc18d\uc124\uc815"],label_db_company_name:n["\ud68c\uc0ac\uba85"],label_db_config_name:n["\uc124\uc815\uba85"],label_db_key:n.Key,label_db_vender:n.Vender,label_db_host:n.Host,label_db_protocol:n.Protocol,label_db_driver:n.Driver,label_db_database:n.Database,label_db_user_name:n["\uc0ac\uc6a9\uc790\uba85"],label_db_password:n["\ube44\ubc00\ubc88\ud638"],label_db_password_change:n["\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd"],label_db_port:n["\ud3ec\ud2b8"],label_db_company:n["\ud68c\uc0ac"],label_choice:n["\ud56d\ubaa9 \uc120\ud0dd"],label_db_description:n["\uc124\uba85"],label_db_maxpoolsize:n.MaxPoolSize,label_db_minpoolsize:n.MinPoolSize,label_db_initpoolsize:n.InitPoolSize,label_db_checkout_timeout:n.CheckoutTimeout,label_remarks:n["\ube44\uace0"],label_test:n["\ud14c\uc2a4\ud2b8"],label_save:r["\uc800\uc7a5"],label_close:r["\ub2eb\uae30"],label_db_save:n["DB \uc124\uc815 \uc800\uc7a5"],label_db_save_message:n["\ud574\ub2f9 \uc811\uc18d\uc124\uc815\uc744 \uc800\uc7a5\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],label_save_success_message:r["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],label_save_error_message:r["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]},s=e.Collection.extend({url:GO.contextRoot+"ad/api/system/companies"}),o=e.Collection.extend({url:GO.contextRoot+"ad/api/system/dbconfig/venders"}),u=e.Model.extend({url:GO.contextRoot+"ad/api/system/dbconfig"}),a=e.View.extend({el:".detail_container",events:{"click input:radio":"_changeVendor","submit #dataForm":"_save","click #changePwd":"_changePassword","click #cancel_btn":"_close","change #key":"_checkDuplicated"},initialize:function(){this.vendors=new o,this.companies=new s},renderInsert:function(){function n(){e.$el.empty(),e.$el.html(t({lang:i,venders:e.vendors.toJSON(),companies:e.companies.toJSON(),isNew:!0}))}var e=this;this.model=new u,this.fetchData(n)},fetchData:function(e){$.when(this.vendors.fetch(),this.companies.fetch()).then(e)},renderModify:function(e){function r(){n.$el.html(t({lang:i,venders:n.vendors.toJSON(),companies:n.companies.toJSON(),data:e.toJSON(),isNew:!1}));var r=document.querySelectorAll("input[name=vendor]");Array.prototype.slice.call(r).map(function(t){t.value==String(e.toJSON().vendor).toLowerCase()&&(t.checked=!0,t.click())}),document.getElementById("configCompany").value=e.toJSON().companyId}var n=this;this.model=e,this.fetchData(r)},_checkDuplicated:function(e){this.trigger("isDulicatedKey",[$(e.currentTarget).val(),e])},_changePassword:function(e){var t='<input class="wfix_max" type="password" name="password" value="" required/>',n=$(e.currentTarget).closest("td");n.html(t)},_changeVendor:function(e){var t=this,n=document.querySelectorAll("input[name=vendor]:checked"),e=$(e.currentTarget).closest("span"),r={dbType:$(n).val(),protocol:$(n).parent().data("protocol"),driver:$(n).parent().data("driver")},i={dbType:"",protocol:"",driver:""};this.model.attributes.vendor!=undefined&&(i={dbType:this.model.attributes.vendor.toLowerCase(),protocol:document.querySelector("input[name=protocol]").value,driver:document.querySelector("input[name=driver]").value}),document.querySelector("input[name=protocol]").value=e.data("protocol"),document.querySelector("input[name=driver]").value=e.data("driver"),r.dbType!=i.dbType&&(document.querySelector("input[name=port]").value=e.data("port"))},_save:function(e){function n(){var e=t.model.save(GO.util.serializeForm($("#dataForm")));e.done(function(e){$.goMessage(i.label_save_success_message),t.trigger("refresh_list"),t.$el.empty()}),e.fail(function(e,t){$.goAlert(i.label_save_error_message),console.log(t)})}e.preventDefault();var t=this;return $.goConfirm(i.label_db_save,i.label_db_save_message,n),!1},_close:function(){document.querySelector(".detail_container").innerHTML=""}});return a});