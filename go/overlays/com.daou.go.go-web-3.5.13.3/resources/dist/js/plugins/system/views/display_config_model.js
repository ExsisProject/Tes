define(function(require){function l(e){var n=[];return t.each(e||{},function(e,t){n.push({key:t,value:e})}),n}var e=require("jquery"),t=require("underscore"),n=require("backbone"),r=require("hogan"),i=require("app"),s=require("when"),o=require("i18n!admin/nls/admin"),u=require("i18n!nls/commons"),a=require("hgn!system/templates/display_config_model");require("jquery.go-popup"),require("jquery.go-grid");var f={label_company_name:o["\ud68c\uc0ac\uba85"],label_add:o["\ucd94\uac00"],label_mod:u["\uc218\uc815"],label_perfomance:u["\uc218\ud589"],label_delete:u["\uc0ad\uc81c"]},c=!1,h=n.View.extend({events:{"click .btn-cmd":"_onClickAddAttr","change #companyList":"_onChangeCompany","click span.ic_delete":"onClickDeleteDisplayConfig"},initialize:function(e){},render:function(){e(".breadcrumb .path").html(o["DisplayConfigModel \uad00\ub9ac"]),this._renderTemplate(),this._getCompanyList().then(this._initSelectCompany).then(t.bind(this._loadDisplayConfigList,this)).then(t.bind(this._renderList,this)).otherwise(function(e){console.log(e.stack)})},_renderTemplate:function(e){this.$el.html(a({lang:f}))},_renderList:function(t){e("#displayConfigList tbody").empty();var n=this.$el.find("#displayConfigList tbody"),i='{{#rows}}<tr class="odd"><!--td><input name="key" type="checkbox" value="{{key}}"></td--><td class="display_config_key" style="text-align: left;">{{key}}</td><td><input type="text" name="{{key}}" class="input txt display_config_value" value="{{value}}" style="width: 95% !important;"/></td><td><div class="critical"><span class="btn_tool btn-cmd" data-key="{{key}}" data-role="update">{{lang.label_mod}}</span> </div></td><td><span class="btn_border display_config_delete_btn_wrap"><span class="ic ic_delete" title={{lang.label_delete}}></span></span></td></tr>{{/rows}}',s=r.compile(i);n.empty().append(s.render({rows:t,lang:f}))},_reloadList:function(e){this._resetCreateForm(),this._renderList(e)},_resetCreateForm:function(){e("#newAttrKey").val(""),e("#newAttrValue").val("")},_getCompanyList:function(){return s.promise(function(t,n){var r=i.config("contextRoot")+"ad/api/system/companies?offset=999";e.ajax(r,{type:"GET",success:function(n){e.each(n.data,function(t,n){e("#companyList").append('<option value="'+n.id+'">'+n.name+"</option>")}),t(n.data)},error:function(t){var r=JSON.parse(t.responseText);e.goMessage(r.message),n()}})})},_initSelectCompany:function(){return e("#companyList").val(i.session("companyId")),s.resolve()},_loadDisplayConfigList:function(){return s.promise(t.bind(function(t,n){var r=this._getSelectedCompanyId();if(!r){e.goSlideMessage(o["\ud68c\uc0ac\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694"],"caution");return}e.ajax(i.config("contextRoot")+"ad/api/company/displayconfig",{type:"GET",data:{companyId:r,includePreservedKey:!1},success:function(e){e&&e.code=="200"?t(l(e.data)):n()},error:function(t){var r=JSON.parse(t.responseText);e.goSlideMessage(r.message,"caution"),n()}})},this))},_getSelectedCompanyId:function(){return e("#companyList").val()},_onClickAddAttr:function(t){t.preventDefault();var n=this,r=e(t.currentTarget),s=r.closest("tr"),a=this._getSelectedCompanyId(),f={},h=r.attr("data-role"),p="POST",d="",v="";if(c){e.goSlideMessage(o["\uc694\uccad \uc911\uc785\ub2c8\ub2e4."]);return}if(h==="create")d=e.trim(s.find("input[name=key]").val()),v=s.find("input[name=value]").val();else{if(h!=="update"){e.goSlideMessage(o["\ud5c8\uc6a9\ub418\uc9c0 \uc54a\uc740 \uc694\uccad\uc785\ub2c8\ub2e4."]);return}d=r.attr("data-key"),v=s.find("input[name="+d+"]").val()}if(!d||d&&d.length<1){e.goSlideMessage(o["Key \ubbf8\uc9c0\uc815 \uacbd\uace0"]),e("#newAttrKey").trigger("focus");return}if(!v||v&&v.length<1){e.goSlideMessage(o["Value \ubbf8\uc9c0\uc815 \uacbd\uace0"],"caution"),e("#newAttrValue").trigger("focus");return}f={companyId:a,key:d,value:v,includePreservedKey:!1},c=!0,e.ajax(i.config("contextRoot")+"ad/api/company/displayconfig",{type:p,data:f,success:function(t){e.goSlideMessage(u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n._reloadList(l(t.data))},error:function(t){var n=t.responseJSON.message;n!=null?e.goSlideMessage(n,"caution"):e.goSlideMessage(o["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."],"caution"),e("#newAttrKey").trigger("focus")},complete:function(){c=!1}})},_onChangeCompany:function(e){e.preventDefault(),this._loadDisplayConfigList().then(t.bind(this._reloadList,this)).otherwise(function(e){console.log(e.stack)}),e.stopImmediatePropagation()},onClickDeleteDisplayConfig:function(t){var n=this,r=e(t.currentTarget).closest("tr");if(c){e.goSlideMessage(o["\uc694\uccad \uc911\uc785\ub2c8\ub2e4."]);return}var s=e.param({companyId:n._getSelectedCompanyId(),key:r.find(".display_config_key").text()});e.ajax({url:i.config("contextRoot")+"ad/api/company/displayconfig?"+s,type:"DELETE",success:function(n){e(t.currentTarget).closest("tr").remove(),e.goSlideMessage(u["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(t){var n=t.responseJSON.message;n!=null?e.goSlideMessage(n,"caution"):e.goSlideMessage(o["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."],"caution")},complete:function(){c=!1}})}},{__instance__:null});return h});