define(function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("system/collections/companies"),s=require("system/models/asset_share_model"),o=require("system/collections/company_asset_shares"),u=require("system/views/asset_company_share_layer"),a=require("hgn!system/templates/asset_company_share"),f=require("i18n!nls/commons"),l=require("i18n!admin/nls/admin"),c=require("i18n!board/nls/board"),h=require("i18n!works/nls/works"),p=require("board/components/board_tree/board_tree"),d=require("board/models/company_board_tree_node"),v=require("board/constants");require("jquery.go-sdk"),require("GO.util"),require("jquery.go-popup");var m={company_board_add:f["\ucd94\uac00"],board_save:f["\uc800\uc7a5"],board_cancel:f["\ucde8\uc18c"],board_modify:f["\uc218\uc815"],board_delete:f["\uc0ad\uc81c"],board_stop:f["\uc911\uc9c0"],board_normal:f["\uc815\uc0c1 \uc0c1\ud0dc\ub85c \ubcc0\uacbd"],board_exposure:l["\uac8c\uc2dc\ud310 \ud648 \ub178\ucd9c"],closed_board:l["\uc911\uc9c0\ub41c \uac8c\uc2dc\ud310"],not_selected_board:c["\uac8c\uc2dc\ud310\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],stop_confirm:c["\uac8c\uc2dc\ud310 \uc911\uc9c0 \ud655\uc778"],stop_board:c["\uac8c\uc2dc\ud310 \uc911\uc9c0"],delete_confirm:c["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],delete_title:c["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],delete_success:f["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],board_title:l["\uc790\uc0b0\uba85"],share_site:l["\uacf5\uc720\ub41c \uc0ac\uc774\ud2b8"],board_no_list:h["\ub370\uc774\ud130\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]},g=null,y=!1,b=t.View.extend({el:"#companyGroupShareContent",events:{'click span[data-btntype="add"]':"popShareLayer",'click span[data-btntype="delete"]':"onDelete","click #checkedShareAll":"checkedAll","click td.b_name span":"popShareLayerByTitleClick"},initialize:function(e){this.options=e||{},this.companyGroupId=this.options.companyGroupId,this.companies=this.options.companies||new i,this.shares=new o(this.companyGroupId)},render:function(e){var t=this;console.log("[asset] AssetCompanyList:render call"),this.shares.fetch({success:function(){return t._initRender(e),t}})},_initRender:function(e){if(e===v.STATUS_ACTIVE){var t=a({isActive:!0,lang:m,isActiveBoard:!0,dataset:this.makeTemplateData(this.shares.toJSON())});this.$el.html(t)}},makeTemplateData:function(e){var t=this;return _.map(e,function(e){return{id:e.id,companyId:e.companyId,name:e.companyName+" > "+e.name,data:e}})},popShareLayer:function(t,n){if(this.companies.length<1)return e.goMessage(l["1\uac1c \uc774\uc0c1\uc758 \ub9e4\uce6d \uc0ac\uc774\ud2b8\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]),!1;this.layer=e.goPopup({header:l["\uc804\uc0ac \uc790\uc0b0 \uacf5\uc720 \uc124\uc815"],pclass:"layer_normal layer_system_board layer_share",width:800,modal:!1,allowPrevPopup:!1,forceClosePopup:!1,buttons:[{btext:f["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:e.proxy(this.saveShareAsset,this)},{btext:f["\ucde8\uc18c"]}],contents:""});var r={companies:this.companies,shares:this.shares,layer:this.layer};n&&(r.toSelectCompanyId=n.companyId,r.toSelectAssetId=n.assetId),this.assetCompanyShareLayer=null,this.assetCompanyShareLayer=new u(r),this.assetCompanyShareLayer.render()},popShareLayerByTitleClick:function(t){var n=e(t.currentTarget).closest("tr").find("input:checkbox").attr("data-assetcompanyid"),r=e(t.currentTarget).closest("tr").find("input:checkbox").attr("data-assetid");this.popShareLayer(t,{companyId:n,assetId:r})},checkedAll:function(t){this.$el.find("#tableBorderList tbody input:checkbox").prop("checked",e(t.currentTarget).is(":checked"))},onDelete:function(){var t=this,n=this.$el.find("#tableBorderList tbody input:checkbox:checked");if(n.length<1)return e.goError(f["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;var r=[],i=t.shares.toJSON();e(n).each(function(t,n){var s=_.findWhere(i,{id:parseInt(e(n).val())});r.push(s)});var s=GO.contextRoot+"ad/api/system/companygroup/"+this.companyGroupId+"/asset/shares";e.ajax(s,{type:"DELETE",contentType:"application/json",data:JSON.stringify(r),success:function(){e.goMessage(f["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.render("ACTIVE")},error:function(t){e.goError(f["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}})},saveShareAsset:function(){var t=this,n=this.assetCompanyShareLayer.getData();if(!this.validateData(n))return!1;var r=new s(this.companyGroupId);r.set(n),r.save({},{type:"POST",success:function(n,r){e.goMessage(f["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.render("ACTIVE"),t.layer&&t.layer.close()},error:function(t,n){var r=JSON.parse(n.responseText);e.goMessage(r.message)},complete:e.proxy(function(){},this)})},validateData:function(t){return t.id?!0:(e.goError(f["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1)},_getCheckedBoardIds:function(){var t=[];return this.$("input:checkbox[name=board_id]:checked").each(function(n,r){t.push(e(r).val())}),t},_convertBoardsAction:function(e){return e.map(function(e){e.isBoardNode()&&e.set("actions",{managable:!0})}),e},_onClickCheckAll:function(t){this.$("input:checkbox[name=board_id]").attr("checked",e(t.currentTarget).is(":checked"))},_onClickBoardDelete:function(t){var n=this._getCheckedBoardIds(),r=this;t.preventDefault();if(y===!0){e.goSlideMessage(f["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(n.length==0){e.goMessage(m.not_selected_board);return}e.goConfirm(m.delete_title,m.delete_confirm,function(){e.ajax({type:"DELETE",async:!0,data:JSON.stringify({ids:n}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/board/status/deleted"}).done(function(t){e.goMessage(m.delete_success),r.render(r.type)}).complete(function(){y=!1})})},checkAllToggle:function(t){var n=e(t.currentTarget);n.is(":checked")?this.$el.find("#tableBorderList input:checkbox").attr("checked","checked"):this.$el.find("#tableBorderList input:checkbox").attr("checked",null)}},{create:function(e){return g=new b({companyGroupId:e.companyGroupId,companies:e.companies}),g.render(e.status)}});return{render:function(e){var t=b.create(e);return t}}});