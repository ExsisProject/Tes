define(["jquery","underscore","backbone","when","app","system/views/system_board_circle","admin/collections/asset_share_list","board/constants","board/components/board_tree/board_tree","system/collections/companies","hgn!system/templates/asset_company_share_layer","hgn!system/templates/asset_list","i18n!nls/commons","i18n!admin/nls/admin","i18n!approval/nls/approval","i18n!works/nls/works"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m={save:h["\uc800\uc7a5"],cancel:h["\ucde8\uc18c"],share_range:p["\uacf5\uac1c \ubc94\uc704"],share_public:p["\uacf5\uac1c"],share_private:h["\ube44\uacf5\uac1c"],no_data:v["\ub370\uc774\ud130\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]},g=n.View.extend({initialize:function(e){this.options=e||{},this.collection=this.options.collection,t.isFunction(this.onClickAssetNodeCallBack)&&(this.onClickAssetNodeCallBack=e.onClickAssetNodeCallBack)},events:{"click .board_name":"_onClickAssetNode"},_onClickAssetNode:function(t){console.debug("[asset] _onClickAssetNode call"),t.stopImmediatePropagation();var n=e(t.currentTarget),r=n.data("asset-id"),i=n.closest("li");this.onClickAssetNodeCallBack(this,t,r)},render:function(){this.$el.html(c({dataSet:this.collection.toJSON(),isEmpty:this.collection.length<1,lang:m}))},onClickAssetNodeCallBack:function(){console.log("\uc544\ubb34\ub7f0 callBack\ud568\uc218\uac00 \uc5c6\uc74c")}}),y=n.View.extend({el:".layer_system_board .content",events:{"click input[name=share]:radio":"onClickShareRadio","change select#asset-company-list":"onChangeCompanyList"},initialize:function(e){this.options=e||{},this.companies=e.companies||new f,this.layer=e.layer,this.shareBoardList=e.shares,this.toSelectCompanyId=e.toSelectCompanyId,this.toSelectAssetId=e.toSelectAssetId,this.companies.each(function(e){e.set("selected",!1)},this),this.toSelectCompanyId?this.companies.each(function(e){e["id"]==this.toSelectCompanyId&&e.set("selected",!0)},this):this.companies.length>0&&this.companies.first().set("selected",!0),this.assetList=new o,this.assetList.setCompanyId(this.getSelectedCompanyId()),this.listenTo(this.assetList,"sync",this._renderAssetList),this.assetListView=null},getSelectedCompanyId:function(){return this.companies.findWhere({selected:!0}).get("id")},getSelectedBoardId:function(){return this.selectedBoardId?this.selectedBoardId:!1},render:function(){var e=this,t=this.assetList,n={};this.initRender(),this._fetchAndRenderAssetList()},onClickShareRadio:function(e){var t=this.$el.find("input[name=share]:radio:checked").val();t=="public"?(this.circleView.nodePickerView.$el.hide(),this.circleView.companyListView.$el.find('span[data-type="add"]').show(),this.circleView.companyListView.$el.find("#publicWritableAuthWrap").show()):(this.circleView.nodePickerView.$el.show(),this.circleView.companyListView.$el.find('span[data-type="add"]').hide(),this.circleView.companyListView.$el.find("#publicWritableAuthWrap").hide())},getData:function(){var e=this.circleView.getData(),n=[],r=e.nodes||[];t.each(r,function(e){e.actions=t.isArray(e.actions)?e.actions.join(","):e.actions,e.nodeCompanyId=parseInt(e.nodeCompanyId)},this);var i=t.uniq(t.pluck(r,"nodeCompanyId"));t.each(i,function(e){var i={};i.companyId=e,i.nodes=t.where(r,{nodeCompanyId:e}),n.push(i)},this);var s={shares:n,id:this.getSelectedBoardId()};return s},onChangeCompanyList:function(t){var n=e(t.currentTarget).find("option:selected").val();this.companies.each(function(e){e.get("id")==n?e.set("selected",!0):e.set("selected",!1)},this),this.assetList.setCompanyId(n),this._fetchAndRenderAssetList()},initRender:function(){this.$el.html(l({companies:this.companies.toJSON(),lang:m})),this.initCircleView()},initCircleView:function(t){this.circleView=null,this.$("#partPublicWrap").empty();var n=function(e){};this.circleView=new s({selector:"#partPublicWrap",isAdmin:!0,useAction:!1,circleJSON:{nodes:t?t:[]},withCompanies:!0,nodeTypes:["user","department","position","grade","duty","usergroup"],addCallback:e.proxy(n,this),companyIds:this.companies.pluck("id"),noSubDept:!1}),this.circleView.render(),this.$el.find("input[name=share]:radio:checked").trigger("click")},_fetchAndRenderAssetList:function(){var e=this,t=this.assetList;t.fetch({silent:!0,success:function(e){}})},_renderAssetList:function(){var e=this.$el.find(".no-list-msg"),t=this.assetList;this.assetListView!==null&&(this.assetListView.$el.empty(),this.assetListView=null),this.assetListView=this._createAssetListView(t),t.length>0?this.toSelectAssetId?(this.assetListView.$el.find('span.board_name[data-asset-id="'+this.toSelectAssetId+'"]').trigger("click"),this.toSelectAssetId=null):this.assetListView.$el.find("span.board_name").eq(0).trigger("click"):(this.selectedBoardId=!1,this.circleView.hideOrgSlide(),this.initCircleView([])),this.layer.reoffset()},_createAssetListView:function(t){var n,r={};return t instanceof o&&(r.collection=t),r.onClickAssetNodeCallBack=e.proxy(this.onClickAssetNodeCallBack,this),n=new g(r),n.setElement(this.$el.find("#asset-tree-config")),n.render(),n},onClickAssetNodeCallBack:function(n,r,i){console.log("onClickAssetNodeCallBack call"),this.assetListView.$el.find("div.item").removeClass("on");var s=e(r.currentTarget).closest("div.item").addClass("on");this.selectedCompanyId=this.getSelectedCompanyId(),this.selectedBoardId=i,this.circleView.hideOrgSlide();var o=[];this.shareBoardList.each(function(e){e.get("id")==this.selectedBoardId&&t.each(e.get("shares"),function(e){t.each(e.nodes,function(e){e.nodeType==="company"&&(e.nodeValue=""),o.push(e)})})},this),this.initCircleView(o)}});return y});