define(["jquery","backbone","when","app","i18n!nls/commons","i18n!admin/nls/admin","hgn!system/templates/apns_manager","hgn!system/templates/attaches_file","hgn!system/templates/attaches","file_upload","jquery.go-sdk","jquery.go-popup","jquery.go-grid","jquery.ui","GO.util","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f){var l={label_ok:i["\uc800\uc7a5"],label_cancel:i["\ucde8\uc18c"],label_desc:s["APNS \uc778\uc99d\uc11c \uad00\ub9ac"],label_apns_add:s["APNS \uc778\uc99d\uc11c \ub4f1\ub85d"],label_apns_path:s["APNS \uc778\uc99d\uc11c \uacbd\ub85c"],label_apns_password:s["APNS \uc778\uc99d\uc11c \ube44\ubc00\ubc88\ud638"],label_apns_type:s["APNS \uc778\uc99d\uc11c \uc11c\ube44\uc2a4 \ud0c0\uc785"],label_file:s["\ud30c\uc77c \ucc3e\uae30"]},c=null,h=t.View.extend({el:"#layoutContent",initialize:function(){this.$el.off(),this.$el.empty(),this.listEl="#apnsManager",this.dataTable=null,this.unbindEvent(),this.bindEvent()},unbindEvent:function(){this.$el.off("click","span#btn_ok"),this.$el.off("click","span#btn_cancel")},bindEvent:function(){this.$el.on("click","span#btn_ok",e.proxy(this.addApnsCertificate,this)),this.$el.on("click","span#btn_cancel",e.proxy(this.cancelApnsCertificate,this))},render:function(){e("#mobilty").addClass("on"),e(".breadcrumb .path").html(s["\ubaa8\ube4c\ub9ac\ud2f0"]+" > "+s["APNS \uc778\uc99d\uc11c \uad00\ub9ac"]),this.$el.empty(),this.$el.html(o({lang:l})),this.initSWFUpload(),this.renderApnsManager()},renderApnsManager:function(){this._getApnsInfo()},initSWFUpload:function(){var t=this,n=l.label_file;options={el:"#swfupload-control",context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+n+"</span>",url:"ad/api/system/file?GOAdminSSOcookie="+e.cookie("GOAdminSSOcookie")},(new f(options)).queue(function(e,t){}).start(function(t,n){e(".file_wrap").empty()}).progress(function(e,t){}).success(function(t,n,r){if(GO.util.fileUploadErrorCheck(n))return e.goAlert(GO.util.serverMessage(n)),!1;var i=n.data,o=i.fileName,a=i.filePath,f=i.hostId,l=i.fileExt.toLowerCase(),c=new RegExp("(p12)","gi"),h=c.test(l);h?(e(".file_wrap").html(u({dataset:i,name:o,linkInfo:!1})),e("#fileName").attr("data-tempname",a),e("#fileName").attr("data-name",o),e("#fileName").attr("host-id",f),e("#apnsPassword").val("1q2w3e4r"),e("#apnsTypeProduction").attr("checked",!0)):e.goMessage(s["APNS \ud655\uc7a5\uc790\uacbd\uace0"])}).complete(function(e,t){console.info(t)}).error(function(e,t){console.info(t)})},_getApnsInfo:function(){return n.promise(function(t,n){var r=GO.config("contextRoot")+"ad/api/system/apnsinfo";e.ajax(r,{type:"GET",success:function(t){if(t.code=="200")if(t.data.apnsPath!=null){e(".file_wrap").empty();var n="<br>"+t.data.apnsPath.split("/").pop()+"</br>";e(".file_wrap").append(n),e("#apnsPassword").val(t.data.apnsPassword),t.data.apnsType=="sandbox"?e("#apnsTypeSendbox").attr("checked",!0):e("#apnsTypeProduction").attr("checked",!0)}else{var n="<br>"+s["\ub4f1\ub85d\ub41c \uc124\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]+"</br>";e(".file_wrap").append(n)}else{var n="<br>"+s["\ub4f1\ub85d\ub41c \uc124\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]+"</br>";e(".file_wrap").append(n)}},error:function(t){var r=JSON.parse(t.responseText);e.goMessage(r.message),n()}})})},addApnsCertificate:function(t){t.stopPropagation();var n=this,i=e("#apnsPassword").val(),o=e('input[name="apnsType"]:radio:checked').val(),u={};if(e("#fileName").attr("data-name")==null){e.goMessage(s["\uc218\uc815\ub41c \uac12\uc774 \uc5c6\uac70\ub098 \uc785\ub825\uac12\uc774 \uc798\ubabb \ub418\uc5c8\uc2b5\ub2c8\ub2e4"]);return}u.name=e("#fileName").attr("data-name"),u.path=e("#fileName").attr("data-tempname"),u.hostId=e("#fileName").attr("host-id");if(i.length==0||i==null){e.goMessage(s["APNS \uc778\uc99d\uc11c \ube44\ubc00\ubc88\ud638\ub97c \uc785\ub825\ud558\uc138\uc694"]);return}GO.EventEmitter.trigger("common","layout:setOverlay","");var a=GO.contextRoot+"ad/api/system/apnscert",f={apnsPassword:i,apnsType:o,apnsAttach:u.path==null&&u.name==null?null:u};e.go(a,JSON.stringify(f),{qryType:"POST",contentType:"application/json",responseFn:function(e){e.code==200&&r.router.navigate("system/apns",!0),n.initialize(),n.render(),GO.EventEmitter.trigger("common","layout:clearOverlay",!0)},error:function(t){var r=JSON.parse(t.responseText);e.goMessage(r.message),n.initialize(),n.render(),GO.EventEmitter.trigger("common","layout:clearOverlay",!0)}})},cancelApnsCertificate:function(){this.initialize(),this.render()}},{create:function(){return c=new h({el:"#layoutContent"}),c.render()}});return{render:function(){var e=h.create();return e}}});