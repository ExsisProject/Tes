define(function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("admin/collections/company_board"),s=require("system/models/board_share_model"),o=require("system/collections/company_borad_shares"),u=require("system/views/board_company_share_layer"),a=require("board/components/board_tree/board_tree"),f=require("board/models/company_board_tree_node"),l=require("board/constants"),c=require("hgn!system/templates/board_company_share"),h=require("system/collections/companies"),p=require("i18n!nls/commons"),d=require("i18n!admin/nls/admin"),v=require("i18n!board/nls/board"),m=require("i18n!works/nls/works");require("jquery.go-sdk"),require("GO.util"),require("jquery.go-popup");var g={company_board_add:p["\ucd94\uac00"],board_save:p["\uc800\uc7a5"],board_cancel:p["\ucde8\uc18c"],board_modify:p["\uc218\uc815"],board_delete:p["\uc0ad\uc81c"],board_stop:p["\uc911\uc9c0"],board_normal:p["\uc815\uc0c1 \uc0c1\ud0dc\ub85c \ubcc0\uacbd"],board_exposure:d["\uac8c\uc2dc\ud310 \ud648 \ub178\ucd9c"],closed_board:d["\uc911\uc9c0\ub41c \uac8c\uc2dc\ud310"],not_selected_board:v["\uac8c\uc2dc\ud310\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],stop_confirm:v["\uac8c\uc2dc\ud310 \uc911\uc9c0 \ud655\uc778"],stop_board:v["\uac8c\uc2dc\ud310 \uc911\uc9c0"],delete_confirm:v["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],delete_title:v["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],delete_success:p["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],board_title:d["\uc804\uc0ac \uac8c\uc2dc\ud310 \uba85"],share_site:d["\uacf5\uc720\ub41c \uc0ac\uc774\ud2b8"],board_no_list:m["\ub370\uc774\ud130\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]},y=null,b=!1,w=t.View.extend({el:"#companyGroupShareContent",events:{'click span[data-btntype="add"]':"popShareLayer",'click span[data-btntype="delete"]':"onDelete","click #checkedShareAll":"checkedAll","click td.b_name span":"popShareLayerByTitleClick"},initialize:function(e){this.options=e||{},this.companyGroupId=this.options.companyGroupId,this.companies=this.options.companies||new h,this.shares=new o(this.companyGroupId)},render:function(e){var t=this;console.log("[board] BoardCompanyShareView:render call"),this.shares.fetch({success:function(){return t._initRender(e),t}})},_initRender:function(e){if(e===l.STATUS_ACTIVE){var t=c({isActive:!0,lang:g,isActiveBoard:!0,dataset:this.makeTemplateData(this.shares.toJSON())});this.$el.html(t)}},makeTemplateData:function(e){var t=this;return _.map(e,function(e){var n=e.share||{},r=[];return _.each(e.shares,function(e){_.each(e.nodes,function(e){r.push({name:e.nodeValue,companyName:e.nodeCompanyName,action:t.getActionName(e.actions)})})}),{id:e.id,share:n,companyId:e.companyId,boardName:e.companyName+" > "+e.name,sharedTargets:r}})},getActionName:function(e){var t={READABLE:"read",WRITABLE:"write",REMOVABLE:"remove",MANAGABLE:"manage"},n=[];return e.indexOf(t.READABLE)>=0&&n.push(d["\uc77d\uae30"]),e.indexOf(t.WRITABLE)>=0&&n.push(d["\uc4f0\uae30"]),n.join("/")},popShareLayer:function(t,n){if(this.companies.length<1)return e.goMessage(d["1\uac1c \uc774\uc0c1\uc758 \ub9e4\uce6d \uc0ac\uc774\ud2b8\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]),!1;this.layer=e.goPopup({header:d["\uc804\uc0ac \uac8c\uc2dc\ud310 \uacf5\uc720 \uc124\uc815"],pclass:"layer_normal layer_system_board layer_share",width:800,modal:!1,allowPrevPopup:!1,forceClosePopup:!1,buttons:[{btext:p["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:e.proxy(this.saveShareBoard,this)},{btext:p["\ucde8\uc18c"]}],contents:""});var r={companies:this.companies,shares:this.shares,layer:this.layer};n&&(r.toSelectCompanyId=n.companyId,r.toSelectBoardId=n.boardId),this.boardCompanyShareLayer=null,this.boardCompanyShareLayer=new u(r),this.boardCompanyShareLayer.render()},popShareLayerByTitleClick:function(t){var n=e(t.currentTarget).closest("tr").find("input:checkbox").attr("data-boardcompanyid"),r=e(t.currentTarget).closest("tr").find("input:checkbox").attr("data-boardid");this.popShareLayer(t,{companyId:n,boardId:r})},checkedAll:function(t){this.$el.find("#tableBorderList tbody input:checkbox").prop("checked",e(t.currentTarget).is(":checked"))},onDelete:function(t){var n=this,r=this.$el.find("#tableBorderList tbody input:checkbox:checked");if(r.length<1)return e.goError(p["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;var i=[],s=n.shares.toJSON();e(r).each(function(t,n){var r=_.findWhere(s,{id:parseInt(e(n).val())});i.push(r)});var o=GO.contextRoot+"ad/api/system/companygroup/"+this.companyGroupId+"/board/shares";e.ajax(o,{type:"DELETE",contentType:"application/json",data:JSON.stringify(i),success:function(){e.goMessage(p["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.render("ACTIVE")},error:function(t){e.goError(p["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}})},saveShareBoard:function(){var t=this,n=this.boardCompanyShareLayer.getData();if(!this.validateData(n))return!1;var r=new s(this.companyGroupId);r.set(n),r.save({},{type:"POST",success:function(n,r){e.goMessage(p["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.render("ACTIVE"),t.layer&&t.layer.close()},error:function(t,n){var r=JSON.parse(n.responseText);e.goMessage(r.message)},complete:e.proxy(function(){},this)})},validateData:function(t){return t.id?!0:(e.goError(p["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1)},_renderClosedBoardList:function(e){var t=this,n=function(){return this.type=="CLASSIC"?g.board_BBS:g.board_STREAM},r=function(){return GO.util.basicDate(this.createdAt)},i=function(){return this.sharedFlag?g.board_private:g.board_public},s=this.closedBoardList.toJSON(),o=TplCompanyBoard({dataset:s,bbsType:n,parseDate:r,sharedRange:i,isActive:!1,lang:g,isActiveBoard:!1});this.$el.html(o),this.listEl=this.$el.find("#tableBorderList"),this.$el.find("#tableBorderList tr:last-child").addClass("last")},_fetchAndRenderClosedBoardList:function(){var e=this,t=this.closedBoardList;return n.promise(function(e,n){t.fetch({silent:!0,success:function(t){e(t)},error:n})}).otherwise(function(e){console.log(e.stack)})},_renderActiveBoardList:function(){var e,t=this.$el.find(".no-list-msg"),n=this.activeBoardList;return this._getBoardTreeConfigView(n)},_fetchAndRenderActiveBoardList:function(){var e=this,t=this.activeBoardList;return n.promise(function(e,n){t.fetch({silent:!0,success:function(t){e(t)},error:n})}).otherwise(function(e){console.log(e)})},_getCheckedBoardIds:function(){var t=[];return this.$("input:checkbox[name=board_id]:checked").each(function(n,r){t.push(e(r).val())}),t},_createBoardTreeConfigView:function(e){var t,n={};return e instanceof f.Collection&&(n.nodes=this._convertBoardsAction(e)),t=new a.BoardTreeSimpleView(n),t.setElement(this.$el.find("#board-tree-config")),t.render(),t},_getBoardTreeConfigView:function(e){return this.boardTreeConfigView===null&&(this.boardTreeConfigView=this._createBoardTreeConfigView(e)),this.boardTreeConfigView},_convertBoardsAction:function(e){return e.map(function(e){e.isBoardNode()&&e.set("actions",{managable:!0})}),e},_addFolder:function(){var e=this._getBoardTreeConfigView(this.activeBoardList);e.addNode(new f.Model({nodeType:l.NODETYPE_FOLDER,nodeValue:v["\uc0c8\ub85c\uc6b4 \uadf8\ub8f9\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]},{isAdminService:!0}))},_addSeperator:function(){var e=this._getBoardTreeConfigView(this.activeBoardList);e.addNode(new f.Model({nodeType:l.NODETYPE_SEPERATOR,nodeValue:v["\uc0c8\ub85c\uc6b4 \uad6c\ubd84\uc120\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]},{isAdminService:!0}))},_onClickCheckAll:function(t){this.$("input:checkbox[name=board_id]").attr("checked",e(t.currentTarget).is(":checked"))},_onClickToggleNodes:function(t){var n=e(t.currentTarget),r=n.attr("data-state");t.preventDefault();if(this.boardTreeConfigView===null)return;r==="opened"?(this.boardTreeConfigView.foldAllNodes(),n.attr("data-state","closed"),n.text(g.open_all)):(this.boardTreeConfigView.unfoldAllNodes(),n.attr("data-state","opened"),n.text(g.close_all))},_onClickSortableToggle:function(t){var n=this,r=e(t.currentTarget);t.preventDefault(),this._isSortableMode()?this._distroyNodeSortable():this._enableNodeSortable()},_enableNodeSortable:function(){if(!this.boardTreeConfigView)return;e(".btnBoardAdd").hide(),e(".btnBoardGroupAdd").hide(),e(".btnBoardLineAdd").hide(),e(".btnBoardStop").hide(),e(".btnBoardDelete").hide(),this.boardTreeConfigView.enableSortable(),this.$(".tb-header").addClass("tb_stair_edit"),this._changeSortButtonText(g.board_sort_done)},_distroyNodeSortable:function(){if(!this.boardTreeConfigView)return;e(".btnBoardAdd").show(),e(".btnBoardGroupAdd").show(),e(".btnBoardLineAdd").show(),e(".btnBoardStop").show(),e(".btnBoardDelete").show(),this.boardTreeConfigView.destroySortable(),this.$(".tb-header").removeClass("tb_stair_edit"),this._changeSortButtonText(g.board_sort)},_isSortableMode:function(){return this.$("#board-tree-config").hasClass("tb_stair_edit")},_changeSortButtonText:function(t){e(".btnBoardSortable").html(t)},_onClickBoardStop:function(t){var n=this._getCheckedBoardIds(),r=this;t.preventDefault();if(b===!0){e.goSlideMessage(p["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(n.length==0){e.goMessage(g.not_selected_board);return}e.goConfirm(g.stop_board,g.stop_confirm,function(){e.ajax({type:"PUT",async:!0,data:JSON.stringify({ids:n}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/board/status/closed"}).done(function(t){e.goMessage(g.change_success),r.render(r.type)}).complete(function(){b=!1})})},_onClickBoardDelete:function(t){var n=this._getCheckedBoardIds(),r=this;t.preventDefault();if(b===!0){e.goSlideMessage(p["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(n.length==0){e.goMessage(g.not_selected_board);return}e.goConfirm(g.delete_title,g.delete_confirm,function(){e.ajax({type:"DELETE",async:!0,data:JSON.stringify({ids:n}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/board/status/deleted"}).done(function(t){e.goMessage(g.delete_success),r.render(r.type)}).complete(function(){b=!1})})},checkAllToggle:function(t){var n=e(t.currentTarget);n.is(":checked")?this.$el.find("#tableBorderList input:checkbox").attr("checked","checked"):this.$el.find("#tableBorderList input:checkbox").attr("checked",null)},changeStatusNormal:function(){var t=this._getCheckedBoardIds(),n=this;if(t.length==0){e.goMessage(g.not_selected_board);return}e.goConfirm(g.change_status_normal,g.normal_confirm,function(){e.ajax({type:"PUT",async:!0,data:JSON.stringify({ids:t}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/board/status/active"}).done(function(t){e.goMessage(g.change_success),n.render(n.type)})})},changeTab:function(t){t.stopImmediatePropagation();var n=e(t.currentTarget),r=n.attr("data-type");this.render(r)},bindListSortable:function(e){this.$el.find(".btnBoardLineAdd").hide(),this.$el.find(".btnBoardSortable").hide(),this.$el.find(".btnBoardAdd").hide(),this.$el.find(".btnBoardSortDone").show(),this.listEl.find("tbody").removeClass().sortable({opacity:"1",delay:100,cursor:"move",items:"tr",containment:".admin_content",hoverClass:"ui-state-hover",placeholder:"ui-sortable-placeholder",start:function(e,t){t.placeholder.html(t.helper.html()),t.placeholder.find("td").css("padding","5px 10px")}})},bbsCreate:function(){r.router.navigate("/board/create",!0)},bbsModify:function(t){if(e(t.currentTarget).parents("tbody:eq(0)").hasClass("ui-sortable"))return e.goMessage(d["\uc21c\uc11c \ubc14\uafb8\uae30 \uc644\ub8cc\ud6c4 \uc124\uc815"]),!1;var n=e(t.currentTarget).attr("data-boardId");r.router.navigate("/board/"+n+"/modify",!0)}},{create:function(e){return y=new w({companyGroupId:e.companyGroupId,companies:e.companies}),y.render(e.status)},remove:function(){}});return{render:function(e){var t=w.create(e);return t}}});