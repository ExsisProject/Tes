define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("system/models/laboratory/feedback_config"),i=require("file_upload"),s=require("hgn!system/templates/laboratory/feedback/config"),o=require("i18n!admin/nls/admin"),u=require("i18n!nls/commons");require("jquery.go-preloader"),require("attach_file"),require("GO.util");var a={save:u["\uc800\uc7a5"],cancel:u["\ucde8\uc18c"],file_ext_error:u["\ud655\uc7a5\uc790\uac00 {{arg1}}\uc778 \uac83\ub9cc \ucca8\ubd80\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."]};return t.View.extend({events:{"click #save":"save","click #cancel":"cancel","click input:checkbox":"_toggleUseConfigCheckbox","click span.ic_del":"_clickDeleteAttack"},initialize:function(){var t=this;e(".breadcrumb .path").html("\uc2e4\ud5d8\uc2e4 \ud53c\ub4dc\ubc31 \uc124\uc815"),n.useLabFeedback||(e.goMessage("\uc0ac\uc6a9\uc774 \ubd88\uac00\ub2a5\ud55c \uc11c\ube44\uc2a4\uc785\ub2c8\ub2e4."),this.cancel()),this.isCreate=this.options.feedbackConfigId===undefined,this.model=new r,this.isCreate?this.model.setData():(this.model.set({id:this.options.feedbackConfigId}),this.model.fetch({async:!1}).done(function(){t.model.setOldUseConfig(t.model.get("useConfig"))}))},render:function(){this._initContent(),this._initDatepicker(),this._initFileUpload("file-control-simple","fileCompleteSimple"),this._initFileUpload("file-control-content","fileCompleteContent")},save:function(){var t=e.goPreloader();t.render(),this._setData();if(!this._validate())return t.release(),!1;this.model.save(null,{success:function(){t.release();var r="system/extension/laboratory/feedback/configs";n.router.navigate(r,{trigger:!0}),e.goMessage("\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4.")},error:function(n,r){t.release(),r.message?e.goAlert(r.message):e.goMessage(u["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}})},cancel:function(){n.router.navigate("system/extension/laboratory/feedback/configs",{trigger:!0})},_initContent:function(){this.$el.html(s({lang:a,data:e.extend({},this.model.toJSON(),{id:this.model.get("id"),usgConfig:this.model.get("useConfig"),startDate:this.model.getDisplayStartDate(),endDate:this.model.getDisplayEndDate()})}));if(!this.isCreate){var t=this.model.get("simpleImg"),n=this.model.get("contentImg");if(!_.isUndefined(t)){var r=this._initImgContent(this.model.id,t);this.$el.find("#fileCompleteSimple").html(r)}if(!_.isUndefined(n)){var i=this._initImgContent(this.model.id,n);this.$el.find("#fileCompleteContent").html(i)}}},_initImgContent:function(e,t){return'<li data-config-id="'+e+'" data-id="'+t.id+'" data-name="'+t.name+'" data-size="'+t.size+'">'+'<span class="item_image">'+'<span class="thumb">'+'<a class="fancybox-button">'+'<img src="'+t.thumbSmall+'">'+"</a>"+"</span>"+'<span class="btn_wrap" title="\uc0ad\uc81c">'+'<span class="ic_classic ic_del"></span>'+"</span>"+"</span>"+"</li>"},_initFileUpload:function(t,r){var s=this,o={el:"#"+t,context_root:n.contextRoot,button_text:"<span class='buttonText'>\ud30c\uc77c\ucca8\ubd80</span>",url:"ad/api/file?GOAdminSSOcookie="+e.cookie("GOAdminSSOcookie")};(new i(o)).queue(function(e,t){}).start(function(t,i){var o=s.$el.find("#"+r+" > li").size();if(o>0)return e.goMessage("\uc774\ubbf8\uc9c0 \ud30c\uc77c\uc740 \ud55c\uac1c\ub9cc \uc5c5\ub85c\ub4dc \uac00\ub2a5\ud569\ub2c8\ub2e4."),!1;var u=new RegExp("png|jpg|jpeg|gif|bmp","gi");if(!u.test(i.name))return e.goMessage(n.i18n(a.file_ext_error,{arg1:"\uc774\ubbf8\uc9c0 \ud30c\uc77c\ub9cc \uac00\ub2a5 \ud569\ub2c8\ub2e4(png, jpg, jpeg, gif, bmp)"})),!1}).progress(function(e,t){}).success(function(t,i,o){if(n.util.fileUploadErrorCheck(i))o.find(".item_file").append("<strong class='caution'>"+n.util.serverMessage(i)+"</strong>"),o.addClass("attachError");else if(n.util.isFileSizeZero(i))return e.goAlert(n.util.serverMessage(i)),!1;o.attr("data-hostId",i.data.hostId),o.attr("data-file-size",i.data.fileSize),s.$el.find("#"+r).html(o)}).complete(function(e,t){}).error(function(e,t){})},_initDatepicker:function(){var t=e("#startDate"),r=e("#endDate");e.datepicker.setDefaults(e.datepicker.regional[n.config("locale")]),t.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",minDate:n.util.customDate(new Date,"YYYY-MM-DD"),onSelect:function(e){r.datepicker("option","minDate",e)}}),r.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",minDate:this.model.getDisplayStartDate()})},_setData:function(){var t=e("#fileCompleteSimple > li"),n=e("#fileCompleteContent > li");this.model.set({title:this.$el.find("#title").val().trim(),appliedVersion:this.$el.find("#appliedVersion").val(),startDate:this.model.convertToSaveDate(this.$el.find("#startDate").val(),"00","00"),endDate:this.model.convertToSaveDate(this.$el.find("#endDate").val(),"23","59"),useConfig:e("#usgConfig").is(":checked"),simpleTitle:this.$el.find("#simpleTitle").val().trim(),simpleDesc:this.$el.find("#simpleDesc").val().trim(),simpleImg:{id:t.attr("data-id")||null,path:t.attr("data-id")?"":t.attr("data-path"),name:t.attr("data-name"),hostId:t.attr("data-hostId"),size:t.attr("data-size")},contentImg:{id:n.attr("data-id")||null,path:n.attr("data-id")?"":n.attr("data-path"),name:n.attr("data-name"),hostId:n.attr("data-hostId"),size:n.attr("data-size")}})},_toggleUseConfigCheckbox:function(t){e(t.currentTarget).is(":checked")?(e(t.currentTarget).attr("checked",!0),e("label[for=usgConfig]").text("\uc0ac\uc6a9\uc911")):(this.$el.find("#checkedAll").attr("checked",!1),e(t.currentTarget).attr("checked",!1),e("label[for=usgConfig]").text("\uc0ac\uc6a9\ud574\uc81c"))},_clickDeleteAttack:function(t){console.log("system feedback form _clickDeleteAttack"),e(t.target).parents("li").first().remove()},_validate:function(){if(!e.goValidation.isCheckLength(0,20,this.model.get("title")))return this.$el.find("#title_validation").show(),this.$el.find("#title").focus(),!1;this.$el.find("#title_validation").hide();var t=/\d+.\d+.\d+.\d+/;if(!t.test(this.model.get("appliedVersion")))return e.goMessage("\ud3ec\ub9f7\uc5d0 \ub9de\uac8c \uc785\ub825\ud574\uc8fc\uc138\uc694. ex) 3.5.0.0"),this.$el.find("#appliedVersion").focus(),!1;if(!e.goValidation.isCheckLength(1,20,this.model.get("simpleTitle")))return e.goMessage("1\uc790 \uc774\uc0c1 20\uc790 \uc774\ud558\ub85c \uc785\ub825\ud574\uc8fc\uc138\uc694."),this.$el.find("#simpleTitle").focus(),!1;if(!e.goValidation.isCheckLength(1,128,this.model.get("simpleDesc")))return e.goMessage("1\uc790 \uc774\uc0c1 128\uc790 \uc774\ud558\ub85c \uc785\ub825\ud574\uc8fc\uc138\uc694."),this.$el.find("#simpleDesc").focus(),!1;var n=this.$el.find("#fileCompleteSimple > li").size();if(n<1)return e.goMessage("\ud31d\uc5c5 \uc2ec\ud50c \uc774\ubbf8\uc9c0 \ud30c\uc77c\uc740 \ubc18\ub4dc\uc2dc \ud55c\uac1c\ub97c \ucca8\ubd80\ud574\uc57c\ud569\ub2c8\ub2e4."),!1;var r=this.$el.find("#fileCompleteContent > li").size();return r<1?(e.goMessage("\uc0c1\uc138\ud398\uc774\uc9c0 \ubcf8\ubb38 \uc774\ubbf8\uc9c0 \ud30c\uc77c\uc740 \ubc18\ub4dc\uc2dc \ud55c\uac1c\ub97c \ucca8\ubd80\ud574\uc57c\ud569\ub2c8\ub2e4."),!1):!0}},{__instance__:null})});