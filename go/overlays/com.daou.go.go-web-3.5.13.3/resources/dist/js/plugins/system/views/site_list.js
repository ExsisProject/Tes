(function(){define(["jquery","backbone","app","hgn!system/templates/site_list","hgn!system/templates/list_empty","system/models/licenseModel","system/models/site_control_option","i18n!nls/commons","i18n!admin/nls/admin","jquery.go-grid","jquery.go-sdk","GO.util","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a){var f={label_add:u["\ucd94\uac00"],label_delete:u["\uc0ad\uc81c"],label_company_name:a["\uc0ac\uc774\ud2b8\uba85"],label_domain_name:a["\ub3c4\uba54\uc778\uba85"],label_user_count:a["\ucd1d \uacc4\uc815\uc218"],label_service:a["\uc0ac\uc774\ud2b8 \uad00\ub9ac"],label_confirm_delete:a["\uc0ad\uc81c\ud558\uc2dc\uac8c\uc2b5\ub2c8\uae4c?"],label_check_delete_item:a["\uc0ad\uc81c\ud560 \ud56d\ubaa9\uc744 \uc120\ud0dd\ud558\uc138\uc694."],label_move_service:a["\uc0ac\uc774\ud2b8\ub85c \uc774\ub3d9"],label_breadcrumb:a["\uc0ac\uc774\ud2b8 \uad00\ub9ac > \uc0ac\uc774\ud2b8 \ubaa9\ub85d"],label_register_user_license:a["\uc0ac\uc6a9\uc790 \ub77c\uc774\uc120\uc2a4\ub97c \ub4f1\ub85d\ud574\uc8fc\uc138\uc694."],label_search:u["\uac80\uc0c9"],label_search_domain:a["\uc0ac\uc774\ud2b8 \uac80\uc0c9"],label_total_account_quota:a["\ucd1d \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9"],label_total_company_quota:a["\uacf5\uc6a9 \uc6a9\ub7c9"],label_limitless:a["\ubb34\uc81c\ud55c"],label_siteUrl:a["\uc811\uc18d URL"],label_move_to_membership_store:a["\uba64\ubc84\uc2ed\uc2a4\ud1a0\uc5b4\ub85c \uc774\ub3d9"],label_move_to_membership_store_desc:a["\uba64\ubc84\uc2ed\uc2a4\ud1a0\uc5b4\ub85c \uc774\ub3d9 \uc124\uba85"]},l=t.View.extend({el:"#layoutContent",initialize:function(){this.listEl="#siteList",this.licenseModel=s.read(),this.siteControlOptionModel=o.read(),this.dataTable=null,this.isSaaS=GO.session().brandName=="DO_SAAS",this.unbindEvent(),this.bindEvent()},unbindEvent:function(){this.$el.off("click","span#btn_add"),this.$el.off("click","span#btn_delete"),this.$el.off("click","span#btn_search"),this.$el.off("keydown","input#search")},bindEvent:function(){this.$el.on("click","span#btn_add",e.proxy(this.addSite,this)),this.$el.on("click","span#btn_delete",e.proxy(this.deleteSite,this)),this.$el.on("click","span#btn_search",e.proxy(this.searchSite,this)),this.$el.on("keydown","input#search",e.proxy(this.searchKeyboardEvent,this)),this.$el.on("click","span#goToMembershipStoreBtn",e.proxy(this.goToMembershipStore,this))},goToMembershipStore:function(){e("#paymentForm").remove(),e.ajax({url:GO.contextRoot+"ad/api/payment/meta",success:function(t){var n=t.data,r=e("<form action='"+n.url+"/user/sso' target='payment' method='post' id='paymentForm'>"+"   <input type='hidden' name='token' value='"+n.token+"'>"+"</form>");e("#main").append(r),window.open("about:blank","payment",""),r.submit()}})},addSite:function(){this.licenseModel.get("hasUserLicense")==0?e.goAlert(a["\uc0ac\uc6a9\uc790 \ub77c\uc774\uc120\uc2a4\ub97c \ub4f1\ub85d\ud574\uc8fc\uc138\uc694."]):this.isExceedLicenseUser()?e.goAlert(a["\ucd5c\ub300 \uc0ac\uc6a9\uc790 \uc218\ub97c \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4."]):this.isExceedLicenseUser()||n.router.navigate("system/site/create",!0)},deleteSite:function(t){var n=this,r=e("#siteList input[type=checkbox]:checked"),i=e(t.currentTarget).attr("data-defaultdomain");for(var s=0;s<r.length;s++)if(r[s].value==i){e.goAlert(a["\ub514\ud3f4\ud2b8 \ub3c4\uba54\uc778\uc740 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),e("#siteList input[type=checkbox]:checked").attr("checked",!1);return}if(r.length==0)return e.goAlert("",a["\uc0ad\uc81c\ud560 \ud56d\ubaa9\uc744 \uc120\ud0dd\ud558\uc138\uc694."]);e.goConfirm(a["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",function(){var t=GO.contextRoot+"ad/api/system/companies",i={ids:[]};for(var s=0;s<r.length;s++){if(r[s].value=="on")continue;i.ids.push(r[s].value)}if(i.ids.length==0)return;e.go(t,JSON.stringify(i),{qryType:"DELETE",contentType:"application/json",responseFn:function(){e.goMessage(u["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.render()},error:function(){e.goMessage(u["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}})})},render:function(t){e("#site").addClass("on"),e(".breadcrumb .path").html(a["\uc0ac\uc774\ud2b8 \uad00\ub9ac > \uc0ac\uc774\ud2b8 \ubaa9\ub85d"]),this.$el.empty(),this.$el.html(r({lang:f,isSaaS:this.isSaaS})),this.renderSiteList(t),e("#search").attr("value",t)},startServiece:function(e){n.router.navigate("system/site/"+e+"/modify",{trigger:!0})},renderSiteList:function(t){var r=this,s=null;this.$tableEl=this.$el.find("#siteList"),this.dataTable=e.goGrid({el:this.listEl,method:"GET",url:GO.contextRoot+"ad/api/system/companies",emptyMessage:i({label_desc:a["\ud45c\uc2dc\ud560 \ub370\uc774\ud130 \uc5c6\uc74c"]}),pageUse:!0,sDomUse:!0,checkbox:!0,sDomType:"admin",checkboxData:"id",defaultSorting:[[1,"desc"]],params:{keyword:t},displayLength:n.session("adminPageBase"),columns:[{mData:"name",sWidth:"250px",bSortable:!0,fnRender:function(e){e.aData.defaultDomain=="this"&&(s=e.aData.id);var t="";if(e.aData.companyPeriodEnd!="ulimit"){var r=n.util.getDdayDiff(e.aData.companyPeriodEnd);r<=7&&r>=0?t=" <span style='color: red;'>(D-"+r+")</span>":r<0&&(t=" <span style='color: red;'>("+a["\uc11c\ube44\uc2a4 \ub9cc\ub8cc"]+")</span>")}return"<div id='name"+e.aData.id+"'>"+e.aData.name+t+"</div>"}},{mData:"siteUrl",sWidth:"250px",bSortable:!0,fnRender:function(e){return e.aData.siteUrl}},{mData:"domainName",sWidth:"200px",bSortable:!0,fnRender:function(e){return e.aData.domainName}},{mData:"baseCompanyConfig.totalAccountQuota",sWidth:"200px",bSortable:!1,fnRender:function(e){return e.aData.baseCompanyConfig.totalAccountQuota=="0"?a["\ubb34\uc81c\ud55c"]:r.makeQuotaTmpl(e.aData.baseCompanyConfig.totalAccountQuota,e.aData.totalAccountQuota)}},{mData:"baseCompanyConfig.companyQuota",sWidth:"200px",bSortable:!1,fnRender:function(e){return e.aData.baseCompanyConfig.companyQuota=="0"?a["\ubb34\uc81c\ud55c"]:r.makeQuotaTmpl(e.aData.baseCompanyConfig.companyQuota,e.aData.companyQuota)}},{mData:"usedCount",sWidth:"150px",bSortable:!0,fnRender:function(e){return e.aData.usedCount-e.aData.stopUserCount+"/"+e.aData.userCount}},{mData:null,sWidth:"200px",bSortable:!1,fnRender:function(){return r.isSaaS?"<td></td>":"<td class='action last'><span class='btn_s'>"+a["\uc0ac\uc774\ud2b8\ub85c \uc774\ub3d9"]+"</span></td>"}}],fnDrawCallback:function(){r.$el.find(".toolbar_top .custom_header").append(r.siteControlOptionModel.isSiteControlOn()?r.$el.find("#goToMembershipStore").show():r.$el.find("#controllButtons").show()),r.$el.find(this.el+" tr>td:nth-child(2)").css("cursor","pointer").click(function(t){n.router.navigate("system/site/"+e(t.currentTarget).parent().find("input").val()+"/modify",{trigger:!0})}),r.$el.find(this.el+" tr>td:nth-child(8)").click(function(t){r.isSaaS||r.checkSession(e(t.currentTarget).parent().find("input").val())}),r.$tableEl.find('input[type="checkbox"][value="'+s+'"]').parent().parent().addClass("default"),r.$el.find("#btn_delete").attr("data-defaultdomain",s)}})},checkSession:function(t){var n=GO.contextRoot+"ad/api/system/user/session";return e.go(n,"",{qryType:"GET",async:!1,responseFn:function(){window.open(GO.contextRoot+"system/gate?companyId="+t,"SiteAdmin","")},error:function(t){var n=JSON.parse(t.responseText);e.goMessage(n.message)}}),!1},makeQuotaTmpl:function(e,t){var n=(parseInt(t)/parseInt(e)*100).toFixed(0),r=GO.util.getHumanizedFileSize(t),i=GO.util.getHumanizedFileSize(e);return r+" / "+i+" ("+n+"%)"},isExceedLicenseUser:function(){var t=!1,n=GO.contextRoot+"ad/api/system/company/userstat";return e.go(n,"",{qryType:"GET",async:!1,responseFn:function(e){e.code==200&&e.data.licenseUserCount-e.data.companiesUserCount<=0&&(t=!0)},error:function(t){var n=JSON.parse(t.responseText);e.goMessage(n.message)}}),t},searchKeyboardEvent:function(e){e.keyCode==13&&this.searchSite()},searchSite:function(){var t=e("#search").val();if(t=="")return e.goMessage(u["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."]),!1;if(!e.goValidation.isCheckLength(2,255,t))return e.goMessage(n.i18n(u["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"255"})),!1;if(!e.goValidation.charValidation("/\\/",t))return e.goMessage(a["\uc785\ub825\ud560 \uc218 \uc5c6\ub294 \ubb38\uc790"]),!1;this.render(t)}},{__instance__:null});return l})}).call(this);