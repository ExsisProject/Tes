(function(){define(["jquery","underscore","app","calendar/collections/calendars","calendar/collections/calendar_feeds","calendar/views/layouts/default","calendar/libs/util","i18n!nls/commons","i18n!calendar/nls/calendar","go-ignoreduplicatemethod","jquery.go-popup"],function(e,t,n,r,i,s,o,u,a,f){function h(){var e=[];return e.push("<span>",a["\uc77c\uc815\ubaa9\ub85d"],"</span>"),e.push('<ul id="calendar-tag-base" class="name_tag calendar_tag"></ul>'),e.join("")}function p(t){var r=e("#calendar-tag-base"),i=e("#side input[name=calendar_id]:checked");r.empty(),e(".layer_name_tag").remove();if(t){var s=t.type;s==="user"?r.append(d(t.name,"user",t.userid)):v(r,s,t.name,t.id)}else if(i.length>1){var o=n.i18n(a["\uce98\ub9b0\ub354 \ud0c0\uc774\ud2c0 \uc120\ud0dd \uce98\ub9b0\ub354 \uba54\uc2dc\uc9c0"],{count:i.length});r.append(d(o))}else i.length===1&&e("#side input[name=calendar_id]:checked").each(function(t,n){var i=e(n);v(r,i.data("type"),i.data("name"),i.data("feedid"))})}function d(e,t,n){var r=[];return t=t||"my",r.push('<li class="default_option">'),r.push('<span class="name">'),r.push(e),r.push("</span>"),r.push("</li>"),r.push('<li class="desc">'),r.push('<span class="btn_wrap">'),r.push('<span class="ic_classic ic_open" title="'+u["\uc790\uc138\ud788 \ubcf4\uae30"]+'" data-type="'+t+'"'+(n?' data-userid="'+n+'"':"")+"></span>"),r.push("</span>"),r.push("</li>"),r.join("\n")}function v(t,n,r,s){require(["hgn!calendar/templates/_calendar_tag"],function(o){var u=n==="my",f=n==="feed",l=n==="user",c={calendar_name:r,"show_star?":l||f,"follower?":f,title_attr:f?a["\uad00\uc2ec \uce98\ub9b0\ub354 \ud574\uc81c"]:a["\uad00\uc2ec \uce98\ub9b0\ub354 \ucd94\uac00"],data_id:s};if(l){var h=i.getInstance(),p=h.isFollowing(s);c["follower?"]=p,c.data_id=p?h.findByCalendarId(s)[0].id:s}e(o(c)).addClass(function(){var e=[];return u&&e.push("default_option"),e.join(" ")}).appendTo(t)})}function m(t){t.off(".calendarAppView"),e(document).off(".calendarAppView"),t.on("click.calendarAppView","#calendar-tag-base .ic_open",function(t){var n=e(t.currentTarget),i=n.data("type"),s;s=g();if(i==="user"){var o=new r,u=n.data("userid");o.setUserId(u),o.fetch({success:function(e){e.each(function(e){if(e.isMyCalendar()){var t=e.get("name");e.isProtected()&&(t+="("+a["\uc218\ub77d \ud6c4 \uacf5\uac1c"]+")"),v(s.find(".calendar_tag"),i,t,e.id)}})}})}else{var f=e("#side input[name=calendar_id]:checked");f.each(function(t,n){var r=e(n);v(s.find(".calendar_tag"),r.data("type"),r.data("name"),r.data("feedid"))})}e(".content_page").append(s),s.show(),e(t.currentTarget).removeClass("ic_open").addClass("ic_close")}),t.on("click.calendarAppView",".layer_name_tag .btn_layer_x, #calendar-tag-base .ic_close",function(){e(".layer_name_tag").remove(),e("#calendar-tag-base .ic_close").removeClass("ic_close").addClass("ic_open")}),t.on("click.calendarAppView",".calendar_star",function(){}),e(document).on("show:calendar.calendarAppView",function(){p()}),e(document).on("hide:calendar.calendarAppView",function(){p()})}function g(){e(".layer_name_tag").remove();var t=[],n;return t.push('<div class="layer_slide layer_name_tag" style="top:-8px; left:-1px;">'),t.push("<header></header>"),t.push('<a class="btn_layer_x" title="'+u["\ub2eb\uae30"]+'">'),t.push('<span class="ic"></span><span class="txt">'+u["\ub2eb\uae30"]+"</span>"),t.push("</a>"),t.push("</header>"),t.push('<ul class="name_tag calendar_tag">'),t.push("</ul>"),t.push("</div>"),n=e(t.join("\n")).hide(),n}var l=s.prototype,c=s.extend({events:t.extend({"click ins.calendar_star":"_editFeed"},l.events),initialize:function(){console.log("CalendarFixedSizeLayout#initialize"),l.initialize.apply(this,arguments)},render:function(){var t=this,n=e.Deferred();return l.render.apply(this).done(function(e){t.$el.find("#content").css("padding-bottom","0px").addClass("go_calendar_list go_renew"),t._bindWindowResize(),this.setTitle(h()),n.resolveWith(t,[t])}),n},delegateEvents:function(e){this.undelegateEvents(),l.delegateEvents.call(this,e)},undelegateEvents:function(){l.undelegateEvents.call(this),e(document).off(".fixedsize-layout")},resizeContentHeight:function(){var t=this.$el.find(".go_body"),r=e(window).height(),i=parseInt(t.css("min-height")),s=this.getContentTopElement().outerHeight(),o=3;s+=this.$el.find(".tool_bar").outerHeight(),n.isAdvancedTheme()||this.$el.find(".go_wrap").children(":not(.go_body)").each(function(t,n){r-=e(n).outerHeight()}),r=Math.max(i,r),this.$el.find(".go_body").height(r),this.$el.find("#content").height(r),this.$el.find(".content_page").height(r-s-o)},getContentPageHeight:function(){return this.$el.find(".content_page").height()},_bindWindowResize:function(){var t=this,n=new f;e(window).on("resize.fixedsize-layout",function(r){if(!e.isWindow(r.target))return;n.bind(function(){t.resizeContentHeight(),t.triggerResizeEvent()})})},triggerResizeEvent:function(){this.trigger("resize:content",this.getContentPageHeight(),this)},setCaledarTags:function(e){p(e),m(this.getContentElement()),e&&e.type==="user"&&this.$el.find("#calendar-tag-base .ic_open").trigger("click")},_editFeed:function(t){var n=e(t.currentTarget);return n.hasClass("ic_star_off")?this._addFeed(t):this._removeFeed(t),this},_addFeed:function(t){var r=this,i=e(t.currentTarget),s=i.attr("data-id");return Backbone.ajax(this._getCreateFeedUrl(s),{type:"POST"}).done(function(t){e.goPopup({title:a["\uad00\uc2ec \uce98\ub9b0\ub354\ub85c \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],message:"",modal:!0,buttons:[{btext:u["\ud655\uc778"],btype:"confirm"}],closeCallback:function(){r._updateCookieForCal(s),n.router.navigate("calendar",{trigger:!0,pushState:!0})}})}),this},_removeFeed:function(t){var r=this,s=e(t.currentTarget),o=s.attr("data-id"),u=i.getInstance().get(o);return e.goConfirm(a["\uad00\uc2ec \uce98\ub9b0\ub354 \ubaa9\ub85d\uc5d0\uc11c \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],a["\uad00\uc2ec \uce98\ub9b0\ub354 \ud574\uc81c \uc54c\ub9bc \uba54\uc2dc\uc9c0"],function(){var e=n.config("contextRoot")+"api/calendar/feed/"+o;Backbone.ajax(e,{type:"DELETE"}).done(function(){r._removeSavedCalendars(u.getCalendarId()),u.isPrivate()?n.router.navigate("calendar",{trigger:!0,pushState:!1}):location.reload()})}),this},_updateCookieForCal:function(e){var n=o.getSavedSelectedCalendar().split(",");return n.push(e),o.saveCheckedCalendar(t.uniq(n)),this},_removeSavedCalendars:function(e){var n=o.getSavedSelectedCalendar().split(","),r;return t.isArray(e)||(e=[e]),e=t.map(e,function(e){return""+e}),r=t.difference(n,e||[]),o.saveCheckedCalendar(t.uniq(r)),this},_getCreateFeedUrl:function(e){return n.config("contextRoot")+"api/calendar/feed?calendarId="+e}},{__instance__:null});return c})}).call(this);