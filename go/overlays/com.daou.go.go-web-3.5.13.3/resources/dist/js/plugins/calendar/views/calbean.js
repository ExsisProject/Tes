(function(){define(["backbone","when","app","calendar/models/event","calendar/views/calendar","calendar/libs/util","i18n!nls/commons","i18n!calendar/nls/calendar","go-calendar","jquery.calbean"],function(e,t,n,r,i,s,o,u,a){function E(e){var t={"required:summary":u["\uc77c\uc815\uba85\uc744 \uc785\ub825\ud558\uc138\uc694"],"max:summary":n.i18n(u["\uc77c\uc815\uba85\uc740 {{max}}\uc790 \uc774\ud558\ub85c \uc785\ub825\ud574 \uc8fc\uc2ed\uc2dc\uc624"],"max",y)};return t[e]||u["\uc77c\uc815 \ub4f1\ub85d\uc2dc \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4"]}function S(e){var t=$.Deferred();return x(e).done(function(e){e.hasAsset?$.goConfirm(u["\uc77c\uc815 \ubcc0\uacbd\uc2dc \uc790\uc0b0 \uc608\uc57d \ucde8\uc18c \uba54\uc2dc\uc9c0"],"",function(){$.ajax({url:n.config("contextRoot")+"api/asset/item/reservation",contentType:"application/json",dataType:"json",data:JSON.stringify({ids:e.reservedId}),type:"DELETE",success:t.resolve})},t.reject,""):t.resolve()}),t}function x(e){var t=$.Deferred(),r={hasAsset:!1};return $.ajax({url:n.contextRoot+"api/asset/my/reservation/calendar/"+e,success:function(e){e.data.length&&(r.hasAsset=!0),r.reservedId=_.map(e.data,function(e){return e.id}),t.resolve(r)}}),t}var f="calbeanview",l=[n.constant("calendar","EVENT_SHOW_CAL"),f].join("."),c=[n.constant("calendar","EVENT_HIDE_CAL"),f].join("."),h=[n.constant("calendar","EVENT_CHANGED_COLOR"),f].join("."),p=[n.constant("calendar","EVENT_SHOW_EVENT"),f].join("."),d=[n.constant("calendar","EVENT_CREATE_EVENT"),f].join("."),v=["changed:date",f].join("."),m=["changed:time",f].join("."),g=["changed:view-type",f].join("."),y=500,b=i.prototype,w=i.extend({name:"Calendar.CalbeanView",type:"calbean",height:0,initialize:function(e){this.options=e||{},b.initialize.call(this),this.__initRendered__=!1,this.options=_.extend({date:new Date,startday:0,type:"monthly",lang:n.config("locale"),i18n:{"\uc885\uc77c\uc77c\uc815":u["\uc885\uc77c\uc77c\uc815"],"\uc2dc\uac04":u["\uc2dc\uac04"],"\ub2eb\uae30":o["\ub2eb\uae30"],"\uac1c":"","\uc804\uc0ac\uc77c\uc815":u["\uc804\uc0ac\uc77c\uc815"],"\uc885\uc77c\uadfc\ud0dc\uc77c\uc815":u["\uc885\uc77c\uadfc\ud0dc\uc77c\uc815"],"\ub4f1\ub85d\ud560 \uc218 \uc5c6\ub294 \uc77c\uc815 \uacbd\uace0":u["\ub4f1\ub85d\ud560 \uc218 \uc5c6\ub294 \uc77c\uc815 \uacbd\uace0"]},collection:this.eventsPool,useAttendeeFetch:!0},_.pick(this.options,"date","startday","type"),{lazy:!0}),this.calbean=this.$el.calbean(this.options)},render:function(e,t){return this._getCalendarEvents().done($.proxy(function(n){var r=n.merge();e&&(r=_.filter(r,{calendarId:+e})),this.calbean.render(r,t)},this)).fail($.proxy(function(){this.calbean.render([],t)},this)),this.__initRendered__=!0,this},delegateEvents:function(e){b.delegateEvents.call(this,e),this.undelegateEvents(),this._delegateCustomEvents(),this._delegateCalbeanEvents()},undelegateEvents:function(){b.undelegateEvents.call(this),$(document).off("."+f),this.calbean.off("."+f)},resize:function(e){return this.calbean.resize(e),this},changeDate:function(e){var t=this;this.options.date=n.util.toMoment(e).toDate(),this._getCalendarEvents().done(function(e){t.calbean.changeDate(t.options.date,e.merge())})},changeType:function(e){this.calbean.changeViewType(e)},_showCalendar:function(e,t){var n=this;this.showCalendar(t).done(function(){n._getCalendarEvents().done(function(e){n.calbean.resetEvents(e.merge())})})},_hideCalendar:function(e,t){var n=this;this.hideCalendar(t).progress(function(){n.calbean.resetEvents(n.eventsPool.merge())})},_removeOrgSlideSelectedCalendar:function(){this.beforeSideSelect()},_changeCalendarColor:function(e,t,n){this.calbean.updateCalendarColor(t,n),this.eventsPool.updateCalendar(t,"color",n,{silent:!0})},_isAllowedViewType:function(e){return _.contains(["daily","weekly","monthly"],e)},_getStartDate:function(e){var t=n.util.toMoment(this.options.date);t=e?t.add("months",e):t;var r=t.clone().startOf("months"),i=r.day()-this.options.startday;return r.subtract("days",i<0?7+i:i)},_getEndDate:function(e){var t=n.util.toMoment(this.options.date);t=e?t.add("months",e):t;var r=t.clone().endOf("months"),i=r.day()-this.options.startday;return r.add("days",7-(i<0?7+i:i)-1)},_getBoundaryDate:function(){return{beforeStartDate:this._getStartDate(-1),beforeEndDate:this._getEndDate(-1),afterStartDate:this._getStartDate(1),afterEndDate:this._getEndDate(1)}},_getCalendarEvents:function(){var e=this._getStartDate(),t=this._getEndDate();return this.getCalendarEvents(e,t,!this.__initRendered__)},_setCalendarInfo:function(e){var t=s.getSavedSelectedCalendar(),n=[];t&&(n=t.split(","),n.push(e.toString())),s.saveCheckedCalendar(n)},_goToCalendar:function(){s.goToCalendar()},_delegateCustomEvents:function(){$(document).on(l,$.proxy(this._showCalendar,this)),$(document).on(c,$.proxy(this._hideCalendar,this)),$(document).on(h,$.proxy(this._changeCalendarColor,this))},_delegateCalbeanEvents:function(){function e(e){var t=$.Deferred();return $.goPopup({title:u["\uc54c\ub9bc\uba54\uc77c \ud655\uc778"],message:u["\uc77c\uc815\uc218\uc815\uc5d0 \ub300\ud55c \uc54c\ub9bc\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],buttons:[{btext:o["\ubcf4\ub0b4\uae30"],btype:"confirm",callback:function(){e.set("mailNoti",!0),t.resolve()}},{btext:u["\ubcf4\ub0b4\uc9c0 \uc54a\uc74c"],btype:"normal",callback:function(){e.set("mailNoti",!1),t.resolve()}}],closeIconVisible:!1,closeCallback:function(){self.submitFlag=!1,t.reject()}}),t}function t(t,n,r){var i=$.Deferred();t.isRecurrence()&&t.setRecurChangeType("instance"),t.isAlone()?i.resolve():e(t).done(function(){i.resolve()}).fail(function(){}),i.done(function(){t.isMove=!0,t.save(n,{success:function(e){n.recurrence="",r.eventsPool.updateEvents(e.id,n),r.calbean.resetEvents(r.eventsPool.merge())},error:function(e,t){r.calbean.render();var n=JSON.parse(t.responseText);$.goMessage(n.message)}})})}this.calbean.on(p,$.proxy(function(e,t,r){var i=this,s=n.session("id"),o=i.eventsPool.findEvent(t,r);n.router.navigate(["calendar",t,"event",r].join("/"),{trigger:!0,pushState:!0})},this)),this.calbean.on(d,$.proxy(function(e,t,i,s,f,l){var c=this;a.addSimpleEvent({contextRoot:n.config("contextRoot"),session:n.session(),timeType:t,startDate:i,startTime:s,endDate:f,endTime:l,modal:!0,afterAddEvent:function(e){var t=c.eventsPool,n=new r(e);t.contains(n.get("calendarId"))&&(n.set("auth",!0),t.addEvent(n),c.calbean.resetEvents(t.merge())),c._setCalendarInfo(n.get("calendarId")),c._goToCalendar()},onCreateError:function(e){$.goMessage(E(e))},lang:{"\ub0b4 \uce98\ub9b0\ub354":u["\ub0b4 \uce98\ub9b0\ub354"],"\uc77c\uc815 \ub4f1\ub85d":u["\uc77c\uc815 \ub4f1\ub85d"],"\uc77c\uc815\uba85":u["\uc77c\uc815\uba85"],"\uc77c\uc2dc":u["\uc77c\uc2dc"],"\uc2dc\uac04":u["\uc2dc\uac04"],"\uc885\uc77c":u["\uc885\uc77c"],"\ud655\uc778":o["\ud655\uc778"],"\ucde8\uc18c":o["\ucde8\uc18c"],"\uc77c\uc815\uc0c1\uc138 \uc785\ub825":u["\uc77c\uc815\uc0c1\uc138 \uc785\ub825"],"\uae30\ubcf8 \uce98\ub9b0\ub354 \uc774\ub984":u["\uce98\ub9b0\ub354 \uae30\ubcf8\uc774\ub984"],"\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc":u["\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc"],"\ubd84":u["\ubd84"],"\uc7a5\uc18c":u["\uc7a5\uc18c"],"\uc804\uc0ac\uc77c\uc815":u["\uc804\uc0ac\uc77c\uc815"],"\uc54c\ub9bc\uba54\uc77c \ud655\uc778":u["\uc54c\ub9bc\uba54\uc77c \ud655\uc778"],"\uc77c\uc815\ub4f1\ub85d\uc5d0 \ub300\ud55c \uc54c\ub9bc\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?":u["\uc77c\uc815\ub4f1\ub85d\uc5d0 \ub300\ud55c \uc54c\ub9bc\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"\ubcf4\ub0b4\uae30":o["\ubcf4\ub0b4\uae30"],"\ubcf4\ub0b4\uc9c0 \uc54a\uc74c":u["\ubcf4\ub0b4\uc9c0 \uc54a\uc74c"]}})},this)),this.calbean.on(v,$.proxy(function(e,r,i,s,o,u){var a=this,f=a.eventsPool.findEvent(i,r),l=n.util.toMoment(f.get("startTime")),c=n.util.toMoment(s+l.format("THH:mm:ssZZ")),h=c.diff(l,"days"),p=n.util.toMoment(f.get("endTime")),d=p.clone().add("days",h),v={startTime:n.util.toISO8601(c),endTime:n.util.toISO8601(d)},m=a.$(".ev-"+r).data("event");if(m){var g=m.attendees;f.set("attendees",g)}var y=n.isAvailableApp("asset");y?S(r).then(function(){t(f,v,a)}):t(f,v,a)},this)),this.calbean.on(m,$.proxy(function(e,r,i,s,o,u){var a=this,f=this.eventsPool.findEvent(i,r),l={startTime:s,endTime:o},c=a.$('[data-id="'+r+'"]').data(),h=null;c&&(h=c.promise,h&&h.then(function(){f.set("attendees",c.event?c.event.attendees:undefined);var e=n.isAvailableApp("asset");e?S(r).then(function(){t(f,l,a)}):t(f,l,a)}))},this)),this.calbean.on(g,$.proxy(function(e,t,r){n.router.navigate(["calendar",t,r].join("/"),{trigger:!0,pushState:!0}),e.stopImmediatePropagation()},this))}});return w})}).call(this);