define("calendar/helpers/regist_form",function(require){function b(t){e(".asset-reservation").each(function(n,r){var i=e(r).data("asset-view");i.changeTime(t.startTime,t.endTime,e("#all_day").is(":checked"))})}function w(t,n){e.goError(n,t),t.addClass("enter error").focus()}var e=require("jquery"),t=require("underscore"),n=require("app"),r=require("hogan"),i=require("moment"),s=require("calendar/helpers/recurrence_layer"),o=require("calendar/libs/util"),u=require("calendar/views/asset"),a=require("text!calendar/templates/form.html"),f=require("text!calendar/templates/_select_date.html"),l=require("i18n!nls/commons"),c=require("i18n!calendar/nls/calendar"),h=require("i18n!asset/nls/asset"),p=require("go-nametags"),d=require("go-calendar");require("jquery.go-popup"),require("jquery.cookie");var v=30,m=Array.prototype.slice,g={start_time:"00:00",end_time:"00:00",recurrence_code:"","regist?":!0,"editable?":!1,"private?":!1,"recurrence?":!1,"show_visibility?":!0,"show_inner_attendees?":!0,"show_location?":!0,"show_description?":!0,"show_reminder?":!0,"allday_event?":!1,"calendar_manager?":!1,"use_asset?":!1,"use_org?":n.session("useOrg"),"show_calendar_select?":!0,repeatable:!0,label:{title:c["\uc77c\uc815\uba85"],privacy:l["\ube44\uacf5\uac1c"],datetime:c["\uc77c\uc2dc"],allday:c["\uc885\uc77c"],recurrence:c["\ubc18\ubcf5"],remove:l["\uc0ad\uc81c"],public_event:c["\uc804\uc0ac\uc77c\uc815"],attendees:c["\ucc38\uc11d\uc790"],select_attendees:c["\ucc38\uc11d\uc790 \uc120\ud0dd"],location:c["\uc7a5\uc18c"],desc:l["\ub0b4\uc6a9"],reminder:c["\uc54c\ub78c"],modify:l["\uc218\uc815"],add_reminder:c["\uc54c\ub78c \ucd94\uac00"],confirm:l["\ud655\uc778"],cancel:l["\ucde8\uc18c"],remove:l["\uc0ad\uc81c"],goto_list:c["\uce98\ub9b0\ub354\ub85c \ub3cc\uc544\uac00\uae30"],leave_attendee:c["\ucc38\uc11d\uc790\uc5d0\uc11c \ube60\uc9c0\uae30"],remove_event:c["\uc77c\uc815 \uc0ad\uc81c\ud558\uae30"],copy_event:c["\uc77c\uc815 \ubcf5\uc0ac"],reserving_asset:c["\uc608\uc57d\ud558\uae30"],my_calendar:c["\ub0b4 \uce98\ub9b0\ub354"],comment:l["\ub313\uae00"],history:l["\ubcc0\uacbd\uc774\ub825"],external_participants:c["\uc678\ubd80\ucc38\uc11d\uc790"],add:l["\ucd94\uac00"],delete_all:l["\uc804\uccb4 \uc0ad\uc81c"],more:l["\ub354\ubcf4\uae30"],copy_url:l["URL \ubcf5\uc0ac"]},msg:{private_event_info:c["\ube44\uacf5\uac1c \uc77c\uc815\uc740 \ucc38\uc11d\uc790\ub9cc \ud655\uc778 \uac00\ub2a5\ud569\ub2c8\ub2e4."],public_event_info:c["\uc804\uc0ac\uc77c\uc815\uc740 \uc0ac\uc6a9\uc790 \uc804\uccb4\uc5d0\uac8c \ubcf4\uc5ec\uc9d1\ub2c8\ub2e4."],atendee_alarm_msg:c["\ucc38\uc11d\uc790 \uc54c\ub78c \uc548\ub0b4 \uba54\uc2dc\uc9c0"],asset_reservation_msg:c["\uc124\uc815\ud55c \uc2dc\uac04\ub300\uc5d0 \uc608\uc57d \uac00\ub2a5\ud55c \ud68c\uc758\uc2e4\ub9cc \ubcf4\uc5ec\uc9d1\ub2c8\ub2e4."]}},y=function(){var p=[],v=function(t,i,s){this.el=t,this.$el=e(t),this.type=i||"regist",this.editable=typeof s=="undefined"?!0:s;if(!this._isValidType(this.type))throw new Error("Invaild form type.(regist or detail)");this.compiledForm=r.compile(a),this.variables={},this.variables=e.extend(!0,{},g,{"regist?":this.type==="regist"?!0:!1,"detail?":this.isDetailType(),"editable?":this.editable,"use_asset?":n.isAvailableApp("asset")}),this.partials={select_date:r.compile(f)}};return v.prototype={render:function(){var t=arguments[0]||{},n=this.compiledForm,i=m.call(arguments,2),s=t.summary;s&&s.length>0&&(t.summary=s.replace(/"/gi,"&quot;"));var o=t.location;return o&&o.length>0&&(t.location=o.replace(/"/gi,"&quot;")),i.unshift(e.extend(!0,this.variables,t,{show_recurrence_wrap:t["recurrence?"]&&t.repeatable}),e.extend(this.partials,arguments[1])),this.el.empty().html(r.Template.prototype.render.apply(n,i)),this.undelegateEvents(),this.delegateEvents(),this.datepickerHelper=d.init({el:this.$el.find("#selectDate"),startDate:this.variables.start_date||this.$el.find("#startDate").val(),startTime:this.variables.start_time||this.$el.find("#startTime").val(),endDate:this.variables.end_date||this.$el.find("#endDate").val(),endTime:this.variables.end_time||this.$el.find("#endTime").val(),lang:{"\ub0b4 \uce98\ub9b0\ub354":c["\ub0b4 \uce98\ub9b0\ub354"],"\uc77c\uc815 \ub4f1\ub85d":c["\uc77c\uc815 \ub4f1\ub85d"],"\uc77c\uc815\uba85":c["\uc77c\uc815\uba85"],"\uc77c\uc2dc":c["\uc77c\uc2dc"],"\uc2dc\uac04":c["\uc2dc\uac04"],"\uc885\uc77c":c["\uc885\uc77c"],"\ud655\uc778":l["\ud655\uc778"],"\ucde8\uc18c":l["\ucde8\uc18c"],"\uc77c\uc815\uc0c1\uc138 \uc785\ub825":c["\uc77c\uc815\uc0c1\uc138 \uc785\ub825"],"\uae30\ubcf8 \uce98\ub9b0\ub354 \uc774\ub984":c["\uce98\ub9b0\ub354 \uae30\ubcf8\uc774\ub984"],"\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc":c["\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc"],"\ubd84":c["\ubd84"],"\uc804\uc0ac\uc77c\uc815":c["\uc804\uc0ac\uc77c\uc815"],"\uc54c\ub9bc\uba54\uc77c \ud655\uc778":c["\uc54c\ub9bc\uba54\uc77c \ud655\uc778"],"\uc77c\uc815\ub4f1\ub85d\uc5d0 \ub300\ud55c \uc54c\ub9bc\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?":c["\uc77c\uc815\ub4f1\ub85d\uc5d0 \ub300\ud55c \uc54c\ub9bc\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"\ubcf4\ub0b4\uae30":l["\ubcf4\ub0b4\uae30"],"\ubcf4\ub0b4\uc9c0 \uc54a\uc74c":c["\ubcf4\ub0b4\uc9c0 \uc54a\uc74c"]}}),this._afterDateChanged(),this._showHideAssetViews(),this},_afterDateChanged:function(){var t=this;if(!n.isAvailableApp("asset"))return!1;this.datepickerHelper.afterChanged(e.proxy(function(){e(".reserved-asset-item").length>0?this._removeReservedAssetItems({confirm:function(){t._showHideAssetViews()},cancel:function(){t.datepickerHelper.reset(this.datepickerHelper.options)}}):this._showHideAssetViews()},this))},loadMyCalendarOptions:function(e,r){var i=[],s=this.$el.find("select[name=calendar_id]"),o=e[0];t.each(e,function(e,t){e.get("defaultCalendar")===!0&&(o=e),i.push('<option value="',e.id,'">',e.get("defaultCalendar")?c["\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc"]:"",n.util.escapeHtml(e.get("name"))||n.i18n(c["\uae30\ubcf8 \uce98\ub9b0\ub354 \uc774\ub984"],{username:e.get("owner").name}),"</option>")},this),s.empty().append(i.join("")),r?s.val(r):s.val(o.id)},loadAsset:function(t){if(n.isAvailableApp("asset")){console.log("loadAsset() Call!!!");var r=this.datepickerHelper.getCurrentTimeInfo();u.load("#asset-wrapper",r.startTime,r.endTime,t,e("#all_day").is(":checked"),e("#check-recurrence").is(":checked"))}},getForReserveAssetItems:function(){return u.getForReserveAssetItems()},saveReservationAssets:function(){var r=this,i=u.getForReserveAssetItems(),s=e.Deferred(),o=this.$el.find("#startDate").val(),a=this.$el.find("#startTime").val(),f=this.$el.find("#endDate").val(),l=this.$el.find("#endTime").val(),c=this.$el.find('input[name="summary"]').val();if(c=="")return;e.isArray(i)||(i=[i]);var d="YYYY-MM-DD HH:mm",v=n.util.toISO8601(n.util.toMoment(o+" "+a,d)),m=n.util.toISO8601(n.util.toMoment(f+" "+l,d)),g=e("#all_day").is(":checked");t.each(i,function(e,t){e.get("startTime")!=v&&!g&&e.set("startTime",v),e.get("endTime")!=m&&!g&&e.set("endTime",m)});var y=i.length;for(var b=0;b<y;b++){var w=i[b],E=w.get("itemId"),S=e("li.reserved-asset-item[data-id="+E+"]").data("mine");if(S)continue;s=e.ajax({url:n.contextRoot+"api/asset/"+w.get("assetId")+"/item/"+w.get("itemId")+"/reserve",type:"POST",async:!1,data:JSON.stringify(w),dataType:"json",contentType:"application/json;",success:function(e){p.push(e.data.id)},error:function(t){e.goMessage(h["\uc608\uc57d\ud558\ub824\ub294 \uc2dc\uac04\ub300\uc5d0 \uc774\ubbf8 \uc608\uc57d\ub41c \uac74\uc774 \ud3ec\ud568\ub418\uc5b4\uc788\uc2b5\ub2c8\ub2e4."])}})}return u.resetAssetItemList(),s},delegateEvents:function(){return this.el.on("click.calendar-regist","#all_day",e.proxy(this._toggleAlldayCallback,this)),this.el.on("click.calendar-regist","#check-recurrence",e.proxy(this._showHideRecurrenceSetupLayer,this)),this.el.on("click.calendar-regist","#recurrence-wrap .recur_delete",e.proxy(this._removeRecurrence,this)),this.el.on("click.calendar-regist","#recurrence-wrap .recur_edit",e.proxy(this._editRecurrence,this)),this.el.on("click.calendar-regist","#check-company-event",e.proxy(this._checkCompanyEvent,this)),this.el.on("keyup.calendar-regist","textarea",e.proxy(this._textAreaExpand,this)),this.el.on("click.calendar-regist","#addExternal",e.proxy(this._addExternal,this)),o.bindDatepickerIcon(this.el,"calendar-regist"),this},undelegateEvents:function(){return this.el.off(".calendar-regist"),this},_textAreaExpand:function(e){n.util.textAreaExpand(e)},_showHideAssetViews:function(){var t=this.datepickerHelper.getCurrentTimeInfo();if(!n.isAvailableApp("asset"))return;if(e("#asset-wrapper").is(":empty"))return;this.isReservableAsset.call(this,t)?(b(t),e("#asset-list-row").show()):e("#asset-list-row").hide()},isReservableAsset:function(e){var t=e||this.datepickerHelper.getCurrentTimeInfo();return this.el.find("#check-recurrence").is(":checked")?!1:!0},initReservedAssetItems:function(t){var n=this;e(".reserved-asset-item").length>0?this._removeReservedAssetItems(t):t.confirm()},_removeReservedAssetItems:function(t){var n=this;typeof t.confirm!="function"&&(t.confirm=function(){}),typeof t.cancel!="function"&&(t.cancel=function(){}),e.goPopup({title:c["\uc608\uc57d \ucde8\uc18c"],message:c["\uc77c\uc815 \ubcc0\uacbd\uc2dc \uc790\uc0b0 \uc608\uc57d \ucde8\uc18c \uba54\uc2dc\uc9c0"],modal:!0,buttons:[{btext:l["\ud655\uc778"],btype:"confirm",callback:function(){u.resetAssetItemList(),u.cancelReservationAll().done(function(){console.log("_removeReservedAssetItems complete!!!"),t.confirm.call(n)})}},{btext:l["\ucde8\uc18c"],btype:"cancel",callback:function(){n.loadAsset(),e("input:checkbox[id='check-recurrence']").removeAttr("checked"),e.proxy(t.cancel,n)}}]})},serializeFormData:function(){var e={},r=this.el.find("form"),s={},o=n.util.serializeForm(r),u="visibility"in o?o.visibility:"public",a="timeType"in o?o.timeType:"timed",f={};t.each(["summary","location","description","recurrence"],function(e){var t=r.find("input[name="+e+"]:not(.edit), textarea[name="+e+"]:not(.edit)");t.length>0&&(s[e]=t.val())});var l="YYYY-MM-DD HH:mm",c=n.util.toISO8601(n.util.toMoment(o.start_date+" "+o.start_time,l)),h=n.util.toISO8601(n.util.toMoment(o.end_date+" "+o.end_time,l));return a==="allday"&&(l="YYYY-MM-DDTHH:mm:ss.SSS"+n.session().timeZone.serverTZOffset,c=i(o.start_date,"YYYY-MM-DD").clone().startOf("day").format(l),h=i(o.end_date,"YYYY-MM-DD").clone().endOf("day").format(l)),s.summary&&(s.summary=this._xssFilter(s.summary)),s.location&&(s.location=this._xssFilter(s.location)),s.description&&(s.description=this._xssFilter(s.description)),n.isAvailableApp("asset")&&(f.assetReservationIds=p,p=[]),e=t.extend({type:o.is_company_event?"company":"normal",visibility:u,startTime:c,endTime:h,timeType:a,recurrence:"",reminders:this._convertRemindersHash(o),timeZoneOffset:n.util.timeZoneOffset(),calendarId:o.is_company_event?parseInt(o.company_calendar_id):parseInt(o.calendar_id)},s,f),e},goToList:function(){o.goToCalendar()},isDetailType:function(){return this.type==="detail"},raiseError:function(t,n,r){var i=Array.prototype.slice.call(arguments,3);switch(n){case"numeric:reminder_time":case"min:reminder_time":case"max:reminder_time":var s=this.el.find('input[name^="reminder_value_"]')[i[0]];e(s).val("30");break;case"required:summary":case"max:summary":w(this.$el.find('input[name="summary"]'),r);break;case"max:location":w(this.$el.find('input[name="location"]'),r);break;case"max:description":w(this.$el.find('textarea[name="description"]'),r);break;case"required:attendees":w(this.$el.find("#attendee-list"),r);break;default:e.goSlideMessage(r,"caution")}},_xssFilter:function(e){return n.util.XSSFilter(e)},_checkCompanyEvent:function(t){var n=e(t.currentTarget),r=this.el.find("#attendee-list-row"),i=this.el.find("#calendar-list-row"),s=this.el.find("#company-calendar-list"),o=this.el.find("#check-visibility"),u=o.parent();return n.is(":checked")?(r.hide(),i.hide(),s.show(),o.attr("checked",!1),o.attr("disabled",!0),u.addClass("disabled")):(o.attr("disabled",!1),u.removeClass("disabled"),r.show(),i.show(),s.hide()),this},_addExternal:function(){var e=this.$el.find("#externalForm").val();if(!e)return;this.$el.find("#externalForm").val(""),this.$el.find("#externalArea").show(),this.$el.trigger("externalAttendee:regist",e)},_toISO8601:function(e,t){return n.util.toISO8601(n.util.toMoment(e+" "+t,"YYYY-MM-DD HH:mm"))},_convertRemindersHash:function(){var t=this,n=[],r=this.$el.find('input[name^="reminder_value_"]');return r.length>0&&r.each(function(r,i){var s=e(i).parent().data("index");n.push({time:parseInt(e(i).val()),type:t.$el.find("select[name=reminder_type_"+s+"] > option:selected").val(),method:t.$el.find("select[name=reminder_method_"+s+"] > option:selected").val()})}),n},_toggleAlldayCallback:function(t){function s(){i.is(":checked")?$selectDate.hide():(this.datepickerHelper.updateSelectedTime(n.util.now()),$selectDate.show())}console.log("CalendarRegistView#_toggleAlldayCallback");var r=this,i=e(t.target);$selectDate=this.el.find("span.wrap_select_list"),e(".reserved-asset-item").length>0?this._removeReservedAssetItems({confirm:function(){s.call(r),r._showHideAssetViews()},cancel:function(){i.prop("checked",!1)}}):(s.call(this),r._showHideAssetViews())},_isValidType:function(e){return t.contains(["regist","detail"],e)},_showHideRecurrenceSetupLayer:function(t,n){function o(e){if(this._getRecurrenceCheckbox().is(":checked")){var t=this.el.find("#startDate").val(),n=new s(t,!0,this._getRecurrenceField().val(),e),r=this._getRecurrenceCheckbox().offset();r.top=parseInt(r.top)+30;var i=parseInt(window.width),o=parseInt(jQuery(window).width());parseInt(r.left)+i>o&&(r.left=parseInt(r.left)+jQuery(window).scrollLeft()-(parseInt(r.left)+i-o)),n.setConfirmCallback(this._updateRecurrenceText,this),n.setCancelCallback(this._cancelUpdateRecurrence,this),n.setCloseCallback(this._cancelUpdateRecurrence,this),n.render(r)}else this._removeRecurrence()}var r=this,i=e("input:checkbox[id='check-recurrence']");console.log("CalendarRegistView#_showHideRecurrenceSetupLayer");if(e(".reserved-asset-item").length>0){var r=this;this._removeReservedAssetItems({confirm:function(){r._showHideAssetViews(),o.call(r,n)},cancel:function(){e(t.currentTarget).prop("checked",!1)}})}else o.call(this,n),this._showHideAssetViews(),i.prop("checked")||r.loadAsset()},_updateRecurrenceText:function(e,t){return this._getRecurrenceWrap().show(),this._getRecurrenceTextWrap().text(t),this._updateRecurrenceField(e),this},_updateRecurrenceField:function(e){return this._getRecurrenceField().val(e),this.isDetailType()&&this._getRecurrenceField().trigger("change"),this},_cancelUpdateRecurrence:function(){var e=this;return this._getRecurrenceField().val()||(this._uncheckRecurrence(),e.loadAsset()),this},_removeRecurrence:function(t){var n=this,r=e("input:checkbox[id='check-recurrence']");return this._getRecurrenceTextWrap().text(""),this._updateRecurrenceField(""),this._getRecurrenceWrap().hide(),this._uncheckRecurrence(),e(".reserved-asset-item").length==0&&(this._showHideAssetViews(),r.prop("checked")||n.loadAsset()),this},_editRecurrence:function(e){this._showHideRecurrenceSetupLayer()},_uncheckRecurrence:function(){var e=this._getRecurrenceCheckbox();e.is(":checked")&&(e.attr("checked",!1),e.trigger("change")),this._showHideAssetViews()},_getRecurrenceCheckbox:function(){return this.$el.find("#check-recurrence")},_getRecurrenceWrap:function(){return this.$el.find("#recurrence-wrap")},_getRecurrenceField:function(){return this.$el.find("#recurrence-wrap input[name=recurrence]")},_getRecurrenceTextWrap:function(){return this.$el.find("#recurrence-text")}},v}();return y});