(function(){define(["underscore","backbone","amplify","app","moment","calendar/models/calendar_feed","calendar/collections/calendar_feeds","calendar/collections/calendars","calendar/views/calbean","calendar/views/agenda","calendar/libs/util","hgn!calendar/templates/calendar","i18n!calendar/nls/calendar","i18n!nls/commons","jquery.ui","jquery.calbean","jquery.go-popup"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){function w(){var t=r.session("id")+"-calendar",n={viewtype:{storetype:"local","default":"monthly"},basedate:{storetype:"session","default":r.util.toMoment(new Date).format("YYYY-MM-DD")}},i={};return e.each(n,function(e,n){var s=t+"-"+n,o=r.util.store,u=o.get(s);u?i[n]=u:(o.set(s,e["default"],{type:e.storetype}),i[n]=e["default"])}),i}var d=r.constant("calendar","EVENT_CHANGE_CAL_TYPE"),v=i().lang(r.config("locale")),m=Array.prototype.slice,g=t.View.prototype,y={timezone:"",tab_daily:h["\uc77c\uac04"],tab_weekly:h["\uc8fc\uac04"],tab_monthly:h["\uc6d4\uac04"],tab_agenda:h["\ubaa9\ub85d"],date_str:v.format(h["YYYY\ub144 MM\uc6d4"]),today:h["\uc624\ub298"],print:p["\uc778\uc1c4"],text_prev:p["\uc774\uc804"],text_next:p["\ub2e4\uc74c"]},b=t.View.extend({tagName:"div",className:"content_page",calendarView:null,conditions:{},height:0,events:{"click .tab_nav > li":"_changeCalendarType","click .current_date .prev-btn":"_goToPrev","click .current_date .next-btn":"_goToNext","click .current_date .datepicker-btn":"_goToDate","click .current_date .today-btn":"_goToToday","click .ic_print":"_printPage"},initialize:function(t){this.options=t||{},this.height=0,this.calendarView=null,this.datastore=w(),this.options=e.defaults(this.options,{type:this.datastore.viewtype,date:r.util.toMoment(this.datastore.basedate).toDate()}),this.__calendarIds__={},this.conditions={date:this.options.date,startday:0,type:this.options.type},this.datastore.viewtype!==this.conditions.type&&this._saveViewTypeToStore(this.conditions.type),this.$el.empty().append(c(y)),this.setDateIndicator(),this._createCalendarView(),this._initTab(),$.datepicker.setDefaults($.datepicker.regional[r.config("locale")]),this._initDatepicker()},render:function(e){return this.calendarView.render(e,{height:this.getHeight()}),this.$el.append(this.calendarView.el),this.el},delegateEvents:function(e){g.delegateEvents.call(this,e),this._bindTabEvent()},undelegateEvents:function(){g.undelegateEvents.call(this),this.getTabElement().off(d)},resize:function(e){if(this._isAgendaView())return;typeof e!="undefined"&&this.setHeight(e),this.$el.height(this.height),this.calendarView.resize(this.height)},setHeight:function(e){var t=24;this.height=e-this.getToolbarView().outerHeight()+t},getHeight:function(){return this.height},setDateIndicator:function(){var e="YYYY.MM.DD",t=r.util.toMoment(this.conditions.date),n=t.format(e),i=t.format("YYYY.MM"),s=r.util.toMoment(r.util.getStartDateOfWeek(t,this.conditions.startday)),o=r.util.toMoment(r.util.getEndDateOfWeek(t,this.conditions.startday)),u={monthly:i,weekly:[s.format(e),o.format(e)].join(" ~ "),daily:n,agenda:n}[this.getCalendarType()];return this.getToolbarView().find("#date-indicator").empty().html(u),this},getCalendarType:function(){return this.conditions.type},setCalendarType:function(e){return console.log("[CalendarAppView#setCalendarType] loading..."),this.conditions.type=e,this._saveViewTypeToStore(e),this.resetCalendarView(),this},resetCalendarView:function(){return this.calendarView.type!==this._getCalendarViewType()?(this.calendarView.remove(),this.calendarView=null,this._createCalendarView(),this.render(),this.resize()):this.calendarView.changeType(this.getCalendarType()),this},getToolbarView:function(){return this.$el.find(".tool_bar")},getTabElement:function(){return this.$el.find(".tab_nav")},addCalendars:function(){var t=m.call(arguments);return e.each(t,function(e,t){this.calendarView.addCalendar(parseInt(e))},this),this},clearCalendars:function(){this.calendarView.clearCalendars()},addCalendarsByUserId:function(n){var i=this,s=new u;return s.setUserId(n).fetch({async:!1,success:function(n){var s=n.getMyCalendars()[0],u=o.getInstance(),a=s.id;u.isFollowing(a)||!s.isPrivate()?i.addCalendars.apply(i,e.pluck(n.getUserCalendars(),"id")):$.goPopup({title:h["\uc77c\uc815\uc744 \uc5f4\ub78c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],message:h["\uad00\uc2ec \uce98\ub9b0\ub354\uac00 \ub418\uba74 \uc77c\uc815\uc744 \uc5f4\ub78c\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"],buttons:[{btext:h["\uad00\uc2ec\ub3d9\ub8cc \uc2e0\uccad"],btype:"confirm",callback:function(){var e=r.config("contextRoot")+"api/calendar/feed?calendarId="+a;t.ajax(e,{type:"POST"}).done(function(e){r.router.navigate("calendar",{trigger:!0,replace:!0})}).fail(function(){r.router.navigate("calendar",{trigger:!0})})}},{btext:p["\ucde8\uc18c"],btype:"normal",callback:function(){r.router.navigate("calendar",{trigger:!0,pushState:!0})}}]})}}),s},_showTagLayer:function(){var e=$("#side input[name=calendar_id]:checked"),t;t=createCalendarTagLayer(e),t.appendTo($("header.content_top")),t.show()},_initTab:function(){return this.getTabElement().find('li[data-type="'+this.conditions.type+'"]').addClass("on"),this},_createCalendarView:function(){return this.calendarView=this._isAgendaView()?new f({date:this.conditions.date}):new a(this.conditions),this},_getCalendarViewType:function(){return this._isAgendaView()?"agenda":"calbean"},_isAgendaView:function(){return this.conditions.type==="agenda"},_goToPrev:function(e){return this._goToOffset(-1),this},_goToNext:function(e){return this._goToOffset(1),this},_goToOffset:function(e){var t={monthly:"months",weekly:"weeks",daily:"days",agenda:"days"}[this.getCalendarType()],n=r.util.toMoment(this.conditions.date).clone().add(t,e);return this._changeDate(n),this},_goToDate:function(e){this.$el.find("#calendarDatepicker").trigger("focus")},_initDatepicker:function(){var e=this,t=this.$el.find("#calendarDatepicker").datepicker({changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(t){e._changeDate(t)}});this.$el.find("#calendarDatepicker").datepicker("setDate",this.conditions.date)},_goToToday:function(e){return this._changeDate(),this},_changeDate:function(e){var t=this.conditions.type,n=this.conditions.date=r.util.toMoment(e||new Date).toDate(),i=["calendar",t,this._getDateForType(t)].join("/");return r.EventEmitter.trigger("common","layout:setOverlay",""),this.calendarView.changeDate(n),this._saveBasedateToStore(n),this.setDateIndicator(),r.router.navigate(i,{trigger:!1,pushState:!0}),r.EventEmitter.trigger("common","layout:clearOverlay",!0),this},_bindTabEvent:function(){var e=this.getTabElement();return $(this.getTabElement()).find("li").each(function(t,n){$(e).on(d,function(e,t){$(n).attr("data-type")===t?$(n).addClass("on"):$(n).removeClass("on")})}),this},_changeCalendarType:function(e){var t=$(e.currentTarget).is("span")?$(e.currentTarget).parent():$(e.currentTarget),n=t.attr("data-type")||"monthly",i={trigger:!0,pushState:!0},s="";return s=["calendar",n,this._getDateForType(n)].join("/"),this.conditions.type!=="agenda"&&n!=="agenda"&&(this.setCalendarType(n),this.setDateIndicator(),this.getTabElement().trigger(d,[n]),i.trigger=!1),r.router.navigate(s,i),this},_getDateForType:function(e){return l.getDateForUrl(e,this.conditions.date)},_saveViewTypeToStore:function(e){l.saveCalendarType(e)},_saveBasedateToStore:function(e){l.saveBasedate(e)},_printPage:function(){window.print()}});return b})}).call(this);