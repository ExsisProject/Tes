(function(){define(["jquery","underscore","app","backbone","hogan","asset/models/asset_user_create","asset/collections/asset_admin","text!calendar/templates/_asset_base.html","text!calendar/templates/_asset_list.html","text!calendar/templates/_asset_alert.html","i18n!nls/commons","i18n!asset/nls/asset","go-nametags","jquery.go-popup"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){function x(n,r,i,s,o,u){var a=new g,f=e(n);C();var l=e(n).children().length;if(l>0||!u)for(var c=0;c<l;c++)e(n).children().remove();a.fetch({success:function(n){n.length>0?(e("#asset-list-row").show(),n.each(function(n){var u=!1;assetViewList=e(e(".flexable_title").find(".txt")),t.each(assetViewList,function(t,r){n.get("name")==e(t).text()&&(u=!0)});if(!u){var a=new S({model:n,startTime:r,endTime:i,allday:s});f.append(a.el),a.render()}o&&o[n.id]&&(t.each(o[n.id],function(t){a.addNameTag(t.get("itemId"),t.get("itemName"),t.get("id"),!0);var n=!1;e.each(d,function(e){t.get("itemName")==d[0].get("itemName")&&(n=!0)}),n||d.push(t)}),a.openFolder())})):e("#asset-list-row").remove()}})}function T(){var e=[];return e.push(c["\uc774\uc6a9\uac00\ub2a5\ud55c \uc790\uc0b0\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),e.join("\n")}function N(){var r=[],i=0;return t.each(d,function(t,i){if(t.id){var o=t.get("reservedStartTime")||n.util.toISO8601(n.util.toMoment(e("#startDate").val()+" "+e("#startTime").val(),"YYYY-MM-DD HH:mm")),u=t.get("reservedEndTime")||n.util.toISO8601(n.util.toMoment(e("#endDate").val()+" "+e("endTime").val(),"YYYY-MM-DD HH:mm")),a=new s({assetId:t.get("assetId"),itemId:t.get("itemId"),itemName:t.get("itemName"),type:"reserve",startTime:o,endTime:u});r.push(a),console.log("ReservedAssetItems complete!!!")}else r.push(t)}),r}function C(){t.each(d,function(e,t){d.splice(t,1)}),d=[]}function k(t){var r=this,i=[],s=e.Deferred();return e(".reserved-asset-item").each(function(t,n){e(n).data("user")&&i.push(e(n).data("user")),e(n).remove(),$trs=e("tbody#data-assetItems").find("tr[data-assetid]"),$trs.each(function(t,r){var i=e(r).attr("data-name");i===e(n).find("span.name").text()&&e(r).show()})}),i.length>0?s=e.ajax({url:n.config("contextRoot")+"api/asset/item/reservation/force",contentType:"application/json",dataType:"json",data:JSON.stringify({ids:i}),type:"DELETE",async:!1,success:function(){console.log("All Asset Reservation Delete : success!"),s.done()},error:function(){console.log("All Asset Reservation Delete : error!")}}):s.resolve(),s}var p={rental:c["\ub300\uc5ec"],item:c["\ud56d\ubaa9"],reservation:c["\uc608\uc57d"],no_assetitem:c["\uc774\uc6a9\uac00\ub2a5\ud55c \uc790\uc0b0\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],confirm:l["\ud655\uc778"],cancel:l["\ucde8\uc18c"],close:l["\ub2eb\uae30"],open:l["\uc5f4\uae30"],alert_length:l["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."]},d=[],v=!1,m=r.Model.extend({}),g=r.Collection.extend({model:m,url:"/api/asset/calendar"}),y=r.Model.extend({}),b=r.Collection.extend({model:y,url:function(){return"/api/asset/my/reservation/calendar/"+this.eventId},initialize:function(){this.eventId=-1},setEventId:function(e){return this.eventId=e,this}}),w=r.Collection.extend({assetId:null,params:{startTime:undefined,endTime:undefined},url:function(){return"/api/asset/"+this.assetId+"/item/reservation/availability?"+e.param(this.params)},initialize:function(){},setAssetId:function(e){return this.assetId=e,this},setAssetStartTime:function(e){return this.assetStartTime=e,this},setAssetEndTime:function(e){return this.assetEndTime=e,this},setStartTime:function(e){return this.params.startTime=e,this},setEndTime:function(e){return this.params.endTime=e,this}}),E=r.View.extend({tagName:"table",className:"type_normal tb_list_sub list_reser007",sortDirection:1,events:{"click .btn-reservation":"reserve"},initialize:function(e){this.options=e||{},this.assetId=this.options.assetId,this.startTime=n.util.toISO8601(this.options.startTime),this.endTime=n.util.toISO8601(this.options.endTime),this.availableItems=this.collection,this.sortDirection=1,this.assetAttrs=new o,this.assetAttrs.setUrlPart("info"),this.assetAttrs.setAssetId(this.assetId),this.assetAttrs.fetch({async:!1}),this.saveFlag||this.availableItems.sortBy(function(e){return e.name})},render:function(){var e=this.assetAttrs.at(0).get("attributes"),t=i.compile(a);this.$el.empty().append(t.render({label:{rental:p.rental,item:p.item,reservation:p.reservation},asset_option_headers:e,column_counts:e.length+2,asset_item_list:this.availableItems.toJSON(),emptyMessage:T()}))},setStartTime:function(e){return this.startTime=e,this},setEndTime:function(e){return this.endTime=e,this},reload:function(e){var t=this;t.availableItems.fetch({success:function(e){}})},sortByName:function(t){var n=this,r=e(t.currentTarget),i=this.$el.find("tbody").children().get();i.sort(function(t,r){var i=e(t).find("td.name > span.txt").text(),s=e(r).find("td.name > span.txt").text(),o;return n.sortDirection===-1?o=i>s:o=i<s,o}),this.$el.find("tbody").empty().append(i),this.sortDirection*=-1,r.hasClass("sorting_asc")?r.removeClass("sorting_asc").addClass("sorting_desc"):r.removeClass("sorting_desc").addClass("sorting_asc")},reserve:function(t){t.stopPropagation();var n=this,r=e(t.currentTarget).parent().parent(),i=this.assetId,s=r.data("id"),u=r.data("name"),a=new o;a.setUrlPart("reservation"),a.setAssetId(i),a.fetch({success:function(e){e.length>0?n.showReservationLayer(s,u,e.toJSON(),r):n.reserveAssetItem(s,u,e.toJSON(),r)}})},showReservationLayer:function(r,s,o,u){function d(i){var o=e(i).find("form[name=form-reserv]").serializeArray(),u=[],a=!0;t.each(o,function(t){var r=e(i).find("input[name="+t.name+"]"),s=t.name.split("_"),o=s[1],f=t.value;if(f.length<1||f.length>255){e.goError(n.i18n(p.alert_length,{arg1:"1",arg2:"255"}),r),r.addClass("enter error"),a=!1;return}u.push({attributeId:o,content:f})},this),a&&this.reserveAssetItem(r,s,u,c).done(function(){h.close()})}var a=this,l=i.compile(f),c=u,h;h=e.goPopup({header:s,pclass:"layer_normal layer_reser",contents:l.render({attributes:o}),buttons:[{btext:p.confirm,btype:"confirm",autoclose:!1,callback:t.bind(d,this)},{btext:p.cancel,btyle:"cancel"}]}),e(h).on("submit","form[name=form-reserv]",function(e){e.preventDefault(),d.call(a,h)})},reserveAssetItem:function(t,r,i,o){var u=this,a=e.Deferred(),f=o,l=!1,c=new s({assetId:this.assetId,itemId:t,itemName:r,type:"reserve",startTime:n.util.toISO8601(this.startTime),endTime:n.util.toISO8601(this.endTime)});return typeof i!="undefined"&&c.set("properties",i),f.hide(),e.each(d,function(e){r==d[0].get("itemName")&&(l=!0)}),l||d.push(c),u.triggerReservedItem(c),a.resolve(),a},triggerReservedItem:function(e){this.$el.trigger("asset-item:reserved",[e.toJSON()])}}),S=r.View.extend({className:"flexable_box asset-reservation",assetId:0,startTime:new Date,endTime:new Date,listView:null,nameTagView:null,events:{"click .ic_openbox":"openFolder","click .ic_closebox":"closeFolder"},initialize:function(t){this.options=t||{},this.listView=null,this.nameTagView=null,this.assetId=this.model.id,this.assetStartTime=this.model.get("startTime"),this.assetEndTime=this.model.get("endTime")=="2400"?"2359":this.model.get("endTime"),this.startTime=n.util.toISO8601(this.options.startTime),this.endTime=n.util.toISO8601(this.options.endTime),this.eventId=this.options.eventId||null,this.allday=this.options.allday||!1,this.availableItems=new w,this.availableItems.setAssetId(this.assetId),this.availableItems.setAssetStartTime(this.assetStartTime),this.availableItems.setAssetEndTime(this.assetEndTime),this.setStartTime(this.startTime),this.setEndTime(this.endTime),this.$el.data("asset-id",this.model.id),this.$el.on("asset-item:reserved",e.proxy(function(e,t){this.addNameTag(t.id,t.itemName)},this))},render:function(){var t=this,n=i.compile(u),r=this.model.get("name");if(this.model.get("otherCompany")){var s=this.model.get("companyName")||"";r=s+" "+r}this.$el.append(n.render({asset_name:r,label:{close:p.close,open:p.open}})),this.nameTagView||(this.nameTagView=h.create(),this.$el.find(".wrap_name_tag").append(this.nameTagView.el),this.nameTagView.$el.on("nametag:removed",e.proxy(this.removeAssetItem,t))),this.$el.data("asset-view",this)},setStartTime:function(e){return this.allday&&(e=n.util.toISO8601(n.util.toMoment(e.split("T")[0]+" "+this.assetStartTime.substring(0,2)+":"+this.assetStartTime.substring(2,4),"YYYY-MM-DD HH:mm"))),this.startTime=e,this.availableItems.setStartTime(this.startTime),this},setEndTime:function(e){return this.allday&&(e=n.util.toISO8601(n.util.toMoment(e.split("T")[0]+" "+this.assetEndTime.substring(0,2)+":"+this.assetEndTime.substring(2,4),"YYYY-MM-DD HH:mm"))),this.endTime=e,this.availableItems.setEndTime(this.endTime),this},changeTime:function(e,t,r){r&&(e=e.split("T")[0]+"T"+this.assetStartTime.substring(0,2)+":"+this.assetStartTime.substring(2,4),t=t.split("T")[0]+"T"+this.assetEndTime.substring(0,2)+":"+this.assetEndTime.substring(2,4));var i=this.startTime!==n.util.toISO8601(e)||this.endTime!==n.util.toISO8601(t);i&&(this.setStartTime(n.util.toISO8601(e)).setEndTime(n.util.toISO8601(t)),this.loadItems(!0))},loadItems:function(n,r){var i=this;if(!this.listView||n||!1)this.availableItems.setStartTime(i.startTime),this.availableItems.setEndTime(i.endTime),this.availableItems.fetch({success:function(n){i.listView||(i.listView=new E({assetId:i.assetId,collection:n}),i.$el.find(".flexable_content").empty().append(i.listView.el)),i.listView.setStartTime(i.startTime),i.listView.setEndTime(i.endTime),t.each(n.models,function(t,n){t&&e(".reserved-asset-item").each(function(n,r){var i=t.get("name")||{};e(r).find(".name").text()==i&&t.trigger("destroy",t)})}),i.listView.render()}})},addNameTag:function(t,n,r,i){var s={removable:!0,onCreate:function(t){e(t).addClass("reserved-asset-item")},itemIsMine:i};t&&(s.onDelete=function(t,n){var r=e.Deferred();return e.goConfirm("",c["\uce98\ub9b0\ub354 \uc608\uc57d \uc790\uc0b0 \ucde8\uc18c \uc548\ub0b4"],function(){r.resolve()},function(){r.reject()}),r.promise()}),this.nameTagView.addTag(t,n,s,r)},removeAssetItem:function(t,r,i){var s=this,o=e(i).data("user"),u=e(i).find(".name").text();o&&(e.isArray(o)||(o=[o]),e.ajax({url:n.config("contextRoot")+"api/asset/item/reservation",contentType:"application/json",dataType:"json",data:JSON.stringify({ids:o}),type:"DELETE",success:function(){s.$el.trigger("asset-item:destroy",o),s.loadItems(!0)},error:function(){console.log("Asset Reservation : error!"),s.loadItems(!0)}}));for(var a=0;a<d.length;a++)d[a].get("itemName")===u&&d.splice(a,1);$trs=e("tbody#data-assetItems").find("tr[data-assetid]"),$trs.each(function(t,n){var r=e(n).attr("data-name");r===u&&e(n).show()})},getReservedItems:function(){return this.nameTagView.getNameTagList()},openFolder:function(){this.$el.find(".foldable").show(),this.$el.find(".ic_openbox").removeClass("ic_openbox").addClass("ic_closebox"),this.loadItems()},closeFolder:function(){this.$el.find(".foldable").hide(),this.$el.find(".ic_closebox").removeClass("ic_closebox").addClass("ic_openbox")}});return{load:function(t,n,r,i,s,o){var u=e(t).children().length;if(i){var a=new b;a.setEventId(i),a.fetch({success:function(e){var i=e.groupBy(function(e){return e.get("assetId")});x(t,n,r,s,i)},fail:function(e){console.log(e)}})}else(u==0||!o)&&x(t,n,r,s,null,o)},cancelReservationAll:k,resetAssetItemList:C,getForReserveAssetItems:N}})})();