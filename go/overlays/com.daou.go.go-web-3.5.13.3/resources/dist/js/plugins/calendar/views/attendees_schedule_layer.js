define("calendar/views/attendees_schedule_layer",function(require){var e=require("jquery"),t=require("underscore"),n=require("backbone"),r=require("hgn!calendar/templates/attendee_schedule_item"),i=require("hgn!calendar/templates/attendees_schedule_layer"),s=require("i18n!nls/commons"),o=require("i18n!calendar/nls/calendar");require("GO.util");var u={"\uc774\uc804":s["\uc774\uc804"],"\ub2e4\uc74c":s["\ub2e4\uc74c"],"\ub2eb\uae30":s["\ub2eb\uae30"],"\ucc38\uc11d\uc790 \uc77c\uc815":o["\ucc38\uc11d\uc790 \uc77c\uc815"],"\ucc38\uc11d\uc790 \uc77c\uc815 \uc870\ud68c":o["\ucc38\uc11d\uc790 \uc77c\uc815 \uc870\ud68c"],"\uc120\ud0dd\ub41c \ub0a0\uc9dc":o["\uc120\ud0dd\ub41c \ub0a0\uc9dc"],"\uc124\uc815\uc2dc\uac04":o["\uc124\uc815\uc2dc\uac04"],"\uc77c\uc815\uc788\uc74c":o["\uc77c\uc815\uc788\uc74c"],"\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \ucd5c\ub300 \uc778\uc6d0 \uc124\uba85":o["\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \ucd5c\ub300 \uc778\uc6d0 \uc124\uba85"],"\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \uc0c1\uc138\uc77c\uc815 \ud655\uc778\uc5ec\ubd80 \uc124\uba85":o["\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \uc0c1\uc138\uc77c\uc815 \ud655\uc778\uc5ec\ubd80 \uc124\uba85"],"\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \uae30\ub2a5 \uc0ac\uc6a9\uac00\ub2a5 \uc54c\ub9bc":o["\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \uae30\ub2a5 \uc0ac\uc6a9\uac00\ub2a5 \uc54c\ub9bc"],"\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \uae30\ub2a5 \uc885\uc77c\uc77c\uc815 \uc54c\ub9bc":o["\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \uae30\ub2a5 \uc885\uc77c\uc77c\uc815 \uc54c\ub9bc"]},a=50,f=50,l=32,c=30,h=60,p=26;return n.View.extend({events:{"click .att_schedule .ic_fold":"_onClickFrontRowBtn","click .att_schedule .ic_folded":"_onClickFrontRowBtn","click [data-attendees-route]":"_onChangeRoute","click [data-attendees-close-btn]":"_hideAttendeesCheckView","click [data-attendees-schedule-show-btn]":"_renderAttendeesCheckView"},unbindEvent:function(){e("#all_day").off("click")},bindEvent:function(){var t=this;e("#all_day").click(function(e){t.onChangeAllDay(e)})},initialize:function(e){this.unbindEvent(),this.bindEvent(),this.options=e||{},this.isCreateMode=t.isUndefined(this.options.model),this.model=this.options.model||{},this.initAttendees=this.options.attendees||{},this.initStartDate=this.options.startDate||GO.util.now(),this.isCreateMode||(this.initStartDate=this.model.isAllday()?GO.util.dateFormatWithoutTimeZone(this.model.get("startTime")):GO.util.toMoment(this.model.get("startTime")).format("YYYY-MM-DD"),this.initAttendees=this._getAttendeesByTag()),this.isAllDay=this.isCreateMode?!1:this.model.isAllday()},render:function(t){var n=e("#startDate").val()||this.initStartDate,t=t||this.initAttendees;return this.$el.html(i({lang:u,isAllDay:this.isAllDay,selectedDate:GO.util.toMoment(n).format("YYYYMMDD"),displayDate:GO.util.toMoment(n).format("MM\uc6d4 DD\uc77c")})),this.addEventListener(t,GO.util.toMoment(n).format("YYYYMMDD")),this._renderingSelectBar(),this},_renderAttendeesCheckView:function(){this.render(this._getAttendeesByTag())},_refreshAttendeesCheckView:function(e){this.onChangeSelectedDate(e),this.refreshEventListener(GO.util.toMoment(e).format("YYYYMMDD")),this._renderingSelectBar()},_renderingSelectBar:function(){if(!GO.util.isSameDate(e("#startDate").val(),e("#endDate").val())||e("#all_day").is(":checked"))return this.$el.find("[data-set-time]").hide(),!1;this.$el.find("[data-set-time]").show();var n=e("#startTime").val(),r=e("#endTime").val(),i=n.split(":"),s=r.split(":"),o=Number(i[0].trim()),u=Number(i[1].trim()),a=0,d=0;this._isFolding()?t.contains([8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],o)?(a=(o-7)*100,30<=u&&(a+=f)):t.contains([20,21,22,23],o)&&(a=1200):(a=o*100,30<=u&&(a+=f)),this._isFolding()&&a>=1300?a=1200:!this._isFolding()&&a>=2400&&(a=2300);if(n===r)d=a-100;else{var v=Number(s[0].trim()),m=Number(s[1].trim()),g=0;if(this._isFolding()&&t.contains([0,1,2,3,4,5,6,7],o))t.contains([0,1,2,3,4,5,6,7],v)?g=h:(g=(v-7)*h,0<m&&m<=30?g+=c:30<m&&(g+=h));else if(this._isFolding()&&t.contains([20,21,22,23],v))t.contains([20,21,22,23],o)?g=h:(g=(20-o)*h,30<=u&&(g-=c));else{var y=0;m>=u?g+=m-u:(y=1,g+=h+m-u),g+=(v-o-y)*h;var b=g%c;b===0&&!t.contains([0,30],m)&&(g+=c)}var w=g>0?Math.ceil(g/c):0;d=-a,w===1?d+=f:w>2?this._isFolding()&&w>p?d-=(p-2)*f:d-=(w-2)*f:w===0&&(d+=(w+2)*f)}this.$el.find("[data-set-time]").css({left:a+"%",right:d+"%",height:this._getAttendeeCheckedCount()*l+"px"})},_updateHeightSelectBar:function(){this.$el.find("[data-set-time]").css({height:this._getAttendeeCheckedCount()*l+"px"}),this.$el.find("[data-attendees-selected-time]").css({height:this._getAttendeeCheckedCount()*l+"px"})},onChangeDate:function(){console.info("attendees_schedule_layer onChangeDate");if(!this._isShowScheduleView())return!1;(GO.util.isSameDate(e("#startDate").val(),e("#endDate").val())||!GO.util.isSameDate(e("#startDate").val(),e("[data-attendees-selected-date]").attr("data-value")))&&this._refreshAttendeesCheckView(e("#startDate").val()),this._renderingSelectBar()},onChangeTime:function(e){console.info("attendees_schedule_layer onChangeTime");if(!this._isShowScheduleView())return!1;this._renderingSelectBar()},onChangeAllDay:function(){console.info("attendees_schedule_layer onChangeAllDay isAllDay: "+e("#all_day").is(":checked")),this.isAllDay=e("#all_day").is(":checked"),this.isAllDay?(this._hideAttendeesCheckView(),this._showCheckedAllDayDescView()):this._renderAttendeesCheckView()},_onChangeRoute:function(t){console.info("attendees_schedule_layer _onChangeRoute");var n=e(t.currentTarget).attr("data-attendees-route"),r=e("[data-attendees-selected-date]").attr("data-value"),i;n==="previous"?i=GO.util.toMoment(r).add("days",-1):n==="next"&&(i=GO.util.toMoment(r).add("days",1)),this._refreshAttendeesCheckView(i)},_onClickFrontRowBtn:function(t){var n=this.$el.find("[data-untime-btn]");e(t.currentTarget).prop("class")==="ic_folded"?(e("[data-untime]").removeClass("untime"),e("[data-untime-0]").text("0"),e("[data-untime-19]").text("19"),n.removeClass("ic_folded").addClass("ic_fold"),n.attr("data-is-folding",!1)):(e("[data-untime]").addClass("untime"),e("[data-untime-0]").text("0 ~"),e("[data-untime-19]").text("19 ~"),n.removeClass("ic_fold").addClass("ic_folded"),n.attr("data-is-folding",!0)),this._renderingSelectBar()},onChangeSelectedDate:function(t){console.info("attendees_schedule_layer onChangeSelectedDate");var n=GO.util.toMoment(t||e("#startDate").val()),r=this.$el.find("[data-attendees-selected-date]");r.attr("data-value",n.format("YYYYMMDD")),r.text(n.format("MM\uc6d4 DD\uc77c"))},addEventListener:function(e){console.info("attendees_schedule_layer addEventListener");if(t.isUndefined(e)||t.isNull(e))return!1;if(t.isArray(e)&&e.length===0)return!1;t.isArray(e)||(e=[e]);var n=this.$el.find("[data-attendees-selected-date]").attr("data-value")||GO.util.toMoment(GO.util.now()).format("YYYYMMDD");this._getScheduleAndRendingRow(e,n)},refreshEventListener:function(e){console.info("attendees_schedule_layer refreshEventListener selectedDate: "+e);var t=this._getAttendeesBySchedule(),e=e||this.$el.find("[data-attendees-selected-date]").attr("data-value");this._getScheduleAndRendingRow(t,e,!0)},_getScheduleAndRendingRow:function(t,n,r){console.info("attendees_schedule_layer _getScheduleAndRendingRow selectedDate: "+n);var i=this;e.ajax({url:"/api/calendar/attendees/schedules?"+this._getParams(t,n),type:"GET",async:!0,contentType:"application/json"}).done(function(e){var n=[];e.code==="200"&&(n=e.data),r?i._refreshRowByAttendee(n):i._renderingRowByAttendee(t,n)}).fail(function(){console.info("attendees  schedules data get error")})},_getParams:function(e,n){var r=[];return t.each(e,function(e,t){t<a&&r.push("userIds="+e.id)}),"checkDate="+n+"&"+r.join("&")},removeEventListener:function(n){console.info("attendees_schedule_layer removeEventListener");var r=this.$el.find("[data-attendees-users-id-"+n+"]"),i=r.length>0||!1;if(!i)return!1;r.remove();var s=e("#attendee-list").find("#attendee-"+this.$el.find("[data-attendees-users]:last").attr("data-user-id")).next().attr("data-id");t.isUndefined(s)||this.addEventListener(this._getAttendeesByTag(s)),this._updateHeightSelectBar()},_refreshRowByAttendee:function(e){console.info("attendees_schedule_layer _refreshRowByAttendee"),t.each(e,function(e){var t=this.$el.find("[data-attendees-users-id-"+e.userId+"]");t.find("[data-attendees-tr]").empty(),t.find("[data-attendees-tr]").append(this._renderingTime(e.scheduleModels))},this),this._updateHeightSelectBar()},_renderingRowByAttendee:function(n,i){console.info("attendees_schedule_layer _renderingRowByAttendee");var s=a-this._getAttendeeCheckedCount();if(s<=0)return!1;var o=s>n.length?n.length:s,u=0;for(var f=0;u<o;f++){var l=this.$el.find("[data-attendees-users-id-"+n[f].id+"]"),c=t.find(i,function(e){return n[f].id==e.userId});l.length>0?(l.find("[data-attendees-tr]").empty(),l.find("[data-attendees-tr]").append(this._renderingTime(c.scheduleModels))):(e("[data-attendees-schedule-user-contents]").append(r({userId:n[f].id,name:n[f].name})),this.$el.find("[data-attendees-users-id-"+n[f].id+"]").find("[data-attendees-tr]").append(this._renderingTime(c.scheduleModels)),u++)}this._updateHeightSelectBar()},_renderingTime:function(e){var n=!1;for(var r in e)if(e[r].timeType==="allday"){n=!0;break}var i="";for(var s=0;s<24;s++){t.contains([1,2,3,4,5,6,7,20,21,22,23],s)?i+=this._isFolding()?'<td class="untime" data-untime>':"<td data-untime>":i+="<td>";var o=GO.util.numberPad(s,2),u=!1,a=!1;for(var f=0;f<e.length;f++){var l=GO.util.toMoment(e[f].targetStartTime).get("hour"),c=GO.util.toMoment(e[f].targetEndTime).get("hour"),h=GO.util.toMoment(e[f].targetEndTime).get("minute");this._isFolding()&&(s===0?l<=7&&(u=!0,a=!0):s===19&&19<l&&(a=!0,u=!0));if(s==l){a=!0;var p=GO.util.toMoment(e[f].targetStartTime).get("minute");p<30&&(u=!0)}else l<s&&s<c?(u=!0,a=!0):s==c&&(0<h&&(u=!0),31<h&&(a=!0))}i+='<div class="txt oclock '+(n||u?"busy":"")+'">'+o+":00"+"</div>",i+='<div class="txt halfhour '+(n||a?"busy":"")+'">'+o+":30"+"</div></td>"}return i},_showCheckedAllDayDescView:function(){this.$el.find("[data-attendees-schedule-show-desc]").text(u["\ucc38\uc11d\uc790 \uc77c\uc815\ud655\uc778 \uae30\ub2a5 \uc885\uc77c\uc77c\uc815 \uc54c\ub9bc"]),this.$el.find("[data-attendees-schedule-show-btn]").remove()},_hideAttendeesCheckView:function(e){this.$el.find("[data-attendees-schedule-content]").remove(),this.$el.find("[data-attendees-notice-el]").show()},_isShowScheduleView:function(){return this.$el.find("[data-attendees-schedule-content]").length>0},_isFolding:function(){return this.$el.find("[data-untime-btn]").attr("data-is-folding")==="true"||!1},_getAttendeesByTag:function(n){var r=e("#attendee-list").find("li:not([data-button])"),i=new Array;if(!t.isUndefined(n)){var s=e(t.find(r,function(t){var r=e(t);return r.attr("data-id")==n}));return i.push({id:s.attr("data-id"),name:s.attr("data-name")}),i}var o=this._getAttendeeTagCount();for(var u=0;u<o&&u<a;u++){var s=e(r[u]);i.push({id:s.attr("data-id"),name:s.attr("data-name")})}return i},_getAttendeesBySchedule:function(){var t=e("[data-attendees-schedule-user-contents]").find("[data-attendees-users]"),n=new Array,r=this._getAttendeeCheckedCount();for(var i=0;i<r;i++){var s=e(t[i]);n.push({id:s.attr("data-user-id"),name:s.attr("[data-user-id]")})}return n},_getAttendeeTagCount:function(){return e("#attendee-list").find("li:not([data-button])").length||0},_getAttendeeCheckedCount:function(){var t=e("[data-attendees-schedule-user-contents]").find("[data-attendees-users]").length||0;return t>a?a:t}})});