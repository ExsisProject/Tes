(function(){define(["backbone","calendar/collections/calendars","hgn!calendar/templates/preference/calendar","hgn!calendar/templates/preference/_calendar_list","i18n!nls/commons","i18n!calendar/nls/calendar","calendar/libs/util","jquery.go-popup"],function(e,t,n,r,i,s,o){function f(e){var t=o.getSavedSelectedCalendar().split(",");o.saveCheckedCalendar(_.difference(t,e))}function l(){return this.$el.find(".calendar-list tbody").hasClass("ui-sortable")}function c(){var e=this,t=this.$el.find(".calendar-list tbody");this.$el.find(".btn-reorder .txt").text(i["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"]),this.$el.find(".btn-remove").hide(),u.lock(),t.sortable({items:"tr",axis:"y",hoverClass:"ui-state-hover",start:function(e,t){},stop:function(t,n){var r=n.item.find("input[name=calendar_id]").val(),i;h.call(e),i=e.collection.get(r),i.move()}}),t.disableSelection()}function h(){var e=this;this.$el.find(".calendar-list tbody tr").each(function(t,n){var r=$(n).find("input[name=calendar_id]").val(),i=e.collection.get(r);i.set({seq:t},{silent:!0})}),this.collection.sort()}function p(){var e=this.$el.find(".calendar-list tbody");this.$el.find(".btn-reorder .txt").text(i["\uc21c\uc11c\ubc14\uafb8\uae30"]),this.$el.find(".btn-remove").show(),u.unlock(),e.sortable("destroy"),e.enableSelection()}function d(e){return!(e.filter(":not(:checked)").length>0)}function v(){$.goSlideMessage(s["\uce98\ub9b0\ub354 \uc218\uc815\uc694\uccad \uc9c4\ud589\uc911 \uba54\uc2dc\uc9c0"],"caution")}function m(e,t){var n=this,r=$.Deferred(),i=this.collection.get(e);return u.isLock()?(v(),r):(u.lock(),i.save(t,{success:function(e){$.goSlideMessage(s["\uce98\ub9b0\ub354 \uc218\uc815\uc644\ub8cc \uba54\uc2dc\uc9c0"]),n.reloadList(),u.unlock(),r.resolve(e)},error:r.reject}),r)}function g(e,t){var n=[];return n.push('<form name="form-edit-calname">'),n.push('<span class="wrap_txt">'),n.push('<input type="hidden" name="calendar_id" value="'+e+'" />'),n.push('<input type="text" name="calendar_name" value="'+t+'" class="txt wfix_large" />'),n.push('<a class="btn-submit btn_fn10" href="#" data-bypass>'+i["\ubcc0\uacbd"]+"</a>"),n.push("</span>"),n.push("</form>"),n.join("\n")}function y(e){e.find(".go_error").remove(),e.find(".enter.error").removeClass("enter error")}function b(e,t){t=t||e,$.goError(GO.i18n(i["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:1,arg2:32}),t),e.addClass("enter error"),u.unlock()}function w(e){var t=e.length;return t<1||t>=33?!1:$.goValidation.containsInvalidFileNameCharacter(e)?($.goError(GO.i18n(i["\ud30c\uc77c\uba85 \ud2b9\uc218 \ubb38\uc790 \ubd88\uac00"])),!1):!0}function E(){var e=$.Deferred();return this.collection.length>0?e.resolve(this.collection):this.collection.fetch({success:e.resolve,error:e.reject}),e}function S(e){return r({calendar_id:e.id,tag:C(e),calendar_name:e.getCalendarName(),"default?":e.isDefault(),"public?":e.isPublic(),"protected?":e.isProtected(),"private?":e.isPrivate(),label:{visibility_public:i["\uacf5\uac1c"],visibility_protected:s["\uc218\ub77d \ud6c4 \uacf5\uac1c"],visibility_private:i["\ube44\uacf5\uac1c"]}})}function x(){E.call(this).then(_.bind(T,this))}function T(e){var t=this.$el.find(".calendar-list > tbody"),n=[];e||(e=this.collection),e.each(function(e){e.isMyCalendar()&&n.push(S(e))}),t.append(n.join("\n"))}function N(e){return e?' selected="selected"':""}function C(e){return e.isDefault()?s["\uae30\ubcf8 \uce98\ub9b0\ub354 \ud45c\uc2dc"]:""}var u={__state__:!1,init:function(){this.unlock()},lock:function(){this.__state__=!0},unlock:function(){this.__state__=!1},isLock:function(){return this.__state__}},a=e.View.extend({id:"calendar-config-pane",className:"calendar-config tab_conent_wrap",events:{"submit #form-add-mycal":"_reqAddCalendar","click #form-add-mycal .btn-submit":"_reqAddCalendar","click .btn-remove":"_reqRemoveCalendars","click .btn-reorder":"_toggleSortable","click .calendar-name":"_setEditNameMode","submit form[name=form-edit-calname]":"_reqUpdateCalendarName","click form[name=form-edit-calname] .btn-submit":"_reqUpdateCalendarName","click .calendar-list input[name=is_default]":"_reqDefaultCalendar","change .calendar-list select[name=visibility]":"_reqUpdateVisibility","click .calendar-list input[type=checkbox][name=calendar_id]":"_setAllCheckedState","click input.check-all":"_checkAllCalendars","click #btn-gotocal":"_goToCal"},initialize:function(e){this.collection||(this.collection=t.create()),this.$el.attr("data-type","calendar"),this.$el.hide(),u.init(),this.listenTo(this.collection,"add",_.bind(this.addListRow,this)),this.listenTo(this.collection,"remove",_.bind(this.reloadList,this)),this.listenTo(this.collection,"reset",_.bind(this.reloadList,this))},render:function(){this.$el.append(n({label:{save:i["\uc800\uc7a5"],"delete":i["\uc0ad\uc81c"],go_to_calendar:s["\uce98\ub9b0\ub354\ub85c \ub3cc\uc544\uac00\uae30"],calendar_name:s["\uce98\ub9b0\ub354 \uc774\ub984"],calendar:i["\uce98\ub9b0\ub354"],add_calendar:i["\ucd94\uac00"],default_calendar:s["\uae30\ubcf8 \uce98\ub9b0\ub354"],visibility_state:s["\uacf5\uac1c \uc0c1\ud0dc"],reorder:i["\uc21c\uc11c\ubc14\uafb8\uae30"],editable:i["\uc218\uc815"]}})),x.call(this)},reloadList:function(){this.$el.find(".calendar-list > tbody").empty(),T.call(this)},activate:function(e){e==="calendar"?this.$el.show():this.$el.hide()},addListRow:function(e){this.$el.find(".calendar-list > tbody").append(S(e))},_reqAddCalendar:function(e){var t=this.$el.find("#form-add-mycal"),n=t.find("input[name=calendar_name]"),r=n.val();if(u.isLock()){v();return}e.preventDefault(),u.lock(),y(t),w(r)?this.collection.create({name:r},{wait:!0,success:function(){n.val(""),u.unlock()}}):b(n,t.find(".wrap_txt"))},_reqRemoveCalendars:function(e){var t=this,n=this.$el.find("input[type=checkbox][name=calendar_id]:checked"),r=[];if(u.isLock()){v();return}u.lock(),n.length>0?(n.each(function(e,t){r.push($(t).val())}),$.ajax({url:GO.config("contextRoot")+"api/calendar",type:"DELETE",data:JSON.stringify({ids:r}),dataType:"json",contentType:"application/json"}).then(function(e){t.collection.remove(r),f(r),u.unlock()})):$.goSlideMessage(s["\uc0ad\uc81c \uce98\ub9b0\ub354 \uc120\ud0dd\uc624\ub958 \uba54\uc2dc\uc9c0"],"caution")},_toggleSortable:function(e){l.call(this)?p.call(this):c.call(this)},_setEditNameMode:function(e){var t=$(e.currentTarget),n=t.data("id"),r=t.data("name");t.hide(),t.parent().append(g(n,r))},_reqUpdateCalendarName:function(e){var t=this,n=$(e.currentTarget),r=n.is("form")?n:n.closest("form"),i=r.find('input[name="calendar_id"]').val(),s=r.find('input[name="calendar_name"]').val();e.preventDefault(),w(s)&&m.call(t,i,{name:s}).then(function(){r.remove()})},_reqDefaultCalendar:function(e){var t=this,n=$(e.currentTarget),r=n.data("id");if(u.isLock()){v();return}u.lock(),this.collection.setDefaultCalendar(r).then(function(){$.goSlideMessage(s["\uce98\ub9b0\ub354 \uc218\uc815\uc644\ub8cc \uba54\uc2dc\uc9c0"]),t.reloadList(),u.unlock()})},_reqUpdateVisibility:function(e){var t=$(e.currentTarget),n=t.val(),r=t.data("id");e.preventDefault(),m.call(this,r,{visibility:n})},_setAllCheckedState:function(e){var t=this.$el.find("input.check-all"),n=this.$el.find(".calendar-list input[type=checkbox][name=calendar_id]");t.prop("checked",d(n))},_checkAllCalendars:function(e){var t=this.$el.find("input.check-all"),n=this.$el.find(".calendar-list input[name=calendar_id]");n.prop("checked",t.is(":checked"))},_goToCal:function(e){GO.router.navigate("calendar",{trigger:!0,pushState:!0})}});return a})})();