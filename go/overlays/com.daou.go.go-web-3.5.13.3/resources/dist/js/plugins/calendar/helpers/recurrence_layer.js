(function(){define(["jquery","underscore","hogan","moment","calendar/libs/recurrence_parser","asset/collections/asset_unreserved_date_list","text!calendar/templates/_recurrence_content.html","text!calendar/templates/_recurrence_tab.html","i18n!nls/commons","i18n!calendar/nls/calendar","i18n!asset/nls/asset","jquery.go-popup","jquery.ui"],function(e,t,n,r,i,s,o,u,a,f,l){function T(e){var t=[];for(var n=1;n<31;n++)t.push('<option value="'+n+'"'),n===parseInt(e)&&t.push(' selected="selected"'),t.push(">"+n+"</option>"+"\n");return t.join("")}var c={sun:f["\uc77c\uc694\uc77c"],mon:f["\uc6d4\uc694\uc77c"],tue:f["\ud654\uc694\uc77c"],wed:f["\uc218\uc694\uc77c"],thu:f["\ubaa9\uc694\uc77c"],fri:f["\uae08\uc694\uc77c"],sat:f["\ud1a0\uc694\uc77c"]},h={sun:f["\uc77c"],mon:f["\uc6d4"],tue:f["\ud654"],wed:f["\uc218"],thu:f["\ubaa9"],fri:f["\uae08"],sat:f["\ud1a0"]},p={sun:"SU",mon:"MO",tue:"TU",wed:"WE",thu:"TH",fri:"FR",sat:"SA"},d={DAILY:f["\uc77c\ub9c8\ub2e4"],WEEKLY:f["\uc8fc\ub9c8\ub2e4"],MONTHLY:f["\uc6d4\ub9c8\ub2e4"],YEARLY:f["\ub144\ub9c8\ub2e4"]},v=1,m=30,g=1,y=1e16,b='<span class="horspace1"></span>',w=n.compile(u),E=n.compile(o),S,x={everyday:f["\ub9e4\uc77c"],everyweek:f["\ub9e4\uc8fc"],everymonth:f["\ub9e4\uc6d4"],everyyear:f["\ub9e4\ub144"],per_date:f["\uc77c\ub9c8\ub2e4"],start_date:f["\uc2dc\uc791\uc77c"],recurrence:f["\ubc18\ubcf5"],end_recurrence:f["\ubc18\ubcf5\uc885\ub8cc"],recurence_count:f["\ud68c \ubc18\ubcf5"],infinit_recurrence:f["\ubb34\ud55c\ubc18\ubcf5"],dates:l["\uc608\uc57d\ubd88\uac00 \uc77c\uc790"]};return S=function(){var o=function(n,r,s,o,u){t.isEmpty(u)?this.repeatCount=m:(this.repeatCount=u.attributes.limitRecurrence==="NOT_USE"?m:u.attributes.limitRecurrenceCount,this.itemModel=u),t.isEmpty(s)&&(s="COUNT="+(this.repeatCount?this.repeatCount:m)),this.hasUnreservedDate=!1,this.popupEl=null,this.startDate=GO.util.toMoment(n),this.templates={},this.recurrenceCode=s||"",this.day=o,this.callbacks={confirm:{func:function(){},context:this},cancel:{func:function(){},context:this},close:{func:function(){},context:this}},e.datepicker.setDefaults(e.datepicker.regional[GO.config("locale")]),this.recurrenceParser=new i,this._parseFromCode(this.recurrenceCode),this._prepareTemplates(r)};return o.prototype={render:function(t){return this.popupEl=e.goPopup({width:440,pclass:"layer_normal layer_repeat_schedule go_renew",headerHtml:this.templates.header,contents:this.templates.content,closeCallback:e.proxy(this._close,this),offset:t,modal:!0,buttons:[{btype:"confirm",btext:a["\ud655\uc778"],callback:e.proxy(this._confirm,this),autoclose:!1},{btype:"cancel",btext:a["\ucde8\uc18c"],callback:e.proxy(this._cancel,this)}]}),this.undelegateEvents(),this.delegateEvents(),this._bindDatepicker(),this._setRecurrencePeriodOptions(this.recurrenceParser.get("FREQ")),this._generateRecurrenceText(),this._resetFocus(),this.popupEl},delegateEvents:function(){this.popupEl.on("click.recurrence","ul.tab_nav li",e.proxy(this._changeTab,this)),this.popupEl.on("click.recurrence","input[type=radio][name^=repeat_]",e.proxy(this._changeRepeatType,this)),this.popupEl.on("change.recurrence","input[name=repeat_date]",e.proxy(this._generateRecurrenceText,this)),this.popupEl.on("change.recurrence","input[name=repeat_date]",e.proxy(this._assetValidateYear,this)),this.popupEl.on("change.recurrence","select[name=recurrence_interval]",e.proxy(this._changeInterval,this)),this.popupEl.on("keyup.recurrence","input[name=repeat_count]",t.isEmpty(this.itemModel)?e.proxy(this._validateRepeatCount,this):e.proxy(this._assetValidateCount,this)),this.popupEl.on("blur.recurrence","input[name=repeat_count]",t.isEmpty(this.itemModel)?e.proxy(this._validateRepeatCount,this):e.proxy(this._assetValidateCount,this)),this.popupEl.on("click.recurrence","input[type=checkbox][name^=week_byday_]",e.proxy(this._generateRecurrenceText,this)),this.popupEl.on("click.recurrence","#date-of-startdate",e.proxy(this._generateRecurrenceText,this)),this.popupEl.on("click.recurrence","#weekday-of-startdate",e.proxy(this._generateRecurrenceText,this))},undelegateEvents:function(){this.popupEl.off(".recurrence")},setConfirmCallback:function(e,t){return this._setCallback("confirm",e,t)},setCancelCallback:function(e,t){return this._setCallback("cancel",e,t)},setCloseCallback:function(e,t){return this._setCallback("close",e,t)},getFreq:function(){return this.popupEl.find("ul.tab_nav li.on").attr("data-freq")},getIntervalElement:function(){return this.popupEl.find("select[name=recurrence_interval]")},getInterval:function(){var e=this.getIntervalElement().find("option:selected").val();return parseInt(e)>1?e:undefined},getRepeatCountElement:function(){return this.popupEl.find("input[type=text][name=repeat_count]")},getRepeatCount:function(){var e=this.getRepeatCountElement();return e.is(":disabled")?undefined:e.val()},getUntilDateElement:function(){return this.popupEl.find("input[type=text][name=repeat_date]")},getUntilDate:function(){var e=this.getUntilDateElement();return e.is(":disabled")||!e.val()?undefined:GO.util.toMoment(e.val()).format("YYYYMMDD")},getMonthdayPerMonth:function(){return this.popupEl.find("#date-of-startdate:checked").val()},getDayPerMonth:function(){return this.popupEl.find("#weekday-of-startdate:checked").val()},getWeekdayCheckboxElement:function(){return this.popupEl.find("input[type=checkbox][name^=week_byday_]:checked")},getWeekdayString:function(){var t=this.getWeekdayCheckboxElement(),n=[];return t.each(function(t,r){e(r).is(":checked")&&n.push(p[e(r).val()])}),n.length>0?n.join(","):undefined},getRecurrenceCode:function(){return this.recurrenceCode},_confirm:function(e){if(this._validate()){var t=this._getCallback("confirm");t.func.call(t.context,this.getRecurrenceCode(),this.recurrenceParser.humanize(),this.hasUnreservedDate),e.close()}return this},_validate:function(){return this.getFreq()==="WEEKLY"&&!this.getWeekdayCheckboxElement().length?(window.alert(f["\uc694\uc77c\uc744 \uc120\ud0dd\ud574\uc8fc\uc138\uc694"]),!1):!0},_cancel:function(){var e=this._getCallback("cancel");return e.func.call(e.context),this},_close:function(){var e=this._getCallback("close");return e.func.call(e.context),this},_getCallback:function(e){return this.callbacks[e]||{func:function(){},context:this}},_setCallback:function(e,n,r){return t.has(this.callbacks,e)||this.callbacks[e],this.callbacks[e].func=n,this.callbacks[e].context=r||this,this},_bindDatepicker:function(){this.getUntilDateElement().datepicker({yearSuffix:"",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,minDate:this.startDate.format("YYYY-MM-DD")})},_setRecurrencePeriodOptions:function(e){var n=this.popupEl.find(".tab-option"),r={WEEKLY:"_buildWeeklyPeriodOptTpl",MONTHLY:"_buildMonthlyPeriodOptTpl"}[e],i="";n.empty();if(!t.contains(["WEEKLY","MONTHLY"],e))return;return i=this[r].call(this),n.html(i),this},_isUnLimited:function(e){var t=this.itemModel.attributes.limitRecurrence;switch(e){case"COUNT":return t==="COUNT"||t==="NOT_USE";case"YEAR":return t==="YEAR"||t==="NOT_USE";case"NOT_USE":return t==="NOT_USE"||t==="NONE"}return!1},_prepareTemplates:function(e){var t=GO.constant("calendar","RECURRENCE_FREQ"),n=this.recurrenceParser.get("FREQ"),r=this.recurrenceParser.has("UNTIL"),i=this.recurrenceParser.has("COUNT"),s=e?!1:this._isUnLimited("YEAR"),o=e?!1:this._isUnLimited("COUNT"),u=e?!1:this._isUnLimited("NOT_USE"),a=new Date;return a.setFullYear(a.getFullYear()+this.repeatCount),this.templates.header=w.render({"is_freq_daily?":n===t.daily,"is_freq_weekly?":n===t.weekly,"is_freq_monthly?":n===t.monthly,"is_freq_yearly?":n===t.yearly,label:x}),this.templates.content=E.render({label:x,interval_options:T(this.recurrenceParser.has("INTERVAL")?this.recurrenceParser.get("INTERVAL"):1),interval:this.recurrenceParser.has("INTERVAL")?this.recurrenceParser.get("INTERVAL"):1,interval_postfix:d[this.recurrenceParser.get("FREQ")],start_date:this.startDate.format("YYYY-MM-DD"),"has_end_date?":r,end_date:r?GO.util.toMoment(this.recurrenceParser.get("UNTIL"),"YYYYMMDD").format("YYYY-MM-DD"):"","has_repeat_count?":i,repeat_count:i?this.recurrenceParser.get("COUNT"):"","is_infinite?":!r&&!i,"is_calendar?":e,dateOn:s,dateOnAttr:u?!1:s,countOn:o,countOnAttr:u?!0:o,init_date:u?"":GO.util.shortDate(a)}),this},_parseFromForm:function(){return console.log("[RecurrencLayer#_parseFromForm] converting...."),this.recurrenceParser.set("FREQ",this.getFreq()),this.recurrenceParser.set("INTERVAL",this.getInterval()),this.recurrenceParser.set("COUNT",this.getRepeatCount()),this.recurrenceParser.set("UNTIL",this.getUntilDate()),this.recurrenceParser.set("BYDAY",this.getWeekdayString()||this.getDayPerMonth()),this.recurrenceParser.set("BYMONTHDAY",this.getMonthdayPerMonth()),this.recurrenceCode=this.recurrenceParser.toString(),this.recurrenceCode},_parseFromCode:function(e){this.recurrenceParser.parse(e)},_changeInterval:function(t){var n=typeof t=="undefined"?e("select[name=recurrence_interval]"):e(t.target),r=n.find("option:selected").val();this._generateRecurrenceText()},_validateRepeatCount:function(t){var n=n=typeof t=="undefined"?e("input[name=repeat_count]"):e(t.target),r=n.val();r.length>0&&(!/^(\d)+$/.test(r)||parseInt(r)<g||parseInt(r)>y)&&n.val(this.repeatCount),this._generateRecurrenceText()},_generateRecurrenceText:function(){this._parseFromForm(),this.popupEl.find(".recurrence-text").html(x.recurrence+" : "+this.recurrenceParser.humanize()),this._getAssetUnreservedDates()},_assetValidateYear:function(){if(t.isEmpty(this.itemModel))return;var n=this.itemModel.attributes.limitRecurrence;if(n==="NOT_USE"||n!=="YEAR"){this._generateRecurrenceText();return}var r=new Date(e("input[name=repeat_date]").val()),i=new Date;i.setFullYear(i.getFullYear()+this.repeatCount),this._isExceedYear(r,i)&&(e("input[name=repeat_date]").val(GO.util.shortDate(i)),this._generateRecurrenceText(),e.goMessage(GO.i18n(l["\ubc18\ubcf5 \uc608\uc57d \uac00\ub2a5 \ucd5c\ub300 \uae30\uac04 0\ub144\uc744 \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4"],{count:this.repeatCount}))),this._generateRecurrenceText()},_isExceedYear:function(e,t){var n=r(e).clone(),i=r(t).clone();return i<n},_assetValidateCount:function(){if(t.isEmpty(this.itemModel))return;var n=e("input[name=repeat_count]").val();if(!this._validateCount(n)){e("input[name=repeat_count]").val(this.repeatCount),this._generateRecurrenceText();return}var r=this.itemModel.attributes.limitRecurrence;if(r==="NOT_USE"||r!=="COUNT"){this._generateRecurrenceText();return}n>this.repeatCount&&(e("input[name=repeat_count]").val(this.repeatCount),this._generateRecurrenceText(),e.goMessage(GO.i18n(l["\ubc18\ubcf5 \uc608\uc57d \ucd5c\ub300 \ud69f\uc218 0\ud68c\ub97c \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4"],{count:this.repeatCount}))),this._generateRecurrenceText()},_validateCount:function(e){return!(e.length>0&&(!/^(\d)+$/.test(e)||parseInt(e)<g))},_getAssetUnreservedDates:function(){if(t.isEmpty(this.itemModel))return;var n=e("#startDate").val(),r=e("#startTime").val(),i=e("#endDate").val(),o=e("#endTime").val(),u="YYYY-MM-DD HH:mm",a=GO.util.toISO8601(GO.util.toMoment(n+" "+r,u)),f=GO.util.toISO8601(GO.util.toMoment(i+" "+o,u)),l=s.getCollection({data:{assetItem:this.itemModel.itemId,recurrence:this.recurrenceParser.toString(),startTime:a,endTime:f}});t.isEmpty(l)?(this.hasUnreservedDate=!1,e("#unreserve-dates").addClass("dsp_none")):(e("#unreserve-dates").removeClass("dsp_none"),e("#dates").empty(),t.each(l,function(t){e("#dates").append("<li>"+t+"</li>")}),this.hasUnreservedDate=!0)},_changeRepeatType:function(t,n){var r=n||!0,i=t instanceof e.Event?e(t.target):e(t),s=i.val(),o=this.popupEl.find("input[type=text][name^=repeat_]"),u=this.popupEl.find("input[type=text][name=repeat_"+s+"]");r&&o.val(""),o.attr("disabled",!0),u.length>0&&(u.attr("disabled",!1),this._resetRepeatInputField(s)),this._generateRecurrenceText()},_resetRepeatInputField:function(e){var t={date:"_resetRepeatEndDate",count:"_resetRepeatCount",infinite:""}[e];return t&&t in this&&this[t].call(this),this},_resetRepeatEndDate:function(){console.log("[RecurrenceLayerHelper#_resetRepeatEndDate]");var e=this.startDate,t={},n="";return t[i.FREQ_DAILY]=e.clone().add("months",2),t[i.FREQ_WEEKLY]=e.clone().add("months",2),t[i.FREQ_MONTHLY]=e.clone().add("years",1),t[i.FREQ_YEARLY]=e.clone().add("years",5),n=t[this.recurrenceParser.get("FREQ")].format("YYYY-MM-DD"),this.getUntilDateElement().val(n),this},_resetRepeatCount:function(){return console.log("[RecurrenceLayerHelper#_resetRepeatCount]"),this.getRepeatCountElement().val(this.repeatCount),this},_changeTab:function(t){var n=e(t.currentTarget),r=n.attr("data-freq");if(n.hasClass("on"))return;this._resetFocus(),this._toggleTabs(r),this._changeIntervalPostfix(r),this._setRecurrencePeriodOptions(r),this._changeInterval()},_resetFocus:function(){return this.getUntilDateElement().blur(),this.getIntervalElement().focus(),this},_changeIntervalPostfix:function(e){this.popupEl.find("#recurrence-interval-postfix").text(d[e])},_toggleTabs:function(t){var n="div.go_popup ul.tab_nav li";e(n).removeClass("on"),e(n).each(function(n,r){e(r).attr("data-freq")===t&&e(r).addClass("on")})},_buildWeeklyPeriodOptTpl:function(){var e=[],r="",i=this.startDate.day();return r=n.compile(['<span class="wrap_option">','<input id="week-byday-{{code}}" name="week_byday_{{code}}" type="checkbox" value="{{code}}"{{#checked?}} checked="checked"{{/checked?}}>','<label for="week-byday-{{code}}">{{label}}</label>',"</span>"].join("\n")),t.each(t.pairs(h),function(n,s){var o="",u=!1;if(this.recurrenceParser.get("BYDAY")){var a=new RegExp(p[n[0]]);t.isUndefined(this.day)?u=a.test(this.recurrenceParser.get("BYDAY")):s==i?u=!0:u=!1}else u=i===s;o=r.render({code:n[0],label:n[1],"checked?":u}),e.push(o)},this),e.join(b)},_buildMonthlyPeriodOptTpl:function(){var e="",r="",i=this.startDate.format("D"),s=GO.util.getNthDayOfMonth(this.startDate),o=t.values(p)[this.startDate.day()],u=t.values(c)[this.startDate.day()];return r=n.compile(['<span class="wrap_option">','<input id="date-of-startdate" name="month_byday" type="radio" value="{{dateOfstartDate}}"{{#date_checked?}} checked="checked"{{/date_checked?}}>','<label for="date-of-startdate">{{label.date_of_startdate}}</label>',"</span>",b,'<span class="wrap_option">','<input id="weekday-of-startdate" name="month_byday" type="radio" value="{{weekday_code}}"{{#weekday_checked?}} checked="checked"{{/weekday_checked?}}>','<label for="weekday-of-startdate">{{label.nth_weekday}}</label>',"</span>"].join("\n")),e=r.render({dateOfstartDate:i,"date_checked?":this.recurrenceParser.has("BYMONTHDAY"),weekday_code:s+o,"weekday_checked?":this.recurrenceParser.has("BYDAY"),label:{date_of_startdate:GO.i18n(f["{{monthday}}\uc77c"],"monthday",i),nth_weekday:GO.i18n(f["{{nth}}\ubc88\uc9f8 {{weekday}}"],{nth:s,weekday:u})}}),e}},o}(),S})}).call();