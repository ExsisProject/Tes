(function(){define(["underscore","app","calendar/models/calendar"],function(e,t,n){var r=t.BaseCollection.prototype,i=t.BaseCollection.extend({model:n,url:function(){if(this.userId<0)throw new Error("Invalid user id");return["/api/calendar/user/",this.userId,"/calendar"].join("")},isHide:!1,userId:-1,__needFetch__:!1,initialize:function(){},comparator:"seq",isValid:function(){return this.__needFetch__?!1:this.length<=0?!1:!0},setUserId:function(e){return e!==this.userId&&(this.__needFetch__=!0),this.userId=e,this},getMyCalendars:function(){return this.getTypedCalendars("normal")},getUserCalendars:function(){return this.filter(function(t){return e.contains(["normal","holiday"],t.get("type"))})},getNewCompanyCalendarIds:function(){var t=[];return e.each(this.models,function(e){e.get("newCompanyCalendar")&&t.push(e.get("id"))}),t},getCompanyCalendars:function(){return this.getTypedCalendars("company")},getHolidayCalendars:function(){return this.getTypedCalendars("holiday")},getTypedCalendars:function(e){return this.filter(function(t){return t.get("type")===e})},isCalendarManager:function(){var e=this.getWritableCompanyCalendars();return e.length>0},getWritableCompanyCalendars:function(){var e=this.filter(function(e){return e.get("type")==="company"&&e.get("permission")===!0});return e},_reset:function(){r._reset.call(this),this.__needFetch__=!1},setDefaultCalendar:function(e){var t=this,n=this.get(e),r=$.Deferred();return n.updateDefaultCalendar().then(function(){t.each(function(t){t.decideDefault(e)}),r.resolve()},r.reject),r}},{__instance__:null,create:function(){return this.__instance__===null&&(this.__instance__=new this.prototype.constructor),this.__instance__},setUserId:function(e){var t=this.getInstance();return t.setUserId(e),this},getMyCalendars:function(){var e=this.getInstance();return e.length||e.setUserId(t.session("id")).fetch({async:!1}),e.getMyCalendars()},getMyCalendar:function(){return this.getMyCalendars()},getDefaultCalendar:function(){var t=this.getMyCalendar(),n;return n=e.filter(t,function(e){return e.get("defaultCalendar")===!0},this),n[0]||t[0]},getCompanyCalendar:function(){var e=this.getInstance(),n;return e.length||e.setUserId(t.session("id")).fetch({async:!1}),n=e.getCompanyCalendars(),n||[]},isCalendarManager:function(e){var n=this.getInstance(),r;return typeof e=="undefined"&&(e=t.session("id")),this.setUserId(e),n.isCalendarManager()},getWritableCompanyCalendars:function(e){var n=this.getInstance(),r;return typeof e=="undefined"&&(e=t.session("id")),this.setUserId(e),n.getWritableCompanyCalendars()},getCalendars:function(){var e=this.getInstance(),n,r=$.Deferred();return e.setUserId(t.session("id")).fetch({async:!1,success:function(){r.resolve(e)}}),r}});return i})}).call(this);