(function(){define(["jquery","underscore","app","calendar/collections/calendars","calendar/collections/events","calendar/libs/util"],function(e,t,n,r,i,s){function f(e){var r=n.session("id"),i=!1;return e.type==="company"||e.type==="holiday"?i=!1:e.creator.id===r?i=!0:t.where(e.attendees,{id:r}).length>0&&(i=!0),e.summary=n.util.XSSFilter(e.summary),e.location=n.util.XSSFilter(e.location),e.description=n.util.XSSFilter(e.description),e.htmlLink=n.util.XSSFilter(e.htmlLink),e.auth=i,e}var o=Array.prototype.slice,u="YYYY-MM-DDTHH:mm:ss.SSSZ",a=function(){var a=function(){this.timeMin=null,this.timeMax=null,this.maxResult=1e3,this.isMyCalSelected=!1,this.isCached=!1,this.includingAttendees=!0,this.__collections__={},this.__updateStatus__={},this.isFetching=!1,this.fetching=e.Deferred()};return a.prototype={getCollections:function(){return this.__collections__},setTimeMin:function(e){return this.timeMin=n.util.toMoment(e).format(u),this},setTimeMax:function(e){return this.timeMax=n.util.toMoment(e).format(u),this},setBoundaryTime:function(e,t){return this.setTimeMin(e),this.setTimeMax(t),this.isCached=!1,this},setIncludingAttendees:function(e){this.includingAttendees=e},setMaxResult:function(e){return this.maxResult=e,this},contains:function(e){return t.has(this.__collections__,e)},findEvent:function(e,t){if(!this.contains(e))throw new Error("\uce98\ub9b0\ub354\uac00 \ud480\uc5d0 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.");return this.__collections__[e].get(t)},addEvent:function(e){var t=this.__collections__[e.get("calendarId")];return t.add(e),this},add:function(e){if(this._isInstanceOf(e))this.__collections__[collection.getCalendarId()]=e;else{var t=new i;t.setCalendarId(e),this.__collections__[e]=t}return this},show:function(e){return this.__collections__[e].isHide=!1,this},hide:function(e){return this.__collections__[e].isHide=!0,this},remove:function(e){var t=e;return this._isInstanceOf(e)&&(t=e.getCalendarId()),delete this.__collections__[t],this},clear:function(){return this.__collections__=null,this.__collections__={},this},updateCalendar:function(e){var t=o.call(arguments,1);return this.contains(e)&&this.__collections__[e].map(function(e,n){e.set.apply(e,t)}),this},updateEvents:function(e){var n=o.call(arguments,1);t.map(this.__collections__,function(t,r){var i=t.get(e);i&&i.set.apply(i,n)})},fetch:function(){var o=this;o.fetching=e.Deferred(),this.isFetching=!0;var u=t.keys(o.__collections__);return t.each(u,function(e,t){e===""&&u.splice(t,1)}),e.ajax(n.config("contextRoot")+"api/calendar/event",{type:"GET",data:{timeMin:this.timeMin,timeMax:this.timeMax,includingAttendees:this.includingAttendees,calendarIds:u},beforeSend:function(){o.fetching.notify()}}).done(function(e){if(!e.__go_checksum__)throw o.fetching.reject(),new Error("\uc798\ubabb\ub41c \uc751\ub2f5\uc785\ub2c8\ub2e4");e.code==="200"&&t.each(e.data,function(e){var t;this.contains(e.calendarId)||(t=new i,t.setCalendarId(e.calendarId),this.add(t)),t=this.__collections__[e.calendarId],t.add(s.parseEventModel(e,r.isCalendarManager()),{merge:!0})},o),o.isCached=!0,o.isFetching=!1,o.fetching.resolveWith(o,[o])}).fail(function(){o.isFetching=!1,o.fetching.rejectWith(o,[o])}),o.fetching},merge:function(){var e={},i=[],s=r.getMyCalendars();return t.each(this.__collections__,function(e,n){var r=e.isHide?[]:e.toJSON();i=t.union(i,r)}),t.each(i,function(r,i){var o=r.id;if(t.has(e,o)){var u=e[o],a=u.__merged__||{include_me:!1},f=t.filter(s,function(e){return e.id===r.calendarId||e.id===u.calendarId}),l=f.length>0;l&&(t.extend(a,{include_me:t.where(r.attendees,{id:n.session("id")}).length>0,color:f[0].get("color")}),r.calendarOwnerId===n.session("id")&&(e[o].calendarId=r.calendarId)),e[o].__merged__=a}else e[r.id]=r}),t.values(e)},setMyCalSelected:function(e){this.isMyCalSelected=e},_afterFetchSuccess:function(e,n){return this.__updateStatus__[e.getCalendarId()]=!0,t.without(this.__updateStatus__,!0).length===0&&(this.__updateStatus__={},n.resolveWith(this,[this])),this},_isInstanceOf:function(e){return e instanceof i}},a}();return a})}).call(this);