define("calendar/views/event_detail",function(require){var e=require("underscore"),t=require("backbone"),n=require("moment"),r=require("hogan"),i=require("app"),s=require("formspy"),o=require("calendar/libs/recurrence_parser"),u=require("calendar/libs/util"),a=require("calendar/models/event"),f=require("calendar/collections/calendars"),l=require("calendar/helpers/regist_form"),c=require("calendar/views/alarm_popup_layer"),h=require("calendar/helpers/form_attendees"),p=require("calendar/helpers/form_reminder"),d=require("calendar/helpers/form_field"),v=require("calendar/helpers/event_remove_confirm_layer"),m=require("text!calendar/templates/_detail_top.html"),g=require("calendar/views/external_attendee"),y=require("calendar/views/calendar_log"),b=require("comment"),w=require("calendar/views/attendees_schedule_layer"),E=require("i18n!calendar/nls/calendar"),S=require("i18n!nls/commons");require("jquery.autocomplete"),require("jquery.ui"),require("jquery.go-popup"),require("jquery.go-orgslide");var x=500,T={"public":"public","private":"private"},N={allday:"allday",timed:"timed"},C=t.View.extend({className:"content_page schedule_form go_renew",editable:!1,editableFields:{},events:{"click #attendee-list > li.creat":"_showOrgSlider","click #btn-add-reminder":"_addReminder","click #btn-confirm":"_confirm","click #btn-goto-list":"_goToList","click #btn-cancel":"_cancel","click #btn-leave-attendee":"_leaveAttendee","click #btn-remove-event":"_removeEvent","click #btn-copy-event":"_copyEvent","click #bottom-btn-confirm":"_confirm","click #bottom-btn-goto-list":"_goToList","click #bottom-btn-cancel":"_cancel","click #bottom-btn-leave-attendee":"_leaveAttendee","click #bottom-btn-remove-event":"_removeEvent","click #bottom-btn-copy-event":"_copyEvent","click li[data-tag=tab]":"_toggleTabView","click #moreAttendee":"_toggleAttendee","change [data-time-picker]":"_onChangeTime"},initialize:function(e){this.options=e||{},this.formHelper=new l(this.$el,"detail"),this.editable=!1,this.submitFlag=!1},render:function(){return this._prepareModel().done($.proxy(function(){this._setEditable(),this._setDeletable(),this._prepareTemplate(),this._initFormSpy(),this._initExtraHelpers(),this._initButtons(),this._renderCommentView(),this._renderLogView(),this._renderExternalAttendees(),this._renderAttendeesSchedules(),this.formHelper.isReservableAsset()&&this.editable&&(this.formHelper.loadAsset(this.model.id),this._bindAssetEvent());var e=this;this.$el.on("externalAttendee:destroy",function(t,n){e.formspy.unregistChangedAttr(n);var r=e.$(".btn_group_confirm"),i=e.$(".btn_group_action");r.css("display","inline-block"),i.hide()}),this.$el.off("externalAttendee:regist"),this.$el.on("externalAttendee:regist",function(t,n){e.makeFormatUnit($("#externalForm"),n),e.formspy.registChangedAttr(n);var r=e.$(".btn_group_confirm"),i=e.$(".btn_group_action");r.css("display","inline-block"),i.hide()})},this)),this.el},_bindAssetEvent:function(){var e=this;this.$el.on("asset-item:reserved",function(t,n){var r=n.id,i="asset-"+r;(!e.formspy.getChangedAttrs(i)||!e.model.isIncludedAttendee(r))&&e.formspy.registChangedAttr(i,r)}),this.$el.on("asset-item:destroy",function(t,n){var r="asset-"+n;e.formspy.getChangedAttrs(r)?e.formspy.unregistChangedAttr(r):e.formspy.registChangedAttr(r,n)})},_setEditable:function(){this.editable=this.model.get("permission").update===!0&&!this.isEhrInfo(this.model)},_setDeletable:function(){this.deletable=this.model.get("permission").delete===!0&&!this.isEhrInfo(this.model)},_confirm:function(t){function o(){i&&!r.isRecurrence()?(r.setRecurChangeType("all"),a()):i&&r.isRecurrence()?n._showConfirmLayer(r,"update",!0):a()}function u(){function n(){var e=this,n=$(e.alarmPopup.popupEl);isPushNoti=n.find("input:checkbox[id='chkbox_push']").is(":checked"),isMailNoti=n.find("input:checkbox[id='chkbox_mail']").is(":checked"),r.set("pushNoti",isPushNoti),r.set("mailNoti",isMailNoti),t.resolve()}function i(){r.set("pushNoti",!1),r.set("mailNoti",!1),t.resolve()}function s(){t.reject()}var e=this,t=$.Deferred();return this.alarmPopup=new c,this.alarmPopup.setConfirmCallback(n,this),this.alarmPopup.setCancelCallback(i,this),this.alarmPopup.setCloseCallback(s,this),this.alarmPopup.render({type:"web"}),t}function a(){r.save({},{success:function(e){n._goToList()},complete:function(){n.submitFlag=!1}})}var n=this,r=this.model.clone(),i=this.model.isRecurrence();if(this.submitFlag)return $.goMessage(E["\uc77c\uc815 \uc218\uc815 \uc911 \uba54\uc2dc\uc9c0"]),!1;this.submitFlag=!0;try{this.formHelper.saveReservationAssets(),r.on("error:validate",$.proxy(this._validateErrorCallback,this)),r.set(e.extend(this._getChangedData(),{type:r.get("type")})),r.isCompanyEvent()||r.isAlone()?o():u().done(function(){o()}).fail(function(){n.submitFlag=!1})}catch(s){this.submitFlag=!1}return this},_validateErrorCallback:function(e,t,n){return l.prototype.raiseError.apply(this.formHelper,arguments),this.submitFlag=!1,this},_getChangedData:function(){var t=e.pick(this.formspy.getChangedAttrs(),"summary","location","description"),n=this.formHelper.serializeFormData(),r={attendees:e.union(this.attendeesHelper.getAttendees(),this.getExternalAttendees())};return e.extend({},n,t,r)},_cancel:function(){return this.$el.empty(),this.render(),this},_prepareModel:function(){var e=this,t=$.Deferred();return this.model=new a({id:this.options.eventId,calendarId:this.options.calendarId}),this.model.fetch({success:t.resolve,error:t.reject,statusCode:{403:function(){i.util.error("403",{msgCode:"400-calendar"})},404:function(){i.util.error("404",{msgCode:"400-calendar"})},500:function(){i.util.error("500")}}}),this.model.on("error:validate",function(t,n,r){$.goAlert(r,"",function(){e._cancel()})}),t},_prepareTemplate:function(){var e=i.util.toMoment(this.model.get("startTime")),n=i.util.toMoment(this.model.get("endTime")),r=this.model.get("recurrence"),s=this.model.get("parentId"),u=this.model.get("summary"),a=new o,l=this.model.get("timeType")===N.allday?i.util.dateFormatWithoutTimeZone(this.model.get("startTime")):e.format("YYYY-MM-DD"),c=this.model.get("timeType")===N.allday?i.util.dateFormatWithoutTimeZone(this.model.get("endTime")):n.format("YYYY-MM-DD"),h=this.model.get("timeZoneOffset")||"";i.util.store.set("timeZoneOffset",h);var p=this.model.get("serverTZOffset")||i.session().timeZone.serverTZOffset,d=i.util.toMoment(this.model.get("basicDateOfRecurrence")).format("YYYY-MM-DD"),v=this;return this.formHelper.render({summary:v.isEhrInfo(this.model)?u+"("+this.model.get("creator").name+")":u,start_date:l,start_time:e.format("HH:mm"),end_date:c,end_time:n.format("HH:mm"),location:this.model.get("location"),description:this.model.get("description"),recurrence_code:r,current_recurrence:r?a.parse(r).humanize(h,p):"",basic_date_recurrence:d,"editable?":this.editable,"removable?":this.deletable,"private?":this.model.get("visibility")===T["private"],"allday_event?":this.model.get("timeType")===N.allday,"recurrence?":!!r,"show_visibility?":this.model.isNormalEvent(),"show_inner_attendees?":this.model.isNormalEvent(),"show_location?":this.editable||!!this.model.get("location"),"show_description?":this.editable||!!this.model.get("description"),"show_reminder?":this.editable,"show_calendar_select?":this.editable&&this.model.isNormalEvent(),"is_company_event?":this.model.isCompanyEvent(),company_calendar:(new t.Collection(f.getWritableCompanyCalendars())).toJSON(),repeatable:!s,"is_select_company_calendar?":function(){return v.model.get("calendarId")==this.id},unusual_repeat_msg:E["\ubc18\ubcf5\uc77c\uc815 \uc911 \uc218\uc815\ub41c \uc77c\uc815 \uc124\uba85"]},this._buildPartials()),this.formHelper.loadMyCalendarOptions(f.getMyCalendars(),this.model.get("calendarId")),this},_initFormSpy:function(){this.formspy=new s(this.$el.find("#form-event")),this.formspy.on("changed:attribute",$.proxy(function(e,t,n){this._showNotiRecurrenceRestrict(t,n),this._showHideConfirmButton()},this)),this.formspy.on("restored:all",$.proxy(function(){this._showHideConfirmButton()},this))},_initExtraHelpers:function(){var t=this.model.get("reminders"),n=e.sortBy(this.model.get("attendees"),function(e){return e.id===i.session("id")?1:2});return this.reminderHelper=new p(this.$el.find("ul#reminder-list"),t,this.editable),e.each(t,function(e,t){this.formspy.registry(this.$el.find("input[name=reminder_value_"+t+"]")),this.formspy.registry(this.$el.find("select[name=reminder_type_"+t+"]")),this.formspy.registry(this.$el.find("select[name=reminder_method_"+t+"]"))},this),this.reminderHelper.on("removed:reminder",$.proxy(this._removeReminderCallback,this)),this.attendeesHelper=new h(this.$el.find("ul#attendee-list"),n,this.editable),this.attendeesHelper.addRemoveCallback($.proxy(this._removeEventFromAttendees,this)),this.attendeesHelper.addAttendeeCallback($.proxy(this._addEventFromAttendees,this)),this},_initButtons:function(){return this.attendeesHelper.includeMe(i.session("id"))&&!this.model.isAlone()&&this.$el.find("#btn-leave-attendee").css("display","inline-block"),this},_buildPartials:function(){return{title_and_date:r.compile(m)}},_showOrgSlider:function(e){return $.goOrgSlide({header:E["\ucc38\uc11d\uc790 \ucd94\uac00"],type:"node",desc:E["\uc77c\uc815\uc758 \ucc38\uc11d\uc790\ub85c \ucd94\uac00\ud560 \uc0ac\uc6a9\uc790\ub97c \uc544\ub798\uc5d0\uc11c \uc120\ud0dd\ud558\uc138\uc694"],contextRoot:i.config("contextRoot"),callback:$.proxy(this._addAttendees,this)})},_addAttendees:function(t){return this.attendeesHelper.addAttendee(t).done(e.bind(function(t){e.each(t,function(e){var t=e.id,n="attendee-"+t;(!this.formspy.getChangedAttrs(n)||!this.model.isIncludedAttendee(t))&&this.formspy.registChangedAttr(n,t)},this)},this)),this},_addReminder:function(){var e=this.reminderHelper.addReminder();return this.formspy.registry(e.find("input[name^=reminder_value]"),"-1"),this.formspy.registry(e.find("select[name^=reminder_type]")),this.formspy.registry(e.find("select[name^=reminder_method]")),this},_removeReminderCallback:function(e,t,n){var r=t.find("input[name=reminder_value_"+n+"]"),i=t.find("select[name=reminder_type_"+n+"]"),s=t.find("select[name=reminder_method_"+n+"]"),o=this.formspy.getChangedAttrs(r.attr("name"))?"unregistry":"registry";return this.formspy[o].call(this.formspy,r,-1),this.formspy[o].call(this.formspy,i,-1),this.formspy[o].call(this.formspy,s,-1),this},_goToList:function(){return u.goToCalendar(),this},_showConfirmLayer:function(e,t,n){var r=this,i=new v(e,t,n);return i.setCallbacks({complete:function(){r.submitFlag=!1}}),i.render(),i},_leaveAttendee:function(){return this.model.set("attendees",this.attendeesHelper.getAttendees(i.session("id")),{silent:!0}),this._showConfirmLayer(this.model,"leave")},_removeEventFromAttendees:function(t,n){var r="attendee-"+t;if(this.attendeesHelper.isExistedAttendee(t)){var s=this.attendeesHelper.getAttendees().length;if(i.session("id")===t||s<2){var o=this.attendeesHelper.getAttendees(t),u=this.getExternalAttendees(),a=e.union(o,u);this.model.set("attendees",a,{silent:!0}),s==1?this._showConfirmLayer(this.model,"remove"):this._showConfirmLayer(this.model,"leave")}else this.formspy.getChangedAttrs(r)?this.formspy.unregistChangedAttr(r):this.formspy.registChangedAttr(r,t),$(n).remove()}else this.formspy.unregistChangedAttr(r),$(n).remove();this.attendeesScheduleLayerView.removeEventListener(t)},_addEventFromAttendees:function(e){this.attendeesScheduleLayerView.addEventListener(e)},_removeEvent:function(e){return this._showConfirmLayer(this.model,"remove")},_copyEvent:function(){var e=this;$.goPopup({title:E["\uc77c\uc815\uc744 \ubcf5\uc0ac\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],contents:E["\uc885\uc77c, \ubc18\ubcf5 \uc124\uc815\uacfc \uc608\uc57d\ud558\uae30\ub294 \ubcf5\uc0ac \ub300\uc0c1\uc5d0\uc11c \uc81c\uc678\ub429\ub2c8\ub2e4."],buttons:[{btext:S["\ud655\uc778"],btype:"confirm",callback:function(){i.router.navigate("calendar/regist/copied/"+e.options.calendarId+"/"+e.options.eventId,!0)}},{btext:S["\ucde8\uc18c"],btype:"normal"}]})},_showNotiRecurrenceRestrict:function(e,t){var n=this,r=i.util.toMoment(this.model.get("startTime")).format("YYYY-MM-DD"),s=i.util.toMoment(this.model.get("endTime")).format("YYYY-MM-DD"),o=i.util.toMoment(this.model.get("basicDateOfRecurrence")).format("YYYY-MM-DD");this.model.isRecurrence()&&e=="start_date"&&$.goConfirm(E["\ubc18\ubcf5 \uc77c\uc815 \uc218\uc815"],E["\ubc18\ubcf5\uc77c\uc815\uc744 \uc218\uc815\ud558\uae30 \uc704\ud574\uc11c\ub294 \ubc18\ubcf5 \uc124\uc815\uc744 \ubcc0\uacbd\ud558\uc154\uc57c \ud569\ub2c8\ub2e4."],function(e){n._showRecurLayer($("input#startDate").val())},function(){e=="start_date"&&($("input#startDate").val(r),n._rejectEditStartDate(e))})},_showRecurLayer:function(e){this.formHelper._showHideRecurrenceSetupLayer(undefined,i.util.getDay(e))},_rejectEditStartDate:function(e){this.formspy.unregistChangedAttr(e)},_showHideConfirmButton:function(){if(this.editable){var e=this.$el.find(".btn_group_confirm"),t=this.$el.find(".btn_group_action"),n=e.first();!n.is(":visible")&&this.formspy.hasChangedAttrs()?(e.css("display","inline-block"),t.hide()):n.is(":visible")&&!this.formspy.hasChangedAttrs()&&(e.hide(),t.css("display","inline-block"),(this.model.isCompanyEvent()||this.model.isAlone())&&$("#btn-leave-attendee").hide())}return this},_renderCommentView:function(){var e=this;this.commentView=b.init({el:this.$("#commentArea"),typeUrl:"calendar/"+this.model.get("calendarId")+"/event",typeId:this.model.id}),this.commentView.$el.on("comment:change",function(t,n,r){e._setCommentCount(r),e.logView.render()}),this.commentView.render(),this.commentView.fetchComments(!0).done(function(){e._setCommentCount(e.commentView.collection.length)})},_setCommentCount:function(e){this.$("#commentCount").text(e)},_renderLogView:function(){this.logView=new y({calendarId:this.model.get("calendarId"),eventId:this.model.id}),this.$("#logArea").html(this.logView.el),this.logView.render()},_renderAttendeesSchedules:function(){var e=this;this.attendeesScheduleLayerView=new w({model:this.model}),this.$el.find("[data-attendees-schedule-wrapper]").append(this.attendeesScheduleLayerView.render().el),this.$el.off("calendarDate:change"),this.$el.on("calendarDate:change",function(t){e.attendeesScheduleLayerView.onChangeDate()})},_onChangeTime:function(e){this.attendeesScheduleLayerView.onChangeTime()},_toggleTabView:function(e){var t=$(e.currentTarget),n=t.hasClass("on");if(n)return;var r=t.attr("data-type"),i=r=="comment"?"log":"comment";this.$("#"+r+"Area").toggle(!n),this.$("#"+r+"Tab").toggleClass("on"),this.$("#"+i+"Area").toggle(n),this.$("#"+i+"Tab").toggleClass("on")},_toggleAttendee:function(e){var t=$(e.currentTarget),n=t.find("span.ic"),r=n.hasClass("ic_arrow_up");this.$("#attendee-list").find("li[data-more]").toggle(!r),n.toggleClass("ic_arrow_up"),n.toggleClass("ic_arrow_down")},getExternalAttendees:function(){return e.map(this.$("#externalArea").find("span.name"),function(e){return{id:"",email:$(e).data("email"),name:$(e).data("label")||"",position:""}})},_renderExternalAttendees:function(){this.formspy.unregistry(this.$("#externalForm")),this.initAutoComplete();var t=this.model.getExternalAttendees();t.length&&this.$("#externalArea").show(),e.each(t,function(e){var t=new g(e);this.$("#externals").append(t.render().el),this.formspy.__changedAttributes__[e.email]=e.email},this)},initAutoComplete:function(){var e={autoResizeWidth:!0,makeFormat:!0,makeFormatFunc:$.proxy(this.makeFormatUnit,this),multiple:!1,width:"400px",matchCase:!0,notContact:"F",excSearchOption:"RIPD",isDomainSearch:"F",customLeft:!0};this.$("#externalForm").autocomplete(i.contextRoot+"api/mail/address/search/name",e)},makeFormatUnit:function(e,t){function v(e){var t=null,n=null;return $.ajax({url:i.contextRoot+"api/user/sort/list",data:{keyword:e},type:"GET",async:!1,success:function(e){hasName=e.data.length>0,hasName&&(t=e.data[0].name,n=e.data[0].email)},error:function(e){console.log(e)}}),{hasName:hasName,name:t,email:n}}var n=this;if($.trim(t)=="")return;addressArray=new Array,addressSplit=t.split(">,");for(var r=0;r<addressSplit.length;r++){tempAddressArray=addressSplit[r].split(",");for(var s=0;s<tempAddressArray.length;s++)tempAddressArray[s]=$.trim(tempAddressArray[s]);addressArray=addressArray.concat(i.util.makeFormatEmail(tempAddressArray))}for(var r=0;r<addressArray.length;r++){t=addressArray[r];var o=i.util.checkEmailFormat(t),u=null,a=o?i.util.get_name(t):t,f=o?a||i.util.get_email(t):t,l=$('<span class="name" id="nameField" evt-rol="select-field" onselectstart="return false"></span>').attr("title",f).data("email",o?i.util.get_email(t):"").data("label",a).data("select",!1).text(f),c="",h=$('<span class="ic_classic ic_del"></span>');h.attr("title","\uc0ad\uc81c").click(function(){var t=$(this).closest("li");t.find("input.edit").unautocomplete(),t.remove(),e.focus(),n.formspy.unregistChangedAttr(t.find("span.name").text())});var p=$('<span class="btn_wrap"></span>').append(h),d=$("<li></li>");d.append(l).append(c).append(p),this.$("#externalArea").show(),this.$("#externals").append(d),this.formspy.registChangedAttr(f,f),e.val("")}},isEhrInfo:function(e){return e.get("referenceId")?!0:!1}});return C});