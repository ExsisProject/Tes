(function(){define(["underscore","app","calendar/views/calendar","hgn!calendar/templates/agenda","hgn!calendar/templates/agenda_list","i18n!nls/commons","i18n!calendar/nls/calendar"],function(e,t,n,r,i,s,o){function v(e){return e.referenceId?!0:!1}function m(e,n){function s(e,t){var n=e.split("T")[0],r=t.split("T")[0],i=-1;return n>r?i=1:n===r&&(i=0),i}function o(e,t){this.a=e,this.b=t,this.__result__=0,this.pipe=function(e){return this.__result__===0&&(this.__result__=e(this.a,this.b)),this},this.run=function(){return this.__result__}}var r={holiday:1,anniversary:1,company:2,normal:2},i={allday:1,timed:2};return(new o(e,n)).pipe(function(t,n){return r[t.type]-r[n.type]}).pipe(function(t,n){if(t.timeType=="allday"&&n.timeType=="allday"){if(t.is_ehr_event&&!n.is_ehr_event)return 1;if(!t.is_ehr_event&&n.is_ehr_event)return-1}return 0}).pipe(function(t,n){return s(t.startTime,n.startTime)}).pipe(function(t,n){return s(n.endTime,t.endTime)}).pipe(function(t,n){return i[t.timeType]-i[n.timeType]}).pipe(function(n,r){return t.util.toMoment(n.startTime).valueOf()-t.util.toMoment(r.startTime).valueOf()}).pipe(function(n,r){return t.util.toMoment(n.createdAt).valueOf()-t.util.toMoment(r.createdAt).valueOf()}).run()}var u="agendaview",a=[t.constant("calendar","EVENT_SHOW_CAL"),u].join("."),f=[t.constant("calendar","EVENT_HIDE_CAL"),u].join("."),l=[t.constant("calendar","EVENT_CHANGED_COLOR"),u].join("."),c=t.util.toMoment,h=n.prototype,p={"empty?":!1,label:{date:o["\ub0a0\uc9dc"],period:o["\uae30\uac04"],title:s["\uc81c\ubaa9"],attendees:o["\ucc38\uc11d\uc790"],"private":s["\ube44\uacf5\uac1c"],more:t.i18n(o["\uc77c\uc815\ubaa9\ub85d \ub354\ubcf4\uae30 \ub77c\ubca8"],{duration:15})},message:{empty:o["\uc77c\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]}},d=n.extend({name:"Calendar.AgendaView",type:"agenda",__haveEvents__:!1,startDate:null,endDate:null,events:{"click #more-load-btn":"_loadMoreList"},initialize:function(t){this.options=t||{},console.log("[AgendaView#initialize] called..."),h.initialize.call(this),this.calendarId=null,this.options=e.extend({date:c(new Date).startOf("day")},e.pick(this.options,"date")),this.$el.css("padding-bottom","20px"),this._prepareTemplate(),this._init()},_init:function(){this.__haveEvents__=!1,this.__infinitScrollCount__=0,this.startDate=null,this.endDate=null,this.setBoundaryTime()},setBoundaryTime:function(){this.startDate===null&&(this.startDate=c(this.options.date).clone().startOf("day")),this.endDate=this.startDate.clone().add("days",15).endOf("days")},render:function(e){return e&&(this.calendarId=e),this._renderList(),this},delegateEvents:function(e){console.log("[AgendaView#delegateEvents] called..."),h.delegateEvents.call(this,e),$(document).on(a,$.proxy(this._showCalendar,this)),$(document).on(f,$.proxy(this._hideCalendar,this)),$(document).on(l,$.proxy(this._changeCalendarColor,this))},undelegateEvents:function(){console.log("[AgendaView#undelegateEvents] called...");var e="."+u;h.undelegateEvents.call(this),$(document).off(e),$(window).off(e)},changeDate:function(e){this.options.date=c(e).toDate(),this._init(),this.$el.find("tbody").empty(),this._renderList()},_renderList:function(t){t=t||!1;var n=this,r=this.calendarId,s=t?this.startDate:this.options.date;return this.getCalendarEvent(s,this.endDate,!0).done(function(t){var s=t.merge(),o,u=[];r&&(s=e.where(s,{calendarId:r+""})),o=n._buildEventSlots(t.timeMin,t.timeMax,s),o.length>0?(e.each(o,function(e,t){u.push(i(e))}),n.__haveEvents__=!0):n.__haveEvents__||u.push(i(e.extend(p,{"empty?":!0}))),n.$el.find("tbody").append(u.join("\n")),n.__haveEvents__?($(".bottom_action").show(),$(".agenda-duration-wrap").show()):($(".bottom_action").hide(),$(".agenda-duration-wrap").hide()),n._renderDuration()}),this},_loadMoreList:function(){this.startDate=this.endDate.clone().startOf("day").add("days",1),this.setBoundaryTime(),this._renderList(!0)},_renderDuration:function(){$("#agenda-duration").empty().text(t.i18n(o["\uc77c\uc815\ubaa9\ub85d \uc885\ub8cc\uc77c \ud45c\uc2dc"],{date:c(this.endDate).format("YYYY-MM-DD")}))},_resetList:function(){return this.$el.find("tbody").empty(),this._renderList(),this},_showCalendar:function(e,t){console.log("[AgendaView#_showCalendar] loading...");var n=this;this.showCalendar(t).progress(function(){n._resetList()})},_hideCalendar:function(e,t){console.log("[AgendaView#_hideCalendar] loading...");var n=this;this.hideCalendar(t).progress(function(){n._resetList()})},_changeCalendarColor:function(e,t,n){this.eventsPool.updateCalendar(t,"color",n,{silent:!0}),this._resetList()},_buildEventSlots:function(n,r,i){var s=e.filter(i,function(e){return e.summary&&e.summary.length>0}),o=15,u=c(n).clone(),a=c(r).clone(),f=new Array(o),l=[];for(var h=0,p=s.length;h<p;h++){if(!s[h])continue;var d,g;s[h].timeType=="allday"?(d=t.util.dateWithoutTimeZone(s[h].startTime),g=t.util.dateWithoutTimeZone(s[h].endTime)):(d=s[h].startTime,g=s[h].endTime);var y=s[h],b=Math.max(c(d).valueOf(),u.valueOf()),w=Math.min(c(g).valueOf(),a.valueOf()),E=c(b),S=c(w),x=E.clone(),T=this._getDuration(u,E)-1,N=this._getDuration(E,S);for(var C=0;C<N;C++){var k=T+C;if(k>=0){f[k]instanceof Array||(f[k]=[]);var L=t.config("root")+["calendar",y.calendarId,"event",y.id].join("/"),A=!0,O="",M="";y.creator&&(O=y.creator.name,M=y.creator.position),y.__merged__&&!y.__merged__.include_me&&(A=!1),f[k].push({type:y.type,timeType:y.timeType,startTime:y.startTime,endTime:y.endTime,createdAt:y.createdAt,detail_url:L,format_date:x.format("MM.DD(ddd)"),format_time:this._getFormattedTime(x,y),duration:N,calendar_color:y.color,calendar_name:[O,M].join(" "),summary:y.summary,attendees:this._getAttendeedsString(y.attendees),"show_color?":A,"is_private?":y.visibility==="private","is_group_event?":!!y.__merged__&&!!y.__merged__.calendarId,"first_row?":!1,"rowspan?":!1,is_ehr_event:v(y),creator_name:O,event_id:y.id,calendar_id:y.calendarId})}x.add("days",1)}}return e.each(f,function(t,n){t&&(l[n]?l[n].concat(t):l[n]=t,l[n].sort(m),e.extend(l[n][0],{"first_row?":!0,"rowspan?":l[n].length>1?!0:!1,rowspan_count:l[n].length}))}),e.flatten(e.compact(l),!0)},_getFormattedTime:function(e,n){var r="",i,s,u=this._getDuration(n.startTime,n.endTime),a=c(n.startTime).format("A hh:mm"),f=c(n.endTime).format("A hh:mm");return n.timeType==="allday"?r=v(n)?o["\uadfc\ud0dc\uc77c\uc815"]:o["\uc885\uc77c\uc77c\uc815"]:(u>1?(i=t.util.isSameDate(e,n.startTime)?a:o["\uacc4\uc18d"],s=t.util.isSameDate(e,n.endTime)?f:o["\uacc4\uc18d"]):(i=a,s=f),r=[i,s].join(" ~ ")),r},_getDuration:function(e,t){return Math.ceil(c(t).clone().endOf("days").diff(c(e).clone().startOf("days"),"days",!0))},_getAttendeedsString:function(t){var n=e.map(t,function(e){return e.name?[e.name,e.position].join(" "):e.email});return n.join(", ")},_prepareTemplate:function(){this.$el.empty().html(r(p))}});return d})}).call(this);