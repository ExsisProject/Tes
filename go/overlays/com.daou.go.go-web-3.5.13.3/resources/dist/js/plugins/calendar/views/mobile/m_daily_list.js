define("calendar/views/mobile/m_daily_list",function(require){var e=require("jquery"),t=require("underscore"),n=require("backbone"),r=require("app"),i=require("i18n!calendar/nls/calendar"),s=require("views/mobile/header_toolbar"),o=require("hgn!calendar/templates/mobile/m_daily_list"),u=require("hgn!calendar/templates/mobile/m_daily_list_unit"),a=require("calendar/collections/mobile/calendar"),f=require("calendar/collections/calendars"),l=require("calendar/libs/util"),c=require("models/user_profile");require("jquery.go-popup"),require("GO.util"),require("jquery.go-validation"),require("jquery.placeholder");var h=null,p={no_event:i["\ub4f1\ub85d\ub41c \uc77c\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],monthly:i["\uc6d4\uac04"],today:i["\uc624\ub298"]},d=n.View.extend({el:"#content",events:{'vclick a[data-btntype="moveDate"]':"moveDate",'vclick a[data-btntype="today"]':"moveToday","vclick dd.eventWrap":"moveEvent",'vclick a[data-btntype="monthView"]':"moveMonthlyView"},initialize:function(){this.$el.off(),this.headerToolbarView=s,this.checkedCalIds=t.isUndefined(l.getSavedSelectedCalendar())||l.getSavedSelectedCalendar()===""?[]:l.getSavedSelectedCalendar().split(","),this.calLocalStorage={type:"daily"},r.util.appLoading(!0)},moveMonthlyView:function(t){t.preventDefault();var n=e("#currentDatePart").attr("data-date"),i=["calendar","monthly",n];r.router.navigate(i.join("/"),{trigger:!0,pushState:!0})},moveEvent:function(n){var i=this;n.preventDefault(),n.stopPropagation();var s=e(n.currentTarget),o="calendar/"+s.attr("data-calendarid")+"/event/"+s.attr("data-eventid");e.ajax({type:"GET",url:r.contextRoot+"api/"+o}).done(function(e){var n=e.data,s=t.where(n.attendees,{id:r.session("id")}).length>0;n&&(n.visibility!=="private"||s)&&(r.util.setLocalStorage("calLocalStorage",i.calLocalStorage),r.router.navigate(o,{trigger:!0,pushState:!0}))}).fail(function(){return})},drawDailyList:function(t){var n=r.util.calDate(t,"days",-1),i=r.util.calDate(t,"days",1);e("#currentDatePart").html(r.util.toMoment(t).format("YYYY.MM.DD")).attr("data-date",r.util.shortDate(t)),e("#prevDatePart").attr("data-date",n),e("#nextDatePart").attr("data-date",i);var s={selectedDate:r.util.toMoment(t.clone())};e("#dailyListWrap").html(this.makeDailyListUnit(s)),r.router.navigate("calendar/daily/"+r.util.shortDate(t),!1),this.calLocalStorage.date=r.util.shortDate(t)},moveToday:function(e){e.preventDefault(),e.stopPropagation();var t=r.util.toMoment(new Date);this.drawList(t)},moveDate:function(t){t.preventDefault(),t.stopPropagation();var n=e(t.currentTarget),i=r.util.toMoment(n.attr("data-date"));this.drawList(i)},checkExistDate:function(t){var n=r.util.calDate(t,"days",2),i=!1;return e.each(this.collection.toJSON(),function(e,t){if(r.util.isSameDate(n,t.datetime))return i=!0,!1}),i},drawList:function(e){var t=this.checkExistDate(e);if(t)this.drawDailyList(e);else{var n=this;this.year=e.year(),this.month=this.month==12?1:e.month()+1;var r=this.getDateData(this.checkedCalIds);r.on("reset",function(t,r){n.collection=t,n.drawDailyList(e)})}},getDateData:function(e){var t=a.getCollection({year:this.year,month:this.month,addWeek:1,calendarIds:e,includingAttendees:!0});return t},render:function(n){r.util.pageDone();var s=r.util.toMoment();n.selectDate&&(s=r.util.toMoment(n.selectDate)),this.year=s.years(),this.month=s.month()+1,this.day=s.date();var n=t.extend(n,{year:this.year,month:this.month,day:this.day,selectedDate:s}),u=this,a=o({prevDate:u.makeDate(n,-1),nextDate:u.makeDate(n,1),currentDate:r.util.toMoment(s).format("YYYY.MM.DD"),currentDateBasic:r.util.shortDate(s),lang:p});u.$el.html(a);var f=this.getDateData(this.checkedCalIds);f.on("reset",function(e){u.collection=e;var t=u.makeDailyListUnit(n);u.$el.find("#dailyListWrap").html(t),r.util.appLoading(!1),u.calLocalStorage.date=r.util.shortDate([n.year,n.month,n.day].join("/"))}),this.headerToolbarView.render({title:i["\uc77c\uc815\ubaa9\ub85d"],isList:!0,isSideMenu:!0,isHome:!0,isSearch:!0,isWriteBtn:!0,writeBtnCallback:function(){r.util.setLocalStorage("calLocalStorage",u.calLocalStorage),r.router.navigate("calendar/write/"+e("#currentDatePart").attr("data-date"),{trigger:!0,pushState:!0})}})},makeDate:function(e,t){var n=[e.year,e.month,e.day].join("/"),i=r.util.calDate(n,"days",t);return i},makeDailyListUnit:function(n){var s=function(){return r.util.formatDatetime(this.date,null,"MM.DD (dd)")},o=function(){var e=this.date.format("dd");return e.indexOf("\ud1a0")>-1?"sat":e.indexOf("\uc77c")>-1?"sun":""},a=function(){if(this.timeType=="allday")return i["\uc885\uc77c"];var e,t;r.util.isSameDate(this.currentDatetime,this.startTime)?e=r.util.hourMinute(this.startTime):e=i["\uacc4\uc18d"];if(r.util.isSameDate(this.currentDatetime,this.endTime))t=r.util.hourMinute(this.endTime);else{t=i["\uacc4\uc18d"];if(e==t)return i["\uc885\uc77c"]}return e+"~"+t},f=this.setThreeDaysCal(n),h=t.isUndefined(l.getSavedSelectedCalendarOwnerId())||l.getSavedSelectedCalendarOwnerId()===""?[]:l.getSavedSelectedCalendarOwnerId(),d=t.isNull(sessionStorage.getItem("calendar-thumbnail-list"))?[]:JSON.parse(sessionStorage.getItem("calendar-thumbnail-list"));t.each(f,function(n,i){e.each(n.eventList,function(e,t){t.currentDatetime=n.date});var s=t.filter(n.eventList,function(e){if(e.type==="holiday")f[i].isHoliday=!0,f[i].holidayName=r.util.escapeHtml(e.summary);else if(e.summary[0]!="-")return!0}),o=function(e){var r=[],i=t.filter(e,function(e){if(r.indexOf(e.id)>-1)return!1;var t=moment(n.date).isSame(e.endTime)&&moment(e.endTime).format("HH:mm")==="00:00"&&e.timeType==="timed";if(!t)return r.push(e.id),!0});return i},u=function(e){var n=e.calendarOwnerId;if(t.isUndefined(n))return r.contextRoot+"resources/images/mobile/photo_profile_group.jpg";if(a(e))return e.color="_group",r.contextRoot+"resources/images/mobile/photo_profile_group.jpg";var i=null;t.any(d,function(e){if(e.id===n)return i=e.thumbnail,!0});if(!t.isNull(i))return i;var s=c.read(n).get("thumbSmall"),o={id:n,thumbnail:s};return d.push(o),sessionStorage.setItem("calendar-thumbnail-list",JSON.stringify(d)),s},a=function(e){if(e.attendees.length>1){var n=!1,r=0;t.any(e.attendees,function(e){h.indexOf(e.id)>-1&&r++;if(r===2)return n=!0,!0});if(n)return!0}return!1},l=o(s);t.each(l,function(e){e.isSecret=e.visibility==="private",e.thumbnail=u(e)}),f[i].eventList=l});var v=function(){return r.util.escapeHtml(this.summary)},m=function(){return this.type==="anniversary"},g=u({data:f,isWeekend:o,parseDate:s,parseTimeType:a,lang:p,parseSummary:v,isHolidayAnniversary:m});return g},setThreeDaysCal:function(t){var n=[],i=7,s=t.selectedDate.clone();for(var o=0;o<i;o++)e.each(this.collection.toJSON(),function(e,t){var i=r.util.dateWithoutTimeZone(t.datetime),o=r.util.dateWithoutTimeZone(s);if(!r.util.isSameDate(i,o))return;n.push({date:i,eventList:t.eventList.sort(function(e,t){return e.startTime==t.startTime?e.endTime>t.endTime?1:-1:0})})}),s.add(1,"days");return n}});return{render:function(e){h=new d,h.render(t.extend(e))}}});