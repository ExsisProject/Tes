define("calendar/views/regist",function(require){var e=require("underscore"),t=require("backbone"),n=require("app"),r=require("hogan"),i=require("calendar/views/form"),s=require("calendar/collections/calendars"),o=require("calendar/models/event"),u=require("calendar/collections/events"),a=require("calendar/views/alarm_popup_layer"),f=require("calendar/views/attendees_schedule_layer"),l=require("calendar/helpers/regist_form"),c=require("calendar/helpers/form_attendees"),h=require("calendar/helpers/form_reminder"),p=require("calendar/views/external_attendee"),d=require("calendar/libs/util"),v=require("text!calendar/templates/_regist_top.html"),m=require("i18n!nls/commons"),g=require("i18n!calendar/nls/calendar");require("jquery.autocomplete"),require("jquery.ui"),require("jquery.go-popup"),require("jquery.go-orgslide"),require("jquery.cookie");var y=n.util.now(),b=i.extend({className:"content_page schedule_form go_renew",events:{"click #attendee-list #btn-add-attendees":"_showOrgSlider","click #btn-confirm":"_submit","click #btn-cancel":"_cancel","click #btn-add-reminder":"_addReminder","click #delete_all_attendees":"_deleteAll","click #moreAttendee":"_toggleAttendee","change [data-time-picker]":"_onChangeTime"},initialize:function(e){this.options=e||{},this._initSearchParam(),this.formHelper=new l(this.$el,"regist"),this.submitFlag=!1},render:function(){console.log("[CalendarRegistView#render] rendering..."),this.options.isCopied?this._prepareModel().done($.proxy(function(){this._initCopiedParam(),this._renderRegistForm(),this._renderExternalAttendees(),this._renderAttendeesSchedules(),$.goSlideMessage(g["\ubcf5\uc0ac\ub41c \uc77c\uc815\uc785\ub2c8\ub2e4."])},this)):(this._renderRegistForm(),this._renderAttendeesSchedules())},_renderExternalAttendees:function(){var t=this.options.externalAttendees;t.length&&this.$("#externalArea").show(),e.each(t,function(e){var t=new p(e);this.$("#externals").append(t.render().el)},this)},_renderRegistForm:function(){var e=s.getWritableCompanyCalendars();this.formHelper.render({start_date:this.options.startDate,start_time:this.options.startTime,end_date:this.options.endDate,end_time:this.options.endTime,summary:this.options.summary,location:this.options.location,"allday_event?":this.options.timeType==="allday","private?":this.options.private,description:this.options.description,isCopiedNotAlone:this.options.isCopied&&!this.options.isAlone,"calendar_manager?":s.isCalendarManager(),company_calendar:(new t.Collection(e)).toJSON(),attendees:this.options.attendees},this._buildPartials()),this.reminderHelper=new h(this.$el.find("ul#reminder-list"),this.options.reminders),this.attendeesHelper=new c(this.$el.find("ul#attendee-list"),this.options.attendees),this.attendeesHelper.addRemoveCallback($.proxy(this._removeEventFromAttendees,this)),this.attendeesHelper.addAttendeeCallback($.proxy(this._addEventFromAttendees,this));var n=s.getMyCalendars();e.length>0&&this.options.calendarType=="company"?(this.$el.find("input[name=is_company_event]").click(),this.$el.find("select[name=company_calendar_id]").val(this.options.calendarId),this.formHelper.loadMyCalendarOptions(n)):this.formHelper.loadMyCalendarOptions(n,this.options.calendarId),this.formHelper.loadAsset(),this.initAutoComplete();var r=this;return this.$el.on("externalAttendee:regist",function(e,t){r.makeFormatUnit($("#externalForm"),t)}),this.el},_renderAttendeesSchedules:function(){var e=this;this.attendeesScheduleLayerView=new f({attendees:this.options.attendees,startDate:this.options.startDate}),this.$el.find("[data-attendees-schedule-wrapper]").append(this.attendeesScheduleLayerView.render().el),this.$el.off("calendarDate:change"),this.$el.on("calendarDate:change",function(t){e.attendeesScheduleLayerView.onChangeDate()})},_onChangeTime:function(e){this.attendeesScheduleLayerView.onChangeTime()},_initSearchParam:function(){var t=n.router.getSearch();this.options.startDate=t.sd||y.format("YYYY-MM-DD"),this.options.startTime=t.st||n.util.getIntervalTime(y).format("HH:mm"),this.options.endDate=t.ed||this.options.startDate,this.options.endTime=t.et||n.util.getIntervalTime(y.clone().add("hours",1)).format("HH:mm"),this.options.timeType=t.tt||"timed",this.options.calendarType=t.ct||"public",this.options.summary=decodeURIComponent(t.summary||""),this.options.location=t.location||"",this.options.attendees=e.pick(n.session(),"id","name","email","position"),this.options.calendarId||(this.options.calendarId=t.calendar||s.getDefaultCalendar().id)},_initCopiedParam:function(){this.options.summary=this.model.get("summary"),this.options.private=this.model.isPrivate(),this.options.calendarType=this.model.get("type"),this.options.attendees=this.model.get("attendees"),this.options.location=this.model.get("location"),this.options.description=this.model.get("description"),this.options.reminders=this.model.get("reminders"),this.options.isAlone=this.model.isAlone(),this.options.externalAttendees=this.model.getExternalAttendees()},_prepareModel:function(){var e=$.Deferred();return this.model=new o({id:this.options.eventId,calendarId:this.options.calendarId}),this.model.fetch({success:e.resolve,error:e.reject,statusCode:{403:function(){n.util.error("403",{msgCode:"400-calendar"})},404:function(){n.util.error("404",{msgCode:"400-calendar"})},500:function(){n.util.error("500")}}}),e},_buildPartials:function(){return{title_and_date:r.compile(v)}},_submit:function(e){function r(){var e=t.formHelper.getForReserveAssetItems();e.length>0?f().always(function(){l()}):l()}function i(){return this.$("#check-company-event").is(":checked")?"company":"normal"}function s(){function t(){var t=this,r=$(t.alarmPopup.popupEl),i=r.find("input:checkbox[id='chkbox_push']").is(":checked"),s=r.find("input:checkbox[id='chkbox_mail']").is(":checked");n.set("pushNoti",i),n.set("mailNoti",s),e.resolve()}function r(){n.set("pushNoti",!1),n.set("mailNoti",!1),e.resolve()}function i(){e.reject()}var e=$.Deferred();return this.alarmPopup=new a,this.alarmPopup.setConfirmCallback(t,this),this.alarmPopup.setCancelCallback(r,this),this.alarmPopup.setCloseCallback(i,this),this.alarmPopup.render({type:"web"}),e}function f(){return t.formHelper.saveReservationAssets()}function l(){n.set(t._serializeFormData()),n.save({},{beforeSend:function(){t.submitFlag=!0},success:function(e){console.log("[CalendarRegistView#_submit] Success regist event!!!");var t=u.getInstance();t.add(e),c(e.get("calendarId")),d.goToCalendar()},error:function(){$.goSlideMessage(g["\uc77c\uc815 \ub4f1\ub85d\uc2dc \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4"],"caution")},complete:function(){t.submitFlag=!1}})}function c(e){var t=d.getSavedSelectedCalendar(),n=[];t&&(n=t.split(","),n.push(e.toString())),d.saveCheckedCalendar(n)}var t=this,n=new o;return this.submitFlag?($.goMessage(g["\uc77c\uc815 \ub4f1\ub85d \uc911 \uba54\uc2dc\uc9c0"]),!1):(e.preventDefault(),n.on("error:validate",$.proxy(this._validateErrorCallback,this)),n.set(t._setAttendantsFormData(i())),n.isAlone()?r():s().done(function(){r()}).fail(function(){t.submitFlag=!1}),!1)},_validateErrorCallback:function(e,t,n){return l.prototype.raiseError.apply(this.formHelper,arguments),this.submitFlag=!1,this},_serializeFormData:function(){var t=s.getDefaultCalendar().toJSON(),n=this.formHelper.serializeFormData();return e.extend({creator:t.owner},n)},_setAttendantsFormData:function(t){return{attendees:t==="normal"?e.union(this.attendeesHelper.getAttendees(),this.getExternalAttendees()):this.getExternalAttendees()}},_cancel:function(e){return e.preventDefault(),d.goToCalendar(),this},_showOrgSlider:function(e){return $.goOrgSlide({header:g["\ucc38\uc11d\uc790 \ucd94\uac00"],type:"node",desc:g["\uc77c\uc815\uc758 \ucc38\uc11d\uc790\ub85c \ucd94\uac00\ud560 \uc0ac\uc6a9\uc790\ub97c \uc544\ub798\uc5d0\uc11c \uc120\ud0dd\ud558\uc138\uc694"],contextRoot:n.config("contextRoot"),callback:$.proxy(this._addAttendees,this),memberTypeLabel:g["\ucc38\uc11d\uc790"],externalLang:m,isBatchAdd:!0})},_addAttendees:function(e){return this.attendeesHelper.addAttendee(e),this},_addReminder:function(){this.reminderHelper.addReminder()},_removeEventFromAttendees:function(e,t){$(t).remove(),this.attendeesScheduleLayerView.removeEventListener(e)},_addEventFromAttendees:function(e){this.attendeesScheduleLayerView.addEventListener(e)},getExternalAttendees:function(){return e.map(this.$("#externalArea").find("span.name"),function(e){return{id:"",email:$(e).data("email"),name:$(e).data("label")||"",position:""}})},initAutoComplete:function(){var e={autoResizeWidth:!0,makeFormat:!0,makeFormatFunc:$.proxy(this.makeFormatUnit,this),multiple:!1,width:"400px",matchCase:!0,notContact:"F",excSearchOption:"RIPD",isDomainSearch:"F",customLeft:!0};this.$("#externalForm").autocomplete(n.contextRoot+"api/mail/address/search/name",e)},makeFormatUnit:function(e,t){function v(e){var t=null,r=null;return $.ajax({url:n.contextRoot+"api/user/sort/list",data:{keyword:e},type:"GET",async:!1,success:function(e){hasName=e.data.length>0,hasName&&(t=e.data[0].name,r=e.data[0].email)},error:function(e){console.log(e)}}),{hasName:hasName,name:t,email:r}}var r=this;if($.trim(t)=="")return;addressArray=new Array,addressSplit=t.split(">,");for(var i=0;i<addressSplit.length;i++){tempAddressArray=addressSplit[i].split(",");for(var s=0;s<tempAddressArray.length;s++)tempAddressArray[s]=$.trim(tempAddressArray[s]);addressArray=addressArray.concat(n.util.makeFormatEmail(tempAddressArray))}for(var i=0;i<addressArray.length;i++){t=addressArray[i];var o=n.util.checkEmailFormat(t),u=null,a=o?n.util.get_name(t):t,f=o?a||n.util.get_email(t):t,l=$('<span class="name" id="nameField" evt-rol="select-field" onselectstart="return false"></span>').attr("title",f).data("email",o?n.util.get_email(t):"").data("label",a).data("select",!1).text(f),c="",h=$('<span class="ic_classic ic_del"></span>');h.attr("title","\uc0ad\uc81c").click(function(){var t=$(this).closest("li");t.find("input.edit").unautocomplete(),t.remove(),e.focus()});var p=$('<span class="btn_wrap"></span>').append(h),d=$("<li></li>");d.append(l).append(c).append(p),this.$("#externalArea").show(),this.$("#externals").append(d),e.val("")}},_deleteAll:function(){this.$el.find("#attendee-list li").not(".default_option").not(".creat").remove()},_toggleAttendee:function(e){var t=$(e.currentTarget),n=t.find("span.ic"),r=n.hasClass("ic_arrow_up");this.$("#attendee-list").find("li[data-more]").toggle(!r),n.toggleClass("ic_arrow_up"),n.toggleClass("ic_arrow_down")}});return b});