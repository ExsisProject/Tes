(function(){define(["backbone","app","calendar/collections/calendar_feeds","hgn!calendar/templates/preference/follow","i18n!nls/commons","i18n!calendar/nls/calendar","calendar/libs/util","jquery.go-grid"],function(e,t,n,r,i,s,o){var u={feed:"feed",follower:"follower"},a=u.feed,f=e.View.extend({id:"follow-config-pane",className:"calendar-config tab_conent_wrap",events:{"click input[type=radio][name=view_type]":"_changeFollowerListViewType","click #button-accept":"_alertForAccept","click #button-delete":"_confirmForRemove"},initialize:function(e){this.collection||(this.collection=n.create()),e.type=="follower"?this.__viewtype__=u.follower:this.__viewtype__=u.feed,this.$el.attr("data-type","follow"),this.dataTable=null,this.listenTo(this.collection,"sync",this._reloadTable),this.listenTo(this.collection,"remove",this._reloadTable),this.listenTo(this.collection,"reset",this._reloadTable),$(document).off(".calendar-preference"),$(document).on("reload:calendar-feeds.calendar-preference removed:calendar-feeds.calendar-preference",$.proxy(function(e){this._reloadTable()},this))},render:function(){this.$el.append(r({label:{followings:s["\ub0b4\uac00 \ub4f1\ub85d\ud55c \uad00\uc2ec \uce98\ub9b0\ub354"],followers:s["\ub0b4 \uc77c\uc815\uc744 \ubcf4\uace0 \uc788\ub294 \uad00\uc2ec\ub3d9\ub8cc"],accept:s["\uc218\ub77d"],"delete":i["\uc0ad\uc81c"],deny:s["\uac70\uc808"],member:i["\uc774\ub984"],status:s["\uc0c1\ud0dc"],updated_at:s["\uc124\uc815\uc77c"],calendar_name:i["\uce98\ub9b0\ub354"]}})),this.__viewtype__=="follower"&&$("#radio-followers").prop("checked",!0),this.loadDataTable(this.__viewtype__)},release:function(){this.stopListening(),this.remove()},activate:function(e){e==="follow"?this.$el.show():this.$el.hide()},loadDataTable:function(e){this.__viewtype__=""+(e||u.feed);var n=this,r=this._buildUrlByType(this.__viewtype__),i=this.$el.find("#customButtons");this.dataTable===null?this.dataTable=$.goGrid({el:"#feed-list-table",url:r,params:{property:"id",direction:"asc"},displayLength:this.__offset__,emptyMessage:this._buildEmptyMessage(),checkbox:!0,checkboxData:"id",columns:[{mData:null,sClass:"align_l",bSortable:!1,fnRender:function(e){var t={follower:e.aData.follower,feed:e.aData.calendar.owner}[n.__viewtype__];return["<span>",t.name," ",t.position,"</span>"].join("")}},{mData:null,bSortable:!1,fnRender:function(e){return["<span>",e.aData.calendar.name,"</span>"].join("")}},{mData:null,bSortable:!1,fnRender:function(e){var t={waiting:s["\uc2e0\uccad\ub300\uae30"],following:s["\uad00\uc2ec \uce98\ub9b0\ub354"]}[e.aData.state];return["<span>",t,"</span>"].join("")}},{mData:null,bSortable:!1,fnRender:function(e){return['<span class="date_info">',t.util.shortDate(e.aData.createdAt),"</span>"].join("")}}],fnDrawCallback:function(e){n.$el.find(".tool_bar .custom_header").append(i.show())}}):(this.dataTable.tables.fnSettings().sAjaxSource=r,this.dataTable.tables.fnClearTable()),$("#checkedAll").attr("checked",!1),this._setButtons(this.__viewtype__)},_reloadTable:function(){return this.dataTable&&this.loadDataTable(this.__viewtype__),this},_buildUrlByType:function(e){var n=""+(e||a),r=[t.config("contextRoot")+"api/calendar"];return n===u.feed?r.push(u.feed):r.push(u.follower),r.join("/")},_buildEmptyMessage:function(){var e=[];return e.push('<p class="data_null">'),e.push('<span class="ic_data_type ic_no_data"></span>'),e.push('<span class="txt">'+s["\uad00\uc2ec \uce98\ub9b0\ub354\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]+".</span>"),e.push("</p>"),e.join("\n")},_setButtons:function(e){var t=""+(e||u.feed);return t===u.feed?(this.$el.find("#button-accept").hide(),this.$el.find("#button-delete > span.txt_caution").text(i["\uc0ad\uc81c"])):(this.$el.find("#button-accept").show(),this.$el.find("#button-delete > span.txt_caution").text([i["\uc0ad\uc81c"],"(",s["\uac70\uc808"],")"].join(""))),this},_changeFollowerListViewType:function(e){var t=this.$(e.currentTarget);return this.loadDataTable(t.val()),this},_alertForAccept:function(e){var t=this,n=this.dataTable.tables.getCheckedData(),r=_.filter(n,function(e){return e.state==="waiting"});if(r.length<=0){$.goAlert(s["\ub300\uae30\uc0c1\ud0dc\uc758 \uce98\ub9b0\ub354\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694"],s["\uad6c\ub3c5 \uc218\ub77d \uc120\ud0dd \uc624\ub958 \uba54\uc2dc\uc9c0"]);return}return $.goConfirm(s["\uad00\uc2ec \uce98\ub9b0\ub354 \uc2e0\uccad\uc744 \uc218\ub77d\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],s["\uad00\uc2ec \uce98\ub9b0\ub354 \uc218\ub77d \uba54\uc2dc\uc9c0"],function(e){t._acceptFollow(r)}),this},_confirmForRemove:function(e){e.preventDefault();var t=this,n=this.dataTable.tables.getCheckedData(),r=this.$el.find("input[type=radio][name=view_type]:checked").val()||a,i={feed:s["\uad00\uc2ec \uce98\ub9b0\ub354 \uc0ad\uc81c"],follower:s["\uad00\uc2ec \uce98\ub9b0\ub354 \uc0ad\uc81c"]}[r],o={feed:s["\uad00\uc2ec \uce98\ub9b0\ub354 \ud574\uc81c \uc54c\ub9bc \uba54\uc2dc\uc9c0"],follower:s["\uc0c1\ub300\ubc29 \uad00\uc2ec \uce98\ub9b0\ub354 \uc911\uc9c0 \uc54c\ub9bc \uba54\uc2dc\uc9c0"]}[r];return n.length>0?$.goConfirm(i,o,function(e){t._removeRelationship(r,n)}):$.goAlert(s["\uba64\ubc84\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694"],s["\uba64\ubc84\ub97c \uc120\ud0dd\ud558\uc9c0 \uc54a\uc73c\uc168\uc2b5\ub2c8\ub2e4. \uba64\ubc84\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694"]),this},_acceptFollow:function(e){var n=this,r=$.Deferred(),i=0;return _.each(e,function(n,s){var o=[t.config("contextRoot")+"api/calendar/follower/",n.id,"/accept"].join("");$.ajax(o,{type:"POST",async:!1}).fail(function(){console.log("Error!!!")}).always(function(){i++,i===e.length&&r.resolve()})}),r.done(function(){n.loadDataTable(n.__viewtype__)}),this},_removeRelationship:function(e,n){var r=this,i=_.pluck(n,"id"),s=""+(e||a);return $.ajax({url:t.config("contextRoot")+"api/calendar/"+s,type:"DELETE",data:JSON.stringify({ids:i}),dataType:"json",contentType:"application/json"}).then(function(){r.collection.remove(i,{silent:!0}),o.triggerRemoveFeed()}),this}});return f})})();