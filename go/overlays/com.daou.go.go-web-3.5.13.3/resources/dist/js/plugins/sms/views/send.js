define("sms/views/send",function(require){var e=require("i18n!nls/commons"),t=require("i18n!sms/nls/sms"),n=require("i18n!contact/nls/contact"),r=require("sms/views/base_sms"),i=require("sms/views/connector"),s=require("hgn!sms/templates/send"),o=require("hgn!sms/templates/receiver_item"),u=require("hgn!sms/templates/receiver_empty"),a=require("hgn!sms/templates/connector"),f=require("models/user_profile"),l=require("sms/models/access_config"),c=require("sms/models/message"),h=require("views/profile_card"),p=require("file_upload"),d=require("app"),v={"delete":e["\uc0ad\uc81c"],add:e["\ucd94\uac00"],phone:e["\uc804\ud654\ubc88\ud638"],senderNumber:t["\ubc1c\uc2e0\ubc88\ud638"],send:e["\ubcf4\ub0b4\uae30"],photo:e["\uc0ac\uc9c4"],name:e["\uc774\ub984"],lms:t["\uc7a5\ubb38"],contentPlaceholder:t["\uba54\uc2dc\uc9c0\ub97c \uc791\uc131\ud574\uc8fc\uc138\uc694."],subjectPlaceholder:t["\uc81c\ubaa9\uc785\ub825"]+"("+d.i18n(t["\ucd5c\ub3000byte"],"arg1",30)+", "+t["\ubc1c\uc1a1\uad00\ub9ac\uc6a9"]+")",senderNumDesc:t["\ubc1c\uc2e0\ubc88\ud638\uc548\ub0b4\uba54\uc138\uc9c0"],fileSizeDesc:t["\ubb38\uc790\ubc1c\uc1a1 \ud30c\uc77c\ud06c\uae30\ucd08\uacfc"]},m=GO.session("loginId")+".sms.rep.number",g=r.extend({events:{"click .delete_receiver":"deleteReceiver","click #addReceiver":"addReceiver","click span.send_message":"sendMessage","keyup textarea#messageContent":"checkMessageCount","keyup #subject":"checkSubjectCount","click span.ic_del":"deleteFile","click #openConnector":"openConnector"},initialize:function(e){r.prototype.initialize.apply(this,arguments),this.accessModel=new l,this.messageType="SMS"},render:function(){var e=this;r.prototype.render.apply(this,arguments),$("h1#breadcrumb").empty().html(t["\ubb38\uc790 \ubc1c\uc1a1"]),this.userProfile=f.read(GO.session().id).toJSON(),this.accessModel.fetch({async:!1}),this.isLms=this.accessModel.isLms(),this.isMms=this.accessModel.isMms(),this.$el.html(s({user:this.userProfile,lang:v,isLms:this.isLms,isMms:this.isMms})),this.$el.find("a[data-userid]").click(function(e){var t=$(e.currentTarget).attr("data-userid");t!=""&&h.render(t,e.currentTarget)}),$.ajax({type:"GET",async:!1,dataType:"json",url:GO.contextRoot+"api/sms/repnumber/normal",success:function(n){n.data.length<1&&(e.userProfile.mobileNo||($.goMessage(t["\ubc1c\uc2e0\uc790 \ud578\ub4dc\ud3f0 \ubc88\ud638\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc544 \ubb38\uc790\ubc1c\uc1a1\uc744 \ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),d.router.navigate("sms",!0))),n.data&&_.each(n.data,function(e){var t='<option data-id="'+e.id+'" value="'+e.repNumber+'">'+e.repNumber+"( "+e.name+" )"+"</option>";$("#select_number").append(t)})},error:function(e){$.goError(e.responseJSON.message)}}),GO.util.store.get(m)&&$("#select_number option[data-id='"+GO.util.store.get(m)+"']").attr("selected",!0),this.changeReceiverCount(),this.initFileUpload(),$("#subject").placeholder(),$("#messageContent").placeholder(),$("#receiverName").placeholder(),$("#receiverNumber").placeholder()},initFileUpload:function(n){var r=this,n={el:"#file-control",context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+t["\ud3ec\ud1a0"]+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie"),progressBarUse:!1};(new p(n)).queue(function(e,t){}).start(function(n,r){var i=new RegExp("(jpeg|jpg)","gi"),s=r.type;if(r.size>61440||!i.test(s))return $.goMessage(t["\ubb38\uc790\ubc1c\uc1a1 \ud30c\uc77c\ud06c\uae30\ucd08\uacfc"]),!1;var o=$(".img_wrap").children().size();if(1<=o)return $.goMessage(d.i18n(e["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",1)),!1}).progress(function(e,t){}).success(function(e,t,n){r.$el.find("#fileComplete").children().remove(),r.$el.find("#fileComplete").append(n),r.$el.find("#attachButton").hide()}).complete(function(e,t){}).error(function(e,t){})},deleteFile:function(e){var t=$(e.currentTarget),n=t.parents("li");n.remove(),$("#attachButton").show()},deleteReceiver:function(e){var t=$(e.currentTarget);t.closest("tr").remove(),this.changeReceiverCount()},addReceiver:function(t){var r=$("#receiverNumber").val(),i=$("#receiverName").val(),s=function(e,t){return $.goMessage(e),t&&t.focus(),!1};if(!$.goValidation.isInvalidTel(r)||r.length==0)return s(n["\ubc88\ud638\ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4(-,0~9)"],$("#receiverNumber")),!1;if(!$.goValidation.isCheckLength(0,64,i))return s(d.i18n(e["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"64"}),$("#receiverName")),!1;var u=o({name:i,number:r,icon:"ic_user",deleteItem:e["\uc0ad\uc81c"]});$("table.address_list>tbody").prepend(u),$("#receiverName").val(""),$("#receiverNumber").val(""),this.changeReceiverCount()},openConnector:function(n){var r=this,s=new i;this.popupEl=$.goPopup({pclass:"layer_normal layer_address layer_message",header:e["\uc8fc\uc18c\ub85d"]+" / "+e["\uc870\uc9c1\ub3c4"],width:1e3,modal:!0,allowPrevPopup:!0,buttons:[{btype:"confirm",btext:e["\ud655\uc778"],autoclose:!1,callback:function(n,i){var u=s.getData();if(!u){$.goSlideMessage(t["\uc218\uc2e0\uc790\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],"caution");return}_.each(u,function(t){function s(e){var t;return e=="group"?t="ic_team":e=="department"||e=="subdepartment"?t="ic_company":t="ic_user",t}var n=t.name;t.type=="subdepartment"&&(n+="("+t.nameAddition+")");var i=o({name:n,id:t.id,type:t.type,number:t.mobileNo,icon:s(t.type),deleteItem:e["\uc0ad\uc81c"]});$("table.address_list>tbody").append(i),r.popupEl.close(),r.changeReceiverCount()})}},{btype:"cancel",btext:e["\ucde8\uc18c"],autoclose:!1,callback:function(e,t){e.close("",t)}}]}),this.popupEl.find(".content").html(s.el),s.render(),this.popupEl.reoffset()},checkMessageCount:function(n){var r=$("#messageContent").val(),i=this.checkByte(r),s=this.isLms?"2000 Byte":"90 Byte";i>90?(this.isLms||$.goMessage(t["\uc7a5\ubb38"]+" "+e["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),this.messageType="LMS",$("#lmsType").show(),$("#subject").attr("placeholder",t["\uc81c\ubaa9\uc785\ub825"]+"("+d.i18n(t["\ucd5c\ub3000byte"],"arg1",30)+")")):(this.messageType="SMS",$("#lmsType").hide(),$("#subject").attr("placeholder",v.subjectPlaceholder)),$("#messageCount").text(i+" / "+s)},checkSubjectCount:function(e){var t=$("#subject").val(),n=this.checkByte(t);n>30&&$("#subject").val(this.subStringByByte(t))},changeReceiverCount:function(e){var n=$("table.address_list>tbody>tr.receiver_item").length,r=GO.i18n(t["\ucd1d\uac74\uc218"],{num:n});$("#totalCount").text(r);if(n==0){var i=u({});$("table.address_list>tbody").prepend(i)}else $("#receiverEmpty").remove()},subStringByByte:function(e){var t=e,n=0;for(var r=0;r<t.length;r++){t.charCodeAt(r)>128?n+=2:n+=1;if(n>30)return t.substring(0,r)}return str},checkByte:function(e){var t=0,n=e;for(var r=0;r<n.length;r++){var i=n.charCodeAt(r);i>128?t+=2:t++}return t},getAttaches:function(){var e=[];return $.each(this.$el.find("ul.img_wrap li"),function(t,n){var r=$(n);e.push({id:r.attr("data-id"),name:r.attr("data-name"),path:r.attr("data-path"),hostId:r.attr("host-id")})}),e},sendMessage:function(){var n=this,r=$("#messageContent").val(),i=$("table.address_list>tbody>tr.receiver_item");if(r.length==0){$.goMessage(t["\uba54\uc2dc\uc9c0\ub97c \uc791\uc131\ud574\uc8fc\uc138\uc694."]);return}if(i.length==0){$.goMessage(t["\uc218\uc2e0\uc790\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var s=new c,o=[],u=[],a=null,f=[],l=n.getAttaches();if(l.length>1)return $.goMessage(d.i18n(e["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",1)),!1;var h=this.checkByte(r);l.length>0?this.messageType="MMS":h>90?this.messageType="LMS":this.messageType="SMS",$.goConfirm(t["\ubb38\uc790 \ubc1c\uc1a1"],t["\ubb38\uc790\ub97c \ubc1c\uc1a1\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],function(){$.each(i,function(e,t){var n=$(t).attr("data-type");n=="department"||n=="subdepartment"?f.push({nodeId:$(t).attr("data-id"),nodeType:$(t).attr("data-type"),nodeDeptName:$(t).attr("data-name")}):n=="group"?u.push($(t).attr("data-id")):o.push({receiverName:$(t).attr("data-name"),receiverNumber:$(t).attr("data-number")})});var t=$("#select_number option:selected").val(),a=$("#select_number option:selected").attr("data-id"),c=$("#subject").val();s.set({messageType:n.messageType,subject:c,content:r,receivers:o,contactGroupReceivers:u,circleReceiver:{nodes:f},attaches:l,senderNumber:t}),s.save({},{type:"POST",success:function(t,n){n.code=="200"&&($.goMessage(e["\uc131\uacf5\ud588\uc2b5\ub2c8\ub2e4."]),GO.util.store.set(m,a),d.router.navigate("sms/"+t.toJSON().id+"/detail",!0))},error:function(e,t){var n=JSON.parse(t.responseText);$.goMessage(n.message)}})})}});return g});