define("admin/models/auth/app_integrated_auth",function(require){var e=Backbone.Model.extend({initialize:function(e,t,n){var r=this;this.attributes=e,this.groupName=t,this.groupKey=n,this.authLevel=this.get("authLevel"),this.name=this.get("name"),this.contentName=this.get("contentName"),this.contentId=this.get("contentId")?this.get("contentId"):0,this.checked=!1,this.view=!0,this.owner=this.get("owner"),this.originLink=this.get("originLink"),this.appAuthType=this.get("authType"),this.authDataType=this.get("authDataType"),this.circle=this.get("circle"),!this.circle||(this.firstCircle=JSON.parse(JSON.stringify(this.get("circle")))),this.originCircle=this.get("originCircle"),this.users=this.get("users"),this.tooltip=this.get("tooltip"),this.actionModel=this.get("actionModels"),this.companyShare=this.get("companyShare"),this.contentKey=this.appAuthType+"_"+this.contentId,this.contentSize=this.get("contentSize")},isEmptyContent:function(){return this.contentSize===0},duplicatedCheckCircle:function(e){if(!e||!e.nodes||e.nodes.length<2)return e;for(var t=0;t<e.nodes.length;t++){var n=e.nodes[t];if(n.nodeType!=="user")continue;for(var r=t+1;r<e.nodes.length;r++){var i=e.nodes[r];n.nodeId===i.nodeId&&i.nodeType==="user"&&e.nodes.splice(r,1)}}return e},clearData:function(){this.circle={},this.actionModel=[],this.updated=!0},updateCircleData:function(e){this.circle=this.duplicatedCheckCircle(e),this.updated=!0},updateCircle:function(e){this.circle=this.duplicatedCheckCircle(e);var t=this;$.ajax({url:GO.contextRoot+"ad/api/auth/save",data:t.getSaveJsonStr(),type:"POST",async:!1,contentType:"application/json",success:function(e){},error:function(e){}})},addUser:function(e){var t=this;if(this.authDataType==="CIRCLE_ACTION"){this.addUserModel(e),this.updated=!0;return}$.ajax({url:GO.contextRoot+"ad/api/auth/save",data:this.getSaveJsonStr(e),type:"POST",async:!1,contentType:"application/json",success:function(n){t.addUserModel(e)},error:function(e){}})},clear:function(){this.users=[],this.circle={},this.actionModel=[]},isOnlyUserCircle:function(){if(!this.circle||!this.circle.nodes)return!1;var e=!0;for(var t=0;t<this.circle.nodes.length;t++)if(this.circle.nodes[t].nodeType!=="user"){e=!1;break}return e},clearUser:function(){var e=this,t=[];if(this.users)_.forEach(this.users,function(n){t[t.length]=e.getSaveModel(n)});else if(this.actionModel)_.forEach(this.actionModel,function(n){t[t.length]=e.getSaveModel(n.user)});else if(this.circle)if(this.isOnlyUserCircle()){var n=[];_.forEach(this.circle.nodes,function(e){e&&e.nodeType==="user"&&(n[n.length]=e.nodeId)});var r=e.getSaveModel({id:0});r.userIds=n,t[t.length]=r}else this.updateCircle({});return t},removeUser:function(e){var t=this;if(this.authDataType==="CIRCLE_ACTION"){this.removeUserModel(e),this.updated=!0;return}$.ajax({url:GO.contextRoot+"ad/api/auth/remove",data:this.getSaveJsonStr(e),type:"POST",async:!1,contentType:"application/json",success:function(n){t.removeUserModel(e)},error:function(e){}})},removeUserModel:function(e){if(this.users){for(var t=0;t<this.users.length;t++)if(this.users[t].id==e.id){this.users.splice(t,1);return}}else if(this.actionModel)for(var t=0;t<this.actionModel.length;t++)if(this.actionModel[t].user.id==e.id){this.actionModel.splice(t,1);return}},addUserModel:function(e){if(this.authDataType==="USER_ACTION"||this.authDataType==="CIRCLE_ACTION"){var t=this.findAction(e.id);if(t)return;this.actionModel||(this.actionModel=[]),this.actionModel[this.actionModel.length]={user:e,read:!0,write:!0,remove:!0,manage:!0}}else if(this.authDataType==="USER"){if(this.appAuthType==="CommunityMaster"){this.users=[],this.users[0]=e;return}var n=this.findUser(e.id);if(n)return;this.users||(this.users=[]),this.users[this.users.length]=e}this.updated=!0},getSaveJsonStr:function(e){return JSON.stringify(this.getSaveModel(e))},getSaveModel:function(e,t){var n="",r=e?e.id:undefined,i=this.findAction(r);i?n=this.convertActionStr(i):n="read,write,remove,manage";if(this.authDataType==="CIRCLE"&&e&&!!t){var s=this.findCircleIdx(r);s>=0&&this.circle.nodes.splice(s,1)}else if(this.authDataType==="CIRCLE"&&e){var s=this.findCircleIdx(r);s<0&&(this.circle.nodes[this.circle.nodes.length]={nodeType:"user",nodeId:e.id,nodeValue:e.displayName})}return{appAuthType:this.appAuthType,contentId:this.contentId,circle:this.circle,firstCircle:this.firstCircle,originCircle:this.originCircle,actionModel:this.actionModel,userId:r,options:n}},convertActionStr:function(e){var t="";return t+=e.read?"read,":"",t+=e.write?"write,":"",t+=e.remove?"remove,":"",t+=e.manage?"manage,":"",t},convertActionToCircle:function(){var e=this,t={};return t.nodes=[],_.forEach(this.actionModel,function(t){e.circle.nodes[e.circle.nodes.length]={nodeId:t.user.id,nodeType:"user",actions:e.convertActionStr(t)}}),t},findCircleIdx:function(e){if(!this.circle||!this.circle.nodes)return this.circle={},this.circle.nodes=[],-1;for(var t=0;t<this.circle.nodes.length;t++){var n=this.circle.nodes[t];if(n.nodeType==="user"&&n.nodeId===e)return t}return-1},findUser:function(e){if(this.users)for(var t=0;t<this.users.length;t++)if(e==this.users[t].id)return this.users[t];return undefined},findAction:function(e){if(this.actionModel)for(var t=0;t<this.actionModel.length;t++)if(this.actionModel[t].user.id==e)return this.actionModel[t];return undefined},updatedChecked:function(e){return this.checked=e.indexOf(this.contentKey)>=0,this.checked?1:0}});return e});