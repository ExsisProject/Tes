(function(){define(["backbone","i18n!nls/commons","i18n!admin/nls/admin","i18n!works/nls/works","collections/paginated_collection","hgn!admin/templates/works/applet_stats_detail","admin/models/applet_stats_detail","go-nametags","admin/views/works/applet_share_item","works/models/applet_baseconfig","jquery.go-orgslide","jquery.go-preloader"],function(e,t,n,r,i,s,o,u,a,f){var l={"\uc800\uc7a5":t["\uc800\uc7a5"],"\ucde8\uc18c":t["\ucde8\uc18c"],"\ubaa9\ub85d\uc73c\ub85c \ub3cc\uc544\uac00\uae30":n["\ubaa9\ub85d\uc73c\ub85c \ub3cc\uc544\uac00\uae30"],"\uc0ad\uc81c":t["\uc0ad\uc81c"],count:t["\uac1c"],"\uc0ad\uc81c\ud558\uae30":t["\uc0ad\uc81c\ud558\uae30"],"\uae30\ubcf8\uc815\ubcf4":n["\uae30\ubcf8\uc815\ubcf4"],"\uc0dd\uc131\uc77c":n["\uc0dd\uc131\uc77c"],"\uc6b4\uc601\uc790":n["\uc6b4\uc601\uc790"],"\uc6b4\uc601\uc790 \ucd94\uac00":n["\uc6b4\uc601\uc790 \ucd94\uac00"],"\ub370\uc774\ud130":r["\ub370\uc774\ud130"],"\ub370\uc774\ud130 \ub4f1\ub85d \uc218":r["\ub370\uc774\ud130 \ub4f1\ub85d \uc218"],"\uc0dd\uc131\uc790":r["\uc0dd\uc131\uc790"],"\uc571\uba85":r["\uc571\uba85"],"\ucd1d \uc571 \uac1c\uc218":r["\ucd1d \uc571 \uac1c\uc218"],"\ucd1d \ub370\uc774\ud130 \uc218":r["\ucd1d \ub370\uc774\ud130 \uc218"],"\uacf5\uc720 \uc124\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4":r["\uacf5\uc720 \uc124\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],"\uacf5\uc720 \uc124\uc815":r["\uacf5\uc720 \uc124\uc815"],"\uacf5\uc720 \uc815\ubcf4":r["\uacf5\uc720 \uc815\ubcf4"],"\ud074\ub798\uc2a4 \uad6c\ubd84":r["\ud074\ub798\uc2a4 \uad6c\ubd84"]},c=!1,h=i.extend({url:function(){return GO.config("contextRoot")+"api/works/applets/"+this.appletId+"/docs/export?"+this.makeParam()},setAppletId:function(e){this.appletId=e}}),p=e.View.extend({events:{"click #btn-confirm":"_onConfirm","click #btn-goback":"_goBack","click #btn-cancel":"_cancel","click #btn-share-delete":"shareDeleteItem","click #btn-app-delete":"appleteDelete"},initialize:function(e){this.options=e||{},this.appletId=e.id,this.statsDetail=new o({appletId:this.appletId}),this.statsDetail.fetch({async:!1})},render:function(){return this.$el.html(s({lang:l,stats:this.statsDetail.toJSON(),createdAt:GO.util.shortDate(this.statsDetail.get("createdAt")),docCount:GO.util.numberWithCommas(this.statsDetail.get("docCount"))})),this.renderAdminList(),this.renderShareList(),this},renderAdminList:function(){var e=this;this.nameTagView=u.create({},{useAddButton:!0}),this.$("ul.name_tag").html(this.nameTagView.el),this.nameTagView.$el.on("nametag:clicked-add",function(t,n){$.goOrgSlide(e._getOrgOption(n))}),_.each(this.statsDetail.get("admins"),function(e){this.nameTagView.addTags({id:e.id,displayName:e.name+(e.position?" "+e.position:"")},{removable:!0,attr:e})},this)},_getOrgOption:function(e){var t={contextRoot:GO.contextRoot,isAdmin:!0,header:n["\uc6b4\uc601\uc790 \ucd94\uac00"],callback:$.proxy(function(t){e.addTags(t,{removable:!0,attr:t})},this)};return t},renderShareList:function(){var e=this.statsDetail.getShareNodes();e.length>0&&(this.$("#shareList").empty(),_.each(e,function(e){var t=new a({item:e});this.$("#shareList").append(t.render().el)},this))},reload:function(){this.statsDetail.fetch({async:!1}),this.renderAdminList(),this.renderShareList()},shareDeleteItem:function(e){console.log("shareDeleteItem");var t=$(e.currentTarget).parent().parent().parent(),n=t.attr("data-nodeid"),r=t.attr("data-nodetype"),i=t.attr("data-nodedeptid"),s=this.getByNodeIdAndType(n,r,i);s&&this.$el.find('[data-nodeid="'+n+'"]').remove()},getByNodeIdAndType:function(e,t,n){var r;return _.each(this.statsDetail.getShareNodes(),function(i){var s=e==i.nodeId,o=t==i.nodeType;_.contains(["department","subdepartment"],t)&&this.statsDetail.isDeptType(t,!0)&&(o=!0),this.statsDetail.isUserWithDeptType(t,n)&&(o=s&&i.nodeDeptId==n);if(s&&o){r=i;return}},this),r},getShareList:function(){var e=this,t=[];return $("#shareList").find("tr").each(function(n,r){var i=$(r);_.each(e.statsDetail.getShareNodes(),function(e){i.data("nodeid")==e.nodeId&&t.push(e)})}),t},appleteDelete:function(e){e.preventDefault();var n=this;$.goPopup({pclass:"layer_confim",modal:!0,contents:'<p class="q">'+r["\uc571\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"]+"</p>"+'<p class="desc">'+r["\uc571 \uc0ad\uc81c \uc124\uba85"]+"</p>",buttons:[{btext:t["\uc0ad\uc81c"],autoclose:!1,btype:"confirm",callback:function(e){$.ajax({type:"DELETE",dataType:"json",url:GO.contextRoot+"ad/api/works/applets/"+n.appletId,success:function(n){e.close(),$.goMessage(t["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),GO.router.navigate("works/applets",{pushState:!0,trigger:!0})},error:function(e){$.goError(e.message)}})}},{btext:t["\ucde8\uc18c"],btype:"cancel"}]})},_onConfirm:function(e){e.preventDefault();var n=_.map($("ul.name_tag").find("li[data-id]"),function(e){return{id:$(e).data("id")}});if(n.length<1){$.goError(r["\uc6b4\uc601\uc790\ub97c \ucd94\uac00\ud574 \uc8fc\uc138\uc694"]);return}this.statsDetail.set("admins",n);var i=this.statsDetail.displayShareValue();i.circle.nodes=this.getShareList(),this.statsDetail.set("appletShareModel",i);var s=null;if(c){$.goSlideMessage(r["\uc800\uc7a5\uc911 \uba54\uc138\uc9c0"]);return}this.statsDetail.save({},{type:"PUT",beforeSend:function(){s=$.goPreloader(),c=!0},success:function(){$.goMessage(t["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(){$.goMessage(t["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])},statusCode:{400:function(){GO.util.error("400",{msgCode:"400-works"})},403:function(){GO.util.error("403",{msgCode:"400-works"})},404:function(){GO.util.error("404",{msgCode:"400-works"})},500:function(){GO.util.error("500")}},complete:function(){s.release(),c=!1}})},_cancel:function(e){e.preventDefault(),this.reload(),$.goMessage(t["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},_goBack:function(e){e.preventDefault(),GO.router.navigate("works/applets",{pushState:!0,trigger:!0})}});return p})}).call(this);