define(function(require){var e=require("backbone"),t=require("hgn!admin/templates/ip_access_config"),n=require("hgn!admin/templates/ip_list_import_popup"),r=require("i18n!admin/nls/admin"),i=require("i18n!nls/commons");return require("jquery.filedownload"),require("jquery.fileupload"),e.View.extend({el:"#ipAccessConfig",events:{"click #addBtn":"onAddBtnClicked","click #delBtn":"onDelBtnClicked","click #exportBtn":"onExportBtnClicked","click #importBtn":"onImportBtnClicked","click #searchBtn":"onSearchBtnClicked","click #saveBtn":"onSaveBtnClicked","click #cancelBtn":"onCancelBtnClicked","click #ipListSelectBox option":"onIpListSelected","change #ipInputType":"onIpInputTypeChanged","change .webAccessType":"onWebAccessTypeChanged","keyup .inputStr":"onKeyUpInInputBox"},initialize:function(){this.bindCtrlKeyEvent()},render:function(){var e=this;this.$el.html(t({adminLang:r,commonLang:i})),$.ajax({url:GO.contextRoot+"ad/api/access/site/config",type:"GET"}).done(function(t){(function(){var r=t.data.webAccessType;e.$el.find(".webAccessType").prop("checked",!1),e.$el.find('.webAccessType[data-type="'+r+'"]').prop("checked",!0),r!="ALL"&&e.$el.find("#ipAccessConfigDetailOption").show()})(),function(){var r=t.data.allowedIps;_.each(r,function(t){var n=t.split(":"),r=n[0],i=n[1];e.appendAllowedIp(r,i)})}()})},bindCtrlKeyEvent:function(){$(document).keyup($.proxy(this.onCtrlKeyUp,this)),$(document).keydown($.proxy(this.onCtrlKeyDown,this))},onCtrlKeyUp:function(e){var t=this;e.keyCode===17&&(t.ctrlKeyIsDown=!1)},onCtrlKeyDown:function(e){var t=this;e.keyCode===17&&(t.ctrlKeyIsDown=!0)},onKeyUpInInputBox:function(e){var t=$(e.currentTarget),n=t.hasClass("inputStr")&&!t.hasClass("inputStrEnd"),r=t.val().length>2;n&&r&&t.next().next().focus()},onAddBtnClicked:function(){var e=$(".ipInputArea:visible"),t=e.data("type"),n=_.chain(e.find(".inputStr")).map(function(t){return $(t).is("input")?$(t).val():$(t).text()}).map(function(t){return t==0?0:t.replace(/(^0+)/,"")}).value().join("");if(!this.validateIpPattern(t,n)){$.goMessage(r["\uc720\ud6a8\ud558\uc9c0 \uc54a\uc740 IP \ud615\uc2dd\uc785\ub2c8\ub2e4."]);return}this.appendAllowedIp(t,n)},onDelBtnClicked:function(){var e=$("#ipListSelectBox option:selected");return _.forEach(e,function(t){$(t).remove()})},onExportBtnClicked:function(){var e=GO.contextRoot+"ad/api/access/site/config/export";$.fileDownload(e,{httpMethod:"POST",data:{allowedIps:this.getAllowedIps().join()}})},onImportBtnClicked:function(){var e=this;(function(){$.goPopup({title:r["IP \ubaa9\ub85d \uac00\uc838\uc624\uae30"],contents:n({adminLang:r}),buttons:[{btype:"confirm",btext:i["\ucd94\uac00"],callback:$.proxy(e.importIpAccessList,e)},{btype:"close",btext:i["\ucde8\uc18c"]}]})})(),function(){$("#fileupload").fileupload({url:GO.contextRoot+"ad/api/access/site/config/import",dataType:"json",singleFileUploads:!0,add:function(e,t){var n=t.originalFiles[0].name,r=n.substring(n.lastIndexOf("."),n.length);if(r!=".txt"){$.goMessage(i["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."]);return}$("#importFileName").val(n),t.paramName="file",t.submit()},done:function(e,t){if(t.result&&t.result.data){var n=t.result.data;_.each(n,function(e){var t=e.split(":"),n='<option value="'+e+'">'+t[1]+"</option>";$("#importedIpListArea").html(),$("#importedIpListArea").append(n)})}},fail:function(){$.goMessage(r["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."])}})}()},importIpAccessList:function(){var e=this;_.each($("#importedIpListArea option"),function(n){var r=$(n).val().split(":")[0],i=$(n).text();e.validateIpPattern(r,i)&&e.appendAllowedIp(r,i)})},onSearchBtnClicked:function(){var e=this.$el.find("#searchInput").val();if(e){var t=$("#ipListSelectBox option");t.prop("selected",!1),_.forEach(t,function(n){var r=$(n).val();r.includes(e)&&$(n).prop("selected",!0)})}},onIpListSelected:function(e){this.ctrlKeyIsDown||$("#ipListSelectBox option").prop("selected",!1),$(e.currentTarget).prop("selected",!0)},onIpInputTypeChanged:function(e){var t=$(e.currentTarget).find("option:selected").data("type");this.$el.find(".ipInputArea").hide(),this.$el.find('.ipInputArea[data-type="'+t+'"]').css("display","inline-block")},onWebAccessTypeChanged:function(e){var t=$(e.currentTarget).data("type");t!="ALL"?this.$el.find("#ipAccessConfigDetailOption").show():this.$el.find("#ipAccessConfigDetailOption").hide()},appendAllowedIp:function(e,t){function s(){return'<option value="'+r+'">'+t+"</option>"}var n=this.getAllowedIps(),r=e+":"+t;if(n.includes(r))return;var i=this.$el.find("#ipListSelectBox");i.append(s(e,t))},validateIpPattern:function(e,t){function r(e){return n.test(e)}function i(e){var t=e.split("-"),r=n.test(t[0])&&n.test(t[1]),i=t[0].replace(/\./g,"")<t[1].replace(/\./g,"");return r&&i}function s(e){var t=e.split("/"),r=/^([0-9]|[0-2][0-9]|3[0-2])$/,i=n.test(t[0]),s=r.test(t[1]);return i&&s}var n=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;return e=="ip"?r(t):e=="range"?i(t):e=="sub"?s(t):!1},onSaveBtnClicked:function(){GO.util.preloader($.ajax({url:GO.contextRoot+"ad/api/access/site/config",type:"POST",contentType:"application/json",data:JSON.stringify({webAccessType:this.getWebAccessType(),allowedIps:this.getAllowedIps()})}).done(function(){$.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])}).fail(function(e){e.responseJSON&&e.responseJSON.message?$.goMessage(e.responseJSON.message):$.goMessage(r["\uc694\uccad \ucc98\ub9ac \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."])}))},onCancelBtnClicked:function(){var e=this;$.goCaution(i["\ucde8\uc18c"],i["\ubcc0\uacbd\ud55c \ub0b4\uc6a9\uc744 \ucde8\uc18c\ud569\ub2c8\ub2e4."],function(){e.render(),$.goMessage(i["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},i["\ud655\uc778"])},getAllowedIps:function(){var e=$("#ipListSelectBox option");return _.map(e,function(t){return $(t).val()})},getWebAccessType:function(){return this.$el.find(".webAccessType:checked").data("type")}})});