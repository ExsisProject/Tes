(function(){define(["jquery","backbone","app","admin/models/base_model","hgn!admin/templates/mail/alias_create","hgn!admin/templates/mail/alias_modify","i18n!nls/commons","i18n!admin/nls/admin","GO.util","jquery.go-popup","jquery.go-orgslide","jquery.go-aliasorgslide","jquery.go-validation"],function(e,t,n,r,i,s,o,u){var a=null,f={label_alias_create:u["\ubcc4\uce6d \uacc4\uc815 \ucd94\uac00"],label_ok:o["\uc800\uc7a5"],label_cancel:o["\ucde8\uc18c"],label_enabled_status:u["\uc815\uc0c1"],label_disabled_status:u["\uc911\uc9c0"],label_alias_name:u["\ubcc4\uce6d \uacc4\uc815 \uc774\ub984"],label_alias_id:u["\ubcc4\uce6d \uacc4\uc815 \uc544\uc774\ub514"],label_service_status:u["\uc11c\ube44\uc2a4 \uc0c1\ud0dc"],label_forwarding_email:u["\uc804\ub2ec\ud560 \uc774\uba54\uc77c"],label_select_account:u["\uacc4\uc815 \uc120\ud0dd"],label_select_alias:u["\ubcc4\uce6d \uc120\ud0dd"],label_delete:u["\uc0ad\uc81c"],label_modify:u["\uc218\uc815"],label_forwrding_detail_user:u["(\ubd80\uc11c,\uc0ac\uc6a9\uc790)"],label_forwrding_detail_alias:u["(\ubcc4\uce6d \uacc4\uc815)"],label_move_list:u["\ubaa9\ub85d\uc73c\ub85c \ub3cc\uc544\uac00\uae30"],id_tooltip:u["\uc544\uc774\ub514 \ud234\ud301"]},l=t.View.extend({events:{"click #selectAccount":"addAccount","click #selectAlias":"addAlias","click ul.name_tag li span.ic_del":"deleteEamil","click #btn_ok":"saveAlias","click span.editable":"changeInput","click #btn_cancel":"cancel","click #btn_move_list":"moveList"},initialize:function(e){this.$el.off(),this.options=e||{},this.renderEl=this.options.renderEl,this.aliasId=this.options.aliasId,this.parentId=this.options.parentId,this.useLayout=this.options.useLayout==undefined?!0:this.options.useLayout,this.model=new r({urlRoot:GO.contextRoot+"ad/api/mail/alias",id:this.aliasId});var n=new t.Model;n.url="/ad/api/company",n.fetch({async:!1}),this.companyInfo=n.toJSON()},render:function(){var e="";return this.$el.empty(),this.aliasId!=undefined?(this.model.fetch({async:!1}),this.$el.html(s({lang:f,domain:this.companyInfo.domainName,data:this.model.toJSON(),useLayout:this.useLayout})),this.model.get("accountStatus")=="disabled"&&this.$el.find("#accountStatus_disabled").attr("checked","checked"),this.renderAccountList(this.model.get("forwardingAddress"))):this.$el.html(i({lang:f,domain:this.companyInfo.domainName,useLayout:this.useLayout})),this},addAlias:function(t){e.goOrgSlide("close"),e.goAliasOrgSlide("close");var n=this,r=e.goAliasOrgSlide({header:u["\ubcc4\uce6d \ubaa9\ub85d"],desc:"",callback:n.renderAliasLi,target:t,isAdmin:!0,contextRoot:GO.contextRoot,type:"node",aliasId:this.aliasId})},addAccount:function(t){e.goOrgSlide("close"),e.goAliasOrgSlide("close");var n=this,r=e.goOrgSlide({header:u["\uc870\uc9c1\ub3c4"],desc:"",callback:n.renderAccountLi,target:t,isAdmin:!0,contextRoot:GO.contextRoot,type:"node"})},renderAccountList:function(t){var r=this,i=[];e.each(t,function(e,t){t.originalEmail=t.email,t.userType=="aliasUser"?r.renderAliasLi(t,r.$el.find("#addAliasEmailEl")):(r.renderAccountLi(t,r.$el.find("#addEmailEl")),t.deletedDept&&i.push(n.i18n(u["\ubd80\uc11c\uba85: 0, \ubd80\uc11c\uc774\uba54\uc77c: 0"],{arg1:t.name,arg2:t.originalEmail})))}),_.isEmpty(i)||(i.unshift(u["\ud574\ub2f9 \ubd80\uc11c\ub97c \uc644\uc804\uc0ad\uc81c \ud558\uc2dc\uac70\ub098 \uc804\ub2ec\ud560 \uc774\uba54\uc77c\uc5d0\uc11c \uc81c\uac70\ud574\uc8fc\uc138\uc694."]),e.goAlert(u["\uc0ad\uc81c\ub41c \ubd80\uc11c\uc758 \uc774\uba54\uc77c\uc774 \uc874\uc7ac\ud569\ub2c8\ub2e4."],i.join("\n")))},renderAliasLi:function(t,n){var r=Hogan.compile('<li data-email="{{email}}"><span class="name">  {{name}} - {{email}}<input type="hidden" name="aliasEmail" value="{{email}}" /><input type="hidden" name="name" value="{{name}}" /><input type="hidden" name="userType" value="{{userType}}" /></span><span class="btn_wrap"><span class="ic_classic ic_del" title="{{lang.label_delete}}"></span></span></li>');n==undefined&&(n=e("#addAliasEmailEl"));if(t.email==""){e.goAlert("",u["\ubd80\uc11c \uc774\uba54\uc77c\uc774 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]);return}var i=!1;e.each(n.find("li"),function(n,r){var s=e(r).find('input[name="aliasEmail"]').val();s==t.email&&(i=!0)});if(i){e.goAlert("",u["\uc774\ubbf8 \ucd94\uac00\ub41c \uc774\uba54\uc77c\uc785\ub2c8\ub2e4."]);return}t.email!=n.find("li").attr("data-email")?n.find("#selectAlias").parents("li.creat").before(r.render(e.extend(t,{lang:f}))):e.goAlert("",u["\uc774\ubbf8 \ucd94\uac00\ub41c \uc774\uba54\uc77c\uc785\ub2c8\ub2e4."])},renderAccountLi:function(t,n){var r=Hogan.compile('<li data-id="{{id}}"><span class="name">{{name}} - {{originalEmail}}<input type="hidden" name="accountEmail" value="{{originalEmail}}" /><input type="hidden" name="name" value="{{name}}" /><input type="hidden" name="userType" value="{{userType}}" /></span><span class="btn_wrap"><span class="ic_classic ic_del" title="{{lang.label_delete}}"></span></span></li>');n==undefined&&(n=e("#addEmailEl"));if(t.originalEmail==""||t.originalEmail.split("@")[0]==""){e.goAlert("",u["\ubd80\uc11c \uc774\uba54\uc77c\uc774 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]);return}var i=!1;e.each(n.find("li"),function(n,r){var s=e(r).find('input[name="accountEmail"]').val();s==t.originalEmail&&(i=!0)});if(i){e.goAlert("",u["\uc774\ubbf8 \ucd94\uac00\ub41c \uc774\uba54\uc77c\uc785\ub2c8\ub2e4."]);return}t.userType=="orgAdmin"||t.type=="org"?(r=Hogan.compile('<li data-id="{{id}}"><span class="ic_classic ic_part" title="\ubd80\uc11c"></span><span class="name">  {{name}} - {{originalEmail}}<input type="hidden" name="accountEmail" value="{{originalEmail}}" /><input type="hidden" name="name" value="{{name}}" /><input type="hidden" name="userType" value="{{userType}}" /></span><span class="btn_wrap"><span class="ic_classic ic_del" title="{{lang.label_delete}}"></span></span></li>'),n.find("#addOrgEmailEl").append(r.render(e.extend(t,{lang:f})))):t.userType=="mailUser"||t.type=="MASTER"||t.type=="MODERATOR"||t.type=="MEMBER"?n.find("#addUserEmailEl").append(r.render(e.extend(t,{lang:f}))):(r=Hogan.compile('<li data-id="{{id}}" style="background:lightyellow"><span class="name">  {{name}} - {{originalEmail}}<input type="hidden" name="accountEmail" value="{{originalEmail}}" /><input type="hidden" name="name" value="{{name}}" /><input type="hidden" name="userType" value="{{userType}}" /></span><span class="btn_wrap"><span class="ic_classic ic_del" title="{{lang.label_delete}}"></span></span></li>'),n.find("#addUserEmailEl").append(r.render(e.extend(t,{lang:f}))))},deleteEamil:function(t){e(t.currentTarget).parents("li").remove()},saveAlias:function(){var t=this,r=!0,i="POST",s=[],a=e("form[name=formAliasCreate]");this.aliasId&&(a=e("form[name=formAliasModify]"),i="PUT"),e.each(a.serializeArray(),function(i,s){if(s.name=="userName"){if(e.goValidation.isInvalidLength(2,64,s.value))return e.goMessage(n.i18n(u["{{arg1}}\uc740(\ub294) {{arg2}}\uc790\uc774\uc0c1 {{arg3}}\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:u["\ubcc4\uce6d \uacc4\uc815 \uc774\ub984"],arg2:"2",arg3:"64"})),e("#userName").focus(),r=!1,!1}else if(s.name=="mailUid"){if(e.goValidation.isInvalidLength(2,64,s.value))return e.goMessage(n.i18n(u["{{arg1}}\uc740(\ub294) {{arg2}}\uc790\uc774\uc0c1 {{arg3}}\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:u["\ubcc4\uce6d \uacc4\uc815 \uc544\uc774\ub514"],arg2:"2",arg3:"64"})),e("#mailUid").focus(),r=!1,!1;if(e.goValidation.isInvalidEmailId(s.value))return e.goMessage(u["\uc0ac\uc6a9\ud560 \uc218 \uc5c6\ub294 \uc774\uba54\uc77c\uc785\ub2c8\ub2e4."]),e("#mailUid").focus(),r=!1,!1}t.model.set(s.name,s.value,{silent:!0})});if(!r)return;if(this.useLayout||this.aliasId)e.each(e("#addEmailEl li"),function(t,n){var r={name:e(n).find('[name="name"]').val(),email:e(n).find('[name="accountEmail"]').val(),userType:e(n).find("[name='userType']").val()};(r.name||!1||r.email||!1)&&s.push(r)}),e.each(e("#addAliasEmailEl li"),function(t,n){var r={name:e(n).find('[name="name"]').val(),email:e(n).find('[name="aliasEmail"]').val(),userType:e(n).find("[name='userType']").val()};(r.name||!1||r.email||!1)&&s.push(r)});this.aliasId&&(t.model.set("parentMailUserSeq",this.aliasId,{silent:!0}),t.model.set("prevParentMailUserSeq",this.aliasId,{silent:!0})),this.parentId&&t.model.set("parentMailUserSeq",this.parentId,{silent:!0}),t.model.set("forwardingAddress",s,{silent:!0}),this.model.save({},{type:i,success:function(r,i){i.code=="200"&&(e.goMessage(o["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.EventEmitter.trigger("common","layout:clearOverlay",!0),t.aliasId?t.useLayout?t.render():GO.EventEmitter.trigger("admin","layout:renderAliasTree",""):t.useLayout?n.router.navigate("mail/alias",{trigger:!0}):n.router.navigate("mail/alias/tree",{trigger:!0}))},error:function(t,r){var i=JSON.parse(r.responseText);e.goMessage(i.message),i.name=="duplicated.login.id"&&e("#mailUid").focus(),n.EventEmitter.trigger("common","layout:clearOverlay",!0)}})},changeInput:function(t){var n=e(t.target),r;n.hasClass("ic_edit")?(r=n.parent().parent(),r.hide(),r.next().show()):(n.hide(),n.next().show())},cancel:function(){this.render()},moveList:function(){n.router.navigate("mail/alias",{trigger:!0})}});return l})}).call(this);