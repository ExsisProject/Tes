(function(){define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("hgn!admin/templates/contact_config"),i=require("go-nametags"),s=require("i18n!nls/commons"),o=require("i18n!admin/nls/admin"),u=require("i18n!contact/nls/contact");require("jquery.go-orgslide");var a={label_ok:s["\uc800\uc7a5"],label_cancel:s["\ucde8\uc18c"],label_side:o["Side \uc6b0\uc120 \uc124\uc815"],COMPANY:o["\uc804\uc0ac \uc8fc\uc18c\ub85d"],USER:o["\uac1c\uc778 \uc8fc\uc18c\ub85d"],DEPARTMENT:u["\ubd80\uc11c \uc8fc\uc18c\ub85d"],label_private_config:o["\uac1c\uc778 \uc8fc\uc18c\ub85d \uc124\uc815"],label_department_config:o["\ubd80\uc11c \uc8fc\uc18c\ub85d \uc124\uc815"],label_company_config:o["\uc804\uc0ac \uc8fc\uc18c\ub85d \uc124\uc815"],label_max_contact:o["\uc5f0\ub77d\ucc98 \ucd5c\ub300 \ub4f1\ub85d \uc218"],label_max_group:o["\ucd5c\ub300 \uadf8\ub8f9 \uc218"],label_max_company_group:o["\ucd5c\ub300 \uc8fc\uc18c\ub85d \uc218"],label_desc_10000:n.i18n(o["\uc785\ub825\ubc94\uc704"],{arg1:"10",arg2:"10,000"}),label_desc_1000:n.i18n(o["\uc785\ub825\ubc94\uc704"],{arg1:"10",arg2:"1,000"}),"\uacf5\uc6a9 \uc8fc\uc18c\ub85d \uad00\ub9ac\uc790":u["\uacf5\uc6a9 \uc8fc\uc18c\ub85d \uad00\ub9ac\uc790"],"\uacf5\uc6a9 \uc8fc\uc18c\ub85d \uad00\ub9ac\uc790 \uc124\uba85":u["\uacf5\uc6a9 \uc8fc\uc18c\ub85d \uad00\ub9ac\uc790 \uc124\uba85"]},f=t.Model.extend({CONTACT_MIN:10,CONTACT_MAX:1e4,GROUP_MIN:10,GROUP_MAX:1e3,url:"/ad/api/contactconfig",initialize:function(){},validate:function(){var e=[];e=this._validateContact(),e=e.concat(this._validateGroup());if(e.length>0)throw new Error(JSON.stringify(e))},_validateContact:function(){var e=["privateContactMax","companyContactMax","departmentContactMax"];return this._validateRange(e,this.CONTACT_MIN,this.CONTACT_MAX)},_validateGroup:function(){var e=["privateContactGroupMax","companyContactGroupMax","departmentContactGroupMax"];return this._validateRange(e,this.GROUP_MIN,this.GROUP_MAX)},_validateRange:function(e,t,r){var i=[];return _.each(e,function(e){var s=this.get(e);if(isNaN(s)){var u={attr:e,message:o["\uc22b\uc790\ub9cc \uc785\ub825\ud558\uc138\uc694."]};i.push(u)}var a=parseInt(s);if(a<t||a>r){var u={attr:e,message:n.i18n(o["\uc785\ub825\ubc94\uc704\uc54c\ub9bc"],{arg1:t,arg2:r})};i.push(u)}},this),i}}),l=n.BaseView.extend({initialize:function(){this.unbindEvent(),this.bindEvent(),this.model=new f,this.model.fetch({async:!1})},unbindEvent:function(){this.$el.off("click","span#btn_ok"),this.$el.off("click","span#btn_cancel"),this.$el.off("focusout","input#privateContactMax"),this.$el.off("focusout","input#privateContactGroupMax"),this.$el.off("focusout","input#companyContactMax"),this.$el.off("focusout","input#companyContactGroupMax"),this.$el.off("click","span.btn_box[data-btntype='changeform']"),this.$el.off("click","span#data"),this.$el.off("submit","form")},bindEvent:function(){this.$el.on("click","span#btn_ok",e.proxy(this.contactConfigSave,this)),this.$el.on("click","span#btn_cancel",e.proxy(this.contactConfigCancel,this)),this.$el.on("focusout","input#privateContactMax",e.proxy(this.inputValidator,this)),this.$el.on("focusout","input#privateContactGroupMax",e.proxy(this.inputValidator,this)),this.$el.on("focusout","input#departmentContactMax",e.proxy(this.inputValidator,this)),this.$el.on("focusout","input#departmentContactGroupMax",e.proxy(this.inputValidator,this)),this.$el.on("focusout","input#companyContactMax",e.proxy(this.inputValidator,this)),this.$el.on("focusout","input#companyContactGroupMax",e.proxy(this.inputValidator,this)),this.$el.on("click","span.btn_box[data-btntype='changeform']",e.proxy(this.changeModifyForm,this)),this.$el.on("click","span#data",e.proxy(this.changeModifyForm,this)),this.$el.on("submit","form",e.proxy(this.formSubmit,this))},formSubmit:function(e){e.preventDefault();return},changeModifyForm:function(t){var n=e(t.currentTarget).parent();n&&n.attr("data-formname")&&(e(t.currentTarget).hide(),n.html(['<input type="input" name="',n.attr("data-formname"),'"id="',n.attr("data-formname"),'" class="input t_num" value="',n.attr("data-value"),'" />'].join("")).find("input").focusin())},render:function(){this.$el.empty();var e=r({lang:a,model:this.model.toJSON(),priorityName:function(){return a[this]}});this.$el.html(e),this._renderNameTagView(),this._renderAdmins(),this.$el.find("ul.drag_option_wrap").sortable({opacity:"1",delay:100,cursor:"move",items:"li",containment:".container:first",hoverClass:"ui-state-hover",start:function(e,t){t.placeholder.html(t.helper.html()),t.placeholder.find("li").css("padding","5px 10px")}})},_renderAdmins:function(){_.each(this.model.get("administrators"),function(e){this.nameTagView.addTags({id:e.userId,displayName:e.name+(e.position?" "+e.position:"")},{removable:!0,attr:e})},this)},_renderNameTagView:function(){var t=this;this.nameTagView=i.create({},{useAddButton:!0}),this.$("ul.name_tag").html(this.nameTagView.el),this.nameTagView.$el.on("nametag:clicked-add",function(n,r){e.goOrgSlide(t._getOrgOption(r))})},_getOrgOption:function(t){var n={contextRoot:GO.contextRoot,isAdmin:!0,header:o["\uad00\ub9ac\uc790 \ucd94\uac00"],callback:e.proxy(function(e){t.addTags(e,{removable:!0,attr:e})},this)};return n},inputValidator:function(t){var r=t.currentTarget.value,i=t.currentTarget.id,s=e(t.currentTarget).parent(),u=s.parent().find(".go_alert");u.html("");if(r==0||r=="")return u.html(o["\uc81c\ud55c \uac12\uc744 \uc785\ub825\ud558\uc138\uc694."]),t.currentTarget.focus(),!1;if(isNaN(r)==1)return u.html(o["\uc22b\uc790\ub9cc \uc785\ub825\ud558\uc138\uc694."]),t.currentTarget.focus(),r="",!1;if(i=="companyContactMax"||i=="privateContactMax"){if(r<10||r>1e4)return u.html(n.i18n(o["\uc785\ub825\ubc94\uc704\uc54c\ub9bc"],{arg1:"10",arg2:"10000"})),t.currentTarget.focus(),!1}else if(i=="companyContactGroupMax"||i=="privateContactGroupMax")if(r<10||r>1e3)return u.html(n.i18n(o["\uc785\ub825\ubc94\uc704\uc54c\ub9bc"],{arg1:"10",arg2:"10000"})),t.currentTarget.focus(),!1},setModel:function(){var t=this.$el.find("form[name=formContactConfig]");_.each(t.serializeArray(),function(e,t){this.model.set(e.name,e.value,{silent:!0})},this);var n=_.map(e("ul.name_tag").find("li[data-id]"),function(t){return{userId:e(t).data("id")}});this.model.set("administrators",n);var r=_.map(this.$el.find("#priorityContainer li"),function(t){return e(t).data("value")});this.model.set("priority",{priorityTypes:r})},contactConfigSave:function(){this.setModel();try{this.$el.find("span.go_alert").html(""),this.model.validate()}catch(t){var n=JSON.parse(t.message);_.each(n,function(t){var n=t.message,r=e("#"+t.attr+"Alert"),i=e('input[name="'+t.attr+'"]').focus();r.html(n),i.focus()});return}var r=this;this.model.save({},{success:function(t,n){n.code=="200"&&(e.goMessage(s["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),r.render())},error:function(t,n){var r=JSON.parse(n.responseText);r.message!=null?e.goMessage(r.message):e.goMessage(s["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}})},contactConfigCancel:function(){var t=this;e.goCaution(s["\ucde8\uc18c"],s["\ubcc0\uacbd\ud55c \ub0b4\uc6a9\uc744 \ucde8\uc18c\ud569\ub2c8\ub2e4."],function(){t.render(),e.goMessage(s["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},s["\ud655\uc778"])}},{__instance__:null});return l})}).call(this);