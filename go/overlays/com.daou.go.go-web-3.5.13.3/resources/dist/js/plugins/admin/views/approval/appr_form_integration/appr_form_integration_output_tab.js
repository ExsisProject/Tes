define(["app","i18n!nls/commons","i18n!admin/nls/admin","i18n!approval/nls/approval","admin/models/approval/integration_query","admin/collections/approval/integration_query","admin/views/approval/appr_form_integration/appr_form_parameter_layer","admin/constants/integration_config"],function(e,t,n,r,i,s,o,u){var a={"Exucute Query":"Exucute Query",parameters:"parameters",Drafted:r["\uae30\uc548\uc644\ub8cc"],"Cancel Drafted":r["\uae30\uc548\ucde8\uc18c"],"Activity Complete":r["\uc911\uac04\uacb0\uc7ac\uc644\ub8cc"],"Document Return":r["\ubc18\ub824\uc644\ub8cc"],"Document Complete":r["\uacb0\uc7ac\uc644\ub8cc"],"\ucd94\uac00":t["\ucd94\uac00"],"\uc0ad\uc81c":t["\uc0ad\uc81c"]},f=['<li name="param"><span data-id="paramWrap">','<span class="name" name="output_parameters" data-dataType="{{dataType}}" data-paramName = "{{paramName}}" data-paramType = "{{paramType}}">{{paramName}} ({{dataType}})</span>','<span name="dataTypeParamDel" class="btn_wrap"><span class="ic ic_del" title="'+t["\uc0ad\uc81c"]+'"></span></span></li>'].join(""),l=['<td class="chk"><input type="checkbox"/></td><td><textarea data-id="query" class="w_full" row-id={{id}}>{{query}}</textarea></td>','<td name="parameterTd"><ul class="name_tag basic_tag">','<li class="creat"><span name="outputTabRowAdd" class="btn_wrap"><span class="ic ic_addlist"></span><span class="txt">'+t["\ucd94\uac00"]+"</span></span></li></ul>","</td>"].join(""),c=Backbone.View.extend({tagName:"tr",initialize:function(e){this.options=e||{},this.observer=this.options.observer,this.model=this.options.model,this.approvalStep=this.options.approvalStep,this.$el.data("instance",this)},events:{"click .ic_del":"deleteParameter","click span[name=outputTabRowAdd]":"popupAddParameterLayer"},getData:function(){var e=$.map(this.$('span[name="output_parameters"]'),function(e,t){return{dataType:$(e).attr("data-dataType"),paramName:$(e).attr("data-paramName"),paramType:$(e).attr("data-paramType"),seq:t}});return{id:this.$('textarea[data-id="query"]').attr("row-id"),query:this.$('textarea[data-id="query"]').val(),parameters:e,approvalStep:this.approvalStep}},deleteParameter:function(e){$(e.currentTarget).closest('span[data-id="paramWrap"]').remove()},addParameter:function(e){this.$(".creat").before(Hogan.compile(f).render(e))},popupAddParameterLayer:function(){var e=$.goPopup({pclass:"layer_normal parameter_popup",header:"Parameter Config",modal:!0,width:600,allowPrevPopup:!0,contents:"",buttons:[{btext:t["\ucde8\uc18c"],btype:"cancel"}]}),n=new o({model:this.model,observer:this.observer});n.render(),n.on("addParameter",_.bind(this.addParameter,this)),e.reoffset()},render:function(){var e=this;return this.$el.append(Hogan.compile(l).render(this.model.toJSON())),_.each(this.model.get("parameters"),function(e){this.$(".creat").before(Hogan.compile(f).render(e))},this),this}}),h=['<table class="in_table direct_access_form" id="{{tabId}}">',"<thead>","<tr>",'<th class="sorting_disable chk"><span class="txt"><input type="checkbox" id="outputDataTypeAllCheck"></span></th>','<th class="sorting_disable"><span class="title_sort">'+a["Exucute Query"]+"</span></th>",'<th class="sorting_disable"><span class="title_sort">'+a.parameters+"</span></th>","</tr>","</thead>","<tbody>","</tbody></table>"].join(""),p=Backbone.View.extend({tagName:"div",initialize:function(e){this.options=e||{},this.collection=this.options.collection,this.observer=this.options.observer,this.approvalStep=this.options.approvalStep,this.tabId=this.options.tabId},render:function(){var e=this;return this.$el.append(Hogan.compile(h).render({tabId:this.tabId})),this.collection.each(function(t){var n=new c({model:t,observer:e.observer,approvalStep:e.approvalStep});e.$("tbody").append(n.render().$el)}),this._itemsSortable(this.tabId),this},_itemsSortable:function(e){this.$el.find("table#"+e+" tbody ul.name_tag").sortable({opacity:"1",delay:100,cursor:"move",items:"li:not('.creat')",hoverClass:"ui-state-hover",forceHelperSize:"true",helper:"clone",placeholder:"ui-sortable-placeholder",start:function(e,t){t.placeholder.html(t.helper.html())}}).sortable("enable")},getData:function(){var e=[];return this.$("tbody tr").each(function(t,n){var r=$(n).data("instance");e.push(r.getData())}),e},addRow:function(){var e=new c({observer:this.observer,approvalStep:this.approvalStep,model:new i});this.$("tbody").append(e.render().$el)},active:function(){this.$el.find("#"+this.tabId).show()},deactive:function(){this.$el.find("#"+this.tabId).hide()}}),d=['<div class="tab_menu_wrap">','<ul class="tab_menu" id="tabControll">','<li class="active" data-type="ACTIVE" id="DRAFT"><span class="txt">'+a.Drafted+"</span></li>",'<li data-type="CLOSED" id="CANCEL"><span class="txt">'+a["Cancel Drafted"]+"</span></li>",'<li data-type="CLOSED" id="INPROGRESS"><span class="txt">'+a["Activity Complete"]+"</span></li>",'<li data-type="CLOSED" id="RETURN"><span class="txt">'+a["Document Return"]+"</span></li>",'<li data-type="CLOSED" id="APPROVAL"><span class="txt">'+a["Document Complete"]+"</span></li>","</ul>","</div>",'<span class="btn_wrap">','<span class="btn_s btnRowAdd">'+a["\ucd94\uac00"]+"</span>",'<span class="btn_s btnRowDelete">'+a["\uc0ad\uc81c"]+"</span>","</span>",'<div class="" id="outputDataTable">',"</div>"].join(""),v=Backbone.View.extend({el:"#outputDirectAccessDataTypeArea",tabViews:null,initialize:function(e){this.collection=e.collection,this.observer=e.observer,this.tabViews=[]},events:{"click ul.tab_menu li":"toggleTab","click .btnRowAdd":"addRow","click .btnRowDelete":"deleteRow","click #outputDataTypeAllCheck":"_outputDataTypeAllCheck"},toggleTab:function(e){var t=$(e.currentTarget),n=t.attr("id");this.$(".tab_menu li").removeClass("active"),t.addClass("active"),this.activeTab(n)},getData:function(){var e=[];return _.each(this.tabViews,function(t){e.push(t.getData())}),{outputQueries:_.flatten(e,!0)}},validate:function(){var t=this,r=!0;return $("#selectOutputDataType").val()=="STRING"?r:(_.each(u.OUTPUT_DATATYPE_TAB,function(i){var s=t.$("#"+i.tableID+" > tbody [data-id=query]");s.length>0&&s.each(function(t,s){var o=new RegExp(/\?/g),u=$(s).val().match(o),a=u&&u.length||0;_.isEmpty($(s).val())?($.goMessage(e.i18n(n["output {{tabName}}\uc758 Query\ub97c \uc785\ub825\ud574 \uc8fc\uc138\uc694"],"tabName",i.tabName)),r=!1):$(s).closest("tr").find("[data-id=paramWrap]").length!=a&&($.goMessage(e.i18n(n["output {{tabName}}\uc758 Query/Parameter \uc124\uc815\uc774 \uc798\ubabb\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],"tabName",i.tabName)),r=!1)})},this),r)},addRow:function(){this.activeTabView.addRow()},deleteRow:function(e){var t=this.$("#tabControll li.active").attr("id");this.$("table#"+t+' tbody input[type="checkbox"]:checked').each(function(e,t){var n=$(t).closest("tr").data("instance");n.remove()}),this.$("table#"+t+" #outputDataTypeAllCheck").attr("checked",!1)},activeTab:function(e){this.activeTabView&&this.activeTabView.deactive();var t=_.findWhere(this.tabViews,{tabId:e});t.active(),this.activeTabView=t},render:function(){this.$el.html(Hogan.compile(d).render({lang:a})),this.addAllTabViews(),this.activeTab("DRAFT")},addAllTabViews:function(){var e=_.toArray(u.APPR_STATUS);_.each(e,function(e){var t=_.where(this.collection.toJSON(),{approvalStep:e}),n=new p({collection:new s(t),observer:this.observer,tabId:e,approvalStep:e});this.tabViews.push(n),this.$("#outputDataTable").append(n.render().$el),n.deactive()},this)},_outputDataTypeAllCheck:function(e){$(e.currentTarget).is(":checked")?_.each($(e.currentTarget).closest("table").find("input[type=checkbox]"),function(e){$(e).attr("checked",!0)}):_.each($(e.currentTarget).closest("table").find("input[type=checkbox]"),function(e){$(e).attr("checked",!1)})}});return v});