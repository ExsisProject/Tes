define(["jquery","backbone","app","hgn!admin/templates/attnd_group_create","hgn!admin/templates/attnd_group_modify","views/circle","i18n!nls/commons","i18n!admin/nls/admin","jquery.go-popup","jquery.go-sdk","jquery.go-grid","jquery.go-orgslide","jquery.go-validation","GO.util"],function(e,t,n,r,i,s,o,u){var a={label_ok:o["\uc800\uc7a5"],label_cancel:o["\ucde8\uc18c"],label_edit:o["\uc218\uc815"],label_defaultSetting:u["\uae30\ubcf8 \uc124\uc815"],label_groupName:u["\uadf8\ub8f9\uba85"],label_groupDesc:u["\uc124\uba85"],label_use:u["\uc0ac\uc6a9"],label_unuse:u["\uc0ac\uc6a9\uc548\ud568"],label_mobileapp:u["\ubaa8\ubc14\uc77c \uc571"],label_allow_mobile:u["\uadfc\ud0dc\uccb4\ud06c \ud5c8\uc6a9 \uc5ec\ubd80"],label_mobile_app_ehr:u["\ubaa8\ubc14\uc77c \uc571 \uadfc\ud0dc"],label_record_gps:u["GPS \uae30\ub85d"],label_webservice:u["\uc6f9 \uc11c\ube44\uc2a4"],label_gps_desc:u["GPS \uae30\ub85d \uc124\uba85"],label_clockInOutTime:u["\ucd9c\ud1f4\uadfc \uc2dc\uac04"],label_clockInTime:u["\ucd9c\uadfc \uc2dc\uac04"],label_clockOutTime:u["\ud1f4\uadfc \uc2dc\uac04"],label_attendanceStatus:u["\uadfc\ud0dc \uc0c1\ud0dc"],label_addAttendanceStatus:u["\ucd94\uac00"],label_useFreeInOut:u["\uc790\uc728 \ucd9c\ud1f4\uadfc\uc81c \uc774\uc6a9"],label_applyPeriod:u["\uc801\uc6a9 \uae30\uac04"],label_settingPeriod:u["\uae30\uac04 \uc124\uc815"],label_attendanceSetting:u["\uadfc\ud0dc\uc790 \uc124\uc815"],label_excludeClass:u["\uadfc\ud0dc \ud074\ub798\uc2a4 \ucd94\uac00"],label_selectClass:u["\ud074\ub798\uc2a4 \uc120\ud0dd"],label_addExceptionClass:u["\uc608\uc678 \ud074\ub798\uc2a4 \ucd94\uac00"],label_flexibleTime_desc:u["*\uc2dc\uac04 \uc124\uc815 \uc5c6\uc774 \uc790\uc720\ub86d\uac8c \uccb4\ud06c\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],label_day_after:u["\uc775\uc77c"],label_until:u["\uae4c\uc9c0"],label_all_night_time:u["\ucca0\uc57c\ud1f4\uadfc \uc2dc\uac04"],label_all_night_desc:u["*\ucca0\uc57c \ud1f4\uadfc\uc2dc\uac04 \uc124\uba85"]},f=t.View.extend({accessUserView:null,exceptionUserView:null,el:"#layoutContent",initialize:function(e){var t=GO.router.getUrl().split("/"),n=t[_.indexOf(t,"group")+1];this.groupId=n=="create"?"":n,this.$el.off()},events:{"click #submit":"submit","click #cancel":"cancel","change #useFlexibleTime":"useFlexibleTime","click input[name='allowMobile']":"changeAllowMobile"},render:function(){this.groupId&&this.groupId!="create"?(this.model=new t.Model({}),this.model.fetch({url:GO.contextRoot+"ad/api/ehr/attnd/group/"+this.groupId,async:!1}),this.$el.html(i({lang:a,data:this.model.toJSON()})),this.renderInOutAllNightTime()):(this.model=new t.Model,this.$el.html(r({lang:a}))),e("#allowMobile").is(":checked")?e("#mobileAppEhr").show():(e("#mobileAppEhr").hide(),e("input#recordGps_unuse").attr("checked",!0)),this.renderPeriod(),this.renderAccessUserView(),this.renderExceptionUserView(),this.model.get("useFlexibleTime")&&(this.$el.find("#clockInOutContainer").hide(),this.$el.find("#clockAllNightContainer").hide())},renderPeriod:function(){e.datepicker.setDefaults(e.datepicker.regional[GO.config("locale")]),this.groupId?(e("#startDate").val(this.model.get("startDate")),e("#endDate").val(this.model.get("endDate"))):(e("#startDate").val(GO.util.now().format("YYYY-MM-DD")),e("#endDate").val(GO.util.now().format("YYYY-MM-DD"))),e("#startDate").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(t){e("#startDate").val(t)}}),this.$el.find("#endDate").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(t){e("#endDate").val(t)}})},renderInOutAllNightTime:function(){var e=this.model.get("clockInTime"),t=this.model.get("clockOutTime"),n=this.model.get("clockAllNightTime");this.$el.find("#inTimeHour").val(e.split(":")[0]),this.$el.find("#inTimeMin").val(e.split(":")[1]),this.$el.find("#inTimeSec").val(e.split(":")[2]),this.$el.find("#outTimeHour").val(t.split(":")[0]),this.$el.find("#outTimeMin").val(t.split(":")[1]),this.$el.find("#outTimeSec").val(t.split(":")[2]),this.$el.find("#allNightTimeHour").val(n.split(":")[0]),this.$el.find("#allNightTimeMin").val(n.split(":")[1]),this.$el.find("#allNightTimeSec").val(n.split(":")[2])},renderAccessUserView:function(){var e=["user","position","grade","usergroup"];GO.util.isUseOrgService(!0)&&(e=["user","department","position","grade","duty","usergroup"]),this.accessUserView=new s({selector:"#accessUser",isAdmin:!0,isWriter:!0,circleJSON:this.model.get("accessTarget"),nodeTypes:e}),this.accessUserView.render()},renderExceptionUserView:function(){var e=["user","position","grade","usergroup"];GO.util.isUseOrgService(!0)&&(e=["user","department","position","grade","duty","usergroup"]),this.exceptionUserView=new s({selector:"#exceptionUser",isAdmin:!0,isWriter:!0,circleJSON:this.model.get("exceptionTarget"),nodeTypes:e}),this.exceptionUserView.render()},useFlexibleTime:function(t){var n=e(t.currentTarget).is(":checked");n?(e("#clockInOutContainer").hide(),e("#clockAllNightContainer").hide()):(e("#clockInOutContainer").show(),e("#clockAllNightContainer").show())},submit:function(t){var n=this,r=60;e("span.go_alert").text("");if(!e.goValidation.isCheckLength(2,64,e("#groupName").val())){e("#groupNameValidate").text(GO.i18n(u["\uc81c\ubaa9\uc740 0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"}));return}if(!e.goValidation.isCheckLength(0,255,e("#groupDesc").val())){e("#groupDescValidate").text(GO.i18n(u["\uc124\uba85\uc740 255\uc790 \uc774\ud558 \uc785\ub825 \uac00\ub2a5\ud569\ub2c8\ub2e4."],{arg1:"255"}));return}var i=parseInt(e("#inTimeHour").val())*r*r+parseInt(e("#inTimeMin").val())*r+parseInt(e("#inTimeSec").val()),s=parseInt(e("#outTimeHour").val())*r*r+parseInt(e("#outTimeMin").val())*r+parseInt(e("#outTimeSec").val()),a=parseInt(e("#allNightTimeHour").val())*r*r+parseInt(e("#allNightTimeMin").val())*r+parseInt(e("#allNightTimeSec").val());if(i<a){e.goAlert(u["\ucca0\uc57c\ud1f4\uadfc \uc2dc\uac04\uc740 \uc775\uc77c \ucd9c\uadfc\uc2dc\uac04\uc744 \ub118\uae38\uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}if(!e("#useFlexibleTime").is(":checked")&&i>=s){e("#inOutValidate").text(u["\ud1f4\uadfc \uc2dc\uac04\uc774 \ucd9c\uadfc \uc2dc\uac04\ubcf4\ub2e4 \uc774\uc804\uc77c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}if(e("#usePeriodSetting").is(":checked")&&!GO.util.isAfterOrSameDate(e("#startDate").val(),e("#endDate").val())){e("#periodValidate").text(u["\uc2dc\uc791\uc77c\uc774 \uc885\ub8cc\uc77c\ubcf4\ub2e4 \uc774\uc804\uc77c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var f=e("#inTimeHour").val()+":"+e("#inTimeMin").val()+":"+e("#inTimeSec").val(),l=e("#outTimeHour").val()+":"+e("#outTimeMin").val()+":"+e("#outTimeSec").val(),c=e("#allNightTimeHour").val()+":"+e("#allNightTimeMin").val()+":"+e("#allNightTimeSec").val(),h=e("#startDate").val(),p=e("#endDate").val();n.model.set({id:e("#attndGroupSetting").attr("data-id"),name:e("#groupName").val(),description:e("#groupDesc").val(),useFlexibleTime:e("#useFlexibleTime").is(":checked"),usePeriodSetting:e("#usePeriodSetting").is(":checked"),startDate:h,endDate:p,accessTarget:this.accessUserView.getData(),exceptionTarget:this.exceptionUserView.getData(),clockInTime:f,clockOutTime:l,clockAllNightTime:c,sortOrder:""},{silent:!0}),n.model.set("allowMobile",e("input#allowMobile").is(":checked"),{silent:!0}),n.model.set("recordGps",e("input#recordGps_use").is(":checked"),{silent:!0}),GO.EventEmitter.trigger("common","layout:setOverlay","");var d=n.groupId?"/"+n.groupId:"";n.model.url=GO.contextRoot+"ad/api/ehr/attnd/group"+d,n.model.save({},{type:n.groupId?"PUT":"POST",success:function(t,n){n.code=="200"&&(e.goMessage(o["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),GO.EventEmitter.trigger("common","layout:clearOverlay",!0),GO.router.navigate("ehr/group/list",!0))},error:function(t,n){e.goMessage(o["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),GO.EventEmitter.trigger("common","layout:clearOverlay",!0)}})},changeAllowMobile:function(t){var n=e(t.currentTarget),r=n.is(":checked");r?e("#mobileAppEhr").show():(e("#mobileAppEhr").hide(),e("input#recordGps_unuse").attr("checked",!0))},cancel:function(){this.render()}});return f});