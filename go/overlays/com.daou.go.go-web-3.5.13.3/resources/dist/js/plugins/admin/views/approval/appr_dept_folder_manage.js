define(["i18n!nls/commons","i18n!approval/nls/approval","hgn!admin/templates/approval/appr_dept_folder_manage","admin/views/approval/appr_dept_folder_manage_item","admin/models/approval/appr_dept_folder","hgn!approval/templates/add_org_member","jquery.ui"],function(e,t,n,r,i,s){var o=Backbone.Model.extend({url:function(){var e=[GO.contextRoot+"ad/api/approval/deptfolder",this.deptId,"managers"].join("/");return e},setDeptId:function(e){this.deptId=e}}),u=Backbone.Collection.extend({model:o,url:function(){return GO.contextRoot+"ad/api/approval/deptfolder/"+this.deptId+"/manager"},setDeptId:function(e){this.deptId=e},getUserIds:function(){return this.map(function(e){return e.get("userId")})}}),a=['<table class="form_type go_renew">',"<tbody>","<tr>","<th>",'<span class="title">',t["\ubd80\uc11c \ubb38\uc11c\ud568\uba85"],'<ins class="asterisk">*</ins>',"</span>","</th>","<td>",'<div class="wrap_txt w_max">','<input class="txt_mini w_max" type="text" id="deptFolderName" maxlength="50">',"</div>","</td>","</tr>","</tbody>","</table>",'<div id="deptFolderError"></div>'].join(""),f={"\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac":t["\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac"],"\uc21c\uc11c \ubc14\uafb8\uae30":e["\uc21c\uc11c \ubc14\uafb8\uae30"],"\ucd94\uac00":e["\ucd94\uac00"],"\uc0ad\uc81c":e["\uc0ad\uc81c"],"\ubb38\uc11c\ud568 \uc774\ub984":t["\ubb38\uc11c\ud568 \uc774\ub984"],"\uc0dd\uc131\uc77c":t["\uc0dd\uc131\uc77c"],"\ubb38\uc11c \uac1c\uc218":t["\ubb38\uc11c \uac1c\uc218"],"\ubd80\uc11c \ubb38\uc11c\ud568 \ub2f4\ub2f9\uc790":t["\ubd80\uc11c \ubb38\uc11c\ud568 \ub2f4\ub2f9\uc790"],"\ub2f4\ub2f9\uc790 \ucd94\uac00":t["\ub2f4\ub2f9\uc790 \ucd94\uac00"]},l=Backbone.View.extend({initialize:function(e){this.deptId=e.deptId,this.deptName=e.deptName,this.collection.on("sync",this._renderList,this),this.collection.fetch(),this.isDeletedDept=!1,this.managerCollection=new u,this.managerCollection.setDeptId(this.deptId),this.managerCollection.fetch({async:!1,error:$.proxy(function(){this.isDeletedDept=!0},this)}),this.isSortMode=!1},events:{"click #sort":"_sortOrder","click #add":"_categorizePopup","click #delete":"_deleteFolders","click #checkAll":"_checkAll","change #manageFolderList input":"_toggleCheckAll","click .creat .btn_wrap":"addManager","click .btn_wrap .ic_del":"deleteManager"},render:function(){var e=this.managerCollection.toJSON();return this.$el.html(n({id:this.deptId,name:this.deptName,managerData:e,isDeletedDept:this.isDeletedDept,lang:f})),this},_renderList:function(){this.$("#manageFolderList").empty(),this._toggleCheckAll(),this._toggleOrderButton(),this.collection.each(function(e){this._renderFolderItem(e)},this),this.collection.length||this._renderEmptyFolder()},_renderEmptyFolder:function(){var e=["<tr>",'<td colspan="4">','<p class="data_null">','<span class="ic_data_type ic_no_contents"></span>','<span class="txt">',t["\ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"</span>","</p>","</td>","</tr>"].join("");this.$("#manageFolderList").html(e)},_categorizePopup:function(){var n=this;this.popup=$.goPopup({pclass:"layer_normal layer_doc_type_select",header:t["\ubd80\uc11c \ubb38\uc11c\ud568 \ucd94\uac00"],modal:!0,width:300,contents:"",buttons:[{btext:e["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(){var e=n.popup.find("#deptFolderName").val();if(!e){$.goError(t["\ubd80\uc11c \ubb38\uc11c\ud568 \ud3f4\ub354\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."],n.popup.find("#deptFolderError"));return}n._addFolder(e)}},{btext:e["\ucde8\uc18c"],btype:"cancel"}]}),this.popup.find("div.content").html(a)},_addFolder:function(e){var t=this,n=new i({deptId:this.deptId,folderName:e});n.save().done(function(e){t.collection.fetch(),t.popup.close()})},_renderFolderItem:function(e){var t=new r({model:e});this.$("#manageFolderList").append(t.render().el)},_sortOrder:function(t){var n=this,r=$(t.currentTarget),i=this.isSortMode?e["\uc21c\uc11c\ubc14\uafb8\uae30"]:e["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"];r.toggleClass("btn_save",this.isSortMode),r.text(i);if(this.isSortMode){var s={ids:this._getAllFolderIds()};this.collection.submitOrder(s).done(function(){n._renderSortMode(),n.collection.fetch()})}else this._renderSortMode()},_renderSortMode:function(){var e=this.isSortMode?"disable":"enable";this.$("#manageFolderList").removeClass().sortable({opacity:"1",delay:100,cursor:"move",items:"tr",containment:".content_page",hoverClass:"ui-state-hover",forceHelperSize:"true",helper:"clone",placeholder:"ui-sortable-placeholder",start:function(e,t){t.placeholder.html(t.helper.html())}}).sortable(e),this.isSortMode=!this.isSortMode},_getAllFolderIds:function(){return _.map(this.$("#manageFolderList").find("tr"),function(e){return $(e).attr("data-folderId")})},_getCheckedFolderIds:function(){return _.map(this.$("#manageFolderList").find("input:checked"),function(e){return $(e).attr("data-folderId")})},_deleteFolders:function(){var n=this,r=this._getCheckedFolderIds();if(!r.length){$.goError(t["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}$.goConfirm(e["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",function(){n.collection.deleteFolders({ids:r}).done(function(){n.collection.fetch()}).fail(function(t){t.responseJSON.message?$.goError(t.responseJSON.message):$.goError(e["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])})})},_checkAll:function(e){var t=this.$("#checkAll").is(":checked");this.$("#manageFolderList").find("input").attr("checked",t),this._toggleCheckAll()},_toggleCheckAll:function(){var e=this.$("#manageFolderList").find("input").length,t=this.$("#manageFolderList").find("input:checked").length,n=e!=0&&e==t?!0:!1;this.$("#checkAll").attr("checked",n)},_toggleOrderButton:function(){var e=this.collection.length>0;this.$("#sort").toggle(e)},addManager:function(n){var r=this;$.goOrgSlide({header:t["\ub2f4\ub2f9\uc790 \ucd94\uac00"],desc:"",contextRoot:GO.contextRoot,isCustomType:!0,memberTypeLabel:t["\ub2f4\ub2f9\uc790"],externalLang:e,isBatchAdd:!0,isAdmin:!0,callback:function(e){r.addMember(e)}})},addMember:function(n){var r=this,i=$("#addMembers");if(n&&!i.find('li[data-userId="'+n.id+'"]').length){var u=new o,a=_.isArray(n)?n:[n],l=_.map(a,function(e){return e.id}),c=this.managerCollection.getUserIds(),h=_.difference(l,c);if(!h.length)return;u.setDeptId(r.deptId),u.save({},{data:JSON.stringify({ids:h}),contentType:"application/json",type:"PUT",success:function(t,n){if(n.code=="200"){$.goMessage(e["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]);var o=_.reject(a,function(e){return _.contains(c,e.id)});_.each(o,function(e){i.find("li.creat").before(s($.extend(e,{lang:f})))}),r.managerCollection.fetch({async:!1})}},error:function(t,n){$.goMessage(e["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})}else $.goMessage(t["\uc774\ubbf8 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},deleteManager:function(t){var n=this,r=$(t.currentTarget).parents("li").attr("data-userId");$.ajax({url:GO.contextRoot+"ad/api/approval/deptfolder/"+this.deptId+"/manager",contentType:"application/json",dataType:"json",data:JSON.stringify({userId:r}),type:"DELETE",success:function(){$.goMessage(e["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),$(t.currentTarget).parents("li").remove(),n.managerCollection.fetch({async:!1})},error:function(e,t,n){var r=JSON.parse(e.responseText);$.goError(r.message)}})}});return l});