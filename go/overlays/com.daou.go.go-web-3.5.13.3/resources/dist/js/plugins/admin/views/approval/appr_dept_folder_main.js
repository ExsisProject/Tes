define(["when","i18n!nls/commons","i18n!admin/nls/admin","i18n!approval/nls/approval","hgn!admin/templates/approval/appr_dept_folder_main","admin/views/approval/appr_dept_folder_tree","admin/views/approval/appr_dept_folder_list","admin/views/approval/appr_dept_setting_list_layout","admin/views/approval/appr_dept_folder_manage","admin/collections/approval/appr_dept_folders","jquery.go-orgslide"],function(e,t,n,r,i,s,o,u,a,f){var l=["<input id='normalState' name='status' type='radio' value='department'>","<label for='normalState'>",t["\uc815\uc0c1 \ubd80\uc11c \uac80\uc0c9"],"</label>","<br />","<input id='deleteState' name='status' type='radio' value='deleteDept'>","<label for='deleteState'>",t["\uc0ad\uc81c\ub41c \ubd80\uc11c \uac80\uc0c9"],"</label>"].join(""),c={"\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac":r["\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac"],"\ubd80\uc11c \ubb38\uc11c\ud568 \uc0ac\uc6a9 \uc124\uc815":n["\ubd80\uc11c \ubb38\uc11c\ud568 \uc0ac\uc6a9 \uc124\uc815"],"\uc0ac\uc6a9 \uc124\uc815":n["\uc0ac\uc6a9 \uc124\uc815"],"\ubd80\uc11c \uc120\ud0dd":t["\ubd80\uc11c \uc120\ud0dd"],"[\ubd80\uc11c \uc0c1\uc138]\ub85c \uc774\ub3d9":n["[\ubd80\uc11c \uc0c1\uc138]\ub85c \uc774\ub3d9"],"\ubd80\uc11c \ubb38\uc11c\ud568 \ubaa9\ub85d":n["\ubd80\uc11c \ubb38\uc11c\ud568 \ubaa9\ub85d"]},h=Backbone.Collection.extend({initialize:function(e){this.options=e||{}},url:function(){return GO.config("contextRoot")+"ad/api/approval/deptsetting"}}),p=Backbone.View.extend({popupEl:null,initialize:function(e){this.options=e||{},this.deptId=this.options.opt1,this.collection=new f,this.department={id:null,name:null},this.orgOptiontype="department"},events:{"click #callOrg":"_callOrg","click #moveDeptDetail":"_moveDeptDetail","click #btnDeptApprSetting":"popupDeptApprSetting"},render:function(){this.$el.html(i({lang:c})),this._renderDefaultTree()},popupDeptApprSetting:function(){var n=[],i=this;this.popupEl=$.goPopup({header:r["\ubd80\uc11c \uc77c\uad04 \uc14b\ud305"],modal:!0,width:650,pclass:"layer_normal layer_use_set",contents:"",buttons:[{btext:t["\ud655\uc778"],autoclose:!1,btype:"confirm",callback:function(e){i.saveDeptApprSetting(e)}},{btext:t["\ucde8\uc18c"],btype:"cancel"}]}),this.layoutView=new u,e(this.layoutView.render()).then(function(){i.popupEl.reoffset()}).otherwise(function(t){console.log(t.stack),i.popupEl.reoffset()})},saveDeptApprSetting:function(e){var n=new h;n.fetch({type:"PUT",dataType:"json",contentType:"application/json",data:JSON.stringify(this.layoutView.getData())}).done(function(){$.goMessage(t["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),e.close()}).fail(function(){$.goError(t["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])})},_renderDefaultTree:function(){var e=this;this._getDepts().done(function(){e._renderTree("draft")})},_getDepts:function(){var e=this;return $.ajax({url:GO.contextRoot+(this.deptId?"ad/api/department/"+this.deptId:"ad/api/organization/root"),success:function(t){var n=t.data.id,r=t.data.name;e.collection.setDeptId(n),e.department={id:n,name:r}}})},_callOrg:function(e,t){var n=t||this._defaultOrgOption(),r=this,i=$.goOrgSlide(n),s=i.getPopupEl();s.find("input[name='status'][value='"+n.type+"']").attr("checked","chcked"),s.find("input[name='status']").on("change",function(){var e=$(this).val(),t=r._defaultOrgOption(e);r._callOrg(null,t),r.orgOptiontype=t.type})},_moveDeptDetail:function(e,r){var i=this,s=n["\ud574\ub2f9 \ud654\uba74\uc73c\ub85c \uc774\ub3d9\ud558\uae30 \uc704\ud55c \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],o=[];GO.routes.hasRouteAuth("admin","dept(/:id)")&&(s=GO.i18n(n["\uba54\ub274\ub85c \uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c"],{menuName:n["\ubd80\uc11c \uc0c1\uc138"]}),o=[{btext:t["\ud655\uc778"],btype:"confirm",autoclose:!0,callback:function(){if(_.isEmpty(i.department))window.location.href=GO.contextRoot+"admin/dept/";else{var e=i.department.id;i.orgOptiontype=="department"?window.location.href=GO.contextRoot+"admin/dept/"+e:i.orgOptiontype=="deleteDept"&&(window.location.href=GO.contextRoot+"admin/dept/delete/"+e)}}},{btext:t["\ucde8\uc18c"]}]),$.goPopup({width:600,title:"",pclass:"layer_confim",contents:"<p class='q'>"+s+"</p>",buttons:o})},_defaultOrgOption:function(e){var n=this;return{contextRoot:GO.contextRoot,header:t["\ubd80\uc11c \uc120\ud0dd"],isAdmin:!0,type:e||"department",headerOption:l,callback:function(e){n.collection.setDeptId(e.id),n.department=e,n._renderTree()}}},_renderTree:function(e){var t=new s({deptId:this.department.id,deptName:this.department.name||this.department.deptName,collection:this.collection,defaultType:e});this.$("#treeArea").html(t.render().el),this._clearList(),t.on("renderList",this._renderList,this),t.on("renderManage",this._renderManage,this)},_renderList:function(e){var t=e[0],n=$(t),r=n.attr("data-navi"),i=n.attr("data-folderId"),s=n.find("span.txt").text(),u=new o({name:s,folderId:i,type:r,department:this.department,isPredefined:r!="doc",isOfficial:r=="official"});this.$("#listArea").html(u.el),u.render()},_clearList:function(){this.$("#listArea").empty()},_renderManage:function(){var e=new a({deptId:this.department.id,deptName:this.department.name,collection:this.collection});this.$("#listArea").html(e.render().el)}},{attachTo:function(e){var t=new p;return e.empty().append(t.el),t.render(),t}});return p});