define("admin/views/menu_admin",function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("admin/models/menu_admin"),i=require("admin/models/install_info"),s=require("admin/models/menu"),o=require("admin/views/menu_detail"),u=require("hgn!admin/templates/menu_admin"),a=require("i18n!nls/commons"),f=require("i18n!admin/nls/admin");require("jquery.go-validation"),require("jquery.go-popup"),require("jquery.go-sdk");var l="about:blank",c={label_delete:a["\uc0ad\uc81c"],label_initial:f["\ucd08\uae30\uba54\ub274 \uc9c0\uc815"],label_order:f["\uc21c\uc11c \ubc14\uafb8\uae30"],menu_list:f["\uba54\ub274\ubaa9\ub85d"],select:a["\uc120\ud0dd"],systemMenu:f["\uae30\ubcf8\uba54\ub274"],etcMenu:f["\ubd80\uac00\uba54\ub274"],category:f["\uce74\ud14c\uace0\ub9ac"],link:f["\ub9c1\ud06c"],changeDepth:f["\ub4e4\uc5ec\uc4f0\uae30"],label_selected:f["\uc120\ud0dd\ud55c \uba54\ub274"],top:f["\ub9e8 \uc704\ub85c"],up:f["\uc704\ub85c"],down:f["\uc544\ub798\ub85c"],bottom:f["\ub9e8 \uc544\ub798\ub85c"]},h=Hogan.compile('<li class="ic" data-depth="parent" data-type="{{menuType}}"><a data-id="{{id}}" rel="org"><ins class="{{#systemMenu}}menu{{/systemMenu}}{{^systemMenu}}{{#subMenuType}}folder{{/subMenuType}}{{^subMenuType}}link{{/subMenuType}}{{/systemMenu}}">&nbsp;</ins>{{name}}{{#initial}}'+f["(\ucd08\uae30\uba54\ub274)"]+"{{/initial}}"+"</a>"+"{{#hasSubmenu}}"+"<ul>"+"{{/hasSubmenu}}"+"{{#activeSubMenu}}"+'<li class="ic" data-depth="child">'+'<a data-id="{{id}}" rel="org">'+'<ins class="{{#systemMenu}}menu{{/systemMenu}}'+"{{^systemMenu}}"+"{{#subMenuType}}folder{{/subMenuType}}"+"{{^subMenuType}}link{{/subMenuType}}"+'{{/systemMenu}}">&nbsp;'+"</ins>{{name}}"+"{{#initial}}"+f["(\ucd08\uae30\uba54\ub274)"]+"{{/initial}}"+"</a>"+"</li>"+"{{/activeSubMenu}}"+"{{#hasSubmenu}}"+"</ul>"+"{{/hasSubmenu}}"+"</li>"),p=n.BaseView.extend({initialize:function(){this.model=new r,this.installInfo=i.init()},dataFetch:function(){var t=e.Deferred(),n=this.model.fetch(),r=this.installInfo.fetch();return e.when(n,r).done(function(){t.resolve()}),t},events:{"click ul a[data-id]":"showDetail","click #order":"order","click #activateMenu":"activateMenu","click #setInitialMenu":"setInitialMenu","click #deleteMenu":"deleteMenu","click #top":"topAndBottom","click #bottom":"topAndBottom","click #up":"up","click #down":"down","click #changeDepth":"changeDepth"},render:function(){var e=this;return this.dataFetch().done(function(){e.$el.html(u({lang:c})),e.renderSystemMenus(),e.renderActiveMenus(),e.selectInitMenu()}),_.forEach(this.$el.find(".simplebar-content-wrapper"),function(e){new SimpleBar(e)}),this},renderSystemMenus:function(){var e=Hogan.compile('<li class="ic"><a data-id={{id}} rel="org" class="{{#isActive}}a_menu_disabled{{/isActive}}"><ins class="menu">&nbsp;</ins>{{name}}</a></li>');_.each(this.model.getSystemMenus(),function(t){var n=_.extend(t,{isActive:t.status=="online"});this.$("#systemMenus").append(e.render(n))},this)},renderActiveMenus:function(){this.$("#active").empty(),_.each(this.model.getActiveMenusTree(),function(e){var t=new s(e),n=t.getMenuType(),r=t.hasActiveSubmenu();this.$("#active").append(h.render(_.extend(e,{menuType:n,hasSubmenu:r})))},this)},showDetail:function(t){var n=this,r=e(t.currentTarget),i=r.attr("data-id");if(i==this.currentMenu)return;this.currentMenu=i,this.unmarkMenu(),this.markCurrentMenu(),this.buttonToggle();var s=r.attr("data-id"),u=parseInt(s)?this.model.getMenuModel(s):this.initMenuModel(s);this.detailView=new o({model:u,installInfo:this.installInfo}),this.$("div.col2").replaceWith(this.detailView.el).show(),this.detailView.$el.on("change:menu",function(e,t){n.model.fetch().done(function(){n.refreshTree(t)})}),this.detailView.render(),e("div.col1").height(e("div.col2").height())},refreshTree:function(e){this.renderActiveMenus(),this.remarkCurrentMenu(e),this.buttonToggle()},initMenuModel:function(e){var t=this.getSelectedMenuId(),n=this.installInfo.get("language"),r=t=="category"?f["\uc0c8 \uce74\ud14c\uace0\ub9ac"]:f["\uc0c8 \ub9c1\ud06c"],i=t=="category"?!0:!1,o=new s({name:r,subMenuType:i});return o.set(this.getLocaleCode(n)+"Name",r),o.set("status","stop"),e=="link"&&o.set("url",l),o},getLocaleCode:function(e){var t=null;return e=="ja"?t="jp":e=="zh_CN"?t="zhcn":e=="zh_TW"?t="zhtw":t=e,t},changeDepth:function(e){if(!this.isPossibleIndent())return;var t=this.getSelectedMenu();if(!t.length)return;var n=t.attr("data-id");if(!n)return;var r=this.model.getMenuModel(n),i=this;if(this.isPossibleIndent()){var o=this.getParentMenu(t).find("a").attr("data-id");r.get("parentId")?r.set("parentId",""):r.set("parentId",o),GO.util.preloader(r.save().done(function(e){i.syncDetailView(new s(e.data)),i.model.fetch().done(function(){i.renderActiveMenus(),i.markCurrentMenu(),i.buttonToggle()})}))}},order:function(t){var n=this;if(this.isOrdering){this.$("span.btn_s").removeClass("btn_disable"),this.buttonToggle(),this.$("#order").text(f["\uc21c\uc11c \ubc14\uafb8\uae30"]);var r=_.map(this.$("#active").find("a"),function(t){return e(t).attr("data-id")});this.model.setOrder(r).done(function(){n.$("#active").sortable("destroy"),n.isOrdering=!1,n.renderActiveMenus(),n.markCurrentMenu()})}else this.$("div.col1").find("span.btn_s").not("#order").addClass("btn_disable"),this.$("#order").text(f["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"]),this.$("#active").removeClass().sortable({scrollSensitivity:1,opacity:"1",delay:100,items:"li",containment:"#activeSortableArea",hoverClass:"ui-state-hover",forceHelperSize:"true",helper:"clone",placeholder:"ui-sortable-placeholder",stop:function(e,t){var r=t.item.children("a"),i=n.isPossibleDrop(r);return n.isChangeDepth(r),i}}),this.isOrdering=!0},isChangeDepth:function(t){var n=t.attr("data-id"),r=this.model.getMenu(n),i=t.parents("li")[1],s=i?e(i).children("a").attr("data-id"):"",o=r.parentId||"",u=o!=s;if(u){var a={parentId:s};r.parentId=s,this.model.updateMenu(n,a)}},topAndBottom:function(t){var n=this.getSelectedMenuId();if(!n)return;var r=e(t.currentTarget),i=r.attr("data-type");if(i=="top"&&!this.isPossibleTop())return;if(i=="bottom"&&!this.isPossibleBottom())return;var s=this.getUnselectedMenuIds();i=="top"?s.unshift(n):s.push(n);var o=this;this.model.setOrder(s).done(function(){o.renderActiveMenus(),o.markCurrentMenu(),o.buttonToggle()})},up:function(e){if(!this.isPossibleUp())return;var t=this.getSelectedMenuId();if(!t)return;var n=this.getMenuIds(),r=_.indexOf(n,t);if(r==0)return;var i=this.getSelectedMenuWrap(),s=i.prev();s.before(i),this.setOrder()},down:function(e){function o(){return r==n.length-1}if(!this.isPossibleDown())return;var t=this.getSelectedMenuId();if(!t)return;var n=this.getMenuIds(),r=_.indexOf(n,t);if(o())return;var i=this.getSelectedMenuWrap(),s=i.next();s.after(i),this.setOrder()},setOrder:function(){var e=this,t=this.getMenuIds();this.model.setOrder(t).done(function(){e.renderActiveMenus(),e.markCurrentMenu(),e.buttonToggle()})},activateMenu:function(){var e=this.$("#system").find("a.jstree-clicked"),t=e.attr("data-id");if(t==undefined)return;var n=this.model.isActive(t);if(n)return;var r=this,i={status:"online"};t=="category"||t=="link"?(this.detailView.model.set("status","online"),this.detailView.submit(),this.buttonToggle()):this.model.updateMenu(t,i).done(function(t){r.syncDetailView(new s(t.data)),r.model.fetch().done(function(){r.renderActiveMenus(),r.markCurrentMenu(),r.buttonToggle(),e.addClass("a_menu_disabled")})})},setInitialMenu:function(t){if(!this.isPossibleInitial())return;var n=this.getSelectedMenuId();if(!n)return;var r=this;GO.EventEmitter.trigger("common","layout:setOverlay",""),this.model.setInitialMenu(n).done(function(t){e.goMessage(a["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),r.refreshTree(t)}).always(function(){GO.EventEmitter.trigger("common","layout:clearOverlay",!0)})},markCurrentMenu:function(){this.$("a[data-id= "+this.currentMenu+"]").addClass("jstree-clicked")},unmarkMenu:function(){this.$("a").removeClass("jstree-clicked")},remarkCurrentMenu:function(e){this.currentMenu=="category"||this.currentMenu=="link"?(this.unmarkMenu(),this.currentMenu=e.id,this.markCurrentMenu()):this.markCurrentMenu()},deleteMenu:function(){if(!this.isPossibleDelete())return;var e=this.getSelectedMenuId();if(!e)return;var t=this.model.getMenuModel(e),n=t.isSystemMenu();n?this.deleteSystemMenu(e):this.deleteEtcMenu(t,e)},deleteSystemMenu:function(e){var t={status:"stop"},n=this;this.model.updateMenu(e,t).done(function(t){n.syncDetailView(new s(t.data)),n.model.fetch().done(function(){n.renderActiveMenus(),n.$("#system").find("a[data-id='"+e+"']").removeClass("a_menu_disabled"),n.buttonToggle(),n.selectInitMenu()})})},deleteEtcMenu:function(e,t){var n=this,r=[];this.model.leaveParent(t).done(function(e){n.destroyMenu(t)})},destroyMenu:function(e){var t=this;t.model.deleteMenu(e).done(function(){t.model.fetch().done(function(){t.renderActiveMenus(),t.$("div.col2").empty(),t.buttonToggle(),t.selectInitMenu()})})},getSelectedSystemMenu:function(){return this.$("#system").find("a.jstree-clicked")},getSelectedMenu:function(){return this.$("#active").find("a.jstree-clicked").last()},getSelectedMenuWrap:function(){return this.getSelectedMenu().parent("li")},getSelectedMenuId:function(){return this.getSelectedMenu().attr("data-id")||this.getSelectedSystemMenu().attr("data-id")},getMenuIds:function(){return _.map(this.$("#active").find("a"),function(t){return e(t).attr("data-id")})},getParentMenuIds:function(){return _.map(this.$("#active").find("li[data-depth=parent]"),function(t){return e(t).children("a").attr("data-id")})},getSiblingIds:function(t){var n=e(t).parents("ul").first().children("li");return _.map(n,function(t){return e(t).find("a").attr("data-id")})},getUnselectedMenuIds:function(){return _.map(this.$("#active").find("a").not(".jstree-clicked"),function(t){return e(t).attr("data-id")})},isChildMenu:function(t){return e(t).parent("li").attr("data-depth")=="child"},getParentMenu:function(t){return e(t).parent("li").prev()},isIndentPossible:function(t){if(this.isChildMenu(t))return!0;var n=e(t).parent("li").prev(),r=n.length>0;if(!r)return!1;var i=n.find("a").attr("data-id"),s=this.model.getMenuModel(i).isCategory();return r&&s},isPossibleDrop:function(t){var n=t.attr("data-id"),r=this.model.getMenuModel(n),i=r.isCategory(),s=e(t).parents("li").length>1;return i&&s?!1:!0},buttonToggle:function(){this.$("#changeDepth").toggleClass("btn_disable",!this.isPossibleIndent()),this.$("#setInitialMenu").toggleClass("btn_disable",!this.isPossibleInitial()),this.$("#top").toggleClass("btn_disable",!this.isPossibleTop()),this.$("#bottom").toggleClass("btn_disable",!this.isPossibleBottom()),this.$("#up").toggleClass("btn_disable",!this.isPossibleUp()),this.$("#down").toggleClass("btn_disable",!this.isPossibleDown()),this.$("#deleteMenu").toggleClass("btn_disable",!this.isPossibleDelete())},isPossibleIndent:function(){var e=this.getSelectedMenu(),t=e.attr("data-id");if(!t)return!1;var n=this.model.getMenuModel(t),r=this.isIndentPossible(e),i=n.isPossibleIndent(),s=r&&i;return s},isPossibleInitial:function(){var e=this.getSelectedMenuId();if(!e)return!1;var t=this.model.getMenuModel(e),n=!(t.isCategory()||t.isLink()||t.isInitial())&&t.isActive();return n},isPossibleTop:function(){var e=this.getMenuIds(),t=this.getSelectedMenuId(),n=this.getSelectedMenu(),r=_.indexOf(e,t),i=r>0&&!this.isChildMenu(n);return i},isPossibleBottom:function(){var e=this.getParentMenuIds(),t=this.getSelectedMenuId(),n=_.indexOf(e,t);if(n==-1)return!1;var r=this.getSelectedMenu(),i=n+1!=e.length&&!this.isChildMenu(r);return i},isPossibleUp:function(){var e=this.getSelectedMenu(),t=this.getSelectedMenuId(),n=this.getSiblingIds(e),r=_.indexOf(n,t),i=r>0;return i},isPossibleDown:function(){var e=this.getSelectedMenu(),t=this.getSelectedMenuId(),n=this.getSiblingIds(e),r=_.indexOf(n,t),i=r+1!=n.length;return i},isPossibleDelete:function(){var e=this.getSelectedMenuId(),t=parseInt(e)?this.model.getMenuModel(e):this.initMenuModel(e),n=t.isActive()&&!this.model.hasOneActive()&&!t.isInitial();return n},isActivatable:function(){var e=this.getSelectedMenuId(),t=this.model.getMenuModel(e),n=!t.isActive();return n},syncDetailView:function(e){this.detailView.model=e,this.detailView.render()},selectInitMenu:function(){var e=this.model.getInitMenu();this.$("a[data-id='"+e.id+"']").trigger("click")}});return p});