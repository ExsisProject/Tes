define(["jquery","backbone","app","i18n!nls/commons","i18n!admin/nls/admin","i18n!approval/nls/approval","hgn!admin/templates/appr_form_template_editor","admin/views/appr_form_template_list","components/form_component_manager/approval_form_manager","formeditor","jquery.go-sdk","jquery.go-popup","jquery.go-grid"],function(e,t,n,r,i,s,o,u,a){var f={head_title:s["\uacb0\uc7ac \uc591\uc2dd \ucd94\uac00"],caption:r["\ub4f1\ub85d\uc815\ubcf4"],title:r["\uc81c\ubaa9"],form_name:r["\uc81c\ubaa9"],edit_template:s["\uc591\uc2dd \ud3b8\uc9d1"],template_editor:s["\uc591\uc2dd \ud3b8\uc9d1\uae30"],template_preview:r["\ubbf8\ub9ac\ubcf4\uae30"],load_another_template:s["\ub2e4\ub978 \uc591\uc2dd \ubd88\ub7ec\uc624\uae30"],load_template_title:s["\ub2e4\ub978 \uc591\uc2dd \uc870\ud68c"],state:i["\uc0ac\uc6a9\uc5ec\ubd80"],hidden:i["\uc228\uae40"],normal:i["\uc815\uc0c1"],empty_msg:s["\ub4f1\ub85d\ub41c \uc591\uc2dd\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],creation_success_msg:s["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4. \uc591\uc2dd \ubaa9\ub85d\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4."],creation_fail_msg:r["\uc800\uc7a5\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cancel_and_go_to_list_msg:s["\ucde8\uc18c\ud558\uc168\uc2b5\ub2c8\ub2e4. \uc774\uc804 \ud654\uba74\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4."],msg_cannot_preview_html:s["\ud604\uc7ac \uc77c\uc2dc\uc801\uc778 \ubb38\uc81c\ub85c \uc591\uc2dd\uc744 \ubbf8\ub9ac\ubcf4\uae30 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4. \uc7a0\uc2dc \ud6c4 \ub2e4\uc2dc \uc2dc\ub3c4\ud574\uc8fc\uc138\uc694."],select:r["\uc120\ud0dd"],add:r["\ucd94\uac00"],"delete":r["\uc0ad\uc81c"],save:r["\uc800\uc7a5"],cancel:r["\ucde8\uc18c"]};return t.View.extend({editorElId:"appr_form_template_editor",previewElId:"template_preview_box",popupEl:null,htmlContent:null,approvalInfo:null,editorOption:{lang:GO.session("locale"),bUseApprovalType:"approval",theme:"form-appr-admin"},initialize:function(t){t=_.extend({},t),this.title=t.title,this.htmlContent=this.model&&this.model.get("templateHtml"),t.approvalInfo&&(this.approvalInfo=t.approvalInfo),_.isString(t.previewElId)&&(this.previewElId=t.previewElId),this.config=t.config,this.TemplateListModule=u,this.approvalInfo&&(this.editorOption.approvalInfo=this.approvalInfo),_.isString(this.htmlContent)&&(this.editorOption.content=e.goFormEditor.spanToDSL(this.htmlContent))},render:function(){var t=e(".tWrap"),n=new a(_.extend(this.editorOption,{title:this.title,editorId:"formEditor",model:this.model,config:this.config,toggleEl:t,companyIds:this.companyIds}));t.hide(),e("body").append(n.render().el)},renderOldFormEditor:function(){this.popupEl=e.goPopup({header:f.edit_template,modal:!0,width:1e3,height:"800px",pclass:"layer_normal layer_doc_edit",contents:o({lang:f}),closeCallback:_.bind(function(){this._cancelTemplate()},this)});var t=this.editorOption;this.approvalInfo&&(t.approvalInfo=this.approvalInfo),_.isString(this.htmlContent)&&(t.editorValue=e.goFormEditor.spanToDSL(this.htmlContent)),e("#"+this.editorElId).goFormEditor(t),this.popupEl.off("click","a#save_template"),this.popupEl.off("click","a#cancel_template"),this.popupEl.off("click","a#load_another_template"),this.popupEl.on("click","a#save_template",e.proxy(this._saveTemplate,this)),this.popupEl.on("click","a#cancel_template",e.proxy(this._cancelTemplate,this)),this.popupEl.on("click","a#load_another_template",e.proxy(this._loadAnotherTemplate,this))},syncApprLineToHtmlContent:function(t,n){if(!this.htmlContent)return;var r=e(this.htmlContent),i=e(r[0]),s=i.find("[data-group-seq]"),o=_.filter(s,function(n){var r=e(n);return parseInt(r.attr("data-group-seq"))===t.get("seq")&&r.attr("data-is-reception")!="true"})[0],u=e(o),a=u.attr("data-group-type");_.has(t.changed,"name")&&(u.attr("data-group-name",t.get("name")),u.find("th").text(t.get("name")));if(_.has(t.changed,"maxApprovalCount")){u.attr("data-group-max-count",t.get("maxApprovalCount"));var f,l;if(a==="type1"){var c=u.find("th");f=c.siblings("td:first").clone(),l=c.parent(),c.siblings("td").remove()}else f=u.children(":first").clone(),l=u,u.children().remove();for(var h=0;h<t.get("maxApprovalCount");h++)l.append(f.clone())}n&&u.remove(),this.htmlContent=e("<div>").append(i).html(),this.model.set("templateHtml",this.htmlContent)},validateActivityGroups:function(t){var n=e.parseHTML(this.model.get("templateHtml")),r,i,s=!0;return _.isNull(n)?!0:(i=_.filter(e(n[0]).find("[data-group-seq]"),function(t){return e(t).attr("data-is-reception")!="true"}),r=_.map(i,function(t){return{seq:e(t).data("group-seq"),name:e(t).data("group-name"),activityMaxCount:e(t).data("group-max-count")}}),_.each(t,function(e){var t=_.map(r,function(e){return e.seq});_.contains(t,e.seq)||(console.log("Template Html validation is fail: Missing group box."),s=!1),_.each(r,function(t){e["seq"]==t["seq"]&&(e["name"]!=t["name"]&&(console.log("Template Html validation is fail: Unmatching group box name."),s=!1),e["maxApprovalCount"]!=t["activityMaxCount"]&&(console.log("Template Html validation is fail: Not matching approval count."),s=!1))})}),s)},validateApprLineRuleForm:function(e){var t=this.model.get("templateHtml"),n=!0;return _.isNull(t)?!0:(e&&e.apprLineRuleGroups&&(_.isUndefined(e.apprLineRuleOptionCount)&&(e.apprLineRuleOptionCount=e.apprLineRuleGroups.length),e.apprLineRuleGroups&&e.apprLineRuleOptionCount>1&&t.indexOf("apprLineRuleOption")==-1&&(n=!1),e.useAccountRule&&t.indexOf("apprLineRuleAmount")==-1&&(n=!1)),n)},setContent:function(e){this.htmlContent=e},setApprovalInfo:function(e){this.approvalInfo=e},setCompanyIds:function(e){this.companyIds=e},setTitle:function(e){this.title=e},getContent:function(){return this.htmlContent},preview:function(t){var n=e.goPopup({allowPrevPopup:!0,header:f.template_preview,modal:!0,top:"20%",width:810,pclass:"layer_normal layer_doc_edit_preview",contents:'<form><div class="doc_wrap" style="width:780px" class="ie9-scroll-fix" id="'+this.previewElId+'"></div></form>'});t=t||this.model.get("templateHtml"),t?(e("#"+this.previewElId).setTemplate({data:t}),parseInt(n.css("height"))<100&&n.css("height",100),n.find("div.content").css({"max-height":"500px",overflow:"auto"}),n.reoffset()):(e.goSlideMessage(f.empty_msg,"caution"),n.close())},_saveTemplate:function(){this.htmlContent=e.goFormEditor.getContent(this.editorElId),this.model.set("templateHtml",this.htmlContent),this.popupEl.close()},_cancelTemplate:function(){this.templateListView&&this.templateListView.close(),this.popupEl.close()},_loadAnotherTemplate:function(){if(!this.templateListView||this.templateListView.isListViewOpen==0)this.templateListView=new this.TemplateListModule({EditorModule:this.constructor,selectCallback:e.proxy(function(t){e.goFormEditor.putContent(this.editorElId,t)},this)}),this.templateListView.render(),this.templateListView.isListViewOpen=!0}},{lang:f})});