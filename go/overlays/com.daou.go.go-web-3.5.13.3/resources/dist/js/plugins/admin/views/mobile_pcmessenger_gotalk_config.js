define(function(require){var e=require("i18n!nls/commons"),t=require("i18n!admin/nls/admin"),n=require("hgn!admin/templates/mobile_pcmessenger_gotalk_config"),r=require("hgn!admin/templates/list_empty"),i=24,s=60;require("jquery"),require("jquery.go-grid");var o=Backbone.View.extend({events:{"click span#btn_ok":"_ConfigSave","click span#btn_cancel":"_ConfigSaveCancel","change input[data-type='maxUserCount']":"_numValidation"},initialize:function(){this.dataTable=null},render:function(){this.$el.html(n({lang:{"\uad6c\ub9e4\ud68c\uc758\uc2e4\uac1c\uc218":t["\uad6c\ub9e4 \ud68c\uc758\uc2e4 \uac1c\uc218"],"\uac1c":t["\uac1c"],"\ubc29\uc774\ub984\uc548\ub0b4":t["\ubc29\uc774\ub984\uc548\ub0b4"],"\ubc29\uc774\ub984":t["\ubc29 \uc774\ub984"],"\ucc38\uc5ec\uc778\uc6d0\uc548\ub0b4":t["\ucc38\uc5ec\uc778\uc6d0\uc548\ub0b4"],"\ucc38\uc5ec\uc790\uc778\uc6d0":t["\ucc38\uc5ec\uc790 \uc778\uc6d0"],"\uc720\ud6a8\uc2dc\uac04\uc548\ub0b4":t["\uc720\ud6a8\uc2dc\uac04\uc548\ub0b4"],"\ucd08\ub300\ud558\uae30\uc720\ud6a8\uc2dc\uac04\uc124\uc815":t["\ucd08\ub300\ud558\uae30 \uc720\ud6a8\uc2dc\uac04 \uc124\uc815"],"\uc800\uc7a5":e["\uc800\uc7a5"],"\ucde8\uc18c":e["\ucde8\uc18c"]}})),this.renderRoomList()},HOUR:function(e){return _.range(0,i).map(function(t){return t<10?"<option"+(e==t?" selected ":" ")+"value="+"0"+t+">"+"0"+t+"h"+"</option>":"<option"+(e==t?" selected ":" ")+"value="+t+">"+t+"h"+"</option>"})},MINUTE:function(e){return _.range(0,s).map(function(t){return t<10?"<option"+(e==t?" selected ":" ")+"value="+"0"+t+">"+"0"+t+"m"+"</option>":"<option"+(e==t?" selected ":" ")+"value="+t+">"+t+"m"+"</option>"})},renderRoomList:function(){var e=this;this.dataTable!=null&&this.dataTable.tables.fnDestroy(),this.dataTable=$.goGrid({el:e.$el.find("#roomList"),method:"GET",url:GO.contextRoot+"ad/api/meeting/room",emptyMessage:r({label_desc:t["\uad6c\ub9e4\ud55c \ud654\uc0c1\ucc44\ud305\ubc29\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]}),pageUse:!1,sDomUse:!1,columns:[{mData:"roomSeqName",sWidth:"80px",bSortable:!1,fnRender:function(e){return'<span class="roomSeqName" data-id="'+e.aData.roomSeqName+'">'+(e.iDataRow+1)+"</span>"}},{mData:"title",sWidth:"400px",bSortable:!1,fnRender:function(e){return'<input data-type="title" class="w_full input titleInput" type="text" value="'+e.aData.title+'">'+'<p data-id="error" style="display: none" class="go_alert"></p>'}},{mData:"maxUserCount",sWidth:"200px",bSortable:!1,fnRender:function(e){return'<input data-type="maxUserCount" class="w_full input numInput" min=1 max=25 type="number" value='+e.aData.maxUserCount+">"+'<p data-id="error" style="display: none" class="go_alert"></p>'}},{mData:"validTime",sClass:"time",bSortable:!1,fnRender:function(t){var n=moment.duration(t.aData.validTime),r=n.hours(),i=n.minutes();return'<select data-type="validTimeH" class="attr_select" >'+e.HOUR(r)+"</select>"+'<select data-type="validTimeM" class="" value='+i+">"+e.MINUTE(i)+"</select>"+'<p data-id="error" style="display: none" class="go_alert"></p>'}}],fnDrawCallback:function(t){!t.isEmpty()&&t.find("tbody tr").length&&e.$el.find("#totalNum").text(t.find("tbody tr").length)}})},_ConfigSaveCancel:function(t){var n=this;if(n._getMeetingRooms().length<=0)return!1;$.goMessage(e["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),this.renderRoomList()},_getMeetingRooms:function(){var e=[];return this.dataTable.tables.fnGetNodes().forEach(function(t){var n={};n.title=$(t).find("td input.titleInput").val(),n.roomSeqName=$(t).find("td .roomSeqName").data("id"),n.maxUserCount=$(t).find("td input.numInput").val();var r=$($(t).find("td.time option:selected")[0]).val(),i=$($(t).find("td.time option:selected")[1]).val();n.validTime=r*60*60*1e3+i*60*1e3,e.push(n)}),e},_titleValidation:function(){var e=!0;return _.each(this.$el.find('input[data-type="title"]'),function(n){var r=$(n);r.val().length<2||r.val().length>20?(r.parent().find("p").text(t["2\uc790 \uc774\uc0c1 20\uc790 \uc774\ud558 \uc785\ub825 \ud574\uc8fc\uc138\uc694"]).show(),e=!1):r.parent().find("p").text("").hide()}),e},_numValidation:function(e){var t=$(e.currentTarget);t.val()>=1&&t.val()<=25?t.parent().find("p").text("").hide():t.val(1)},_validTimeValidation:function(){var e=!0;return _.each(this.$el.find('select[data-type="validTimeH"]'),function(n){var r=$(n),i=r.closest("tr").find("[data-type=validTimeH]").find("option:selected").val(),s=r.closest("tr").find("[data-type=validTimeM]").find("option:selected").val();i<=0&&s<=0?(r.parent().find("p").text(t["1\ubd84 \uc774\uc0c1 \uc2dc\uac04\uc744 \uc124\uc815\ud574\uc8fc\uc138\uc694"]).show(),e=!1):r.parent().find("p").text("").hide()}),e},_ConfigSave:function(t){var n=this,r=n._titleValidation(),i=n._validTimeValidation();if(n._getMeetingRooms().length<=0)return!1;if(!r||!i)return;$.ajax({url:GO.contextRoot+"ad/api/meeting/rooms",type:"PUT",data:JSON.stringify(n._getMeetingRooms()),dataType:"json",contentType:"application/json"}).success(function(t){$.goMessage(e["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])}).fail(function(t){t.message?$.goAlert(t.message):$.goMessage(e["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}).done(function(e){n.renderRoomList()})}});return o});