define("admin/views/layout/side_menu_new",function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("hgn!admin/templates/layout/side_menu_new"),i=require("admin/collections/side_menu_collection"),s=require("admin/views/layout/side_menu_list"),o=require("i18n!admin/nls/admin"),u=require("i18n!nls/commons"),a=require("admin/collections/favorite_menus"),f=require("admin/collections/recently_menus");return require("jquery.go-grid"),t.View.extend({events:{"click .logo":"moveToCompanyPage","click li":"movePage","keyup #filteringText":"filtering","click .gnb_tit":"toggleFolded","click .gnb_menu_manage .gnb_sub li .tit":"toggleFolded","click .btn_fold":"openFolded","click .btn_cancel_s_w":"cancelSearch"},initialize:function(){var e=this;this.sideMenuCollection=new i,this.favoriteMenus=new a,this.recentlyMenus=new f,this.models=this.sideMenuCollection.getMenus(),this.recentlyMenuView=new s("recently_",this.sideMenuCollection),this.favoritMenuView=new s("favorite_",this.sideMenuCollection),this.favoriteMenus.fetch({async:!1}),this.recentlyMenus.fetch({async:!1}),this.recentlyMenuView.update(this.recentlyMenus),this.favoritMenuView.update(this.favoriteMenus),window.onhashchange=function(){e.refreshSelectedMenu()}},render:function(){var t=n.session().companyName,i=this;return this.$el.html(r({contextRoot:GO.contextRoot,AdminLang:o,CommonLang:u,companyName:t})),this.$el.ready(function(){e("#tree").jstree({})}),this.refreshMenus(),this.addEventListener(),this.initbar(),e(window).resize(function(){i.resize()}),this},initbar:function(){new SimpleBar(e(".simplebar-content-wrapper")[0]),this.resize()},resize:function(){this.windowHeight=window.innerHeight*.95;var t=0;_.forEach(e(".head_sidebar"),function(n){t+=e(n).height()});var n=this.windowHeight-t;if(this.contentHeight===n)return;this.contentHeight=n,e("#sidebar_wrapper").height(n)},refreshMenus:function(){var t=this.$el.find("#management_menu");t.empty();var n=this._getCookie(),r=n?JSON.parse(n):{};this.selectedId=r.selectedId,this.notFoldeds=r.notFoldeds,this.searchKey=r.searchKey?r.searchKey:"",e("#filteringText").val(this.searchKey),this.models=this.sideMenuCollection.getFilteringModels(this.searchKey);var i=!1,s=this.getActiveSyncHistory();for(var o=0;o<this.models.length;o++){i|=this.models[o].view,t.append(this.tpl(this.models[o]));for(var u=0;u<this.models[o].childs.length;u++)this.models[o].childs[u].labelKey=="\ub3d9\uae30\ud654 \uc774\ub825\uad00\ub9ac"&&(s||this.$el.find("#management_menu").find("#root_C-f").remove())}i?(e("#null_data").hide(),e("#menu-content").show()):(e("#null_data").show(),e("#menu-content").hide()),this.$el.find("#recentlyMenu").append(this.recentlyMenuView.$el),this.$el.find("#favoritedMenu").append(this.favoritMenuView.$el),this.favoritMenuView.render(),this.recentlyMenuView.render(),this.isNotFold("favoritedMenu")&&(this.$el.find("#favoritedMenu").children("a").removeClass("folded"),this.favoritMenuView.$el.css("display","block"),s==0&&this.favoritMenuView.$el.find("#favorite_C-f").remove()),this.isNotFold("recentlyMenu")&&(this.$el.find("#recentlyMenu").children("a").removeClass("folded"),this.recentlyMenuView.$el.css("display","block")),this.refreshSelectedMenu()},getActiveSyncHistory:function(){var t=!1;return e.go(GO.contextRoot+"ad/api/site/adminjob/check/","",{qryType:"get",async:!1,contentType:"application/json",responseFn:function(e){t=e.data.data},error:function(t){e.goMessage(t.responseJSON.message)}}),t},refreshSelectedMenu:function(){if(!this.selectedId)return;var t=window.location.pathname.replace("/go","").replace("/admin/",""),n=this.selectedId.substr(this.selectedId.indexOf("_")+1),r=this.sideMenuCollection.findMenuFromHref(t);r&&n!==r.getMenuKey()&&e("#recently_"+r.getMenuKey()).length>0&&(this.selectedId="recently_"+r.getMenuKey(),e("#recentlyMenu").find("a").removeClass("folded"),e("#recentlyMenu").find("ul").css("display","block"),this.saveCookie(!0)),e(".tit").removeClass("on"),e("#"+this.selectedId).find(".tit").addClass("on")},filtering:function(t){this.searchKey=e(t.currentTarget).val(),this.saveCookie(!1),this.refreshMenus()},cancelSearch:function(){if(!this.searchKey)return;this.searchKey="",this.saveCookie(!1),this.refreshMenus()},moveToCompanyPage:function(){GO.router.navigate("/company",!0)},movePage:function(t){var r=e(t.currentTarget),i=r.attr("name"),s=r.attr("id"),o=this.sideMenuCollection.findMenu(i);if(!o)return;if(o&&o.childs.length<1){if(o.routingName==="window"){window.open(GO.contextRoot+o.href);return}this.selectedId=s,e("a").removeClass("on"),e("#"+s).find("a").addClass("on"),o.href&&n.router.navigate(o.href,{trigger:!0,pushState:!0})}this.saveCookie(!0)},toggleFolded:function(t){var n=this,r=e(t.currentTarget);t.preventDefault(),r.toggleClass("folded");var i=navigator.userAgent.toLowerCase();navigator.appName=="Netscape"&&navigator.userAgent.search("Trident")!=-1||i.indexOf("msie")!=-1?r.hasClass("folded")?e(r).parent().children(".gnb_sub").hide():e(r).parent().children(".gnb_sub").show():r.siblings(".gnb_sub").slideToggle("fast",function(){}),this.saveCookie(!0)},openFolded:function(t){e(".btn_fold").toggle(),e(".admin_side_new").toggleClass("folded")},addEventListener:function(){self=this,e("body").on("favorite.menu.updated",e.proxy(this.refreshFavorite,this)),e("body").on("recently.menu.updated",e.proxy(this.refreshRecently,this))},refreshFavorite:function(){this.favoriteMenus.fetch({async:!1}),this.favoritMenuView.update(this.favoriteMenus),this.refreshSelectedMenu()},refreshRecently:function(){this.recentlyMenus.fetch({async:!1}),this.recentlyMenuView.update(this.recentlyMenus),this.refreshSelectedMenu()},isNotFold:function(e){if(!this.notFoldeds)return!1;for(var t=0;t<this.notFoldeds.length;t++)if(this.notFoldeds[t]===e)return!0;return!1},tpl:function(e){if(!e.accessible||!e.view)return"";var t="root_"+e.getMenuKey(),n=this.isNotFold(t),r=e.depth===0?'<div class="gnb_memu gnb_menu_manage"':"<li";e.depth===0&&e.maxDepth<2&&(r='<div class="gnb_memu"'),r+=' name="'+e.getMenuKey()+'" id="'+t+'"> ',r+='<a class="'+(e.depth===0?"gnb_tit folded":"tit folded")+'"'+">",r=r.replace(" folded",n?"":" folded"),r+=this.accordionTp(e),r+='<span class="txt">'+e.labelKey+"</span>",r+="</a>";if(e.childs.length>0){r+='<ul class="gnb_sub" style="display:none;">'.replace("none",n?"block":"none");for(var i=0;i<e.childs.length;i++)r+=this.tpl(e.childs[i]);r+="</ul>"}return e.keyword&&e.keyword.length>0&&(r=r.replace("folded",""),r=r.replace('style="display:none;"',"")),r+=e.depth===0?"</div>":"</li>",r},accordionTp:function(e){return e.childs.length<1?"":e.depth===0?'<span class="ic_adm ic_accordion"></span>':'<span class="ic_adm ic_accordion_s"></span>'},addNotFoldeds:function(t){if(!e(t).hasClass("folded")){var n=e(t).parent().attr("id"),r=e(t).parent().attr("name");if(r){var i=this.sideMenuCollection.findMenu(r);if(i.depth===i.maxDepth)return}this.notFoldeds[this.notFoldeds.length]=n}},saveCookie:function(e){var t=this;e&&(!this.searchKey||this.searchKey.length<1)&&(this.notFoldeds=[],_.forEach(this.$el.find(".gnb_tit"),function(e){t.addNotFoldeds(e)}),_.forEach(this.$el.find(".tit"),function(e){t.addNotFoldeds(e)})),this._saveCookie()},_getCookie:function(){var t=n.session().companyId;return e.cookie("sideMenuCookie_"+t)},_saveCookie:function(){var t={selectedId:this.selectedId,searchKey:this.searchKey,notFoldeds:this.notFoldeds},r=JSON.stringify(t),i={path:"/"},s=n.session().companyId;e.cookie("sideMenuCookie_"+s,r,i)}})});