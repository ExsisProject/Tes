define(["jquery","underscore","backbone","app","hgn!admin/templates/appr_dept_statistics","hgn!admin/templates/appr_dept_statisticsItem","hgn!approval/templates/doclist_empty","i18n!approval/nls/approval","i18n!nls/commons","i18n!admin/nls/admin","jquery.ui"],function(e,t,n,r,i,s,o,u,a,f){var l=n.Model.extend(),c=n.Collection.extend({model:l,url:function(){return this.keyword?r.contextRoot+"ad/api/approval/deptstatistics"+"?"+e.param({startAt:this.startAt,endAt:this.endAt,keyword:this.keyword,searchtype:this.searchtype}):r.contextRoot+"ad/api/approval/deptstatistics"+"?"+e.param({startAt:this.startAt,endAt:this.endAt})},fetch:function(e){typeof e!="undefined"||(e={}),this.trigger("fetching");var t=this,r=e.success;return e.success=function(e){t.trigger("fetched"),r&&r(t,e)},e.reset=!0,n.Collection.prototype.fetch.call(this,e)},setSearch:function(e,t,n,r,i){this.startAt=e,this.endAt=t,this.keyword=n,this.searchtype=r,this.docstatus=i}}),h=n.View.extend({el:"#layoutContent",columns:{"\ubd80\uc11c\uba85":u.\ubd80\uc11c\uba85,"\ubd80\uc11c\uc7a5":u.\ubd80\uc11c\uc7a5,"\uc9c4\ud589":u.\uc9c4\ud589,"\uc644\ub8cc":u.\uc644\ub8cc,"\ubc18\ub824":u.\ubc18\ub824,"\ud569\uacc4":u.\ud569\uacc4,count:6},initialize:function(){this.collection=new c,this.collection.bind("reset",this.resetList,this);var e=r.util.toISO8601(r.util.toMoment(r.util.now().format("YYYY-MM-DD")).add("days",-6)),t=r.util.toISO8601(r.util.toMoment(r.util.now().format("YYYY-MM-DD")).add("days",1).subtract("seconds",1)),n="",i="";this.collection.setSearch(e,t,n,i),this.collection.fetch({statusCode:{403:function(){r.util.error("403")},404:function(){r.util.error("404",{msgCode:"400-common"})},500:function(){r.util.error("500")}}})},delegateEvents:function(t){this.undelegateEvents(),n.View.prototype.delegateEvents.call(this,t),this.$el.on("change.statisticsDept","#selectDateOpt",e.proxy(this._changeSelectDateOpt,this)),this.$el.on("click.statisticsDept","#btn_search_statistics",e.proxy(this._search,this,!1)),this.$el.on("click.statisticsDept","#btn_search_type",e.proxy(this._search,this,!0)),this.$el.on("click.statistics","#apprStatisticsCvsDown",e.proxy(this._download,this))},undelegateEvents:function(){return n.View.prototype.undelegateEvents.call(this),this.$el.off(),this},_changeSelectDateOpt:function(e){var t=this.$el.find("#endDate");this._changeDateHandler(t.val())},_changeDateHandler:function(t){var n=this.$el.find("#startDate"),i=this.$el.find("#endDate"),s=e("#selectDateOpt > option:selected").val();switch(s){case"custom":n.datepicker("option","maxDate",t);break;case"7d":var o=r.util.toMoment(i.val()).add("days",-6).format("YYYY-MM-DD");n.val(o);break;case"30d":var o=r.util.toMoment(i.val()).add("days",-29).format("YYYY-MM-DD");n.val(o);break;case"60d":var o=r.util.toMoment(i.val()).add("days",-59).format("YYYY-MM-DD");n.val(o);break;case"6m":var o=r.util.toMoment(i.val()).add("months",-5).format("YYYY-MM-DD");n.val(o)}this._dateDisabledHandler()},_initDate:function(){var t=this;e.datepicker.setDefaults(e.datepicker.regional[r.config("locale")]);var n=this.$el.find("#startDate"),i=this.$el.find("#endDate");this.$el.find("#startDate").val(r.util.now().format("YYYY-MM-DD")),this.$el.find("#endDate").val(r.util.now().format("YYYY-MM-DD")),n.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",maxDate:i.val()}),i.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onClose:function(e){t._changeDateHandler(e)}}),e('#selectDateOpt > option[value="7d"]').attr("selected","selected").trigger("change")},_dateDisabledHandler:function(){var t=e("#selectDateOpt > option:selected").val(),n=this.$el.find("#startDate");t=="custom"?n.attr("disabled",!1):n.attr("disabled",!0)},render:function(){var e={"\ub0a0\uc9dc":u.\ub0a0\uc9dc,"\uc9c4\ud589":u.\uc9c4\ud589,"\uc644\ub8cc":u.\uc644\ub8cc,"\ubc18\ub824":u.\ubc18\ub824,"\ud569\uacc4":u.\ud569\uacc4,count:6,"\ucd5c\uadfc 24\uc2dc\uac04":f["\ucd5c\uadfc 24\uc2dc\uac04"],"\ucd5c\uadfc 7\uc77c\uac04":f["\ucd5c\uadfc 7\uc77c\uac04"],"\ucd5c\uadfc 30\uc77c\uac04":f["\ucd5c\uadfc 30\uc77c\uac04"],"\ucd5c\uadfc 60\uc77c\uac04":f["\ucd5c\uadfc 60\uc77c\uac04"],"\ucd5c\uadfc 6\uac1c\uc6d4\uac04":f["\ucd5c\uadfc 6\uac1c\uc6d4\uac04"],"\uc124\uce58 \uc774\ud6c4":f["\uc124\uce58 \uc774\ud6c4"],"\uc0ac\uc6a9\uc790 \uc9c0\uc815":f["\uc0ac\uc6a9\uc790 \uc9c0\uc815"],"\uae30\uc548\uc77c \uae30\uc900":f["\uae30\uc548\uc77c \uae30\uc900"],"\uac80\uc0c9":a["\uac80\uc0c9"],"\ubd80\uc11c\uba85":f["\ubd80\uc11c\uba85"],"\ubd80\uc11c\uc7a5":f["\ubd80\uc11c\uc7a5"],"\uae30\uac04":f["\uae30\uac04"],"\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc":f["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"]};this.$el.html(i({lang:e})),this._initDate()},resetList:function(t){var n=this.columns;e("#appr_statisticsDept_list_tb > tbody").empty(),t.length==0?e("#appr_statisticsDept_list_tb > tbody").append(o({columns:n,lang:{doclist_empty:a["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"]}})):t.each(function(t){e("#appr_statisticsDept_list_tb > tbody").append(s(t.toJSON()))})},_search:function(t){var n=r.util.toISO8601(r.util.toMoment(e("#startDate").val())),i=r.util.toISO8601(r.util.toMoment(e("#endDate").val()).add("days",1).subtract("seconds",1)),s=e("#search_keyword").val(),o=e("#select_search_type > option:selected").val();if(t){if(!s)return e.goMessage(u["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."]),e("#search_keyword").focus(),!1;if(!e.goValidation.isCheckLength(2,64,s))return e.goMessage(r.i18n(u["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"})),e("#search_keyword").focus(),!1}this.collection.setSearch(n,i,s,o),this.collection.fetch()},_download:function(){var t="ad/api/approval/deptstatistics/download?",n={startAt:r.util.toISO8601(r.util.toMoment(e("#startDate").val())),endAt:r.util.toISO8601(r.util.toMoment(e("#endDate").val()).add("days",1).subtract("seconds",1)),keyword:e("#search_keyword").val(),searchtype:e("#select_search_type > option:selected").val()};r.util.downloadCsvFile(t+r.util.jsonToUrlParam(n))},release:function(){this.$el.off(),this.$el.empty()}});return h});