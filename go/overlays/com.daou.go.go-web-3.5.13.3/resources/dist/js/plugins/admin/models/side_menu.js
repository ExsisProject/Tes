define("admin/models/side_menu",function(require){var e=require("backbone"),t=require("app"),n=require("underscore"),r=require("models/site_config"),i=require("json!admin/sidemenu.json"),s=require("json!admin/sidemenu.custom.json"),o=require("i18n!admin/nls/admin"),u=require("i18n!nls/commons"),a=require("i18n!approval/nls/approval"),f={adminLang:o,commonLang:u,approvalLang:a},l=e.Model.extend({initialize:function(e){this.menuGroup=e.menuGroup,this.menuList=i[this.menuGroup].concat(s[this.menuGroup]||[]),this.certConfig=null,this.isOtpServiceOn=!1},getAccessMenu:function(){var e=$.Deferred();return this.menuList=n.filter(this.menuList,function(e){var n=t.session().serviceAdminMode==0&&e.level.indexOf("site")>=0,r=t.session().serviceAdminMode==1&&e.level.indexOf("service")>=0;return n||r}),n.sortBy(this.menuList,"order"),n.each(this.menuList,function(e){e.name=f[e.lang][e.key]}),this.getDomainAdminAuthFilter(e),this.menuGroup=="company"?this.getComapnyFilter(e):this.menuGroup=="board"?this.getBoardFilter(e):this.menuGroup=="mobile"?this.getMobileFilter(e):this.menuGroup=="works"?this.getWorksFilter(e):this.menuGroup=="approval"?this.getApprovalFilter(e):this.menuGroup=="mail/stat"?this.getMailFilter(e):e.resolve(this.menuList),e},getDomainAdminAuthFilter:function(e){var t=this;return $.when(this.getInaccessibleMenus()).then($.proxy(function(){var r=n.filter(this.menuList,function(e){return n.contains(t.inaccssibleMenus,t.menuGroup+"."+e.leftName)?!1:!0},this);t.menuList=r,e.resolve(t.menuList)},this)),e},getInaccessibleMenus:function(){var e=this,n=$.Deferred();return $.ajax({type:"GET",url:t.contextRoot+"ad/api/domainadmin/auth/menus",async:!1,success:function(t){e.inaccssibleMenus=t.data,n.resolve()}}),n},getWorksFilter:function(e){var t=this;this.siteConfigModel=r.read({isAdmin:!0});var i=this.siteConfigModel.toJSON(),s=n.filter(this.menuList,function(e){return e.href=="works"&&i.worksService!="on"?!1:!0},this);return t.menuList=s,e.resolve(t.menuList),e},getApprovalFilter:function(e){var r=this,i=n.filter(this.menuList,function(e){return e.href=="approval/deptstatistics"&&!t.util.isUseOrgService(!0)?!1:!0},this);return r.menuList=i,e.resolve(r.menuList),e},getMailFilter:function(r){var i=new e.Model;i.url=t.contextRoot+"ad/api/company/mailservice",i.fetch({async:!1});var s=this,o=n.filter(this.menuList,function(e){return e.href=="mail/stat/pop"&&!i.get("pop")?!1:e.href=="mail/stat/imap"&&!i.get("imap")?!1:!0},this);return s.menuList=o,r.resolve(s.menuList),r},getBoardFilter:function(e){var r=this,i=n.filter(this.menuList,function(e){return e.href=="board/statistics/dept"&&!t.util.isUseOrgService(!0)?!1:!0},this);return r.menuList=i,e.resolve(r.menuList),e},getMobileFilter:function(e){var t=this;this.siteConfigModel=r.read({isAdmin:!0});var i=this.siteConfigModel.toJSON(),s=n.filter(this.menuList,function(e){return e.href=="mobile"&&i.mobileAppService!="on"?!1:!0},this);return t.menuList=s,e.resolve(t.menuList),e},getComapnyFilter:function(e){var t=this;return $.when(this._getCertConfig(),this._getOTPConfig()).then($.proxy(function(){var r=n.filter(this.menuList,function(e){return e.href=="company/cert"&&t.certConfig.str!="on"?!1:e.href=="company/otp"&&!t.isOtpServiceOn?!1:!0},this);t.menuList=r,e.resolve(t.menuList)},this)),e},_getCertConfig:function(){var e=this,n=$.Deferred();return $.ajax({type:"GET",url:t.contextRoot+"ad/api/system-certconfig",success:function(t){e.certConfig=t.data,n.resolve()}}),n},_getOTPConfig:function(){var e=this,n=$.Deferred();return $.ajax({type:"GET",url:t.contextRoot+"ad/api/company/"+t.session("companyId"),success:function(t){e.isOtpServiceOn=t.data.config["otpService"]=="on",n.resolve()}}),n}});return l});