(function(){define(["backbone","app","views/circle","admin/libs/recurrence_parser","i18n!nls/commons","i18n!admin/nls/admin","i18n!calendar/nls/calendar","hgn!admin/templates/notice/form","admin/models/notice","file_upload","attach_file","GO.util","jquery.go-validation","go-webeditor/jquery.go-webeditor","go-notice","jquery.go-preloader","jquery.go-sdk","jquery.jstree","jquery.go-popup","jquery.go-orgslide"],function(e,t,n,r,i,s,o,u,a,f,l){function p(e){var t={};return $.each(e.split(";"),function(){var e="";value="",$.each(this.split("="),function(t,n){t==0?e=n:value=n}),t[e]=value}),t}function d(){var e=this.$el.find("input:radio[name='popup_size']:checked"),n=this.$el.find("input:radio[name='popup_device']:checked"),r=this.$el.find("#targetAll").is(":checked"),i=e.val().split("|")[0],s=e.val().split("|")[1],o=n.val()=="all"||n.val()=="web",u=n.val()=="all"||n.val()=="mobile",a=this.$el.find("#startDate").val()+" 00:00",f=this.$el.find("#endDate").val()+" 23:59",l=this.$el.find("#state").is(":checked")?"NORMAL":"HIDDEN",c=r?null:this.targetView.getData(),h=$("#recurrence_label").attr("data-recurrence")?$("#recurrence_label").attr("data-recurrence"):null;this.model.set({title:this.$el.find("#title").val(),content:t.Editor.getInstance("notice_editor").getContent(),startTime:a,endTime:f,option:this.$el.find("input:radio[name='option']:checked").val(),width:i,height:s,showWeb:o,showMobile:u,attaches:v.call(this),targetAll:r,target:c,state:l,recurrence:h})}function v(){var e=[];return $.each(this.$el.find("#attaches li"),function(t,n){var r=$(n);e.push({id:r.attr("data-id"),name:r.attr("data-name"),path:r.attr("data-path"),hostId:r.attr("host-id"),extention:r.attr("data-name").split(".")[r.attr("data-name").split(".").length-1],size:r.attr("data-file-size"),downloadUrl:"#"})}),e}function m(){var e=$("#recurrence_label").attr("data-recurrence");return!!$("#scope").is(":checked")||e!=""&&e!=undefined?$.goValidation.isCheckLength(0,64,this.model.get("title"))?(this.$el.find("#name_validation").hide(),!0):(this.$el.find("#name_validation").show(),this.$el.find("#title").focus(),!1):($.goMessage(i["\ubc18\ubcf5 \uae30\uac04\uc744 \uc124\uc815\ud574 \uc8fc\uc138\uc694."]),!1)}function g(){this.model.get("attaches")&&$.each(this.model.get("attaches"),function(){this.file_icon=t.util.getFileIconStyle({extention:this.extention}),this.sizeByKb=t.util.getHumanizedFileSize(this.size)}),this.$el.html(u({lang:c,data:$.extend({},this.model.toJSON(),{dayTerm:this._getDay(),dateTerm:this._getTermData(1,31),weekTerm:this._getWeek(1,5),monthTerm:this._getTermData(1,12),hasRecurrence:this.model.hasRecurrence(),hasByMonthDay:this.model.hasByMonthDay(),hasByDay:this.model.hasByDay(),isShowAll:this.model.isShowAll(),isShowWeb:this.model.isShowWeb(),isShowMobile:this.model.isShowMobile(),isNormalState:this.model.isNormalState(),isSize400_600:this.model.isSize400_600(),isSize520_600:this.model.isSize520_600(),isSize800_600:this.model.isSize800_600(),isAlwaysMode:this.model.isAlwaysMode(),isDayMode:this.model.isDayMode(),isWeekMode:this.model.isWeekMode(),isNoneMode:this.model.isNoneMode(),convertedStartTime:this.model.getConvertStartTime(),convertedEndTime:this.model.getConvertEndTime(),files:this.model.get("attaches")})}));var e=this.model.get("recurrence"),i="";e!=undefined&&e!=""&&(this.recrurrenceHelper=new r,i=this.recrurrenceHelper.parse(e).humanize(),this._renderRecurrence(e)),$("#recurrence_label").attr("data-recurrence",e),$("#recurrence_label").text(o["\ubc18\ubcf5"]+": "+i);var s=["user","position","grade","usergroup"];t.util.isUseOrgService(!0)&&(s=["user","department","position","grade","duty","usergroup"]),this.targetView=new n({selector:"#target",isAdmin:!0,isWriter:!0,circleJSON:this.model.get("target"),nodeTypes:s}),this.targetView.render(),this.model.get("targetAll")?this.targetView.hide():this.targetView.show()}function y(){var e=$("#startDate"),n=$("#endDate");$.datepicker.setDefaults($.datepicker.regional[t.config("locale")]),e.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",minDate:t.util.customDate(new Date,"YYYY-MM-DD"),onSelect:function(e){n.datepicker("option","minDate",e)}}),n.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",minDate:this.model.getConvertStartTime()})}function b(e,n,r){var i=this.isCreate?"":this.model.get("content");i=t.util.escapeEditorContent(i),$("#notice_editor").goWebEditor({contextRoot:t.config("contextRoot"),lang:t.session("locale"),editorValue:i})}function w(){var e=this,n={el:"#file-control",context_root:t.contextRoot,button_text:"<span class='buttonText'>"+c.attach_file+"</span>",button_width:100,button_height:22,url:"ad/api/file?GOAdminSSOcookie="+$.cookie("GOAdminSSOcookie")};(new f(n)).queue(function(e,t){}).start(function(e,t){}).progress(function(e,t){}).success(function(n,r,i){var s=t.util.isImage(r.data.fileExt),o=e.$el.find("#attaches"),u=o.find("ul.file_wrap"),a=r.data,f=a.fileName,l=a.filePath,h=a.hostId,p=t.util.getHumanizedFileSize(a.fileSize),d=t.util.getFileIconStyle({extention:a.fileExt}),v="";v="<li class='item_file' data-name='"+f+"' data-file-size='"+a.fileSize+"' data-path='"+l+"' host-id='"+h+"'>"+"<span class='item_file'>"+"<span class='ic_file "+d+"'></span>"+"<span class='name'>"+f+"</span>"+"<span class='size'>("+p+")</span>"+"<span class='btn_wrap' title='"+c.remove+"'>"+"<span class='ic_classic ic_del'></span>"+"</span>"+"</span>"+"</li>",$fileTmpl=$(v),$fileTmpl.find("span.ic_del").on("click",function(){var e=$(this).parents("div#commentAttachPart");$(this).parents("li[data-name]").remove();var t=e.find("li").length;t||e.removeClass("option_display")}),u.append($fileTmpl)}).complete(function(e,t){}).error(function(e,t){})}var c={notice_config:s["\ud31d\uc5c5 \uacf5\uc9c0 \uc124\uc815"],notice_detail_config:s["\ud31d\uc5c5 \uacf5\uc9c0 \uc0c1\uc138 \uc124\uc815"],notice_name:s["\uacf5\uc9c0 \uc81c\ubaa9"],limit_char:t.i18n(s["0\uc790\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:64}),content:s["\uacf5\uc9c0 \ub0b4\uc6a9"],term:s["\uacf5\uc9c0 \uae30\uac04"],size:s["\ud31d\uc5c5 \uc0ac\uc774\uc988"],preview:s["\uc124\uc815\ud55c \uacf5\uc9c0 \ubbf8\ub9ac\ubcf4\uae30"],options:s["\uc635\uc158"],option_1:s["\ub85c\uadf8\uc778 \ud560 \ub54c\ub9c8\ub2e4 \uc0ac\uc6a9\uc790\uc5d0\uac8c \ubcf4\uc5ec\uc8fc\uae30"],option_2:s["\uc0ac\uc6a9\uc790\uc5d0\uac8c '\ud558\ub8e8\ub3d9\uc548 \uc774 \ucc3d\uc744 \uc5f4\uc9c0 \uc54a\uc74c' \uae30\ub2a5 \uc81c\uacf5"],option_3:s["\uc0ac\uc6a9\uc790\uc5d0\uac8c '1\uc8fc\uc77c \ub3d9\uc548 \uc774 \ucc3d\uc744 \uc5f4\uc9c0 \uc54a\uc74c' \uae30\ub2a5 \uc81c\uacf5"],option_4:s["\uc0ac\uc6a9\uc790\uc5d0\uac8c '\ub354\uc774\uc0c1 \uc5f4\uc9c0 \uc54a\uc74c' \uae30\ub2a5 \uc81c\uacf5"],save:i["\uc800\uc7a5"],cancel:i["\ucde8\uc18c"],save_success:i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],attach_file:i["\ud30c\uc77c\ucca8\ubd80"],remove:i["\uc0ad\uc81c"],desc:s["\u203b \uc635\uc158\uc744 \uc218\uc815\ud558\ub354\ub77c\ub3c4 \uc774\ubbf8 '\uc5f4\uc9c0 \uc54a\uc74c'\uc744 \uccb4\ud06c\ud55c \uc0ac\uc6a9\uc790\ub294 \uc218\uc815\uc0ac\ud56d\uc774 \ubc18\uc601\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],target:s["\uacf5\uc9c0 \ub300\uc0c1"],targetAll:s["\uc804\uccb4 \uc0ac\uc6a9\uc790"],state:s["\uc0ac\uc6a9\uc5ec\ubd80"],normal:s["\uc0ac\uc6a9"],every_month:o["\ub9e4\uc6d4"],every_week:o["\ub9e4\uc8fc"],last_week:o["\ub9c8\uc9c0\ub9c9 \uc8fc"],last_day:o["\ub9c8\uc9c0\ub9c9 \uc77c"],recur:o["\ubc18\ubcf5"],scope:o["\ud2b9\uc815\uae30\uac04"],usedesc:s["\ud31d\uc5c5\uacf5\uc9c0\uc0ac\uc6a9\uc5ec\ubd80"],specdays:o["\ud2b9\uc815\uc694\uc77c"],specweek:o["\ud2b9\uc815 \uc8fc"],day:o["\ub0a0"],specday:o["\ud2b9\uc815 \uc77c"],month:o["\ub2ec"],recurmonth:o["\ubc18\ubcf5 \uc6d4"],weekly:o["\ub9e4 \uc8fc \ubc18\ubcf5"],monthly:o["\ub9e4 \uc6d4 \ubc18\ubcf5"],device:s["\ub514\ubc14\uc774\uc2a4"],web:s["\uc6f9"],mobile:s["\ubaa8\ubc14\uc77c"],mobile_size_desc:s["\ubaa8\ubc14\uc77c\uc740 \uae30\uae30\uc5d0 \ub9de\ucdb0\uc11c \uc0ac\uc774\uc988\uac00 \uc790\ub3d9 \uc9c0\uc815\ub429\ub2c8\ub2e4."],mobile_option_1_desc:s["\ub85c\uadf8\uc778 \ud560 \ub54c\ub9c8\ub2e4 \uc0ac\uc6a9\uc790\uc5d0\uac8c \ubcf4\uc5ec\uc8fc\uae30 \ubaa8\ubc14\uc77c \uc548\ub0b4"]},h=e.View.extend({el:"#layoutContent",events:{"click #preview":"preview","click #save":"save","click #cancel":"cancel","click #attaches span.ic_del":"removeAttach","click #targetAll":"changeTarget","click input[name='term']":"changeTerm","click input[name='month']":"changeMonthOrWeek","click input[name='week']":"changeMonthOrWeek","click input[id*='_all']":"selectAll","change #startDay":"changeDay","change select[data-tag=repeatSelect]":"changeRecurrence","change input[data-tag=repeatSelect]":"changeRecurrence"},initialize:function(){this.$el.off(),this.isCreate=this.options.noticeId==undefined?!0:!1,this.model=new a,this.isCreate?this.model.setInitData():(this.model.set({id:this.options.noticeId}),this.model.fetch({async:!1}))},render:function(){g.call(this),b.call(this),y.call(this),w.call(this)},save:function(){if(!t.Editor.getInstance("notice_editor").validate())return $.goError(commonLang["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=$.goPreloader();e.render(),d.call(this);if(!m.call(this))return e.release(),!1;this.model.save(null,{success:function(){e.release();var n="company/notice";$.goMessage(c.save_success),t.router.navigate(n,{trigger:!0})},error:function(t,n){e.release(),n.message?$.goAlert(n.message):$.goMessage(i["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}})},changeRecurrence:function(e){var t="";if($("#monthly_radio").is(":checked")){var n=[],i=[],s=$("#startDay option:selected").val(),u=$("#endDay option:selected").val();_.each($("input[name=month]:checked"),function(e){n.push(e.getAttribute("value"))}),n=$.grep(n,function(e){return e!="all"}),i=this._makeMonthDays(s,u==-1?31:u,u==-1?!0:!1),n.length>0&&i.length>0?t=this._setICalFormat({FREQ:"YEARLY",BYMONTH:n.join(","),BYMONTHDAY:i.join(",")}):t=""}else if($("#weekly").is(":checked")){var n=[],a=[],f=[],l=[];_.each($("input[name=month]:checked"),function(e){n.push(e.getAttribute("value"))}),n=$.grep(n,function(e){return e!="all"}),_.each($("input[name=week]:checked"),function(e){a.push(e.getAttribute("value"))}),a=$.grep(a,function(e){return e!="all"}),_.each($("input[name=day]:checked"),function(e){f.push(e.getAttribute("value"))}),_.each(a,function(e){_.each(f,function(t){l.push(e+t)})}),!$.isEmptyObject(n)&&!$.isEmptyObject(l)?t=this._setICalFormat({FREQ:"YEARLY",BYMONTH:n.join(","),BYDAY:l.join(",")}):t=""}var c="";t!=undefined&&t!=""&&(this.recrurrenceHelper=new r,c=this.recrurrenceHelper.parse(t).humanize()),$("#recurrence_label").attr("data-recurrence",t),$("#recurrence_label").text(o["\ubc18\ubcf5"]+": "+c)},changeTarget:function(e){var t=$(e.currentTarget);t.is(":checked")?$("#target").hide():$("#target").show()},changeTerm:function(e){var t=$(e.currentTarget),n=t.val();$("[id*='_select']").hide(),n!="scope"?($("div#monthly").show(),$("#reccurrenceDetail").show()):($("div#monthly").hide(),$("#reccurrenceDetail").hide()),$("#"+n+"_select*").show()},changeMonthOrWeek:function(e){var t=$(e.currentTarget),n=t.attr("name"),r=t.attr("id");n=="month"&&!$(e.currentTarget).is(":checked")&&r!="month_all"&&$("#month_all").attr("checked",!1),n=="week"&&!$(e.currentTarget).is(":checked")&&r!="week_all"&&$("#week_all").attr("checked",!1)},selectAll:function(e){var t=$(e.currentTarget),n=t.is(":checked");$("input[name='"+t.attr("name")+"']").attr("checked",n)},changeDay:function(e){var t=$(e.currentTarget),n=t.attr("id"),r=t.val();(parseInt(r)>parseInt($("#endDay option:selected").val())||r==-1)&&$("#endDay option:selected").val()!=-1&&$("#endDay").val(r);var i=$("#"+n+" option:selected").prevAll();$("#endDay").children().attr("disabled",!1),_.each(i,function(e){$("#endDay option[value="+e.value+"]").attr("disabled",!0)})},preview:function(){var e=this.$el.find("input:radio[name='popup_size']:checked"),n=e.val().split("|")[0],r=e.val().split("|")[1],i=t.Editor.getInstance("notice_editor").getContent();$.go(t.contextRoot+"ad/api/notice/contentpreview",JSON.stringify({content:i}),{qryType:"POST",contentType:"application/json",responseFn:function(e){o(e.data)}});var s=this,o=function(e){$.goNotice.makePreviewItem({content:e,modal:!0,title:s.$el.find("#title").val(),width:n,height:r,option:s.$el.find("input:radio[name='option']:checked").val(),attaches:v.call(s)}).css({left:"30%",top:"20%"})}},cancel:function(){var e="company/notice";t.router.navigate(e,{trigger:!0})},removeAttach:function(e){var t=$(e.currentTarget),n=t.parents("li:first");n.remove()},_getDay:function(){return[{text:o["\uc77c"],value:"SU"},{text:o["\uc6d4"],value:"MO"},{text:o["\ud654"],value:"TU"},{text:o["\uc218"],value:"WE"},{text:o["\ubaa9"],value:"TH"},{text:o["\uae08"],value:"FR"},{text:o["\ud1a0"],value:"SA"}]},_getWeek:function(){return[{text:o["\uccab\uc9f8\uc8fc"],value:"1"},{text:o["\ub458\uc9f8\uc8fc"],value:"2"},{text:o["\uc14b\uc9f8\uc8fc"],value:"3"},{text:o["\ub137\uc9f8\uc8fc"],value:"4"},{text:o["\ub2e4\uc12f\uc9f8\uc8fc"],value:"5"}]},_getTermData:function(e,t){var n=[];for(var r=e;r<=t;r++)n.push({value:r});return n},_makeMonthDays:function(e,t,n){var r=[];for(var i=parseInt(e);i<=parseInt(t);i++)r.push(i);return n&&r.push(-1),_.filter(r,this._onlyUnique)},_onlyUnique:function(e,t,n){return n.indexOf(e)===t},_setICalFormat:function(e){var t=[];return $.each(e,function(e,n){$.trim(n)!=""&&t.push(e+"="+n)}),t.join(";")},_renderRecurrence:function(e){var t=p(e),n=t.BYMONTH.split(",");n.length==12?$("input[name='month']").attr("checked",!0):_.each(n,function(e){$("input[name='month'][value='"+e+"']").attr("checked",!0)});if($("input[name='term']:checked").attr("id")=="monthly_radio"){var r=t.BYMONTHDAY.split(","),i=r.shift(),s=r.pop();$("#startDay").val(i),$("#endDay").val(s)}else if($("input[name='term']:checked").attr("id")=="weekly"){var o=t.BYDAY.split(",");_.each(o,function(e){var t=e.replace(/[^-1-9]/g,""),n=e.replace(t,"");$("input[name='week'][value='"+t+"']").attr("checked",!0),$("input[name='day'][value='"+n+"']").attr("checked",!0)}),$("input[name=week]:checked").length==6&&$("input[name=week]").attr("checked",!0)}}},{render:function(e){var t=new h(e);return t.render(),t}});return h})})();