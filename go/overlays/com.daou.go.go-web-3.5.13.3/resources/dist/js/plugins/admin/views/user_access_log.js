define("admin/views/user_access_log",function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("hgn!admin/templates/user_access_log"),i=require("hgn!admin/templates/list_empty"),s=require("i18n!nls/commons"),o=require("i18n!admin/nls/admin");require("jquery.go-grid"),require("GO.util");var u={download:o["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],limit_message:o["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc \uae30\uac04 \uc81c\ud55c"],required_date_message:o["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc \ud544\uc218\uac12 \uc785\ub825 \uc694\uccad"],search_total_result:o["0\uac1c\uc758 \ub370\uc774\ud130\uac00 \uac80\uc0c9\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],search_duration:o["\uae30\uac04"],recent_7d:o["\ucd5c\uadfc 7\uc77c\uac04"],recent_15d:o["\ucd5c\uadfc 15\uc77c\uac04"],recent_30d:o["\ucd5c\uadfc 30\uc77c\uac04"],date_input:o["\uc9c1\uc811\uc785\ub825"],name:s["\uc774\ub984"],email:s["\uc774\uba54\uc77c"],dept:o["\ubd80\uc11c"],login_event_type:o["\uc0c1\ud0dc"],site_type:o["\uc720\ud615"],ip:o.IP,device:o["\ub514\ubc14\uc774\uc2a4"],browser:o["\ube0c\ub77c\uc6b0\uc800"],os:o["\uc6b4\uc601\uccb4\uc81c"],time:s["\uc2dc\uac04"],search:s["\uac80\uc0c9"],reset:o["\ucd08\uae30\ud654"],detail_search:s["\uc0c1\uc138\uac80\uc0c9"],simple_search:s["\uae30\ubcf8 \uac80\uc0c9"],open:s["\uc5f4\uae30"],close:s["\ub2eb\uae30"]},a=t.View.extend({el:"#layoutContent",events:{"click #searchBtn":"_renderUserAccessLogList","change #selectDateOpt":"_changeSelectDateOpt","click #userAccessLogCvsDownload":"_downloadCsv","click #detailSearch":"_showDetail","click #simpleSearch":"_showSimple","click #reset":"_reset"},initialize:function(){this.listEl="#userAccessLogList",this.dataTable=null,this.loginEventTypes=this._getListOfType("loginevent"),this.accuracyTypes=this._getListOfType("accuracy"),this.clientTypes=this._getListOfType("client"),this.siteTypes=[{name:"ADMIN"},{name:"USER"}]},_getListOfType:function(t){var r=[];return e.ajax({type:"GET",async:!1,url:n.contextRoot+"ad/api/useraccesslog/types/"+t,success:function(e){r=e.data}}),r},render:function(){var e=this;this.$el.empty(),this.$el.html(r({lang:u,accuracyTypes:e.accuracyTypes,loginEventTypes:e.loginEventTypes,clientTypes:e.clientTypes,siteTypes:e.siteTypes})),this.$searchArea=this.$el.find("#simpleSearchArea"),this._initDate(),this._initAccuracy(),this._renderUserAccessLogList()},_renderUserAccessLogList:function(){function t(e,t){var t=_.isUndefined(t)?"txt":t,n=['<span class="'+t+'">',e,"</span>"];return n.join("")}this.dataTable!=null&&this.dataTable.tables.fnDestroy();var r=this;this.dataTable=e.goGrid({el:this.listEl,method:"GET",url:n.contextRoot+"ad/api/useraccesslog/list"+r.getQueryParam(),emptyMessage:i({label_desc:s["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"]}),defaultSorting:[[0,"desc"]],sDomType:"admin",params:{page:this.page},displayLength:n.session("adminPageBase"),pageUse:!0,columns:[{mData:"createdAt",bSortable:!0,fnRender:function(e){return t(n.util.basicDate(e.aData.createdAt))}},{mData:"user",sWidth:"200px",bSortable:!0,fnRender:function(e){return e.aData.user.name?t(e.aData.user.name)+t("("+e.aData.user.email+")","txt2"):t(e.aData.loginId)}},{mData:function(e){var n=e.deptName?e.deptName:"-";return t(n)},sWidth:"150px",bSortable:!1},{mData:"loginEventType",bSortable:!0,fnRender:function(e){var n=e.aData.securityRiskLevel=="NORMAL"?"normal":"abnormal";return t(e.aData.loginEventMessage,"label_state "+n)}},{mData:"siteType",bSortable:!0,fnRender:function(e){return t(e.aData.siteType)}},{mData:"ip",sWidth:"200px",bSortable:!1,fnRender:function(e){return t(e.aData.ip)}},{mData:"clientType",bSortable:!0,fnRender:function(e){return t(e.aData.clientType)}},{mData:"browser",bSortable:!1,fnRender:function(e){return t(e.aData.browser)}},{mData:"os",bSortable:!1,fnRender:function(e){return t(e.aData.os)}}],fnDrawCallback:function(e,t){var i=n.i18n(u.search_total_result,{arg0:t._iRecordsTotal.toLocaleString()}),s=['<div class="critical"><span>',i,"</span></div>"],o=['<div class="optional"><span class="btn_tool" id="userAccessLogCvsDownload">',u.download,"</span></div>"];r.$el.find(".toolbar_top").empty(),r.$el.find(".toolbar_top").append(s.join("")),r.$el.find(".toolbar_top").append(o.join(""))}})},getQueryParam:function(){var t={},n=this.$searchArea;return n.find(".param_check input:checkbox:checked").each(function(){var r=e(this).closest("th").attr("class"),i=n.find("td."+r+" span[class^='wrap_']");i.each(function(){var n,r;if(e(this).hasClass("wrap_txt")||e(this).hasClass("wrap_date"))n=e(this).find("input").attr("id"),r=e(this).find("input").val();else{if(!e(this).hasClass("wrap_select"))return;n=e(this).find("select").attr("id"),r=e(this).find("option:selected").val()}n.indexOf("StartDate")>=0?t.startDate=r:n.indexOf("EndDate")>=0?t.endDate=r:t[n]=r})}),t.accuracy=n.find("select#accuracy option:selected").val(),"?"+e.param(t)},_initDate:function(){e.datepicker.setDefaults(e.datepicker.regional[n.config("locale")]),this._initDatepicker("#simpleStartDate","#simpleEndDate"),this._initDatepicker("#detailStartDate","#detailEndDate"),this._getAreas().forEach(function(e){e.find("select#selectDateOpt option[value='7d']").attr("selected",!0).trigger("change")},this)},_initDatepicker:function(e,t){var r=this,i=this.$el.find(e),s=this.$el.find(t);s.val(n.util.now().format("YYYY-MM-DD")),i.val(n.util.now().add("days",-6).format("YYYY-MM-DD")),i.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",maxDate:s.val()}),s.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onClose:function(e){r._changeDateHandler(e)}})},_initAccuracy:function(){this._getAreas().forEach(function(e){e.find("select#accuracy option[value='LIKE']").attr("selected",!0)},this)},_changeDateHandler:function(e){var t=this._getStartDate(),r=this._getEndDate(),i=this.$searchArea.find("select#selectDateOpt option:selected").val();switch(i){case"custom":t.datepicker("option","maxDate",e);break;case"7d":var s=n.util.toMoment(r.val()).add("days",-6).format("YYYY-MM-DD");t.val(s);break;case"15d":var s=n.util.toMoment(r.val()).add("days",-14).format("YYYY-MM-DD");t.val(s);break;case"30d":var s=n.util.toMoment(r.val()).add("days",-29).format("YYYY-MM-DD");t.val(s)}this._dateDisabledHandler()},_dateDisabledHandler:function(){var e=this.$searchArea.find("select#selectDateOpt option:selected").val(),t=this._getStartDate();e=="custom"?t.attr("disabled",!1):t.attr("disabled",!0)},_changeSelectDateOpt:function(){var e=this._getEndDate();this._changeDateHandler(e.val())},_downloadCsv:function(){var t=this._getStartDate().val(),r=this._getEndDate().val(),i=this.$searchArea.find("#searchDurationCheck").is(":checked");if(!t||!r||!i){e.goMessage(u.required_date_message);return}if(n.util.daysDiff(t,r)>30){e.goMessage(u.limit_message);return}var s="ad/api/useraccesslog/download";n.util.downloadCsvFilePreventDuplicate(s+this.getQueryParam())},_showSimple:function(){this._toggleSearch(!1)},_showDetail:function(){this._toggleSearch(!0)},_toggleSearch:function(e){e?(this.$searchArea.hide(),this.$searchArea=this.$el.find("#detailSearchArea"),this.$searchArea.show()):(this.$searchArea.hide(),this.$searchArea=this.$el.find("#simpleSearchArea"),this.$searchArea.show(),this.$searchArea.find("#nameCheck").prop("checked",!0).hide())},_reset:function(){this.$searchArea.find("input:text").val(""),this.$searchArea.find("input:checkbox").removeAttr("checked"),this.$searchArea.find("select").prop("selectedIndex",0),this._initDate()},_getAreas:function(){return[this.$el.find("#simpleSearchArea"),this.$el.find("#detailSearchArea")]},_getStartDate:function(){var e=this.$el.find("#simpleSearchArea").is(":visible");return e?this.$el.find("#simpleStartDate"):this.$el.find("#detailStartDate")},_getEndDate:function(){var e=this.$el.find("#simpleSearchArea").is(":visible");return e?this.$el.find("#simpleEndDate"):this.$el.find("#detailEndDate")}});return a});