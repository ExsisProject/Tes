define(["i18n!nls/commons","i18n!approval/nls/approval","hgn!admin/templates/approval/appr_dept_folder_list","collections/paginated_collection","admin/views/approval/appr_dept_folder_categorize","hgn!approval/templates/select_all_layout","views/pagination","views/pagesize"],function(e,t,n,r,i,s,o,u){var a={add:t["\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958"],move:e["\uc774\ub3d9"],remove:e["\uc0ad\uc81c"],"\uc218\uc2e0":t["\uc218\uc2e0"],"\uae30\uc548\uc77c":t["\uae30\uc548\uc77c"],"\uae30\uc548\uc790":t["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc591\uc2dd":t["\uacb0\uc7ac\uc591\uc2dd"],"\uc81c\ubaa9":e["\uc81c\ubaa9"],"\ubd80\uc11c\ubb38\uc11c\ud568":t["\ubd80\uc11c\ubb38\uc11c\ud568"],"\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4":t["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],all_select_page:t["\ud604\uc7ac \ud398\uc774\uc9c0\uc5d0 \uc788\ub294 \ubaa8\ub4e0 \ubb38\uc11c\ub4e4\uc774 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],count_msg:t["\ud574\ub2f9 \ubb38\uc11c\ud568\uc758 \ubaa8\ub4e0 \ubb38\uc11c 0\uac1c\ub97c \uc120\ud0dd\uba54\uc2dc\uc9c0"],select_all:t["\ubaa8\ub4e0 \ubb38\uc11c \uc120\ud0dd"],all_select_folder:t["\ud574\ub2f9 \ubb38\uc11c\ud568\uc758 \ubaa8\ub4e0 \ubb38\uc11c\ub4e4\uc774 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],cancel_msg:t["\ud574\ub2f9 \ubb38\uc11c\ud568\uc758 \uc120\ud0dd \ucde8\uc18c\uba54\uc2dc\uc9c0"],select_cancel:t["\uc120\ud0dd \ud574\uc81c"],"\uc5f4\ub78c\uc790 \ucd94\uac00":t["\uc5f4\ub78c\uc790 \ucd94\uac00"]},f=Backbone.Model.extend({isCompleted:function(){return this.get("docStatus")=="COMPLETE"}}),l=Backbone.Model.extend({initialize:function(e){this.docId=e},url:function(){return"/ad/api/approval/manage/document/addreaders"}}),c=r.extend({model:f,url:function(){var e=GO.contextRoot+"ad/api/approval/deptfolder/",t="";return this._isPredefinedFolder()?(t=e+this.type+"/"+this.folderId,this._isReceiveFolder()&&(t+="/all")):t=e+this.folderId+"/documents",t+"?"+this._makeParam()},setAttributes:function(e){_.each(e,function(e,t){this[t]=e},this)},_makeParam:function(){return $.param({page:this.pageNo,offset:this.pageSize,property:this.property,direction:this.direction,searchtype:this.searchtype,keyword:this.keyword})},_isPredefinedFolder:function(){return this.type!="doc"},_isReceiveFolder:function(){return this.type=="receive"},categorize:function(e){var t,n="document",r="deptfolder";return e.isAllDocumentsSelect?(n="alldocuments",e.type=="move"?t={folderId:e.targetFolderId}:e.type=="add"&&(r="dept"+e.folderType+"folder",t={folderId:e.folderId,deptId:e.deptId})):(t={ids:e.documentIds},e.type=="move"&&_.extend(t,{folderId:e.targetFolderId})),$.ajax({url:GO.contextRoot+"ad/api/approval/"+r+"/"+e.folderId+"/"+n+"/"+e.type,type:"PUT",contentType:"application/json",data:JSON.stringify(t)})},addreaders:function(e){var t=new l;t.set({readers:e.readers});var n="deptfolder";return this.type!="doc"&&(n="dept"+this.type+"folder"),$.ajax({url:GO.contextRoot+"ad/api/approval/"+n+"/"+e.folderId+"/alldocuments/addreaders",type:"PUT",contentType:"application/json",data:JSON.stringify(t)})},getCompletedDocumentCount:function(){var e=0;return _.each(this.models,function(t){t.isCompleted()&&(e+=1)}),e}}),h=Backbone.View.extend({initialize:function(e){this.department=e.department,this.folderName=e.name,this.folderId=e.folderId,this.type=e.type,this.isPredefined=e.isPredefined,this.isOfficial=e.isOfficial,this.collection=new c,this.collection.setAttributes({folderId:e.folderId,type:e.type}),this.collection.on("sync",this.render,this),GO.util.preloader(this.collection.fetch())},events:{"click #addCategory":"_categorize","click #moveCategory":"_categorize","click #removeCategory":"_categorize","click #checkAll":"_checkAll","change #documentList input":"_toggleCheckAll","click th[data-property]":"_sorting","click p#allSelectMsg3":"toggleSelectScope","click #bulkReaderAdd":"_onReaderAddClicked"},render:function(){var e=n({name:this.folderName,isPredefined:this.isPredefined,isOfficial:this.isOfficial,collection:this._parseCollection(),lang:a,isReceive:this.type=="receive"});return this.$el.html(e),this._renderSelectAllTpl(),this._renderPageSizeView(),this._renderPageView(),this._markHeader(),this},_parseCollection:function(){var e=_.clone(this.collection);return _.map(e.models,function(e){var t={shortDraftedAt:GO.util.shortDate(e.get("draftedAt")),isCompleted:e.isCompleted()};return _.extend(t,e.toJSON())})},_renderPageSizeView:function(){this.pageSizeView=new u({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this._selectPageSize,this)},_renderPageView:function(){this.pageView&&this.pageView.remove(),this.pageView=new o({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this._selectPage,this),this.$("#paginateArea").append(this.pageView.render().el)},_selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},_selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},_categorize:function(n){var r=this,s=$(n.currentTarget).attr("data-categorizeType"),o=this._getCheckedDocumentIds();if(!o.length){$.goError(t["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var u=$(n.target).parent().parent().next(),f=u.find("#allSelectTr").is(":visible")&&u.find("#allSelectMsg3").attr("data-value")=="folder";if(s=="remove"){var l={type:s,folderId:r.folderId,documentIds:o,isAllDocumentsSelect:f,deptId:r.folderId};$.goConfirm(t["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",function(){GO.util.preloader(r.collection.categorize(l).done(function(){$.goMessage(t["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),r.$el.find("#checkedAllCompanyDoc").attr("checked",!1),r.collection.fetch()}).fail(function(){$.goError(e["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}))})}else{this.popup=$.goPopup({pclass:"layer_normal layer_doc_type_select",header:a[s],modal:!0,width:300,contents:"",buttons:[{btext:e["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(n){var i=c.getSelectedFolderEl();if(!i.length)return $.goError(t["\uc774\ub3d9\ud558\uc2e4 \ubb38\uc11c\ud568\uc744 \uc120\ud0dd\ud574\uc8fc\uc2ed\uc2dc\uc694."]),!1;var o=$(i).attr("data-folderId");if(!o)return $.goError(t["\uc774\ub3d9\ud558\uc2e4 \ubb38\uc11c\ud568\uc744 \uc120\ud0dd\ud574\uc8fc\uc2ed\uc2dc\uc694."]),!1;var u=r._getCheckedDocumentIds(),a={type:s,documentIds:u,targetFolderId:o,isAllDocumentsSelect:f,deptId:r.folderId};s=="move"?(a.targetFolderId=o,a.folderId=r.folderId):(a.folderId=o,a.folderType=r.collection.type);var l=r.collection.categorize(a).done(function(){r.popup.close(),r.collection.fetch(),r.$("#checkAll").prop("checked",!1)}).fail(function(){$.goError(e["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])});GO.util.preloader(l)}},{btext:e["\ucde8\uc18c"],btype:"cancel"}]});var c=new i({department:this.department});this.popup.find("div.content").html(c.render().el)}},_onReaderAddClicked:function(e){var n=this,r=this._getCheckedDocumentIds();if(!r.length){$.goError(t["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var i=$(e.target).parent().parent().next(),s=i.find("#allSelectTr").is(":visible")&&i.find("#allSelectMsg3").attr("data-value")=="folder";s&&(r=[]),this._showReaderAddOrgSlide(r)},_showReaderAddOrgSlide:function(n){$.goOrgSlide({header:t["\uc5f4\ub78c\uc790 \ucd94\uac00"],contextRoot:GO.config("contextRoot"),callback:$.proxy(this._addReaders,this,n),memberTypeLabel:t["\uc5f4\ub78c\uc790"],externalLang:e,isBatchAdd:!0,useTag:!0,isAdmin:!0,type:"node"})},_addReaders:function(n,r){var i=this,s=_.map(r,function(e){return{reader:e}}),o=new l;if(!_.isEmpty(n)){if(_.isEmpty(s)){$.goError(t["\uc5f4\ub78c\uc790\ub97c \ucd94\uac00\ud574 \uc8fc\uc138\uc694."]);return}o.set({docIds:n,readers:s}),o.save(null,{type:"POST",success:function(e,n){n.code=="200"&&($(".list_approval input[type=checkbox][data-id]").prop("checked",!1),$.goMessage(t["\uc5f4\ub78c\uc790 \ucd94\uac00\uac00 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]))},error:function(t,n){$.goMessage(e["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})}else{var o=new l;if(_.isEmpty(s)){$.goError(t["\uc5f4\ub78c\uc790\ub97c \ucd94\uac00\ud574 \uc8fc\uc138\uc694."]);return}o.set({readers:s});var u={folderId:i.folderId,deptId:i.folderId,folderType:i.collection.type,readers:s},a=i.collection.addreaders(u).done(function(){$.goMessage(t["\uc5f4\ub78c\uc790 \ucd94\uac00\uac00 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),i.collection.fetch(),i.$("#checkAll").prop("checked",!1)}).fail(function(){$.goError(e["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])});GO.util.preloader(a)}},_checkAll:function(e){var t=this.$("#checkAll").is(":checked");this.$("#documentList").find("input").attr("checked",t),this._toggleSelectAllTpl(t)},_toggleCheckAll:function(){var e=!0;_.each(this.$("#documentList").find("input"),function(t){$(t).is(":checked")||(e=!1)}),this.$("#checkAll").attr("checked",e),this._toggleSelectAllTpl(e)},_renderSelectAllTpl:function(){$(".tb_admin > tbody").prepend(s({columnCount:this.isPredefined?6:5,lang:a,totalCount:GO.i18n(a.count_msg,{totalCount:this.collection.type=="receive"?this.completeDocumentCount():this.collection.total})}))},_toggleSelectAllTpl:function(e){var t=this.collection.total>this.collection.pageSize||this.collection.total>this.collection.getCompletedDocumentCount();e&&t?$("#allSelectTr").show():($("#allSelectTr").hide(),this.toggleSelectAllMsg("folder"))},toggleSelectScope:function(e){var t=$(e.target).parent(),n=t.attr("data-value");if(_.isUndefined(n))return;this.toggleSelectAllMsg(n)},toggleSelectAllMsg:function(e){var t=$("#allSelectMsg1").empty(),n=$("#allSelectMsg2").empty(),r=$("#allSelectMsg3").find("a").empty();e=="page"?($("#allSelectMsg3").attr("data-value","folder"),t.append(a.all_select_folder),n.append(a.cancel_msg),r.append(a.select_cancel)):e=="folder"&&($("#allSelectMsg3").attr("data-value","page"),t.append(a.all_select_page),n.append(GO.i18n(a.count_msg,{totalCount:this.collection.type=="receive"?this.completeDocumentCount():this.collection.total})),r.append(a.select_all))},completeDocumentCount:function(){var e;return $.ajax({type:"GET",async:!1,dataType:"json",url:GO.contextRoot+"ad/api/approval/deptfolder/"+this.folderId+"/reception/complete/count",success:function(t){e=t.data.docCount},error:function(e){$.goError(e.responseJSON.message)}}),e},_getCheckedDocumentIds:function(){return _.map(this.$("#documentList").find("input:checked"),function(e){return $(e).attr("data-docid")})},_sorting:function(e){var t=$(e.currentTarget),n=t.attr("data-property"),r=t.attr("data-direction")=="asc"?"desc":"asc";t.attr("data-direction",r),this.collection.property=n,this.collection.direction=r,this.collection.fetch()},_markHeader:function(){var e=this.$("th[data-property='"+this.collection.property+"']");e.attr("data-direction",this.collection.direction),e.removeClass(),e.addClass("sorting_"+this.collection.direction)}});return h});