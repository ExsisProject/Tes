(function(){define(["backbone","i18n!nls/commons","i18n!admin/nls/admin","i18n!task/nls/task","hgn!admin/templates/task_type","admin/views/task/task_state_item","admin/views/task/task_flow_item","admin/collections/task_states","admin/collections/task_flows","admin/models/task_state","admin/models/task_flow","admin/models/task_type","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h={task:r["\uc5c5\ubb34"],DUEDATE:r["\uae30\ud55c"],ASSIGNEE:r["\ub2f4\ub2f9\uc790"],ETC:r["\ub098\uba38\uc9c0 \ud56d\ubaa9"],REGISTRANT:r["\ub4f1\ub85d\uc790"],ADMIN:r["\uc6b4\uc601\uc790"],REFERER:r["\ucc38\uc870\uc790"],APPROVER:r["\uc2b9\uc778\uc790"],typeAdministration:n["\uc5c5\ubb34 \uc720\ud615 \uad00\ub9ac"],typeName:n["\uc720\ud615\uba85"],typeDescription:n["\uc720\ud615 \uc124\uba85"],status:n["\uc0c1\ud0dc"],add:t["\ucd94\uac00"],letter:r["\uc790"],statusName:n["\uc0c1\ud0dc\uba85"],completionStatus:n["\uc644\ub8cc \uc0c1\ud0dc"],destroy:t["\uc0ad\uc81c"],workFlow:n["\uc0c1\ud0dc\ud750\ub984"],startStatus:n["\uc2dc\uc791 \uc0c1\ud0dc"],nextStatus:n["\ub2e4\uc74c \uc0c1\ud0dc"],statusModifierButton:n["\uc0c1\ud0dc\ubcc0\uacbd\ubc84\ud2bc"],statusModifiers:n["\uc0c1\ud0dc \ubcc0\uacbd\uc790"],notificationTarget:n["\uc0c1\ud0dc \ubcc0\uacbd \uc54c\ub9bc\ub300\uc0c1"],administration:t["\uad00\ub9ac"],modifyPermissions:n["\uc5c5\ubb34\uc218\uc815 \uad8c\ud55c"],deleteTaskPermissions:n["\uc5c5\ubb34\uc0ad\uc81c \uad8c\ud55c"],item:n["\ud56d\ubaa9"],fixPermissions:n["\uc218\uc815\uad8c\ud55c"],deletePermissions:n["\uc0ad\uc81c\uad8c\ud55c"],revisedNotificationTargets:n["\uc218\uc815 \ud6c4 \uc54c\ub9bc\ub300\uc0c1"],availability:n["\uc0ac\uc6a9\uc5ec\ubd80"],hide:n["\uc228\uae40"],normal:n["\uc815\uc0c1"],confirm:t["\uc800\uc7a5"],cancel:t["\ucde8\uc18c"],statusModifyDescription:n["\uc0c1\ud0dc \ubcc0\uacbd \uc54c\ub9bc"]},p=Hogan.compile('{{#attributes}}<tr><td class="item">{{lang}}</td><td class="right" data-value="{{attr_value}}" data-type="Privileges">{{#roles}}<span class="option_wrap"><input type="checkbox" value="{{value}}" id="{{attr_value}}_auth_{{value}}"><label for="{{attr_value}}_auth_{{value}}">{{lang}}</label></span>{{/roles}}</td><td class="noti" data-value="{{attr_value}}" data-type="Pushes">{{#roles}}<span class="option_wrap"><input type="checkbox" value="{{value}}" id="{{attr_value}}_noti_{{value}}"><label for="{{attr_value}}_noti_{{value}}">{{lang}}</label></span>{{/roles}}</td></tr>{{/attributes}}'),d=[{attr_value:"DUEDATE",lang:h.DUEDATE},{attr_value:"ASSIGNEE",lang:h.ASSIGNEE},{attr_value:"ETC",lang:h.ETC}],v=[{value:"REGISTRANT",lang:h.REGISTRANT},{value:"ASSIGNEE",lang:h.ASSIGNEE},{value:"ADMIN",lang:h.ADMIN},{value:"REFERER",lang:h.REFERER},{value:"APPROVER",lang:h.APPROVER}],m=["APPROVER","CONTENT","FIELD","NAME","PRIVATETASK","REFERER","TAG"],g=e.View.extend({events:{"click #addState":"addState","keypress #stateName":"enterEventHandler","click #stateList span.ic_delete":"deleteStateAction","click #flowList span.ic_delete":"deleteFlow","click #flowList span.ic_row_add":"addFlow","click input[type=checkbox]":"setRoles","click #submit":"submit","click #cancel":"cancel","keyup #stateName":"lengthCheck"},initialize:function(e){this.options=e,this.type=new c(e.id),this.type.id&&this.type.fetch({async:!1}),e.copy&&this.typeCopy(),this.states=new u(this.type.get("taskStatuses")),this.flows=new a(this.type.get("transitions")),this.editable=this.type.id?!1:!0,this.flows.addFirstFlow(this.states.firstFlow().get("name"),this.type.get("addPushes"))},render:function(){return this.$el.html(i({lang:h,model:this.type.toJSON(),isShow:this.type.isShow(),editable:this.editable})),this.addAllStates(),this.addAllFlows(),this.renderEditPermissionView(),this.renderDeletePrivileges(),this},typeCopy:function(){var e=this.type.get("taskStatuses"),t=this.type.get("transitions");_.each(e,function(e){e.id=null}),_.each(t,function(e){e.id=null}),this.type.id=null,this.type.set("id",null),this.type.set("appliedFolders",0),this.type.set("taskStatuses",e),this.type.set("transitions",t)},enterEventHandler:function(e){e.which==13&&this.addState()},addState:function(){var e=this.$("#stateName").val().trim();if(!$.goValidation.isCheckLength(2,10,e)){$.goError(GO.i18n(t["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"10"}),$("#stateName").siblings("br"),!1,!0),$("#stateName").focus();return}if(this.states.findWhere({name:e})){$.goError(GO.i18n(t["\uc774\ubbf8 \ucd94\uac00\ub418\uc5b4 \uc788\uc2b5\ub2c8\ub2e4."]),$("#stateName").siblings("br"),!1,!0),$("#stateName").focus();return}var n=new f({name:e});this.$("#stateName").val(""),this.states.add(n),this.StateAddOne(n),GO.EventEmitter.trigger("task","change:states",this.states)},deleteStateAction:function(e){var t=this,r=$(e.currentTarget).parents("tr[data-type=state]"),i=this.states.get(r.data().instance);i.id?$.ajax({type:"GET",dataType:"json",url:GO.contextRoot+"ad/api/task/type/"+t.type.id+"/status/"+i.id,success:function(e){var s=e.data.count>0?!1:!0;s?t.deleteState(i,r):t.showInvalidPopup(n["\uc0ad\uc81c\ud560 \uc0c1\ud0dc\uac00 \uc0ac\uc6a9\uc911"])},error:function(e){$.goError(e.message)}}):this.deleteState(i,r)},showInvalidPopup:function(e){$.goPopup({title:n["\uc0ad\uc81c \ubd88\uac00"],message:e,buttons:[{btype:"confirm",btext:t["\ud655\uc778"]}]})},deleteState:function(e,t){this.states.remove(e),t.remove(),GO.EventEmitter.trigger("task","change:states",this.states)},addAllStates:function(){this.$("#stateList").find("tr").remove(),this.states.each(function(e){this.StateAddOne(e)},this)},StateAddOne:function(e){var t=new s({model:e,editable:this.editable});this.$("#stateList").append(t.render().el),t.$el.data("instance",e)},addFlow:function(e){var t=$(e.currentTarget).parents("tr[data-type=flow]"),n=t.index(),r=new l;this.flows.add(r,{at:n+1}),this.addOneFlow(r,t)},addAllFlows:function(){this.flows.each(function(e){this.addOneFlow(e)},this)},addOneFlow:function(e,t){var n=new o({collection:this.states,model:e,roles:v});t?t.after(n.render().el):this.$("#flowList").append(n.render().el),n.$el.data("instance",e)},deleteFlow:function(e){var t=$(e.currentTarget).parents("tr[data-type=flow]"),n=this.flows.get(t.data().instance);this.flows.remove(n),t.remove()},renderEditPermissionView:function(){var e=this.$("#editPermissionList");e.html(p.render({lang:h,attributes:d,roles:v}));var t=this.$("#editPermissionList").find("td[data-type=Privileges]").find("input[value=REGISTRANT]");t.last().attr("disabled",!0),this.type.id||this.options.copy?this.markRoles():this.markDefaultRole()},renderDeletePrivileges:function(){_.each(this.type.get("deletePrivileges"),function(e){this.$("#deletePrivileges").find("input[value="+e+"]").attr("checked",!0)},this)},getDeletePrivileges:function(){var e=[];return _.each(this.$("#deletePrivileges").find("input:checked"),function(t){e.push(t.value)},this),e},markRoles:function(){var e=this.$("#editPermissionList");_.each(["Privileges","Pushes"],function(t){_.each(this.type.auths(t),function(n){n.attribute=="NAME"&&(n.attribute="ETC");var r=e.find("td[data-type="+t+"][data-value="+n.attribute+"]");_.each(n.roles,function(e){r.find("input[value="+e+"]").attr("checked",!0)})})},this)},markDefaultRole:function(){var e=this.$("#editPermissionList");e.find("input[value=REGISTRANT]").attr("checked",!0),e.find("input[value=ASSIGNEE]").attr("checked",!0),e.find("input[value=ADMIN]").attr("checked",!0)},submit:function(){var e=this,t={name:this.$("#typeName").val(),description:this.$("#description").val(),approver:this.isApprover(),taskStatuses:this.getTaskStatuses(),addPushes:this.flows.firstNotiList(),editPrivileges:this.getRoles("Privileges"),editPushes:this.getRoles("Pushes"),deletePrivileges:this.getDeletePrivileges(),transitions:this.flows.transitions().toJSON(),status:this.getStatus()};if(!this.validate(t))return;this.type.set(t),this.type.save({},{success:function(e){GO.router.navigate("task/types",{trigger:!0,pushState:!0})},error:function(t,n){n.responseJSON.name=="task.failure.remove.taskstatus"?e.showInvalidPopup(n.responseJSON.message):$.goError(n.responseJSON.message)}})},validate:function(e){return $.goValidation.isCheckLength(2,30,e.name)?$.goValidation.isCheckLength(1,200,e.description)?this.states.length<1?($.goError("\uc0c1\ud0dc\ub294 1\uac1c \uc774\uc0c1",$("#stateName").siblings("br"),!1,!0),$("#stateName").focus(),!1):this.flowValidate()?!0:(this.$("select.pause").first().focus(),!1):($.goError(GO.i18n(t["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"1",arg2:"200"}),$("#description"),!1,!0),$("#description").focus(),!1):($.goError(GO.i18n(t["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"30"}),$("#typeName"),!1,!0),$("#typeName").focus(),!1)},flowValidate:function(){var e=!0;return _.each(this.$("#flowList").find("tr"),function(n){var r=$(n),i=r.find("select[data-type=before]"),s=r.find("select[data-type=next]"),o=r.find("input[type=text]");r.find(".pause").removeClass("pause"),i.length&&!i.val()&&(e=!1,i.addClass("pause")),s.val()||(e=!1,s.addClass("pause"));if(o.length){o.val()||(e=!1,o.addClass("pause"));if(o.val().length>10||o.val().length<2)$.goError(GO.i18n(t["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"10"}),o,!1,!0),e=!1,o.addClass("pause")}},this),e},getStatus:function(){return this.$("input[name=status]:checked").attr("id")},isApprover:function(){return this.$("input[value=APPROVER]:checked").length>0},getTaskStatuses:function(){var e=this.flows.at(0).get("nextStatus");if(!e)return;var t=this.states.clone(),n=t.findWhere({name:e});if(!n)return;return n.set("start",!0),t.toJSON()},getRoles:function(e){var t=[];return _.each(this.$("td[data-type="+e+"]"),function(e){var n=[];_.each($(e).find("input[type=checkbox]:checked"),function(e){n.push(e.getAttribute("value"))});var r=e.getAttribute("data-value"),i=r=="ETC"?m:[r];_.each(i,function(e){t.push({attribute:e,roles:n})})}),t},lengthCheck:function(e){var n=$(e.currentTarget),r=n.val().trim().length;$("#stateNameLength").text(r),r>10?$.goError(GO.i18n(t["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:2,arg2:10}),n.siblings("br"),!1):$(".go_error").remove()},cancel:function(){GO.router.navigate("task/types",{trigger:!0,pushState:!0})}});return g})}).call(this);