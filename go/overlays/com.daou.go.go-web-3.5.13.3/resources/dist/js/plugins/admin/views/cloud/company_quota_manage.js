define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("system/models/siteConfigModel"),i=require("hgn!admin/templates/cloud/company_quota_manage"),s=require("i18n!nls/commons"),o=require("i18n!admin/nls/admin");require("jquery.go-orgslide"),require("jquery.go-popup"),require("jquery.go-sdk"),require("jquery.go-validation");var u={label_user_setting:o["\uc0ac\uc6a9\uc790 \uc124\uc815"],label_max_user_count:o["\ucd5c\ub300 \uc0ac\uc6a9\uc790 \uc218"],label_online_user_count:o["\ud604\uc7ac \uc0ac\uc6a9\uc790 \uc218"],label_user_count:s["\uba85"],label_quota_setting:o["\uc6a9\ub7c9 \uc124\uc815"],label_available_quota:o["\ucd1d \uc6a9\ub7c9"],label_total_account_quota:o["\ucd1d \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9"],label_total_company_quota:o["\uacf5\uc6a9 \uc6a9\ub7c9"],label_send_warning:o["\uacf5\uc6a9 \uc6a9\ub7c9 \ucd08\uacfc \uacbd\uace0 \ubc1c\uc1a1"],label_warning_rate:o["\uacf5\uc6a9 \uc6a9\ub7c9 \ucd08\uacfc \uacbd\uace0 \ube44\uc728"],label_restriction:o["\uacf5\uc6a9 \uc6a9\ub7c9 \ucd08\uacfc\uc2dc \uc81c\uc7ac"],label_help_account_quota:o["\uc0ac\uc774\ud2b8 \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9 \ud234\ud301"],label_help_company_quota:o["\uc0ac\uc774\ud2b8 \uacf5\uc6a9 \uc6a9\ub7c9 \ud234\ud301"],label_help_restrict_quota:o["\uacf5\uc6a9 \uc6a9\ub7c9 \ucd08\uacfc\uc2dc \uc81c\uc7ac \ub3c4\uc6c0\ub9d0"],label_max_user_help:o["\ucd5c\ub300 \uc0ac\uc6a9\uc790 \uc218 \uc124\uba85"],label_use:s["\uc0ac\uc6a9"],label_not_use:o["\uc0ac\uc6a9 \uc548\ud568"],label_save:s["\uc800\uc7a5"],label_cancel:s["\ucde8\uc18c"],label_quota_service_desc:o["\uc6a9\ub7c9\ucd94\uac00 \uad6c\uc785\uc740 \ud604\uc7ac \uc900\ube44 \uc911\uc774\ub2c8 \ub530\ub85c \ubb38\uc758 \ubc14\ub78d\ub2c8\ub2e4"],label_company_quota_usage:o["\uacf5\uc6a9 \uc6a9\ub7c9 \uc0ac\uc6a9 \ud604\ud669"],label_used_quota:o["\ud604\uc7ac \uc0ac\uc6a9\ub7c9"],label_contact:s["\uc8fc\uc18c\ub85d"],label_works:s.Works,label_post:o["\uac8c\uc2dc\ud310/\ucee4\ubba4\ub2c8\ud2f0"],label_approval:s["\uc804\uc790\uacb0\uc7ac"],label_report:s["\ubcf4\uace0"],label_task:s["\uc5c5\ubb34"],label_webfolder:s["\uc790\ub8cc\uc2e4"],label_survey:s["\uc124\ubb38"],label_todo:s["ToDO+"],label_sms:o["\ubb38\uc790\ubc1c\uc1a1"],label_docs:s["\ubb38\uc11c\uad00\ub9ac"],label_chat:o["\uba54\uc2e0\uc800/\uc571 \ub300\ud654"],label_comment:s["\ub313\uae00"],label_etc:s["\uae30\ud0c0"],label_help_etc:o["\uae30\ud0c0 \uc6a9\ub7c9 \ud234\ud301"],label_sync:o["\ub3d9\uae30\ud654"],label_prev_sync_caution:o["\ud604\uc7ac \uacf5\uc6a9 \uc6a9\ub7c9 \uc0ac\uc6a9\ud604\ud669 \ud655\uc778\uc744 \uc704\ud574\uc11c\ub294 \ub3d9\uae30\ud654\ub97c \uba3c\uc800 \uc218\ud589\ud574\uc8fc\uc2ed\uc2dc\uc624."],label_usage_desc:o["\uc0ac\uc6a9\ub7c9 \uc815\ubcf4\ub294 \uc790\uc815 \uae30\uc900\uc73c\ub85c \uc790\ub3d9 \ub3d9\uae30\ud654 \ub418\uba70, \uc6a9\ub7c9 \uad00\ub9ac \ub3d9\uae30\ud654 \uc218\ud589\uc2dc \ud604\uc7ac\uc2dc\uc810\uc73c\ub85c \uc989\uc2dc \ub3d9\uae30\ud654 \ub429\ub2c8\ub2e4."]},a=t.Model.extend({url:function(){var e="/ad/api/company";return e}}),f=t.Model.extend({url:function(){var e="/ad/api/quotaconfig";return e}}),l=t.Model.extend({url:function(){var e="/ad/api/company/attach/usage";return e}}),r=t.Model.extend({url:function(){var e="/ad/api/siteconfig";return e}}),c=t.Model.extend({url:function(){var e="/ad/api/company/quota/sync";return e}}),h={GB:1073741824,MB:1048576,QUOTA_APPS:["contact","works","post","document","report","survey","todo","task","sms","webfolder","docs","chat","comment","all"],byteToMega:function(e){return(parseInt(e)/this.MB).toFixed(1)},byteToGiga:function(e){return parseInt(e)/this.GB},gigaToByte:function(e){return e*this.GB}},p=t.View.extend({el:"#layoutContent",events:{"click span#saveQuota":"save","click span#cancelQuota":"cancel","click input:radio":"toggleRadio","click span#btn_sync":"sync","keyup input#totalAccountQuota":"_validateNumber","keyup input#companyQuota":"_validateNumber"},initialize:function(){this.$el.off()},render:function(){this.$el.html(i({lang:u,isNotSite:!0}))},renderQuotaArea:function(){var e=this;this.$el.html(i({lang:u,isNotSite:!GO.session().serviceAdminMode,companyModel:this.model.toJSON(),companyQuotaModel:this.companyQuotaModel.toJSON(),companyAppsQuotaModel:e.convertAppsUsage(),hidePercent:function(){return e.companyQuotaModel.get("companyQuota")==0?!1:!0},usagePercent:Math.round(this.companyAppsQuotaModel.get("all")/this.companyQuotaModel.get("companyQuota")*100),appConfig:e.convertAppConfig(),availableQouta:function(){return h.byteToGiga(e.availableQuota)},allAccountQuotaGB:function(){return h.byteToGiga(this.companyQuotaModel.totalAccountQuota)},allCompanyQuotaGB:function(){return h.byteToGiga(this.companyQuotaModel.companyQuota)}})),this.toggleRadio();var t=this.companyQuotaModel.get("companyQuotaWarningRate");return this.$el.find("#companyQuotaWarningRate").attr("value",t==0?90:t),this.$el.find("#quota_content").css("display","block"),this.$el.find(".desc_caution").css("display","none"),this.$el},sync:function(){GO.EventEmitter.trigger("common","layout:setOverlay","");var t=this;this.model=new a,this.model.fetch({async:!1}),this.companyQuotaModel=new f,this.companyQuotaModel.fetch({async:!1}),this.availableQuota=this.companyQuotaModel.get("totalAccountQuota")+this.companyQuotaModel.get("companyQuota"),this.companyAppsQuotaModel=new l,this.companyAppsQuotaModel.fetch({async:!1}),this.siteConfigModel=new r,this.siteConfigModel.fetch({async:!1}),this.SyncQuotaModel=new c,this.SyncQuotaModel.save(null,{async:!1,success:function(){e.goMessage(o["\ub3d9\uae30\ud654\uc5d0 \uc131\uacf5\ud558\uc600\uc2b5\ub2c8\ub2e4."]),t.renderQuotaArea()},error:function(){e.goError(o["\ub3d9\uae30\ud654\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4. \uc7a0\uc2dc \ud6c4 \ub2e4\uc2dc \uc2dc\ub3c4\ud574\uc8fc\uc138\uc694."])}}),GO.EventEmitter.trigger("common","layout:clearOverlay",!0)},convertAppsUsage:function(){var t={},n=0;return e.each(this.companyAppsQuotaModel.toJSON(),function(r,i){e.inArray(r,h.QUOTA_APPS)>=0?t[r+"MB"]=h.byteToMega(i):n+=i}),t.etcMB=h.byteToMega(n),t},convertAppConfig:function(){var t={};return e.each(this.siteConfigModel.toJSON(),function(e,n){e.indexOf("Service")&&(t[e]=n=="on"?!0:!1)}),t.postService=this.siteConfigModel.get("boardService")=="on"||this.siteConfigModel.get("communityService")=="on"?!0:!1,t},validation:function(t){e(".go_alert").html("");var r=!0,i="",s=h.byteToGiga(t.get("totalAccountQuota")),u=h.byteToGiga(t.get("companyQuota"));if(t.get("totalAccountQuota")==0)return r=!1,this.showValidateMsg("totalAccountQuota",n.i18n(o["{{quota}}\uc740 0{{unit}}\ub85c \uc124\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],{quota:o["\ucd1d \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9"],unit:"GB"})),!1;if(!e.goValidation.isNumber(t.get("totalAccountQuota"))||!e.goValidation.isNumber(s))return r=!1,this.showValidateMsg("totalAccountQuota",n.i18n(o["{{quota}}\uc5d0 \uc22b\uc790\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694."],{quota:o["\ucd1d \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9"]})),!1;if(t.get("totalAccountQuota")<this.model.get("totalAccountQuota"))return r=!1,this.showValidateMsg("totalAccountQuota",n.i18n(o["\ud604\uc7ac \uc0ac\uc6a9\ub7c9\uc740 {{arg1}}\uc785\ub2c8\ub2e4. {{arg1}}\uc774\uc0c1\uc73c\ub85c \uc124\uc815\ud574\uc8fc\uc138\uc694."],{arg1:Math.ceil(h.byteToGiga(this.model.get("totalAccountQuota")))})),!1;if(s<2||s>102400)return r=!1,this.showValidateMsg("totalAccountQuota",n.i18n(o["{{quota}}\uc758 \uc124\uc815 \uac00\ub2a5 \ubc94\uc704\ub294 {{arg1}} ~ {{arg2}}\uae4c\uc9c0\uc785\ub2c8\ub2e4."],{quota:o["\ucd1d \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9"],arg1:2,arg2:102400})),!1;if(t.get("companyQuota")==0)return r=!1,this.showValidateMsg("companyQuota",n.i18n(o["{{quota}}\uc740 0{{unit}}\ub85c \uc124\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],{quota:o["\uacf5\uc6a9 \uc6a9\ub7c9"],unit:"GB"})),!1;if(!e.goValidation.isNumber(t.get("companyQuota"))||!e.goValidation.isNumber(u))return r=!1,this.showValidateMsg("companyQuota",n.i18n(o["{{quota}}\uc5d0 \uc22b\uc790\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694."],{quota:o["\uacf5\uc6a9 \uc6a9\ub7c9"]})),!1;if(t.get("companyQuota")<this.model.get("companyQuota"))return r=!1,this.showValidateMsg("companyQuota",n.i18n(o["\ud604\uc7ac \uc0ac\uc6a9\ub7c9\uc740 {{arg1}}\uc785\ub2c8\ub2e4. {{arg1}}\uc774\uc0c1\uc73c\ub85c \uc124\uc815\ud574\uc8fc\uc138\uc694."],{arg1:Math.ceil(h.byteToGiga(this.model.get("companyQuota")))})),!1;if(u<1||u>102400)return r=!1,this.showValidateMsg("companyQuota",n.i18n(o["{{quota}}\uc758 \uc124\uc815 \uac00\ub2a5 \ubc94\uc704\ub294 {{arg1}} ~ {{arg2}}\uae4c\uc9c0\uc785\ub2c8\ub2e4."],{quota:o["\uacf5\uc6a9 \uc6a9\ub7c9"],arg1:1,arg2:102400})),!1;if(t.get("totalAccountQuota")+t.get("companyQuota")!=this.availableQuota){r=!1,this.showValidateMsg("totalAccountQuota",n.i18n(o["\ucd1d \uc6a9\ub7c9(\ucd1d \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9 + \uacf5\uc6a9 \uc6a9\ub7c9)\uc740 {{arg1}}\uc785\ub2c8\ub2e4."],{arg1:h.byteToGiga(this.availableQuota)}));return}return e.goValidation.isNumber(t.get("companyQuotaWarningRate"))?t.get("sendWarningExceedCompanyQuota")=="true"&&t.get("companyQuotaWarningRate")<1||t.get("companyQuotaWarningRate")>99?(r=!1,this.showValidateMsg("companyQuotaWarningRate",n.i18n(o["{{quota}}\uc758 \uc124\uc815 \uac00\ub2a5 \ubc94\uc704\ub294 {{arg1}} ~ {{arg2}}\uae4c\uc9c0\uc785\ub2c8\ub2e4."],{quota:o["\uacf5\uc6a9 \uc6a9\ub7c9 \ucd08\uacfc \uacbd\uace0 \ube44\uc728"],arg1:1,arg2:99})),!1):r:(r=!1,this.showValidateMsg("companyQuotaWarningRate",n.i18n(o["{{quota}}\uc5d0 \uc22b\uc790\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694."],{quota:o["\uacf5\uc6a9 \uc6a9\ub7c9 \ucd08\uacfc \uacbd\uace0 \ube44\uc728"]})),!1)},showValidateMsg:function(t,n){e("#"+t).focus(),e("#"+t+"Validate").html(n)},save:function(){var t=this,n=this.$el.find("form[name=formCompanyQuota]");e.each(n.serializeArray(),function(e,n){n.value=t._inputValueConverter(n.name,n.value),t.companyQuotaModel.set(n.name,n.value,{silent:!0})});if(!t.validation(t.companyQuotaModel))return;GO.EventEmitter.trigger("common","layout:setOverlay",""),t.companyQuotaModel.save({},{type:"PUT",success:function(t,n){n.code=="200"&&e.goMessage(s["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(t,n){n.message?e.goAlert(n.message):e.goMessage(s["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])},complete:function(){t.render(),GO.EventEmitter.trigger("common","layout:clearOverlay")}})},toggleRadio:function(){e("#sendWarningExceedCompanyQuota_on").is(":checked")?e("#companyQuotaWarningRate").attr("disabled",!1):e("#companyQuotaWarningRate").attr("disabled",!0)},cancel:function(){this.render()},_inputValueConverter:function(e,t){return e=="totalAccountQuota"||e=="companyQuota"?h.gigaToByte(t):t},_validateNumber:function(t){e(".go_alert").html("");var r=e(t.currentTarget);e.goValidation.isNumber(r.val())||this.showValidateMsg(r.attr("id"),n.i18n(o["{{quota}}\uc5d0 \uc22b\uc790\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694."],{quota:o["\ucd1d \ud560\ub2f9 \uacc4\uc815 \uc6a9\ub7c9"]}))}});return p});