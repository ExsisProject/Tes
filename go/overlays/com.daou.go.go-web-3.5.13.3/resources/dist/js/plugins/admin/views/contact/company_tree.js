define(function(require){var e=require("app"),t=require("backbone"),n=require("i18n!admin/nls/admin"),r=require("i18n!nls/commons"),i=require("i18n!docs/nls/docs"),s=require("hgn!admin/templates/contact/company_tree"),o=require("approval/views/apprform/admin_company_folder_tree");require("jquery.go-orgslide");var u={"\ucd94\uac00":r["\ucd94\uac00"],"\uc0ad\uc81c":r["\uc0ad\uc81c"],"\uc8fc\uc18c\ub85d \uc774\ub984":n["\uc8fc\uc18c\ub85d \uc774\ub984"]},a=!0,f=t.View.extend({maxDepth:10,maxChildren:1e3,className:"col1",events:{"click #add":"add","click #remove":"remove"},initialize:function(e){this.treeView=null,this.isAdmin=e.isAdmin,a=_.isUndefined(e.isSiteAdmin)?a:e.isSiteAdmin},render:function(){return this.$el.html(s({lang:u,isNotSelected:!0})),this.renderTree(),this},renderTree:function(){this.treeView=new l({maxDepth:this.maxDepth,maxChildren:this.maxChildren,isAdmin:this.isAdmin,isSideAdmin:!0,treeElementId:"contact_tree",selectCallback:$.proxy(function(e){this.$(".tb_wrap"),e.type=="root"?this.trigger("company_tree.empty"):this.trigger("company_tree.detail",e.id)},this)}),this.treeView.render()},add:function(){$.goOrgSlide("close"),this.treeView.renderNewFolderInput(u["\uc8fc\uc18c\ub85d \uc774\ub984"])},remove:function(){var e=this.treeView.deleteSelectedFolder();e.done($.proxy(function(){this.trigger("company_form.refresh")},this))}}),l=o.extend({_getCommonUrl:function(){return a?e.contextRoot+"ad/api/contact/companyfolder/manage":e.contextRoot+"api/contact/companyfolder/manage"},_onJstreeRemove:function(e,t){var n=$(t.rslt.obj[0]);$.go(this._getCommonUrl()+"/"+n.data().id,{},{qryType:"DELETE",contentType:"application/json",responseFn:$.proxy(function(e){var t=n.parents("li:eq(0)");this._getTreeElement().jstree("select_node",t)},this),error:$.proxy(function(e){$.goError(u.cannot_delete),t.rlbk&&$.jstree.rollback(t.rlbk)},this)})},_onJstreeCreate:function(t,n){function h(e){var t=[];return _.isUndefined(e)?t:(_.each(e.nodes,function(e){var n=_.pick(e,function(e,t){return t!="id"});t.push(n)}),t)}var r=n.rslt,s=h(this.getSelectedNodeData().admins),o=h(this.getSelectedNodeData().accessTarget),a=h(this.getSelectedNodeData().exceptionTarget),f={name:$.trim(r.name),parentId:this.getSelectedNodeData().id,admins:{nodes:s},accessTarget:{nodes:o},exceptionTarget:{nodes:a},seq:r.position},l=this,c=n.inst._get_node(n.rslt.o);if(!_.isEmpty(f.name)&&!$.goValidation.isCheckLength(2,20,f.name))return this._getTreeElement().jstree("refresh",c),$.goError(e.i18n(i["0\uc740 0\uc790\uc774\uc0c1 0\uc790\uc774\ud558 \uc785\ub825\ud574\uc57c \ud569\ub2c8\ub2e4."],{arg0:u["\uc8fc\uc18c\ub85d \uc774\ub984"],arg1:"2",arg2:"64"})),!1;if(f.name==u["folder_name"]||f.name=="")return this._getTreeElement().jstree("refresh",c),!1;$.go(this._getCommonUrl(),JSON.stringify(f),{contentType:"application/json",responseFn:function(e){l._getTreeElement().jstree("refresh",c)},error:function(e){n.rlbk&&$.jstree.rollback(rlbk)}})}});return f});