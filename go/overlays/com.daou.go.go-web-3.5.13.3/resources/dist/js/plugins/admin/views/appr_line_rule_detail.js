define(function(require){var e=require("backbone"),t=require("when"),n=require("system/collections/companies"),r=require("admin/views/appr_line_rule_detail_item"),i=require("hgn!admin/templates/appr_line_rule_detail"),s=require("i18n!approval/nls/approval"),o=require("i18n!nls/commons"),u=require("i18n!admin/nls/admin"),a={"\uc790\ub3d9\uacb0\uc7ac\uc120 \uba85":s["\uc790\ub3d9\uacb0\uc7ac\uc120 \uba85"],"\uc801\uc6a9\ub41c \uc591\uc2dd\uc218":u["\uc801\uc6a9\ub41c \uc591\uc2dd\uc218"],"\uacb0\uc7ac\uc120":s["\uacb0\uc7ac\uc120"],"\uc790\ub3d9\uacb0\uc7ac\uc120 \uc124\uc815":u["\uc790\ub3d9\uacb0\uc7ac\uc120 \uc124\uc815"],"\uc21c\uc11c\ubc14\uafb8\uae30":o["\uc21c\uc11c\ubc14\uafb8\uae30"],"\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc":o["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"],"\ucd94\uac00":o["\ucd94\uac00"],"\uc0ad\uc81c":o["\uc0ad\uc81c"],"\uc800\uc7a5":o["\uc800\uc7a5"],"\ucde8\uc18c":o["\ucde8\uc18c"],empty_msg:s["\uc790\ub8cc\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"],"\ucd5c\uc18c \ud558\ub098 \uc774\uc0c1\uc758 \uacb0\uc7ac\uc120 \uc124\uc815\uc774 \uc788\uc5b4\uc57c \ud569\ub2c8\ub2e4":s["\ucd5c\uc18c \ud558\ub098 \uc774\uc0c1\uc758 \uacb0\uc7ac\uc120 \uc124\uc815\uc774 \uc788\uc5b4\uc57c \ud569\ub2c8\ub2e4"],save_success_msg:s["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4 \uc790\ub3d9 \uacb0\uc7ac\uc120 \uc124\uc815 \ubaa9\ub85d\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4"],"\uc774\ub984":o["\uc774\ub984"],"\uc635\uc158\ucd94\uac00":o["\uc635\uc158\ucd94\uac00"]},f=e.Model.extend({defaults:{apprLineRuleGroups:[]},url:function(){return this.isNew()?"/ad/api/approval/apprlinerule":"/ad/api/approval/apprlinerule/"+this.get("id")}}),l=e.Model.extend({defaults:{useAccountRule:!1,ruleTypeName:"duty",apprLineRuleItemGroups:[],useAllDept:!0}}),c=e.Collection.extend({model:l}),h=e.Model.extend({url:function(){return"/ad/api/approval/admin/config"},getTypes:function(){var e=[{type:"APPROVAL",name:s["\uacb0\uc7ac"]}];return this.get("useAgreement")&&e.push({type:"AGREEMENT",name:s["\ud569\uc758"]}),this.get("useCheckActivity")&&e.push({type:"CHECK",name:s["\ud655\uc778"]}),this.get("useInspectionActivity")&&e.push({type:"INSPECTION",name:s["\uac10\uc0ac"]}),e}}),p=e.Model.extend({initialize:function(){this.set("companyId",GO.session("companyId"))},url:function(){return"/ad/api/positionall/list"}}),d=e.View.extend({el:"#layoutContent",lineItemViews:null,initialize:function(e){this.options=e||{},this.lineItemViews=null,this.model=new f(this.options.hasOwnProperty("ruleId")?{id:this.options.ruleId}:null),this.apprConfig=new h,this.domain=new p,this.unbindEvent(),this.bindEvent()},bindEvent:function(e){this.$el.on("click","#btn_add_option",$.proxy(this._addApprLineOption,this)),this.$el.on("click","#btn_save",$.proxy(this._saveApprLineRule,this)),this.$el.on("click","#btn_cancel",$.proxy(this._goToApprLineRuleView,this))},unbindEvent:function(){this.$el.off("click","#btn_add_option"),this.$el.off("click","#btn_save_apprLineRule"),this.$el.off("click","#btn_cancel_appr_config")},render:function(){var e=this;t(this.fetchRuleModel()).then(_.bind(this.fetchConfig,this)).then(_.bind(this.fetchDomain,this)).then(_.bind(this.fetchCompanies,this)).then(function(){e.$el.html(i({data:e.model.toJSON(),lang:a}));if(e.model.get("apprLineRuleGroups").length<1){var t=new r({apprConfig:e.apprConfig,domain:e.domain,companyIds:e.companyIds,model:new l});e.$el.find("#appr_line_rule_item_area").append(t.render().$el)}else{var n="";_.each(_.groupBy(e.model.get("apprLineRuleGroups"),"seq"),function(t,i){var s=t.length;$.each(t,function(t,i){if(t==0){var o=new r({apprConfig:e.apprConfig,domain:e.domain,companyIds:e.companyIds,model:new l(i),maxLength:s});n=o,e.$el.find("#appr_line_rule_item_area").append(o.render().$el)}else n.addLineRuleItemAreaView({apprConfig:e.apprConfig,domain:e.domain,companyIds:e.companyIds,model:new l(i),maxLength:s,firstLineItemView:n})})})}return e.hideUnnecessaryButtons(),e}).otherwise(function(t){console.log(t.stack)})},_addApprLineOption:function(){var e=this,t=new r({apprConfig:e.apprConfig,domain:e.domain,companyIds:e.companyIds,model:new l});e.$el.find("#appr_line_rule_item_area").append(t.render().$el),$(".btn_delete_option").show(),this.hideUnnecessaryButtons()},hideUnnecessaryButtons:function(){$.each($('div[name="lineRuleItemArea"]'),function(e,t){$(t).find(".approvalLineConfig").length<=1&&($(t).find('.approvalLineConfig span[name="priorityTypeSpan"]').hide(),$(t).find('.approvalLineConfig span[name="approvalLineConfigDelete"]').hide())}),$('div[name="lineRuleItemArea"]').length<=1&&$(".btn_delete_option").hide()},_saveApprLineRule:function(){var e=this,t=[],n=this.$('#appr_line_rule_item_area > div[name="lineRuleItemArea"]');if(this.$('input[name="name"]').val()=="")return $.goMessage(u["\uc774\ub984\uc744 \uc785\ub825\ud558\uc138\uc694."]),!1;$.each(n,function(e,n){var r=e+1,i=$(n).find("div.approvalLineConfig").length;$.each($(n).find("div.approvalLineConfig"),function(e,n){t.push(_.extend($(n).data("instance").getData(!0),{seq:r,subSeqCount:i}))})});var r={name:this.$('input[name="name"]').val(),apprLineRuleGroups:t};if(r.apprLineRuleGroups.length==0)return $.goMessage(a["\ucd5c\uc18c \ud558\ub098 \uc774\uc0c1\uc758 \uacb0\uc7ac\uc120 \uc124\uc815\uc774 \uc788\uc5b4\uc57c \ud569\ub2c8\ub2e4"]),!1;var i="",s=!1;$.each(n,function(e,t){$.each($(t).find("div.approvalLineConfig"),function(e,t){i=$(t).data("instance").validate();if(i!="true")return!1;s=$(t).find("#applyDeptTypes input:checked").val()=="all_depts"?!0:!1});if(i!="true")return!1});if(i!="true")return $.goMessage(i),!1;s?this._ApprLineRuleModelSave(r):$.goConfirm(u["\uc800\uc7a5\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],u["\uc790\ub3d9\uacb0\uc7ac\uc120 \uc804\uccb4\ubd80\uc11c \ubbf8 \ud3ec\ud568 \uacbd\uace0"],function(){e._ApprLineRuleModelSave(r)},o["\ud655\uc778"],function(){return!1})},_ApprLineRuleModelSave:function(e){var t=this;this.model.set(e),this.model.save({},{success:function(e,n){$.goAlert(a.save_success_msg,"",$.proxy(t._goToApprLineRuleView,this))},error:function(e,t){t.responseJSON?$.goMessage(t.responseJSON.message):$.goMessage(o["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})},_goToApprLineRuleView:function(){GO.router.navigate("approval/apprlinerule",{trigger:!0})},fetchRuleModel:function(){var e=this,n=t.defer();return this.model.isNew()?n.resolve():this.model.fetch({success:n.resolve,error:n.reject}),n.promise},fetchConfig:function(){var e=this,n=t.defer();return this.apprConfig.fetch({success:function(){n.resolve()},error:n.reject}),n.promise},fetchDomain:function(){var e=this,n=t.defer();return this.domain.fetch({data:{companyId:e.domain.get("companyId")},success:function(){n.resolve()},error:n.reject}),n.promise},fetchCompanies:function(){var e=this,r=t.defer();return this.apprConfig.get("multiCompanySupporting")==1?(this.companyCollection=new n({type:"companygroup"}),this.companyCollection.fetch({success:_.bind(function(e){this.companyIds=e.map(function(e){return e.id}),r.resolve()},this),error:r.reject})):r.resolve(),r.promise}});return d});