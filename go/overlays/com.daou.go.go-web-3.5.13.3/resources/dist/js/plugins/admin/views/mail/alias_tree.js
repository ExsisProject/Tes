(function(){define(["jquery","backbone","app","hgn!admin/templates/mail/alias_tree","admin/views/mail/alias_create","i18n!nls/commons","i18n!admin/nls/admin","GO.util","jquery.jstree.hotkeys","jquery.jstree"],function(e,t,n,r,i,s,o){var u=null,a={label_alias:o["\ubcc4\uce6d \uacc4\uc815 \uad00\ub9ac"],label_add:s["\ucd94\uac00"],label_edit:s["\uc218\uc815"],label_delete:o["\ubcc4\uce6d \uacc4\uc815 \uc0ad\uc81c"]},f=t.View.extend({el:"#layoutContent",events:{"click #aliasCreate":"addAlias","click #aliasDelete":"deleteAlias","click #moveTopAlias":"moveTopAlias"},initialize:function(){this.$el.off(),GO.EventEmitter.on("admin","layout:renderAliasTree",this.renderTree,this)},render:function(){return this.$el.append(r({lang:a})),this.renderTree(),this},renderTree:function(){var t=this;this.treeEl=this.$el.find("#aliasTree").jstree({plugins:["themes","json_data","ui","crrm","cookies","dnd","types","hotkeys","contextmenu"],core:{animation:120},json_data:{ajax:{url:GO.contextRoot+"ad/api/mail/alias/tree/list",data:function(e){if(typeof e.data=="function")var n=e.data();return{id:n?n.mailUserSeq:t.loadId}},cache:!0,async:!0,success:function(n){try{e.each(n,function(e,t){t.metadata.accountStatus=="disabled"&&(t.data.title=" ("+o["\uc911\uc9c0"]+") "+t.data.title)});var r=t.$el.find("#aliasTree");if(n.length==0&&r.find("ul>li").length<=1){var i=['<p class="data_null"><span class="txt">'+o["\uc0c1\ub2e8\uc5d0"]+"</span>"+" <strong>"+o["[\ucd94\uac00]"]+"</strong>"+'<span class="txt">'+o["\ub97c \ud074\ub9ad\ud574 \uc8fc\uc138\uc694."]+"</span></p>"].join("");r.html(i),r.css("margin","185px 15px"),t.selectedFirstAlias()}}catch(s){console.info(s)}}}},core:{animation:120},"defaults ":{html_titles:!1,move_node:!1,ccp:!0,width:200},ui:{select_multiple_modifier:!1,select_limit:1},hotkeys:{del:t._deleteDept,f2:function(){return!1},space:function(){return!1}},types:{max_depth:-1,max_children:-1,valid_children:["aliasroot"],start_drag:!0,move_node:!0,delete_node:!0,remove:!0,types:{alias:{max_depth:-1,max_children:-1,valid_children:["alias"],start_drag:!0,move_node:!0,delete_node:!0,remove:!0}}}}).bind("loaded.jstree",function(e,n){t.selectedFirstAlias()}).bind("load_node.jstree",function(e,n,r){t.treeEl.find('a[href="#"]').attr("data-bypass",1)}).bind("move_node.jstree",t.moveAliasSave).bind("select_node.jstree",t.selectAlias)},selectedFirstAlias:function(){var t=e("#aliasTree ul");if(!t.length){var n='<p class="data_null"><span class="ic_data_type ic_no_data"></span><span class="txt">'+o["\ub4f1\ub85d\ub41c \ubcc4\uce6d \uacc4\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+"</span>"+"</p>";e("#aliasDetail").html(n),e("#aliasDetail").css("margin","230px 15px");return}var r=t.find("li:first-child a").attr("nodeid"),s=new i({useLayout:!1,aliasId:r});e("#aliasDetail").html(s.render().el)},selectAlias:function(t,n){e.goOrgSlide("close");var r=e(n.rslt.obj[0]).data(),s=new i({useLayout:!1,aliasId:r.mailUserSeq});e("#aliasDetail").html(s.render().el),e(n.rslt.obj[0]).find("a").attr("rel")!="aliasroot"?e("#moveTopAlias").show():e("#moveTopAlias").hide()},addAlias:function(){var t="",n=this.getSelectedAliasNode();n.length&&(t=n.find("a").attr("nodeid"));var r=this,u=new i({useLayout:!1,parentId:t}),a=e.goPopup({pclass:"layer_normal",header:o["\ubcc4\uce6d \uacc4\uc815 \ucd94\uac00"],modal:!0,width:"500px",contents:"",allowPrevPopup:!0,buttons:[{btype:"confirm",btext:s["\ud655\uc778"],autoclose:!1,callback:function(e){u.saveAlias()}},{btype:"close",btext:s["\ucde8\uc18c"]}]});e("#gpopupLayer .content").html(u.render().el),a.reoffset()},getSelectedAliasNode:function(){return this.treeEl.jstree("get_selected")},deleteAlias:function(){var t=this,n=this.getSelectedAliasNode();if(n.length==0)return e.goMessage(admin["\uc0ad\uc81c\ud560 \ubcc4\uce6d \uacc4\uc815\uc744 \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]),!1;var r=n.find("a").attr("nodeid");r&&e.goCaution(o["\ubcc4\uce6d \uacc4\uc815 \uc0ad\uc81c"],o["\ubcc4\uce6d \uacc4\uc815\uc744 \uc0ad\uc81c\ud558\uba74, \ud558\uc704 \ubcc4\uce6d \uacc4\uc815\uc774 \ucd5c\uc0c1\uc704\ub85c \uc774\ub3d9\ub429\ub2c8\ub2e4."],function(){e.go(GO.contextRoot+"ad/api/mail/alias/"+r,{},{qryType:"DELETE",contentType:"application/json",responseFn:function(e){var n=t.getSelectedAliasNode(),r=n.parents("li:eq(0)"),i=r.data();r.find("a:first").addClass("jstree-clicked"),t.render()}})})},moveTopAlias:function(){var t=this,n=this.getSelectedAliasNode();if(n.length==0)return e.goMessage("\ucd5c\uc0c1\uc704\ub85c \uc774\ub3d9\ud560 \ubcc4\uce6d \uacc4\uc815\uc744 \uc120\ud0dd\ud574\uc8fc\uc138\uc694."),!1;var r=n.find("a").attr("nodeid"),i=n.parent("ul").parent("li").find("a").attr("nodeid");r&&e.go(GO.contextRoot+"ad/api/mail/alias/"+r+"/root?prevParentMailUserSeq="+i,{},{qryType:"PUT",contentType:"application/json",responseFn:function(e){t.renderTree()}})},moveAliasSave:function(t,n){var r=e(this),i=n.inst._get_parent(n.rslt.o),s=n.inst._get_node(n.rslt.o),o=n.inst._get_node(n.rslt.op),u="";o!=-1&&(u=o.data("mailUserSeq"));var a=GO.contextRoot+"ad/api/mail/alias/"+s.data("mailUserSeq")+"/move?prevParentMailUserSeq="+u+"&targetParentMailUserSeq="+i.data("mailUserSeq");e.go(a,{},{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200?r.jstree("refresh",i):e.jstree.rollback(n.rlbk)}})},validationParentsNode:function(){}});return f})}).call(this);