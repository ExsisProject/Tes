(function(){define(["jquery","backbone","app","i18n!nls/commons","i18n!admin/nls/admin","hgn!admin/templates/account_csv","hgn!admin/templates/_add_account_csv_result","file_upload","jquery.go-popup","jquery.go-grid","GO.util","jquery.progressbar"],function(e,t,n,r,i,s,o,u){var a={file:r["\ud30c\uc77c\ucc3e\uae30"],title:i["\uacc4\uc815 \uc77c\uad04\ub4f1\ub85d \ud30c\uc77c\uc120\ud0dd"],sub_title:i["\uacc4\uc815 \uc77c\uad04 \ub4f1\ub85d \ud30c\uc77c"],csv_tmpl:i["\uacc4\uc815 \uc77c\uad04 \ub4f1\ub85d \ud30c\uc77c \uc591\uc2dd \ub2e4\uc6b4\ub85c\ub4dc"],account_import:i["\uc77c\uad04 \ub4f1\ub85d"],result:i["\ucc98\ub9ac \uacb0\uacfc"],result_download:i["\uc804\uccb4 \ucc98\ub9ac \uacb0\uacfc \ub2e4\uc6b4\ub85c\ub4dc"],fail_download:i["\uc624\ub958 \ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],account_download:i["\uacc4\uc815 \ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],account_down_title:i["\uacc4\uc815\ubaa9\ub85d \uc77c\uad04 \ub2e4\uc6b4\ub85c\ub4dc"],result_title:i["\uacc4\uc815 \uc77c\uad04 \ub4f1\ub85d \ud30c\uc77c \uc5c5\ub85c\ub4dc \ud604\ud669"]},f={boxImage:GO.contextRoot+"resources/images/progressbar.gif",barImage:GO.contextRoot+"resources/images/progressbg_green_200.gif",width:200,max:100},l=t.View.extend({events:{"click.account #add_accounts":"addAccounts","click.account #download_all":"downloadAll","click.account #download_fail":"downloadFail","click.account #fileComplete .ic_del":"deleteFile","click.account #formDownload":"formDownload","click.account #accountListDownload":"accountListDownload"},initialize:function(){this.add_account_result={},this.model=new t.Model,this.model.url=GO.contextRoot+"ad/api/user/csv",this.interval=null},render:function(){return this.$el.html(s({root:GO.contextRoot,lang:a})),this.getCSVUploadStatus(),this},accountListDownload:function(){GO.util.downloadCsvFile("ad/api/user/download/all")},formDownload:function(){GO.util.downloadCsvFile("ad/api/user/csv/download/form")},undelegateEvents:function(){return t.View.prototype.undelegateEvents.call(this),this.$el.off(".account"),this},downloadAll:function(){var e="ad/api/user/csv/download/total/result";GO.util.downloadCsvFile(e)},downloadFail:function(){var e="ad/api/user/csv/download/fail/result";GO.util.downloadCsvFile(e)},deleteFile:function(){e("#fileComplete").html("")},addAccounts:function(){var t=this,n=GO.contextRoot+"ad/api/user/csv",r={fileName:e("#file_name").val(),filePath:e("#file_path").val(),hostId:e("#host_id").val(),fileExt:e("#file_ext").val()};try{this.validationFile(r)}catch(s){return console.log("accountAccounts Error :: "+s)}GO.EventEmitter.trigger("common","layout:setOverlay",i["\ub85c\ub529\uc911"]),e.go(n,JSON.stringify(r),{qryType:"POST",timeout:0,contentType:"application/json",responseFn:function(e){GO.EventEmitter.trigger("common","layout:clearOverlay",!0),t.getCSVUploadStatus()},error:function(e){clearInterval(this.interval)}})},validationFile:function(t){if(t.fileName==undefined||t.filePath==undefined)throw e.goAlert(i["\uc77c\uad04\ub4f1\ub85d \ud30c\uc77c \uc120\ud0dd"]),new Error(400,i["\uc77c\uad04\ub4f1\ub85d\ud560 \ud30c\uc77c\uc744 \uc120\ud0dd\ud574\uc8fc\uc138\uc694."])},getCSVUploadStatus:function(){var t=this;this.model.fetch({async:!1,silent:!0,success:function(e,n,r){t.changeUIWithUploadStatus()},error:function(){e.goAlert(i["\ub4f1\ub85d\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."]),clearInterval(this.interval)}})},changeUIWithUploadStatus:function(){var t=this,n=this.model.get("jobStatus"),r=this.model.get("size"),s=this.model.get("successCount"),o=this.model.get("failCount"),u=GO.util.basicDate3(this.model.get("startedAt")),a=GO.util.basicDate3(this.model.get("endedAt")),l=s+o;clearInterval(this.interval),n=="WAIT"?this.initializeFileUpload():n=="PREPARE"?(e("#add_accounts").hide(),e("#select_file").hide(),e("#swfupload-control").hide(),e("#csv_progress").show(),e("#item_file").remove(),e("#progress_content").empty(),e("#progress_content").append('<p class="go_alert">'+i["\uacc4\uc815\uc77c\uad04\ub4f1\ub85d \uc900\ube44\uc911"]+"</p>"),this.interval=setInterval(function(){t.getCSVUploadStatus()},1500)):n=="DOING"?(e("#item_file").remove(),e("#progress_content").empty(),e("#add_accounts").hide(),e("#select_file").hide(),e("#swfupload-control").hide(),e("#csv_progress").show(),e("#csv_result").hide(),e("#csv_progress div.header").html("<h2>"+i["\uacc4\uc815 \uc77c\uad04 \ub4f1\ub85d \ud30c\uc77c \uc5c5\ub85c\ub4dc \ud604\ud669"]+"</h2>"),e("#csvProgressBar div#progressbar").show(),e("#csvProgressBar div#progressbar").progressBar(l/r*100,f),this.interval=setInterval(function(){t.getCSVUploadStatus()},1500)):n=="DONE"?(e("#csvProgressBar div#progressbar").hide(),e("#csvProgressBar div#progressbar").progressBar(0,f),e("#add_accounts").show(),e("#select_file").show(),e("#swfupload-control").show(),e("#csv_progress").show(),e("#csv_progress div.header").html("<h2>"+i["\ucd5c\uadfc \uc77c\uad04 \ub4f1\ub85d \uacb0\uacfc"]+"</h2>"),e("#csv_result").show(),e("#progress_content").append("<div>"+i["\ub4f1\ub85d\uc77c"]+": "+u+"</div>"),e("#progress_content").append("<div>"+i["\uc885\ub8cc\uc77c"]+": "+a+"</div>"),e("#progress_content").append("<div>"+i["\ucd1d \uacc4\uc815\uc218"]+": "+l+"</div>"),e("#progress_content").append("<div>"+i["\uc2e4\ud328 \uacc4\uc815\uc218"]+": "+o+"</div>"),e("#progress_content").append("<div>"+i["\uc131\uacf5 \uacc4\uc815\uc218"]+": "+s+"</div>"),this.initializeFileUpload(),clearInterval(this.interval)):(this.initializeFileUpload(),e("#csvProgressBar div#progressbar").hide(),e("#add_accounts").show(),e("#select_file").show(),e("#swfupload-control").show(),e("#csv_progress").show(),e("#csv_progress div.header").html("<h2>"+i["\ucd5c\uadfc \uc77c\uad04 \ub4f1\ub85d \uacb0\uacfc"]+"</h2>"),e("#csv_result").show(),e("#progress_content").append('<p class="go_alert">'+i["\uacc4\uc815\uc77c\uad04\ub4f1\ub85d \uc911\uc9c0"]+"</p>"),e("#progress_content").append("<div>"+i["\ub4f1\ub85d\uc77c"]+": "+u+"</div>"),e("#progress_content").append("<div>"+i["\uc885\ub8cc\uc77c"]+": "+a+"</div>"),e("#progress_content").append("<div>"+i["\ucd1d \uacc4\uc815\uc218"]+": "+l+"</div>"),e("#progress_content").append("<div>"+i["\uc2e4\ud328 \uacc4\uc815\uc218"]+": "+o+"</div>"),e("#progress_content").append("<div>"+i["\uc131\uacf5 \uacc4\uc815\uc218"]+": "+s+"</div>"),clearInterval(this.interval))},initializeFileUpload:function(){this.initFileUpload();var t=this.getAccountCnt(),n=t.userCount-t.usedCount+t.stopUserCount;n<=0?(e(".btn_file").hide(),e("#formDownload").parent().append('<p class="go_alert">'+i["\uacc4\uc815\uc744 \ub354\uc774\uc0c1 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4. \ub77c\uc774\uc120\uc2a4 \uacc4\uc815\uc218\ub97c \ud655\uc778\ud558\uc138\uc694."]+"</p>")):t.userCount==0&&(e(".btn_file").hide(),e("#formDownload").parent().append('<p class="go_alert">'+i["\uc0ac\uc6a9\uc790 \ub77c\uc774\uc120\uc2a4 \ub4f1\ub85d \uacbd\uace0"]+"</p>"))},getAccountCnt:function(){var t={},n=GO.contextRoot+"ad/api/company/license";return e.go(n,"",{async:!1,qryType:"GET",contentType:"application/json",responseFn:function(e){e.code==="200"&&(t=e.data)},error:function(t){e.goAlert(a.error)}}),t},initFileUpload:function(){var t=i["\ud30c\uc77c \ucc3e\uae30"],n=this,r={el:"#swfupload-control",context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+t+"</span>",progressBarUse:!0,url:"ad/api/file?GOAdminSSOcookie="+e.cookie("GOAdminSSOcookie")};(new u(r)).queue(function(e,t){}).start(function(t,n){var r=new RegExp("(.csv|.xls|.xlsx)","gi"),s=n.type.toLowerCase();if(!r.test(s))return e.goAlert(i["csv \ud30c\uc77c\ub9cc \ub4f1\ub85d \uac00\ub2a5\ud569\ub2c8\ub2e4."]),e("#progressbar").hide(),!1}).progress(function(e,t){}).success(function(t,n,r){if(GO.util.fileUploadErrorCheck(n))return e.goAlert(GO.util.serverMessage(n)),!1;var i=n.data,s=i.fileName,o=i.filePath,u=i.hostId,a=GO.util.getHumanizedFileSize(i.fileSize),f=i.fileExt,l="<li id='item_file'><span class='item_file'><span class='ic_file ic_def'></span><span class='name'>"+s+"</span>"+"<span class='size'>("+a+")</span>"+"<span class='btn_wrap' title='\uc0ad\uc81c'>"+"<span class='ic_classic ic_del'></span>"+"</span>"+"</span>"+"<input type='hidden' value='"+o+"' id='file_path'/>"+"<input type='hidden' value='"+s+"' id='file_name'/>"+"<input type='hidden' value='"+u+"' id='host_id'/>"+"<input type='hidden' value='"+f+"' id='file_ext'/>"+"</li>";e("#fileComplete").html(l)}).complete(function(e,t){console.info(t)}).error(function(e,t){console.info(t)})}});return l})}).call(this);