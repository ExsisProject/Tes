define(["jquery","backbone","app","i18n!admin/nls/admin","i18n!nls/commons","hgn!admin/templates/otp_config","jquery.go-grid"],function(e,t,n,r,i,s){var o=null,u={label_ok:i["\uc800\uc7a5"],label_cancel:i["\ucde8\uc18c"],label_title:r["\uae30\ubcf8 \uc124\uc815"],label_otp_login:r["OTP \ub85c\uadf8\uc778"],label_use:r["\uc0ac\uc6a9\ud568"],label_unuse:i["\uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc74c"],otp_enabled_users:r["OTP \uc0ac\uc6a9\uacc4\uc815"],otp_disabled_users:r["OTP \ube44\uc0ac\uc6a9\uacc4\uc815"],otp_delete:r["OTP \uae30\uae30 \uc0ad\uc81c"],otp_enable:r["OTP \uc0ac\uc6a9 \uacc4\uc815\uc73c\ub85c \ubcc0\uacbd"],otp_disable:r["OTP \ube44\uc0ac\uc6a9 \uacc4\uc815\uc73c\ub85c \ubcc0\uacbd"],name:i["\uc774\ub984"],email:i["\uc774\uba54\uc77c"],ostype:r["OS\ud0c0\uc785"],deviceModel:r["\ubaa8\ub378\uba85"],deviceId:r.DeviceId,otp_registered_at:r["OTP \ub4f1\ub85d\uc77c"],empty_user_list:r["\ub4f1\ub85d\ub41c \uacc4\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],search:i["\uac80\uc0c9"],no_selected:r["\uc120\ud0dd\ub41c \uc0ac\uc6a9\uc790\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"],otp_exception_ip_title:r["OTP \ub85c\uadf8\uc778 \uc81c\uc678 IP \uc124\uc815"],otp_exception_ip_desc:r["\uc81c\uc678IP \uc124\uba85"],otp_exception_ip_active:r["\uc0ac\uc6a9\uc5ec\ubd80"],ip_address:r["IP \uc8fc\uc18c"],add:i["\ucd94\uac00"],remove:i["\uc81c\uac70"]},a=t.Model.extend({url:function(){return GO.contextRoot+"ad/api/otpconfig"}},{IP_RANGE_CONCATOR:"-",validateIp:function(e){var t=/^(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))$/;if(e.indexOf(a.IP_RANGE_CONCATOR)>0){var n=e.split(a.IP_RANGE_CONCATOR)[1];if(!t.test(n))return!1}return t.test(e.split(a.IP_RANGE_CONCATOR)[0])}}),f=t.View.extend({initialize:function(){this.model=new a,this.pageInfo={page:0,offset:20,search:{type:null,keyword:null}}},render:function(t){this.searchParams=this._getSearchParams(),this.model.fetch().done(e.proxy(function(){this._renderBase(),this._setIpInputDisabled(),this._renderExceptionIpList(),this._renderOnOffUserList()},this)),this._bindEvent()},_renderBase:function(){this.$el.html(s({data:this.model.toJSON(),lang:u}))},_renderExceptionIpList:function(){var e=this.$("#exceptionIps"),t={ips:this.model.get("exceptionIps")},n=[];n.push("{{#ips}}"),n.push('    <option value="{{.}}">{{.}}'),n.push("{{/ips}}"),e.html(Hogan.compile(n.join("")).render(t))},_renderOnOffUserList:function(){var t=this.$("#otp_enabled_users").hasClass("active")?"enabled":"disabled",s=this;this.dataTable=e.goGrid({el:"#otp_user_table",method:"GET",bDestroy:!0,url:GO.contextRoot+"ad/api/otp/user/"+t,emptyMessage:"<p class='data_null'> <span class='ic_data_type ic_no_data'></span><span class='txt'>"+r["\ub4f1\ub85d\ub41c \uacc4\uc815\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+"</span>"+"</p>",defaultSorting:[[1,"asc"]],sDomType:"admin",checkbox:!0,checkboxData:"id",displayLength:n.session("adminPageBase"),params:this.searchParams,columns:[{mData:"userName",sClass:"title",bSortable:!0,sWidth:"180px"},{mData:"userEmail",sClass:"align_c",sWidth:"200px",bSortable:!0},{mData:null,bSortable:!0,sWidth:"100px",fnRender:function(e){return e.aData.osType==null||e.aData.osType==""?i["\uc5c6\uc74c"]:e.aData.osType}},{mData:null,bSortable:!0,sWidth:"120px",fnRender:function(e){return e.aData.deviceModel==null||e.aData.deviceModel==""?i["\uc5c6\uc74c"]:e.aData.deviceModel}},{mData:null,sClass:"title",bSortable:!1,fnRender:function(e){return e.aData.deviceId==null||e.aData.deviceId==""?i["\uc5c6\uc74c"]:e.aData.deviceId}},{mData:null,sClass:"align_c",sWidth:"200px",bSortable:!1,fnRender:function(e){return e.aData.registeredAt==null||e.aData.registeredAt==""?i["\uc5c6\uc74c"]:GO.util.basicDate(e.aData.registeredAt)}}],fnDrawCallback:function(e,n,r){var i=[];i.push('<a href="#"><span id="otp_enable_disable" class="btn_tool">'),i.push(t=="enabled"?u.otp_disable:u.otp_enable),i.push("</span></a>"),i.push('<span class="btn_tool" id="otp_delete_button">'),i.push(u.otp_delete),i.push("</span>"),s.$el.find(".toolbar_top .custom_header").html(i.join("\n")),s._addSearchParam({page:r.page,offset:r.offset},!0)}})},_bindEvent:function(){this.$el.off("click","span#ok"),this.$el.off("click","span#cancel"),this.$el.off("click",'input[name="enabled"]'),this.$el.off("click",'input[name="exceptionIpsEnabled"]'),this.$el.off("click","li#otp_enabled_users"),this.$el.off("click","li#otp_disabled_users"),this.$el.off("click","#otp_enable_disable"),this.$el.off("click","#otp_delete_button"),this.$el.off("click","#exception_ip_add_button"),this.$el.off("click","#exception_ip_remove_button"),this.$el.off("click","#user_search_submit"),this.$el.off("submit","#user_otp_search_form"),this.$el.on("click","span#ok",e.proxy(this._onSaveButtonClicked,this)),this.$el.on("click","span#cancel",e.proxy(this._onCancelButtonClicked,this)),this.$el.on("click",'input[name="enabled"]',e.proxy(this._onEnabledCBClicked,this)),this.$el.on("click",'input[name="exceptionIpsEnabled"]',e.proxy(this._onExceptionIpEnabledCBClicked,this)),this.$el.on("click","li#otp_enabled_users",e.proxy(this._onOTPEnabledUserTabClicked,this)),this.$el.on("click","li#otp_disabled_users",e.proxy(this._onOTPDisabledUserTabClicked,this)),this.$el.on("click","#otp_enable_disable",e.proxy(this._onOTPOnOffButtonClicked,this)),this.$el.on("click","#otp_delete_button",e.proxy(this._onOTPDeleteButtonClicked,this)),this.$el.on("click","#exception_ip_add_button",e.proxy(this._onExceptionIpAddClicked,this)),this.$el.on("click","#exception_ip_remove_button",e.proxy(this._onExceptionIpRemoveClicked,this)),this.$el.on("click","#user_search_submit",e.proxy(this._onSearchSubmit,this)),this.$el.on("submit","#user_otp_search_form",e.proxy(this._onSearchSubmit,this))},_onSaveButtonClicked:function(t){var n=this;n.model.save({},{success:function(t,r){r.code=="200"&&(e.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.render())},error:function(t,n){var r=JSON.parse(n.responseText);r.message!=null?e.goMessage(r.message):e.goMessage(i["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])}}),t.stopPropagation()},_onCancelButtonClicked:function(t){var n=this;e.goCaution(i["\ucde8\uc18c"],i["\ubcc0\uacbd\ud55c \ub0b4\uc6a9\uc744 \ucde8\uc18c\ud569\ub2c8\ub2e4."],function(){n.render(),e.goMessage(i["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},i["\ud655\uc778"]),t.stopPropagation()},_onEnabledCBClicked:function(){var e=this.$("input[name=enabled]:checked").val();this.model.set("enabled",e)},_onExceptionIpEnabledCBClicked:function(){var e=this.$('input[name="exceptionIpsEnabled"]:checked').val()=="true";this.model.set("exceptionIpsEnabled",e),this._setIpInputDisabled()},_setIpInputDisabled:function(){var e=!this.model.get("exceptionIpsEnabled");this.$("td.ipAddress > input").prop("disabled",e),this.$("#exceptionIps").prop("disabled",e),e&&this._clearIpParts()},_onExceptionIpAddClicked:function(){var t=this.$('td.ipAddress > input[name*="ip_from_"]'),n=this.$('td.ipAddress > input[name*="ip_to_"]'),r=this._mapToVal(t),s=this._mapToVal(n),o=r.join(".");_.size(_.compact(s))>0&&(o=o.concat("-",s.join(".")));if(!a.validateIp(o)){e.goAlert(i["IP \uc720\ud6a8\ud558\uc9c0 \uc54a\uc74c"]);return}if(_.contains(this.model.get("exceptionIps"),o)){e.goAlert(i["IP \uc911\ubcf5"]);return}this.model.get("exceptionIps").push(o),this._renderExceptionIpList(),this._clearIpParts()},_clearIpParts:function(){this.$('td.ipAddress > input[name*="ip_from_"]').val(""),this.$('td.ipAddress > input[name*="ip_to_"]').val("")},_mapToVal:function(t){return _.map(t,function(t){return e(t).val()})},_onExceptionIpRemoveClicked:function(){var t=e("#exceptionIps option:selected");if(t.length<1){e.goAlert(i["IP \uc120\ud0dd\ub418\uc9c0 \uc54a\uc74c"]);return}var n=this._mapToVal(t),r=this.model.get("exceptionIps");r=_.reject(r,function(e){return _.contains(n,e)}),this.model.set("exceptionIps",r),this._renderExceptionIpList()},_onOTPEnabledUserTabClicked:function(e){e.stopPropagation(),this.$("#otp_enabled_users").addClass("active"),this.$("#otp_disabled_users").removeClass("active"),this._renderOnOffUserList()},_onOTPDisabledUserTabClicked:function(e){e.stopPropagation(),this.$("#otp_enabled_users").removeClass("active"),this.$("#otp_disabled_users").addClass("active"),this._renderOnOffUserList()},_onOTPOnOffButtonClicked:function(t){var n=this;t.stopPropagation();if(this._getCheckedIds().length==0){e.goSlideMessage(r["\uc120\ud0dd\ub41c \uc0ac\uc6a9\uc790\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var s=r["OTP \uc0ac\uc6a9 \uacc4\uc815\uc73c\ub85c \ubcc0\uacbd"];o=r["\ub85c\uadf8\uc778\ud560 \ub54c, OTP\uac00 \ud544\uc694\ud569\ub2c8\ub2e4."];if(this.$("#otp_enabled_users").hasClass("active")){s=r["OTP \ube44\uc0ac\uc6a9 \uacc4\uc815\uc73c\ub85c \ubcc0\uacbd"];var o=r["\ub85c\uadf8\uc778\ud560 \ub54c, OTP\uac00 \ud544\uc694\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]}return e.goConfirm(s,o,function(){e.ajax({type:"PUT",async:!0,data:JSON.stringify({ids:n._getCheckedIds()}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/otp/user/"+(n.$("#otp_enabled_users").hasClass("active")?"disabled":"enabled")}).done(function(t){e.goMessage(i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n._renderOnOffUserList()})}),!1},_onOTPDeleteButtonClicked:function(t){var n=this;t.stopPropagation();if(this._getCheckedIds().length==0){e.goSlideMessage(r["\uc120\ud0dd\ub41c \uc0ac\uc6a9\uc790\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}return e.goConfirm(r["OTP \uae30\uae30 \uc0ad\uc81c"],r["\uc0ac\uc6a9\uc790\uac00 \ub4f1\ub85d\ud55c OTP \uae30\uae30\uac00 \uc0ad\uc81c\ub429\ub2c8\ub2e4."],function(){e.ajax({type:"DELETE",async:!0,data:JSON.stringify({ids:n._getCheckedIds()}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/otp/user"}).done(function(t){e.goMessage(i["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n._renderOnOffUserList()})}),!1},_getCheckedIds:function(){return this._mapToVal(this.$("tbody input[type=checkbox]:checked"))},searchParamKeys:["page","offset"],_addSearchParam:function(t,n){var r=GO.router.getUrl(),i=this.searchParams,t=t;e.each(this.searchParamKeys,function(e,n){t.hasOwnProperty(n)&&(i[n]=t[n])}),GO.router.navigate(r.split("?")[0]+"?"+e.param(i))},_getSearchParams:function(){var e=GO.router.getSearch(),t=e||{};return t.page=parseInt(e.page,20)||0,t.offset=e.offset||20,t},_onSearchSubmit:function(){var e=this.$("#user_search_select").val(),t=this.$("#user_search_keyword").val();return this.dataTable.tables.search(e,t,this.$("#user_search_keyword")),!1}});return f});