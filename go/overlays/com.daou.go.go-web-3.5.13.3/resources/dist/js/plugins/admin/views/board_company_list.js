define(function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("hgn!admin/templates/board_company_list"),s=require("i18n!nls/commons"),o=require("i18n!admin/nls/admin"),u=require("i18n!board/nls/board"),a=require("admin/collections/company_board"),f=require("board/components/board_tree/board_tree"),l=require("board/models/company_board_tree_node"),c=require("board/constants");require("jquery.go-sdk"),require("GO.util"),require("jquery.go-popup");var h={company_board_add:o["\uac8c\uc2dc\ud310 \ucd94\uac00"],separate_add:o["\uad6c\ubd84\uc120 \ucd94\uac00"],board_sort:o["\uc21c\uc11c \ubc14\uafb8\uae30"],board_sort_done:o["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"],board_title:o["\uac8c\uc2dc\ud310 \uc81c\ubaa9"],board_type:o["\uc720\ud615"],board_manager:o["\uc6b4\uc601\uc790"],board_createdAt:o["\uc0dd\uc131\uc77c"],board_count:o["\uac8c\uc2dc\ubb3c \uac1c\uc218"],share_range:o["\uacf5\uac1c \ubc94\uc704"],board_setting:s["\uc124\uc815"],board_no_list:o["\ub4f1\ub85d\ub41c \uc804\uc0ac\uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],board_BBS:o["\ud074\ub798\uc2dd"],board_STREAM:o["\ud53c\ub4dc"],board_public:o["\uc804\uccb4\uacf5\uac1c"],board_private:o["\ubd80\ubd84\uacf5\uac1c"],board_separate:u["\uad6c\ubd84\uc120"],board_save:s["\uc800\uc7a5"],board_cancel:s["\ucde8\uc18c"],board_modify:s["\uc218\uc815"],board_delete:s["\uc0ad\uc81c"],board_stop:s["\uc911\uc9c0"],board_normal:s["\uc815\uc0c1 \uc0c1\ud0dc\ub85c \ubcc0\uacbd"],board_exposure:o["\uac8c\uc2dc\ud310 \ud648 \ub178\ucd9c"],actived_board:o["\uc0ac\uc6a9\uc911\uc778 \uac8c\uc2dc\ud310"],closed_board:o["\uc911\uc9c0\ub41c \uac8c\uc2dc\ud310"],not_selected_board:u["\uac8c\uc2dc\ud310\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],stop_confirm:u["\uac8c\uc2dc\ud310 \uc911\uc9c0 \ud655\uc778"],stop_board:u["\uac8c\uc2dc\ud310 \uc911\uc9c0"],delete_confirm:u["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],delete_title:u["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],delete_success:s["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],change_status_normal:s["\uc815\uc0c1 \uc0c1\ud0dc\ub85c \ubcc0\uacbd"],normal_confirm:u["\uc815\uc0c1\uc73c\ub85c \ubcc0\uacbd \uc54c\ub9bc"],change_success:s["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],add_group:u["\uac8c\uc2dc\ud310 \uadf8\ub8f9 \ucd94\uac00"],close_all:u["\ubaa8\ub450 \ub2eb\uae30"],open_all:u["\ubaa8\ub450 \uc5f4\uae30"]},p=null,d=!1,v=t.View.extend({el:"#companyboardListPage",unbindEvent:function(){this.$el.off("click","span[data-btntype='bbsCreate']"),this.$el.off("click","span[data-btntype='modify']"),this.$el.off("click","span.btnBoardStatusNormal"),this.$el.off("click","td.title"),this.$el.off("click","#checkedAll"),this.$el.off("click","#tabControll li"),this.$el.off("click","span.btnBoardLineAdd"),this.$el.off("click","span.btnBoardSortable"),this.$el.off("click","span.btnToggleNodes"),this.$el.off("click","span.btnBoardGroupAdd"),this.$el.off("click","span.btnBoardStop"),this.$el.off("click","span.btnBoardDelete"),this.$el.off("click",".tb-header #checkAll")},bindEvent:function(){this.$el.on("click","span[data-btntype='bbsCreate']",e.proxy(this.bbsCreate,this)),this.$el.on("click","span[data-btntype='modify']",e.proxy(this.bbsModify,this)),this.$el.on("click","span.btnBoardStatusNormal",e.proxy(this.changeStatusNormal,this)),this.$el.on("click","td.title",e.proxy(this.bbsModify,this)),this.$el.on("click","#checkedAll",e.proxy(this.checkAllToggle,this)),this.$el.on("click","#tabControll li",e.proxy(this.changeTab,this)),this.$el.on("click","span.btnBoardLineAdd",e.proxy(this._addSeperator,this)),this.$el.on("click","span.btnToggleNodes",e.proxy(this._onClickToggleNodes,this)),this.$el.on("click","span.btnBoardSortable",e.proxy(this._onClickSortableToggle,this)),this.$el.on("click","span.btnBoardGroupAdd",e.proxy(this._addFolder,this)),this.$el.on("click","span.btnBoardStop",e.proxy(this._onClickBoardStop,this)),this.$el.on("click","span.btnBoardDelete",e.proxy(this._onClickBoardDelete,this)),this.$el.on("click",".tb-header #checkAll",e.proxy(this._onClickCheckAll,this))},initialize:function(){this.companyId=GO.session().companyId,this.unbindEvent(),this.bindEvent(),this.type=c.STATUS_ACTIVE,this.activeBoardList=new l.Collection(null,{status:c.STATUS_ACTIVE,isAdminService:!0}),this.closedBoardList=new l.Collection(null,{status:c.STATUS_CLOSED,isAdminService:!0}),this.boardTreeConfigView=null,this.listenTo(this.activeBoardList,"sync",this._renderActiveBoardList),this.listenTo(this.closedBoardList,"sync",this._renderClosedBoardList)},render:function(e){console.log("[board] BoardCompanyList:render call"),this._initRender(e),e===c.STATUS_ACTIVE?(this.type=c.STATUS_ACTIVE,this._fetchAndRenderActiveBoardList()):(this.type=c.STATUS_CLOSED,this._fetchAndRenderClosedBoardList())},_initRender:function(e){if(e===c.STATUS_ACTIVE){this.boardTreeConfigView&&(this.boardTreeConfigView.remove(),this.boardTreeConfigView=null);var t=i({isActive:!0,lang:h,isActiveBoard:!0});this.$el.html(t)}},_renderClosedBoardList:function(e){var t=this,n=function(){return this.type=="CLASSIC"?h.board_BBS:h.board_STREAM},r=function(){return GO.util.basicDate(this.createdAt)},s=function(){return this.sharedFlag?h.board_private:h.board_public},o=this.closedBoardList.toJSON(),u=i({dataset:o,bbsType:n,parseDate:r,sharedRange:s,isActive:!1,lang:h,isActiveBoard:!1});this.$el.html(u),this.listEl=this.$el.find("#tableBorderList"),this.$el.find("#tableBorderList tr:last-child").addClass("last")},_fetchAndRenderClosedBoardList:function(){var e=this,t=this.closedBoardList;return n.promise(function(e,n){t.fetch({silent:!0,success:function(t){e(t)},error:n})}).otherwise(function(e){console.log(e.stack)})},_renderActiveBoardList:function(){var e,t=this.$el.find(".no-list-msg"),n=this.activeBoardList;return this._getBoardTreeConfigView(n)},_fetchAndRenderActiveBoardList:function(){var e=this,t=this.activeBoardList;return n.promise(function(e,n){t.fetch({silent:!0,success:function(t){e(t)},error:n})}).otherwise(function(e){console.log(e)})},_getCheckedBoardIds:function(){var t=[];return this.$("input:checkbox[name=board_id]:checked").each(function(n,r){t.push(e(r).val())}),t},_createBoardTreeConfigView:function(e){var t,n={};return e instanceof l.Collection&&(n.nodes=this._convertBoardsAction(e)),t=new f.BoardTreeConfigView(n),t.setElement(this.$el.find("#board-tree-config")),t.render(),t},_getBoardTreeConfigView:function(e){return this.boardTreeConfigView===null&&(this.boardTreeConfigView=this._createBoardTreeConfigView(e)),this.boardTreeConfigView},_convertBoardsAction:function(e){return e.map(function(e){e.isBoardNode()&&e.set("actions",{managable:!0})}),e},_addFolder:function(){var e=this._getBoardTreeConfigView(this.activeBoardList);e.addNode(new l.Model({nodeType:c.NODETYPE_FOLDER,nodeValue:u["\uc0c8\ub85c\uc6b4 \uadf8\ub8f9\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]},{isAdminService:!0}))},_addSeperator:function(){var e=this._getBoardTreeConfigView(this.activeBoardList);e.addNode(new l.Model({nodeType:c.NODETYPE_SEPERATOR,nodeValue:u["\uc0c8\ub85c\uc6b4 \uad6c\ubd84\uc120\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]},{isAdminService:!0}))},_onClickCheckAll:function(t){this.$("input:checkbox[name=board_id]").attr("checked",e(t.currentTarget).is(":checked"))},_onClickToggleNodes:function(t){var n=e(t.currentTarget),r=n.attr("data-state");t.preventDefault();if(this.boardTreeConfigView===null)return;r==="opened"?(this.boardTreeConfigView.foldAllNodes(),n.attr("data-state","closed"),n.text(h.open_all)):(this.boardTreeConfigView.unfoldAllNodes(),n.attr("data-state","opened"),n.text(h.close_all))},_onClickSortableToggle:function(e){e.preventDefault(),this._isSortableMode()?this._distroyNodeSortable():this._enableNodeSortable()},_enableNodeSortable:function(){if(!this.boardTreeConfigView)return;this.$el.find(".chk").hide(),e(".btnBoardAdd").hide(),e(".btnBoardGroupAdd").hide(),e(".btnBoardLineAdd").hide(),e(".btnBoardStop").hide(),e(".btnBoardDelete").hide(),e(".btnEditNode").hide(),this.boardTreeConfigView.enableSortable(),this.$(".tb-header").addClass("tb_stair_edit"),this._changeSortButtonText(h.board_sort_done)},_distroyNodeSortable:function(){if(!this.boardTreeConfigView)return;this.$el.find(".chk").hide(),e(".btnBoardAdd").show(),e(".btnBoardGroupAdd").show(),e(".btnBoardLineAdd").show(),e(".btnBoardStop").show(),e(".btnBoardDelete").show(),e(".btnEditNode").show(),this.boardTreeConfigView.destroySortable(),this.$(".tb-header").removeClass("tb_stair_edit"),this._changeSortButtonText(h.board_sort)},_isSortableMode:function(){return this.$("#board-tree-config").hasClass("tb_stair_edit")},_changeSortButtonText:function(t){e(".btnBoardSortable").html(t)},_onClickBoardStop:function(t){var n=this._getCheckedBoardIds(),r=this;t.preventDefault();if(d===!0){e.goSlideMessage(s["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(n.length==0){e.goMessage(h.not_selected_board);return}e.goConfirm(h.stop_board,h.stop_confirm,function(){e.ajax({type:"PUT",async:!0,data:JSON.stringify({ids:n}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/board/status/closed"}).done(function(t){e.goMessage(h.change_success),r.render(r.type)}).complete(function(){d=!1})})},_onClickBoardDelete:function(t){var n=this._getCheckedBoardIds(),r=this;t.preventDefault();if(d===!0){e.goSlideMessage(s["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(n.length==0){e.goMessage(h.not_selected_board);return}e.goConfirm(h.delete_title,h.delete_confirm,function(){e.ajax({type:"DELETE",async:!0,data:JSON.stringify({ids:n}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/board/status/deleted"}).done(function(t){e.goMessage(h.delete_success),r.render(r.type)}).complete(function(){d=!1})})},checkAllToggle:function(t){var n=e(t.currentTarget);n.is(":checked")?this.$el.find("#tableBorderList input:checkbox").attr("checked","checked"):this.$el.find("#tableBorderList input:checkbox").attr("checked",null)},changeStatusNormal:function(){var t=this._getCheckedBoardIds(),n=this;if(t.length==0){e.goMessage(h.not_selected_board);return}e.goConfirm(h.change_status_normal,h.normal_confirm,function(){e.ajax({type:"PUT",async:!0,data:JSON.stringify({ids:t}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"ad/api/board/status/active"}).done(function(t){e.goMessage(h.change_success),n.render(n.type)})})},changeTab:function(t){t.stopImmediatePropagation();var n=e(t.currentTarget),r=n.attr("data-type");this.render(r)},bindListSortable:function(e){this.$el.find(".btnBoardLineAdd").hide(),this.$el.find(".btnBoardSortable").hide(),this.$el.find(".btnBoardAdd").hide(),this.$el.find(".btnBoardSortDone").show(),this.listEl.find("tbody").removeClass().sortable({opacity:"1",delay:100,cursor:"move",items:"tr",containment:".admin_content",hoverClass:"ui-state-hover",placeholder:"ui-sortable-placeholder",start:function(e,t){t.placeholder.html(t.helper.html()),t.placeholder.find("td").css("padding","5px 10px")}})},bbsCreate:function(){r.router.navigate("/board/create",!0)},bbsModify:function(t){if(e(t.currentTarget).parents("tbody:eq(0)").hasClass("ui-sortable"))return e.goMessage(o["\uc21c\uc11c \ubc14\uafb8\uae30 \uc644\ub8cc\ud6c4 \uc124\uc815"]),!1;var n=e(t.currentTarget).attr("data-boardId");r.router.navigate("/board/"+n+"/modify",!0)}},{create:function(e){return p=new v,p.render(e)}});return{render:function(e){var t=v.create(e);return t}}});