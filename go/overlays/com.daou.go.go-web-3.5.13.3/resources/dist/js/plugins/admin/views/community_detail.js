define(["jquery","backbone","app","hgn!admin/templates/community_detail","hgn!admin/templates/community_members","hgn!admin/templates/community_boards","admin/models/base_model","admin/collections/community_members","admin/collections/community_boards","i18n!nls/commons","i18n!admin/nls/admin","jquery.go-popup","jquery.go-sdk","jquery.go-grid","GO.util"],function(e,t,n,r,i,s,o,u,a,f,l){var c=null,h={label_name:f["\uc81c\ubaa9"],label_type:l["\uc720\ud615"],label_master:l["\uac8c\uc2dc\ud310 \uc6b4\uc601\uc790"],label_postcount:l["\uac8c\uc2dc\ubb3c \uc218(\uac1c)"],label_usedata:l["\uc0ac\uc6a9\ub7c9(MB)"],label_title:l["\uae30\ubcf8\uc815\ubcf4"],label_name:l["\ucee4\ubba4\ub2c8\ud2f0 \uba85"],label_delete:l["\ucee4\ubba4\ub2c8\ud2f0 \uc0ad\uc81c"],label_status:l["\uc0c1\ud0dc"],label_online:l["\uc815\uc0c1"],label_stop:l["\uc911\uc9c0"],label_wait:l["\uac1c\uc124\ub300\uae30"],label_desc:l["\ucee4\ubba4\ub2c8\ud2f0 \uc18c\uac1c"],label_created:l["\uc0dd\uc131\uc77c"],label_pds:l["\ucee4\ubba4\ub2c8\ud2f0 \uc790\ub8cc"],label_count:l["\uac1c"],label_board:f["\uac8c\uc2dc\ud310"],label_post:l["\uac8c\uc2dc\ubb3c"],label_size:l["\uc0ac\uc6a9\ub7c9"],label_mb:l.MB,label_ok:f["\ud655\uc778"],label_save:f["\uc800\uc7a5"],label_cancel:f["\ucde8\uc18c"],label_back:l["\ubaa9\ub85d\uc73c\ub85c \ub3cc\uc544\uac00\uae30"],label_csv:l["\ubaa9\ub85d \ub2e4\uc6b4\ub85c\ub4dc"],label_email:f["\uc774\uba54\uc77c"],label_last:l["\ucd5c\uc885 \uc811\uc18d"],label_membertype:l["\uba64\ubc84\ud0c0\uc785"],label_name2:l["\uc774\ub984(\uc9c1\uc704)"],label_community_member:l["\ucee4\ubba4\ub2c8\ud2f0 \uba64\ubc84"],label_community_board:l["\ucee4\ubba4\ub2c8\ud2f0 \uac8c\uc2dc\ud310"],BBS:l["\ud074\ub798\uc2dd"],CLASSIC:l["\ud074\ub798\uc2dd"],STREAM:l["\ud53c\ub4dc"],MASTER:l["\ub9c8\uc2a4\ud130"],MODERATOR:l["\ubd80\ub9c8\uc2a4\ud130"],USER:l["\uba64\ubc84"],label_non_board:l["\ub4f1\ub85d\ub41c \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]},p=t.View.extend({el:"#layoutContent",events:{},unbindEvent:function(){this.$el.off("click","#detail_save"),this.$el.off("click","#detail_cancel"),this.$el.off("click","#back_community"),this.$el.off("click","#community_remove"),this.$el.off("click","#community_member"),this.$el.off("click","#community_board"),this.$el.off("click",".memberType"),this.$el.off("click",".ic_edit_done"),this.$el.off("click",".ic_edit_cancel"),this.$el.off("click","span#btn_down_members"),this.$el.off("click","span#btn_down_boards")},bindEvent:function(){this.$el.on("click","#detail_save",e.proxy(this.detailSave,this)),this.$el.on("click","#detail_cancel",e.proxy(this.detailCancel,this)),this.$el.on("click","#back_community",e.proxy(this.backCommunityAll,this)),this.$el.on("click","#community_remove",e.proxy(this.communityRemove,this)),this.$el.on("click","#community_member",e.proxy(this.getCommunityMember,this)),this.$el.on("click","#community_board",e.proxy(this.getCommunityBoard,this)),this.$el.on("click",".memberType",e.proxy(this.setMemberType,this)),this.$el.on("click",".ic_edit_done",e.proxy(this.saveMemberType,this)),this.$el.on("click",".ic_edit_cancel",e.proxy(this.cancelMemberType,this)),this.$el.on("click","span#btn_down_members",e.proxy(this.csvDownloadCommunityMembers,this)),this.$el.on("click","span#btn_down_boards",e.proxy(this.csvDownloadCommunityBoards,this))},initialize:function(){this.unbindEvent(),this.bindEvent(),this.communityId=this.options.communityId},render:function(){this.$el.empty(),this.renderInfo(this.communityId),this.getCommunityMember(this.communityId),e("#community_member").addClass("active")},csvDownloadCommunityMembers:function(){var e=this.$el.find("#community_name").attr("data-id");GO.util.downloadCsvFile("ad/api/community/"+e+"/member/download")},csvDownloadCommunityBoards:function(){var e=this.$el.find("#community_name").attr("data-id");GO.util.downloadCsvFile("ad/api/community/"+e+"/statistic/boards/download")},renderInfo:function(e){this.model=new o({urlRoot:GO.contextRoot+"ad/api/community",id:e}),this.model.fetch({async:!1});var t=this.model.toJSON();this.$el.html(r({lang:h,model:t,createdAt:GO.util.shortDate(t.createdAt),totalSize:function(){return GO.util.byteToMega(t.totalSize)},isCommunityStatusOnline:function(){return this.model.status=="ONLINE"?!0:!1},isCommunityStatusStop:function(){return this.model.status=="STOP"?!0:!1},isCommunityStatusWait:function(){return this.model.status=="WAIT"?!0:!1}}))},detailSave:function(t){var n=[],r=e('input[name="communityStatus"]:radio:checked').val(),i=this.$el.find("#community_name").attr("data-id");n.push(i),r=="STOP"?e.goCaution(l["\uc911\uc9c0\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],l["\ucee4\ubba4\ub2c8\ud2f0\ub97c \uc911\uc9c0\uc0c1\ud0dc\uc5d0\uc11c\ub294..."],function(){e.go(GO.contextRoot+"ad/api/community/status/stop",JSON.stringify({communityIds:n}),{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200?e.goMessage(f["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):e.goAlert(f["\uc2e4\ud328"],f["\uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])}})},l["\uc911\uc9c0"]):e.go(GO.contextRoot+"ad/api/community/status/online",JSON.stringify({communityIds:n}),{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200?e.goMessage(f["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):e.goAlert(f["\uc2e4\ud328"],f["\uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])}})},detailCancel:function(){var t=this.$el.find("#community_name").attr("data-id");this.render(t),e.goMessage(f["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},backCommunityAll:function(e){n.router.navigate("community/all",{trigger:!0})},communityRemove:function(t){var r=this.$el.find("#community_name").attr("data-id");e.goCaution(l["\uc815\ub9d0 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],l["\ucee4\ubba4\ub2c8\ud2f0\ub97c \uc0ad\uc81c\ud558\uba74..."],function(){e.go(GO.contextRoot+"ad/api/community/"+r+"/remove",JSON.stringify(),{qryType:"DELETE",contentType:"application/json",responseFn:function(t){t.code==200?n.router.navigate("community/all",{trigger:!0}):e.goAlert(f["\uc2e4\ud328"],f["\uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])}})})},getCommunityMember:function(t){this.$el.find("#member_content_page").remove();var n=e(t.currentTarget);this.$el.find(".active").removeClass("active"),n.addClass("active");var r=this.$el.find("#community_name").attr("data-id");this.collection=u.getCollection(r);var s=this.collection.toJSON()||[];s=_.filter(s,function(e){return e.memberStatus=="ONLINE"});var o=function(){return h[this.memberType]},a=function(){return GO.util.basicDate(this.createdAt)},f=i({dataset:s,isDataset:s.length?!0:!1,lang:h,memberTypeName:o,createdAtTime:a,memberPosition:function(){if(this.position!="")return"("+this.position+")"}});this.$el.append(f)},getCommunityBoard:function(t){this.$el.find("#member_content_page").remove();var n=e(t.currentTarget);this.$el.find(".active").removeClass("active"),n.addClass("active");var r=this.$el.find("#community_name").attr("data-id");this.collection=a.getCollection(r);var i=function(){return h[this.type+""]},o=this.collection.toJSON()||[],u=s({dataset:o,boardTotalSize:function(){return GO.util.byteToMega(this.totalSize)},isDataset:o.length?!0:!1,boardTypeName:i,lang:h,masterNameAndPosition:function(){var e=this.managerNames.toString();return e||(e="-"),e.replace(/,/gi,"<br>")}});this.$el.append(u)},setMemberType:function(t){var n=e(t.currentTarget);n.hide(),n.next(".modifyMemberType").show(),n.next(".modifyMemberType").find("select.select_member_type").val(n.attr("data-memberType"))},saveMemberType:function(t){var n=this,r=e(t.currentTarget).parents(".modifyMemberType").siblings("span").attr("data-id"),i=e(t.currentTarget).parents(".modifyMemberType").find("select.select_member_type").val(),s=this.$el.find("#community_name").attr("data-id");e(t.currentTarget).parents(".modifyMemberType").siblings("span").show(),e(t.currentTarget).parents(".modifyMemberType").hide(),GO.EventEmitter.trigger("common","layout:setOverlay","");var o=GO.contextRoot+"ad/api/community/"+s+"/member/"+r+"/"+i;e.ajax({type:"PUT",async:!0,data:JSON.stringify(),dataType:"json",contentType:"application/json",url:o,success:function(t){GO.EventEmitter.trigger("common","layout:clearOverlay",!0),e.goSlideMessage(f["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.getCommunityMember(s),e("#community_member").addClass("active")},error:function(t){GO.EventEmitter.trigger("common","layout:clearOverlay",!0),e.goSlideMessage(f["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."],"caution")}})},cancelMemberType:function(t){e(t.currentTarget).parents(".modifyMemberType").siblings("span").show(),e(t.currentTarget).parents(".modifyMemberType").hide()}});return p});