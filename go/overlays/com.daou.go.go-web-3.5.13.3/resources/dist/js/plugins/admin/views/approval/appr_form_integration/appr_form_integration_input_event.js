define(["app","i18n!nls/commons","i18n!admin/nls/admin","i18n!approval/nls/approval","admin/collections/approval/integration_query","admin/models/approval/integration_query","hgn!admin/templates/approval/appr_form_integration/appr_form_integration_input_event","hgn!admin/templates/approval/appr_form_integration/appr_form_integration_input_event_query","hgn!admin/templates/approval/appr_form_integration/appr_form_integration_input_event_query_item"],function(e,t,n,r,i,s,o,u,a){var f={"\uac12\uc744 \uc785\ub825\ud574 \uc8fc\uc138\uc694":t["\uac12\uc744 \uc785\ub825\ud574 \uc8fc\uc138\uc694"],"\uc0ad\uc81c \ub300\uc0c1\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694":t["\uc0ad\uc81c \ub300\uc0c1\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694"],"\uc774\ubbf8 \ub3d9\uc77c\ud55c \uc774\ub984\uc758 \uc774\ubca4\ud2b8\uac00 \uc788\uc2b5\ub2c8\ub2e4":r["\uc774\ubbf8 \ub3d9\uc77c\ud55c \uc774\ub984\uc758 \uc774\ubca4\ud2b8\uac00 \uc788\uc2b5\ub2c8\ub2e4"],"input Event\uc758 Query\ub97c \uc785\ub825\ud574 \uc8fc\uc138\uc694":r["input Event\uc758 Query\ub97c \uc785\ub825\ud574 \uc8fc\uc138\uc694."],"Event List":"Event List","\ucd94\uac00":t["\ucd94\uac00"],"\uc0ad\uc81c":t["\uc0ad\uc81c"],Query:"Query",Parameters:"Parameters","Param type":"Param type",Return:"Return",STRING:"STRING",NUMBER:"NUMBER",BOOLEAN:"BOOLEAN"},l=Backbone.View.extend({tagName:"li",initialize:function(e){this.options=e||{},this.model=this.options.model,this.$el.data("instance",this)},events:{'click [name="inputEvent"]':"_renderInputEventConfig","click .ic_del":"_inputEventDelete"},render:function(){var e=$("#inputEventAddName").val();this.model.get("name")!=undefined&&(e=this.model.get("name"));var t=['<span class="name" name="inputEvent" data-name="'+e+'">'+e+"</span>",'<span class="btn_wrap"><span class="ic ic_del"></span></span>'];return this.$el.html(t.join("")),this},_renderInputEventConfig:function(e){$("#inputEventList").find("li").removeClass("active"),this.$el.addClass("active"),this.trigger("_renderInputEventConfig",this.model)},_inputEventDelete:function(e){var t=this,n=$(e.target);$(n).closest("li").remove();var r=$("#inputEventQueryList tr:eq(0)").data("instance");if(r){var i=r.model;i==t.model&&this.trigger("_renderInputEventConfig")}},getData:function(){var e={id:this.model.get("id"),name:this.model.get("name"),eventQueries:this.model.get("eventQueries").toJSON(),approvalStep:"CREATE",multiRow:!0};return e}}),c=Backbone.View.extend({tagName:"tr",initialize:function(e){this.options=e||{},this.model=this.options.model,this.queryModel=this.options.queryModel,this.$el.data("instance",this)},events:{"keyup [name=inputEventQuery]":"_saveQuery","blur [name=inputEventQuery]":"_paramSet","keyup [name=returnMethod]":"_saveReturnMethod","keyup [name=parametersName]":"_saveParametersName","change [name=parametersType]":"_saveParametersType"},render:function(){var e=this,t=_.map(e.queryModel.get("parameters"),function(e){return e.dataType=="STRING"?e.isSTRING=!0:e.dataType=="NUMBER"?e.isNUMBER=!0:e.dataType=="BOOLEAN"&&(e.isBOOLEAN=!0),e});return this.$el.empty(),this.$el.append(a({lang:f,model:e.queryModel.toJSON(),parameters:t})),this},_paramSet:function(e){var t=this.queryModel.get("parameters")||[],n=$(e.currentTarget),r=new RegExp(/\?/g),i=n.val().match(r),s=i&&i.length||0,o=s-t.length;t.length<s?(_.each(_.range(o),function(e){t.push({dataType:"STRING",paramName:"",paramType:"VARIABLE",seq:e})}),this.queryModel.set("parameters",t)):t.length>s&&(_.each(_.range(-o),function(e){t.pop()}),this.queryModel.set("parameters",t));var u=this.model.get("eventQueries"),a=u.get(this.queryModel);a.set(this.queryModel.toJSON()),this.model.set("eventQueries",u),this.render()},_saveQuery:function(e){var t=$(e.currentTarget);this.queryModel.set("query",t.val())},_saveReturnMethod:function(e){var t=$(e.currentTarget);this.queryModel.set("returnMethod",t.val())},_saveParametersName:function(e){var t=$(e.currentTarget),n=_.map(this.queryModel.get("parameters"),function(e){return e.seq==t.attr("data-seq")&&(e.paramName=$(t).val()),e});this.queryModel.set("parameters",n)},_saveParametersType:function(e){var t=$(e.currentTarget),n=_.map(this.queryModel.get("parameters"),function(e){return e.seq==t.attr("data-seq")&&(e.dataType=$(t).val()),e});this.queryModel.set("parameters",n)}}),h=Backbone.View.extend({el:"#inputEvent",eventListModel:null,initialize:function(e){this.options=e||{},this.model=this.options.model},events:{"click [name=inputEventAdd]":"_clickBtnInputEventAdd","click .btnRowAdd":"_clickQueryItemAdd","click .btnRowDelete":"_queryItemDelete","click #inputEventAllCheck":"_inputEventAllCheck"},render:function(){var e=this;this.$el.html(o({lang:f})),this.model.get("events").each(function(t){t.set("eventQueries",new i(t.get("eventQueries"))),e._inputEventAdd(t)})},_inputEventAllCheck:function(e){$(e.currentTarget).is(":checked")?_.each(this.$("#inputEventQueryList input[type=checkbox]"),function(e){$(e).attr("checked",!0)}):_.each(this.$("#inputEventQueryList input[type=checkbox]"),function(e){$(e).attr("checked",!1)})},_clickBtnInputEventAdd:function(e){var t=!0,n=this.$("#inputEventAddName").val();if(n=="")return $.goMessage(f["\uac12\uc744 \uc785\ub825\ud574 \uc8fc\uc138\uc694"]),!1;var r=this.$("[name=inputEvent]");_.each(r,function(e){if($(e).attr("data-name")==this.$("#inputEventAddName").val())return t=!1,!1});if(!t)return $.goMessage(f["\uc774\ubbf8 \ub3d9\uc77c\ud55c \uc774\ub984\uc758 \uc774\ubca4\ud2b8\uac00 \uc788\uc2b5\ub2c8\ub2e4"]),!1;if(t){var o=new s({name:n,eventQueries:new i});this._inputEventAdd(o,"new")}},_inputEventAdd:function(e,t){var n=new l({model:e});this.$("#inputEventList").append(n.render().$el),n.on("_renderInputEventConfig",_.bind(this._renderInputEventConfig,this)),t=="new"&&$(n)[0].$el.find("[name=inputEvent]").click(),this.$("#inputEventAddName").val("")},_renderInputEventConfig:function(e){var t=this;this.eventListModel=e,this.$("#inputEventQuery").html(u({lang:f}));var n=this.eventListModel!=undefined?this.eventListModel.get("eventQueries"):null;n&&n.each(function(e){t._queryItemAdd(t.eventListModel,e)})},_clickQueryItemAdd:function(e){var t=this,n=new s({query:"",returnMethod:"",parameters:[]}),r=t.eventListModel.get("eventQueries");r.add(n),this._queryItemAdd(t.eventListModel,n)},_queryItemAdd:function(e,t){var n=new c({model:e,queryModel:t});this.$("#inputEventQueryList").append(n.render().$el)},_queryItemDelete:function(e){var t=this.$('#inputEventQueryList input[type="checkbox"]:checked');if(t.length==0)return $.goMessage(f["\uc0ad\uc81c \ub300\uc0c1\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694"]),!1;_.each(t,function(e){var t=$(e).closest("tr").data("instance"),n=t.model,r=t.queryModel;n.get("eventQueries").remove(r),t.$el.remove()},this),$("#inputEventAllCheck").attr("checked",!1)},getData:function(){var e=[];return this.$("#inputEventList li").each(function(t,n){var r=$(n).data("instance");e.push(r.getData())}),this.model.set("events",e),_.extend({},{events:this.model.get("events")})},validate:function(){var t=!0,s=[];return this.$("#inputEventList li").each(function(e,t){var n=$(t).data("instance");s.push(n.getData())}),(new i(s)).each(function(s){if(s.get("eventQueries").length>0)(new i(s.get("eventQueries"))).each(function(e){if(_.isEmpty(e.get("query")))return $.goMessage(r["input Event\uc758 Query\ub97c \uc785\ub825\ud574 \uc8fc\uc138\uc694"]),t=!1,!1});else if(s.get("eventQueries").length==0)return $.goMessage(e.i18n(n["{{eventName}} event\uc758 Query\uac00 \uc124\uc815 \ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4"],"eventName",s.get("name"))),t=!1,!1}),t}});return h});