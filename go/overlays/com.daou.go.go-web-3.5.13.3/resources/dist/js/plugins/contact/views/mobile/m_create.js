define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("underscore"),i=require("views/mobile/header_toolbar"),s=require("hgn!contact/templates/mobile/m_create"),o=require("hgn!contact/templates/mobile/m_modify"),u=require("contact/models/personal_create_contact"),a=require("contact/models/contact_info"),f=require("contact/models/company_contact_info"),l=require("contact/models/company_create_contact"),c=require("contact/models/company_contact_modify"),h=require("contact/models/contact_modify"),p=require("contact/models/personal_group_info"),d=require("contact/models/company_group_info"),v=require("i18n!nls/commons"),m=require("i18n!nls/user"),g=require("i18n!contact/nls/contact"),y=require("contact/models/dept_contact"),b=require("contact/collections/groups"),w=require("contact/helpers/contacts"),E=require("components/go-fileuploader/mobile");require("jquery.go-validation"),require("GO.util"),require("jquery.cookie"),require("jquery.datepicker");var S=null,x={add_contact:g["\uc5f0\ub77d\ucc98 \ucd94\uac00"],return_home:v["\ud648\uc73c\ub85c \uc774\ub3d9"],not_contact:g["\ub4f1\ub85d\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],name:g["\uc774\ub984(\ud45c\uc2dc\uba85)"],firstName:v["\uc774\ub984"],middleName:g["\uc911\uac04\uc774\ub984"],lastName:g["\uc131"],company:m["\ud68c\uc0ac"],dept:m["\ubd80\uc11c"],position:m["\uc9c1\uc704"],group:g["\uadf8\ub8f9"],group_create:g["\uadf8\ub8f9\ucd94\uac00"],email:m["\uc774\uba54\uc77c"],phone:m["\ud734\ub300\ud3f0"],company_tel:g["\ud68c\uc0ac\uc804\ud654"],company_addr:g["\ud68c\uc0ac\uc8fc\uc18c"],description:g["\uba54\ubaa8"],nickName:g["\uc560\uce6d"],birthday:g["\uc0dd\uc77c"],anniversary:g["\uae30\ub150\uc77c"],home_tel:g["\uc9d1 \uc804\ud654"],home_addr:g["\uc9d1 \uc8fc\uc18c"],home_fax:g["\uc9d1 \ud329\uc2a4"],home_homepage:g["\uc9d1 \ud648\ud398\uc774\uc9c0"],company_fax:g["\ud68c\uc0ac \ud329\uc2a4"],company_homepage:g["\ud68c\uc0ac \ud648\ud398\uc774\uc9c0"],item_add:g["\ud56d\ubaa9\ucd94\uac00"],select_desc:g["\ucd94\uac00\ud560 \ud56d\ubaa9\uc744 \uc120\ud0dd\ud558\uc138\uc694"],photoupload:g["\uc0ac\uc9c4\ub4f1\ub85d"],profilephoto:g["\ud504\ub85c\ud544\uc0ac\uc9c4"],modify:v["\uc218\uc815"],"delete":v["\uc0ad\uc81c"],image:v["\uc0ac\uc9c4"],imageUpload:v["\uc0ac\uc9c4 \uc62c\ub9ac\uae30"],imageUploadInfo:v["\u203b \uc0ac\uc9c4\uc740 \uc790\ub3d9\uc73c\ub85c 100x100 \uc0ac\uc774\uc988\ub85c \uc801\uc6a9 \ub429\ub2c8\ub2e4."]},T=t.View.extend({el:"#content",events:{"change select[name=contactItem]":"selectItem","vclick #groupNameTag li span.ic_del":"deleteGroup","change select[name=selectGroup]":"selectGroup","keyup #contactDescription":"expandTextarea","keyup input[name=firstName]":"checkName","keyup input[name=lastName]":"checkName","keyup input[name=middleName]":"checkName","focusout input[name=firstName]":"checkName","focusout input[name=lastName]":"checkName","focusout input[name=middleName]":"checkName"},initialize:function(e){this.$el.off(),this.type=e.type,this.contactId=e.contactId,this.viewMode=e.viewMode,this.groupId=e.groupId,this.deptId=e.deptId,w.init(e),this.headerToolbarView=i,GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","contact-save",this.saveData,this)},render:function(){this.renderToolbar(),w.isModifyMode()?this.renderModify():this.renderCreate(),this.attachFileUploader()},attachFileUploader:function(){var t={};t.isContact=!0,t.success=function(t){var n=GO.config("isMobileApp")?JSON.parse(t):t.data;e("#contactImage").attr("src",n.thumbnail),e("#contactImage").attr("data-filepath",n.filePath),e("#contactImage").attr("data-filename",n.fileName)},t.error=function(){alert(v["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},E.bind(this.$el.find("#contact-fileuploader"),t)},checkName:function(e){var t=this.$el.find("input[name=firstName]").val(),n=this.$el.find("input[name=lastName]").val(),r=this.$el.find("input[name=middleName]").val(),i=this.$el.find("input[name=name]");n+=" ",r!=""&&(r+=" "),i.val(n+r+t)},renderModify:function(){var e;w.isUser()?(this.groupInfo=p.read({groupId:this.groupId}).toJSON(),e=a.read({contactId:this.contactId})):w.isCompany()?(this.groupInfo=d.read({groupId:this.groupId}).toJSON(),e=new f,e.set({groupId:this.groupId,contactId:this.contactId}),e.fetch({async:!1,error:function(e,t){return!1}})):(e=new y,e.setDeptId(this.deptId),e.set("id",this.contactId),e.fetch({async:!1}));var t=e.toJSON();r.map(t,function(e,n){typeof e=="string"&&!e&&(t[n]=null),typeof e=="object"&&r.map(e,function(e,r){typeof e=="string"&&!e&&(t[n][r]=null)});if(n=="birthday"||n=="anniversary")t[n]=moment(e,"YYYY-MM-DD").format("YYYY-MM-DD");n=="description"&&(typeof e=="string"&&!e?t[n]=null:(w.isModifyMode()?(e=e.replace("<br>",/(\n)/gi),e=e.replace("&nbsp;",/ /gi)):(e=e.replace(/(\n)/gi,"<br>"),e=e.replace(/ /gi,"&nbsp;")),t[n]=e))});var i={lang:x,contextRoot:n.contextRoot,data:t,isCompany:w.isCompany()};w.isCompany()?i.companyGroup=d.read({groupId:this.groupId}).toJSON():i.allGroups=b.getCollection(this.type,this.deptId).toJSON(),this.$el.html(o(i)),this.$el.css("-webkit-tap-highlight-color","")},renderToolbar:function(){var e=this,t={isClose:!0,title:w.isCreateMode()?g["\uc5f0\ub77d\ucc98 \ucd94\uac00"]:g["\uc5f0\ub77d\ucc98 \uc218\uc815"],actionMenu:[{id:"contactSave",text:v["\ud655\uc778"],triggerFunc:"contact-save"}]};this.headerToolbarView.render(t)},saveData:function(){this.preventSameAction(),this.saveContactData(this.contactId)},preventSameAction:function(){e("a[data-trigger=contact-save]").on("vclick",!1)},expandTextarea:function(e){GO.util.textAreaExpand(e)},selectGroup:function(t){var n=e(t.currentTarget).val();if(n=="none")return!0;var r=e(t.currentTarget).find("option:selected").text();e("#groupNameTag").find('li[data-id="'+n+'"]').length?alert(v["\uc774\ubbf8 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):(e("#groupInput").show(),e("#groupName").hide(),e("#groupNameTag").append('<li class="edit" data-id="'+n+'">'+'<input type="hidden" name="groupId" value="'+n+'">'+'<span class="name">'+r+'</span><span class="btn_wrap">'+'<span class="ic ic_del" title="'+v["\uc0ad\uc81c"]+'"></span></span></li>'))},deleteGroup:function(t){e(t.currentTarget).parents("li").remove()},renderCreate:function(){var e=[{value:"nickName",name:g["\uc560\uce6d"]},{value:"birthday",name:g["\uc0dd\uc77c"]},{value:"anniversary",name:g["\uae30\ub150\uc77c"]},{value:"home_tel",name:g["\uc9d1 \uc804\ud654"]},{value:"home_addr",name:g["\uc9d1 \uc8fc\uc18c"]},{value:"home_fax",name:g["\uc9d1 \ud329\uc2a4"]},{value:"home_homepage",name:g["\uc9d1 \ud648\ud398\uc774\uc9c0"]},{value:"company_fax",name:g["\ud68c\uc0ac \ud329\uc2a4"]},{value:"company_homepage",name:g["\ud68c\uc0ac \ud648\ud398\uc774\uc9c0"]}],t={lang:x,optionList:e,contextRoot:n.contextRoot,isMobileApp:GO.config("isMobileApp"),isCompany:w.isCompany()};w.isCompany()?t.companyGroup=d.read({groupId:this.groupId}).toJSON():t.allGroups=b.getCollection(this.type,this.deptId).toJSON(),this.$el.html(s(t))},selectItem:function(t){item=e(t.currentTarget).val();var n=this.$el.find("form[name=formContactCreate]"),r;item=="description"?r=n.find("textarea[name="+item+"]"):r=n.find("input[name="+item+"]"),r.parents("tr").css("display")=="none"&&(r.parents("tr").show(),(item=="birthday"||item=="anniversary")&&this.initializeDatepicker(),e(t.currentTarget).find("option[value="+item+"]").remove())},initializeDatepicker:function(){var t=e("#birthdayDate"),n=e("#anniversaryDate");t.datepicker({defaultDate:"+1w",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:""}),n.datepicker({defaultDate:"+1w",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:""})},saveContactData:function(t){function b(){e("a[data-trigger=contact-save]").off("vclick",!1)}function x(t){function i(){e.goValidation.isCheckLength(2,64,e.trim(t.get("name")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"}),o)}function u(){e.goValidation.isCheckLength(0,255,e.trim(t.get("companyName")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="companyName"]'))}function f(){e.goValidation.isCheckLength(0,255,e.trim(t.get("departmentName")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="departmentName"]'))}function l(){e.goValidation.isCheckLength(0,255,e.trim(t.get("positionName")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="positionName"]'))}function c(){t.get("email").length>0&&(e.goValidation.isValidEmail(t.get("email"))||r(v["\uc774\uba54\uc77c \ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],a),e.goValidation.isCheckLength(0,255,e.trim(t.get("email")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),a))}function h(){t.get("mobileNo").length>0&&(e.goValidation.isCheckLength(0,40,e.trim(t.get("mobileNo")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"40"}),s.find('input[name="mobileNo"]')),e.goValidation.isInvalidTel(t.get("mobileNo"))||r(g["\ubc88\ud638\ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4(-,0~9)"],s.find('input[name="mobileNo"]')))}function p(){t.get("office").tel.length>0&&(e.goValidation.isCheckLength(0,40,e.trim(t.get("office").tel))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"40"}),s.find('input[name="company_tel"]')),e.goValidation.isInvalidTel(t.get("office").tel)||r(g["\ubc88\ud638\ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4(-,0~9)"],s.find('input[name="company_tel"]')))}function d(){e.goValidation.isCheckLength(0,255,e.trim(t.get("office").basicAddress))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="company_basicAddress"]'))}function m(){e.goValidation.isCheckLength(0,255,e.trim(t.get("description")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="description"]'))}function y(){e.goValidation.isCheckLength(0,64,e.trim(t.get("nickName")))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"64"}),s.find('input[name="nickName"]'))}function w(){t.get("home").tel.length>0&&(e.goValidation.isCheckLength(0,40,e.trim(t.get("home").tel))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"40"}),s.find('input[name="home_tel"]')),e.goValidation.isInvalidTel(t.get("home").tel)||r(g["\ubc88\ud638\ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4(-,0~9)"],s.find('input[name="home_tel"]')))}function E(){e.goValidation.isCheckLength(0,255,e.trim(t.get("home").basicAddress))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="home_basicAddress"]'))}function S(){t.get("home").fax.length>0&&(e.goValidation.isCheckLength(0,40,e.trim(t.get("home").fax))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"40"}),s.find('input[name="home_fax"]')),e.goValidation.isInvalidTel(t.get("home").fax)||r(g["\ubc88\ud638\ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4(-,0~9)"],s.find('input[name="home_fax"]')))}function x(){t.get("home").homepage.length>0&&(e.goValidation.isCheckLength(0,255,e.trim(t.get("home").homepage))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="home_homepage"]')),e.goValidation.validateURL(t.get("home").homepage)||r(g["\ud648\ud398\uc774\uc9c0 \uc624\ub958 \uc124\uba85"],s.find('input[name="home_homepage"]')))}function T(){t.get("office").fax.length>0&&(e.goValidation.isCheckLength(0,40,e.trim(t.get("office").fax))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"40"}),s.find('input[name="company_fax"]')),e.goValidation.isInvalidTel(t.get("office").fax)||r(g["\ubc88\ud638\ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4(-,0~9)"],s.find('input[name="company_fax"]')))}function N(){t.get("office").homepage.length>0&&(e.goValidation.isCheckLength(0,255,e.trim(t.get("office").homepage))||r(n.i18n(v["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"255"}),s.find('input[name="office_homepage"]')),e.goValidation.validateURL(t.get("office").homepage)||r(g["\ud648\ud398\uc774\uc9c0 \uc624\ub958 \uc124\uba85"],s.find('input[name="office_homepage"]')))}var r=function(e,t){alert(e);if(t)throw t.focus(),b(),new Error("invalid params")};i(),u(),f(),l(),c(),h(),p(),d(),m(),y(),w(),E(),S(),x(),N(),T()}var i=this,s=this.$el.find("form[name=formContactCreate]"),o=s.find('input[name="name"]'),a=s.find('input[name="email"]'),f={},p={},d=[],m=null;s.find("input:focus").blur().trigger("focusout"),w.isCompany()?t?(m=new c,m.set({groupId:this.groupId,id:t})):(m=new l,m.setGroupId(this.groupId)):w.isUser()?t?(m=new h,m.set("id",t)):m=new u:(m=new y,m.setDeptId(this.deptId),t&&m.set("id",t)),e.each(s.serializeArray(),function(e,t){t.name=="groupId"?d.push(t.value):t.name=="description"?(t.value=t.value.replace(/<br>/gi,""),t.value=t.value.replace(/&nbsp;/gi,""),m.set(t.name,t.value,{silent:!0})):t.name=="company_tel"?p.tel=t.value:t.name=="company_fax"?p.fax=t.value:t.name=="company_addr"?p.basicAddress=t.value:t.name=="company_country"?p.country=t.value:t.name=="company_postalCode"?p.postalCode=t.value:t.name=="company_state"?p.state=t.value:t.name=="company_city"?p.city=t.value:t.name=="company_extAddress"?p.extAddress=t.value:t.name=="company_homepage"?p.homepage=t.value:t.name=="home_tel"?f.tel=t.value:t.name=="home_fax"?f.fax=t.value:t.name=="home_addr"?f.basicAddress=t.value:t.name=="home_country"?f.country=t.value:t.name=="home_postalCode"?f.postalCode=t.value:t.name=="home_state"?f.state=t.value:t.name=="home_city"?f.city=t.value:t.name=="home_extAddress"?f.extAddress=t.value:t.name=="home_homepage"?f.homepage=t.value:t.name=="birthday"&&t.value.length>0?m.set(t.name,GO.util.dateFormatWithoutTimeZone(t.value),{silent:!0}):t.name=="anniversary"&&t.value.length>0?m.set(t.name,GO.util.dateFormatWithoutTimeZone(t.value),{silent:!0}):t.name!="contactItemDesc"&&m.set(t.name,t.value,{silent:!0})}),m.set({office:p,home:f,groupIds:d});var E=e("#contactImage").attr("data-filepath"),S=e("#contactImage").attr("data-filename");(E.length>0||S.length>0)&&m.set({photo:{filePath:E,fileName:S}}),r.isEmpty(r.compact(r.values(p)))||m.set("office",p),r.isEmpty(r.compact(r.values(f)))||m.set("home",f),x(m),m.save({},{async:!1,success:function(t,n){n.code=="200"&&(e("#birthdayDate").blur(),e("#anniversaryDate").blur(),e("#birthdayDate").datepicker("hide"),e("#anniversaryDate").datepicker("hide"),window.history.back())},error:function(e,t){b();var n=JSON.parse(t.responseText);console.error(n.message)}})},imageUpload:function(t){var n=new FormData,r=e(t.currentTarget);n.append("file",r.get(0).files[0]),n.append("GOSSOcookie",e.cookie("GOSSOcookie")),e.ajax({url:GO.contextRoot+"api/file",type:"POST",contentType:!1,processData:!1,data:n,success:function(e){window.attachFileSuccess(e)}})}});return{render:function(e){return S=new T(e),S.render()}}});