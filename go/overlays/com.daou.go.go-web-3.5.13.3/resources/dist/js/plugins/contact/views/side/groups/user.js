define(function(require){function d(t,n){var r=t.closest("section"),s=t.parents("h1"),o=s.find(".ic_side");r.find("ul.side_depth").slideToggle("fast",function(){e(this).css("display")=="block"?(s.removeClass("folded"),o.attr("title",f["\uc811\uae30"])):(s.addClass("folded"),o.attr("title",f["\ud3bc\uce58\uae30"]));var t=!s.hasClass("folded");i.storeCategoryIsOpen(n,t)})}function v(t,n,r){var i=u.defer();return r=_.isArray(r)?r:[r],e.ajax({url:t,type:n,data:JSON.stringify({ids:r}),dataType:"json",contentType:"application/json"}).then(i.resolve,i.reject),i.promise}function m(e){var t=n.config("contextRoot")+"api/contact/personal/group";return v(t,"DELETE",e).then(function(e){console.log("DELETE")})}function g(e){var t=n.config("contextRoot")+"api/contact/personal/group";return v(t,"PUT",e).then(function(e){console.log("REORDER")})}var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("hgn!contact/templates/side_user"),i=require("contact/helpers/local_storage"),s=require("contact/views/side/components/add_group"),o=require("contact/views/side/components/manage_popup"),u=require("when"),a=require("when/sequence");require("jquery.go-popup"),require("jquery.go-validation");var f=require("i18n!nls/commons"),l=require("i18n!contact/nls/contact"),c={USER:l["\uac1c\uc778 \uc8fc\uc18c\ub85d"],COMPANY:l["\uc804\uc0ac \uc8fc\uc18c\ub85d"],DEPARTMENT:l["\ubd80\uc11c \uc8fc\uc18c\ub85d"],contact_group:l["\uc8fc\uc18c\ub85d \uadf8\ub8f9"],group_add:l["\uc5f0\ub77d\ucc98 \uadf8\ub8f9 \ucd94\uac00"],contact_add:l["\uc5f0\ub77d\ucc98 \uc8fc\uc18c\ub85d \ucd94\uac00"],contact_all:l["\uc804\uccb4 \uc8fc\uc18c\ub85d"],contact_manage:l["\uc8fc\uc18c\ub85d \uad00\ub9ac"],group_manage:l["\uadf8\ub8f9\uad00\ub9ac"],fold:f["\uc811\uae30"],open:f["\ud3bc\uce58\uae30"],edit:f["\ud3b8\uc9d1"],modify:f["\uc218\uc815\uc644\ub8cc"],cancel:f["\ucde8\uc18c"],new_contact:l["\uc0c8 \uc5f0\ub77d\ucc98"],contact:l["\uc8fc\uc18c\ub85d"],delete_contact:l["\uc8fc\uc18c\ub85d \uc0ad\uc81c"]},h="personal",p=t.View.extend({tagName:"section",className:"lnb",SIDE_STORE_KEY:n.session("loginId")+"-contact-personal-toggle",events:{"click span.contactTag":"moveLink","click span.groupManage":"groupManage","click .side_toggle":"sideToggle","click span[data-button='manage']":"_companyGroupManage","click .ic_list_reorder":"_changeEditMode","click .editmode.ic_cancel":"_cancelEdit","click .ic_list_del":"_removeGroup","click .editmode.ic_done":"_requestModify"},type:"USER",initialize:function(e){this.actionQueues={},this.$el.attr("data-type","USER"),this.collection=e.collection,this.addGroupView=new s({type:this.type})},render:function(){this.$el.html(r({lang:c,data:this.collection.toJSON(),hasContactCount:function(){return this.contactCount>0},isToggleOpen:i.getStoredCategoryIsOpen(this.SIDE_STORE_KEY)})),this.$el.find("ul.side_depth").append(this.addGroupView.el),this.addGroupView.render(),i.getStoredCategoryIsOpen(this.SIDE_STORE_KEY)||this.$el.find("ul.side_depth").hide()},sideToggle:function(t){var n=e(t.currentTarget);d(n,this.SIDE_STORE_KEY)},moveLink:function(t){function o(e){var t=[];return t.push("contact"),t.push("personal"),e&&t.push(e),t.join("/")}var r=e(t.currentTarget),i=r.closest("li.group").data("id"),s=o.call(this,i);n.router.navigate(s,{trigger:!0,pushState:!0}),n.EventEmitter.trigger("contact","changed:sideGroups")},groupManage:function(){var e=this.$el.closest("section").find("p.on").closest("li"),t=new o({type:this.type,id:e.data("id")});t.render()},_changeEditMode:function(t){var n=this.$el.closest("section"),r=l["\uc5f0\ub77d\ucc98 \uadf8\ub8f9 \ud3b8\uc9d1"],i=null,s;s=this._getActionQueue(h),n.find("h1 > a > span.txt").text(r),n.find("p.on").removeClass("on"),n.find(".ui-state-disabled").hide(),n.addClass("lnb_edit"),n.removeClass("sortable_not"),n.siblings().find(".normalmode").hide(),n.siblings().find(".editmode:not([data-lazyshow])").show(),n.find(".normalmode").hide(),n.find(".editmode:not([data-lazyshow])").show(),n.sortable({items:"li:not(.ui-state-disabled)",axis:"y",start:function(t,n){var r=s.last();e(n.helper).addClass("move"),r&&r.action==="sort"?i=r.index:i=s.placeholder()},stop:function(t,r){var o=[];n.find("li:not(.ui-state-disabled)").each(function(t,n){o.push(e(n).data("id"))}),s.update(i,{ids:o,action:"sort"}),e(r.item).removeClass("move")}}),n.disableSelection()},_getActionQueue:function(e){return this.actionQueues[e]||(this.actionQueues[e]=new y),this.actionQueues[e]},_clearActionQueue:function(e){this.actionQueues[e]&&this.actionQueues[e].clear()},_cancelEdit:function(e){return this._changeNormalMode(),this},_changeNormalMode:function(){this._clearActionQueue(h),n.EventEmitter.trigger("contact","changed:sideGroups")},_removeGroup:function(t){var n=e(t.currentTarget),r=n.closest("li"),i=this._getActionQueue(h),s=i.last();if(s&&s.action==="remove"){var o=_.isArray(s.ids)?s.ids:[s.ids],u=_.isArray(s.elements)?s.elements:[s.elements];o.push(r.data("id")),u.push(r),i.update(s.index,{ids:o,elements:u})}else i.add({ids:[r.data("id")],action:"remove",elements:[r]});r.remove()},_requestModify:function(e){e.preventDefault();var t=this,n=this._getActionQueue(h),r=n.get(),i=[];return _.each(r,function(e){i.push(function(){var n={sort:g,remove:m}[e.action];return n.call(t,e.ids)})},this),a(i).then(function(){return t._changeNormalMode(),u.resolve()})}}),y=function(){var t=function(){this.__index__=0,this.__queue__={}};return t.prototype={get:function(e){return typeof e=="undefined"?_.reject(this.__queue__,function(e){return!e}):this.__queue__[e]},last:function(){return this.__queue__[this.__index__]},placeholder:function(){return this.add(null)},add:function(t){return this.__queue__[++this.__index__]=e.extend(!0,{index:this.__index__},t),this.__index__},update:function(t,n){return this.__queue__.hasOwnProperty(t)&&(this.__queue__[t]=e.extend(!0,this.__queue__[t],n)),this},remove:function(e){return delete this.__queue__[e],this},clear:function(){this.__queue__={}},count:function(){return _.toArray(this.__queue__).length},groupByAction:function(){return _.groupBy(this.get(),function(e){return e.action},this)}},t}();return p});