define(function(require){var e=require("app"),t=require("components/backdrop/backdrop"),n=require("hgn!contact/templates/home"),r=require("hgn!contact/templates/group_modify"),i=require("hgn!contact/templates/copy_contact"),s=require("hgn!contact/templates/contact_null"),o=require("hgn!contact/templates/contact_export"),u=require("hgn!contact/templates/contact_import"),a=require("hgn!contact/templates/contact_import_loading"),f=require("contact/views/create"),l=require("contact/views/search_title"),c=require("contact/views/dept_import"),h=require("contact/views/field_setting_layer"),p=require("contact/views/side/components/manage_popup"),d=require("contact/models/personal_create_contact"),v=require("contact/models/delete_contact"),m=require("contact/models/company_create_contact"),g=require("contact/models/group_info"),y=require("contact/models/group_add"),b=require("contact/models/group_cancel"),w=require("contact/models/import_dept"),E=require("contact/models/contact_list_field"),S=require("contact/models/contact_copy_menu"),x=require("contact/models/contact_copy_menu_groups"),T=require("contact/collections/personal_group"),N=require("contact/collections/company_group"),C=require("contact/collections/dept_group"),k=require("i18n!nls/commons"),L=require("i18n!contact/nls/contact"),A=require("i18n!nls/user"),O=require("file_upload"),M=require("models/dept_profile"),D=require("contact/models/dept_contact");require("jquery.go-grid"),require("jquery.go-popup"),require("jquery.go-validation");var P=null,H={new_contact_desc:L["\uc0c8\ub85c\uc6b4 \uc5f0\ub77d\ucc98\ub97c \ub4f1\ub85d\ud558\uc138\uc694"],new_contact:L["\uc0c8 \uc8fc\uc18c \ub4f1\ub85d\ud558\uae30"],all_contact:L["\uc804\uccb4 \uc8fc\uc18c\ub85d"],search:k["\ud50c\ub808\uc774\uc2a4\ud640\ub354\uac80\uc0c9"],total:k["\uc804\uccb4"],"import":L["\uac00\uc838\uc624\uae30"],"export":L["\ub0b4\ubcf4\ub0b4\uae30"],print:L["\uc778\uc1c4"],group_select:L["\uadf8\ub8f9\uc120\ud0dd"],file_type:L["\ud30c\uc77c\uc720\ud615"],encording:L["\uc778\ucf54\ub529"],"export":L["\ub0b4\ubcf4\ub0b4\uae30"],dup_addr:L["\uc911\ubcf5 \ucc98\ub9ac\ubc29\uc2dd"],all_new:L["\uc0c8\ub85c\ucd94\uac00"],overwrite:L["\ub36e\uc5b4\uc4f0\uae30"],not_add:L["\ucd94\uac00\uc548\ud568"],import_desc:L["\uac00\uc838\uc624\uae30\uc124\uba85"],all:k["\uc804\uccb4"],personal:L["\uac1c\uc778 \uc8fc\uc18c\ub85d"],company:L["\uc804\uc0ac \uc8fc\uc18c\ub85d"],sendMail:L["\uc774 \uadf8\ub8f9\uc5d0\uac8c \uc804\uccb4\uba54\uc77c"],displayname:L["\uc774\ub984(\ud45c\uc2dc\uba85)"],email:A["\uc774\uba54\uc77c"],mobileno:A["\ud734\ub300\ud3f0"],name:k["\uc774\ub984"],companyname:A["\ud68c\uc0ac"],tel:k["\uc804\ud654\ubc88\ud638"],quick:L["\ube60\ub978 \ub4f1\ub85d"],detail:L["\uc0c1\uc138\uc815\ubcf4 \ucd94\uac00"],"delete":k["\uc0ad\uc81c"],mail:L["\uba54\uc77c\ubc1c\uc1a1"],addcontact:L["\uc8fc\uc18c\ucd94\uac00"],addgroup:L["\uadf8\ub8f9\uc9c0\uc815"],file_select:L["\ud30c\uc77c \uc120\ud0dd"],not_select:L["\ubbf8\uc9c0\uc815"],hurigana:L["\ud6c4\ub9ac\uac00\ub098"],company_tel:L["\ud68c\uc0ac\uc804\ud654"],current_print:L["\ud604\uc7ac \ubaa9\ub85d \uc778\uc1c4"],all_print:L["\uc804\uccb4 \ubaa9\ub85d \uc778\uc1c4"],successContact:L["\uc815\uc0c1\uc801\uc73c\ub85c \uac00\uc838\uc628 \uc5f0\ub77d\ucc98"],failContact:L["\uc2e4\ud328\ud55c \uc5f0\ub77d\ucc98"],duplicateContact:L["\uc911\ubcf5\uc8fc\uc18c\uc124\uba85"],contactImportDesc:L["\uac1c\uc758 \uc5f0\ub77d\ucc98\ub97c \uac00\uc838\uc654\uc2b5\ub2c8\ub2e4."],contactImportLodingDesc:L["\uc8fc\uc18c\ub85d \uac00\uc838\uc624\uae30 \uc124\uba85"],import_csv:L["CSV\uc5d0\uc11c \uac00\uc838\uc624\uae30"],import_from_org:L["\uc870\uc9c1\ub3c4\uc5d0\uc11c \uac00\uc838\uc624\uae30"],group:L["\uadf8\ub8f9"],groupCancel:L["\uadf8\ub8f9\ud574\uc81c"],copy:L["\uc8fc\uc18c\ub85d \ubcf5\uc0ac"],department:L["\ubd80\uc11c"],position:L["\uc9c1\uc704"],company_address:L["\ud68c\uc0ac\uc8fc\uc18c"],memo:k["\uba54\ubaa8"],contact:L["\uc8fc\uc18c\ub85d"],copyContactDesc:L["\uc8fc\uc18c\ub85d\uc744 \ubcf5\uc0ac\ud560 \uc704\uce58\ub97c \uc120\ud0dd\ud558\uc138\uc694."],contactGroup:L["\uadf8\ub8f9\uba85"],deptContact:L["\ubd80\uc11c \uc8fc\uc18c\ub85d"],canNotCopyDesc:L["\ubcf5\uc0ac\ud560 \uc218 \uc788\ub294 \uc5f0\ub77d\ucc98 \uadf8\ub8f9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"\ub4f1\ub85d\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4":L["\ub4f1\ub85d\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"\uadf8\ub8f9\uad00\ub9ac":L["\uadf8\ub8f9\uad00\ub9ac"],"\ub354\ubcf4\uae30":L["\ub354\ubcf4\uae30"]},B=null,j=Backbone.View.extend({el:"#content",listEl:null,manage:!1,TYPE:{USER:"USER",COMPANY:"COMPANY",DEPARTMENT:"DEPARTMENT"},isUser:function(){return _.isEqual(this.TYPE.USER,this.type)},isCompany:function(){return _.isEqual(this.TYPE.COMPANY,this.type)},isDept:function(){return _.isEqual(this.TYPE.DEPARTMENT,this.type)},events:{"click #contactMail":"contactMail","click #groupModify":"groupModify","click #contactDelete":"contactDelete","click #groupCancel":"groupCancel","click #quickCreate":"quickCreate","click #detailCreate":"detailCreate","click .contact_detail":"contactDetail","click #contactCreate":"contactCreate","click .tab_nav li[data-param]":"initialSearch","click #sendMailGroup":"sendMailGroup","click #contactExport":"contactExport","click #contactCsvImport":"contactImport","click #contactDeptImport":"contactDeptImport","click #importDisplay":"importDisplay","click #printDisplay":"contactPrintDisplay","click #contactCurrentPrint":"contactPrint","click #contactAllPrint":"contactPrint","click .send_mail":"sendMail","click #copyContact":"_copyButtonClicked","click #popupFieldSetting":"popupFieldSetting","change tbody input":"_toggleCheckAll","change #groups":"groupsFilter","click #manage_company":"companyManage","click #quickRegistToggler":"_toggleQuickRegist","click #seeMore":"_seeMore"},initialize:function(e){this.groupId=e.groupId,this.deptId=e.deptId,this.$el.off(),this.type=e.type,this.groupId&&(this.groupInfo=g.read({groupId:this.groupId}).toJSON()),this.mailExposure=GO.config("mailExposure")},render:function(){this.$el.addClass("go_addr_list");var t=this,r;this.isUser()?r=T.promiseAsync():this.isDept()&&(r=C.promiseAsync(this.deptId));var i=new E({isGetFieldList:!0});$.when(r,i.fetch().done()).then(function(r){var s;t.isCompany()||(s=r.toJSON()),B=i.getContactListFields();var o=n({lang:H,contextRoot:e.contextRoot,info:t.groupInfo,isCompanyManager:t.isCompany()&&t.groupInfo.managable,getSubTitle:function(){if(t.isCompany())return H.company;if(t.isUser())return H.personal;if(t.groupId)return t.groupInfo.deptName+" "+H.contact;var e=M.read(t.deptId);return e.get("name")+" "+H.contact},isGroup:function(){return t.groupId?!0:!1},isAvailableMail:function(){return GO.isAvailableApp("mail")?!0:!1},isLocaleJp:function(){return GO.session().locale=="ja"?!0:!1},isName:function(){return t._checkFieldShowing(B,"NAME")},isPosition:function(){return t._checkFieldShowing(B,"POSITION")},isMobile:function(){return t._checkFieldShowing(B,"MOBILE")},isEmail:function(){return t._checkFieldShowing(B,"EMAIL")},isDepartment:function(){return t._checkFieldShowing(B,"DEPARTMENT")},isCompany:function(){return t._checkFieldShowing(B,"COMPANY")},isCompanyPhone:function(){return t._checkFieldShowing(B,"COMPANY_PHONE")},isCompanyAddress:function(){return t._checkFieldShowing(B,"COMPANY_ADDRESS")},isMemo:function(){return t._checkFieldShowing(B,"MEMO")},isShowGroup:function(){return t._checkFieldShowing(B,"GROUP")},writable:t.isCompany()?t.groupInfo.writable:!0,removable:t.isCompany()?t.groupInfo.removable:!0,contactGroup:s,isCompanyMode:t.isCompany(),mailExposure:t.mailExposure});t.$el.html(o),$("input[placeholder], textarea[placeholder]").placeholder(),t.listEl=t.renderDataTables(t.groupId,t.type,t.deptId),l.render(t.type,t.groupId,t.deptId),GO.session("useOrgAccess")||($("#importDisplay").remove(),$("#importOption").remove())})},_toggleQuickRegist:function(){$("#quickCreateForm .form_speed").slideToggle("fast")},_seeMore:function(){this.backdropView||(this.backdropView=new t,this.backdropView.backdropToggleEl=this.$("div[el-backdrop]"),this.backdropView.linkBackdrop(this.$("a[el-backdrop-link]")))},_checkFieldShowing:function(e,t){var n=!1;return _.each(e,function(e){if(t==e.fieldCode)return n=e.checked,n}),n},companyManage:function(){var e=new p({type:this.type,id:this.groupId,name:this.groupInfo.name,hasChildren:this.groupInfo.hasChildren});e.render()},_copyButtonClicked:function(){function n(t,n,r){var i=this,s=GO.contextRoot+"api/contact/type/"+t+"/copy";this.groupId&&(s=GO.contextRoot+"api/contact/type/"+t+"/group/"+this.groupId+"/copy"),$.ajax({url:GO.contextRoot+"api/contact/type/"+t+"/copy",type:"POST",data:JSON.stringify({groupIds:n==null||n==undefined?n:[n],contactIds:e,deptId:r}),contentType:"application/json",success:function(){i.copyPopup&&i.copyPopup.close(),$.goSlideMessage(L["\ubcf5\uc0ac\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(e){$.goSlideMessage(e.responseJSON.message,"caution")}})}this.copyMenuModel=S.read().toJSON();var e=_.map(this._getCheckedContacts(),function(e){return $(e).val()});if(e.length==0){$.goMessage(L["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var t=this;this.copyPopup=$.goPopup({header:L["\uc8fc\uc18c\ub85d \ubcf5\uc0ac"],modal:!0,width:300,pclass:"layer_normal layer_item_move",contents:i({lang:H}),buttons:[{autoclose:!1,btype:"confirm",btext:k["\ud655\uc778"],callback:function(){var e=t.copyPopup.find("#type option:selected").val(),r=t.copyPopup.find("#selectGroup option:selected").val(),i=t.copyPopup.find("#type option:selected").attr("data-id");n.call(t,e,r,i)}}]}),t.changeTypeSelect(),t.changeGroupSelect(),this.copyPopupUnbindEvents(),this.copyPopupBindEvents()},copyPopupUnbindEvents:function(){this.copyPopup.off()},copyPopupBindEvents:function(){this.copyPopup.on("change","select#type",$.proxy(this.changeGroupSelect,this))},changeTypeSelect:function(){var e="",t=this;$.each(t.copyMenuModel.priority.priorityTypes,function(n,r){!t.isCompany()&&r=="COMPANY"&&t.copyMenuModel.displayCompany&&(e+="<option value='company'>"+H.company+"</option>"),!t.isDept()&&r=="DEPARTMENT"&&t.copyMenuModel.displayDept&&$.each(t.copyMenuModel.deptGroups,function(t,n){e+="<option data-id="+n.deptId+" value='department'>["+n.deptName+"] "+H.deptContact+"</option>"}),!t.isUser()&&r=="USER"&&(e+="<option value='personal'>"+H.personal+"</option>")}),$("#type").html(e)},changeGroupSelect:function(){var e=this.copyPopup.find("#type option:selected").val(),t=this.copyPopup.find("#type option:selected").attr("data-id"),n=x.read({type:e,deptId:t}),r=this;$("#selectGroupLabel").show(),$("#selectGroupDd").show(),r.copyPopup.find(".btn_major_s").css({pointerEvents:"",cursor:"",opacity:""});var i="";$("#canNotCopy").hide(),$("#type option:selected").val()=="company"?($.each(n.toJSON().companyGroups,function(e,t){i+="<option value="+t.id+">"+t.parentPathName+"</option>"}),i==""&&($("#selectGroupLabel").hide(),$("#selectGroupDd").hide(),$("#canNotCopy").show(),r.copyPopup.find(".btn_major_s").css({pointerEvents:"none",cursor:"default",opacity:"0.6"}))):$("#type option:selected").val()=="department"?$.each(n.toJSON().deptGroups,function(e,t){$("#type option:selected").attr("data-id")==t.deptId&&($.each(t.groups,function(e,t){i+="<option value="+t.id+">"+t.name+"</option>"}),t.groups.length<1&&($("#selectGroupLabel").hide(),$("#selectGroupDd").hide()))}):($.each(n.toJSON().personalGroups,function(e,t){i+="<option value="+t.id+">"+t.name+"</option>"}),n.toJSON().personalGroups.length<1&&($("#selectGroupLabel").hide(),$("#selectGroupDd").hide())),$("#selectGroup").html(i)},sendMailGroup:function(e){var t=$(e.currentTarget).parents("h1").children("span.txt").text(),n={to:'"'+t+'"'+"<$"+this.groupId+">"};window.open(GO.contextRoot+"app/mail/popup/process?data="+encodeURIComponent(JSON.stringify(n)),"popupRead"+Math.floor(Math.random()*1e6)+1,"scrollbars=yes,resizable=yes,width=1280,height=760")},_reloadTables:function(e){this.listEl.tables.fnClearTable()},contactDetail:function(t){var n=$(t.currentTarget).attr("data-id"),r={trigger:!0,pushStatus:!0},i;if(!this.groupId){this.isUser()?i="contact/"+n:i="contact/dept/"+this.deptId+"/modify/"+n,e.router.navigate(i,r);return}this.isUser()?i="contact/personal/"+this.groupId+"/modify/"+n:this.isCompany()?i="contact/company/"+this.groupId+"/modify/"+n:i="contact/dept/"+this.deptId+"/group/"+this.groupId+"/modify/"+n,e.router.navigate(i,r)},contactCreate:function(t){var n="";this.groupId?this.isUser()?n="contact/personal/"+this.groupId+"/create":this.isCompany()?n="contact/company/"+this.groupId+"/create":n="contact/dept/"+this.deptId+"/group/"+this.groupId+"/create":this.isUser()?n="contact/create":n="contact/dept/"+this.deptId+"/create",e.router.navigate(n,{trigger:!0,pushState:!0})},renderDataTables:function(t,n,r){function a(){var e;if(this.isDept())e="api/contact/dept/"+r+"/contacts";else if(t){var i={};i[this.TYPE.USER]="personal",i[this.TYPE.COMPANY]="company",e="api/contact/"+i[n]+"/group/"+t+"/contacts"}else e="api/contact/personal/contacts";return e}function f(){var e=[];return this._checkFieldShowing(B,"NAME")&&(e.push({mData:"nameInitialConsonant",bSortable:!0,sClass:"align_l name",fnRender:function(e){var t=GO.util.textToHtml(e.aData.name);return'<span class="photo small"><img src="'+e.aData.thumbSmall+'" title="'+t+'" alt="'+t+'" />'+"</span>"+"<a>"+'<span class="name contact_detail" data-id="'+e.aData.id+'">'+t+"</span>"+"</a>"}}),GO.session().locale=="ja"&&e.push({mData:"nameHurigana",bSortable:!0,sClass:"align_l name",fnRender:function(e){return'<span class="name">'+GO.util.textToHtml(e.aData.nameHurigana)+"</span>"}})),this._checkFieldShowing(B,"POSITION")&&e.push({mData:null,bSortable:!1,sClass:"align_l position",fnRender:function(e){return e.aData.positionName!=undefined?'<span class="positionName">'+GO.util.textToHtml(e.aData.positionName)+"</span>":""}}),this._checkFieldShowing(B,"MOBILE")&&e.push({mData:"mobileNo",bSortable:!1,sClass:"align_l hp",fnRender:function(e){return'<span class="hp">'+GO.util.textToHtml(e.aData.mobileNo)+"</span>"}}),this._checkFieldShowing(B,"EMAIL")&&e.push({mData:"email",bSortable:!0,sClass:"align_l email",fnRender:function(e){return'<a><span class="email send_mail" data-position="'+GO.util.textToHtml(e.aData.positionName)+'" data-department="'+GO.util.textToHtml(e.aData.departmentName)+'" >'+e.aData.email+"</span></a>"}}),this._checkFieldShowing(B,"DEPARTMENT")&&e.push({mData:null,bSortable:!1,sClass:"align_l department",fnRender:function(e){return e.aData.departmentName!=undefined?'<span class="departmentName">'+GO.util.textToHtml(e.aData.departmentName)+"</span>":""}}),this._checkFieldShowing(B,"COMPANY")&&e.push({mData:"companyName",bSortable:!0,sClass:"align_l company",fnRender:function(e){return e.aData.companyName!=undefined?'<span class="company">'+GO.util.textToHtml(e.aData.companyName)+"</span>":""}}),this._checkFieldShowing(B,"COMPANY_PHONE")&&e.push({mData:null,bSortable:!1,sClass:"align_l tel",fnRender:function(e){return e.aData.office!=undefined&&e.aData.office.tel!=undefined?'<span class="tel">'+GO.util.textToHtml(e.aData.office.tel)+"</span>":""}}),this._checkFieldShowing(B,"COMPANY_ADDRESS")&&e.push({mData:null,bSortable:!1,sClass:"align_l company_address",fnRender:function(e){return e.aData.office!=undefined&&e.aData.office.basicAddress!=undefined?'<span class="basicAddress">'+GO.util.textToHtml(e.aData.office.basicAddress)+"</span>":""}}),this._checkFieldShowing(B,"MEMO")&&e.push({mData:null,bSortable:!1,sClass:"align_l memo",fnRender:function(e){return e.aData.description!=undefined?'<span class="description">'+GO.util.textToHtml(e.aData.description)+"</span>":""}}),this._checkFieldShowing(B,"GROUP")&&e.push({mData:null,bSortable:!1,sClass:"align_l group",fnRender:function(e){var t=[];return e.aData.groups==undefined?"":($.each(e.aData.groups,function(e,n){t.push(n.name)}),t.length>0?'<span class="group" title="'+t.join(",")+'">'+GO.util.textToHtml(t.join(","))+"</span>":"")}}),e}var i=this,o={};this.isDept()&&t&&(o.groupId=t);var u=GO.session().locale=="ja"?Math.round(this.$el.width()/6-15):Math.round(this.$el.width()/5-10);return this.goGrid=$.goGrid({el:"#contacts",url:e.contextRoot+a.apply(this),params:o,emptyMessage:s({lang:H}),method:"get",defaultSorting:[[1,"asc"]],checkbox:!0,checkboxData:"id",columns:f.apply(this),fnServerError:function(e){e.status=="403"&&GO.util.error("403")},fnDrawCallback:function(t,n,r){i.$el.find("#contactCount").html(e.i18n(k["\ucd1d\uac74\uc218"],"num",n._iRecordsTotal)),$(window).scrollTop(0),i.groupInfo!=null&&i.isCompany()&&i.groupInfo.writable!=1&&(i.$el.find(".data_null").find("span.txt").text(H["\ub4f1\ub85d\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]),i.$el.find("#contactCreate").remove())}}),this.renderToolbar(),this.goGrid},renderToolbar:function(){var e=L["\ucd08\uc131\uac80\uc0c9"],t=[];t=e.split(",");var n='<ul class="tab_nav small">';$(t).each(function(e,r){e==0?n+='<li data-param="" class="first on"><span>'+r+"</span></li>":e==t.length-1?n+='<li class="last" data-param="'+r+'"><span>'+r+"</span></li>":n+='<li data-param="'+r+'"><span>'+r+"</span></li>"}),n+="</ul>",this.$el.find("#toolBar").html(n),this.$el.find(".tool_bar .custom_header").append(this.$el.find("#toolBar").show()),this.$el.find("#contacts_length").css("margin-top","15px"),this.$el.find("#contacts tr td:first-child,#contacts tr th:first-child").addClass("checkbox");var r=L["\ud544\ub4dc \uc124\uc815"],i='<div class="optional" style="margin-top: 15px;">';i+='<a id="popupFieldSetting" class="btn_tool" data-role="button"><span class="ic_toolbar setting"></span><span class="txt">'+r+"</span> </a>",i+="</div>",this.$el.find("#contacts_wrapper .tool_bar:first").append(i)},initialSearch:function(e){this.listEl.tables.setParam("initialConsonantPattern",$(e.currentTarget).attr("data-param")),$(e.currentTarget).parents("ul.tab_nav").find("li").removeClass("on"),$(e.currentTarget).addClass("on")},contactMail:function(e){if(this._getCheckedContacts().size()==0){$.goMessage(L["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var t=this.listEl.tables.getCheckedData(),n=[];n=$(t).map(function(e,t){var n=$(t.email).find("span.email").text();if(n)return'"'+t.name+'"'+" <"+n+">"}).get();if(!n.length)$.goMessage(L["\uba54\uc77c \uc8fc\uc18c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]);else{var r={to:n.join(",")};window.open(GO.contextRoot+"app/mail/popup/process?data="+encodeURIComponent(JSON.stringify(r)),"popupRead"+Math.floor(Math.random()*1e6)+1,"scrollbars=yes,resizable=yes,width=1280,height=760")}},sendMail:function(e){if(!GO.isAvailableApp("mail"))return;var t=$(e.currentTarget).html(),n=$(e.currentTarget).parents("tr").find(".contact_detail").text(),r=$(e.currentTarget).data("position"),i=$(e.currentTarget).data("department");r=r&&r!="undefined"?"/"+r:"",i=i&&i!="undefined"?"/"+i:"";var s=n+r+i,o={to:'"'+s+'"'+" <"+t+">"};window.open(GO.contextRoot+"app/mail/popup/process?data="+encodeURIComponent(JSON.stringify(o)),"popupRead"+Math.floor(Math.random()*1e6)+1,"scrollbars=yes,resizable=yes,width=1280,height=760")},groupModify:function(e){var t=this;if(this._getCheckedContacts().size()==0){$.goMessage(L["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var n;this.isUser()?n=T.getCollection().toJSON()||[]:n=C.get(this.deptId).toJSON()||[];if(!n.length){$.goMessage(L["\ub4f1\ub85d\ub41c \uadf8\ub8f9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}this.popupEl=$.goPopup({header:L["\uadf8\ub8f9\uc9c0\uc815"],modal:!0,width:"262",pclass:"layer_creat_group layer_normal",contents:r({data:n}),buttons:[{autoclose:!1,btype:"confirm",btext:k["\ud655\uc778"],callback:function(){var e=$("#popupGroupName").find("input:checked"),n=[];e.each(function(){n.push($(this).val())}),t.saveGroups(n),t._reloadTables(),t.popupEl.close()}},{btype:"normal",btext:k["\ucde8\uc18c"],callback:function(){}}]}),this.popupEl.reoffset(),this.popupUnbindEvents(),this.popupBindEvents()},popupUnbindEvents:function(){this.popupEl.off()},popupBindEvents:function(){this.initSWFUpload()},saveGroups:function(e){var t=[];$(this.$el.find("form[name=formContacts]").serializeArray()).each(function(e,n){n.name=="id"&&t.push(n.value)});var n=new y;n.set({groupIds:e,contactIds:t},{silent:!0}),n.save({},{type:"PUT",async:!1,success:function(e,t){t.code=="200"&&($.goMessage(L["\uadf8\ub8f9\uc9c0\uc815 \uc644\ub8cc"]),$("#checkedAll").attr("checked",!1))},error:function(e,t){var n=JSON.parse(t.responseText);$.goMessage(n.message)}})},contactDelete:function(t){var n=this,r=[],i=this.$el.find("form[name=formContacts]"),s=this._getCheckedContacts();if(s.size()==0){$.goMessage(L["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}$(i.serializeArray()).each(function(e,t){t.name=="id"&&r.push(t.value)}),$.goCaution(L["\uc120\ud0dd\ud558\uc2e0 \uc8fc\uc18c\ub85d\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c"],e.i18n(L["\ucd1d 0\uba85 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],"count",s.size()),function(){var e=new v;e.set({ids:r},{silent:!0}),e.save({},{type:"DELETE",success:function(e,t){t.code=="200"&&($.goMessage(k["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n._reloadTables(),$("#checkedAll").attr("checked",!1))},error:function(e,t){var n=JSON.parse(t.responseText);$.goMessage(n.message)}})},k["\ud655\uc778"])},groupCancel:function(t){var n=this,r=[],i=this.$el.find("form[name=formContacts]"),s=this._getCheckedContacts();if(s.size()==0){$.goMessage(L["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}$(i.serializeArray()).each(function(e,t){t.name=="id"&&r.push(t.value)}),$.goCaution(L["\uc120\ud0dd\ud55c \uc5f0\ub77d\ucc98\uc758 \uadf8\ub8f9\uc744 \ud574\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c"],e.i18n(L["\ucd1d 0\uba85 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],"count",s.size()),function(){var e=new b;e.set({groupId:n.groupId,ids:r},{silent:!0}),e.save({},{type:"DELETE",success:function(e,t){t.code=="200"&&($.goMessage(L["\ud574\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n._reloadTables(),$("#checkedAll").attr("checked",!1))},error:function(e,t){var n=JSON.parse(t.responseText);$.goMessage(n.message)}})},k["\ud655\uc778"])},quickCreate:function(t){var n=this,r=$("#quickName").val(),i=$("#quickEmail").val(),s=$("#quickPhone").val(),o=function(e,t){return $.goMessage(e),t&&t.focus(),!1};r==L["\uc774\ub984(\ud45c\uc2dc\uba85)"]&&(r=""),i==A["\uc774\uba54\uc77c"]&&(i=""),s==A["\ud734\ub300\ud3f0"]&&(s="");if(!$.goValidation.isCheckLength(2,64,r))return o(e.i18n(k["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"}),$("#quickName")),!1;if(i.length>0&&!$.goValidation.isValidEmail(i))return o(k["\uc774\uba54\uc77c \ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],$("#quickEmail")),!1;if(s.length>0){if(!$.goValidation.isCheckLength(0,40,s))return o(e.i18n(k["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"40"}),$("#quickPhone")),!1;if(!$.goValidation.isInvalidTel(s))return o(L["\ubc88\ud638\ud615\uc2dd\uc774 \uc62c\ubc14\ub974\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4(-,0~9)"],$("#quickPhone")),!1}var u;this.isUser()?u=new d:this.isCompany()?u=new m:(u=new D,u.setDeptId(this.deptId)),u.set({name:r,mobileNo:s,email:i},{silent:!0});if(this.groupId)if(this.isCompany())u.setGroupId(this.groupId);else{var a=[];a.push(this.groupId),u.set({groupIds:a})}GO.EventEmitter.trigger("common","layout:setOverlay",!0),u.save({},{type:"POST",success:function(e,t){t.code=="200"&&($("#quickEmail").val("").focus().focusout(),$("#quickPhone").val("").focus().focusout(),$("#quickName").val("").focus().focusout(),GO.EventEmitter.trigger("common","layout:clearOverlay",!0),n._reloadTables())},error:function(e,t){GO.EventEmitter.trigger("common","layout:clearOverlay",!0);var n=JSON.parse(t.responseText);$.goMessage(n.message)}})},detailCreate:function(t){var n=$("#quickName").val(),r=GO.util.escapePlaceholder($("#quickEmail")),i=GO.util.escapePlaceholder($("#quickPhone")),s={groupId:this.groupId},o={name:n,email:r,phone:i},u=null;this.isUser()?u="personal":this.isCompany()?u="company":(u="dept",s.deptId=this.deptId);var a=function(e,t){return $.goMessage(e),t&&t.focus(),!1};n==L["\uc774\ub984(\ud45c\uc2dc\uba85)"]&&(n="");if(!$.goValidation.isCheckLength(2,64,n))return a(e.i18n(k["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"}),$("#quickName")),!1;f.render(s,"create",u,o)},contactExport:function(){var e=[{value:"OUTLOOK"},{value:"OUTLOOK_EXPRESS"}];GO.session().locale=="ja"?encording=[{value:"SHIFT-JIS"},{value:"UTF-8"},{value:"EUC-KR"}]:encording=[{value:"EUC-KR"},{value:"UTF-8"},{value:"SHIFT-JIS"}];var t=null;this.isUser()?t=T.getCollection().toJSON()||[]:this.isCompany()?t=N.getCollection().toJSON()||[]:t=C.get(this.deptId).toJSON()||[];var n=this,r=$.goPopup({header:L["\ub0b4\ubcf4\ub0b4\uae30"],modal:!0,width:"240px",pclass:"layer_normal layer_addr_export",contents:o({fileType:e,encording:encording,data:t,isUser:this.isUser(),lang:H}),buttons:[{autoclose:!1,btype:"confirm",btext:k["\ud655\uc778"],callback:function(){var e=$("select[name=groupId] option:selected").val(),t=$("select[name=fileType] option:selected").val(),i=$("select[name=encording] option:selected").val();e=="all"&&(e=null);var s={groupId:e,csvType:t,charset:i,ownerType:n.type};n.isDept()&&(s.deptId=n.deptId),location.href=GO.contextRoot+"api/contact/export?"+n._serializeObj(s),r.close()}},{btype:"normal",btext:k["\ucde8\uc18c"],callback:function(){}}]});this.groupId>0?$("#selectContactExport").val(this.groupId):$("#selectContactExport").val("all")},contactImport:function(){$("#importOption").hide(),this.contactLoadingPopup(L["CSV\uc5d0\uc11c \uac00\uc838\uc624\uae30"]);var e=this.contactJobStatus("contact_import_batch");if(e=="DONE")this.contactImportPopup(),this.popupEl.reoffset();else var t=this,n=setInterval(function(){var e=t.contactJobStatus("contact_import_batch");e=="DONE"&&(t.contactImportPopup(),t.popupEl.reoffset(),clearInterval(n))},2e3)},popupFieldSetting:function(e){var t=this;e.preventDefault();var n=$.goPopup({pclass:"layer_normal",header:L["\ud544\ub4dc \uc124\uc815"],modal:!0,width:300,contents:"",buttons:[{btext:k["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){t.savePopupFieldSetting(),e.close()}},{btext:k["\ucde8\uc18c"],btype:"cancel"}]});return this.fieldSettingLayerView=new h({isGetFieldList:!0,toRemoveColumns:this.toRemoveColumns}),n.find(".content").append(this.fieldSettingLayerView.el),this.fieldSettingLayerView.render().done(function(){n.reoffset()}),!1},savePopupFieldSetting:function(){var e=this,t=this.fieldSettingLayerView.getData();$.ajax({url:GO.config("contextRoot")+"api/contact/fields",contentType:"application/json",async:!0,data:JSON.stringify(t),type:"POST",dataType:"json",success:function(t){e.render(e.groupId,e.groupType)}})},contactImportPopup:function(){var t=this,n=[{value:"Outlook"},{value:"Outlook_Express"}],r=[{value:"UTF-8"},{value:"EUC-KR"},{value:"SHIFT-JIS"}],i=null,s=null;this.isUser()?i=T.getCollection().toJSON()||[]:this.isCompany()?i=N.getCollection().toJSON()||[]:i=C.get(this.deptId).toJSON(),this.popupEl=$.goPopup({header:L["CSV\uc5d0\uc11c \uac00\uc838\uc624\uae30"],modal:!1,pclass:"layer_normal layer_addr_import",contents:u({fileType:n,data:i,isCompany:this.isCompany(),lang:H,contextRoot:e.contextRoot,ownerType:this.type}),buttons:[{autoclose:!1,btype:"confirm",btext:k["\ud655\uc778"],callback:function(){var e=$("form[name=importForm]"),n={path:$("#filePath").attr("data-filepath"),groupId:e.find('select[name="groupId"]').val(),ownerType:e.find('input[name="ownerType"]').val(),csvType:e.find('select[name="csvType"]').val(),charset:e.find('select[name="charset"]').val(),writeType:e.find('input[name="writeType"]:radio:checked').val(),deptId:t.deptId},r=t._serializeObj(n);$.go(GO.contextRoot+"api/contact/import?"+r,"",{qryType:"GET",contentType:"application/json",responseFn:function(e){if(e.code=="200"){t.contactLoadingPopup(L["CSV\uc5d0\uc11c \uac00\uc838\uc624\uae30"]);var n=setInterval(function(){var e=t.contactJobStatus("contact_import_batch");e=="DONE"&&(t.popupEl.close(),$.goSlideMessage(L["\uac00\uc838\uc624\uae30 \uc644\ub8cc"]),t.reloadContact(),clearInterval(n))},2e3)}},error:function(e){var t=JSON.parse(e.responseText);t.name=="exceed.contact"?$.goSlideMessage(t.message,"caution"):$.goSlideMessage(L["\uac00\uc838\uc624\uae30\uc2e4\ud328"],"caution")}})}},{btype:"normal",btext:k["\ucde8\uc18c"],callback:function(){}}]}),this.popupEl.find(".btn_major_s").hide(),this.groupId&&this.popupEl.find("#selectContactImport").val(this.groupId),this.popupEl.reoffset(),this.popupUnbindEvents(),this.popupBindEvents()},contactDeptImport:function(){function r(){t.contactDeptImportPopup();var n=new c({type:e,groupId:t.groupId,deptId:t.deptId});n.render(),t.popupEl.reoffset()}function i(){var e=t.contactJobStatus("contact_import_dept_batch");return e=="DONE"}var e=this.type,t=this;$("#importOption").hide(),this.contactLoadingPopup(L["\uc870\uc9c1\ub3c4\uc5d0\uc11c \uac00\uc838\uc624\uae30"]);if(i())r();else var n=setInterval($.proxy(this,function(){i()&&(r(),clearInterval(n))}),2e3)},contactDeptImportPopup:function(){var e=this;this.popupEl=$.goPopup({header:L["\uc870\uc9c1\ub3c4\uc5d0\uc11c \uac00\uc838\uc624\uae30"],modal:!1,pclass:"layer_normal layer_address",width:"1000px",buttons:[{autoclose:!1,btype:"confirm",btext:k["\ud655\uc778"],callback:function(){userIds=[],deptIds=[],$.each($("#mailReceive ul li"),function(e,t){$(t).hasClass("user")&&userIds.push($(t).attr("data-userid"));if($(t).hasClass("group")){var n=0;$(t).attr("data-sub")=="true"&&(n=1),deptIds.push($(t).attr("data-id")+"_"+n)}});var t=$('input[name="writeType"]:radio:checked').val(),n=[];$.each($("#groupNameTag li[data-id]"),function(e,t){n.push($(t).find("input").val())}),this.model=new w,this.model.set({userIds:userIds,deptIds:deptIds,writeType:t,groupIds:n,ownerType:e.type,ownerDeptId:e.deptId},{silent:!0}),this.model.save({},{type:"POST",success:function(t,n){if(n.code=="200"){e.contactLoadingPopup(L["\uc870\uc9c1\ub3c4\uc5d0\uc11c \uac00\uc838\uc624\uae30"]);var r=setInterval(function(){var t=e.contactJobStatus("contact_import_dept_batch");t=="DONE"&&(e.popupEl.close(),$.goSlideMessage(L["\uac00\uc838\uc624\uae30 \uc644\ub8cc"]),e.reloadContact(),clearInterval(r))},2e3)}},error:function(e,t){var n=JSON.parse(t.responseText);$.goError(n.message)}})}},{btype:"normal",btext:k["\ucde8\uc18c"],callback:function(){}}]})},contactLoadingPopup:function(e){this.popupEl=$.goPopup({header:e,lang:H,modal:!1,pclass:"layer_normal layer_import_info",contents:a({lang:H})})},contactJobStatus:function(e){var t;return $.ajax({type:"GET",async:!1,dataType:"json",url:GO.contextRoot+"api/contact/job/status/"+e,success:function(e){t=e.data.jobStatus},error:function(e){$.goError(e.responseJSON.message)}}),t},contactPrint:function(e){$("#contactPrintOption").hide();var t=$(e.currentTarget).attr("data-type");sessionStorage.setItem("contactPrintOffset",this.goGrid.listParams.offset),t=="all"&&sessionStorage.setItem("contactPrintOffset",9999),sessionStorage.setItem("contactPrintPage",this.goGrid.listParams.page),sessionStorage.setItem("groupId",this.groupId),sessionStorage.setItem("deptId",this.deptId),sessionStorage.setItem("contactPrintDirection",this.goGrid.listParams.direction),sessionStorage.setItem("type",this.type),sessionStorage.setItem("contactPrintProperty",this.goGrid.listParams.property),sessionStorage.setItem("initialConsonantPattern",this.goGrid.listParams.initialConsonantPattern);var n=GO.contextRoot+"app/contact/print";window.open(n,"","location=no, directories=no, resizable=yes, status=no, toolbar=no, menubar=no, width=1280, height=650, left=0, top=0, scrollbars=yes")},contactPrintDisplay:function(){var e=$("#contactPrintOption");e.css("display")=="none"?e.show():e.hide()},importDisplay:function(){var e=$("#importOption");e.css("display")=="none"?e.show():e.hide()},reloadContact:function(){var t=e.router.getUrl();if(t.search("contact")==-1)return;if(t.search("create")>0)return;e.router.navigate(t,{trigger:!0,pushState:!0,replace:!0})},_serializeObj:function(e){var t=[];for(var n in e)e[n]!=undefined&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},initSWFUpload:function(){var e=this;(new O({el:"#swfupload-control",context_root:GO.config("contextRoot"),button_text:"<span class='buttonText'>"+k["\ud30c\uc77c \ucca8\ubd80"]+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie")})).queue(function(e,t){}).start(function(e,t){var n=new RegExp("(csv)","gi"),r=t.type.split(".")[1].toLowerCase();if(!n.test(r))return $.goMessage(L["csv \ud30c\uc77c\ub9cc \uac00\ub2a5\ud569\ub2c8\ub2e4"]),!1;if(t.size>5242880)return $.goMessage(k["\ucca8\ubd80\ud30c\uc77c \uc6a9\ub7c9\uc740 5MB\uc774\ud558 \uc785\ub2c8\ub2e4."]),!1}).progress(function(e,t){}).success(function(t,n){var r=n.data,i=r.fileName,s=r.filePath;if(GO.util.isFileSizeZero(n))return $.goAlert(GO.util.serverMessage(n)),!1;$("#fileName").text(i),$("#fileName").prepend('<span class="ic_file ic_def"></span>'),$("#filePath").attr("data-filepath",s),e.popupEl.find(".btn_major_s").show()}).complete(function(e,t){}).error(function(e,t){})},_getCheckedContacts:function(){return this.$('tbody input[type="checkbox"]:checked')},_toggleCheckAll:function(){var e=!0;_.each(this.$("tbody").find("input"),function(t){$(t).is(":checked")||(e=!1)}),this.$("#checkedAll").attr("checked",e)},groupsFilter:function(e){var t;this.isDept()?t="groupId":t="groupsFilter",this.changeFilter(e,t)},changeFilter:function(e,t){var n=$(e.currentTarget).val();typeof this.listEl.tables.setParam=="function"&&this.listEl.tables.setParam(t,n)}});return{render:function(e,t,n){return P=new j({groupId:e,type:t,deptId:n}),P.render()}}});