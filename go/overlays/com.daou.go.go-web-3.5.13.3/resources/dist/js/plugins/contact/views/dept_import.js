define(function(require){var e=require("app"),t=require("jquery"),n=require("underscore"),r=require("backbone"),i=require("hgn!contact/templates/dept_import"),s=require("hgn!contact/templates/dept_import_list"),o=require("hgn!contact/templates/group_create"),u=require("i18n!nls/commons"),a=require("i18n!contact/nls/contact"),f=require("i18n!nls/user"),l=require("contact/models/create_group"),c=require("contact/models/group_info"),h=require("contact/collections/personal_group"),p=require("contact/collections/dept_group"),d=require("contact/collections/contacts_org_member");require("jquery.placeholder"),require("jquery.jstree");var v,m={use_help:a["\uc8fc\uc18c\ub85d \uc0ac\uc6a9 \uc124\uba85"],all:u["\uc804\uccb4"],search:u["\uac80\uc0c9"],user:u["\uc0ac\uc6a9\uc790"],group:u["\uadf8\ub8f9"],etc:u["\uae30\ud0c0"],remove:u["\uc0ad\uc81c"],organization:a["\uc870\uc9c1\ub3c4"],search_null:u["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"],list_more:u["\ub354\ubcf4\uae30"],lowDeptInclude:u["\ud558\uc704\ubd80\uc11c\ud3ec\ud568"],user:u["\uc0ac\uc6a9\uc790"],name:u["\uc774\ub984"],dept:f["\ubd80\uc11c"],position:f["\uc9c1\uc704"],email:f["\uc774\uba54\uc77c"],company:f["\ud68c\uc0ac"],dup_addr:a["\uc911\ubcf5 \ucc98\ub9ac\ubc29\uc2dd2"],all_new:a["\uc0c8\ub85c\ucd94\uac00"],overwrite:a["\ub36e\uc5b4\uc4f0\uae30"],not_add:a["\ucd94\uac00\uc548\ud568"],import_desc:a["\uac00\uc838\uc624\uae30\uc124\uba85"],group_create:a["\uadf8\ub8f9\ucd94\uac00"],contact_group:a["\uc8fc\uc18c\ub85d \uadf8\ub8f9"],dept_import_desc:a["\ubd80\uc11c \uac00\uc838\uc624\uae30 \uc124\uba85"],new_group:a["\uc0c8 \uadf8\ub8f9"]};return v=r.View.extend({el:".go_popup .content",className:"content layer_address",isCompany:function(){return this.type=="COMPANY"},isUser:function(){return this.type=="USER"},isDept:function(){return this.type=="DEPARTMENT"},events:{"click #groupCreate":"groupCreate","click #searchTab":"searchTab","click #receiveGroup":"sendGroup","click #receiveUser":"sendUser","keydown #contactSearch1":"searchKeyboardEvent","click #contactSearch2":"search","click .btn_list_reload":"listMore","click #contactChkAll":"contactChkAll","click ul span.ic_list_del":"deleteItem","click input.lowDeptChk":"chkLowDeptInclude","click #contactTable tr td[class!='checkbox']":"selectLow","click #groupNameTag li span.ic_del":"deleteGroup"},initialize:function(){var e=this.options;this.type=e.type,this.groupId=e.groupId,this.deptId=e.deptId,this.addrSearchPlaceHolder=m.name+"/"+m.email+"/"+m.company,this.orgSearchPlaceHolder=m.name+"/"+m.user_id+"/"+m.dept+"/"+m.position+"/"+m.title+"/"+m.phone,this.groupId&&(this.groupInfo=c.read({groupId:this.groupId}).toJSON())},render:function(){var e=t.extend(!0,{},{lang:m});this.$el.empty().append(i(e)),this.renderOrgTree(),this.setGlobalMethod(),this.changeSearchPlaceHolder(this.addrSearchPlaceHolder),this.$el.find("span.lowDeptCheck").hide(),this.existCompanyGroups(),this.groupInfo&&this.popupGroupNameAdd(this.groupInfo.name,this.groupInfo.id),this.isCompany()&&(this.$el.find("#groupCreate").remove(),this.$el.find("#groupNameTag").find(".btn_wrap").remove())},selectLow:function(e){var n=t(e.currentTarget).parents("tr").first(),r=n.find("input"),i=r.is(":checked");n.find("input[type=checkbox]").not("[disabled]").attr("checked",!i)},chkLowDeptInclude:function(e){var n=t(e.currentTarget),r=n.parents("li").first().attr("data-id"),i=n.parents("li").first().attr("data-deptname"),s="0",o="";n.is(":checked")?(s="1",n.parents("li").first().attr("data-sub","true")):(s="0",n.parents("li").first().attr("data-sub","false")),o='"'+i+'" <'+r+"_"+s+">",n.parents("li").first().find("label:first").html(o)},contactChkAll:function(e){var n=t(e.currentTarget).is(":checked");t("#contactTable").find("tbody input[type=checkbox]").not("[disabled]").attr("checked",n)},renderOrgTree:function(){var e=this;t(".bottom_action").hide(),this.orgTree=this.$el.find("#org-tree").empty().jstree({plugins:["themes","json_data","ui","crrm","cookies","types"],core:{animation:120},json_data:{ajax:{url:function(e){return typeof e.data=="function"?GO.contextRoot+"api/"+"organization/dept":GO.contextRoot+"api/"+"organization/multi/list"},data:function(t){if(typeof t.data=="function"){var n=t.data();return{deptid:n?n.id:e.loadId}}return{type:"mydept",scope:"dept"}},cache:!0,async:!0,success:function(t){try{if(t==null){var n=["<tr>","<td class='null_data' colspan='6'>","<span>"+m.search_null+"</span>","</td>","</tr>"].join("");e.$el.find(".scroll_wrap>table>tbody").empty(),e.$el.find(".scroll_wrap>table>tbody").append(n)}}catch(r){console.info(r)}}}},core:{animation:120},"defaults ":{html_titles:!1,move_node:!1,ccp:!0,width:200},ui:{select_multiple_modifier:!1,select_limit:1},hotkeys:{del:e._deleteDept,f2:function(){return!1}},types:{max_depth:10,max_children:10,valid_children:["root"],start_drag:!1,move_node:!1,start_drag:!1,move_node:!1,delete_node:!1,remove:!1,types:{root:{valid_children:["org"],start_drag:!1,move_node:!1,delete_node:!1,remove:!1},org:{max_depth:10,max_children:10,valid_children:["org"],start_drag:!0,move_node:!0,delete_node:!0,remove:!0}}}}).bind("loaded.jstree",function(e,t){}).bind("load_node.jstree",function(t,n,r){e.orgTree.find('a[href="#"]').attr("data-bypass",1)}).bind("select_node.jstree",t.proxy(e.renderOrgMember,e)),t.go(GO.contextRoot+"api/user/profile/"+GO.session("id"),"",{qryType:"GET",async:!1,contentType:"application/json",responseFn:function(t){var n=t.data.deptMembers[0].deptId,r=t.data.deptMembers[0].deptName;e.drawOrgMemger(n,r),setTimeout(function(){e.orgTree.find('a[nodeid="'+n+'"]').addClass("jstree-clicked"),n&&(e.selectedDeptData={},e.selectedDeptData.id=n,e.selectedDeptData.name=r)},500)},error:function(e){}})},drawOrgMemger:function(e,n){var r=this;this.keyword=null,this.collection=d.getCollection(e,null,0);var i=this.collection.toJSON(),o=s({data:i,lang:m,isEmail:function(){return this.email.length?!0:!1},departmentName:function(){return n},positionName:function(){return this.position},isOrgAccess:GO.session("useOrgAccess")});this.$("#contactChkAll").attr("checked",!1),t(".scroll_wrap>table>tbody").empty(),t(".scroll_wrap>table>tbody").append(o),this.collection.page.lastPage?t(".bottom_action").hide():(t(".bottom_action").show(),t(".bottom_action").attr("data-param","org"),t(".bottom_action").attr("data-deptid",e),t(".bottom_action").attr("data-deptname",n))},renderOrgMember:function(e,n){var r=this;n.inst.toggle_node(n.rslt.obj[0]),this.selectedDeptData=t(n.rslt.obj[0]).data(),this.drawOrgMemger(this.selectedDeptData.id,this.selectedDeptData.name)},existCompanyGroups:function(){t.ajax({type:"GET",async:!1,dataType:"json",url:GO.contextRoot+"api/contact/company/group/exist",success:function(e){e.data||t("#companyGroups").remove()},error:function(e){t.goError(e.responseJSON.message)}})},setGlobalMethod:function(){window.getAddrRcptList=function(){var e={},n=t("#mailReceive label.mailInfo").map(function(){return t(this).text()}).get();e.toList=n;var r=t("#mailCC label.mailInfo").map(function(){return t(this).text()}).get();e.ccList=r;var i=t("#hiddenCC label.mailInfo").map(function(){return t(this).text()}).get();return e.bccList=i,e}},receiveGroup:function(){},sendUser:function(e){var n=t(".scroll_wrap").find('tbody input[type="checkbox"]:checked');if(n.length==0){t.goMessage(a["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var r=t(e.currentTarget).attr("id"),i=t("#mailReceive ul");r=="receiveUser"?i=t("#mailReceive ul"):r=="mailCCUser"?i=t("#mailCC ul"):r=="hiddenCCUser"&&(i=t("#hiddenCC ul"));var s=0;i.find("li").each(function(){t(this).html()==""&&(s++,t(this).remove())});var o=null;t.each(n,function(){var e=t(this).attr("data-email"),n=t(this).attr("data-name"),r=t(this).attr("data-deptname"),s=t(this).attr("data-position"),u=t(this).attr("data-userid"),a=t(this).attr("data-nodetype");if(!e.length)return!0;if(a=="department")return!0;var f=[n];r!=""&&f.push(r),s!=""&&f.push(s),i.find('li[data-userid="'+u+'"]').length?o=o?!0:!1:(i.append('<li class="user" data-userid="'+u+'">'+'<label class="mailInfo" title="'+n+" : "+e+'">"'+f.join("/")+'" &lt'+e+"&gt</label>"+'<span class="list_side_wrap">'+'<span class="btn_wrap"><span class="ic_side ic_list_del"></span></span>'+"</span>"+"</li>"),o=!0)}),o?t.goMessage(u["\ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],"message"):o==0&&t.goMessage(u["\uc774\ubbf8 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]);var f=s-n.length;if(f>0)for(var l=0;l<f;l++)i.append("<li></li>")},deleteItem:function(e){e.stopPropagation();var n=t(e.currentTarget),r=n.parents("ul").find("li").length-1,i=n.parents("div").first().attr("id"),s;n.closest("li").remove();if(r<6){s=6-r;for(var o=0;o<s;o++)t("#"+i).find("ul").append("<li></li>")}},sendGroup:function(e){var n=null;if(t('li[data-type="personalGroups"] a.jstree-clicked').length)n=t('li[data-type="personalGroups"] a.jstree-clicked').parent();else if(t('li[data-type="companyGroups"] a.jstree-clicked').length)n=t('li[data-type="companyGroups"] a.jstree-clicked').parent();else{if(!this.orgTree)return;t("#org-tree").find("a").hasClass("jstree-clicked")?n=this.orgTree.jstree("get_selected"):n=t(".scroll_wrap").find('tbody input[data-nodetype="department"][type="checkbox"]:checked')}if(n.length==0){t.goMessage(a["\uc120\ud0dd\ub41c \uadf8\ub8f9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var r=t(e.currentTarget).attr("id"),i=t("#mailReceive ul");r=="receiveGroup"?i=t("#mailReceive ul"):r=="mailCCGroup"?i=t("#mailCC ul"):r=="hiddenCCGroup"&&(i=t("#hiddenCC ul"));var s=0;i.find("li").each(function(){t(this).html()==""&&(s++,t(this).remove())});var o=n.data("id"),f=!1,l="";l='<div style="padding-left:20px">'+m.lowDeptInclude+"</div>";var c=n.data("name");i.find("li[data-id="+o+"]").length?t.goMessage(u["\uc774\ubbf8 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):i.append('<li class="group" data-deptname="'+c+'" data-id="'+o+'" data-sub="false"><label class="mailInfo">"'+c+'" &lt'+o+"_0&gt</label>"+'<span class="list_side_wrap">'+'<input type="checkbox" class="lowDeptChk" id="'+c+o+'"><label class="depth" for="'+c+o+'">'+m.lowDeptInclude+"</label>"+'<span class="btn_wrap">'+'<span class="ic_side ic_list_del"></span>'+"</span>"+"</span>"+"</li>");if(s>1)for(var h=0;h<s-1;h++)i.append("<li></li>")},searchTab:function(e){var n=t(e.currentTarget);if(n.hasClass("ui-state-active"))return;t(e.currentTarget).parents("ul").find("li").removeClass("ui-state-active"),n.addClass("ui-state-active"),t("#initialWord").hide(),t("#moveTab").addClass("move_wrap_noindex"),t("#isSearchHierarchy").hide(),this.tabContentChange("userSearch"),type=="personal"?(this.$el.find(".bottom_action").attr("data-deptname",""),this.changeSearchPlaceHolder(this.addrSearchPlaceHolder)):this.changeSearchPlaceHolder(this.orgSearchPlaceHolder);var r=["<tr>",'<td class="null_data" colspan="6">',"<span>"+m.search_null+"</span>","</td>","</tr>"].join("");this.$el.find(".scroll_wrap>table>tbody").empty(),this.$el.find(".scroll_wrap>table>tbody").append(r)},changeSearchPlaceHolder:function(e){t("#contactSearch1").val(""),t("#contactSearch1").attr("placeholder",e),t("#contactSearch1").attr("title",e),t("input[placeholder], textarea[placeholder]").placeholder()},tabContentChange:function(e){e=="userSearch"?t("#mailAddressWrap").addClass("mail_address_search"):t("#mailAddressWrap").removeClass("mail_address_search")},searchKeyboardEvent:function(e){e.keyCode==13&&this.search()},search:function(){var n=this.$el.find(".search_wrap input"),r=n.val();if(r==""){t.goMessage(u["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."]);return}this.keyword=r,this.selectedDeptData=undefined;if(!t.goValidation.isCheckLength(2,64,r)){t.goMessage(e.i18n(u["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"}));return}var i=null;this.collection=null,this.collection=d.getCollection(0,r,0),i=this.collection.toJSON();var o={data:i,lang:m,isEmail:function(){return this.email.length||this.nodeType=="department"?!0:!1}};o.positionName=function(){return this.position?this.position:""},o.departmentName=function(){return this.departments?this.departments.join(","):""},o.userId=function(){return this.id?this.id:""},this.orgTree.jstree("deselect_all");var a=s(o);this.$el.find(".scroll_wrap>table>tbody").empty(),this.$el.find(".scroll_wrap>table>tbody").append(a);if(this.collection.page.lastPage)this.$el.find(".bottom_action").hide();else{var f={ORG:"org",USER:"contacts",COMPANY:"company"};this.$el.find(".bottom_action").show(),this.$el.find(".bottom_action").attr("data-param",f[ownerType]),this.$el.find(".bottom_action").attr("data-type","search")}t("#contactSearch1").val(""),t("#initialWord").hide()},listMore:function(e){var t=this,n=this.$el.find(".bottom_action").attr("data-deptname");this.collection=d.getCollection(this.$el.find(".bottom_action").attr("data-deptid"),this.keyword,this.collection.page.page+1);var r=this.collection.toJSON(),i={data:r,lang:m,isEmail:function(){return this.email.length?!0:!1},departmentName:n,isOrgAccess:GO.session("useOrgAccess")};i.positionName=function(){return this.position?this.position:""},i.departmentName=function(){return this.departments?this.departments.join(","):t.selectedDeptData?t.selectedDeptData.name:""},i.userId=function(){return this.id?this.id:""};var o=s(i);this.$el.find(".scroll_wrap>table>tbody").append(o),this.collection.page.lastPage?this.$el.find(".bottom_action").hide():this.$el.find(".bottom_action").show()},groupCreate:function(){var e;this.isUser()?e=h.getCollection().toJSON()||[]:e=p.get(this.deptId).toJSON(),this.popupEl=t.goPopup({header:a["\uadf8\ub8f9\ucd94\uac00"],pclass:"layer_creat_group layer_normal",width:"280px",allowPrevPopup:"true",contents:o({data:e,lang:m})}),this.popupEl.reoffset(),this.popupUnbindEvents(),this.popupBindEvents()},popupUnbindEvents:function(){this.popupEl.off()},popupBindEvents:function(){this.popupEl.on("click","#popupGroupAdd",t.proxy(this.popupGroupAdd,this)),this.popupEl.on("click",".popupGroupName",t.proxy(this.popupGroupName,this)),this.popupEl.on("click","#popupGroupCreate",t.proxy(this.popupGroupCreate,this)),this.popupEl.on("click","#popupGroupCancel",t.proxy(this.popupGroupCancel,this))},popupGroupAdd:function(e){var n=t(e.currentTarget).parents("ul.group_tag").children("li.edit");n.css("display")=="none"?n.show():t.goAlert(a["1\uac1c \uc774\uc0c1 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."])},popupGroupCreate:function(n){var r=this,i=t(n.currentTarget).parents("li.edit").children("input").val(),s=function(e,n){return t.goMessage(e),n&&n.focus(),!1};if(!t.goValidation.isCheckLength(2,16,i))return s(e.i18n(u["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"16"}),t(n.currentTarget).parents("li.edit").children("input")),!1;this.model=new l({type:r.type}),this.model.set({name:i,deptId:this.deptId},{silent:!0}),this.model.save({},{type:"POST",success:function(e,s){s.code=="200"&&(r.popupGroupNameAdd(i,s.data.id),GO.EventEmitter.trigger("contact","changed:sideGroups"),t(n.currentTarget).parents("li.edit"),t(".group_tag li.edit").before('<li class="popupGroupName" data-id="'+s.data.id+'"><a data-bypass="">'+i+"</a></li>"),r.popupGroupCancel(n))},error:function(e,n){var r=JSON.parse(n.responseText);t.goMessage(r.message)}})},popupGroupCancel:function(e){t(e.currentTarget).parents("li.edit").hide().children("input").val("")},popupGroupNameAdd:function(e,n){t("#groupNameTag li.creat").parent().append("<li data-id="+n+'><input type="hidden" name="groupId" value='+n+'><span class="name">'+e+'</span><span class="btn_wrap"><span class="ic_classic ic_del" title="'+u["\uc0ad\uc81c"]+'"></span></span></li>')},popupGroupName:function(e){var n=t(e.currentTarget).attr("data-id"),r=t(e.currentTarget).children("a").text(),i=t("#groupNameTag");i.find('li[data-id="'+n+'"]').length?t.goMessage(u["\uc774\ubbf8 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):t("#groupNameTag li.creat").parent().append("<li data-id="+n+'><input type="hidden" name="groupId" value='+n+'><span class="name">'+r+'</span><span class="btn_wrap"><span class="ic_classic ic_del" title="'+u["\uc0ad\uc81c"]+'"></span></span></li>')},deleteGroup:function(e){t(e.currentTarget).parents("li").remove(),this.showModifyBtn()}}),v});