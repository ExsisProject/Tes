define(function(require){var e=require("jquery"),t=require("underscore"),n=require("backbone"),r=require("i18n!nls/commons"),i=require("i18n!contact/nls/contact"),s=require("hgn!contact/templates/connector"),o=require("hgn!contact/templates/connector_add"),u=require("hgn!contact/templates/connector_add_group"),a=require("hgn!contact/templates/connector_add_user"),f=require("contact/views/tab_book/main"),l=require("contact/views/tab_book/components/type_manager");require("jquery.jstree");var c={receiver:i["\ubc1b\ub294\uc0ac\ub78c"],mail_cc:i["\ucc38\uc870"],private_cc:i["\uc228\uc740\ucc38\uc870"],use_help:i["\uc8fc\uc18c\ub85d \uc0ac\uc6a9 \uc124\uba85"],user:r["\uc0ac\uc6a9\uc790"],group:r["\uadf8\ub8f9"],lowDeptInclude:r["\ud558\uc704\ubd80\uc11c\ud3ec\ud568"]},h=n.View.extend({className:"content layer_address",events:{},initialize:function(t){function s(t){try{var n=r.connectorInfoView.getSelectedGroup()}catch(s){e.goSlideMessage(i["\uc120\ud0dd\ub41c \uadf8\ub8f9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"caution");return}t.callback(n.data,t.target,n.groupType)}function o(t){try{var n=r.connectorInfoView.getSelectedUsers()}catch(s){e.goSlideMessage(i["\uc120\ud0dd\ub41c \uc0ac\uc6a9\uc790\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],"caution");return}t.callback(n,t.target)}this.options=t||{},this.target=this.options.target;var n=new l({localStorageKey:"contact-connector-type"});this.connectorInfoView=new f({mode:"MAIL",tabArea:"#tabArea",infoArea:"#infoArea",typeManager:n}),this.addView=new p({typeManager:n}),this.$el.off();var r=this;this.addView.on({"click.addGroup":s,"click.addUser":o})},render:function(){!t.isUndefined(window.GO_Notification)&&!t.isUndefined(window.GO_Notification.disconnect)&&window.GO_Notification.disconnect();var n=e.extend(!0,{},{lang:c});return this.$el.empty().append(s(n)),this.connectorInfoView.render(),this.$el.find("#addArea").html(this.addView.render()),this.setGlobalMethod(),this.target=="all"&&(t.isFunction(parent.removeProcessLoader)&&parent.removeProcessLoader(),e("#mailReceive").css("overflow","auto")),!1},setGlobalMethod:function(){var e=this;window.getAddrRcptList=function(){var t={};return t.toList=e.addView.getRecevieList(),t.ccList=e.addView.getCCList(),t.bccList=e.addView.getHiddenCCList(),t}}}),p=n.View.extend({events:{"click span.addGroup":"_onClickAddGroup","click span.addUser":"_onClickAddUser","click span.ic_list_del":"_onClickDelete","click input.lowDeptChk":"chkLowDeptInclude"},ITEM_MIN_LENGTH:4,initialize:function(e){this.typeManager=e.typeManager},render:function(){var e=o({lang:c});return this.$el.html(e),this.$el},_onClickAddGroup:function(t){var n=e(t.currentTarget).data("target");this.trigger("click.addGroup",{callback:e.proxy(this.addGroup,this),target:n})},_onClickAddUser:function(t){var n=e(t.currentTarget).data("target");this.trigger("click.addUser",{callback:e.proxy(this.addUsers,this),target:n})},addGroup:function(n,r,i){var s=this.$el.find("div[data-target='"+r+"']");t.each(n,function(n){function l(n,r,i){var s=this.$el.find("div[data-target='"+n+"'] li").map(function(){return e(this).data("id")}).get(),o;return i=="GROUP"?o="$":o="#",o+=r.dataId,t.indexOf(s,o)<0?!1:!0}if(l.call(this,r,n,i))return;var o=u({data:n,isOrg:function(){return i=="ORG"},lang:c,dataKey:function(){return i=="ORG"?'"'+this.dataName+'" <#'+this.dataId+"_1>":'"'+this.dataName+'" <$'+this.dataId+">"}});if(this._isReplaceAdd(r)){var a=this._findEmptyIndex(r),f=s.find("li");e(f[a]).replaceWith(o)}else s.find("ul").append(o)},this)},addUsers:function(n,r){var i=this.$el.find("div[data-target='"+r+"']");t.each(n,function(n){function c(n,r){var i=this.$el.find("div[data-target='"+n+"'] li").map(function(){return e(this).data("email")}).get();return t.indexOf(i,r.email)<0?!1:!0}if(c.call(this,r,n))return;var s=[];n.name&&s.push(n.name),n.position&&s.push(n.position),n.deptName&&s.push(n.deptName);var o=s.join("/"),u=a({data:n,summeryInfo:o,dataKey:'"'+o+'" <'+n.email+">",mailExposure:GO.config("mailExposure")||this.typeManager.getType()!="ORG"});if(this._isReplaceAdd(r)){var f=this._findEmptyIndex(r),l=i.find("li");e(l[f]).replaceWith(u)}else i.find("ul").append(u)},this)},chkLowDeptInclude:function(t){var n=e(t.currentTarget),r=n.parents("li").first().attr("data-id"),i=n.parents("li").first().attr("data-deptname"),s="0",o="";n.is(":checked")?s="1":s="0",o='"'+i+'" <'+r+"_"+s+">",n.parents("li").first().find("label:first").html(o),n.parents("li").first().attr("data-key",o)},_findEmptyIndex:function(t){var n=this._getItems(t);for(var r=0;r<n.length;r++)if(e(n[r]).html()=="")return r;return n.length},_isReplaceAdd:function(t){var n=this._getItems(t),r;for(var i=0;i<n.length;i++)if(e(n[i]).html()==""){r=i;break}return r<this.ITEM_MIN_LENGTH?!0:!1},_getItems:function(e){var t=this.$el.find("div[data-target='"+e+"']"),n=t.find("li");return t.find("li"),n},_onClickDelete:function(t){var n=e(t.currentTarget).closest("li"),r=n.closest("ul");n.remove();var i=r.find("li").length;for(var s=i;s<this.ITEM_MIN_LENGTH;s++)r.append("<li></li>")},getRecevieList:function(){return this._getTypeList("RECEVIE")},getCCList:function(){return this._getTypeList("MAIL_CC")},getHiddenCCList:function(){return this._getTypeList("HIDDEN_CC")},_getTypeList:function(t){var n=this.$el.find("div[data-target='"+t+"'] li label.mailInfo").map(function(){return e(this).parent().attr("data-key")}).get();return n}});return h});