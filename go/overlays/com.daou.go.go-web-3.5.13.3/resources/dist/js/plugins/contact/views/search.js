define(function(require){var e=require("app"),t=require("hgn!contact/templates/search"),n=require("hgn!contact/templates/group_modify"),r=require("hgn!contact/templates/search_null"),i=require("contact/views/search_title"),s=require("contact/collections/personal_group"),o=require("contact/collections/dept_group"),u=require("contact/models/company_group_info"),a=require("contact/models/group_add"),f=require("contact/models/delete_contact"),l=require("contact/models/contact_list_field"),c=require("i18n!nls/commons"),h=require("i18n!contact/nls/contact"),p=require("i18n!nls/user");require("jquery.go-grid"),require("jquery.go-popup"),require("jquery.go-validation");var d=null,v={new_contact_desc:h["\uc0c8\ub85c\uc6b4 \uc5f0\ub77d\ucc98\ub97c \ub4f1\ub85d\ud558\uc138\uc694\ub85d"],search_null:h["\uac80\uc0c9\uc5b4\uc640 \uc77c\uce58\ud558\ub294 \uc5f0\ub77d\ucc98\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"],new_contact:h["\uc0c8 \uc8fc\uc18c \ub4f1\ub85d\ud558\uae30"],all_contact:h["\uc804\uccb4 \uc8fc\uc18c\ub85d"],total:c["\uc804\uccb4"],name:c["\uc774\ub984"],email:p["\uc774\uba54\uc77c"],mobileno:p["\ud734\ub300\ud3f0"],companyname:p["\ud68c\uc0ac"],tel:c["\uc804\ud654\ubc88\ud638"],personal:h["\uac1c\uc778 \uc8fc\uc18c\ub85d"],company:h["\uc804\uc0ac \uc8fc\uc18c\ub85d"],dept:h["\ubd80\uc11c \uc8fc\uc18c\ub85d"],all:c["\uc804\uccb4"],searchresult:c["\uac80\uc0c9\uacb0\uacfc"],searchword:c["\uac80\uc0c9\uc5b4"],contacttype:h["\uc8fc\uc18c\ub85d \uad6c\ubd84"],"delete":c["\uc0ad\uc81c"],mail:h["\uba54\uc77c\ubc1c\uc1a1"],addgroup:h["\uadf8\ub8f9\uc9c0\uc815"],hurigana:h["\ud6c4\ub9ac\uac00\ub098"],company_tel:h["\ud68c\uc0ac\uc804\ud654"],group:h["\uadf8\ub8f9"],department:h["\ubd80\uc11c"],position:h["\uc9c1\uc704"],company_address:h["\ud68c\uc0ac\uc8fc\uc18c"],memo:c["\uba54\ubaa8"]},m=Backbone.View.extend({el:"#content",listEl:null,manage:!1,isUser:function(){return this.type=="USER"},isCompany:function(){return this.type=="COMPANY"},isDept:function(){return this.type=="DEPARTMENT"},events:{"click .contact_detail":"contactDetail","click #contactMail":"contactMail","click #groupModify":"groupModify","click #contactDelete":"contactDelete","click .send_mail":"sendMail"},initialize:function(){this.$el.off(),this.searchParams=e.router.getSearch(),this.groupId=this.searchParams.groupId,this.deptId=this.searchParams.deptId,this.type=this.searchParams.ownerType.toUpperCase(),this.$el.addClass("go_addr_list"),this.contactFieldModel=new l({isGetFieldList:!0})},render:function(){var n=!0;this.type&&(n=!1);var r=this;this.contactFieldModel.fetch({dataType:"json",contentType:"application/json",success:function(s){d=s.getContactListFields();var o=t({lang:v,contextRoot:e.contextRoot,isOneItem:n,data:$.extend(r.searchParams,{name:r.searchParams.name||v.all,email:r.searchParams.email||v.all,mobileNo:r.searchParams.mobileNo||v.all,companyName:r.searchParams.companyName||v.all,officeTel:r.searchParams.officeTel||v.all}),getContactType:function(){return r.isUser()?v.personal:r.isCompany()?v.company:v.dept},isLocaleJp:function(){return GO.session().locale=="ja"?!0:!1},isName:function(){return r._checkFieldShowing(d,"NAME")},isPosition:function(){return r._checkFieldShowing(d,"POSITION")},isMobile:function(){return r._checkFieldShowing(d,"MOBILE")},isEmail:function(){return r._checkFieldShowing(d,"EMAIL")},isDepartment:function(){return r._checkFieldShowing(d,"DEPARTMENT")},isCompany:function(){return r._checkFieldShowing(d,"COMPANY")},isCompanyPhone:function(){return r._checkFieldShowing(d,"COMPANY_PHONE")},isCompanyAddress:function(){return r._checkFieldShowing(d,"COMPANY_ADDRESS")},isMemo:function(){return r._checkFieldShowing(d,"MEMO")},isShowGroup:function(){return r._checkFieldShowing(d,"GROUP")}});r.$el.html(o),r.listEl=r.renderDataTables(),r.isCompany()&&(_.isUndefined(r.groupId)?$.ajax({type:"GET",async:!1,dataType:"json",url:GO.contextRoot+"api/contact/checkadmin",success:function(e){e.data||$("#contactDelete").remove()}}):(r.groupInfo=u.read({groupId:r.groupId}).toJSON(),r.groupInfo.updatable!=1&&$("#contactDelete").remove()),$("#groupModify").remove()),i.render(r.type,r.groupId,r.deptId),r._selectSideMenu()}})},contactDetail:function(t){function o(){return this.groupId?"contact/personal/"+this.groupId+"/modify/"+n:"contact/"+n}function u(){var e=this.groupId;return e||_.each(this.collection,function(t){t.id==n&&(e=t.groups[0].id)}),"contact/company/"+e+"/modify/"+n}function a(){return this.groupId?"contact/dept/"+this.deptId+"/group/"+this.groupId+"/modify/"+n:"contact/dept/"+this.deptId+"/modify/"+n}var n=$(t.currentTarget).attr("data-id"),r={trigger:!0,pushState:!0},i={USER:o,COMPANY:u,DEPARTMENT:a},s=i[this.type].call(this);e.router.navigate(s,r)},sendMail:function(e){if(!GO.isAvailableApp("mail"))return;var t=$(e.currentTarget).text(),n=$(e.currentTarget).parents("tr").find(".contact_detail").text(),r=$(e.currentTarget).data("position"),i=$(e.currentTarget).data("department");r=r&&r!="undefined"?"/"+r:"",i=i&&i!="undefined"?"/"+i:"";var s=n+r+i,o={to:'"'+s+'"'+" <"+t+">"};window.open(GO.contextRoot+"app/mail/popup/process?data="+encodeURIComponent(JSON.stringify(o)),"popupRead"+Math.floor(Math.random()*1e6)+1,"scrollbars=yes,resizable=yes,width=1280,height=760")},_selectSideMenu:function(){var e=this.groupId,t=$("#side");t.find(".on").removeClass("on");if(t.find('li[data-group-id="'+e+'"]').size()==1){t.find('li[data-group-id="'+e+'"]').children("p.title").addClass("on");return}if(this.isUser()){t.find("section[data-type='USER'] p.title:first").addClass("on");return}t.find("section[data-type='DEPARTMENT'] li[data-dept-id='"+this.deptId+"']").find("ul p.title:first").addClass("on");return},_reloadTables:function(e){this.listEl.tables.fnClearTable()},renderDataTables:function(){var t=this,n=e.router.getSearch().name,i=e.router.getSearch().email,s=e.router.getSearch().mobileNo,o=e.router.getSearch().companyName,u=e.router.getSearch().officeTel,a=location.href.split("?")[1],f=[];if(t._checkFieldShowing(d,"NAME")){var l=GO.session().locale=="ja"?Math.round(this.$el.width()/6-15):Math.round(this.$el.width()/5-10);f.push({mData:"nameInitialConsonant",sWidth:l<180?l:180,bSortable:!0,sClass:"align_l name",fnRender:function(e){return n==undefined||e.aData.name.toLowerCase().indexOf(n.toLowerCase())==-1?'<a><span class="name contact_detail" data-id="'+e.aData.id+'">'+e.aData.name+"</span></a>":'<a><span class="name contact_detail" data-id="'+e.aData.id+'"><strong class="txt_key">'+e.aData.name+"</strong></span></a>"}}),GO.session().locale=="ja"&&f.push({mData:"nameHurigana",sWidth:l<150?l:150,bSortable:!0,sClass:"align_l name",fnRender:function(e){return'<a><span class="name">'+e.aData.nameHurigana+"</strong></span></a>"}})}t._checkFieldShowing(d,"POSITION")&&f.push({mData:null,bSortable:!1,sClass:"align_l position",fnRender:function(e){return e.aData.positionName!=undefined?'<span class="positionName">'+GO.util.textToHtml(e.aData.positionName)+"</span>":""}}),t._checkFieldShowing(d,"MOBILE")&&f.push({mData:"mobileNo",sWidth:l<150?l:150,bSortable:!1,sClass:"align_l hp",fnRender:function(e){return s==undefined||e.aData.mobileNo.indexOf(s)==-1?'<span class="hp">'+e.aData.mobileNo+"</span>":'<span class="hp"><strong class="txt_key">'+e.aData.mobileNo+"</string></span>"}}),t._checkFieldShowing(d,"EMAIL")&&f.push({mData:"email",bSortable:!0,sClass:"align_l email",mRender:function(e){return i==undefined||e.toLowerCase().indexOf(i.toLowerCase())==-1?'<a><span class="email send_mail">'+e+"</span></a>":'<a><span class="email send_mail"><strong class="txt_key">'+e+"</string></span></a>"}}),t._checkFieldShowing(d,"DEPARTMENT")&&f.push({mData:null,bSortable:!1,sClass:"align_l department",fnRender:function(e){return e.aData.departmentName!=undefined?'<span class="departmentName">'+GO.util.textToHtml(e.aData.departmentName)+"</span>":""}}),t._checkFieldShowing(d,"COMPANY")&&f.push({mData:"companyName",sWidth:l<170?l:170,bSortable:!0,sClass:"align_l company",fnRender:function(e){return o==undefined||e.aData.companyName.toLowerCase().indexOf(o.toLowerCase())==-1?'<span class="company">'+e.aData.companyName+"</span>":'<span class="company"><strong class="txt_key">'+e.aData.companyName+"</string></span>"}}),t._checkFieldShowing(d,"COMPANY_PHONE")&&f.push({mData:null,sWidth:l<150?l:150,bSortable:!1,sClass:"align_l tel",fnRender:function(e){return e.aData.office!=undefined?u==undefined||e.aData.office.tel.indexOf(u)==-1?'<span class="tel">'+e.aData.office.tel+"</span>":'<span class="tel"><strong class="txt_key">'+e.aData.office.tel+"</string></span>":""}}),t._checkFieldShowing(d,"COMPANY_ADDRESS")&&f.push({mData:null,bSortable:!1,sClass:"align_l company_address",fnRender:function(e){return e.aData.office!=undefined&&e.aData.office.basicAddress!=undefined?'<span class="basicAddress">'+e.aData.office.basicAddress+"</span>":""}}),t._checkFieldShowing(d,"MEMO")&&f.push({mData:null,bSortable:!1,sClass:"align_l memo",fnRender:function(e){return e.aData.description!=undefined?'<span class="description">'+e.aData.description+"</span>":""}}),t._checkFieldShowing(d,"GROUP")&&f.push({mData:null,sWidth:l<150?l:150,bSortable:!1,sClass:"align_l group",fnRender:function(e){var t=[];return e.aData.groups==undefined?"":($.each(e.aData.groups,function(e,n){t.push(n.name)}),t.length>0?'<span class="group">'+t.join(",")+"</span>":"")}});var h=$.goGrid({el:"#contacts",url:e.contextRoot+"api/contact/search?"+a,emptyMessage:r({lang:v}),method:"get",defaultSorting:[[1,"asc"]],checkbox:!0,checkboxData:"id",columns:f,fnDrawCallback:function(n,r,i){t.$el.find("#contactCount").html(e.i18n(c["\ucd1d\uac74\uc218"],"num",r._iRecordsTotal))},fnServerSuccess:function(e){t.collection=e.data}});return this.renderToolbar(),h},renderToolbar:function(){this.$el.find(".tool_bar .custom_header").append(this.$el.find("#contactSearchTool").html()),this.$el.find("#contacts tr td:first-child,#contacts tr th:first-child").addClass("checkbox")},contactMail:function(e){var t=this.$el.find("form[name=formContacts]"),n=t.find('tbody input[type="checkbox"]:checked');if(n.size()==0){$.goMessage(h["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var r=this.listEl.tables.getCheckedData(),i=[];i=$(r).map(function(e,t){if(t.email)return'"'+t.name+'"'+" <"+t.email+">"}).get();if(!i.length)$.goMessage(h["\uba54\uc77c \uc8fc\uc18c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]);else{var s={to:i.join(",")};window.open(GO.contextRoot+"app/mail/popup/process?data="+encodeURIComponent(JSON.stringify(s)),"popupRead"+Math.floor(Math.random()*1e6)+1,"scrollbars=yes,resizable=yes,width=1280,height=760")}},groupModify:function(e){var t=this,r=this.$el.find("form[name=formContacts]"),i=r.find('tbody input[type="checkbox"]:checked');if(i.size()==0){$.goMessage(h["\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}var u;this.isUser()?u=s.getCollection().toJSON()||[]:u=o.get(this.deptId).toJSON()||[];if(!u.length){$.goMessage(h["\ub4f1\ub85d\ub41c \uadf8\ub8f9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}this.popupEl=$.goPopup({header:h["\uadf8\ub8f9\uc9c0\uc815"],modal:!0,width:"240px",pclass:"layer_creat_group layer_normal",contents:n({data:u}),buttons:[{autoclose:!1,btype:"confirm",btext:c["\ud655\uc778"],callback:function(){var e=$("#popupGroupName").find("input:checked"),n=[];e.each(function(){n.push($(this).val())}),t.saveGroups(n),t._reloadTables(),t.popupEl.close()}},{btype:"normal",btext:c["\ucde8\uc18c"],callback:function(){}}]}),this.popupEl.reoffset(),this.popupUnbindEvents(),this.popupBindEvents()},popupUnbindEvents:function(){this.popupEl.off()},popupBindEvents:function(){this.initSWFUpload()},saveGroups:function(e){var t=this,n=[],r=this.$el.find("form[name=formContacts]");$(r.serializeArray()).each(function(e,t){t.name=="id"&&n.push(t.value)}),this.model=new a,this.model.set({groupIds:e,contactIds:n},{silent:!0}),this.model.save({},{type:"PUT",success:function(e,n){n.code=="200"&&($.goMessage(c["\uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t._reloadTables(),t.popupEl.close())},error:function(e,t){var n=JSON.parse(t.responseText);$.goMessage(n.message)}})},_checkFieldShowing:function(e,t){var n=!1;return _.each(e,function(e){if(t==e.fieldCode)return n=e.checked,n}),n},contactDelete:function(t){var n=this,r=[];form=this.$el.find("form[name=formContacts]"),contactEl=form.find('tbody input[type="checkbox"]:checked');if(contactEl.size()==0){$.goMessage("\uc120\ud0dd\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.");return}$(form.serializeArray()).each(function(e,t){t.name=="id"&&r.push(t.value)}),$.goCaution(h["\uc120\ud0dd\ud558\uc2e0 \uc8fc\uc18c\ub85d\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c"],e.i18n(h["\ucd1d 0\uba85 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],"count",contactEl.size()),function(){this.model=new f,this.model.set({ids:r},{silent:!0}),this.model.save({},{type:"DELETE",success:function(e,t){t.code=="200"&&($.goMessage(c["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n._reloadTables(),$("#checkedAll").attr("checked",!1))},error:function(e,t){var n=JSON.parse(t.responseText);$.goMessage(n.message)}})})}});return{render:function(){var e=new m;return e.render()}}});