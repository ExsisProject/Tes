define(function(require){var e=require("backbone"),t=require("i18n!contact/nls/contact"),n=require("hgn!contact/templates/tab_book/connector_group"),r=require("hgn!contact/templates/tab_book/connector_group_dept_side"),i=require("contact/views/tab_book/detail/contact"),s=require("contact/views/tab_book/toolbar/initial_bar"),o=require("collections/joined_depts"),u=require("contact/collections/dept_group");require("jquery.go-sdk");var a={totalContact:t["\uc804\uccb4 \uc8fc\uc18c\ub85d"]},f=e.View.extend({type:"DEPARTMENT",initialize:function(e){this.deptSideView=new l,this.detailView=new i({type:this.type,mode:e.mode}),this.initialView=new s,this.initialView.on("click.initialWord",$.proxy(function(e){this.detailView.refresh({initial:e})},this)),this.deptSideView.on("click.deptSideView",$.proxy(function(e){this.detailView.refresh({groupId:e.groupId,deptId:e.deptId,type:this.type}),this.initialView.show(),this.initialView.reset()},this)),this.detailView.on("detail.search",$.proxy(function(){this.initialView.hide()},this))},render:function(){this.$el.html(n());var e=this.$el.find("#contactWrap");e.append(this.deptSideView.el),e.append(this.detailView.el),this.$el.append(this.initialView.el),this.detailView.render(),this.deptSideView.render(),this.initialView.render()},getSelectedGroup:function(){return this.deptSideView.getSelectedGroup()},getSelectedUsers:function(){return this.detailView.getSelectedUsers()}}),l=e.View.extend({className:"content_tab_wrap",template:"<div id='group-tree' style='height:350px' class='jstree jstree-default'><ul></ul></div>",events:{"click #group-tree li.contact_group":"_onClickSideGroup"},initialize:function(){},render:function(){this.$el.html(this.template),this._renderTree(),this.$el.find("#group-tree li:first").find("li:first").trigger("click")},_renderTree:function(){function f(e){var n=[];return _.each(e,function(e){var r=u.get(e.id);t=r.toJSON(),t.length&&(t[t.length-1].isGroupLast=!0),n.push({id:e.id,name:e.name,groups:t})}),n}function l(e){return r({data:e,lang:a})}var e=this.$el.find("#group-tree").jstree("destroy").addClass("jstree jstree-default").html("<ul />").find("ul"),t=[],n=o.fetch().toJSON(),i=f(n);i.length&&(i[i.length-1].isDeptLast=!0);var s=l(i);e.html(s)},_onClickSideGroup:function(e){function i(){t.closest("#group-tree").find("a").removeClass("jstree-clicked"),t.find("a").addClass("jstree-clicked")}var t=$(e.currentTarget);i();var n=t.data("group-id"),r=t.closest("li.dept-node").data("dept-id");this.trigger("click.deptSideView",{groupId:n,deptId:r})},getSelectedGroup:function(){var e=this.$el.find("#group-tree a.jstree-clicked").closest("li"),t=e.data("group-id"),n=e.data("name");if(!t)throw new Error("not select group");return{data:[{dataId:t,dataName:n}],groupType:"GROUP"}}});return f});