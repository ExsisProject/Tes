define(function(require){var e=require("app"),t=require("backbone"),n=require("i18n!nls/commons"),r=require("i18n!contact/nls/contact"),i=require("hgn!contact/templates/tab_book/connector_group"),s=require("contact/views/tab_book/detail/org");require("jquery.jstree"),require("jquery.go-sdk");var o={search_null:n["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"]},u=t.View.extend({type:"ORG",initialize:function(e){this.detailView=new s({type:this.type,mode:e.mode}),this.orgSideView=new a,this.orgSideView.on({"click.orgSideView":$.proxy(function(e){this.detailView.refresh({deptId:e.deptId,deptName:e.deptName,type:this.type})},this)}),this.detailView.on({"click.search":$.proxy(function(){this.orgSideView.releaseNode()},this)})},render:function(){this.$el.html(i());var e=this.$el.find("#contactWrap");e.append(this.orgSideView.el),e.append(this.detailView.el),this.orgSideView.render(),this.detailView.render()},getSelectedGroup:function(){var e=this.orgSideView.getSelectedGroup();_.isEmpty(e)&&(e=this.detailView.getSelectedGroup());if(_.isEmpty(e)){$.goSlideMessage(r["\uc120\ud0dd\ub41c \uadf8\ub8f9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"caution");return}return e},getSelectedUsers:function(){return this.detailView.getSelectedUsers()}}),a=t.View.extend({className:"content_tab_wrap",template:"<div id='group-tree' style='height:350px' class='jstree jstree-default'><ul></ul></div>",initialize:function(){},render:function(){this.$el.html(this.template),this.renderTree()},renderTree:function(){var t=this,n=this.$el.find("#group-tree"),r=$.Deferred();this.orgTree=n.empty().jstree({plugins:["themes","json_data","ui","crrm","cookies","types"],core:{animation:120},json_data:{ajax:{url:function(t){return typeof t.data=="function"?e.contextRoot+"api/"+"organization/dept":e.contextRoot+"api/"+"organization/multi/list"},data:function(e){if(typeof e.data=="function"){var n=e.data();return{deptid:n?n.id:t.loadId}}return{type:"mydept",scope:"dept"}},cache:!0,async:!0,success:function(e){try{if(e==null){var n=["<tr>","<td class='null_data' colspan='6'>","<span>"+o.search_null+"</span>","</td>","</tr>"].join("");t.$el.find(".scroll_wrap>table>tbody").empty(),t.$el.find(".scroll_wrap>table>tbody").append(n)}}catch(r){console.info(r)}}}},core:{animation:120},"defaults ":{html_titles:!1,move_node:!1,ccp:!0,width:200},ui:{select_multiple_modifier:!1,select_limit:1},hotkeys:{del:t._deleteDept,f2:function(){return!1}},types:{max_depth:10,max_children:10,valid_children:["root"],start_drag:!1,move_node:!1,start_drag:!1,move_node:!1,delete_node:!1,remove:!1,types:{root:{valid_children:["org"],start_drag:!1,move_node:!1,delete_node:!1,remove:!1},org:{max_depth:10,max_children:10,valid_children:["org"],start_drag:!0,move_node:!0,delete_node:!0,remove:!0}}}}).bind("loaded.jstree",function(e,t){r.resolve()}).bind("load_node.jstree",function(e,r,i){t.orgTree.find('a[href="#"]').attr("data-bypass",1),n.find('a[rel="company"]').parent("li").addClass("jstree-company");var s=!1;n.find('a[rel="company"]').parent("li").each(function(e,t){var n=$(t).data("groupDepth");_.isNumber(n)||(n=0),$(t).addClass("depth"+n),!s&&parseInt(n)>=0&&(s=!0)}),s&&n.addClass("jstree_depth")}).bind("select_node.jstree",$.proxy(t._clickNode,t));var i=$.Deferred();$.go(e.contextRoot+"api/user/profile/"+e.session("id"),"",{qryType:"GET",async:!0,contentType:"application/json",responseFn:function(e){var t=e.data.deptMembers[0].deptId;i.resolveWith(this,[t])},error:function(e){}}),$.when(i,r).then(function(e){t.$el.find('#group-tree a[nodeid="'+e+'"]').trigger("click")})},_clickNode:function(e,t){var n=$(t.rslt.obj[0]),r=n.data().id,i=n.data().name;this.trigger("click.orgSideView",{deptId:r,deptName:i})},releaseNode:function(){this.orgTree.find("a.jstree-clicked").removeClass("jstree-clicked")},getSelectedGroup:function(){var e=this.orgTree.find("a.jstree-clicked").closest("li");if(e.length==0)return{};var t=[];return $.each(e,function(){var e=$(this).data("id"),n=$(this).data("name");t.push({dataId:e,dataName:n})}),{data:t,groupType:"ORG"}}});return u});