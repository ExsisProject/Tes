(function(){define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("underscore"),i=require("views/mobile/header_toolbar"),s=require("hgn!contact/templates/mobile/m_detail"),o=require("contact/models/contact_info"),u=require("contact/models/company_contact_info"),a=require("contact/models/group_info"),f=require("contact/models/delete_contact"),l=require("i18n!nls/commons"),c=require("i18n!nls/user"),h=require("i18n!contact/nls/contact"),p=require("contact/models/dept_contact"),d=require("contact/helpers/contacts");require("GO.util"),require("jquery.cookie");var v=null,m={add_contact:h["\uc5f0\ub77d\ucc98 \ucd94\uac00"],return_home:l["\ud648\uc73c\ub85c \uc774\ub3d9"],not_contact:h["\ub4f1\ub85d\ub41c \uc8fc\uc18c\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],name:l["\uc774\ub984"],company:c["\ud68c\uc0ac"],dept:c["\ubd80\uc11c"],position:c["\uc9c1\uc704"],group:h["\uadf8\ub8f9"],group_create:h["\uadf8\ub8f9\ucd94\uac00"],email:c["\uc774\uba54\uc77c"],phone:c["\ud734\ub300\ud3f0"],company_tel:h["\ud68c\uc0ac\uc804\ud654"],company_addr:h["\ud68c\uc0ac\uc8fc\uc18c"],description:h["\uba54\ubaa8"],nickName:h["\uc560\uce6d"],birthday:h["\uc0dd\uc77c"],anniversary:h["\uae30\ub150\uc77c"],home_tel:h["\uc9d1 \uc804\ud654"],home_addr:h["\uc9d1 \uc8fc\uc18c"],home_fax:h["\uc9d1 \ud329\uc2a4"],home_homepage:h["\uc9d1 \ud648\ud398\uc774\uc9c0"],company_fax:h["\ud68c\uc0ac \ud329\uc2a4"],company_homepage:h["\ud68c\uc0ac \ud648\ud398\uc774\uc9c0"],profilephoto:h["\ud504\ub85c\ud544\uc0ac\uc9c4"],"delete":l["\uc0ad\uc81c"],image:l["\uc0ac\uc9c4"],modify:l["\uc218\uc815"],copy_url:l["URL \ubcf5\uc0ac"]},g=t.View.extend({el:"#content",events:{"vclick #telMobile":"telMobile","vclick #smsMobile":"smsMobile","vclick #sendMail":"sendMail"},initialize:function(e){function t(e){var t={readable:!0,removable:!0,writable:!0};return r.isUndefined(e)&&t,d.isCompany()&&(t=a.read({groupId:e}).toJSON()),t}this.$el.off(),this.type=e.type,this.contactId=e.contactId,this.viewMode=e.viewMode,this.groupId=e.groupId,this.deptId=e.deptId,d.init(e),this.headerToolbarView=i,this.groupInfo=t(this.groupId),GO.EventEmitter.off("trigger-action"),GO.EventEmitter.on("trigger-action","contact-modify",this.contactModify,this),GO.EventEmitter.on("trigger-action","contact-delete",this.contactDelete,this),GO.EventEmitter.on("trigger-action","contact-copy-url",this.copyUrl,this)},render:function(){this.renderToolbar(),this.renderDetail()},copyUrl:function(){GO.util.copyUrl()},renderDetail:function(){var t,r=this,i={error:function(e,t){GO.util.linkToErrorPage(t)}};d.isUser()?t=o.read({contactId:this.contactId}):d.isCompany()?(t=new u,t.set({groupId:this.groupId,contactId:this.contactId}),t.fetch({async:!1,error:i.error})):(t=new p,t.setDeptId(this.deptId),t.set("id",this.contactId),t.fetch({async:!1,error:i.error}));var a=t.toJSON();this.$el.html(s({lang:m,isMobileApp:GO.config("isMobileApp"),contextRoot:n.contextRoot,data:r.parseData(a),isGroups:function(){return a.groups!=undefined?!0:!1},isAvailableMail:function(){return n.isAvailableApp("mail")?!0:!1}})),e("#btnToolbarRight").remove(),e("#goBody").addClass("address_detail"),e("#defaultInfo ul li").length==0&&e("#defaultInfo").hide(),e("#addInfo ul li").length==0&&e("#addInfo").hide()},renderToolbar:function(){var e={isPrev:!0,actionMenu:this.getUseMenus()};this.headerToolbarView.render(e)},getUseMenus:function(){var e={"\uc218\uc815":{id:"contact-modify",text:m.modify,triggerFunc:"contact-modify",inMoreBtn:!0},"\uc0ad\uc81c":{id:"contact-delete",text:m.delete,triggerFunc:"contact-delete",inMoreBtn:!0},"URL \ubcf5\uc0ac":{id:"contact-copy-url",text:m.copy_url,triggerFunc:"contact-copy-url"}},t=[];return this.groupInfo.removable&&t.push(e["URL \ubcf5\uc0ac"]),this.groupInfo.writable&&t.push(e.\uc218\uc815),this.groupInfo.removable&&t.push(e.\uc0ad\uc81c),t},contactModify:function(t){var r=["contact"];this.groupId?(this.type&&r.push(d.getURL()),d.isDept()?e.merge(r,[this.deptId,"group",this.groupId]):r.push(this.groupId)):d.isDept()&&e.merge(r,[d.getURL(),this.deptId]),e.merge(r,["modify",this.contactId]),n.router.navigate(r.join("/"),{trigger:!0,pushState:!0})},contactDelete:function(e){var t=[];t.push(this.contactId),confirm(h["\uc8fc\uc18c\ub85d\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c"])&&(this.model=new f,this.model.set({ids:t},{silent:!0}),this.model.save({},{type:"DELETE",success:function(e,t){t.code=="200"&&window.history.back()},error:function(e,t){}}))},telMobile:function(t){return t.stopPropagation(),window.location.href="tel:"+e(t.currentTarget).attr("data-mobile"),!1},smsMobile:function(t){return t.stopPropagation(),window.location.href="smsto:"+e(t.currentTarget).attr("data-mobile"),!1},sendMail:function(t){return t.stopPropagation(),confirm(h["\uba54\uc77c\uc744 \ubcf4\ub0b4\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])&&(console.log(sessionStorage.getItem("GO-Agent-mail")),r.isNull(sessionStorage.getItem("GO-Agent-mail"))&&sessionStorage.setItem("GO-Agent-mail",this._getGoAgentMail()),window.location.href=GO.contextRoot+"app/mail?work=write&toAddr="+encodeURIComponent(e(t.currentTarget).attr("data-email"))),!1},_getGoAgentMail:function(){return GO.util.isMobileApp()?GO.util.isAndroidApp()?"GO-Android":"GO-iPhone":"BROWSER"},parseData:function(e){return r.map(e,function(t,n){typeof t=="string"&&!t&&(e[n]=null),typeof t=="object"&&r.map(t,function(t,r){typeof t=="string"&&!t&&(e[n][r]=null)});if(n=="birthday"||n=="anniversary")e[n]=moment(t,"YYYY-MM-DD").format("YYYY-MM-DD");n=="description"&&(typeof t=="string"&&!t?e[n]=null:(t=t.replace(/(\n)/gi,"<br>"),t=t.replace(/ /gi,"&nbsp;"),e[n]=t))}),e}});return{render:function(e){return v=new g(e),v.render()}}})}).call(this);