define("board/views/side",function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("hogan"),s=require("board/models/board_favorite"),o=require("admin/models/board_base_config"),u=require("board/models/company_board_tree"),a=require("board/models/dept_board_tree"),f=require("board/collections/board_favorite"),l=require("board/views/side_favorite"),c=require("board/components/board_tree/board_tree"),h=require("hgn!board/templates/side"),p=require("hgn!board/templates/side_dept_board"),d=require("hgn!board/templates/side_company_board"),v=require("i18n!nls/commons"),m=require("i18n!board/nls/board"),g=c.BoardTreeMenuView;require("jquery.go-popup");var y={board:v["\uac8c\uc2dc\ud310"],dept_board:m["\ubd80\uc11c\uac8c\uc2dc\ud310"],manage_row_rank:m["\ud558\uc704\ubd80\uc11c \uac8c\uc2dc\ud310 \uc870\ud68c"],company_board:m["\uc804\uc0ac\uac8c\uc2dc\ud310"],new_post:m["\uae00\uc4f0\uae30"],new_board:m["\uc0c8 \uac8c\uc2dc\ud310"],board_admin:v["\uac8c\uc2dc\ud310 \uad00\ub9ac"],board_setting:v["\uac8c\uc2dc\ud310 \uc124\uc815"],board_add:m["\uac8c\uc2dc\ud310 \ucd94\uac00"],no_board:m["\ub4f1\ub85d\ub41c \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],no_writable_board:m["\uc0c8 \uae00\uc744 \uc791\uc131\ud560 \uc218 \uc788\ub294 \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],closed_board:v["\ube44\uacf5\uac1c"],input_placeholder:m["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."],alert_check_editor:m["\ud604\uc7ac \uc791\uc131\uc911\uc778 \ub0b4\uc6a9\uc774 \uc788\uc2b5\ub2c8\ub2e4.<br>\ud654\uba74 \uc774\ub3d9 \uc2dc \uc791\uc131 \uc911\uc778 \ub0b4\uc6a9\uc740 \uc0ac\ub77c\uc9d1\ub2c8\ub2e4.<br>\uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],no_dept:m["\uc18c\uc18d\ub41c \ubd80\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4. \uc6b4\uc601\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."],confirm:v["\ud655\uc778"],cancel:v["\ucde8\uc18c"],collapse:v["\uc811\uae30"],expand:v["\ud3bc\uce58\uae30"],closed_board:m["\uc911\uc9c0\ub41c \uac8c\uc2dc\ud310 \uad00\ub9ac"],deleted_department:v["\uc0ad\uc81c\ub41c \ubd80\uc11c"]},b=r.session("loginId")+"-board-department-toggle",w=r.session("loginId")+"-board-company-toggle",E=r.session("loginId")+"-board-favorite-toggle",S=c.renderBoardTreeMenuNode,x=t.View.extend({events:{"click .btn-setting":"_clickBtnSettingHandler","click a.go_boards[data-id]":"goBoard","click section.lnb span.ic_side[data-slide]":"slideToggle","click section.lnb a.txt":"slideToggle","click a.node-value span.ic_side[data-slide]":"slideToggleDepartmentName","click a.node-value span.txt":"slideToggleDepartmentName","click #favoriteSide li span.ic_list_del":"favoriteItemDelete","click #reorderSave":"favoreteReorderSave","click #writeBtn":"sideWriteBtnAction","click span[btn-type='newBoard']":"newBoard","click #boardHome":"boardHome"},initialize:function(){this.companyBoardList=new u.Collection,this.deptBoardList=new a.Collection;var e=this;this.favoriteCollection=f.create(),this.deleteFavoriteIds=[],r.EventEmitter.off("board"),r.EventEmitter.on("board","changed:favorite",this.favoriteRender,this),r.EventEmitter.on("board","changed:lastPostedAt",function(){e.renderContent()},this),r.EventEmitter.on("board","changed:deptBoard",function(){e.renderContent()},this),r.EventEmitter.off("boardTree"),r.EventEmitter.on("boardTree","changed:nodes",function(){e.renderContent()},this),this.model=o.read({admin:!1}).toJSON(),r.config("attachNumberLimit",this.model.attachNumberLimit),r.config("attachSizeLimit",this.model.attachSizeLimit),r.config("maxAttachNumber",this.model.maxAttachNumber),r.config("maxAttachSize",this.model.maxAttachSize),r.config("excludeExtension",this.model.excludeExtension?this.model.excludeExtension:""),r.config("priorityBoard",this.model.priorityBoard)},render:function(e){console.debug("[board] BoardSideView:render call"),this.$el.html(h({contextRoot:r.contextRoot,isDeptBoardPriority:r.config("priorityBoard"),isDeptOpen:this.getStoredCategoryIsOpen(b),isCompanyOpen:this.getStoredCategoryIsOpen(w),appName:r.util.getAppName("board"),lang:y})),this.renderContent()},renderContent:function(){console.debug("[board] BoardSideView:renderContent call"),n.all([this.favoriteRender(),this.companyBoardRender(),this.deptBoardRender()]).then(_.bind(this.selectSideMenu,this)).otherwise(function(e){console.debug(e.stack)})},favoriteRender:function(){var t=this,i=this.favoriteCollection;return this.deleteFavoriteIds=[],n.promise(function(n,s){i.fetch({data:{page:"0",offset:"1000"},success:function(i){var s=i.toJSON(),o=e(s).map(function(e,n){return{name:n.name,boardId:n.boardId,id:n.id,type:n.type,anonymFlag:n.anonymFlag,sharedFlag:n.sharedFlag,getBoardTypeClass:t._getBoardTypeClass,lastPostedAt:n.lastPostedAt||!1,hasRecentPost:function(){return this.lastPostedAt&&r.util.isCurrentDate(this.lastPostedAt)},publicFlag:n.publicFlag}});l.attachTo(t.$el.find("#favoriteSide"),{data:o.get(),isOpen:t.getStoredCategoryIsOpen(E)}),n()},error:s})})},companyBoardRender:function(){var e=this,t=this.companyBoardList,i=this.$("#companySide"),s=i.find("ul"),o=[];return s.empty(),n.promise(function(n,u){function a(e){return e.map(function(e){var t=e.get("actions");t&&t.managable&&(t.managable=!1,e.set("actions",t))}),e}t.fetch({success:function(t){if(t.length<1)return;t.each(function(t){var n=t.getBoardTreeNodes();if(n.length>0){var i=["company",r.session("companyId"),"company"].join("."),s=e._renderMenuTree(a(n),i);o.push(s.el)}}),t.hasClosedBoards()&&o.push(e._renderClosedBoardLink(r.config("contextRoot")+"app/board/company/close")),s.append.apply(s,o),o.length>0&&i.show(),n()},error:u})})},deptBoardRender:function(){function a(n){var i=n.getBoardTreeNodes(),s=["company",r.session("companyId"),"dept"].join("."),o=t._renderMenuTree(i,s),u=e(S({nodeId:n.getDeptId(),nodeType:"DEPT",nodeValue:n.getDeptName(),isDeleted:n.isDeleted(),iconType:"org",linkUrl:"#",managable:n.isManagable(),lang:{deleteDept:v["\uc0ad\uc81c\ub41c \ud300"]},hasToggleIcon:"true"}));return u.on("click","a.node-value",function(e){e.preventDefault()}),u.append(o.el),u}function f(){return e(S({nodeType:"LINK",nodeValue:y.manage_row_rank,iconType:"assigned",linkUrl:r.config("contextRoot")+"app/board/lowrank/manage",managable:!1}))}var t=this,i=this.deptBoardList,s=this.$("#deptSide"),o=s.find("ul:first"),u=[];return o.empty(),s.show(),n.promise(function(e,n){i.fetch({success:function(n){n.length>0?s.find(".no-dept-msg").remove():s.find(".no-dept-msg").show(),n.each(function(e){var t=a(e);t&&u.push(a(e))}),n.isAccessableSubDeptBoards()&&u.push(f()),n.hasClosedBoards()&&u.push(t._renderClosedBoardLink(r.config("contextRoot")+"app/board/dept/close")),o.append.apply(o,u),e()},error:n})})},selectSideMenu:function(){var e=null,t=r.router.getUrl().split("/");this.$el.find(".on").removeClass("on"),t[2]==="favorite"?e=this.$el.find('#favoriteSide li a[data-boardId="'+t[1]+'"]'):t[1]=="dept"?t[2]=="close"?e=this.$el.find("#deptSide li.closed a"):e=this.$el.find('#deptSide li a[data-deptid="'+t[2]+'"]'):t[1]=="lowrank"?e=this.$el.find("#deptSide li.assigned a"):t[1]=="company"&&t[2]=="close"?e=this.$el.find("#companySide li.closed a"):e=this.$el.find('#deptSide li[data-type=BOARD] a[data-id="'+t[1]+'"],#deptSide li[data-type=SHARE] a[data-id="'+t[1]+'"], #companySide li[data-type=BOARD] a[data-id="'+t[1]+'"],#companySide li[data-type=SHARE] a[data-id="'+t[1]+'"]'),e.length&&e.parents("p:eq(0)").addClass("on")},deptAdmin:function(t){var n=this;r.util.hasActiveEditor()?r.util.editorConfirm(function(){n.deptAdminAction(t)}):e("#feedContent").val()&&e("#feedContent").val()!=y.input_placeholder?this.wirtePageMovePopup(t,"deptAdminAction"):this.deptAdminAction(t)},deptAdminAction:function(t){var n=e(t.currentTarget),i=n.data("id");n.data("type")||(i=n.data("deptid")),r.router.navigate("board/dept/"+i,!0)},boardAdmin:function(t){var n=this;r.util.hasActiveEditor()?r.util.editorConfirm(function(){n.boardAdminAction(t)}):e("#feedContent").val()&&e("#feedContent").val()!=y.input_placeholder?this.wirtePageMovePopup(t,"boardAdminAction"):this.boardAdminAction(t)},boardAdminAction:function(t){var n=e(t.currentTarget),i=n.data("id");n.data("type")||(i=n.data("boardid")),r.router.navigate("board/"+i+"/admin",!0)},newBoard:function(t){if(r.util.hasActiveEditor()){var n=e(t.currentTarget),i=n.attr("data-boardid"),s=function(){r.router.navigate("board/create",!0)};r.util.editorConfirm(s)}else e("#feedContent").val()&&e("#feedContent").val()!=y.input_placeholder?this.wirtePageMovePopup(t,"newBoardAction"):this.newBoardAction()},newBoardAction:function(){r.router.navigate("board/create",!0)},sideWriteBtnAction:function(t){if(r.util.hasActiveEditor()){var n=this,i=function(){n.goWrite(t)};r.util.editorConfirm(i)}else e("#feedContent").val()&&e("#feedContent").val()!=y.input_placeholder?this.wirtePageMovePopup(t,"goWrite"):this.goWrite(t)},goWrite:function(t){var n=this,i=e(t.currentTarget).parent().parent(),s=this.deptBoardList.hasBoards(),o=this.companyBoardList.hasBoards();if(!s&&!o)return e.goMessage(y.no_board),!1;if(!this._hasWritableBoards())return e.goMessage(y.no_writable_board),!1;var u,a,f=!_.isUndefined(r.router.getUrl().split("board/")[1]);f&&(a=r.router.getUrl().split("board/")[1].split("/post/")[0]),this.deptBoardList.models.forEach(function(e){e.attributes.boards.forEach(function(t){n._isWritableCurrentBoard(t,a)&&(u=e.attributes.deptId)})}),this.companyBoardList.models.forEach(function(e){e.attributes.boards.forEach(function(t){n._isWritableCurrentBoard(t,a)&&(u=e.attributes.companyId)})}),!u||!a?r.router.navigate("board/post/write",!0):r.router.navigate("board/post/write/"+u+"/"+a,!0)},favoriteItemDelete:function(t){var n=e(t.currentTarget).parents("li");this.deleteFavoriteIds.push(n.attr("data-boardid")),n.remove()},favoreteReorderSave:function(t){var n=this,i=l.getReorderIds();this.favoriteModel||(this.favoriteModel=new s),this.deleteFavoriteIds.length&&(this.favoriteModel||(this.favoriteModel=new s),e.each(this.deleteFavoriteIds,function(e,t){n.favoriteModel.set({boardId:t,id:t},{silent:!0}),n.favoriteModel.destroy({success:function(e,t){r.EventEmitter.trigger("board","changed:favorite",!0),r.EventEmitter.trigger("board","change:boardInfo",e.id)}})})),l.destroySortable(),i&&(this.favoriteModel.set("boardId","",{silent:!0}),this.favoriteModel.save({ids:i},{type:"PUT",success:function(e,t){t.code==200&&r.EventEmitter.trigger("board","changed:favorite",!0)}}))},slideToggle:function(t){var n=e(t.currentTarget),r=n.parents("h1"),i=r.find(".ic_side"),s=this;r.next("ul").slideToggle("fast",function(){e(this).css("display")=="block"?(r.removeClass("folded"),i.attr("title",y.collapse)):(r.addClass("folded"),i.attr("title",y.expand)),s.storeToggleStatus(r,i)})},slideToggleDepartmentName:function(t){var n=e(t.currentTarget),r=n.parents("p"),i=r.find(".ic_hide_up"),s=this;if(!r.next("ul").find("li").length)return;r.next("ul").slideToggle("fast",function(){e(this).css("display")=="block"?(i.removeClass("open").addClass("close"),i.attr("title",y.collapse)):(i.removeClass("close").addClass("open"),i.attr("title",y.expand)),s.storeToggleStatus(r,i)})},storeToggleStatus:function(e,t){var n=this,r=e.hasClass("company"),i=e.hasClass("org"),s=e.hasClass("star"),o=!t.hasClass("folded");r?n.storeCategoryIsOpen(w,o):i?n.storeCategoryIsOpen(b,o):s&&n.storeCategoryIsOpen(E,o)},wirtePageMovePopup:function(t,n){var i=this;e.goPopup({title:"",message:y.alert_check_editor,modal:!0,buttons:[{btext:y.confirm,btype:"confirm",callback:function(){n=="goBaordAction"?i.goBaordAction(t):n=="goWrite"?i.goWrite(t):n=="newBoardAction"?r.router.navigate("board/create",!0):n=="boardAdminAction"?i.boardAdminAction(t):n=="deptAdminAction"&&i.deptAdminAction(t)}},{btext:y.cancel,btype:"normal",callback:function(){}}]})},goBaordAction:function(t){var n=e(t.currentTarget);this.$el.find(".on").removeClass("on"),n.parent().addClass("on");if(n.attr("data-id")){if(n.parents("#favoriteSide").length)r.router.navigate("board/"+n.attr("data-boardId")+"/favorite",{trigger:!0,pushState:!0});else{var i=n.attr("data-id");if(i!="closed")r.router.navigate("board/"+n.attr("data-id"),{trigger:!0,pushState:!0});else{var s=n.attr("data-deptId");r.router.navigate("board/dept/"+s+"/close",{trigger:!0,pushState:!0})}}e("html, body").animate({scrollTop:0})}},goBoard:function(t){if(r.util.hasActiveEditor()){var n=this,i=function(){n.goBaordAction(t)};r.util.editorConfirm(i)}else e("#feedContent").val()&&e("#feedContent").val()!=y.input_placeholder?this.wirtePageMovePopup(t,"goBaordAction"):this.goBaordAction(t)},getStoredCategoryIsOpen:function(e){var t=r.util.store.get(e);return _.isUndefined(t)&&(t=!0),t},storeCategoryIsOpen:function(e,t){return r.util.store.set(e,t)},boardHome:function(){var e=function(){r.router.navigate(r.contextRoot+"board",!0)};r.util.editorConfirm(e)},_hasWritableBoards:function(){return this.deptBoardList.hasWritableBoards()||this.companyBoardList.hasWritableBoards()},_isWritableCurrentBoard:function(e,t){return e.nodeType=="BOARD"&&e.board.id==t&&e.actions&&e.actions.writable},_renderMenuTree:function(e,t){var n=new g({nodes:e,menuId:t});return n.render(),n},_renderClosedBoardLink:function(t){return e(S({nodeType:"LINK",nodeValue:y.closed_board,iconType:"closed",linkUrl:t,managable:!1}))},_clickBtnSettingHandler:function(t){var n=e(t.currentTarget),r=n.data("type");switch(r){case"DEPT":this.deptAdmin(t);break;case"BOARD":this.boardAdmin(t);break;default:}},_getBoardTypeClass:function(){var e=this.type=="STREAM"?"feed":"classic",t=this.anonymFlag;return this.sharedFlag&&(e+="_share"),t&&(e+="_anonym"),e}});return x});