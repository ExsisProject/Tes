(function(){define(["jquery","backbone","app","views/mobile/header_toolbar","board/collections/post_classic_tiny","board/models/post","board/models/post_recommend","board/models/board_config","hgn!board/templates/mobile/m_post_detail","hgn!board/templates/mobile/m_post_auth_users","hgn!board/templates/mobile/m_post_detail_tiny","hgn!board/templates/mobile/m_post_detail_tiny_hidden","board/views/mobile/m_post_attaches","i18n!board/nls/board","i18n!nls/commons","views/layouts/m_action_bar_default","views/mobile/m_font_resize","GO.util"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g={"\ub2f5\uae00":{id:"board-reply",text:p["\ub2f5\uae00"],triggerFunc:"board-reply"},"\ub313\uae00":{id:"board-comment",cls:"btn_comments",text:p["\ub313\uae00"],triggerFunc:"board-comment"},"\uc218\uc815":{id:"board-delete",cls:"post_update",text:d["\uc218\uc815"],triggerFunc:"board-modify",inMoreBtn:!0},"\uc0ad\uc81c":{id:"board-delete",cls:"post_delete",text:d["\uc0ad\uc81c"],triggerFunc:"board-delete",inMoreBtn:!0},"\uc5f4\ub78c \uad8c\ud55c":{id:"board-auth-users",cls:"post_auth_users",text:p["\uc5f4\ub78c \uad8c\ud55c"],triggerFunc:"board-auth-users",inMoreBtn:!0}},y={ok:d["\ud655\uc778"],modify:d["\uc218\uc815"],"delete":d["\uc0ad\uc81c"],list:d["\ubaa9\ub85d"],plus_user:d["\uc88b\uc544\uc694 \ub204\ub978 \uc0ac\ub78c"],recommend:d["\uc88b\uc544\uc694 \ud558\uae30"],recommend_cancel:d["\uc88b\uc544\uc694 \ucde8\uc18c"],label_like:p["\uc88b\uc544\uc694"],comments:p["\ub313\uae00"],read_count:p["\uc870\ud68c"],post_reply:p["\ub2f5\uae00\uc4f0\uae30"],post_orphan_msg:p["\uc6d0\uae00\uc774 \uc0ad\uc81c\ub41c \ub2f5\uae00"],post_delete_desc:GO.util.br2nl(p["\uc0ad\uc81c\ud655\uc778\uba54\uc138\uc9c0"]),post_last_msg:p["\ub9c8\uc9c0\ub9c9 \uac8c\uc2dc\ubb3c\uc785\ub2c8\ub2e4."],post_move_impossible:p["\uc774\ub3d9\ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],prev:d["\uc704"],next:d["\uc544\ub798"],hidden_post:p["\uc5f4\ub78c\uad8c\ud55c\uc774 \uc5c6\ub294 \uac8c\uc2dc\ubb3c\uc785\ub2c8\ub2e4."],more_content:p["\ub354\ubcf4\uae30"],content_fold:d["\uc811\uae30"]},b=t.View.extend({id:"postBbsDetailView",initialize:function(e){this.$el.off(),this.options=e||{},this.postTinyCollection=new i,this.postTinyCollection.on("reset",this.renderTinyList,this),this.boardModel=u.get(this.options.boardId),this.isReadablePost=!0},unbindEvent:function(){this.$el.off("vclick","#recommendUserList"),this.$el.off("vclick","span#recommendHeart"),this.$el.off("vclick","a#recommendHeart"),this.$el.off("vclick","div.tool_bar a.post_delete"),this.$el.off("vclick","div.tool_bar a.post_update"),this.$el.off("vclick","div.tool_bar a.post_auth_users"),this.$el.off("vclick","div.tool_bar a.post_url_copy"),this.$el.off("vclick",".btn_go_list"),this.$el.off("vclick","#detailTinyList a[data-id]"),this.$el.off("vclick",'span[data-type="externalUrl"]'),this.$el.off("vclick","div.meta_info_wrap a"),this.$el.off("vclick","article a[href]"),this.$el.off("vclick",'span[data-btntype="moreBtn"]'),this.$el.off("vclick",'span[data-btntype="closeBtn"]'),this.$el.off("vclick","#more_btn"),this.$el.off("vclick","#copyUrl"),e(document).off("backdrop"),GO.EventEmitter.off("trigger-action")},bindEvent:function(){this.$el.on("vclick","#recommendUserList",e.proxy(this.goToRecommends,this)),this.$el.on("vclick","span#recommendHeart",e.proxy(this.actionPostRecommend,this)),this.$el.on("vclick","a#recommendHeart",e.proxy(this.blurEl,this)),this.$el.on("vclick","div.tool_bar a.post_delete",e.proxy(this.actionPostDelete,this)),this.$el.on("vclick","div.tool_bar a.post_update",e.proxy(this.actionPostUpdate,this)),this.$el.on("vclick","div.tool_bar a.post_auth_users",e.proxy(this.actionPostAuthUsers,this)),this.$el.on("vclick",".btn_go_list",e.proxy(this.goToList,this)),this.$el.on("vclick","#detailTinyList a[data-id]",e.proxy(this.goToPostById,this)),this.$el.on("vclick",'span[data-type="externalUrl"]',e.proxy(this.externalUrl,this)),this.$el.on("vclick","div.meta_info_wrap a",e.proxy(this.externalUrl,this)),this.$el.on("vclick","article a[href]",e.proxy(this.articleExternalUrl,this)),this.$el.on("vclick",'span[data-btntype="moreBtn"]',e.proxy(this.contentMoreAction,this)),this.$el.on("vclick",'span[data-btntype="closeBtn"]',e.proxy(this.contentCloseAction,this)),this.$el.on("vclick","#more_btn",e.proxy(this.moreLayout,this)),this.$el.on("vclick","#copyUrl",e.proxy(this.copyUrl,this)),GO.EventEmitter.on("trigger-action","board-reply",this.goToReply,this),GO.EventEmitter.on("trigger-action","board-comment",this.goToComments,this),GO.EventEmitter.on("trigger-action","board-modify",this.actionPostUpdate,this),GO.EventEmitter.on("trigger-action","board-delete",this.actionPostDelete,this),GO.EventEmitter.on("trigger-action","board-auth-users",this.actionPostAuthUsers,this),e(document).on("backdrop",e.proxy(function(e){this.closeMoreLayout(e)},this))},closeMoreLayout:function(t){var n=e(t.currentTarget).find("#more_layout");n.is(":visible")&&n.hide()},moreLayout:function(t){t.preventDefault(),t.stopPropagation();var n=e(t.currentTarget).parent().find("#more_layout");this.toggleMoreLayout(n)},toggleMoreLayout:function(e){e.is(":visible")?e.hide():e.show()},contentCloseAction:function(t){var n=e(t.currentTarget);n.parent().find("span.expander").show(),n.parent().find("span.contentMore").remove(),n.parent().find('span[data-btntype="moreBtn"]').show(),n.parent().find('span[data-btntype="closeBtn"]').hide()},contentMoreAction:function(t){var n=e(t.currentTarget);this.model.moreContent||this.model.getMoreContent(),n.parent().find("span.expander").hide(),n.parent().find('span[data-btntype="moreBtn"]').hide(),n.before('<span class="contentMore">'+GO.util.escapeHtml(this.model.moreContent)+"</span>"),n.parent().find('span[data-btntype="closeBtn"]').show()},externalUrl:function(t){var n=e(t.currentTarget);return GO.util.externalUrl(n.attr("data-url")),!1},articleExternalUrl:function(t){t.preventDefault();var n=e(t.currentTarget);return GO.util.externalUrl(n.attr("href")),!1},blurEl:function(t){e(t.target).blur(),e(t.currentTarget).blur()},changePage:function(){var e=this;this.boardId=this.options.boardId,this.postId=this.options.postId,this.masterOwner=this.options.owner,this.isStream=this.options.boardType=="STREAM",this.isCommunity=this.options.isCommunity||!1,this.writeUrl=this._getWriteUrl(),this.replyUrl=this._getReplyUrl(),this.options.isMobile=!0,this.model=new s(this.options),this.model.setURL(),this.model.fetch({async:!1,error:function(t,n){e.isReadablePost=!1,setTimeout(function(){GO.util.linkToErrorPage(n)},100)}});if(!this.isReadablePost)return;this.recommendModel=new o(this.options),this.recommendModel.set("id",this.postId,{silent:!0}),this.model.on("change",function(t){t.hasChanged("id")&&(e.postId=t.id,t.set({postId:e.postId},{silent:!0}),n.router.navigate(e._getDirectPostUrl(),{trigger:!1})),e.render(!0)}),this.isStream||(this.postTinyCollection.boardId=this.boardId,this.postTinyCollection.postId=this.postId,this.postTinyCollection.fetch({data:{sorts:"sortCriteria desc,threadRootCode desc,threadCode asc",page:n.router.getSearch("page")},reset:!0}))},updatePage:function(){this.model.options.readOnly=!0,this.model.options.async=!0,this.model.fetch()},render:function(){this.unbindEvent();var e=arguments[0]===!0?!0:!1,t=this.postId==this.options.postId,n=this.options.actions;t||this.changePage();if(!this.isReadablePost)return;var r=this.model.toJSON(),i=function(){return this.dataset.recommendCount==0?!0:!1};r.title=GO.util.convertRichText(r.title),_.each(r.links,function(e){e.url&&(e.url=e.url.replace(/&amp;/gi,"&"))});var s=a({dataset:r,boardId:this.boardId,ownerId:this.masterOwner.ownerId,isZero:i,isStream:this.isStream,postTitle:function(){return GO.util.escapeHtml(this.dataset.title)},isClose:function(){return this.dataset.type=="CLASSIC"&&this.dataset.status=="CLOSE"},hasControlAction:function(){return this.dataset.actions.updatable||this.dataset.actions.removable},directUrl:this._getDirectPostUrl(),writeUrl:this.writeUrl,replyUrl:this.replyUrl,dateformat:function(){return GO.util.basicDate(this.dataset.createdAt)},renderStreamContent:function(){return GO.util.convertMobileRichText(this.dataset.content||this.dataset.summary)},renderClassicContent:function(){return this.dataset.contentType=="TEXT"&&(this.dataset.content=GO.util.convertMobileRichText(this.dataset.content)),GO.util.escapeXssFromHtml(this.dataset.content)},contextRoot:GO.contextRoot,lang:y});this.isStream||(GO.util.appLoading(!0),this.$el.css("visibility","hidden")),this.$el.html(s).removeClass("m_loading"),this.$el.find("#doc_header").css("visibility","visible"),this.$el.find("a[target]").attr("target","_blank"),this.renderHeaderToolBar(r,n),r.attaches&&r.attaches.length&&(h.render({el:"#attaches"+r.id,attaches:r.attaches,postId:this.postId,boardId:this.boardId}),h.resize(this.$el)),t&&!e&&this.updatePage(),this.$el.trigger("vclick"),this.bindEvent(),this.initWindowEvent()},renderHeaderToolBar:function(e,t){var n={isPrev:!0,actionMenu:this.getUseMenus(e,t)};r.render(n)},getUseMenus:function(e,t){var n=[];!this.isStream&&e.actions.writable&&(g.\ub2f5\uae00.url=this.replyUrl,n.push(g.\ub2f5\uae00));if(e.commentFlag||e.commentsCount!=0)g.\ub313\uae00.commentsCount=e.commentsCount,n.push(g.\ub313\uae00);return t.updatable&&e.actions.updatable&&n.push(g.\uc218\uc815),t.removable&&e.actions.removable&&n.push(g.\uc0ad\uc81c),this.model.get("authorizedUsers").length>0&&n.push(g["\uc5f4\ub78c \uad8c\ud55c"]),n},initWindowEvent:function(){this.orientationWindowEvent={name:"orientation",event:function(){this.$el.find("#postContentWrapper").width(e(window).width()),this.decideIscrollInit()}},this.setTimeoutToWindowEventHandler(this.orientationWindowEvent)},setTimeoutToWindowEventHandler:function(t){var n=this;e(window).on(t.name,function(){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(e.proxy(t.event,n),200)})},makeTplTinyList:function(e,t){if(!e&&!e.id)return!1;var n=e.get("hiddenPost"),r=e.get("summary")==" $$#HIDDEN_POST#$$ ",i="",t=t||!1;return n?i=c({tplVar:y,isPrev:t,isTitleHidden:r,title:GO.util.escapeHtml(e.get("title"))}):i=l({tplVar:y,isPrev:t,id:e.id,title:GO.util.escapeHtml(e.get("title"))}),i},renderTinyList:function(){var e=this.postTinyCollection.indexOf(this.postTinyCollection.get(this.postId)),t=this.postTinyCollection.at(e-1),n=this.postTinyCollection.at(e+1);this.$tinyEl=this.$el.find("#detailTinyList").empty(),t&&this.$tinyEl.prepend(this.makeTplTinyList(t,!0)),n&&this.$tinyEl.append(this.makeTplTinyList(n,!1)),this.resizeContent()},resizeContent:function(){var e=this;setTimeout(function(){e.decideIscrollInit(),e.fontResizeLayerAdd()},500)},decideIscrollInit:function(){e(document).width()<e("#postContent").width()?GO.util.initDetailiScroll("postDetailWrapper","iScrollContentWrap","postContentWrapper"):(this.$el.css("visibility","visible"),GO.util.appLoading(!1))},fontResizeLayerAdd:function(){m.render({el:"#fontResizeWrap",targetContentEl:"#postContent"})},_getDirectPostUrl:function(){var e=n.router.getRootUrl();return this.isCommunity?e+="community/"+this.masterOwner.ownerId+"/board/"+this.boardId+"/post/"+this.postId:e+="board/"+this.boardId+"/post/"+this.postId,e},_getReplyUrl:function(){var e=GO.contextRoot+"app/"+(this.isCommunity?"community":"board");return e+="/post/write/"+this.masterOwner.ownerId+"/"+this.boardId+"/"+this.postId,e},_getCommunityPrefix:function(){return"community/"+this.masterOwner.ownerId+"/"},_getWriteUrl:function(){var e="";return this.isCommunity?e+="community/"+this.masterOwner.ownerId+"/board/"+this.boardId+"/post/write":e+="board/post/write/"+this.masterOwner.ownerId+"/"+this.boardId,e},goToRecommends:function(e){e.preventDefault();if(this.boardModel.get("anonymFlag"))return!1;var t="board/"+this.boardId+"/post/"+this.postId+"/recommends";return this.isCommunity&&(t=this._getCommunityPrefix()+t),n.router.navigate(t,!0),!1},goToReply:function(){var e=(this.isCommunity?"community":"board")+"/post/write/"+this.masterOwner.ownerId+"/"+this.boardId+"/"+this.postId;return n.router.navigate(e,!0),!1},goToComments:function(){var e="board/"+this.boardId+"/post/"+this.postId+"/comments";return this.isCommunity&&(e=this._getCommunityPrefix()+e),n.router.navigate(e,!0),!1},goToList:function(){var e="board/"+this.boardId;return e=n.router.getSearch("page")?e+="/?page="+n.router.getSearch("page"):e,this.isCommunity&&(e=this._getCommunityPrefix()+e),n.router.navigate(e,!0),!1},swipeStart:function(){this.swipeStartX=window.event.changedTouches[0].clientX,this.swipeStartY=window.event.changedTouches[0].clientY},swipeEnd:function(){this.swipeEndX=window.event.changedTouches[0].clientX,this.swipeEndY=window.event.changedTouches[0].clientY;var t=this.postTinyCollection,n=t.indexOf(t.get(this.postId));e("#rightHandle").css("left",-50),e("#leftHandle").css("right",-50),this.isSwipeX()&&(this.swipeStartX-this.swipeEndX>100?this.goToPost(n,"next"):this.swipeEndX-this.swipeStartX>100&&this.goToPost(n,"prev"))},isSwipeX:function(){var e=Math.abs(this.swipeStartX-this.swipeEndX),t=Math.abs(this.swipeEndY-this.swipeStartY);return e>t&&e>25&&t<40},showNavigator:function(t){var n=window.event.changedTouches[0].clientX,r=Math.abs(window.event.changedTouches[0].clientY),i=0,s=r-this.swipeStartY,o=e("#rightHandle"),u=e("#leftHandle");s<40?(n-this.swipeStartX>100&&(i=n-this.swipeStartX,o.stop().css("left",i<50?-50+i:0)),this.swipeStartX-n>100&&(i=this.swipeStartX-n,u.stop().css("right",i<50?-50+i:0))):(u.stop().animate({right:-50},500),o.stop().animate({left:-50},500))},goToPostById:function(t,r){t&&t.stopPropagation(),r=r||e(t.currentTarget).attr("data-id");if(!r)return!1;var i="board/"+this.boardId+"/post/"+r;return i=n.router.getSearch("page")?i+="?page="+n.router.getSearch("page"):i,this.isCommunity&&(i=this._getCommunityPrefix()+i),n.router.navigate(i,!0),!1},goToPost:function(e,t){var r=null;return e=e||0,t=="next"?e++:e--,r=this.postTinyCollection.at(e),r?(r.get("status")=="CLOSE"&&r.get("summary")==" $$#HIDDEN_POST#$$ "?this.postMove(e,t):(this.$el.empty().addClass("m_loading"),n.router.navigate("board/"+this.boardId+"/post/"+r.id,!0)),!1):(GO.util.delayAlert(y.post_last_msg),!1)},actionPostDelete:function(){var e=this;return confirm(y.post_delete_desc)&&this.model.destroy({success:function(t,r){var i="";e.isCommunity?i=e._getCommunityPrefix()+"board/"+e.boardId:i="board/"+e.boardId,n.router.navigate(i,{trigger:!0,replace:!0})}}),!1},actionPostUpdate:function(){var e="";return this.model.get("contentType")==="HTML"?(GO.util.delayAlert(p["\ubaa8\ubc14\uc77c \uac8c\uc2dc\uae00 \uc218\uc815\ubd88\uac00 \uba54\uc138\uc9c0"]),!1):(this.isCommunity?e+="community/post/put/":e+="board/post/put/",e+=this.masterOwner.ownerId+"/"+this.boardId+"/"+this.postId,n.router.navigate(e,{trigger:!0}),!1)},copyUrl:function(e){GO.util.copyUrl(e)},actionPostAuthUsers:function(t){var n=this.model.get("authorizedUsers");e("body").append(f({authorizedUsers:n,boardLang:p,commonLang:d})),e("#postAuthUsersLayer .btn_layer_close").on("click",function(){e("#postAuthUsersLayer").remove()}),e("#postAuthUsersLayer .btn_major_s").on("click",function(){e("#postAuthUsersLayer").remove()})},actionPostRecommend:function(t){var n=this,r={type:"POST",success:function(t,i){if(i.code==200){var s=n.$el.find("#recommendHeart"),o=i.data.recommendCount||0;e("#recommendUserList span.num").html(o),r.type=="DELETE"?(s.removeClass("on").attr("title",y.recommend),s.find("#heartImg").attr("src","/resources/images/mobile/ic_heart.png"),s.find("span.txt").text(o)):(s.addClass("on").attr("title",y.recommend_cancel),s.find("#heartImg").attr("src","/resources/images/mobile/ic_heart_on.png"),s.find("span.txt").text(o)),n.model.set("recommend",!n.model.get("recommend"),{silent:!0})}else GO.util.delayAlert(i.message)}};return this.model.get("recommend")&&(r.type="DELETE"),this.recommendModel.clear(),this.recommendModel.save({boardId:this.boardId,postId:this.postId},r),!1}},{__instance__:null,create:function(t){return this.__instance__=new this.prototype.constructor(e.extend({el:e("#content")},t[0])),this.__instance__},render:function(){var e=arguments.length>0?Array.prototype.slice.call(arguments):[],t=this.create(e);return this.prototype.render.apply(t,e)}});return b})}).call(this);