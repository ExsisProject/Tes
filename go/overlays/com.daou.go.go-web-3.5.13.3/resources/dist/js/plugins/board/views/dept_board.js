define(function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("board/components/board_tree/board_tree"),s=require("board/models/dept_board_tree_node"),o=require("text!board/templates/_dept_board_toolbar.html"),u=require("board/constants"),a=require("board/views/board_title"),f=require("hgn!board/templates/dept_board"),l=require("i18n!board/nls/board"),c=require("i18n!nls/commons");require("jquery.ui"),require("jquery.go-popup"),require("jquery.go-sdk"),require("GO.util"),require("jquery.go-orgslide");var h={board_admin:l["\uac8c\uc2dc\ud310 \uad00\ub9ac"],board_admin_desc:l["\uac8c\uc2dc\ud310 \uad00\ub9ac \uc124\uba85"],board_separator:l["\uad6c\ubd84\uc120"],board_separator_add:l["\uad6c\ubd84\uc120 \ucd94\uac00"],board_stop:c["\uc911\uc9c0"],board_delete:c["\uc0ad\uc81c"],board_migration:c["\uac8c\uc2dc\ud310 \uc774\uad00"],modify:c["\uc218\uc815"],save:c["\uc800\uc7a5"],cancel:c["\ucde8\uc18c"],"delete":c["\uc0ad\uc81c"],board_active_title:l["\uc0ac\uc6a9\uc911"],board_stop_title:l["\uc911\uc9c0"],board_reorder:l["\uc21c\uc11c \ubc14\uafb8\uae30"],board_reorder_save:l["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"],board_title:c["\uac8c\uc2dc\ud310"],board_manager:l["\uc6b4\uc601\uc790"],board_createat:l["\uac1c\uc124\uc77c"],board_updateat:l["\uc911\uc9c0\uc77c"],board_posts:l["\uac8c\uc2dc\uae00 \uc218"],board_setting:c["\uc124\uc815"],board_active_null:l["\uc0ac\uc6a9\uc911\uc778 \uac8c\uc2dc\ud310 \ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],board_stop_null:l["\uc911\uc9c0\ub41c \uac8c\uc2dc\ud310 \ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],"delete_separator?":l["\uad6c\ubd84\uc120\uc744 \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"delete_separator_desc?":l["\uad6c\ubd84\uc120\uc744 \uc0ad\uc81c\ud558\uba74 \ubcf5\uad6c\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4. <br />\uacc4\uc18d \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],not_select_board:l["\uac8c\uc2dc\ud310\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],change_success:c["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],delete_success:c["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],delete_confirm:l["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],delete_title:l["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],stop_confirm:l["\uac8c\uc2dc\ud310 \uc911\uc9c0 \ud655\uc778"],stop_board:l["\uac8c\uc2dc\ud310 \uc911\uc9c0"],add_board:l["\uac8c\uc2dc\ud310 \ucd94\uac00"],add_group:l["\uac8c\uc2dc\ud310 \uadf8\ub8f9 \ucd94\uac00"],close_all:l["\ubaa8\ub450 \ub2eb\uae30"],open_all:l["\ubaa8\ub450 \uc5f4\uae30"],stop_board_success:l["\uac8c\uc2dc\ud310\uc911\uc9c0 \uc548\ub0b4\uba54\uc2dc\uc9c0"],stop_boards_success:l["\ubcf5\uc218\uac1c \uac8c\uc2dc\ud310\uc911\uc9c0 \uc548\ub0b4\uba54\uc2dc\uc9c0"],del_board_success:l["\uac8c\uc2dc\ud310\uc0ad\uc81c \uc548\ub0b4\uba54\uc2dc\uc9c0"],del_boards_success:l["\ubcf5\uc218\uac1c \uac8c\uc2dc\ud310\uc0ad\uc81c \uc548\ub0b4\uba54\uc2dc\uc9c0"],"\ucd94\uac00":c["\ucd94\uac00"]},p=!1,d=t.View.extend({initialize:function(e){var t=e||{};this.deptId=t.deptId,this.status=t.status||s.STATUS_ACTIVE,this.deptBoardNodes=new s.Collection(null,{deptId:this.deptId,status:this.status}),this.boardTitleView=null,this.boardTreeConfigView=null},events:{"click a.btnToggleAddMenu":"_onClickToggleAddMenu","click a.btnBoardDelete":"_onClickBoardDelete","click a.btnBoardStop":"_onClickBoardStop","click #checkAll":"_onClickCheckAll","click .btnAddBoard":"_onClickAddBoard","click .btnAddGroup":"_onClickAddGroup","click .btnAddSeperator":"_onClickAddSeperator","click a.btnBoardMigration":"_onClickBoardMigration","click a.btnBoardSortable":"_onClickSortableToggle","click a.btnToggleNodes":"_onClickToggleNodes"},render:function(){console.debug("[board] DeptBoardAdmin:render call"),this.$el.html(f({lang:h},{toolbar:o})),this._renderBoardTitle(),this._renderBoardTree()},remove:function(){t.View.prototype.remove.apply(this,arguments),this.boardTitleView&&(this.boardTitleView.remove(),this.boardTitleView=null),this.boardTreeConfigView&&(this.boardTreeConfigView.remove(),this.boardTreeConfigView=null)},_renderBoardTitle:function(){this.boardTitleView=a.render({el:".content_top",dataset:{name:h.board_admin}})},_renderBoardTree:function(){var e=this,t=this.deptBoardNodes;return n.promise(function(n,s){t.fetch({silent:!0,success:function(t){var n=new i.BoardTreeConfigView({nodes:t});n.setElement(e.$("#board-tree-config")),n.render(),e.boardTreeConfigView=n},error:s,statusCode:{403:function(){r.util.error("403",{msgCode:"400-board"})},404:function(){r.util.error("404",{msgCode:"400-board"})},500:function(){r.util.error("500")}}})})},_getCheckedBoardIds:function(){var t=[];return this.$("input:checkbox[name=board_id]:checked").each(function(n,r){t.push(e(r).val())}),t},_addFolder:function(){this.boardTreeConfigView&&this.boardTreeConfigView.addNode(new s.Model({nodeType:u.NODETYPE_FOLDER,nodeValue:l["\uc0c8\ub85c\uc6b4 \uadf8\ub8f9\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]}))},_addSeperator:function(){this.boardTreeConfigView&&this.boardTreeConfigView.addNode(new s.Model({nodeType:u.NODETYPE_SEPERATOR,nodeValue:l["\uc0c8\ub85c\uc6b4 \uad6c\ubd84\uc120\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]}))},_onClickToggleNodes:function(t){var n=e(t.currentTarget),r=n.attr("data-state");t.preventDefault();if(this.boardTreeConfigView===null)return;r==="opened"?(this.boardTreeConfigView.foldAllNodes(),n.attr("data-state","closed"),n.find("span.txt").text(h.open_all)):(this.boardTreeConfigView.unfoldAllNodes(),n.attr("data-state","opened"),n.find("span.txt").text(h.close_all))},_onClickToggleAddMenu:function(t){var n=e(t.currentTarget),r=n.siblings(".addActionContextMenu");t.preventDefault(),r.toggle()},_onClickBoardDelete:function(t){var n=this,i=this._getCheckedBoardIds(),s=i.length,o;t.preventDefault();if(p===!0){e.goSlideMessage(c["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(i.length===0){e.goMessage(h.not_select_board);return}o=this.deptBoardNodes.findByBoardId(parseInt(i[0])),e.goConfirm(h.delete_title,h.delete_confirm,function(){e.ajax({type:"DELETE",data:JSON.stringify({ids:i}),dataType:"json",contentType:"application/json",url:r.config("contextRoot")+"api/board/status/deleted",beforeSend:function(){p=!0}}).done(function(t){var i="";s>1?i=r.i18n(h.del_boards_success,{arg1:s}):s===1&&(i=r.i18n(h.del_board_success,{arg1:o.getBoardName()})),e.goSlideMessage(i),r.EventEmitter.trigger("boardTree","changed:nodes",!0),n.render()}).fail(function(t){t.status==403?e.goSlideMessage(c["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+c["\uad00\ub9ac\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."],"caution"):e.goSlideMessage(c["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."],"caution")}).complete(function(){p=!1})})},_onClickBoardStop:function(t){var n=this,i=this._getCheckedBoardIds(),s=i.length,o;t.preventDefault();if(p===!0){e.goSlideMessage(c["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(i.length==0){e.goMessage(h.not_select_board);return}o=this.deptBoardNodes.findByBoardId(parseInt(i[0])),e.goConfirm(h.stop_board,h.stop_confirm,function(){e.ajax(r.config("contextRoot")+"api/board/status/closed",{type:"PUT",data:JSON.stringify({ids:i}),dataType:"json",contentType:"application/json",beforeSend:function(){p=!0}}).done(function(t){var i="";s>1?i=r.i18n(h.stop_boards_success,{arg1:s}):s===1&&(i=r.i18n(h.stop_board_success,{arg1:o.getBoardName()})),e.goSlideMessage(i),r.EventEmitter.trigger("boardTree","changed:nodes",!0),n.render()}).fail(function(t){t.status==403?e.goSlideMessage(c["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+c["\uad00\ub9ac\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."],"caution"):e.goSlideMessage(c["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."],"caution")}).complete(function(){p=!1})})},_onClickCheckAll:function(t){this.$("input:checkbox[name=board_id]").attr("checked",e(t.currentTarget).is(":checked"))},_onClickAddBoard:function(t){var n=e(t.currentTarget).closest(".addActionContextMenu");n.hide(),r.router.navigate("board/create",{trigger:!0})},_onClickAddGroup:function(t){var n=e(t.currentTarget).closest(".addActionContextMenu");this._addFolder(),n.hide()},_onClickAddSeperator:function(t){var n=e(t.currentTarget).closest(".addActionContextMenu");n.hide(),this._addSeperator()},_onClickBoardMigration:function(t){var n=this,i=this._getCheckedBoardIds();t.preventDefault();if(p===!0){e.goSlideMessage(c["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(i.length==0){e.goMessage(h.not_select_board);return}e.goOrgSlide({type:"department",contextRoot:r.contextRoot,callback:e.proxy(function(t){var s='<p class="add">'+r.i18n(l["\uac8c\uc2dc\ud310 {{arg1}}\ub85c \uc774\ub3d9"],{arg1:t.name})+"</p>";e.goConfirm(h.board_migration,s,function(){e.ajax({type:"PUT",async:!0,data:JSON.stringify({ids:i}),dataType:"json",contentType:"application/json",url:r.config("contextRoot")+"api/board/transfer/dept/"+t.id}).done(function(t){e.goMessage(h.change_success),r.EventEmitter.trigger("board","changed:deptBoard",!0),n.render(),e.goOrgSlide.close()}).fail(function(t){t.status==403?e.goAlert(c["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+"<br/>"+c["\uad00\ub9ac\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."]):e.goAlert(c["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])})})},this)})},_onClickSortableToggle:function(e){e.preventDefault(),this._isSortableMode()?this._distroyNodeSortable():this._enableNodeSortable()},_enableNodeSortable:function(){if(!this.boardTreeConfigView)return;e(".btnBoardStop").hide(),e(".btnBoardDelete").hide(),e(".btnToggleAddMenu").hide(),e(".btnBoardMigration").hide(),this.boardTreeConfigView.enableSortable(),this.$(".tb-header").addClass("tb_stair_edit"),this._changeSortButtonText(h.board_reorder_save)},_distroyNodeSortable:function(){if(!this.boardTreeConfigView)return;e(".btnBoardStop").show(),e(".btnBoardDelete").show(),e(".btnToggleAddMenu").show(),e(".btnBoardMigration").show(),this.boardTreeConfigView.destroySortable(),this.$(".tb-header").removeClass("tb_stair_edit"),this._changeSortButtonText(h.board_reorder)},_isSortableMode:function(){return this.$("#board-tree-config").hasClass("tb_stair_edit")},_changeSortButtonText:function(t){e(".btnBoardSortable").find("span.txt").html(t)}});return d});