define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("when"),i=require("board/views/board_title"),s=require("board/models/dept_board"),o=require("board/models/board_config"),u=require("hgn!board/templates/board_create"),a=require("hgn!board/templates/board_modify"),f=require("hgn!board/templates/board_create_manager"),l=require("hgn!board/templates/board_create_owners"),c=require("hgn!board/templates/board_create_owners_data"),h=require("hgn!board/templates/board_create_public"),p=require("hgn!board/templates/board_create_public_data"),d=require("hgn!board/templates/board_create_public_members"),v=require("hgn!board/templates/board_create_header"),m=require("i18n!board/nls/board"),g=require("i18n!nls/commons");require("jquery.go-orgslide"),require("jquery.go-popup"),require("jquery.go-sdk");var y=GO.session(),b=GO.contextRoot+"api/",w={anonym_flag:m["\uc775\uba85 \uc124\uc815"],anonym_desc:m["\u203b \uc775\uba85 \uc124\uc815\uc740 \ub098\uc911\uc5d0 \ubcc0\uacbd\ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],board_add:m["\uac8c\uc2dc\ud310 \ucd94\uac00"],board_modify:g["\uac8c\uc2dc\ud310 \uc124\uc815"],board_add_desc:m["\uac8c\uc2dc\ud310 \ucd94\uac00\ud558\uae30"],search_detail:g["\uc0c1\uc138\uac80\uc0c9"],search:g["\uac80\uc0c9"],where:m["\uac8c\uc2dc\ud310\uadf8\ub8f9"],title:g["\uc81c\ubaa9"],desc:m["\uc124\uba85"],board_desc_null:m["\uac8c\uc2dc\ud310 \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."],type:m["\uc720\ud615"],classic:m["\ud074\ub798\uc2dd"],feed:m["\ud53c\ub4dc"],manager:m["\uc6b4\uc601\uc790"],manager_add:m["\uc6b4\uc601\uc790 \ucd94\uac00"],manager_select:m["\uc6b4\uc601\uc790 \uc120\ud0dd"],manager_select_desc:m["\uc6b4\uc601\uc790\ub97c \uc120\ud0dd\ud558\uc138\uc694."],share:m["\uacf5\uc720"],share_setting:m["\uacf5\uc720 \ubd80\uc11c \uc124\uc815"],share_desc:m["\uacf5\uc720 \uc124\uba85"],use:m["\uc0ac\uc6a9\ud568"],unuse:g["\uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc74c"],share_dept_desc:m["\uacf5\uc720\ubd80\uc11c\uc9c0\uc815"],share_dept_select:m["\uacf5\uc720\ubd80\uc11c \uc120\ud0dd"],share_dept_select_desc:m["\uacf5\uc720\ud560 \ubd80\uc11c\ub97c \uc120\ud0dd\ud558\uc138\uc694."],share_low_dept:m["\ud558\uc704 \ubd80\uc11c\uc5d0 \uacf5\uc720\ud568"],perm_write_read:m["\uc5f4\ub78c, \uc791\uc131 \ubaa8\ub450 \ud5c8\uc6a9"],perm_only_read:m["\uc5f4\ub78c\ub9cc \ud5c8\uc6a9"],dept_share:m["\ud2b9\uc815 \ubd80\uc11c\uc640 \uacf5\uc720\ud568"],dept_share_add:m["\uacf5\uc720 \ubd80\uc11c \ucd94\uac00"],close_set:m["\ube44\uacf5\uac1c \uc124\uc815"],open_set_desc:m["\uacf5\uac1c \uc124\uc815 \uc124\uba85"],open_member_desc:m["\uacf5\uac1c \uba64\ubc84 \uc9c0\uc815"],open_dept_member:m["\uacf5\uac1c \ubd80\uc11c \uba64\ubc84 \uc124\uc815"],open_member_select:m["\uc5f4\ub78c\uc790 \uc120\ud0dd"],open_member_add:m["\uc5f4\ub78c\uc790 \ucd94\uac00"],open_member_select_desc:m["\uac8c\uc2dc\ud310 \uc5f4\ub78c\uc790\ub97c \ucd94\uac00\ud558\uc138\uc694."],open_dept_name:m["\ubd80\uc11c\uba85"],open_dept_value:m["\ubd80\uc11c \uacf5\uac1c \uc5ec\ubd80"],open_all:m["\uc804\uccb4\uacf5\uac1c"],open_dept_write_perm:m["\uc791\uc131\uad8c\ud55c"],board_add_confirm:g["\ud655\uc778"],board_add_submit:m["\ub9cc\ub4e4\uae30"],board_add_cancel:g["\ucde8\uc18c"],modify:g["\uc218\uc815"],stop:m["\uc911\uc9c0"],board_stop:m["\uac8c\uc2dc\ud310 \uc911\uc9c0"],board_stop_desc:m["\uac8c\uc2dc\ud310 \uc911\uc9c0 \uc124\uba85"],board_delete:m["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],board_delete_desc:m["\uac8c\uc2dc\ud310 \uc0ad\uc81c \uc124\uc815"],setting:g["\uc124\uc815"],"delete":g["\uc0ad\uc81c"],me:m["\ub098"],save_success:g["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],add_board_alert:m["\uac8c\uc2dc\ud310\uc774 \ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],header:m["\ub9d0\uba38\ub9ac"],header_placeholder:m["\ub9d0\uba38\ub9ac\uba85 \uc785\ub825"],header_add:m["\ub9d0\uba38\ub9ac \ucd94\uac00"],header_subject:m["\ub9d0\uba38\ub9ac \uc81c\ubaa9"],modify_done:g["\uc218\uc815\uc644\ub8cc"],comment_flag:m["\ub313\uae00 \uc791\uc131"],comment_flag_true:g["\ud5c8\uc6a9"],comment_flag_false:g["\ud5c8\uc6a9\ud558\uc9c0 \uc54a\uc74c"],alert_board_type:m["\uac8c\uc2dc\ud310 \uc720\ud615\uc740 \ub098\uc911\uc5d0 \ubcc0\uacbd\ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],header_required_option:m["\uac8c\uc2dc\ubb3c \ub4f1\ub85d\uc2dc \ubc18\ub4dc\uc2dc \uc120\ud0dd\ud558\uac8c \ud568"],send_mail_title:g["\uba54\uc77c\ubc1c\uc1a1 \ud0c0\uc774\ud2c0"],send_mail_tooltip:g["\uba54\uc77c\ubc1c\uc1a1 \ud234\ud301"],yes:g["\uc608"],no:g["\uc544\ub2c8\uc624"],delete_title:m["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],delete_confirm:m["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],delete_success:g["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]},E=t.View.extend({rootIdName:"",formName:"formBoardCreate",isSaveDone:!0,events:{"click a#formCreateRegist":"boardSave","click a#formCreateCancel":"boardSaveCancel","click a#formCreateDelete":"boardDelete","click span#btnAddManager":"addBoardManagers","click span#btnAddOwners":"addBoardOwners","click ul.name_tag li span.ic_del":"deleteMember","click div#ownersTable span.ic_basket":"deleteOwner","click input[name=sharedFlag]:radio":"toggleSharedFlag","click input[name=publicFlag]:radio":"togglePublicFlag","click input[name=lowRankFlag]:checkbox":"toggleLowRankFlag","click input[name=headerFlag]:radio":"toggleHeaderFlag","click input[name=type]:radio":"toggleTypeFlag","click input#ownersUse:checkbox":"toggleOwners","click #publicFlagOptionTable span[data-id]":"addPublicMember","change select[name=deptId]":"changeDept","click input#statusDeleted":"toggleStatus","click input#statusClosed":"toggleStatus","click #headerAdd":"headerAdd","click span[data-btntype='headerModify']":"headerModify","click span.headerText":"headerModify","click span[data-btntype='headerSave']":"headerSave","click span[data-btntype='headerDelete']":"headerDelete","click span[data-btntype='headerCancel']":"headerCancel","keyup input#headerName":"headerInputValidation","click .btn-add-select-node":"_addChildNodesSelect"},initialize:function(e){this.options=e||{},this.boardId=e.boardId,this.boardModel=this._getBoardModel(),this.isSaveDone=!0},render:function(){var t=this,n=[],r={};this.isCreateMode()?(this.$el.html(u({isCreate:this.isCreateMode(),isOrgServiceOn:GO.session("useOrgAccess"),lang:w})),this._makeDeptSelectList().then(_.bind(this._setBoardOperator,this))):(this.boardModel.get("actions").managable||GO.util.error("403",{msgCode:"400-board"}),r.dataset=this.boardModel.toJSON(),e.each(r.dataset.owners,function(e,t){t.ownerType=="Company"&&GO.util.error("403",{msgCode:"400-board"}),t.ownerShip=="MASTER"?(r.dataset.masterOwner=t,r.dataset.masterOwner.ownerInfo||(r.dataset.masterOwner.ownerInfo=r.dataset.deptText)):t.ownerShip=="JOINT"&&n.push(t)}),r.dataset.jointOnwers=n,this.$el.html(a(e.extend(r,{isClassic:function(){return this.dataset.type=="CLASSIC"?!0:!1},isStream:function(){return this.dataset.type=="STREAM"?!0:!1},isAnonym:function(){return this.dataset.anonymFlag?!0:!1},lang:w,isOrgServiceOn:GO.session("useOrgAccess")}))),this.boardDataset(r.dataset)),i.render({el:".content_top",dataset:{name:this.isCreateMode()?w.board_add:w.board_modify}})},_addChildNodesSelect:function(t){var n=this,r=".select-node",i=this.$(r).last(),s=i.data("parentid"),o=this.$("select[name=deptId]").val(),u={deptId:o};this.$(r).length>1&&(u.parentId=i.val()),e.ajax(b+"/department/board/folders",{data:u,contentType:"application/json",dataType:"json"}).then(function(t){if(t.data&&t.data.length===0)e.goSlideMessage("\ud558\uc704 \ud3f4\ub354\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.");else{var r=i.parent();r.nextAll(".wrap_select").remove(),r.after(n._makeSelectNode(t.data))}})},_makeSelectNode:function(t){var n=this.$(".select-node").length,r=n>1?n-1:1,i=e('<span class="wrap_select"><select name="parentId-'+r+'" class="select-node"></select></span>'),s=[];return _.each(t,function(e){s.push(this._makeFolderOptionHtml(e))},this),i.find("select").html(s.join("\n")),i},_makeDeptSelectList:function(){var t=this,i=[],s=r.defer(),o=this.rootId;return e.ajax(b+"department/list/joined").then(function(u){u.data.length?(_.each(u.data,function(e,n){i.push(t._makeFolderOptionHtml(e,o))}),t.$("select[name=deptId]").html(i.join("\n")),s.resolve(i.join("\n"))):(n.router.navigate("board",{trigger:!0,replace:!0}),e.goAlert(w.board_add_desc,m["\ubd80\uc11c\uac00 \uc124\uc815\ub418\uc9c0 \uc54a\uc544 \uac8c\uc2dc\ud310\uc744 \ucd94\uac00 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),s.reject())}),s.promise},_makeFolderOptionHtml:function(e,t){var n=t&&e.id===t?' selected="selected"':"";return'<option value="'+e.id+'"'+n+">"+e.name+"</option>"},_setBoardOperator:function(){this.$("#boardManagers li.creat").before(f({isMe:!0,name:y.name,id:y.id,positionName:y.position,lang:w}))},isCreateMode:function(){return!this.boardId},boardDataset:function(t){var n=this,r=this.$el.find('form[name="'+n.formName+'"]');e.each(t.managers,function(e,t){n.addBoardManagerEl(t,"cteate")}),t.sharedFlag&&(r.find('input[name="sharedFlag"][value="true"]').attr("checked",!0),this.toggleSharedFlag(),r.find('input[name="lowRankFlag"]').attr("checked",t.lowRankFlag),this.toggleLowRankFlag(),r.find('input[name="lowPermission"][value="'+t.masterOwner.permission+'"]').attr("checked",!0),t.jointOnwers.length&&(r.find("input#ownersUse").attr("checked",!0),this.toggleOwners(),e.each(t.jointOnwers,function(e,t){n.addBoardOwnerEl({id:t.ownerId,name:t.ownerInfo,checked:t.permission==1?!1:!0}),t.ownerShip=="JOINT"&&t.scope=="PART"&&n.getJoinMembers(t.id,t.ownerId)}))),t.masterOwner&&t.masterOwner.scope=="PART"&&n.getJoinMembers(t.masterOwner.id,t.masterOwner.ownerId),t.status=="CLOSED"&&n.$el.find("#statusClosed").attr("checked",!0),t.publicFlag&&(this.$el.find('form[name="'+n.formName+'"] input[name="publicFlag"][value="true"]').attr("checked",!0),this.togglePublicFlag()),this.$el.find('input[name="headerFlag"][value="'+t.headerFlag+'"]').attr("checked",!0),this.$el.find('input[name="commentFlag"][value="'+t.commentFlag+'"]').attr("checked",!0),this.$el.find('input[name="sendMailFlag"][value="'+t.sendMailFlag+'"]').attr("checked",!0);if(t.postHeaders.length||t.headerFlag){this.$el.find('input[name="headerRequiredFlag"]').attr("checked",t.headerRequiredFlag),this.toggleHeaderFlag();var i=v({dataset:t.postHeaders,lang:w});n.$el.find("#headerListPart").append(i),n.$el.find('#headerFlagOption tr[data-headerdeleteflag="true"]').hide()}},changeDept:function(){this.setSharedDeptName(),this.setPublicData(),e.goOrgSlide("close")},getSelectedDeptOption:function(){var e={},t=this.$el.find("select[name=deptId] option:selected");return t.length?(e.id=t.val(),e.text=t.text()):(e.id=this.$el.find("input[name=deptId]").val(),e.text=this.$el.find("input[name=deptText]").val()),e},setSharedDeptName:function(){return this.$el.find("#sharedDeptName").html(this.getSelectedDeptOption().text)},setPublicData:function(){var t=[p({name:this.getSelectedDeptOption().text,id:this.getSelectedDeptOption().id,lang:w})];this.$el.find("#ownersTable>table>tbody>tr").each(function(){t.push(p({name:e(this).find("th").text(),id:e(this).attr("data-id"),lang:w}))}),this.$el.find("#publicFlagOptionTable").html(h({lang:w})),this.$el.find("#publicFlagOptionTable>table>tbody").html(t.join(""))},addBoardOwnerEl:function(t){var n=e("#ownersTable .in_table"),r=e('form[name="formBoardCreate"] [name="deptId"]').val();if(t&&!n.find('tr[data-id="'+t.id+'"]').length){if(t.id==r)return!1;n.length||(e("#ownersTable").append(l({lang:w})),n=e("#ownersTable .in_table")),n.find("tbody").append(c(e.extend(t,{lang:w}))),e("#publicFlagOptionTable tbody").append(p(e.extend(t,{lang:w})))}},addBoardOwners:function(t){e.goOrgSlide({target:t,header:w.share_dept_select,type:"department",desc:w.share_dept_select_desc,contextRoot:GO.contextRoot,callback:this.addBoardOwnerEl,target:t})},addBoardManagerEl:function(t,n){var r=_.isArray(t)?t:[t],i=e("#boardManagers");_.each(r,function(t){t&&!i.find('li[data-id="'+t.id+'"]').length&&(t.id===y.id&&(t.isMe=!0,t.position=y.position),t.displayName||(t.displayName=t.name+(t.positionName?" "+t.positionName:"")),i.find("li.creat").before(f(e.extend(t,{lang:w}))))})},getSharedDeptIds:function(){var t=[];return this.$el.find("input#ownersUse:checkbox").is(":checked")&&(t=this.$el.find("#ownersTable tr[data-id]").map(function(t,n){return e(n).attr("data-id")}).get()),t},addBoardManagers:function(t){var n=this,r=this.$el.find("[name=deptId]").val(),i=this.getSharedDeptIds()||[],s=this.$el.find('input[name="sharedFlag"]:checked').val();e.goOrgSlide({header:w.manager_select,memberTypeLabel:w.manager,desc:w.manager_select_desc,target:t,contextRoot:GO.contextRoot,isMyDeptOpened:!1,loadId:r,includeLoadIds:i,hideOrg:s=="false"?!0:!this.$el.find("#lowRankFlag").is(":checked"),callback:n.addBoardManagerEl,target:t,accessOrg:!0,isCustomType:!0,externalLang:g,isBatchAdd:!0})},addPublicMember:function(t,n){var r=this,i=e(t.currentTarget).attr("data-id")||n.deptId,s=r.$el.find('#publicFlagOption tr[data-id="'+i+'"]'),o=s.find("span.public_all"),u=s.find("ul.name_tag"),a=this.$el.find('input[name="sharedFlag"]:checked').val(),f=function(t){var n=_.isArray(t)?t:[t];_.each(n,function(t){if(t&&!u.find('li[data-id="'+t.id+'"]').length){t.deptId=i,t.displayName=t.name+(t.position?" "+t.position:"");var n=d(e.extend(t,{lang:w}));u.find(".creat").before(n)}u.trigger("contentChanged.public")});return};u.bind("contentChanged.public",function(){u.find("li:not(.creat)").length?(o.hide(),u.show()):(o.show(),u.hide())});var l=function(t,n){var i=e(t.currentTarget),s=r.$el.find('[name="deptId"]').val();return n=="false"?!0:s!=i.closest("tr").attr("data-id")?!0:!r.$el.find("#lowRankFlag").is(":checked")};t.currentTarget?e.goOrgSlide({header:w.open_member_select,desc:w.open_member_select_desc,contextRoot:GO.contextRoot,loadId:i,callback:f,hideOrg:l(t,a),target:t,isCustomType:!0,externalLang:g,memberTypeLabel:g["\uc5f4\ub78c\uc790"],isBatchAdd:!0}):f(n)},deleteMember:function(t){var n=e(t.currentTarget).parents("ul.name_tag");e(t.currentTarget).parents("li").remove(),n.trigger("contentChanged.public")},deleteOwner:function(t){var n=this.$el.find("#ownersTable>table, #publicFlagOptionTable>table"),r=e(n[0]),i=n.find("tbody");i.find('tr[data-id="'+e(t.currentTarget).attr("data-id")+'"]').remove(),r.find("tbody>tr").length||r.remove()},toggleOwners:function(){var t=this,n=this.$el.find("#ownersOption"),r=this.$el.find("input#ownersUse:checkbox").is(":checked"),i=n.find("tr[data-id]");e.goOrgSlide("close"),r?n.show():n.hide(),i.length&&e(i).each(function(n,i){var s=t.$el.find('#publicFlagOptionTable tr[data-id="'+e(i).attr("data-id")+'"]');r?s.show():s.hide()})},toggleLowRankFlag:function(){var t=this.$el.find("#lowRankPermission");e.goOrgSlide("close"),this.$el.find("#lowRankFlag").is(":checked")?t.show():t.hide(),this.setPublicLowRankText()},toggleSharedFlag:function(){var t=this.$el.find("input[name=sharedFlag]:radio:checked").val(),n=this.$el.find("#sharedFlagOption");e.goOrgSlide("close"),t=="true"?(n.show(),this.setSharedDeptName()):(n.hide(),this.$el.find("#ownersTable").empty()),this.setPublicData(),this.setPublicLowRankText()},toggleHeaderFlag:function(){var e=this.$el.find("input[name=headerFlag]:radio:checked").val(),t=this.$el.find("#headerFlagOption");e=="true"?t.show():t.hide()},toggleTypeFlag:function(){var e=this.$el.find("input[name=type]:radio:checked").val(),t=this.$el.find("#typeFlagOption td, #typeFlagOption th"),n=this.$el.find("#typeFlagLine td");e=="CLASSIC"?(t.show(),n.show()):(t.hide(),n.hide())},togglePublicFlag:function(){var e=this.$el.find("input[name=publicFlag]:radio:checked").val(),t=this.$el.find("#publicFlagOption");e=="true"?(t.show(),this.setPublicData(),this.setPublicLowRankText()):t.hide()},setPublicLowRankText:function(){var e=null,t=this.$el.find('[name="deptId"]').val(),n=this.$el.find('input[name=sharedFlag][value="true"]').is(":checked"),r=this.$el.find("#lowRankFlag").is(":checked"),i=this.$el.find('#publicFlagOptionTable tr[data-id="'+t+'"] th strong');n&&r&&(e="&nbsp;("+m["\ud558\uc704 \ubd80\uc11c \ud3ec\ud568"]+")"),i.html(e)},toggleStatus:function(t){var n=e(t.currentTarget);n.val()=="DELETED"&&this.$el.find("#statusClosed").attr("disabled",n.is(":checked"))},boardSaveCancel:function(){var t=this;if(this.isCreateMode())e.goConfirm(g["\ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],g["\uc785\ub825\ud558\uc2e0 \uc815\ubcf4\uac00 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4."],function(){t.render()});else{var r="board/"+t.boardId;n.router.navigate(r,{trigger:!0})}},boardDelete:function(){var t=this,r=[];r.push(t.boardId),e.goConfirm(w.delete_title,w.delete_confirm,function(){e.ajax({type:"DELETE",async:!0,data:JSON.stringify({ids:r}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"api/board/status/deleted"}).done(function(t){e.goMessage(w.delete_success),n.router.navigate("board",{trigger:!0,replace:!0})}).fail(function(t){t.status==403?e.goAlert(g["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+"<br/>"+g["\uc6b4\uc601\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."]):e.goAlert(g["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])})})},boardFormValidation:function(){var t=this.$el.find("form[name="+this.formName+"]"),r=t.find('input[name="name"]'),i=e.trim(r.val()),s=t.find('[name="description"]'),o=function(t,n){return e.goError(t,n?n:""),n&&n.addClass("error").focus(),!1};if(r.length){if(!i)return o(m["\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694."],r),!1;if(!e.goValidation.isCheckLength(2,64,i))return o(n.i18n(m["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"}),r),!1}return s.length&&!e.goValidation.isCheckLength(0,2e3,s.val())?(o(n.i18n(m["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"2000"}),s),!1):!0},boardSave:function(){var t=this,r=this.$el.find("form[name="+this.formName+"]"),i=r.find("[name=deptId]").val(),s=this.$el.find("#ownersUse").is(":checked"),o=null,u=[],a=null,f=[],l=this.$(".select-node").length>1?this.$(".select-node").last().val():null,c=function(i){if(!t.isSaveDone)return;t.isSaveDone=!1,i.save({},{success:function(r,i){GO.EventEmitter.trigger("common","layout:clearOverlay",!0);if(i.code=="200"){t.isCreateMode()?e.goMessage(w.add_board_alert):e.goMessage(w.save_success);if(r.get("publicFlag")){var s=[],o=_.filter(r.get("owners"),function(e){return e.ownerType=="User"});if(o.length!=0){e.each(r.get("managers"),function(){s.push(this.id)}),s=_.union(s,o);if(e.inArray(y.id,s)<0){n.router.navigate("board",!0);return}}}t.isCreateMode()?n.router.navigate("board/"+i.data.id,!0):n.router.navigate("board/"+i.data.id+"/admin",!0)}else e.goMessage(i.message);t.isSaveDone=!0,GO.EventEmitter.trigger("board","changed:deptBoard",!0)},error:function(n,i){GO.EventEmitter.trigger("common","layout:clearOverlay",!0);var s=JSON.parse(i.responseText);s.message&&e.goError(s.message),s.name=="board.name.duplicated"&&(s.focus="name"),s.focus&&r.find('input[name="'+s.focus+'"]').focus(),t.isSaveDone=!0;return}})};if(!this.boardFormValidation())return!1;GO.EventEmitter.trigger("common","layout:setOverlay",!0),o=this.boardModel,this.isCreateMode()?o.set({deptId:i,parentId:l},{silent:!0}):(o.clear(),o.set("id",this.boardId,{silent:!0})),e(r.serializeArray()).each(function(e,t){t.name=="managerIds"?u.push(t.value):o.set(t.name,t.value,{silent:!0})}),a=o.get("publicFlag"),this.$el.find('form[name|="owners"]').each(function(n,r){var u={};e(e(r).serializeArray()).each(function(e,t){u[t.name]=t.value});if(s||!s&&u.deptId==i)a=="false"?u.scope="ALL":u.ownerType=="Department"?(t.$el.find('form[name|="owners-'+u.ownerId+'-member"]').length?u.scope="PART":u.scope="ALL",u.permission=u.permission||1):u.scope="ALL",u.ownerType=="User"&&(i==u.deptId?t.$el.find("input#sharedFlag1").is(":checked")?t.$el.find("input#lowRankFlag").is(":checked")?u.permission=o.get("lowPermission")||1:u.permission=3:u.permission=3:t.$el.find('form[name="owners-'+u.deptId+'"] input[name="permission"]').is(":checked")?u.permission=3:u.permission=1),u.permission=u.permission||1,f.push(u)}),f.push({ownerShip:"MASTER",ownerType:"Department",ownerId:i,scope:a=="false"||t.$el.find('form[name|="owners-'+i+'-member"]').length==0?"ALL":"PART",permission:this.$('input[name="lowRankFlag"]').is("checked")?o.get("lowPermission"):3});var h=[],p=this.$el.find("input[name=headerFlag]:radio:checked").val(),d=this.$el.find("input[name=headerRequiredFlag]").is(":checked"),v=0;p=="true"&&(this.$el.find('tr[data-type="headerPart"]').each(function(){h.push({id:e(this).attr("data-headerid"),name:e(this).attr("data-headername"),deletedFlag:e(this).attr("data-headerdeleteflag")}),e(this).attr("data-headerdeleteflag")=="true"&&v++}),h.length-v<1&&(p=!1,d=!1)),o.set({managerIds:u,owners:f,lowRankFlag:o.get("sharedFlag")=="false"?"false":o.get("lowRankFlag"),headerFlag:p,headerRequiredFlag:d,postHeaders:h},{silent:!0}),o.get("status")=="DELETED"?e.goCaution(m["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],m["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],function(){o.destroy({success:function(e,t){n.router.navigate("board",{trigger:!0,replace:!0}),GO.EventEmitter.trigger("board","changed:deptBoard",!0),GO.EventEmitter.trigger("board","changed:favorite",!0)}})}):c(o)},headerAdd:function(){var t=this.$el.find("#headerName"),n=e.trim(t.val()),r=!1;if(!n)return t.focus(),!1;this.$el.find('tr[data-type="headerPart"]').each(function(){if(e(this).attr("data-headername")==n){e(this).attr("data-headerdeleteflag","false"),e(this).show(),t.val(""),r=!0;return}});if(!r){var i=[];i.push({name:n});var s=tplBoardCreateViewHeaderPart({dataset:i,lang:w});e("#headerListPart").append(s),t.val("")}},headerModify:function(t){var n=e(t.currentTarget).parents("tr").first();return n.find("span.headerTextPart").hide().end().find("span.headerInputPart").show(),!1},headerSave:function(t){var n=e(t.currentTarget).parent(),r=n.parents("tr").first(),i=n.siblings("input").val(),s=r.find("span.headerText");return r.attr("data-headername",i),r.find("span.headerTextPart").show(),s.html(i),r.find("span.headerInputPart").hide(),!1},headerCancel:function(t){var n=e(t.currentTarget).parents("tr").first(),r=n.find("span.headerTextPart"),i=n.find("span.headerInputPart");return r.show(),i.hide(),i.find("input").val(r.text().trim()),!1},headerDelete:function(t){var n=e(t.currentTarget),r=n.parents("tr").first();r.attr("data-headerdeleteflag","true"),r.hide()},headerInputValidation:function(t){var n=e.goValidation.realLength(e("#headerName").val());parseInt(n)>14?e("#headerName").val(e("#headerName").attr("data-value")):(e("#headerByte").text(n),e("#headerName").attr("data-value",e("#headerName").val()))},_getBoardModel:function(){return this.isCreateMode()?new s:o.get(this.boardId)}});return E});