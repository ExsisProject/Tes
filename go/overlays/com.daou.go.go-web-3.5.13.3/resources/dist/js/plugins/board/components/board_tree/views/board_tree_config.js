define("board/components/board_tree/views/board_tree_config",function(require){function c(){var e=[];return e.push('<li class="empty-message">'),e.push('<p class="data_null">'),e.push('<span class="ic_data_type ic_no_contents"></span>'),e.push('<span class="txt">'),e.push(a["\ub4f1\ub85d\ub41c \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),e.push("</span>"),e.push("<br />"),e.push("</p>"),e.push("</li>"),e.join("")}var e=require("when"),t=require("app"),n=require("board/components/board_tree/views/base_board_tree"),r=require("board/models/board_tree_node"),i=require("text!board/components/board_tree/templates/board_tree_config.html"),s=require("board/components/layer/views/share_scope"),o=require("board/constants"),u=require("i18n!nls/commons"),a=require("i18n!board/nls/board"),f=require("i18n!admin/nls/admin");require("jquery.go-popup");var l=5,h=n.extend({template:i,sortableState:!1,closedNodes:[],events:{"click .btn-board-admin":"_onClickBoardAdmin","click .btnSaveNode":"_onClickSaveNode","click .btnEditNode":"_onClickEditNode","click .btnRemoveNode":"_onClickNodeRemove","click .btnCancelAddNode":"_onClickCancelAddNode","click .btnCancelEditNode":"_onClickCancelEditNode","click .btnToggleNode":"_onClickToggleNode","change select[name=homeExposureFlag]":"_onChangeHomeExposure",'click [data-type="btnOwners"]':"_onClickBtnOwners"},initialize:function(e){n.prototype.initialize.apply(this,arguments),this.sortableState=!1},render:function(){n.prototype.render.apply(this,arguments),this.sortableState&&this.enableSortable(),this.isRootNode()&&this._renderEmptyMessageIfNoData()},reload:function(){var e=this;this.$el.empty(),this.boardTreeNodes.fetch({success:function(){e.render()}})},enableSortable:function(){function t(e){e.sortable({item:"li.node",handle:".ic_drag",scroll:!1,connectWith:".board-tree-nodes",appendTo:document.body,helper:function(e,t){return n(t.find(".node-title:first").text())},stop:r,receive:r,remove:function(e,t){var n=$(this);n.find("li.node").length<1&&n.remove()}})}function n(e){var t=$('<span class="board_name dragging">'+e+"</span>");return t.css({width:200,height:10}),t}function r(t,n){var r=n.item,i=r.closest(".board-tree-nodes"),s=i.children("li.node").index(r),o=e._getNodeModel(r),u=r.parents("li.node").get(0),a=null;if(!i.is(this))return;u&&(a=e._getNodeModel(u).getNodeId()),e._moveNode(o,a,s)}var e=this;this.$el.addClass("tb_stair_edit"),t(this.$el),t(this.$el.find(".board-tree-nodes")),this.$("li.node .node-title").draggable({scroll:!1,appendTo:"body",cursorAt:{left:0,top:0},helper:function(e){var t=$(e.currentTarget);return n(t.text())},start:function(){$(this).data("startingScrollTop",$(document.body).scrollTop())},drag:function(e,t){var n=parseInt($(this).data("startingScrollTop"));t.position.top-=n}}),this.$("li.folder > .item").droppable({accept:".node-title",drop:function(t,n){var r=n.draggable.closest("li"),i=$(this).closest("li"),s=e._getNodeModel(i),o=s.getNodeId(),u=e._getNodeModel(r),f=u.getNodeId(),l=e.boardTreeNodes.getChildrenCount(o);if(r.is(i))return;if(!s)return;if(i.parents("li.folder[data-id="+f+"]").length>0){$.goSlideMessage(a["\uc0c1\uc704\uadf8\ub8f9\uc744 \ud558\uc704\uadf8\ub8f9\uc73c\ub85c \uc774\ub3d9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}o!==u.getParentId()&&e._moveNode(u,o,l).then(function(){e.reload()})}}),this.sortableState=!0},destroySortable:function(){this.$el.removeClass("tb_stair_edit"),$(".board-tree-nodes.ui-sortable").sortable("destroy"),this.$("li.node .node-title").draggable("destroy"),this.$("li.folder > .item").droppable("destroy"),this.sortableState=!1},getTemplateVars:function(e){var t=n.prototype.getTemplateVars.apply(this,arguments);return t.managerList=this._getFormattedManagerName(e),t.isAdminService=e.isAdminService(),t.isHomeExposureBoard=e.isHomeExposureBoard(),t.isDeptShared=e.isDeptShared(),t.hasCompanyShare=e.hasCompanyShare(),t.lang={modify:u["\uc218\uc815"],save:u["\uc800\uc7a5"],remove:u["\uc0ad\uc81c"],cancel:u["\ucde8\uc18c"],setting:u["\uc124\uc815"],open:u["\uc5f4\uae30"],range:f["\uacf5\uac1c \ubc94\uc704"]},t},getIconType:function(e){var t=e.get("nodeType"),n;return e.isFolderNode()?n="folder":e.isBoardNode()?n="board":e.isCompanyShareNode()?n="board":e.isSeperatorNode()&&(n="delimiter"),n},addNode:function(e){var t=this,n=this.createNodeElement(e,{isEditingMode:!0});this.$el.find(".empty-message").remove(),this.$el.append(n),this._bindNodeEnterEvent(n)},isClosedNode:function(e){return _.indexOf(this.closedNodes,e.getNodeId())>-1},foldNode:function(e){console.debug("[board] BoardTreeConfigView: foldNode call");var t=e.data("id");e.find(".board-tree-nodes:first").hide(),e.find(".btnToggleNode:first").removeClass("ic_stair_close").addClass("ic_stair_open"),this._addClosedNode(parseInt(e.data("id")))},unfoldNode:function(e){console.debug("[board] BoardTreeConfigView: unfoldNode call"),e.find(".board-tree-nodes:first").show(),e.find(".btnToggleNode:first").removeClass("ic_stair_open").addClass("ic_stair_close"),this._removeClosedNode(parseInt(e.data("id")))},foldAllNodes:function(){var e=this;this.$("li.folder").each(function(t,n){var r=$(this);e.foldNode(r)})},unfoldAllNodes:function(){var e=this;this.$("li.folder").each(function(){var t=$(this);e.unfoldNode(t)})},getBoardAdminUrl:function(e){return"board/"+e.getBoardId()+"/admin"},_getEmptyMessageEl:function(){return this.$el.find(".empty-message")},_removeEmptyMessage:function(){if(!this.isRootNode())return;this._getEmptyMessageEl().remove()},_renderEmptyMessageIfNoData:function(){if(!this.isRootNode())return;this._removeEmptyMessage(),this.boardTreeNodes.length<1&&this.$el.html(c())},_addClosedNode:function(e){_.indexOf(this.closedNodes,parseInt(e))<0&&this.closedNodes.push(e)},_removeClosedNode:function(e){var t=_.indexOf(this.closedNodes,parseInt(e));t>-1&&this.closedNodes.splice(t,1)},_onClickToggleNode:function(e){var t=$(e.currentTarget),n=t.closest("li");e.stopImmediatePropagation(),t.hasClass("ic_stair_open")?this.unfoldNode(n):this.foldNode(n)},_getNodeModel:function(e){var t=$(e).data("id");if(!t)return;return this.boardTreeNodes.get(parseInt(t))},_getFormattedManagerName:function(e){var n="",r=e.getManagerNames();if(r.length>1){var i=r.shift();n=t.i18n(a["\uac8c\uc2dc\ud310 \ub300\ud45c\uc6b4\uc601\uc790 \ud45c\uc2dc"],{args1:i,args2:r.length})}else r.length===1?n=r[0]:n="-";return n},_moveNode:function(t,n,r){var i=this;return t.move(r,n).then(function(){return i._triggerChangeEvent(),$.goSlideMessage(a["\uc21c\uc11c\ubcc0\uacbd\uc774 \uc801\uc6a9\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),e.resolve()})},_onClickBoardAdmin:function(e){var n=$(e.currentTarget),r=n.closest("li"),i=r.data("id"),s=this.boardTreeNodes.get(i);e.stopImmediatePropagation(),t.router.navigate(this.getBoardAdminUrl(s),{trigger:!0})},_onClickEditNode:function(e){var t=this,n=$(e.currentTarget),r=n.closest("li"),i=r.data("id"),s=this.boardTreeNodes.get(parseInt(i));this._toggleNodeTitleInput(s,r,!0),this._removeEmptyMessage()},_onClickSaveNode:function(e){var t=this,n=$(e.currentTarget),r=n.closest("li");this._saveNode(r)},_toggleNodeTitleInput:function(e,t,n){var r=this.createNodeElement(e,{isEditingMode:n||!1});t.find(".item:first").replaceWith(r.find(".item:first")),n?this._bindNodeEnterEvent(t):t.off("keyup")},_saveNode:function(n){function l(e,t){var n="",r=t||!1;r&&e.isFolderNode()?n=a["\uadf8\ub8f9\uc774 \ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]:!r&&e.isFolderNode()?n=a["\uadf8\ub8f9\uc774 \uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]:r&&e.isSeperatorNode()?n=a["\uad6c\ubd84\uc120\uc774 \ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]:!r&&e.isSeperatorNode()&&(n=a["\uad6c\ubd84\uc120\uc774 \uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),n&&n.length>0&&$.goSlideMessage(n)}var r=this,i=n.data("type"),s=n.data("id"),o=n.find("input:text").val();if(!$.goValidation.isCheckLength(2,64,o))return $.goSlideMessage(t.i18n(a["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"})),!1;var u,f=!1;return s?u=e.promise(function(e,t){var n=r.boardTreeNodes.get(s).get("nodeValue");r.boardTreeNodes.get(s).save({nodeValue:o,title:o},{success:e,error:function(e,r){return e.set({nodeValue:n,title:n}),t(r)}})}):(f=!0,u=this.boardTreeNodes.createNode(i,o)),u.then(function(t){return n.attr("data-id",t.getNodeId()),r._toggleNodeTitleInput(t,n),r._renderEmptyMessageIfNoData(),r._triggerChangeEvent(),l(t,f),e.resolve(t)},function(e){e.responseJSON.name=="name.duplicated"&&$.goSlideMessage(a["\uadf8\ub8f9\uba85\uc774 \uc911\ubcf5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])})},_onClickCancelAddNode:function(e){var t=this,n=$(e.currentTarget),r=n.closest("li");e.preventDefault(),r.remove(),this._renderEmptyMessageIfNoData()},_onClickCancelEditNode:function(e){var t=this,n=$(e.currentTarget),r=n.closest("li"),i=r.data("id"),s=this.boardTreeNodes.get(parseInt(i));e.preventDefault(),this._toggleNodeTitleInput(s,r)},_onClickBtnOwners:function(e){var t=$(e.currentTarget),n=t.closest("li"),r=$.goPopup({header:f["\uacf5\uac1c \ubc94\uc704"],pclass:"layer_normal layer_share_scope",width:330,modal:!0,allowPrevPopup:!1,buttons:[{btext:u["\ud655\uc778"],btype:"confirm",autoclose:!0}],contents:""}),i=new s({shares:this._getNodeModel(n)});i.render()},_onClickNodeRemove:function(e){function c(e){var t="";switch(e){case o.NODETYPE_FOLDER:t=a["\uac8c\uc2dc\ud310 \uadf8\ub8f9 \uc0ad\uc81c"];break;case o.NODETYPE_SEPERATOR:t=a["\uad6c\ubd84\uc120 \uc0ad\uc81c"]}return t}var n=this,r=$(e.currentTarget),i=r.closest("li"),s=i.data("id"),f=i.data("type"),l=this.boardTreeNodes.get(parseInt(s));e.preventDefault(),e.stopImmediatePropagation();if(this.boardTreeNodes.hasChildren(s)){$.goSlideMessage(a["\uac8c\uc2dc\ud310\uc774 \uc788\uac70\ub098 \ud558\uc704\uadf8\ub8f9\uc774 \uc788\ub294 \uacbd\uc6b0 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}$.goConfirm(c(f),t.i18n(a["\uac8c\uc2dc\ud310 \ub178\ub4dc \uc0ad\uc81c \uba54\uc2dc\uc9c0"],{args1:l.getNodeValue()}),function(){n.boardTreeNodes.destroyNode(s).then(function(t){i.remove(),n._renderEmptyMessageIfNoData(),$.goSlideMessage(u["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.boardTreeNodes.trigger("sync"),n._triggerChangeEvent()})})},_canAddHomeExposure:function(){var e=this.boardTreeNodes.filter(function(e){return e.isBoardNode()&&e.getBoardModel().get("homeExposureFlag")});return this.boardTreeNodes.isAdminService()&&e.length<l},_onChangeHomeExposure:function(e){var n=this,r=$(e.currentTarget),i=r.closest("li"),s=parseInt(i.data("id")),o=this.boardTreeNodes.get(s),a=o.getBoardId(),f=r.val();if(!this.boardTreeNodes.isAdminService())return;if(f==="true"&&!this._canAddHomeExposure()){$.goSlideMessage(t.i18n(u["\ucd5c\ub300 {{arg1}}\uac1c \uae4c\uc9c0 \uc124\uc815\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],{arg1:l}),"caution"),this.reload();return}$.ajax({url:t.config("contextRoot")+"ad/api/company/board/"+a+"/change/exposure?homeExposureFlag="+f,type:"PUT",success:function(e){e.code==200?($.goSlideMessage(u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),o.setBoardAttrs("homeExposureFlag",f==="true")):($.goSlideMessage(u["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."],"caution"),n.reload())},error:function(){$.goSlideMessage(u["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."],"caution"),n.reload()}})},_bindNodeEnterEvent:function(e){var t=this;e.find("input:first").on("keyup",function(n){var r=n.keyCode?n.keyCode:n.which;13===parseInt(r)&&t._saveNode(e)})},_triggerChangeEvent:function(){t.EventEmitter.trigger("boardTree","changed:nodes")}});return h});