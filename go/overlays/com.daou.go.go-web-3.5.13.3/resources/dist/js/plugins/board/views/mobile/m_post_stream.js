define(["views/mobile/m_more_list","jquery","backbone","i18n!nls/commons","i18n!board/nls/board","app","views/mobile/header_toolbar","hgn!board/templates/mobile/m_post_stream","board/collections/post_stream","board/views/mobile/m_post_attaches","board/models/post_more_content","board/models/board_config","json","json2","jquery.go-validation","jquery.placeholder","GO.util","jquery.go-sdk"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h={comment_count:i["\ub313\uae00"],sort_update:i["\ub313\uae00 \ub4f1\ub85d \uae30\uc900"],past_feed:i["\uc608\uc804 \ud53c\ub4dc \ubcf4\uae30"],term_custom:i["\uc0ac\uc6a9\uc790 \uc9c0\uc815"],save:r["\uc800\uc7a5"],cancel:r["\ucde8\uc18c"],modify:r["\uc218\uc815"],del:r["\uc0ad\uc81c"],comment:i["\uac1c\uc758 \ub367\uae00"],all_view:i["\ubaa8\ub450 \ubcf4\uae30"],comment_modify:i["\ub367\uae00 \uc218\uc815"],comment_delete:i["\ub367\uae00 \uc0ad\uc81c"],comment_save:i["\ub313\uae00 \uc791\uc131"],close:r["\ub2eb\uae30"],more_view:i["\ub354 \ubcf4\uae30"],more_content:i["\ub354\ubcf4\uae30"],content_fold:r["\uc811\uae30"],no_content:i["\uc544\uc9c1 \ub4f1\ub85d\ub41c \uae00\uc774 \uc5c6\uc2b5\ub2c8\ub2e4. \uae00\uc744 \ub4f1\ub85d\ud574 \uc8fc\uc138\uc694."],confirm_delete:i["\uac8c\uc2dc\uae00\uc744 \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],confirm_delete_message:i["\uc0ad\uc81c\ud655\uc778\uba54\uc138\uc9c0"],confirm_comment_delete_message:i["\ub313\uae00\uc0ad\uc81c\ud655\uc778\uba54\uc138\uc9c0"],alert_fail:r["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."],label_like:i["\uc88b\uc544\uc694"],title_recommend:r["\uc88b\uc544\uc694 \ud558\uae30"],title_recommender:r["\uc88b\uc544\uc694 \ub204\ub978 \uc0ac\ub78c"],title_recommend_cancel:r["\uc88b\uc544\uc694 \ucde8\uc18c"],title_open:r["\ud3bc\uce58\uae30"],title_close:r["\uc811\uae30"],user_count:r["\uba85"]},p=e.extend({initialize:function(e){this.options=e||{},GO.util.appLoading(!0),this.offset=GO.config("mobileListOffset")||20,this.sorts="createdAt desc",this.boardId=this.options.boardId,this.boardModel=c.get(this.boardId),this.bbsWritable=this.options.writable,this.owner=this.options.owner,this.isCommunity=this.options.isCommunity,this.boardData=this.options.boardModel,this.unbindEvent(),this.bindEvent(),this.renderToolBar(),this.collection=new a([],{boardId:this.boardId}),GO.EventEmitter.trigger("common","layout:scrollToTop",this),this.addLoaderOnce=!0,this.$listEl=null,this.lastSeparateDate=null;var n={sorts:this.sorts},r={listFunc:t.proxy(function(e){this._renderPage(e)},this)};this.setRenderListFunc(r),this.setFetchInfo(n,this.collection)},unbindEvent:function(){this.$el.off("vclick",'a[data-btntype="postmodify"]'),this.$el.off("vclick",'a[data-btntype="postdelete"]'),this.$el.off("vclick",'a[data-btntype="recommend"]'),this.$el.off("vclick","a.comment_view"),this.$el.off("vclick","a#recommend_view"),this.$el.off("vclick",'span[data-btntype="moreBtn"]'),this.$el.off("vclick",'span[data-btntype="closeBtn"]'),this.$el.off("vclick",'span[data-type="externalUrl"]'),this.$el.off("vclick","div.meta_info_wrap a")},bindEvent:function(){this.$el.on("vclick",'a[data-btntype="postmodify"]',t.proxy(this.postModify,this)),this.$el.on("vclick",'a[data-btntype="postdelete"]',t.proxy(this.postDelete,this)),this.$el.on("vclick",'a[data-btntype="recommend"]',t.proxy(this.actionRecommend,this)),this.$el.on("vclick","a.comment_view",t.proxy(this.moveToComment,this)),this.$el.on("vclick","a#recommend_view",t.proxy(this.moveToRecommend,this)),this.$el.on("vclick",'span[data-btntype="moreBtn"]',t.proxy(this.contentMoreAction,this)),this.$el.on("vclick",'span[data-btntype="closeBtn"]',t.proxy(this.contentCloseAction,this)),this.$el.on("vclick",'span[data-type="externalUrl"]',t.proxy(this.externalUrl,this)),this.$el.on("vclick","div.meta_info_wrap a",t.proxy(this.externalUrl,this))},renderToolBar:function(){var e=this,t={title:this.boardData.name,isList:!0,isSideMenu:!0,isHome:!0,isSearch:!0};this.bbsWritable&&(t.isWriteBtn=!0,t.writeBtnCallback=function(){var t=e.isCommunity?"community":"board";t+="/post/write/"+e.owner.ownerId+"/"+e.boardId,GO.router.navigate(t,{trigger:!0})}),o.render(t)},externalUrl:function(e){var n=t(e.currentTarget);return GO.util.externalUrl(n.attr("data-url")),!1},render:function(){this.dataFetch().done(t.proxy(function(e){this.renderListFunc.listFunc(e),this.scrollToEl()},this)),GO.util.appLoading(!1)},_renderPage:function(e){var t=e.page&&e.page.page>0?!0:!1;t&&this.$listEl?this.$listEl.append(this.makeTemplete({collection:this.getStreamData(e),type:"more",boardId:this.boardId})):(this.$el.append(this.makeTemplete({collection:this.getStreamData(e),type:"",boardId:this.boardId})),this.$listEl=this.$("ul.feed_type")),this.setBtnMore(),f.initImageView(this.$el),GO.util.appLoading(!1)},listMore:function(){var e=this.collection.page;if(e.lastPage)return!1;var t={page:parseInt(e.page+1,10)||0,offset:this.offset,sorts:this.sorts};this.collection.fetch({data:t})},getStreamData:function(e){var n=this,r=new Date,i=[];return t.each(e.toJSON(),function(e,t){if(!GO.util.isSameDate(r,t.createdAt)){var s=GO.util.shortDate(t.createdAt);n.lastSeparateDate!=s&&(n.lastSeparateDate=s,i.push({isSeparator:!0,date:s}))}i.push(t)}),i},setBtnMore:function(e){this.collection.page.lastPage?t("#pullUp").hide():t("#pullUp").show()},contentMoreAction:function(e){var n=t(e.currentTarget),r=n.parents("li").first(),i=r.attr("data-postid"),s=GO.contextRoot+"api/board/"+this.boardId+"/post/"+i+"/content",o=this;t.go(s,"",{qryType:"GET",contentType:"application/json",responseFn:function(e){e.code==200&&(n.parent().find("span.expander").hide(),n.parent().find('span[data-btntype="moreBtn"]').hide(),n.before('<span class="contentMore">'+GO.util.convertMobileRichText(e.data.content)+"</span>"),n.parent().find('span[data-btntype="closeBtn"]').show())}})},contentCloseAction:function(e){var n=t(e.currentTarget);return n.parent().find("span.expander").show(),n.parent().find("span.contentMore").remove(),n.parent().find('span[data-btntype="moreBtn"]').show(),n.parent().find('span[data-btntype="closeBtn"]').hide(),!1},getPostId:function(e){return e?t(e.currentTarget).parents("li").first().attr("data-postId"):!1},actionRecommend:function(e){var n=t(e.currentTarget),r=this.getPostId(e),i=this.collection.get(r),s=i.get("recommend");n.blur(),e.stopPropagation(),e.preventDefault(),t.go(GO.contextRoot+"api/board/"+this.boardId+"/post/"+r+"/recommend","",{qryType:s?"DELETE":"POST",contentType:"application/json",responseFn:function(e){var t=!s,r=n.parents("div.optional");i.set("recommend",t),r.find("span.txt").text(e.data.recommendCount),r.find("span#txt_count").text(e.data.recommendCount),s?(r.find("#recommendHeart").removeClass("on"),r.find("#heartImg").attr("src","/resources/images/mobile/ic_heart.png")):(r.find("#recommendHeart").addClass("on"),r.find("#heartImg").attr("src","/resources/images/mobile/ic_heart_on.png"))},error:function(){console.log("error")}});return},postModify:function(e){var n=t(e.currentTarget).parents("li").first(),r=n.attr("data-postId"),i=[];r&&(this.isCommunity?i=["community/post/put",this.owner.ownerId,this.boardId,r]:i=["board/post/put",this.owner.ownerId,this.boardId,r],s.router.navigate(i.join("/"),!0))},postDelete:function(e){var t=this;if(!confirm(GO.util.br2nl(h.confirm_delete_message)))return!1;t.postDeleteAction(e)},postDeleteAction:function(e){var n=this,r=t(e.target).parents("li"),i=r.attr("data-postId"),o=this.collection.page&&this.collection.page.page||0;if(!i)return!1;var u=GO.contextRoot+"api/board/"+this.boardId+"/post/"+i;t.go(u,{},{qryType:"DELETE",contentType:"application/json",responseFn:function(e){r.fadeOut(500,function(){var e="";n.isCommunity?e="community/"+n.owner.ownerId+"/board/"+n.boardId:e="board/"+n.boardId,s.router.navigate(e,{trigger:!0,replace:!0})})}})},makeTemplete:function(e){var t=e.collection,n=e.type,r=e.boardId,i=e.bbsWritable,s=this,r=function(){return s.boardId},o=function(){return s.collection.length>0?"":"none"},a=function(e){return GO.util.snsDate(this.createdAt)},l=function(e){return GO.util.snsDate(this.createdAt)},c=function(e){return parseInt(this.recommendCount)==0?e=="zero"?"zero":"none":""},p=function(){if(parseInt(this.commentsCount)<4)return"none"},d=function(){return this.comments?this.comments.length:0},v=function(){return this.recommend?"btn_plus_favo":"btn_plus"},m=function(){if(this.attaches)return f.render({attaches:this.attaches,postId:this.id,boardId:r})},g=function(){return this.attaches&&this.attaches.length>0?!0:!1},y=function(){var e=GO.util.escapeHtml(this.summary);return GO.util.ckeckBrCnt(e)>8?GO.util.splitBrContent(e):GO.util.convertMobileRichText(this.summary)},b=function(){var e=GO.util.escapeHtml(this.summary);if(GO.util.ckeckBrCnt(e)>8||this.summarizedFlag)return!0},w=function(){return GO.util.convertMobileRichText(this.message)},E=function(){return this.extention.toLowerCase()=="gif"?!0:!1},S=function(){var e="def";return GO.util.fileExtentionCheck(this.extention)&&(e=this.extention),e},x=u({isPageZero:n=="more"?!1:!0,contextRoot:GO.contextRoot,dataset:t,boardId:r,isZero:c,commentCheck:p,repliesCnt:d,postAttachFiles:m,isRecommend:v,dateParse:a,commentParse:l,isListNull:o,lang:h,attachWrap:g,contentParse:y,commentMessage:w,bbsWritable:i,checkFileType:S,summarizedFlagSet:b,isCommentFlag:function(){return s.boardModel.get("commentFlag")||this.commentsCount!=0},isAlimPost:function(){return this.notiMailFlag||this.notiPushFlag?!0:!1},isGif:E});return x},contentToEscape:function(e){return e=e.replace(/<br\>/gi,"\n"),e=e.replace(/&nbsp;/gi," "),e},moveToComment:function(e){this.setSessionInfo(e),e.stopPropagation();var t=this.getPostId(e),n="board/"+this.boardId+"/post/"+t+"/comments";this.isCommunity&&(n="community/"+this.owner.ownerId+"/"+n),s.router.navigate(n,!0)},moveToRecommend:function(e){e.stopPropagation();if(this.boardModel.get("anonymFlag"))return;var t=this.getPostId(e),n="board/"+this.boardId+"/post/"+t+"/recommends";this.isCommunity&&(n="community/"+this.owner.ownerId+"/"+n),s.router.navigate(n,!0)}});return{render:function(e){var t=new p({el:"#content",boardId:e.boardId,isCommunity:e.isCommunity,owner:e.owner,boardModel:e.boardModel,writable:e.writable});return t.render()}}});