define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("when"),i=require("board/views/board_title"),s=require("board/models/dept_board"),o=require("board/models/board_config"),u=require("hgn!board/templates/board_create"),a=require("hgn!board/templates/board_modify"),f=require("hgn!board/templates/board_create_manager"),l=require("hgn!board/templates/board_create_owners"),c=require("hgn!board/templates/board_create_owners_data"),h=require("hgn!board/templates/board_create_public"),p=require("hgn!board/templates/board_create_public_data"),d=require("hgn!board/templates/board_create_public_members"),v=require("hgn!board/templates/board_create_header"),m=require("hgn!board/templates/board_create_anonymous"),g=require("hgn!board/templates/board_create_anonymous_data"),y=require("i18n!board/nls/board"),b=require("i18n!nls/commons");require("jquery.go-orgslide"),require("jquery.go-popup"),require("jquery.go-sdk");var w=n.session(),E=n.contextRoot+"api/",S={anonym_flag:y["\uc775\uba85 \uc124\uc815"],anonym_desc:y["\u203b \uc775\uba85 \uc124\uc815\uc740 \ub098\uc911\uc5d0 \ubcc0\uacbd\ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],public_writer_for_post:y["\uac8c\uc2dc\ubb3c \uc791\uc131\uc790 \uacf5\uac1c \uc124\uc815 \ud5c8\uc6a9"],public_writer_for_post_comment:y["\ub313\uae00 \uc791\uc131\uc790 \uacf5\uac1c \uc124\uc815 \ud5c8\uc6a9"],all_user_option:b["\uc804\uccb4 \uc0ac\uc6a9\uc790"],specific_user_option:y["\uc0ac\uc6a9\uc790 \uc124\uc815"],board_add:y["\uac8c\uc2dc\ud310 \ucd94\uac00"],board_modify:b["\uac8c\uc2dc\ud310 \uc124\uc815"],board_add_desc:y["\uac8c\uc2dc\ud310 \ucd94\uac00\ud558\uae30"],search_detail:b["\uc0c1\uc138\uac80\uc0c9"],search:b["\uac80\uc0c9"],where:y["\uac8c\uc2dc\ud310\uadf8\ub8f9"],title:b["\uc81c\ubaa9"],desc:y["\uc124\uba85"],board_desc_null:y["\uac8c\uc2dc\ud310 \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."],type:y["\uc720\ud615"],classic:y["\ud074\ub798\uc2dd"],feed:y["\ud53c\ub4dc"],manager:y["\uc6b4\uc601\uc790"],manager_add:y["\uc6b4\uc601\uc790 \ucd94\uac00"],manager_select:y["\uc6b4\uc601\uc790 \uc120\ud0dd"],manager_select_desc:y["\uc6b4\uc601\uc790\ub97c \uc120\ud0dd\ud558\uc138\uc694."],share:y["\uacf5\uc720"],share_setting:y["\uacf5\uc720 \ubd80\uc11c \uc124\uc815"],share_desc:y["\uacf5\uc720 \uc124\uba85"],use:y["\uc0ac\uc6a9\ud568"],unuse:b["\uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc74c"],share_dept_desc:y["\uacf5\uc720\ubd80\uc11c\uc9c0\uc815"],share_dept_select:y["\uacf5\uc720\ubd80\uc11c \uc120\ud0dd"],share_dept_select_desc:y["\uacf5\uc720\ud560 \ubd80\uc11c\ub97c \uc120\ud0dd\ud558\uc138\uc694."],share_low_dept:y["\ud558\uc704 \ubd80\uc11c\uc5d0 \uacf5\uc720\ud568"],perm_write_read:y["\uc5f4\ub78c, \uc791\uc131 \ubaa8\ub450 \ud5c8\uc6a9"],perm_only_read:y["\uc5f4\ub78c\ub9cc \ud5c8\uc6a9"],dept_share:y["\ud2b9\uc815 \ubd80\uc11c\uc640 \uacf5\uc720\ud568"],dept_share_add:y["\uacf5\uc720 \ubd80\uc11c \ucd94\uac00"],close_set:y["\ube44\uacf5\uac1c \uc124\uc815"],open_set_desc:y["\uacf5\uac1c \uc124\uc815 \uc124\uba85"],open_member_desc:y["\uacf5\uac1c \uba64\ubc84 \uc9c0\uc815"],open_dept_member:y["\uacf5\uac1c \ubd80\uc11c \uba64\ubc84 \uc124\uc815"],open_member_select:y["\uc5f4\ub78c\uc790 \uc120\ud0dd"],open_member_add:y["\uc5f4\ub78c\uc790 \ucd94\uac00"],open_member_select_desc:y["\uac8c\uc2dc\ud310 \uc5f4\ub78c\uc790\ub97c \ucd94\uac00\ud558\uc138\uc694."],open_dept_name:y["\ubd80\uc11c\uba85"],open_dept_value:y["\ubd80\uc11c \uacf5\uac1c \uc5ec\ubd80"],open_all:y["\uc804\uccb4\uacf5\uac1c"],open_dept_write_perm:y["\uc791\uc131\uad8c\ud55c"],board_add_confirm:b["\ud655\uc778"],board_add_submit:y["\ub9cc\ub4e4\uae30"],board_add_cancel:b["\ucde8\uc18c"],modify:b["\uc218\uc815"],stop:y["\uc911\uc9c0"],board_stop:y["\uac8c\uc2dc\ud310 \uc911\uc9c0"],board_stop_desc:y["\uac8c\uc2dc\ud310 \uc911\uc9c0 \uc124\uba85"],board_delete:y["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],board_delete_desc:y["\uac8c\uc2dc\ud310 \uc0ad\uc81c \uc124\uc815"],setting:b["\uc124\uc815"],"delete":b["\uc0ad\uc81c"],me:y["\ub098"],save_success:b["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],add_board_alert:y["\uac8c\uc2dc\ud310\uc774 \ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],header:y["\ub9d0\uba38\ub9ac"],header_placeholder:y["\ub9d0\uba38\ub9ac\uba85 \uc785\ub825"],header_add:y["\ub9d0\uba38\ub9ac \ucd94\uac00"],header_subject:y["\ub9d0\uba38\ub9ac \uc81c\ubaa9"],modify_done:b["\uc218\uc815\uc644\ub8cc"],comment_flag:y["\ub313\uae00 \uc791\uc131"],comment_flag_true:b["\ud5c8\uc6a9"],comment_flag_false:b["\ud5c8\uc6a9\ud558\uc9c0 \uc54a\uc74c"],alert_board_type:y["\uac8c\uc2dc\ud310 \uc720\ud615\uc740 \ub098\uc911\uc5d0 \ubcc0\uacbd\ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],header_required_option:y["\uac8c\uc2dc\ubb3c \ub4f1\ub85d\uc2dc \ubc18\ub4dc\uc2dc \uc120\ud0dd\ud558\uac8c \ud568"],send_mail_title:b["\uba54\uc77c\ubc1c\uc1a1 \ud0c0\uc774\ud2c0"],send_mail_tooltip:b["\uba54\uc77c\ubc1c\uc1a1 \ud234\ud301"],yes:b["\uc608"],no:b["\uc544\ub2c8\uc624"],delete_title:y["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],delete_confirm:y["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],delete_success:b["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],add_board_group:y["\uac8c\uc2dc\ud310\uadf8\ub8f9"],select_group:y["\uac8c\uc2dc\ud310\uadf8\ub8f9 \uc120\ud0dd"],add_member:y["\uc0ac\uc6a9\uc790 \ucd94\uac00"],select_member:y["\uc0ac\uc6a9\uc790 \uc120\ud0dd"],add_member_desc:y["\uc775\uba85 \uc635\uc158 \uc0ac\uc6a9\uc790\ub97c \ucd94\uac00\ud558\uc138\uc694."],anonymous_option_value:y["\uc775\uba85 \uc635\uc158 \uc124\uc815 \uc5ec\ubd80"],settable:y["\uc124\uc815 \ud5c8\uc6a9 \uc5ec\ubd80"],anonymous_option_member:y["\uc775\uba85 \uc635\uc158 \uba64\ubc84 \uc124\uc815"],anonym_tooltip:y["\uc775\uba85 \uc124\uc815 \ud234\ud301"]},x=t.View.extend({rootKeyName:"deptId",formName:"formBoardCreate",isSaveDone:!0,events:{"click a#formCreateRegist":"boardSave","click a#formCreateCancel":"boardSaveCancel","click a#formCreateDelete":"boardDelete","click span#btnAddManager":"addBoardManagers","click span#btnAddOwners":"addBoardOwners","click ul.name_tag li span.ic_del":"deleteMember","click div#ownersTable span.ic_basket":"deleteOwner","click input[name=sharedFlag]:radio":"toggleSharedFlag","click input[name=publicFlag]:radio":"togglePublicFlag","click input[name=lowRankFlag]:checkbox":"toggleLowRankFlag","click input[name=headerFlag]:radio":"toggleHeaderFlag","click input[name=type]:radio":"toggleTypeFlag","click input#ownersUse:checkbox":"toggleOwners","click #publicFlagOptionTable span[data-id]":"addPublicMember","click #postCommentGroupWrap span[data-id]":"addAnonymousPostCommentMember","click #postGroupWrap span[data-id]":"addAnonymousPostMember","change select[name=deptId]":"changeDept","click input#statusDeleted":"toggleStatus","click input#statusClosed":"toggleStatus","click #headerAdd":"headerAdd","click span[data-btntype='headerModify']":"headerModify","click span.headerText":"headerModify","click span[data-btntype='headerSave']":"headerSave","click span[data-btntype='headerDelete']":"headerDelete","click span[data-btntype='headerCancel']":"headerCancel","keyup input#headerName":"addHeaderLengthValidate","click .btn-add-select-node":"_addChildNodesSelect","keyup span.headerInputPart input:text":"editHeaderLengthValidate","change select.select-node":"_clearSelectedChildren","click input[name=anonymFlag]:radio":"toggleAnonymFlag","click input#publicWriterSettingForPost":"togglePublicWriterForPost","click input#publicWriterSettingForPostComment":"togglePublicWriterForPostComment","click input[name=targetForPost]:radio":"togglePublicWriterPostGroup","click input[name=targetForPostComment]:radio":"togglePublicWriterPostCommentGroup"},initialize:function(e){this.options=e||{},this.boardId=e.boardId,this.deptId=e.deptId,this.boardModel=this._getBoardModel(),this.isSaveDone=!0},render:function(){var t=[],r={},s=!1;this.isCreateMode()?(this.$el.html(u({isCreate:this.isCreateMode(),isOrgServiceOn:n.session("useOrgAccess"),lang:S,boardLang:y,hidePostAuthOption:s})),this._makeDeptSelectList().then(_.bind(this._setBoardOperator,this))):(this.boardModel.isManageable()||n.util.error("403",{msgCode:"400-board"}),r.dataset=this.boardModel.toJSON(),e.each(r.dataset.owners,function(e,i){i.ownerType=="Company"&&n.util.error("403",{msgCode:"400-board"}),i.ownerShip=="MASTER"?(r.dataset.masterOwner=i,r.dataset.masterOwner.ownerInfo||(r.dataset.masterOwner.ownerInfo=r.dataset.deptText)):i.ownerShip=="JOINT"&&t.push(i)}),r.dataset.jointOnwers=t,_.isArray(r.dataset.pathName)&&(r.dataset.pathInfo=n.util.escapeXssFromHtml(r.dataset.pathName.join(" &gt; "))),this.$el.html(a(e.extend(r,{isClassic:function(){return this.dataset.type=="CLASSIC"?!0:!1},isStream:function(){return this.dataset.type=="STREAM"?!0:!1},isAnonym:function(){return this.dataset.anonymFlag?!0:!1},lang:S,boardLang:y,isOrgServiceOn:n.session("useOrgAccess"),hidePostAuthOption:s}))),this.boardDataset(r.dataset)),i.render({el:".content_top",dataset:{name:this.isCreateMode()?S.board_add:S.board_modify}})},addChildNodesSelect:function(t){var r=this,i=".select-node",s=this.$(i).last(),o=this.$(i).first().val(),u={};u[this.rootKeyName]=o,this.$(i).length>1&&(u.parentId=s.val()),e.ajax(n.config("contextRoot")+"api/"+(t||"department")+"/board/folders",{data:u,contentType:"application/json",dataType:"json"}).then(function(t){if(t.data&&t.data.length===0)e.goSlideMessage(y["\uac8c\uc2dc\ud310\uadf8\ub8f9\uc774 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4"]);else{var n=s.parent();n.nextAll(".wrap_select").remove(),n.after(r._makeSelectNode(t.data))}})},_addChildNodesSelect:function(e){this.addChildNodesSelect("department")},_makeSelectNode:function(t){var n=this.$(".select-node").length,r=n>1?n-1:1,i=e('<span class="wrap_select"><select name="parentId-'+r+'" class="select-node"></select></span>'),s=[];return _.each(t,function(e){var t=e.nodeValue||e.title||e.name;s.push(this._makeFolderOptionHtml(e.id,t))},this),i.find("select").html(s.join("\n")),i},toggleAnonymFlag:function(){var e=this.$el.find("input[name=anonymFlag]:radio:checked").val(),t=this.$el.find("#anonymFlagOption");e=="true"?t.show():t.hide()},_makeDeptSelectList:function(){var t=this,i=[],s=r.defer(),o=this.deptId;return e.ajax(E+"department/list/joined").then(function(u){u.data.length?(_.each(u.data,function(e,n){i.push(t._makeFolderOptionHtml(e.id,e.name,o))}),t.$("select[name=deptId]").html(i.join("\n")),s.resolve(i.join("\n"))):(n.router.navigate("board",{trigger:!0,replace:!0}),e.goAlert(S.board_add_desc,y["\ubd80\uc11c\uac00 \uc124\uc815\ub418\uc9c0 \uc54a\uc544 \uac8c\uc2dc\ud310\uc744 \ucd94\uac00 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),s.reject())}),s.promise},_makeFolderOptionHtml:function(e,t,n){var r=n&&e===n?' selected="selected"':"";return'<option value="'+e+'"'+r+">"+_.escape(t)+"</option>"},_setBoardOperator:function(){this.$("#boardManagers li.creat").before(f({isMe:!0,name:w.name,id:w.id,positionName:w.position,lang:S}))},isCreateMode:function(){return!this.boardId},boardDataset:function(t){console.log("boardDataset()"),console.log(t);var n=this,r=this.$el.find('form[name="'+n.formName+'"]');e.each(t.managers,function(e,t){n.addBoardManagerEl(t,"cteate")}),t.sharedFlag&&(r.find('input[name="sharedFlag"][value="true"]').attr("checked",!0),this.toggleSharedFlag(),r.find('input[name="lowRankFlag"]').attr("checked",t.lowRankFlag),this.toggleLowRankFlag(),r.find('input[name="lowPermission"][value="'+t.lowPermission+'"]').attr("checked",!0),t.jointOnwers.length&&(r.find("input#ownersUse").attr("checked",!0),this.toggleOwners(),e.each(t.jointOnwers,function(e,t){n.addBoardOwnerEl({id:t.ownerId,name:t.ownerInfo,checked:t.permission==1?!1:!0}),t.ownerShip=="JOINT"&&t.scope=="PART"&&n.getJoinMembers(t.id,t.ownerId)}))),t.masterOwner&&t.masterOwner.scope=="PART"&&n.getJoinMembers(t.masterOwner.id,t.masterOwner.ownerId),t.status=="CLOSED"&&n.$el.find("#statusClosed").attr("checked",!0),t.publicFlag&&(this.$el.find('form[name="'+n.formName+'"] input[name="publicFlag"][value="true"]').attr("checked",!0),this.togglePublicFlag()),this.$el.find('input[name="headerFlag"][value="'+t.headerFlag+'"]').attr("checked",!0),this.$el.find('input[name="commentFlag"][value="'+t.commentFlag+'"]').attr("checked",!0),this.$el.find('input[name="sendMailFlag"][value="'+t.sendMailFlag+'"]').attr("checked",!0);if(t.postHeaders.length||t.headerFlag){this.$el.find('input[name="headerRequiredFlag"]').attr("checked",t.headerRequiredFlag),this.toggleHeaderFlag();var i=v({dataset:t.postHeaders,lang:S,headerLength:function(){return e.goValidation.realLength(this.name)}});n.$el.find("#headerListPart").append(i),n.sortableHeaderFlag(),n.$el.find('#headerFlagOption tr[data-headerdeleteflag="true"]').hide()}this.togglePublicWriterPostGroup(),this.togglePublicWriterPostCommentGroup(),!_.isUndefined(t.anonymousWriterPostOption)&&!_.isUndefined(t.anonymousWriterPostOption.specificUsers)&&this.getAnonymousOptionTarget(n.$el.find("#postGroupWrap"),t.anonymousWriterPostOption.specificUsers),!_.isUndefined(t.anonymousWriterPostCommentOption)&&!_.isUndefined(t.anonymousWriterPostCommentOption.specificUsers)&&this.getAnonymousOptionTarget(n.$el.find("#postCommentGroupWrap"),t.anonymousWriterPostCommentOption.specificUsers)},getAnonymousOptionTarget:function(t,n){var r=t.find("tbody>tr");_.each(n,function(t){var n={id:t.userId,displayName:t.name,name:t.name,deptId:t.typeId},i=d(e.extend(n,{lang:S}));r.each(function(){e(this).attr("data-id")==t.typeId&&e(this).find(".creat").before(i)})}),t.find("span.public_all").hide(),t.find("ul.name_tag").show()},getJoinMembers:function(t,n){var r=this;e.go(E+"board/"+this.boardId+"/dept/owner/"+t+"/member",{},{qryType:"GET",contentType:"application/json",responseFn:function(i){if(i.code==200){console.log("getJoinMemberResponse"),console.log(i.data);if(i.data.length==0)r.$el.find('#publicFlagOptionTable tr[data-id="'+n+'"] span.public_all')[0].firstChild.nodeValue=y["\uacf5\uac1c/\uacf5\uc720\ub41c \uba64\ubc84\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."];else{var s=r.$el.find('#publicFlagOptionTable tr[data-id="'+t+'"] ul.name_tag');e.each(i.data,function(e,t){r.addPublicMember({},{deptId:n,id:t.ownerId,name:t.ownerInfo})})}s.show(),r.setPublicLowRankText()}}})},changeDept:function(){this.setSharedDeptName(),this.setPublicData(),this.setAnonymousPost(),this.setAnonymousComment(),e.goOrgSlide("close")},getSelectedDeptOption:function(){var e={},t=this.$el.find("select[name=deptId] option:selected");return t.length?(e.id=t.val(),e.text=t.text()):(e.id=this.$el.find("input[name=deptId]").val(),e.text=this.$el.find("input[name=deptText]").val()),e},setSharedDeptName:function(){return this.$el.find("#sharedDeptName").html(this.getSelectedDeptOption().text)},setPublicData:function(){var t=[p({name:this.getSelectedDeptOption().text,id:this.getSelectedDeptOption().id,lang:S})];this.$el.find("#ownersTable>table>tbody>tr").each(function(){t.push(p({name:e(this).find("td").text(),id:e(this).attr("data-id"),lang:S}))}),this.$el.find("#publicFlagOptionTable").html(h({lang:S})),this.$el.find("#publicFlagOptionTable>table>tbody").html(t.join(""))},setAnonymousPost:function(){var t=[g({name:this.getSelectedDeptOption().text,id:this.getSelectedDeptOption().id,lang:S})];this.$el.find("#ownersTable>table>tbody>tr").each(function(){t.push(g({name:e(this).find("td").text(),id:e(this).attr("data-id"),lang:S}))}),this.$el.find("#postGroupWrap").html(m({lang:S})),this.$el.find("#postGroupWrap>table>tbody").html(t.join(""))},setAnonymousComment:function(){var t=[g({name:this.getSelectedDeptOption().text,id:this.getSelectedDeptOption().id,lang:S})];this.$el.find("#ownersTable>table>tbody>tr").each(function(){t.push(g({name:e(this).find("td").text(),id:e(this).attr("data-id"),lang:S}))}),this.$el.find("#postCommentGroupWrap").html(m({lang:S})),this.$el.find("#postCommentGroupWrap>table>tbody").html(t.join(""))},addBoardOwnerEl:function(t){var n=e("#ownersTable .in_table"),r=e('form[name="formBoardCreate"] [name="deptId"]').val();if(t&&!n.find('tr[data-id="'+t.id+'"]').length){if(t.id==r)return!1;n.length||(e("#ownersTable").append(l({lang:S})),n=e("#ownersTable .in_table")),n.find("tbody").append(c(e.extend(t,{lang:S}))),e("#publicFlagOptionTable tbody").append(p(e.extend(t,{lang:S}))),e("#postGroupWrap tbody").append(g(e.extend(t,{lang:S}))),e("#postCommentGroupWrap tbody").append(g(e.extend(t,{lang:S})))}},addBoardOwners:function(t){e.goOrgSlide({target:t,header:S.share_dept_select,type:"department",desc:S.share_dept_select_desc,contextRoot:n.contextRoot,callback:this.addBoardOwnerEl,target:t})},addBoardManagerEl:function(t,n){var r=_.isArray(t)?t:[t],i=e("#boardManagers");_.each(r,function(t){t&&!i.find('li[data-id="'+t.id+'"]').length&&(t.id===w.id&&(t.isMe=!0,t.position=w.position),t.displayName||(t.displayName=t.name+(t.positionName?" "+t.positionName:"")),i.find("li.creat").before(f(e.extend(t,{lang:S}))))})},getSharedDeptIds:function(){var t=[];return this.$el.find("input#ownersUse:checkbox").is(":checked")&&(t=this.$el.find("#ownersTable tr[data-id]").map(function(t,n){return e(n).attr("data-id")}).get()),t},addBoardManagers:function(t){var r=this,i=this.$el.find("[name=deptId]").val(),s=this.getSharedDeptIds()||[],o=this.$el.find('input[name="sharedFlag"]:checked').val();e.goOrgSlide({header:S.manager_select,memberTypeLabel:S.manager,desc:S.manager_select_desc,target:t,contextRoot:n.contextRoot,isMyDeptOpened:!1,loadId:i,includeLoadIds:s,hideOrg:o=="false"?!0:!this.$el.find("#lowRankFlag").is(":checked"),accessOrg:!0,isCustomType:!0,externalLang:b,isBatchAdd:!0,callback:r.addBoardManagerEl})},addAnonymousPostMember:function(t,r){var i=this,s=e(t.currentTarget).attr("data-id")||r.deptId,o=i.$el.find('#postGroupWrap tr[data-id="'+s+'"]'),u=o.find("span.public_all"),a=o.find("ul.name_tag"),f=this.$el.find('input[name="sharedFlag"]:checked').val(),l=function(t){var n=_.isArray(t)?t:[t];_.each(n,function(t){if(t&&!a.find('li[data-id="'+t.id+'"]').length){t.deptId=s,t.displayName=t.name+(t.position?" "+t.position:"");var n=d(e.extend(t,{lang:S}));a.find(".creat").before(n)}a.trigger("contentChanged.anonymous")});return};a.bind("contentChanged.anonymous",function(){a.find("li:not(.creat)").length?(u.hide(),a.show()):(u.show(),a.hide())});var c=function(t,n){var r=e(t.currentTarget),s=i.$el.find('[name="deptId"]').val();return n=="false"?!0:s!=r.closest("tr").attr("data-id")?!0:!i.$el.find("#lowRankFlag").is(":checked")};t.currentTarget?e.goOrgSlide({header:S.add_member,desc:S.add_member_desc,contextRoot:n.contextRoot,loadId:s,callback:l,hideOrg:c(t,f),target:t,isCustomType:!0,externalLang:b,memberTypeLabel:b["\uc0ac\uc6a9\uc790"],isBatchAdd:!0}):l(r)},addAnonymousPostCommentMember:function(t,r){var i=this,s=e(t.currentTarget).attr("data-id")||r.deptId,o=i.$el.find('#postCommentGroupWrap tr[data-id="'+s+'"]'),u=o.find("span.public_all"),a=o.find("ul.name_tag"),f=this.$el.find('input[name="sharedFlag"]:checked').val(),l=function(t){var n=_.isArray(t)?t:[t];_.each(n,function(t){if(t&&!a.find('li[data-id="'+t.id+'"]').length){t.deptId=s,t.displayName=t.name+(t.position?" "+t.position:"");var n=d(e.extend(t,{lang:S}));a.find(".creat").before(n)}a.trigger("contentChanged.anonymousComment")});return};a.bind("contentChanged.anonymousComment",function(){a.find("li:not(.creat)").length?(u.hide(),a.show()):(u.show(),a.hide())});var c=function(t,n){var r=e(t.currentTarget),s=i.$el.find('[name="deptId"]').val();return n=="false"?!0:s!=r.closest("tr").attr("data-id")?!0:!i.$el.find("#lowRankFlag").is(":checked")};t.currentTarget?e.goOrgSlide({header:S.add_member,desc:S.add_member_desc,contextRoot:n.contextRoot,loadId:s,callback:l,hideOrg:c(t,f),target:t,isCustomType:!0,externalLang:b,memberTypeLabel:b["\uc0ac\uc6a9\uc790"],isBatchAdd:!0}):l(r)},addPublicMember:function(t,r){var i=this,s=e(t.currentTarget).attr("data-id")||r.deptId,o=i.$el.find('#publicFlagOption tr[data-id="'+s+'"]'),u=o.find("span.public_all"),a=o.find("ul.name_tag"),f=this.$el.find('input[name="sharedFlag"]:checked').val(),l=function(t){var n=_.isArray(t)?t:[t];_.each(n,function(t){if(t&&!a.find('li[data-id="'+t.id+'"]').length){t.deptId=s,t.displayName=t.name+(t.position?" "+t.position:"");var n=d(e.extend(t,{lang:S}));a.find(".creat").before(n)}a.trigger("contentChanged.public")});return};a.bind("contentChanged.public",function(){a.find("li:not(.creat)").length?(u.hide(),a.show()):(u.show(),a.hide())});var c=function(t,n){var r=e(t.currentTarget),s=i.$el.find('[name="deptId"]').val();return n=="false"?!0:s!=r.closest("tr").attr("data-id")?!0:!i.$el.find("#lowRankFlag").is(":checked")};t.currentTarget?e.goOrgSlide({header:S.open_member_select,desc:S.open_member_select_desc,contextRoot:n.contextRoot,loadId:s,callback:l,hideOrg:c(t,f),target:t,isCustomType:!0,externalLang:b,memberTypeLabel:b["\uc5f4\ub78c\uc790"],isBatchAdd:!0}):l(r)},deleteMember:function(t){var n=e(t.currentTarget).parents("ul.name_tag");e(t.currentTarget).parents("li").remove(),n.trigger("contentChanged.public")},deleteOwner:function(t){var n=this.$el.find("#ownersTable>table, #publicFlagOptionTable>table, #postGroupWrap>table, #postCommentGroupWrap>table"),r=e(n[0]),i=n.find("tbody");i.find('tr[data-id="'+e(t.currentTarget).attr("data-id")+'"]').remove(),r.find("tbody>tr").length||r.remove()},toggleOwners:function(){var t=this,n=this.$el.find("#ownersOption"),r=this.$el.find("input#ownersUse:checkbox").is(":checked"),i=n.find("tr[data-id]");e.goOrgSlide("close"),r?n.show():n.hide(),i.length&&e(i).each(function(n,i){var s=t.$el.find('#publicFlagOptionTable tr[data-id="'+e(i).attr("data-id")+'"]');r?s.show():s.hide()})},toggleLowRankFlag:function(){var t=this.$el.find("#lowRankPermission");e.goOrgSlide("close"),this.$el.find("#lowRankFlag").is(":checked")?t.show():t.hide(),this.setPublicLowRankText()},toggleSharedFlag:function(){var t=this.$el.find("input[name=sharedFlag]:radio:checked").val(),n=this.$el.find("#sharedFlagOption");e.goOrgSlide("close"),t=="true"?(n.show(),this.setSharedDeptName()):(n.hide(),this.$el.find("#ownersTable").empty()),this.setPublicData(),this.setPublicLowRankText()},toggleHeaderFlag:function(){var e=this.$el.find("input[name=headerFlag]:radio:checked").val(),t=this.$el.find("#headerFlagOption");e=="true"?(t.show(),this.sortableHeaderFlag()):t.hide()},sortableHeaderFlag:function(){this.$el.find("#headerListPart").sortable({delay:100,axis:"y",items:"tr",hoverClass:"headerText",start:function(t,n){e.browser.webkit&&(wscrolltop=e(window).scrollTop())},sort:function(t,n){e.browser.webkit&&n.helper.css({top:n.position.top+wscrolltop+"px"})}}),this.$el.find("#headerListPart").disableSelection()},toggleTypeFlag:function(){var e=this.$el.find("input[name=type]:radio:checked").val(),t=this.$el.find("#typeFlagOption td, #typeFlagOption th"),n=this.$el.find("#typeFlagLine td");e=="CLASSIC"?(t.show(),n.show(),this.$el.find(".postAuthOptionArea").show(),this.$el.find(".closePostTitleShowOptionArea").show()):(t.hide(),n.hide(),this.$el.find(".closePostTitleShowOptionArea").hide(),this.$el.find(".closePostTitleShowOption:radio[value=true]").prop("checked",!1),this.$el.find(".closePostTitleShowOption:radio[value=false]").prop("checked",!0),this.$el.find(".postAuthOptionArea").hide(),this.$el.find(".postAuthOption:radio[value=true]").prop("checked",!1),this.$el.find(".postAuthOption:radio[value=false]").prop("checked",!0))},togglePublicFlag:function(){var e=this.$el.find("input[name=publicFlag]:radio:checked").val(),t=this.$el.find("#publicFlagOption");e=="true"?(t.show(),this.setPublicData(),this.setPublicLowRankText()):t.hide()},togglePublicWriterForPost:function(){var t=this.$el.find("div[name=publicWriterDetailForPost]");e("#publicWriterSettingForPost").is(":checked")?t.show():t.hide()},togglePublicWriterForPostComment:function(){var t=this.$el.find("div[name=publicWriterDetailForPostComment]");e("#publicWriterSettingForPostComment").is(":checked")?t.show():t.hide()},togglePublicWriterPostGroup:function(){var t=this.$el.find("input[name=targetForPost]:radio:checked").val();t=="false"?(e("#postGroupWrap").show(),this.setAnonymousPost()):e("#postGroupWrap").hide()},togglePublicWriterPostCommentGroup:function(){var t=this.$el.find("input[name=targetForPostComment]:radio:checked").val();t=="false"?(e("#postCommentGroupWrap").show(),this.setAnonymousComment()):e("#postCommentGroupWrap").hide()},setPublicLowRankText:function(){var e=null,t=this.$el.find('[name="deptId"]').val(),n=this.$el.find('input[name=sharedFlag][value="true"]').is(":checked"),r=this.$el.find("#lowRankFlag").is(":checked"),i=this.$el.find('#publicFlagOptionTable tr[data-id="'+t+'"] th strong');n&&r&&(e="&nbsp;("+y["\ud558\uc704 \ubd80\uc11c \ud3ec\ud568"]+")"),i.html(e)},toggleStatus:function(t){var n=e(t.currentTarget);n.val()=="DELETED"&&this.$el.find("#statusClosed").attr("disabled",n.is(":checked"))},boardSaveCancel:function(){var t=this;if(this.isCreateMode())e.goConfirm(b["\ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],b["\uc785\ub825\ud558\uc2e0 \uc815\ubcf4\uac00 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4."],function(){t.render()});else{var r="board/"+t.boardId;n.router.navigate(r,{trigger:!0})}},boardDelete:function(){var t=this,r=[];r.push(t.boardId),e.goConfirm(S.delete_title,S.delete_confirm,function(){e.ajax({type:"DELETE",async:!0,data:JSON.stringify({ids:r}),dataType:"json",contentType:"application/json",url:n.config("contextRoot")+"api/board/status/deleted"}).done(function(t){e.goMessage(S.delete_success),n.EventEmitter.trigger("board","changed:deptBoard",!0),n.router.navigate("board",{trigger:!0,replace:!0})}).fail(function(t){t.status==403?e.goAlert(b["\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]+"<br/>"+b["\uc6b4\uc601\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."]):e.goAlert(b["\uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4."])})})},boardFormValidation:function(){var t=this.$el.find("form[name="+this.formName+"]"),r=t.find("input[name='name']"),i=e.trim(r.val()),s=t.find('[name="description"]'),o=function(t,n){return e.goError(t,n?n:""),n&&n.addClass("error").focus(),!1};if(r.length){if(!i)return o(y["\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694."],r),!1;if(!e.goValidation.isCheckLength(2,100,i))return o(n.i18n(y["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"100"}),r),!1}return s.length&&!e.goValidation.isCheckLength(0,2e3,s.val())?(o(n.i18n(y["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"0",arg2:"2000"}),s),!1):!0},boardSave:function(){var t=this,r=this.$el.find("form[name="+this.formName+"]"),i=this.$("#deptId").val(),s=this.$el.find("#ownersUse").is(":checked"),o=null,u=[],a=null,f=[],l=this.$(".select-node").length>1?this.$(".select-node").last().val():null,c=function(i){if(!t.isSaveDone)return;t.isSaveDone=!1,i.save({},{success:function(r,i){n.EventEmitter.trigger("common","layout:clearOverlay",!0),n.EventEmitter.trigger("board","changed:deptBoard",!0);if(i.code=="200"){t.isCreateMode()?e.goMessage(S.add_board_alert):e.goMessage(S.save_success);if(r.get("publicFlag")){var s=[],o=_.filter(r.get("owners"),function(e){return e.ownerType=="User"});if(o.length!=0){e.each(r.get("managers"),function(){s.push(this.id)}),s=_.union(s,o);if(e.inArray(w.id,s)<0){n.router.navigate("board",!0);return}}}t.isCreateMode()?n.router.navigate("board/"+i.data.id,!0):n.router.navigate("board/"+i.data.id+"/admin",!0)}else e.goMessage(i.message);t.isSaveDone=!0},error:function(i,s){n.EventEmitter.trigger("common","layout:clearOverlay",!0);var o=JSON.parse(s.responseText);o.message&&e.goError(o.message),o.name=="board.name.duplicated"&&(o.focus="name"),o.focus&&r.find('input[name="'+o.focus+'"]').focus(),t.isSaveDone=!0;return}})};if(!this.boardFormValidation())return!1;n.EventEmitter.trigger("common","layout:setOverlay",!0),o=this.boardModel,this.isCreateMode()||o.clear(),e(r.serializeArray()).each(function(e,t){t.name=="managerIds"?u.push(t.value):o.set(t.name,t.value,{silent:!0})}),this.isCreateMode()?o.set({deptId:i,parentId:l},{silent:!0}):o.set("id",this.boardId,{silent:!0}),a=o.get("publicFlag"),this.$el.find('#publicFlagOptionTable form[name|="owners"], #ownersTable form[name|="owners"]').each(function(n,r){var u={};e(e(r).serializeArray()).each(function(e,t){u[t.name]=t.value});if(s||!s&&u.deptId==i)a=="false"?u.scope="ALL":u.ownerType=="Department"?(t.$el.find('form[name|="owners-'+u.ownerId+'-member"]').length?u.scope="PART":u.scope="ALL",u.permission=u.permission||1):u.scope="ALL",u.ownerType=="User"&&(i==u.deptId?t.$el.find("input#sharedFlag1").is(":checked")?t.$el.find("input#lowRankFlag").is(":checked")?u.permission=o.get("lowPermission")||1:u.permission=3:u.permission=3:t.$el.find('form[name="owners-'+u.deptId+'"] input[name="permission"]').is(":checked")?u.permission=3:u.permission=1),u.permission=u.permission||1,f.push(u)}),f.push({ownerShip:"MASTER",ownerType:"Department",ownerId:i,scope:a=="false"||t.$el.find('form[name|="owners-'+i+'-member"]').length==0?"ALL":"PART",permission:3});var h=[],p=this.$el.find("input[name=headerFlag]:radio:checked").val(),d=this.$el.find("input[name=headerRequiredFlag]").is(":checked"),v=0;p=="true"&&(this.$el.find('tr[data-type="headerPart"]').each(function(t){h.push({id:e(this).attr("data-headerid"),name:e(this).attr("data-headername"),deletedFlag:e(this).attr("data-headerdeleteflag"),sortOrder:t}),e(this).attr("data-headerdeleteflag")=="true"&&v++}),h.length-v<1&&(p=!1,d=!1));var m=e("input[name=publicWriterSettingForPost]:checkbox").is(":checked")||!1,g=e("input[name=publicWriterSettingForPostComment]:checkbox").is(":checked")||!1,b=e("div[name=publicWriterDetailForPost]"),E=e("div[name=publicWriterDetailForPostComment]"),x=b.find("input[name=targetForPost]:radio:checked").val(),T=E.find("input[name=targetForPostComment]:radio:checked").val(),N=b.find("#postGroupWrap>table>tbody>tr"),C=[];N!=undefined&&N.length!=0&&N.each(function(){var t=e(this).attr("data-id"),n=e(this).find("li");n!=undefined&&n.length!=0&&n.each(function(){e(this).hasClass("creat")||C.push({type:"DEPARTMENT",typeId:t,userId:e(this).attr("data-id"),sharedType:"NONE"})})});var k=E.find("#postCommentGroupWrap>table>tbody>tr"),L=[];k!=undefined&&k.length!=0&&k.each(function(){var t=e(this).attr("data-id"),n=e(this).find("li");n!=undefined&&n.length!=0&&n.each(function(){e(this).hasClass("creat")||L.push({type:"DEPARTMENT",typeId:t,userId:e(this).attr("data-id"),sharedType:"NONE"})})});var A=this.createAnonymousOption(m,x,C),O=this.createAnonymousOption(g,T,L);o.set({managerIds:u,owners:f,lowRankFlag:o.get("sharedFlag")=="false"?"false":o.get("lowRankFlag"),headerFlag:p,headerRequiredFlag:d,postHeaders:h,anonymousWriterPostOption:A,anonymousWriterPostCommentOption:O,postAuthOption:this.$el.find(".postAuthOption:checked").val(),closePostTitleShowOption:this.$el.find(".closePostTitleShowOption:checked").val()},{silent:!0}),o.get("status")=="DELETED"?e.goCaution(y["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],y["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],function(){o.destroy({success:function(e,t){n.router.navigate("board",{trigger:!0,replace:!0}),n.EventEmitter.trigger("board","changed:deptBoard",!0),n.EventEmitter.trigger("board","changed:favorite",!0)}})}):c(o)},createAnonymousOption:function(e,t,n){return{allowed:e,allUser:t,specificUsers:n}},headerAdd:function(){var t=this.$el.find("#headerName"),n=e.trim(t.val()),r=!1;if(!n)return t.focus(),!1;this.$el.find('tr[data-type="headerPart"]').each(function(){if(e(this).attr("data-headername")==n){e(this).attr("data-headerdeleteflag","false"),e(this).show(),t.val(""),r=!0;return}});if(!r){var i=[];i.push({name:n});var s=v({dataset:i,lang:S,headerLength:function(){return e.goValidation.realLength(this.name)}});e("#headerListPart").append(s),t.val(""),e("#headerByte").html("0")}},headerModify:function(t){var n=e(t.currentTarget).parents("tr").first();return n.find("span.headerTextPart").hide().end().find("span.headerInputPart").show(),!1},headerSave:function(t){var n=e(t.currentTarget).parent(),r=n.parents("tr").first(),i=n.siblings("input").val(),s=r.find("span.headerText");return r.attr("data-headername",i),r.find("span.headerTextPart").show(),s.html(i),r.find("span.headerInputPart").hide(),!1},headerCancel:function(t){var n=e(t.currentTarget).parents("tr").first(),r=n.find("span.headerTextPart"),i=n.find("span.headerInputPart");return r.show(),i.hide(),i.find("input").val(r.text().trim()),!1},headerDelete:function(t){var n=e(t.currentTarget),r=n.parents("tr").first();r.attr("data-headerdeleteflag","true"),r.hide()},headerLengthValidate:function(t,n,r){var i=e.goValidation.realLength(t.val());parseInt(i)>n?t.val(t.attr("data-value")):(typeof r=="function"&&r(i),t.attr("data-value",t.val()))},addHeaderLengthValidate:function(t){var n=e(t.currentTarget),r=30,i=function(e){var t=n.closest("div");t.find("#headerByte").text(e)};this.headerLengthValidate(n,r,i)},editHeaderLengthValidate:function(t){var n=e(t.currentTarget),r=30,i=function(e){var t=n.closest("span.headerInputPart");t.find("#headerByte").text(e)};this.headerLengthValidate(n,r,i)},_getBoardModel:function(){return this.isCreateMode()?new s:o.get(this.boardId)},_clearSelectedChildren:function(t){var n=e(t.currentTarget).parent();n.nextAll(".wrap_select").remove()}});return x});