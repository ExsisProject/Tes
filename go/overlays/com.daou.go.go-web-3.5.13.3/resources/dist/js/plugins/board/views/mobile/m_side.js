define(function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("hogan"),i=require("app"),s=require("admin/models/board_base_config"),o=require("board/collections/board_favorite"),u=require("board/models/company_board_tree"),a=require("board/models/dept_board_tree"),f=require("board/components/board_tree/board_tree"),l=require("hgn!board/templates/mobile/m_side"),c=require("i18n!board/nls/board"),h=require("i18n!nls/commons"),p={favorite_board:h["\uc990\uaca8\ucc3e\uae30"],company_board:c["\uc804\uc0ac\uac8c\uc2dc\ud310"],new_post:c["\uae00\uc4f0\uae30"],no_board:c["\ub4f1\ub85d\ub41c \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],no_dept:c["\uc18c\uc18d\ub41c \ubd80\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4. \uad00\ub9ac\uc790\uc5d0\uac8c \ubb38\uc758\ud558\uc138\uc694."],confirm:h["\ud655\uc778"],cancel:h["\ucde8\uc18c"]},d=function(){var e='<h3><span class="btn_wrap"><span class="txt_ellipsis">{{title}}</span></span></h3>',t=r.compile(e);return t.render.apply(t,arguments)},v=t.View.extend({events:{"vclick a[data-navigate]":"goBoard"},initialize:function(e){this.options=e||{},this.model=s.read({admin:!1}).toJSON(),i.config("priorityBoard",this.model.priorityBoard),this.companyBoardList=new u.Collection,this.deptBoardList=new a.Collection,this.addMenuEls()},render:function(){return this.renderContent()},renderContent:function(){console.debug("[board] BoardSideView:renderContent call");var e=this;return i.config("priorityBoard")?n.all([this.favoriteRender(),this.deptBoardRender(),this.companyBoardRender()]).then(function(){return e.setSideApp(),n.resolve(e)}):n.all([this.favoriteRender(),this.companyBoardRender(),this.deptBoardRender()]).then(function(){return e.setSideApp(),n.resolve(e)})},deptBoardRender:function(){var e=this,t=this.deptBoardList,r=this.$("#sideDeptBoard");return r.empty(),n.promise(function(n,s){t.fetch({success:function(t){t.each(function(t){var n=t.getBoardTreeNodes(),s=n.filter(function(e){return!e.isSeperatorNode()}),o=["company",i.session("companyId"),"dept"].join("."),u=e._renderMenuTree(s,o);r.append(d({title:t.getDeptName()}),u.el)}),n()},error:s})})},favoriteRender:function(){var t=o.create(),r=this;return n.promise(function(n,s){t.fetch({data:{page:"0",offset:"1000"},success:function(t){var s=t.toJSON(),o=[];r.$favoriteBoardEl.empty();if(!s.length)return n(),!1;e(s).each(function(e,t){t.boardId&&o.push({iconCls:"ic_add_tag",name:t.name,publicFlag:t.publicFlag,"hasRecentPost?":function(){return t.lastPostedAt&&i.util.isCurrentDate(t.lastPostedAt)},navigate:"board/"+t.boardId})}),r.$favoriteBoardEl.append(l({title:p.favorite_board,menus:o,"hasMenu?":function(){return o.length>0}})),n()},error:s})})},companyBoardRender:function(){var e=this,t=this.companyBoardList,r=this.$("#sideCompanyBoard");return r.empty(),n.promise(function(n,s){function o(e){return e.map(function(e){var t=e.get("actions");t&&t.managable&&(t.managable=!1,e.set("actions",t))}),e}t.fetch({success:function(t){t.length>0&&r.show(),t.each(function(t){var n=t.getBoardTreeNodes(),s=n.filter(function(e){return!e.isSeperatorNode()}),u=["company",i.session("companyId"),"company"].join("."),a=e._renderMenuTree(o(s),u);r.append(d({title:c["\uc804\uc0ac\uac8c\uc2dc\ud310"]}),a.el)}),n()},error:s})})},_renderMenuTree:function(e,t){var n=new f.MobileBoardTreeMenuView({nodes:e,menuId:t});return n.$el.addClass("side_depth"),n.render(),n},addMenuEls:function(){var e='<div id="sideFavoriteBoard" />';i.config("priorityBoard")?e+='<div id="sideDeptBoard" /><div id="sideCompanyBoard" />':e+='<div id="sideCompanyBoard" /><div id="sideDeptBoard" />',this.$el.html(e),this.$favoriteBoardEl=this.$el.find("#sideFavoriteBoard")},setSideApp:function(){e("body").data("sideApp",this.packageName)},goBoard:function(t){t.preventDefault(),t.stopPropagation();var n=e(t.currentTarget),r=n.attr("data-navigate");return r&&i.router.navigate(r,{trigger:!0}),!1}},{__instance__:null,create:function(e){return this.__instance__=new this.prototype.constructor({packageName:e}),this.__instance__}});return v});