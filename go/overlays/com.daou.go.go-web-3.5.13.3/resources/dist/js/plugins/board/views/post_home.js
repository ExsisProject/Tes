(function(){define(["jquery","backbone","app","board/models/board_config","board/models/board_favorite","community/models/info","board/views/board_title","board/views/post_stream","board/views/post_bbs","board/views/post_bbs_detail","hgn!board/templates/post_home","hgn!board/templates/board_info","hgn!board/templates/board_owners","hgn!board/templates/board_subscribers","i18n!board/nls/board","i18n!nls/commons","jquery.go-popup","jquery.go-orgslide","jquery.go-sdk"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=null,g={open:v["\uc5f4\uae30"],close:v["\ub2eb\uae30"],copy:v["\ubcf5\uc0ac"],edit:v["\ud3b8\uc9d1"],"delete":v["\uc0ad\uc81c"],member_count:v["\uba85"],confirm:v["\ud655\uc778"],user_name:v["\uc774\ub984"],manager:d["\uc6b4\uc601\uc790"],board_address:d["\uac8c\uc2dc\ud310 \uc8fc\uc18c"],user_email:v["\uc774\uba54\uc77c"],email_admin_name:d["\ub4f1\ub85d\uc790"],email_subscriber_name:d["\uc218\uc2e0\uc790"],email_subscriber:d["\uc774\uba54\uc77c \uc218\uc2e0\uc790"],email_subscription:d["\uc774\uba54\uc77c \uc218\uc2e0"],email_subscriber_null:d["\ub4f1\ub85d\ub41c \uc774\uba54\uc77c \uc218\uc2e0\uc790\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],email_subscriber_select:d["\uc774\uba54\uc77c \uc218\uc2e0\uc790 \uc120\ud0dd"],email_subscriber_delete_msg:d["\uc0ad\uc81c\ud560 \uc218\uc2e0\uc790\ub97c \uc120\ud0dd\ud558\uc138\uc694."],add:d["\ucd94\uac00\ud558\uae30"],board_share_state:d["\uacf5\uac1c/\uacf5\uc720 \ud604\ud669 \ubcf4\uae30"],community_share_state:d["\uacf5\uac1c \ud604\ud669 \ubcf4\uae30"],board_share_state_tiny:d["\uacf5\uac1c/\uacf5\uc720 \ud604\ud669"],community_share_state_tiny:d["\uacf5\uac1c \ud604\ud669"],onwer_target:d["\uacf5\uac1c/\uacf5\uc720 \ub300\uc0c1"],community_onwer_target:d["\uacf5\uac1c \ub300\uc0c1"],board_share_desc:d["\uacf5\uac1c/\uacf5\uc720 \uc124\uba85"],community_share_desc:d["\uacf5\uac1c \uc124\uba85"],dept_name:d["\ubd80\uc11c\uba85"],dept_share_flag:d["\ubd80\uc11c\uacf5\uac1c\uc5ec\ubd80"],write_permission:d["\uc791\uc131\uad8c\ud55c"],board_member:d["\uba64\ubc84\ud655\uc778"],board_urltoclip_ie:d["\uac8c\uc2dc\ud310\uc8fc\uc18c\ubcf5\uc0acIE"],board_urltoclip_etc:d["\uac8c\uc2dc\ud310\uc8fc\uc18c\ubcf5\uc0acETC"],board_url_copy:d["\ubaa8\ubc14\uc77c URL \ubcf5\uc0ac \ubb38\uad6c"],email_subscription_post:v["\uc2e0\uccad\ud558\uae30"],email_subscription_delete:v["\ud574\uc9c0\ud558\uae30"],email_subscription2:v["\uc218\uc2e0\uc911"]},y=t.View.extend({manage:!1,initialize:function(t){this.options=t||{},this.boardId=this.options.boardId,this.postId=this.options.postId,this.refresh=this.options.refresh||!1,this.model=r.get(this.boardId,this.refresh),this.mailExposure=GO.config("mailExposure"),GO.EventEmitter.on("board","change:boardInfo",this.changeBoardInfo,this),this.$el.on("boardInfo:change",e.proxy(this.boardInfoChange,this))},events:{"click ul.simple_info span#copyUrl":"urlToClipboard","click #boardInfoBtn":"setTitleExpander","click span#btnSubscriberAdd":"actionSubscriberAdd","click span#btnSubscriptionUser":"actionSubscriptionUser","click span#btnSubscriberCount":"showSubscribers","click span#btnOwners":"showOwners","mouseover span#btnSubscriptionUser":"subscribersPlaceHolderIn","mouseout span#btnSubscriptionUser":"subscribersPlaceHolderOut"},render:function(){return this.actions=this.model.get("actions"),this.masterOwner=this._getMasterOwner(),this.$el.html(l),this.renderBoardTitle(),this.renderBoardInfo(!this.getFolderStatus()),this.renderContents(),this.refresh=!1,this.el},popupRender:function(){this.actions=this.model.get("actions"),this.masterOwner=this._getMasterOwner(),this.refresh=!1;var e={boardId:this.boardId,owner:this.masterOwner,isCommunity:this._isCommunity(),commentFlag:this.model.get("commentFlag"),sendMailFlag:this.model.get("sendMailFlag"),postId:this.postId};return f.popupRender(e),this.el},changeBoardInfo:function(e){if(e&&e!=this.boardId)return!1;this.model=r.get(this.boardId,!0),this.renderBoardTitle(),this.renderBoardInfo(!this.getFolderStatus())},boardInfoChange:function(){this.model=r.get(this.boardId,!0),this.renderBoardTitle(),this.renderBoardInfo(!this.getFolderStatus())},renderBoardTitle:function(){this.favoriteModel?(this.favoriteModel.clear(),this.favoriteModel.set({boardId:this.boardId,id:this.boardId},{silent:!0})):this.favoriteModel=new i({boardId:this.boardId,id:this.boardId}),o.render({el:".content_top",dataset:e.extend(this.model.toJSON(),{masterOwner:this.masterOwner}),favoriteModel:this.favoriteModel,isCommunity:this._isCommunity()})},renderBoardInfo:function(e){var t=this.model.toJSON(),n={dataset:t,directUrl:this._getDirectBoardUrl(),isCommunity:this._isCommunity(),isCompany:this._isCompany(),lang:g,isMember:this._isCommunity()?this._isMember(this.masterOwner.ownerId):!0,isHideSubscrib:t.status=="CLOSED"||t.deletedDept?!0:!1,folderStatus:e};t.description=GO.util.textToHtml(t.description),this.$el.find(".content_info_wrap").remove(),this.$el.find(".content_top").after(c(n))},_isCommunity:function(){return this.masterOwner&&this.masterOwner.ownerType=="Community"?!0:!1},_isCompany:function(){return this.masterOwner&&this.masterOwner.ownerType=="Company"?!0:!1},_isDepartment:function(){return this.masterOwner&&this.masterOwner.ownerType=="Department"?!0:!1},_getDirectBoardUrl:function(){var e=n.router.getRootUrl(),t=null;return this._isCommunity()?(t=this.masterOwner,e+="community/"+t.ownerId+"/board/"+this.boardId):e+="board/"+this.boardId,e},_getMasterOwner:function(){var t=null;if(this.model.get("owners")==undefined)return;return e.each(this.model.get("owners"),function(e,n){n.ownerShip=="MASTER"&&(t=n)}),t},_getAdminUrl:function(){var e=this.masterOwner,t="board/"+this.boardId+"/admin";return this._isCommunity()&&(t="community/"+e.ownerId+"/board/"+this.boardId+"/admin"),t},_isMember:function(e){var t=s.read({communityId:e}).toJSON(),n=!1;if(t.memberStatus=="ONLINE"||!this._isCommunity())n=!0;return n},renderContents:function(){var e=this._isCommunity(),t={boardId:this.boardId,owner:this.masterOwner,isCommunity:e,commentFlag:this.model.get("commentFlag"),sendMailFlag:this.model.get("sendMailFlag")};if(this.postId&&this.model.isClassicType())t.postId=this.postId,f.render(t);else if(this.model.isStreamType())t.writable=this.model.isActive()&&this.model.get("actions").writable,u.render(t);else if(this.actions!=undefined){t.writable=this.actions.writable,t.manageable=this.actions.managable,t.headerFlag=this.model.get("headerFlag"),t.anonymFlag=this.model.get("anonymFlag"),t.headerRequiredFlag=this.model.get("headerRequiredFlag"),t.status=this.model.get("status"),t.communityId=this.options.communityId;var n=new a(t);n.render()}},showOwners:function(){var t=this,r=this._isDepartment(),i=t.model.get("lowRankFlag"),s=e.goPopup({pclass:"layer_public_list layer_normal",header:r?g.board_share_state_tiny:g.community_share_state_tiny,contents:h({lang:g,manageable:this.actions.managable,isDepartment:r}),width:600,buttons:[{btype:"confirm",btext:g.confirm}]}),o=[{mData:null,bSortable:!1,fnRender:function(e){var n=e.aData.ownerInfo;return r&&i&&e.aData.ownerId==t.masterOwner.ownerId&&(n+="&nbsp;("+d["\ud558\uc704 \ubd80\uc11c \ud3ec\ud568"]+")"),n}}];r&&o.push({mData:"scope",bSortable:!1,sWidth:"100px",fnRender:function(e){var t=e.aData.scope=="ALL"?d["\uc804\uccb4\uacf5\uac1c"]:d["\uc77c\ubd80\ub9cc \uacf5\uac1c"];return t}}),o.push({mData:"permission",sWidth:"100px",bSortable:!1,fnRender:function(e){var t="O";return e.aData.permission==1&&(t="X"),t}}),r&&o.push({mData:null,sWidth:"70px",bSortable:!1,fnRender:function(e){var t='<a class="btn_fn7 owners_member" data-bypass data-ownerId="'+e.aData.id+'">'+v["\ubcf4\uae30"]+"</a>";return t}}),e.goGrid({el:"#boardOwners",url:GO.contextRoot+"api/board/"+this.boardId+"/owners/"+(r?"ALL":"JOINT"),displayLength:5,displayLengthSelect:!1,numbersShowPages:5,method:"GET",sDom:'rt<"tool_bar"<"critical custom_bottom">p>',emptyMessage:r?d["\uacf5\uac1c/\uacf5\uc720\ub41c \ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]:d["\uc804\uccb4\uacf5\uac1c \uac8c\uc2dc\ud310\uc785\ub2c8\ub2e4."],columns:o,fnDrawCallback:function(e){s.find("#btnOwnerEdit").appendTo(s.find(".custom_bottom")),s.reoffset()}}),s.find("#btnOwnerEdit").click(function(){s.close(),n.router.navigate(t._getAdminUrl(),!0)}),s.on("click",".owners_member",function(n){var r=e(n.currentTarget),i=r.attr("data-ownerId");if(s.find("#ownersMember"+i).length){var o=s.find("#ownersMember"+i),u=o.is(":visible"),a=u?v["\ubcf4\uae30"]:v["\uc811\uae30"];o.toggle(!u),e(this).text(a)}else e(n.currentTarget).parents("tr").after('<tr id="ownersMember'+i+'" class="detail_info"><td colspan="4">&nbsp;</td></tr>'),e.go(GO.contextRoot+"api/board/"+t.boardId+"/dept/owner/"+r.attr("data-ownerId")+"/member",{},{qryType:"GET",contentType:"application/json",responseFn:function(t){if(t.code==200){var n=[];e.each(t.data,function(e,t){n.push('<li class="default_option">'+t.ownerInfo+"</li>")}),n.length||n.push(d["\uacf5\uac1c/\uacf5\uc720\ub41c \uba64\ubc84\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]),s.find("#ownersMember"+i+">td").html('<ul class="name_tag">'+n.join("")+"</ul>")}}}),e(this).text(v["\uc811\uae30"])})},showSubscribers:function(){var t=this,n=null,r=this.actions.managable||!1,i=e.goPopup({width:750,header:g.email_subscriber,buttons:[{btype:"confirm",btext:g.confirm}]});i.find(".content").html(p({lang:g,managable:r,mailExposure:this.mailExposure})),n=[{mData:null,sWidth:"150px",bSortable:!1,fnRender:function(e){var t=e.aData.subscriber.departmentNames||["-"];return t.join(", ")}},{mData:null,bSortable:!1,sWidth:"100px",fnRender:function(e){return e.aData.subscriber.name+" "+e.aData.subscriber.positionName}}],this.mailExposure&&n.push({mData:"subscriber.email",bSortable:!1}),n.push({mData:"updatedAt",sWidth:"200px",fnRender:function(e){return e.aData.manager.name+" "+GO.util.basicDate(e.aData.updatedAt)}}),r?n.push({mData:null,sWidth:"70px",bSortable:!1,fnRender:function(e){return'<span class="btn_bdr btn_subscriber_delete" data-deleteid="'+e.aData.subscriber.id+'"><span class="ic_classic ic_basket" title="'+g["delete"]+'"></span></span>'}}):n.push({mData:null,sWidth:"70px",bSortable:!1,fnRender:function(e){return e.aData.subscriber.id==GO.session("id")||e.aData.manager.id==GO.session("id")?'<span class="btn_bdr btn_subscriber_delete" data-deleteid="'+e.aData.subscriber.id+'"><span class="ic_classic ic_basket" title="'+g["delete"]+'"></span></span>':"&nbsp;"}});var s=e.goGrid({el:"#boardSubscribers",url:GO.contextRoot+"api/board/"+this.boardId+"/subscriber",checkbox:r,displayLength:5,displayLengthSelect:!1,emptyMessage:g.email_subscriber_null,numbersShowPages:5,checkboxData:"id",method:"GET",defaultSorting:r?[[4,"desc"]]:[[3,"desc"]],sDom:'rt<"tool_bar"<"critical custom_bottom">p>',columns:n,fnDrawCallback:function(n){i.find("#btnSubscritersDeleteAll").appendTo(i.find(".custom_bottom")),i.find(".btn_subscriber_delete").bind("click",function(n){if(confirm(d["\uc120\ud0dd\ub41c \uc774\uba54\uc77c \uc218\uc2e0\uc790\ub97c \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])){var r=e(n.currentTarget).attr("data-deleteid");t.actionSubscriberDelete([r])}return}),i.reoffset()}});r&&i.find("#btnSubscritersDeleteAll").bind("click",function(){var n=[],r=s.tables.getCheckedData()||[];n=e(r).map(function(e,t){return t.subscriber.id}).get(),n.length&&confirm(d["\uc120\ud0dd\ub41c \uc774\uba54\uc77c \uc218\uc2e0\uc790\ub97c \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])?t.actionSubscriberDelete(n):e.goMessage(g.email_subscriber_delete_msg)})},actionSubscriberDelete:function(t){var n=[GO.contextRoot+"api/board",this.boardId,"subscriber"],r=this;e.go(n.join("/"),JSON.stringify({ids:t}),{qryType:"DELETE",contentType:"application/json",responseFn:function(t){t.code=="200"&&(e("#boardSubscribers").length&&e("#boardSubscribers").dataTable().fnClearTable(),r.changeBoardInfo())}})},subscribersPlaceHolderIn:function(t){if(this.model.get("subscriptionFlag")){var n=e(t.currentTarget);n.find("span.ic_con").show(),n.find("span.txt").text(g.email_subscription_delete)}},subscribersPlaceHolderOut:function(t){if(this.model.get("subscriptionFlag")){var n=e(t.currentTarget);n.find("span.ic_con").hide(),n.find("span.txt").text(g.email_subscription2)}},actionSubscriptionUser:function(){var t=this,n=[GO.contextRoot+"api/board",this.boardId,"subscriber",GO.session("id")];this.model.get("subscriptionFlag")?this.actionSubscriberDelete([GO.session("id")]):e.go(n.join("/"),{},{contentType:"application/json",qryType:this.model.get("subscriptionFlag")?"DELETE":"POST",responseFn:function(e){t.changeBoardInfo()},error:function(t){var n=JSON.parse(t.responseText);n.message&&e.goMessage(n.message)}})},actionSubscriberAdd:function(){var t=this,n=function(n){if(n.type=="org")return;var r=[GO.contextRoot+"api/board",t.boardId,"subscriber",n.id];e.go(r.join("/"),{},{contentType:"application/json",responseFn:function(n){n.code==200?(t.$el.find("#btnSubscriberCount").html(n.data.subscriberCount),t.model.set({subscriberCount:n.data.subscriberCount},{silent:!0})):n.message&&e.goMessage(n.message)},error:function(t){var n=JSON.parse(t.responseText);n.message&&e.goMessage(n.message)}})};e.goOrgSlide({header:g.email_subscriber_select,desc:"",callback:n,contextRoot:GO.contextRoot})},urlToClipboard:function(){var t=this.$el.find("span.txt_url").html(),n=navigator.userAgent.toLowerCase();if(n.indexOf("msie")!=-1)window.clipboardData.setData("Text",t),e.goMessage(g.board_url_copy);else{var r=document.createElement("textarea");document.body.appendChild(r),r.value=t,r.select(),document.execCommand("copy"),document.body.removeChild(r),e.goMessage(g.board_url_copy)}},setTitleExpander:function(t){var n=e(t.target),r=this.$el.find("ul.detail_info"),i=r.is(":visible"),s="postInfo_"+GO.session("id")+"_"+this.model.id;n.hasClass("ic_open")?n.removeClass("ic_open").addClass("ic_close").attr("title",g.close):n.removeClass("ic_close").addClass("ic_open").attr("title",g.open),r.toggle(!i),GO.util.store.set(s,i,{type:"local"})},getFolderStatus:function(){var e="postInfo_"+GO.session("id")+"_"+this.model.id;return GO.util.store.get(e)||!1}});return y})}).call(this);