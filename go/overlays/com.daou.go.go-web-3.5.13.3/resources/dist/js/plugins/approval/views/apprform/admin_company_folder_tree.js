(function(){define(["jquery","backbone","app","i18n!nls/commons","i18n!admin/nls/admin","i18n!approval/nls/approval","jquery.go-sdk","jquery.jstree","jquery.go-validation"],function(e,t,n,r,i,s){var o,u,a;return o={folder_name:i["\ud3f4\ub354\uba85"],select_folder:i["\ud3f4\ub354\ub97c \uc120\ud0dd\ud574 \uc8fc\uc2ed\uc2dc\uc624."],cannot_update:i["\ucd5c\uc0c1\uc704 \ud3f4\ub354\ub97c \uc218\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete:i["\uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete_root:r["\ucd5c\uc0c1\uc704 \ud3f4\ub354\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete_parent:i["\ud558\uc704 \ud3f4\ub354\uac00 \uc788\ub294 \uacbd\uc6b0\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],folder_add:i["\ud3f4\ub354 \ucd94\uac00"],folder_modify:r["\uc218\uc815"],folder_delete:r["\uc0ad\uc81c"],folder_delete_message:i["\ud3f4\ub354 \uc0ad\uc81c"],folder_delete_confirm:i["\ud3f4\ub354\ub97c \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c? \ud574\ub2f9 \ud3f4\ub354\ub0b4\uc758 \ubb38\uc11c\ub294 \uc9c0\uc6cc\uc9d1\ub2c8\ub2e4"],selected_folder:i["\uc120\ud0dd\ub41c \ud3f4\ub354"],save_success:r["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],already_used_name:i["\uc774\ubbf8 \uc0ac\uc6a9\uc911\uc778 \uc774\ub984\uc785\ub2c8\ub2e4."],name_invalid_character:i["\uc720\ud6a8\ud558\uc9c0 \uc54a\uc740 \ubb38\uc790\uc5f4 \uc785\ub2c8\ub2e4."],name_invalid_length:i["\uc81c\ubaa9\uc740 20\uc790\uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."]},u=function(e){this.message=e,this.name="FormTreeException"},a=t.View.extend({treeElement:null,treeElementId:null,apiCommonUrl:null,isAdmin:!1,parentNodes:[],maxDepth:10,maxChildren:-1,dragable:!0,initialize:function(e){this.options=e||{},_.isString(this.options.treeElementId)&&(this.treeElementId=this.options.treeElementId),_.isString(this.options.apiCommonUrl)&&(this.apiCommonUrl=this.options.apiCommonUrl),_.isFunction(this.options.selectCallback)&&(this.selectCallback=this.options.selectCallback),_.isBoolean(this.options.isAdmin)&&(this.isAdmin=this.options.isAdmin),_.isNumber(this.options.maxDepth)&&(this.maxDepth=this.options.maxDepth),_.isNumber(this.options.maxChildren)&&(this.maxChildren=this.options.maxChildren),_.isBoolean(this.options.dragable)&&(this.dragable=this.options.dragable);if(_.isNull(this.treeElementId))throw new u("\uc635\uc158:treeElementId\uc774 \ud544\uc694\ud569\ub2c8\ub2e4.")},selectCallback:function(){console.log("\uc544\ubb34\ub7f0 selectCallback\ub3c4 \uc9c0\uc815\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4.")},getSelectedNodeData:function(e){e=e||this._getTreeElement().jstree("get_selected");if(!e||e.length==0||!e.data())return{};var t=_.extend(e.data(),{el:e,type:e.find("a:eq(0)").attr("rel")});return t},getFullPathName:function(){var t=this._getTreeElement().jstree("get_selected"),n=this._getTreeElement().find("a[nodeid="+t.data().id+"]").closest("li"),r=e(n).parentsUntil(this._getTreeElement()).filter("li").length,i=[],s="",o="";for(var u=0;u<r+1;u++)o=e(n).find("a").eq(0).text(),i.push(o),n=e(n).parent().closest("li");var a=e(i).length;return e(e(i).get().reverse()).each(function(e,t){e===a-1?s+=t:s+=t+" > "}),s},renderNewFolderInput:function(e){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData().el;this._getTreeElement().jstree("create",t,"last",{data:e||o.folder_name})},renderRenameFolderInput:function(){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData();if(!t.id)return e.goError(o.select_folder),!1;if(t["type"]=="ROOT")return e.goError(o.cannot_update),!1;this._getTreeElement().jstree("rename"),this._getTreeElement().find(".jstree-clicked").css({background:"transparent",border:0}),this._getTreeElement().find("input.jstree-rename-input").css({left:"20px",top:"2px"})},deleteSelectedFolder:function(){function r(){if(!this.isAdmin)throw new Error;var t=this.getSelectedNodeData();if(!t.id)throw e.goError(o.select_folder),new Error;if(t["type"]=="ROOT"||t["type"]=="root")throw e.goError(o.cannot_delete_root),new Error;var n=jQuery.jstree._reference(e(this._getTreeElement())),r=e(this._getTreeElement()).jstree("get_selected"),i=n._get_children(r);if(i.length>0)throw e.goError(o.cannot_delete_parent),new Error}var t=e.Deferred();try{r.call(this)}catch(n){return t}return e.goCaution(o.folder_delete_message,o.folder_delete_confirm,e.proxy(function(){this._getTreeElement().jstree("remove"),t.resolve()},this)),t},render:function(){var t=this,n=["themes","json_data","crrm","ui","types"];this.dragable&&n.push("dnd"),this.treeElement=this._getTreeElement().jstree({plugins:n,core:{animation:120},json_data:{ajax:{url:t._getCommonUrl(),data:function(e){var n=null;return typeof e.data=="function"&&(n=e.data()),{folderId:n?n.id:t.loadId}},cache:!0,async:!0,success:function(e){}}},"defaults ":{html_titles:!1,move_node:!1,ccp:!0,width:200},ui:{select_multiple_modifier:!1,select_limit:1},types:{valid_children:["ROOT"],start_drag:!1,move_node:!1,delete_node:!1,remove:!1,types:{"default":{max_depth:this.maxDepth,max_children:this.maxChildren},root:{valid_children:t._getValidChildrenOfFolder(),start_drag:!1,move_node:!1,delete_node:!1,remove:!1},normal:{max_depth:10,max_children:-1,valid_children:t._getValidChildrenOfFolder(),start_drag:this.dragable,move_node:this.dragable,delete_node:this.dragable,remove:this.dragable}}}}).bind("loaded.jstree",e.proxy(t._onLoaded,t)).bind("load_node.jstree",e.proxy(t._onLoadNode,t)).bind("select_node.jstree",e.proxy(t._onSelectNode,t)),this.isAdmin&&this.treeElement.bind("create.jstree",e.proxy(t._onJstreeCreate,t)).bind("move_node.jstree",e.proxy(t._onJstreeMove,t)).bind("remove.jstree",e.proxy(t._onJstreeRemove,t))},_getTreeElement:function(){return e("#"+this.treeElementId)},_getCommonUrl:function(){return _.isEmpty(this.apiCommonUrl)?this.isAdmin?GO.contextRoot+"ad/api/approval/manage/companyfolder":GO.contextRoot+"api/approval/companyfolder/tree":GO.contextRoot+this.apiCommonUrl},_getValidChildrenOfFolder:function(){var e=["normal"];return e.push("FORM"),e},_onLoaded:function(){this.treeElement.find('a[rel="ROOT"]').trigger("click")},_onLoadNode:function(e,t,n){this.treeElement.find('a[href="#"]').attr("data-bypass",1)},_onSelectNode:function(t,n){var r=this.getSelectedNodeData(e(n.rslt.obj[0]));r&&_.isFunction(this.selectCallback)&&this.selectCallback(r),n.inst.toggle_node(n.rslt.obj[0])},_checkUniqueTextOnCreate:function(t){var n=t.rslt,r={name:e.trim(n.name)},i=t.inst._get_children(t.rslt.o),s=0;return i.children("a").each(function(){e.trim(e(this).text())==r.name&&s++}),s>1?!1:!0},_checkUniqueTextOnMove:function(t){var n=t.inst._get_node(t.rslt.o).data("name"),r=t.inst._get_node(t.rslt.o),i=0;return r.closest("ul").find("> li > a").each(function(){e.trim(e(this).text())==n&&i++}),i>1?!1:!0},_checkUniqueTextOnRename:function(t){var n=this._getTreeElement().jstree("get_selected"),r=n.data("id"),i=0;return n.closest("ul").find("> li > a").each(function(){e.trim(e(this).text())==e.trim(t)&&e(this).attr("nodeid")!=r&&i++}),i>0?!1:!0},hasChildrenFolder:function(){var t=jQuery.jstree._reference(e(this._getTreeElement())),n=e(this._getTreeElement()).jstree("get_selected"),r=t._get_children(n);return r.length>0?!0:!1},_onJstreeCreate:function(t,i){var s=i.rslt,u={name:e.trim(s.name),state:"HIDDEN",parentId:this.getSelectedNodeData().id,desc:e.trim(s.name),seq:s.position},a=this,f=i.inst._get_node(i.rslt.o),l=this._checkUniqueTextOnCreate(i);if(!l)return e.goError(o.already_used_name),this._getTreeElement().jstree("refresh",f),!1;if(!_.isEmpty(u.name)&&!e.goValidation.isCheckLength(2,100,u.name))return this._getTreeElement().jstree("refresh",f),e.goError(n.i18n(r["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:2,arg2:100})),!1;if(u.name==o["folder_name"]||u.name=="")return this._getTreeElement().jstree("refresh",f),!1;e.go(this._getCommonUrl(),JSON.stringify(u),{contentType:"application/json",responseFn:function(e){a._getTreeElement().jstree("refresh",f)},error:function(t){i.rlbk&&e.jstree.rollback(rlbk)}})},_onJstreeMove:function(t,n){n.rslt.o.data("id")||e.jstree.rollback(n.rlbk);var r=n.inst._get_parent(n.rslt.o),i=n.rslt.o.data("id"),s={parentId:r.data("id"),seq:n.rslt.o.index()},u=this._checkUniqueTextOnMove(n);if(!u)return e.goError(o.already_used_name),e.jstree.rollback(n.rlbk),!1;e.go(this._getCommonUrl()+"/"+i+"/move",JSON.stringify(s),{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200?this._getTreeElement().jstree("refresh",r):e.jstree.rollback(n.rlbk)}})},_onJstreeRemove:function(t,n){var r=e(n.rslt.obj[0]);e.go(this._getCommonUrl()+"/"+r.data().id,{},{qryType:"POST",contentType:"application/json",responseFn:e.proxy(function(e){var t=r.parents("li:eq(0)");this._getTreeElement().jstree("select_node",t)},this),error:e.proxy(function(t){e.goError(o.cannot_delete),n.rlbk&&e.jstree.rollback(n.rlbk)},this)})}}),a})}).call(this);