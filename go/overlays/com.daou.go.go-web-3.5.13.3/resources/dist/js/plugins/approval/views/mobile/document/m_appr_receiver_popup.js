define(function(require){var e=require("jquery"),t=require("underscore"),n=require("backbone"),r=require("app"),i=require("hgn!approval/templates/mobile/document/m_appr_receiver_popup"),s=require("views/mobile/m_dept"),o=require("i18n!nls/commons"),u=require("i18n!admin/nls/admin"),a=require("i18n!approval/nls/approval"),f=n.Model.extend({defaults:{id:0,deptId:0},initialize:function(e){this.docId=e},url:function(){return"/api/approval/document/"+this.docId+"/receiver"}});return n.View.extend({className:"overlay_scroll",events:{"click #change_receiver":"showDeptOrgView","click .btn_layer_close":"close","click #confirm":"confirm"},initialize:function(e){this.type=e.type?e.type:"normal",this.docIds=e.docIds,this.docId=e.docId,this.receivedDocOwnerDeptId=e.receivedDocOwnerDeptId,this.receiverDeptId=e.receiverDeptId,this.receiverDeptName=e.receiverDeptName,this.receiverUserId=e.receiverUserId,this.receiverUserName=e.receiverUserName,this.receiverUserPositionName=e.receiverUserPositionName,this.lang={do_assign_a_receiver:a["\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud574\uc8fc\uc138\uc694"],assigned_a_receiver:a["\ub2f4\ub2f9\uc790\uac00 \uc9c0\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],unable_to_assign_a_receiver:a["\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],assign_a_receiver:a["\ub2f4\ub2f9\uc790 \uc9c0\uc815"],receiver:a["\ub2f4\ub2f9\uc790"],incoming_document_recipient_designation_guide:a["\uc218\uc2e0 \ubb38\uc11c \uc811\uc218\uc790 \uc9c0\uc815 \uac00\uc774\ub4dc"],change:o["\ubcc0\uacbd"],confirm:o["\ud655\uc778"],displayName:this.receiverUserName+" "+this.receiverUserPositionName}},render:function(){var e=i({lang:this.lang,receiverUserId:this.receiverUserId,receiverDeptId:this.receiverDeptId});return this.$el.html(e),this},confirm:function(){var e=this;this.assignReceiver(function(){GO.util.toastMessage(e.lang.assigned_a_receiver),GO.util.navigateToBackList(),e.close()},function(){GO.util.toastMessage(e.lang.unable_to_assign_a_receiver)})},showDeptOrgView:function(n){var r=e("#change_receiver").attr("data-userDeptId"),i=new s({type:"custom",deptId:r,sendSelectedNodesCallback:e.proxy(function(e,n,r){if(r.length!==1)return;var i=t.first(r);return this.receiverUserId=i.id,this.receiverDeptId=i.deptId,this.setSelectedMemberTpl(i),e.$el.remove(),!1},this)});i.render()},setSelectedMemberTpl:function(t){var n=t.displayName;return e("#displayName").text(n)},assignReceiver:function(t,n){if(!this.receiverUserId||!this.receiverDeptId)return e.goMessage(approvalLang["\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud574\uc8fc\uc138\uc694"]),!1;if(this.type=="normal"){var r=(new f(this.docId)).save({id:this.receiverUserId,deptId:this.receiverDeptId});r.done(t).fail(n),this.slide&&this.slide.close()}else{var i=this;e.ajax(GO.contextRoot+"api/approval/document/bulkreceiver",{type:"PUT",contentType:"application/json",dataType:"json",data:JSON.stringify({docIds:i.docIds,approverUser:{id:i.receiverUserId,deptId:i.receiverDeptId}})}).done(function(e,n,r){t(e)}).fail(function(e,t,r){n(e)}),this.slide&&this.slide.close()}},close:function(t){e(".layer_type_bottom").animate({bottom:-300},150,function(){e(".overlay_scroll").hide()})}})});