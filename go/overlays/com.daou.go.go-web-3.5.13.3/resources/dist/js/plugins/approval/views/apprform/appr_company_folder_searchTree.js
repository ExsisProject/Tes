(function(){define(["jquery","backbone","app","i18n!approval/nls/approval","i18n!nls/commons","i18n!admin/nls/admin","jquery.go-sdk","jquery.jstree"],function(e,t,n,r,i,s){var o,u,a;return o={folder_name:s["\ud3f4\ub354\uba85"],select_folder:s["\ud3f4\ub354\ub97c \uc120\ud0dd\ud574 \uc8fc\uc2ed\uc2dc\uc624."],cannot_update:s["\ucd5c\uc0c1\uc704 \ud3f4\ub354\ub97c \uc218\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete:s["\uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete_root:i["\ucd5c\uc0c1\uc704 \ud3f4\ub354\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete_parent:s["\uc591\uc2dd\uc774 \uc788\uac70\ub098 \ud558\uc704 \ud3f4\ub354\uac00 \uc788\ub294 \uacbd\uc6b0\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],folder_add:s["\ud3f4\ub354 \ucd94\uac00"],folder_modify:i["\uc218\uc815"],folder_delete:i["\uc0ad\uc81c"],folder_delete_message:s["\ud3f4\ub354 \uc0ad\uc81c"],folder_delete_confirm:s["\ud3f4\ub354\ub97c \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],selected_folder:s["\uc120\ud0dd\ub41c \ud3f4\ub354"],save_success:i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],already_used_name:s["\uc774\ubbf8 \uc0ac\uc6a9\uc911\uc778 \uc774\ub984\uc785\ub2c8\ub2e4."]},u=function(e){this.message=e,this.name="FormTreeException"},a=t.View.extend({elId:null,treeElId:null,searchInputId:null,searchResultElId:null,isAdmin:!1,initialize:function(e){this.options=e||{},_.isString(this.options.elId)&&(this.elId=this.options.elId),_.isString(this.options.treeElId)&&(this.treeElId=this.options.treeElId),_.isString(this.options.searchInputId)&&(this.searchInputId=this.options.searchInputId),_.isString(this.options.apiCommonUrl)&&(this.apiCommonUrl=this.options.apiCommonUrl),_.isString(this.options.searchResultElId)&&(this.searchResultElId=this.options.searchResultElId),_.isFunction(this.options.selectCallback)&&(this.selectCallback=this.options.selectCallback),_.isBoolean(this.options.isAdmin)&&(this.isAdmin=this.options.isAdmin);if(_.isNull(this.elId))throw new u("\uc635\uc158:elId \ud544\uc694\ud569\ub2c8\ub2e4.");this.css={minHeight:150,maxHeight:375,"overflow-y":"auto"}},_bindEvents:function(){var t=e("#"+this.options.elId);t.off("keyup","#"+this.options.searchInputId),t.on("keyup","#"+this.options.searchInputId,e.proxy(function(t){var n=e(t.currentTarget).val(),r=e("#"+this.options.searchResultElId),i=e("#"+this.options.treeElId);n==""?(r.hide(),i.show(),this._loadJsTree()):(i.hide(),r.show(),this._loadSearchList(n))},this))},_loadSearchList:function(t){this.isSearchShowing=!0,this.isTreeShowing=!1;var n=e("#"+this.options.searchInputId),i=e("#"+this.options.searchResultElId),t=n.val()==n.attr("placeholder")?"":e.trim(t),s,o;i.off("click","ul.mail_folder > li"),i.on("click","ul.mail_folder > li",e.proxy(function(t){var n=e(t.currentTarget);if(n.attr("rel")=="noAuth")return!1;i.find("ul").find("li>a").removeClass("jstree-clicked"),n.find("a").addClass("jstree-clicked"),_.isFunction(this.selectCallback)&&this.selectCallback(this._processSearchData(n))},this)),s=Hogan.compile(['<li class="jstree-leaf {{className}}" data-id="{{id}}" data-title="{{name}}" rel="{{rel}}" ">',"   <a  data-bypass >",'       <ins class="jstree-icon">&nbsp;</ins>{{name}}',"   </a>","</li>"].join("")),o=Hogan.compile(['<p class="data_null"><span class="ic_data_type ic_no_part"></span>{{msg_no_search_result}}</p>'].join("")),e.ajax({url:GO.contextRoot+"api/approval/companyfolder/tree/search",type:"get",contentType:"application/json",data:{page:0,offset:200,keyword:t}}).done(e.proxy(function(t){var n=[];i.find("ul").empty();if(t.data&&t.data.length)e.each(t.data,function(e,t){n.push(s.render({id:t.metadata.id,name:t.metadata.name,title:t.metadata.title,rel:t.metadata.auth?"":"noAuth",className:t.metadata.auth?"":"disable"}))}),i.find("ul.mail_folder").append(n.join(""));else{var u=i.find("ul.mail_folder"),a=o.render({msg_no_search_result:r["\uc790\ub8cc\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]});u.empty(),u.html(a)}},this))},selectCallback:function(){console.log("\uc544\ubb34\ub7f0 selectCallback\ub3c4 \uc9c0\uc815\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4.")},getSelectedNodeData:function(e){e=e||this._getTreeElement().jstree("get_selected");if(!e||e.length==0||!e.data())return{};var t=_.extend(e.data(),{el:e,type:e.find("a:eq(0)").attr("rel")});return t},renderNewFolderInput:function(e){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData().el;this._getTreeElement().jstree("create",t,"last",{data:e||o.folder_name})},renderRenameFolderInput:function(){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData();if(!t.id)return e.goMessage(o.select_folder),!1;if(t["type"]=="ROOT")return e.goMessage(o.cannot_update),!1;this._getTreeElement().jstree("rename"),this._getTreeElement().find(".jstree-clicked").css({background:"transparent",border:0}),this._getTreeElement().find("input.jstree-rename-input").css({left:"20px",top:"2px"})},_renderTemplate:function(){var t={placeholder:r["\uc804\uc0ac \ubb38\uc11c\ud568"]},n=['<section class="search">','    <div class="search_wrap">','        <input id="'+this.options.searchInputId+'" class="search" maxlength="15"  type="text" placeholder="{{lang.placeholder}}">','        <input class="btn_search" type="button"  value="{{lang.search}}" title="{{lang.search}}" evt-rol="mail-search">',"    </div>",'    <div id="detailSearchLayerWrap" style="position:relative;display:none;z-index:60"></div>',"</section>",'<div class="content_tab_wrap">','<div id="'+this.options.treeElId+'" class="jstree jstree-0 jstree-focused jstree-default">',"</div>",'<div id="'+this.options.searchResultElId+'"  style="min-height: '+this.css.minHeight+"px; max-height: "+this.css.maxHeight+'px; display: none;">','    <div class="jstree jstree-default" style="border-bottom:1px dashed #c8c8c8;margin:5px;display:block">','        <ul class="mail_folder"></ul>',"    </div>","</div>","</div>"],i=Hogan.compile(n.join(""));e("#"+this.options.elId).html(i.render({lang:t})),e("#"+this.options.elId).find("input[placeholder]").placeholder()},deleteSelectedFolder:function(){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData();if(!t.id)return e.goMessage(o.select_folder),!1;if(t["type"]=="ROOT")return e.goMessage(o.cannot_delete_root),!1;if(!_.isEmpty(t.children))return e.goMessage(o.cannot_delete_parent),!1;e.goCaution(o.folder_delete_message,o.folder_delete_confirm,e.proxy(function(){this._getTreeElement().jstree("remove")},this))},render:function(){this._bindEvents(),this._renderTemplate(),this._loadJsTree()},_loadJsTree:function(){var t=this;this.treeEl=this._getTreeElement().jstree({plugins:["themes","json_data","crrm","ui","dnd","types"],core:{animation:120},json_data:{ajax:{url:t._getCommonUrl(),data:function(e){var n=null;return typeof e.data=="function"&&(n=e.data()),{folderId:n?n.id:t.loadId}},cache:!0,async:!0,success:function(e){}}},core:{animation:120},"defaults ":{html_titles:!1,move_node:!1,ccp:!0,width:200},ui:{select_multiple_modifier:!1,select_limit:1},types:{max_depth:10,max_children:10,move_node:!1,start_drag:!1,move_node:!1,delete_node:!1,remove:!1,types:{"default":{start_drag:t.isAdmin?!0:!1,move_node:t.isAdmin?!0:!1,delete_node:t.isAdmin?!0:!1},root:{valid_children:t._getValidChildrenOfFolder(),start_drag:!1,move_node:!1,delete_node:!1,remove:!1},noAuth:{max_depth:10,select_node:!1,start_drag:!1,move_node:!1,delete_node:!1,remove:!1}}}}).bind("loaded.jstree",e.proxy(t._onLoaded,t)).bind("load_node.jstree",e.proxy(t._onLoadNode,t)).bind("select_node.jstree",e.proxy(t._onSelectNode,t)),this.isAdmin&&this.treeEl.bind("create.jstree",e.proxy(t._onJstreeCreate,t)).bind("rename.jstree",e.proxy(t._onJstreeRename,t)).bind("move_node.jstree",e.proxy(t._onJstreeMove,t)).bind("remove.jstree",e.proxy(t._onJstreeRemove,t))},_getTreeElement:function(){return e("#"+this.treeElId)},_getCommonUrl:function(){return _.isEmpty(this.apiCommonUrl)?this.isAdmin?GO.contextRoot+"ad/api/approval/manage/companyfolder":GO.contextRoot+"api/approval/companyfolder/tree":GO.contextRoot+this.apiCommonUrl},_getValidChildrenOfFolder:function(){var e=["FOLDER"];return this.isAdmin||e.push("FORM"),e},_onLoaded:function(){e.jstree._reference(this.treeEl).open_all()},_onLoadNode:function(t,n,r){this.treeEl.find('a[href="#"]').attr("data-bypass",1),this.treeEl.find("li").each(function(t,n){e(n).data("auth")||e(n).attr("rel","noAuth").find("a").eq(0).addClass("disable")})},_onSelectNode:function(t,n){var r=this.getSelectedNodeData(e(n.rslt.obj[0]));r&&_.isFunction(this.selectCallback)&&this.selectCallback(r),n.inst.toggle_node(n.rslt.obj[0])},_onJstreeCreate:function(t,n){var r=this,i=this.getSelectedNodeData().el,s=n.rslt,u={name:e.trim(s.name),parentId:this.getSelectedNodeData().id};if(u.name==o["folder_name"]||u.name=="")return this._getTreeElement().jstree("refresh",i),!1;e.go(this._getCommonUrl(),JSON.stringify(u),{contentType:"application/json",responseFn:function(e){r._getTreeElement().jstree("refresh",i)}})},_onJstreeRename:function(t,n){this._getTreeElement().find(".jstree-clicked").removeAttr("style");var r=n.rslt,i=e(n.rslt.obj[0]).data(),s=JSON.stringify({id:i.id,name:r.new_name});if(!r.new_name)return!1;if(r.new_name==r.old_name)return!1;e.go(this._getCommonUrl()+"/"+i.id,s,{qryType:"PUT",contentType:"application/json",responseFn:function(t){e.goMessage(o.save_success),this._getTreeElement().find(".go_alert").html("")},error:function(t){n.rlbk&&e.jstree.rollback(rlbk),this._getTreeElement().find(".go_alert").html(o.already_used_name)}})},_onJstreeMove:function(t,n){var r=n.inst._get_parent(n.rslt.o),i=n.rslt.o.data("id"),s={parentId:r.data("id"),seq:n.rslt.cp};e.go(this._getCommonUrl()+"/"+i+"/move",JSON.stringify(s),{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200?this._getTreeElement().jstree("refresh",r):e.jstree.rollback(n.rlbk)}})},_onJstreeRemove:function(t,n){var r=e(n.rslt.obj[0]);e.go(this._getCommonUrl()+"/"+r.data().id,{},{qryType:"DELETE",contentType:"application/json",responseFn:e.proxy(function(e){var t=r.parents("li:eq(0)");this._getTreeElement().jstree("select_node",t)},this),error:e.proxy(function(t){n.rlbk&&e.jstree.rollback(n.rlbk),this._getTreeElement().find(".go_alert").html(o.cannot_delete)},this)})},_processSearchData:function(e){var t={};return t={id:e.data("id"),title:e.data("title"),name:e.find("a").text()},t}}),a})}).call(this);