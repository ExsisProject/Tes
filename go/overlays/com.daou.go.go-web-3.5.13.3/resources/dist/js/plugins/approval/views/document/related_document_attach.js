define(["jquery","underscore","backbone","app","views/pagination","views/pagesize","approval/views/doclist/doclist_item","approval/views/apprform/appr_company_folder_tree","approval/collections/draft_doclist","approval/collections/appr_doc_list","approval/collections/viewer_doclist","approval/collections/reception_doclist","approval/collections/dept_folder_doclist","approval/collections/send_doclist","approval/collections/user_folder_doclist","approval/collections/share_folder_doclist","approval/collections/company_doc_list","hgn!approval/templates/doclist_empty","hgn!approval/templates/document/related_document_attach","i18n!nls/commons","i18n!approval/nls/approval","jquery.jstree","jquery.go-preloader"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w){var E=n.Model.extend({url:"/api/approval/side"}),S=o.extend({isReadable:!1,events:function(){return t.extend({},o.prototype.events,{"click input:checkbox":"checkReadable"})},checkReadable:function(t){var n=this,i=e(t.currentTarget);if(!n.isReadable){var s=this.model.get("documentId");e.ajax({type:"GET",url:r.contextRoot+"api/approval/document/"+s+"/readable",success:function(){n.isReadable=!0},error:function(t){var r=JSON.parse(t.responseText);e.goError(r.message),e(i).prop("checked",!1),n.isReadable=!1}})}}}),x=n.View.extend({searchTreeView:null,formListView:null,el:".layer_doc_attach .content",columns:{"\uc120\ud0dd":"\uc120\ud0dd","\uacb0\uc7ac\uc591\uc2dd":w.\uacb0\uc7ac\uc591\uc2dd,"\uc81c\ubaa9":b.\uc81c\ubaa9,"\uae30\uc548\uc790":w.\uae30\uc548\uc790,"\uacb0\uc7ac\uc77c":w.\uacb0\uc7ac\uc77c,count:5},events:{"click #allCheck":"allCheck","click #userReference ul.side_depth p a":"clickUserRefSide","click #deptReference ul.side_depth ul p a":"clickDeptRefSide","click #companyDocSide ul.side_depth ul p a":"clickCompanyRefSide","click #search_icon":"search","keydown #search_title":"searchEnter"},initialize:function(n){this.options=n||{},this.release(),t.bindAll(this,"render","renderPageSize","renderPages"),this.collection=new a,this.collection.setType("complete"),this.collection.bind("reset",this.resetList,this),this.collection.setSort("latestActivityCompletedAt","DESC");var i=e.goPreloader();this.collection.fetch({beforeSend:function(){i.render()},statusCode:{403:function(){r.util.error("403")},404:function(){r.util.error("404",{msgCode:"400-common"})},500:function(){r.util.error("500")}}}).done(function(){i.release()}),this.apprSideModel=new E,this.apprSideModel.fetch({async:!1})},render:function(){var t={"\uc774\ub984":b["\uc774\ub984"],"\ubd80\uc11c\uba85":b["\ubd80\uc11c\uba85"],"\uc774\uba54\uc77c":b["\uc774\uba54\uc77c"],"\uac80\uc0c9":b["\uac80\uc0c9"],"\uac1c\uc778 \ubb38\uc11c\ud568":w["\uac1c\uc778 \ubb38\uc11c\ud568"],"\uae30\uc548 \ubb38\uc11c\ud568":w["\uae30\uc548 \ubb38\uc11c\ud568"],"\uacb0\uc7ac \ubb38\uc11c\ud568":w["\uacb0\uc7ac \ubb38\uc11c\ud568"],"\ucc38\uc870/\uc5f4\ub78c \ubb38\uc11c\ud568":w["\ucc38\uc870/\uc5f4\ub78c \ubb38\uc11c\ud568"],"\uc218\uc2e0 \ubb38\uc11c\ud568":w["\uc218\uc2e0 \ubb38\uc11c\ud568"],"\uae30\uc548 \uc644\ub8cc\ud568":w["\uae30\uc548 \uc644\ub8cc\ud568"],"\ubd80\uc11c \ucc38\uc870\ud568":w["\ubd80\uc11c \ucc38\uc870\ud568"],"\ubd80\uc11c \uc218\uc2e0\ud568":w["\ubd80\uc11c \uc218\uc2e0\ud568"],"\ubd80\uc11c \ubb38\uc11c\ud568":w["\ubd80\uc11c \ubb38\uc11c\ud568"],"\ubb38\uc11c\ubc88\ud638":w["\ubb38\uc11c\ubc88\ud638"],"\uacb0\uc7ac\uc120":w["\uacb0\uc7ac\uc120"],company_docfolder:w["\uc804\uc0ac \ubb38\uc11c\ud568"],send_docfolder:w["\ubc1c\uc1a1 \ubb38\uc11c\ud568"],added_docfolder:w["\ucd94\uac00\ub41c \ubb38\uc11c\ud568"],shared_docfolder:w["\uacf5\uc720\ub41c \ubb38\uc11c\ud568"],base_docfolder:w["\uae30\ubcf8 \ubb38\uc11c\ud568"]},n=this.columns,r=!1;this.apprSideModel.get("userFolders")&&(r=this.apprSideModel.get("userFolders").length>0);var i=!1;this.apprSideModel.get("sharedFoldersToUser")&&(i=this.apprSideModel.get("sharedFoldersToUser").length>0);var s=this.deptFoldersData(this.apprSideModel.get("deptFolders")),o=this.apprSideModel.toJSON();e.each(o.sharedFoldersToUser,function(e,t){t.folderType=="USER"?t.isfolderTypeUser=!0:t.isfolderTypeUser=!1});var u=y({columns:n,lang:t,addedFolder:r,sharedFolder:i,apprSideData:o,dataset:s});this.$el.html(u),e(".tb_doc_attach > tbody").html(g({columns:this.columns,lang:{doclist_empty:w["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages(),this.sideCompanyDocRender()},deptFoldersData:function(t){return t.length&&e.each(t,function(t,n){n.deptFolders.length>0?n.addedDeptFolder=!0:n.addedDeptFolder=!1,n.sharedDocFolders&&n.sharedDocFolders.length>0?(n.sharedDeptFolder=!0,e.each(n.sharedDocFolders,function(e,t){t.deptId=n.deptId,t.folderType=="USER"?t.isfolderTypeUser=!0:t.isfolderTypeUser=!1})):n.sharedDeptFolder=!1}),t},sideCompanyDocRender:function(){this.companyDocTreeView=new u({isAdmin:!1,disabledSelect:!1,apiCommonUrl:"api/docfolder/sidetree",treeElementId:"companyDocTree"}),this.companyDocTreeView.render()},clickCompanyRefSide:function(t){var n=e(t.currentTarget),i=n.parents("li:first").attr("data-id"),s=new m;s.setFolderId(i),n.parents("div.set_nav:first").find("p").removeClass("on"),n.parent().addClass("on"),this.collection=s,this.collection.setSort("latestActivityCompletedAt","DESC");var o=e.goPreloader();o.render(),this.collection.bind("reset",this.resetList,this),this.collection.fetch({statusCode:{403:function(){r.util.error("403")},404:function(){r.util.error("404",{msgCode:"400-common"})},500:function(){r.util.error("500")}}}).done(function(){o.release()})},allCheck:function(t){e(".tb_doc_attach tbody input[type=checkbox]").attr("checked",e(t.currentTarget).is(":checked"))},clickUserRefSide:function(t){var n=e(t.currentTarget),i=n.parents("li:first").attr("data-type"),s=n.attr("data-navi")=="shareuserdoc"?"userfolder":"deptfolder",o={draft:new a,sign:new f,cc:new l,inbox:new c,send:new p,userFolder:new d({folderId:n.attr("data-id")}),sharedFolder:new v({folderId:n.attr("data-id"),deptId:n.attr("data-deptid"),type:s,belong:n.attr("data-belong")})};n.parents("div.set_nav:first").find("p").removeClass("on"),n.parent().addClass("on"),this.collection=o[i],i!="sharedFolder"&&this.collection.setType("complete"),i=="cc"?this.collection.setSort("document.latestActivityCompletedAt","DESC"):this.collection.setSort("latestActivityCompletedAt","DESC");var u=e.goPreloader();u.render(),this.collection.bind("reset",this.resetList,this),this.collection.fetch({statusCode:{403:function(){r.util.error("403")},404:function(){r.util.error("404",{msgCode:"400-common"})},500:function(){r.util.error("500")}}}).done(function(){u.release()})},clickDeptRefSide:function(t){var n=e(t.currentTarget),i=n.parents("li:first").attr("data-type"),s=n.parents("ul:first").attr("data-deptid"),o=n.parents("li:first").attr("data-folderId"),u=n.attr("data-navi")=="shareuserdoc"?"userfolder":"deptfolder",a={draft:new h({deptId:s,type:"deptdraft"}),cc:new h({deptId:s,type:"deptreference",status:"complete"}),inbox:new c("complete",s),folder:new h({folderId:o,deptId:s,type:"deptfolder"}),sharedFolder:new v({folderId:o,deptId:s,type:u,belong:n.attr("data-belong")})};n.parents("div.set_nav:first").find("p").removeClass("on"),n.parent().addClass("on"),this.collection=a[i];var f=e.goPreloader();i=="cc"?this.collection.setSort("document.latestActivityCompletedAt","DESC"):this.collection.setSort("latestActivityCompletedAt","DESC"),this.collection.bind("reset",this.resetList,this),this.collection.fetch({beforeSend:function(){f.render()},statusCode:{403:function(){r.util.error("403")},404:function(){r.util.error("404",{msgCode:"400-common"})},500:function(){r.util.error("500")}}}).done(function(){console.info("done!!"),f.release()})},setFormDetail:function(e){this.collection.setFolderId(e),this.collection.fetch()},renderPageSize:function(){this.pageSizeView=new s({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new i({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("#messageNaviWrap > div.dataTables_paginate").remove(),this.pageView.render(),this.pageView.$el.removeAttr("style"),this.$el.find("#messageNaviWrap").append(this.pageView.el)},resetList:function(t){e(".tb_doc_attach > tbody").empty();var n=this.columns,r="approval";t.each(function(t){var i=new S({model:t,listType:r,columns:n,isCheckboxVisible:!0,isShowUrl:!1});e(".tb_doc_attach > tbody").append(i.render().el)}),t.length==0&&e(".tb_doc_attach > tbody").html(g({columns:this.columns,lang:{doclist_empty:w["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectPage:function(t){this.collection.setPageNo(t);var n=e.goPreloader();this.collection.fetch({beforeSend:function(){n.render()}}).done(function(){console.info("done!!"),n.release()})},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},search:function(){var e=this.$el.find("#search_title"),t=this.$el.find("#referenceSearchType").val();this.collection.setSearch(t,e.val()),this.collection.fetch(),e.val("")},searchEnter:function(e){e.keyCode=="13"&&this.search()},release:function(){this.$el.off(),this.$el.empty()}});return x});