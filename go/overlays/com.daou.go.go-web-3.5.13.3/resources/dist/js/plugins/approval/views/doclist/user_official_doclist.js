define(["jquery","underscore","backbone","app","when","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/doclist_item","approval/views/doclist/base_doclist","approval/views/doclist/doclist_csv_download","approval/models/doc_list_field","approval/collections/doc_list_field","approval/models/doclist_item","approval/collections/user_official_doclist","hgn!approval/templates/doclist_empty","hgn!approval/templates/user_official_doclist","i18n!nls/commons","i18n!approval/nls/approval","jquery.placeholder"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y){var b={"\uc804\uccb4":y["\uc804\uccb4"],"\uc2b9\uc778\ub300\uae30":y["\uc2b9\uc778\ub300\uae30"],"\uc2b9\uc778":y["\uc2b9\uc778"],"\ubc18\ub824":y["\ubc18\ub824"],"\ubc1c\uc1a1\ucde8\uc18c":y["\ubc1c\uc1a1\ucde8\uc18c"],"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc120":y["\uacb0\uc7ac\uc120"],"\uae30\uc548\ubd80\uc11c":y["\uae30\uc548\ubd80\uc11c"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],"\uac80\uc0c9":g["\uac80\uc0c9"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],placeholder_search:g["\ud50c\ub808\uc774\uc2a4\ud640\ub354\uac80\uc0c9"]},w=n.Model.extend({url:"/api/approval/apprconfig"}),E=f.extend({el:"#content",columns:{"\uae30\uc548\uc77c":y["\uae30\uc548\uc77c"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":y["\uae34\uae09"],"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\ucca8\ubd80":y["\ucca8\ubd80"],"\uacb0\uc7ac\uc0c1\ud0dc":y["\uacb0\uc7ac\uc0c1\ud0dc"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],count:7},useOfficialConfirm:!0,docFolderType:"user_official",usePeriod:!0,initialize:function(e){this.options=e||{},t.bindAll(this,"render","renderPageSize","renderPages"),this.contentTop=s.getInstance(),this.type=this.options.type,this.options.type.indexOf("?")>=0&&(this.type=this.options.type.substr(0,this.options.type.indexOf("?"))),this.collection=new d,this.collection.setType(this.type),this.initProperty="document.completedAt",this.initDirection="desc",this.ckeyword="",this.userId=r.session("id");var n=sessionStorage.getItem("list-history-baseUrl"),i=new RegExp("(#)?approval/doclist/userofficial/"+this.type+"$");n&&i.test(n)?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.initSearchtype=sessionStorage.getItem("list-history-searchtype"),this.ckeyword=sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),this.duration=sessionStorage.getItem("list-history-duration"),this.fromDate=sessionStorage.getItem("list-history-fromDate"),this.toDate=sessionStorage.getItem("list-history-toDate"),this.collection.setListParam()):(this.collection.setDuration(),this.collection.setSort(this.initProperty,this.initDirection)),sessionStorage.clear(),this.collection.bind("reset",this.resetList,this),f.prototype.initialize.call(this,e)},events:function(){return t.extend({},f.prototype.events,{"click input:checkbox":"toggleCheckbox","click .tab_nav > li":"selectTab","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click #checkedAllDeptDoc":"checkedAllDoc"})},render:function(){i(this.fetchConfig.call(this)).then(t.bind(this.fetchDocField,this)).then(t.bind(this.renderLayout,this)).then(t.bind(this.renderPeriodView,this)).then(t.bind(this.renderDocFieldSettingView,this)).then(t.bind(this.renderDocFieldColumnTpl,this)).then(t.bind(this.fetchDocList,this)).then(t.bind(this.setInitSort,this)).otherwise(function(t){console.log(t.stack)})},renderLayout:function(){var t=this;this.$el.html(m({lang:b,useOfficialConfirm:this.useOfficialConfirm})),this.type.indexOf("?")>=0&&(this.type=this.type.substr(0,this.type.indexOf("?"))),e("#tab_"+this.type).addClass("on"),this.contentTop.setTitle(y["\uacf5\ubb38 \ubb38\uc11c\ud568"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.$el.find("input[placeholder]").placeholder(),this.renderPageSize(),(new l({getDownloadURL:e.proxy(this.collection.getCsvURL,this.collection),appendTarget:this.$el.find("#docToolbar > div.critical")})).render()},fetchDocField:function(){var e=this;this.docFieldModel=new c({docFolderType:this.docFolderType});var t=i.defer();return this.docFieldModel.fetch({success:function(n){var r=n.getCollection(),i=r.findWhere({columnMsgKey:"\uc2b9\uc778\uc790"}),s=r.findWhere({columnMsgKey:"\uc2b9\uc778\uc0c1\ud0dc"});e.useOfficialConfirm||(r.remove(i),r.remove(s),e.toRemoveColumns=["\uc2b9\uc778\uc790"],e.toRemoveColumns=["\uc2b9\uc778\uc0c1\ud0dc"]),e.columns=r.makeDoclistColumn(e.columns),e.sorts=r.makeDoclistSort(),t.resolve()},error:t.reject}),t.promise},fetchConfig:function(){var e=this,t=i.defer();return this.configModel=new w,this.useOfficialConfirm=!0,this.configModel.fetch({success:function(n){e.useOfficialConfirm=n.get("useOfficialConfirm"),t.resolve()},error:t.reject}),t.promise},toggleCheckbox:function(t){this.$el.find("#checkedAll").is(":checked")&&e('input[type="checkbox"][name="checkbox"]').attr("checked",!0),e(t.currentTarget).is(":checked")?e(t.currentTarget).attr("checked",!0):(this.$el.find("#checkedAll").attr("checked",!1),e(t.currentTarget).attr("checked",!1))},renderPageSize:function(){this.pageSizeView=new u({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new o({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el)},resetList:function(t){var n=this.collection.url().replace("/api/",""),i=r.router.getUrl().replace("#","");i.indexOf("?")<0?r.router.navigate(n,{replace:!0}):i!=n&&r.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty();var s=this.columns,o="officialDoc";t.each(function(t){var n=new a({model:t,isCheckboxVisible:!1,listType:o,columns:s,useDocInfo:!1});e(".list_approval > tbody").append(n.render().el)}),t.length==0&&e(".list_approval > tbody").html(v({columns:this.columns,lang:{doclist_empty:y["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectTab:function(t){this.collection.setPageNo(0),e(".tab_nav > li").removeClass("on"),e(t.currentTarget).addClass("on"),this.$el.find("#checkedAll").attr("checked",!1);var n=e(t.currentTarget).attr("id");n=="tab_all"?this.collection.setType("all"):n=="tab_wait"?this.collection.setType("wait"):n=="tab_approve"?this.collection.setType("approve"):n=="tab_return"?this.collection.setType("return"):n=="tab_cancel"&&this.collection.setType("cancel"),this.collection.fetch()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},checkedAllDoc:function(){e("#checkedAllDeptDoc").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1)},release:function(){this.$el.off(),this.$el.empty()}});return E});