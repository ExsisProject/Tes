define(["jquery","underscore","backbone","app","when","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/base_doclist","approval/views/doclist/doclist_item","approval/views/doclist/doclist_csv_download","approval/views/doclist/user_doc_folder","approval/views/create_rule","approval/models/doclist_item","approval/collections/viewer_doclist","hgn!approval/templates/doclist_empty","hgn!approval/templates/viewer_doclist","approval/models/all_documents_action","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b){var w=n.Model.extend({url:function(){var e=["/api/approval/userfolder/"+this.folderId+"/document/add"].join("/");return e},setFolderId:function(e){this.folderId=e}}),E={"\uc804\uccb4":b["\uc804\uccb4"],"\ucc38\uc870":b["\ucc38\uc870"],"\uc5f4\ub78c":b["\uc5f4\ub78c"],"\uc81c\ubaa9":y["\uc81c\ubaa9"],"\uae30\uc548\uc790":b["\uae30\uc548\uc790"],"\uae30\uc548\ubd80\uc11c":b["\uae30\uc548\ubd80\uc11c"],"\uacb0\uc7ac\uc120":b["\uacb0\uc7ac\uc120"],"\ubb38\uc11c\ubc88\ud638":b["\ubb38\uc11c\ubc88\ud638"],"\uac80\uc0c9":y["\uac80\uc0c9"],"\uacb0\uc7ac\uc591\uc2dd":b["\uacb0\uc7ac\uc591\uc2dd"],placeholder_search:y["\ud50c\ub808\uc774\uc2a4\ud640\ub354\uac80\uc0c9"],"\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958":b["\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958"],"\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4":b["\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"\uc790\ub3d9\ubd84\ub958":b["\uc790\ub3d9\ubd84\ub958"],"\ubd84\ub958":b["\ubd84\ub958"]},S=a.extend({el:"#content",columns:{"\uae30\uc548\uc77c":b["\uae30\uc548\uc77c"],"\uae30\uc548\uc790":b["\uae30\uc548\uc790"],"\uad6c\ubd84":b["\uad6c\ubd84"],"\uacb0\uc7ac\uc591\uc2dd":b["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":b["\uae34\uae09"],"\uc81c\ubaa9":y["\uc81c\ubaa9"],"\ucca8\ubd80":b["\ucca8\ubd80"],"\uacb0\uc7ac\uc0c1\ud0dc":b["\uacb0\uc7ac\uc0c1\ud0dc"],"\ubb38\uc11c\ubc88\ud638":b["\ubb38\uc11c\ubc88\ud638"],count:9},docFieldModel:null,docFolderType:"user_ref",usePeriod:!0,initialize:function(e){this.options=e||{},t.bindAll(this,"render","renderPageSize","renderPages"),this.contentTop=s.getInstance(),this.type=this.options.type,this.options.type.indexOf("?")>=0&&(this.type=this.options.type.substr(0,this.options.type.indexOf("?"))),this.collection=new d,this.collection.setType(this.type),this.initProperty="document.draftedAt",this.initDirection="desc",this.ckeyword="",this.userId=r.session("id");var n=sessionStorage.getItem("list-history-baseUrl");n&&(n=n.replace(/#/gi,"")),n&&n=="approval/doclist/viewer/"+this.type?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.initSearchtype=sessionStorage.getItem("list-history-searchtype"),this.ckeyword=sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),this.duration=sessionStorage.getItem("list-history-duration"),this.fromDate=sessionStorage.getItem("list-history-fromDate"),this.toDate=sessionStorage.getItem("list-history-toDate"),this.collection.setListParam()):(this.collection.setDuration(),this.collection.setSort(this.initProperty,this.initDirection)),sessionStorage.clear(),this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},this.collection.bind("reset",this.resetList,this),a.prototype.initialize.call(this,e)},events:function(){return t.extend({},a.prototype.events,{"click input:checkbox":"toggleCheckbox","click .tab_nav > li":"selectTab","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click #userDocCopy":"userDocCopy","click #userDocClassify":"userDocClassify","click #checkedAllDeptDoc":"checkedAllDoc","click #docClassifyMenu":"toggleDocClassifyMenu"})},userDocCopy:function(){var n=this,i=[],s=e("input[name=checkbox]:checked");s.each(function(){i.push(e(this).attr("data-id"))});if(e.isEmptyObject(i)){e.goError(b["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var o=this.userId,u,a=new c({docIds:i,userId:o});if(a.isEmptyDocFolder())return a.release(),e.goAlert(E["\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;a.release();var f=e.goPopup({pclass:"layer_normal layer_doc_type_select",header:E["\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958"],modal:!0,width:300,contents:"",buttons:[{btext:y["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(s){var o=s.find(".on span[data-folderid]").attr("data-folderid");if(!o)return e.goError(b["\uc774\ub3d9\ud558\uc2e4 \ubb38\uc11c\ud568\uc744 \uc120\ud0dd\ud574\uc8fc\uc2ed\uc2dc\uc694."],e(".list_wrap ")),!1;var a=e.goPreloader();if(s.parent().find("#allSelectTr").is(":visible")&&s.parent().find("#allSelectMsg3").attr("data-value")=="folder"){var f=n.collection.type+"documents";u=new g({folderType:"userviewerfolder",documentType:f}),!t.isUndefined(n.collection.keyword)&&n.collection.keyword.trim().length>0&&(u.setSearch(n.collection.searchtype,n.collection.keyword),n.collection.duration=="period"&&u.setDuration({duration:n.collection.duration,fromDate:r.util.toISO8601(n.collection.fromDate),toDate:r.util.searchEndDate(n.collection.toDate)}))}else u=new w({ids:i});u.setFolderId(o),u.save({},{silent:!0,type:"PUT",beforeSend:function(){a.render()},success:function(t,r){e.goMessage(b["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \ubcf5\uc0ac\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),s.close(),n.$el.find("#checkedAllDeptDoc").attr("checked",!1),n.collection.fetch()},error:function(n,r){var i=r.responseJSON;return!t.isUndefined(i)&&i.message?(e.goError(i.message),!1):(e.goError(y["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),!1)},complete:function(){a.release()}})}},{btext:y["\ucde8\uc18c"],btype:"cancel"}]}),l=new c({docIds:i,userId:o});l.render(),i!=""&&f.reoffset()},userDocClassify:function(){var t=this,n=[],r=e("input[name=checkbox]:checked");r.each(function(){n.push(e(this).attr("data-id"))});if(e.isEmptyObject(n)){e.goError(b["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}if(n.length!=1){e.goError(b["\ud558\ub098\uc758 \ubb38\uc11c\ub9cc \uc790\ub3d9\ubd84\ub958\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"]);return}var i=this.collection.filter(function(e){return e.attributes.id==n[0]})[0],s={title:i.get("title"),form:i.get("formName"),drafter:i.get("drafterName"),draftDeptName:i.get("drafterDeptName"),docFolderType:"REFERRENCE_READ"},o=new h({docId:n[0],docInfo:s}),u=e.goPopup({pclass:"layer_normal layer_auto",header:E["\uc790\ub3d9\ubd84\ub958"],modal:!0,width:380,contents:"",buttons:[{btext:y["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){o.validate()&&o.createRule().done(function(){e.close()})}},{btext:y["\ucde8\uc18c"],btype:"cancel"}]});u.find(".content").html(o.render().el),u.reoffset()},renderLayout:function(){this.$el.html(m({lang:E})),this.type.indexOf("?")>=0&&(this.type=this.type.substr(0,this.type.indexOf("?"))),e("#tab_"+this.type).addClass("on"),this.contentTop.setTitle(b["\ucc38\uc870/\uc5f4\ub78c\ubb38\uc11c\ud568"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.$el.find("input[placeholder]").placeholder(),this.renderPageSize(),(new l({getDownloadURL:e.proxy(this.collection.getCsvURL,this.collection),appendTarget:this.$el.find("#docToolbar > div.critical")})).render()},toggleCheckbox:function(t){e(t.currentTarget).is(":checked")?(e(t.currentTarget).attr("checked",!0),e("td.check :checkbox:checked").length==this.collection.getCompletedDocumentCount()&&(this.$el.find("#checkedAllDeptDoc").attr("checked",!0),this.toggleSelectAllTpl(!0))):(this.$el.find("#checkedAllDeptDoc").attr("checked",!1),e(t.currentTarget).attr("checked",!1),this.toggleSelectAllTpl(!1))},renderPageSize:function(){this.pageSizeView=new u({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new o({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el)},resetList:function(t){var n=this.collection.url().replace("/api/",""),i=r.router.getUrl().replace("#","");i.indexOf("?")<0?r.router.navigate(n,{replace:!0}):i!=n&&r.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty(),this.completeDocumentTotal=this.completeDocumentCount(),this.renderSelectAllTpl();var s=this.columns,o="approval";t.each(function(t){var n=new f({model:t,isCheckboxVisible:t.isCompleted(),listType:o,columns:s});e(".list_approval > tbody").append(n.render().el)}),t.length==0&&e(".list_approval > tbody").html(v({columns:this.columns,lang:{doclist_empty:b["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectTab:function(t){this.collection.setPageNo(0),e(".tab_nav > li").removeClass("on"),e(t.currentTarget).addClass("on"),this.$el.find("#checkedAllDeptDoc").attr("checked",!1);var n=e(t.currentTarget).attr("id");n=="tab_all"?this.collection.setType("all"):n=="tab_reference"?this.collection.setType("reference"):n=="tab_reading"&&this.collection.setType("reading"),this.collection.fetch()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},checkedAllDoc:function(){e("#checkedAllDeptDoc").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1),this.toggleSelectAllTpl(e("#checkedAllDeptDoc").is(":checked"))},toggleDocClassifyMenu:function(t){var n=e(t.currentTarget).find(".array_option");n.is(":visible")?n.hide():n.show()},release:function(){this.$el.off(),this.$el.empty()},makeCompleteDocumentCountingUrl:function(){var e=this.collection.type=="all"?"viewer":this.collection.type,t=r.contextRoot+"api/approval/doclist/"+e+"/complete/count?";return t+this.makeParams()}});return S});