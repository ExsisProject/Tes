define(["jquery","underscore","backbone","app","when","calendar/libs/util","helpers/form","collections/paginated_collection","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/base_doclist","approval/views/doclist/doclist_item","approval/views/doclist/doclist_csv_download","approval/views/doclist/doclist_bulk_action","approval/models/doclist_item","approval/collections/apprFormCoreCollection","hgn!approval/templates/doclist_search_null","hgn!approval/templates/appr_doc_manage_main","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-popup","jquery.ui"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w){var E={"\uc804\uccb4":w["\uc804\uccb4"],"\uc9c4\ud589\uc911":w["\uc9c4\ud589\uc911"],"\uc644\ub8cc":w["\uc644\ub8cc"],"\ubc18\ub824":w["\ubc18\ub824"],"\uc0c1\ud0dc":w["\uc0c1\ud0dc"],"\uae30\uac04":b["\uae30\uac04"],"\uac80\uc0c9 \uae30\uac04":w["\uac80\uc0c9 \uae30\uac04"],"\uae30\uc548\uc790":w["\uae30\uc548\uc790"],"\uae30\uc548\ubd80\uc11c":w["\uae30\uc548\ubd80\uc11c"],"\uacb0\uc7ac\uc120":w["\uacb0\uc7ac\uc120"],"\uc81c\ubaa9":b["\uc81c\ubaa9"],"\uac80\uc0c9":b["\uac80\uc0c9"],"\uc120\ud0dd":b["\uc120\ud0dd"],"\uc0ad\uc81c":b["\uc0ad\uc81c"],"\ubd80\uc11c\uba85":b["\ubd80\uc11c\uba85"],"\uae30\uc548\uc77c":w["\uae30\uc548\uc77c"],"\uacb0\uc7ac\uc591\uc2dd":w["\uacb0\uc7ac\uc591\uc2dd"],"\ucca8\ubd80":w["\ucca8\ubd80"],"\ubb38\uc11c \uad6c\ubd84":w["\ubb38\uc11c \uad6c\ubd84"],"\uacb0\uc7ac \uc0c1\ud0dc":w["\uacb0\uc7ac \uc0c1\ud0dc"],"\uc77c\ubc18 \uacb0\uc7ac\ubb38\uc11c":w["\uc77c\ubc18 \uacb0\uc7ac\ubb38\uc11c"],"\uc218\uc2e0 \uacb0\uc7ac\ubb38\uc11c":w["\uc218\uc2e0 \uacb0\uc7ac\ubb38\uc11c"],"\uacb0\uc7ac\uc77c":w["\uacb0\uc7ac\uc77c"],"\ubb38\uc11c\ubc88\ud638":w["\ubb38\uc11c\ubc88\ud638"],"\uc5f4\ub78c\uc790 \ucd94\uac00":w["\uc5f4\ub78c\uc790 \ucd94\uac00"],"\uc811\uc218\ub300\uae30":w["\uc811\uc218\ub300\uae30"],"\uc811\uc218":w["\uc811\uc218"],"\ubc18\uc1a1":w["\ubc18\uc1a1"],"\uc0c1\uc2e0\ucde8\uc18c":w["\uc0c1\uc2e0\ucde8\uc18c"],"\uacb0\uc7ac\ubb38\uc11c\ud68c\uc218":w["\uacb0\uc7ac\ubb38\uc11c\ud68c\uc218"],"\uae30\uc548\uc77c\uc774 \uc5c6\ub294 \ubb38\uc11c\ub294 \uc0dd\uc131\uc77c \uae30\uc900\uc73c\ub85c \uac80\uc0c9\ub429\ub2c8\ub2e4":w["\uae30\uc548\uc77c\uc774 \uc5c6\ub294 \ubb38\uc11c\ub294 \uc0dd\uc131\uc77c \uae30\uc900\uc73c\ub85c \uac80\uc0c9\ub429\ub2c8\ub2e4"],"\uc5f0\ub3d9 \uc5ec\ubd80":w["\uc5f0\ub3d9 \uc5ec\ubd80"],"\uc77c\ubc18\ubb38\uc11c(N)":w["\uc77c\ubc18\ubb38\uc11c(N)"],"\uc5f0\ub3d9\ubb38\uc11c(Y)":w["\uc5f0\ub3d9\ubb38\uc11c(Y)"],"\uc5f0\ub3d9 \uc5ec\ubd80\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694.":w["\uc5f0\ub3d9 \uc5ec\ubd80\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694."],"\uc218\uc2e0 \uc811\uc218\ub300\uae30 / \uc811\uc218 / \ubc18\uc1a1 \ubb38\uc11c\ub97c \uc870\ud68c\ud569\ub2c8\ub2e4":w["\uc218\uc2e0 \uc811\uc218\ub300\uae30 / \uc811\uc218 / \ubc18\uc1a1 \ubb38\uc11c\ub97c \uc870\ud68c\ud569\ub2c8\ub2e4"],"\ubb38\uc11cID":w["\ubb38\uc11cID"],"\uacb0\uc7ac\uc694\uccad\uc2dc \uc0dd\uc131\ub418\ub294 \uace0\uc720\uc758 ID\uc785\ub2c8\ub2e4":w["\uacb0\uc7ac\uc694\uccad\uc2dc \uc0dd\uc131\ub418\ub294 \uace0\uc720\uc758 ID\uc785\ub2c8\ub2e4"],"DocID\ub294 \uc22b\uc790\ub9cc \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4":w["DocID\ub294 \uc22b\uc790\ub9cc \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"]},S=null,x=u.extend({manageType:null,model:v,initialize:function(e){u.prototype.initialize.apply(this,arguments),this.manageType=e},url:function(){return this._makeURL(!1)},getCsvURL:function(){return this._makeURL(!0)},_makeURL:function(t){var n="/api/approval/$REPLACE/document";return this.manageType.isFormAdmin()?n=n.replace("$REPLACE","manageform"):this.manageType.isDocMaster()?n=n.replace("$REPLACE","manage"):n=n.replace("$REPLACE","companyofficial"),t&&(n+="/csv"),n+"?"+e.param({startAt:this.startAt,endAt:this.endAt,drafterName:this.drafterName,drafterDeptName:this.drafterDeptName,activityUserName:this.activityUserName,docNum:this.docNum,title:this.title,"docStatus[]":this.docStatusList,"docType[]":this.docTypeList,"formId[]":this.formIdList,page:this.pageNo,offset:this.pageSize,property:this.property,direction:this.direction,"integration[]":this.integrationList,docId:this.docId,apprStatus:this.apprStatus})},fetch:function(n){typeof n!="undefined"||(n={});var r=this,i=n.beforeSend;t.isFunction(i)||(S=e.goPreloader(),S.render());var s=n.complete;return n.complete=function(e){S!=null&&S.release(),t.isFunction(s)&&s(r,e)},u.prototype.fetch.call(this,n)},setInit:function(e,t,n){this.startAt=r.util.toISO8601(r.util.toMoment(r.util.now().format("YYYY-MM-DD"))),this.endAt=r.util.toISO8601(r.util.searchEndDate(r.util.shortDate(r.util.now().format("YYYY-MM-DD")))),this.property=e,this.direction=t,this.docStatusList=n,this.pageNo=0},setSort:function(e,t){this.property=e,this.direction=t,this.pageNo=0},setSearch:function(e){this.startAt=e.startAt,this.endAt=e.endAt,this.drafterName=e.drafterName,this.drafterDeptName=e.drafterDeptName,this.activityUserName=e.activityUserName,this.docNum=e.docNum,this.title=e.title,this.docTypeList=e.docType,this.docStatusList=e.docStatus,this.formIdList=e.formId,this.pageNo=e.page,this.pageSize=e.offset,this.property=e.property,this.direction=e.direction,this.integrationList=e.integration,this.docId=e.docId,this.apprStatus=e.apprStatus},setListParam:function(){this.pageNo=sessionStorage.getItem("list-history-pageNo"),this.pageSize=sessionStorage.getItem("list-history-pageSize"),this.property=sessionStorage.getItem("list-history-property"),this.direction=sessionStorage.getItem("list-history-direction")}}),T=function(e){this.name="ApprDocManageRenderException",this.message=e},N=n.Model.extend({types:["formAdmin","docMaster","officialDocMaster"],type:null,initialize:function(e){this.type=this._parse(e)},_parse:function(e){if(t.contains(this.types,e))return e;throw new T("Invalid Manage Type.")},isFormAdmin:function(){return this.type=="formAdmin"},isDocMaster:function(){return this.type=="docMaster"},isOfficialDocMaster:function(){return this.type=="officialDocMaster"},getValue:function(){return this.type}}),C=n.View.extend({initialize:function(t){this.$el=e(t),this.collection=new m},render:function(t){this.collection.fetch({success:e.proxy(function(e,n,i){var s=[];s.push(['<option value="',0,'" selected="selected">',E["\uc804\uccb4"],"</option>"].join("")),e.each(function(e){s.push(['<option value="',e.get("id"),'">',e.get("name"),"</option>"].join(""))}),this.$el.html(s.join("\n"));var o=r.router.getSearch(),u=o.formId&&o.formId.length==1?o.formId[0]:"0";u&&this.$el.val(u),t()},this)},this)},getSelectedFormIdList:function(){var e=this.$el.find("option:selected").val();return e==0?null:e}}),k=c.extend({el:"#content",docFolderType:null,columns:{},initialize:function(e){this.isSearch=location.search?!0:!1,r.router.getUrl().indexOf("?")>0&&(this.isSearch=!0),this.options=e||{},t.bindAll(this,"render","renderPageSize","renderPages"),this.contentTop=a.getInstance(),this.manageType=new N(this.options.type),this.manageType.isFormAdmin()||this.manageType.isDocMaster()?this.docFolderType="manage_form":this.docFolderType="manage_official",this.collection=new x(this.manageType),this.collection.bind("reset",this.resetList,this),this.initProperty="id",this.initDirection="desc";var n=sessionStorage.getItem("list-history-baseUrl");n&&(n=n.replace(/#/gi,"")),n&&n=="approval/manage/document"?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.collection.setListParam()):this.collection.setSearch(r.router.getSearch()),sessionStorage.clear(),this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},c.prototype.initialize.call(this,e)},events:{"click input[name=docStatCheck]":"toggleDocStatCheckbox","click input[name=docTypeCheck]":"toggleDocTypeCheckbox","click input[name=docIntegrationCheck]":"toggleDocIntegrationCheckbox","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click a#btn_search_document":"docManageSearch","click input[name=checkedAllDeptDoc]":"toggleCheckboxDocManage"},_initDate:function(){e.datepicker.setDefaults(e.datepicker.regional[r.config("locale")]);var t=this.$el.find("#startDate"),n=this.$el.find("#endDate");return this.$el.find("#startDate").val(r.util.fromNow("days",-7).format("YYYY-MM-DD")),this.$el.find("#endDate").val(r.util.now().format("YYYY-MM-DD")),t.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onClose:function(e){n.datepicker("option","minDate",e)}}),n.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",minDate:t.val()}),this},toggleDocStatCheckbox:function(t){if(e(t.currentTarget).attr("id")=="docStatAllCheck"){var n=this.$el.find("#docStatAllCheck").is(":checked");e('input[type="checkbox"][name="docStatCheck"]').attr("checked",n)}else{var n=e(t.currentTarget).is(":checked");e(t.currentTarget).attr("checked",n),n||e("#docStatAllCheck").attr("checked",!1)}},toggleDocTypeCheckbox:function(t){if(e(t.currentTarget).attr("id")=="docTypeAllCheck"){var n=this.$el.find("#docTypeAllCheck").is(":checked");e('input[type="checkbox"][name="docTypeCheck"]').attr("checked",n)}else{var n=e(t.currentTarget).is(":checked");e(t.currentTarget).attr("checked",n),n||e("#docTypeAllCheck").attr("checked",!1)}},toggleDocIntegrationCheckbox:function(t){if(e(t.currentTarget).attr("id")=="docIntegrationAllCheck"){var n=this.$el.find("#docIntegrationAllCheck").is(":checked");e('input[type="checkbox"][name="docIntegrationCheck"]').attr("checked",n)}else{var n=e(t.currentTarget).is(":checked");e(t.currentTarget).attr("checked",n),n||e("#docIntegrationAllCheck").attr("checked",!1)}},_initStatus:function(){this.$el.find("input[type=checkbox][name=docStatCheck]").prop("checked",!0)},_initType:function(){this.$el.find("input[type=checkbox][name=docTypeCheck]").prop("checked",!0)},_initIntegration:function(){this.$el.find("input[type=checkbox][name=docIntegrationCheck]").prop("checked",!0)},_initPage:function(e,t){this.collection.setPageSize(t),this.collection.setPageNo(e)},render:function(){i(this.fetchDocField.call(this)).then(t.bind(this.renderLayout,this)).then(t.bind(this.renderDocFieldSettingView,this)).then(t.bind(this.renderDocFieldColumnTpl,this)).then(t.bind(this.renderFormView,this)).then(t.bind(this.setInitSort,this)).otherwise(function(t){console.log(t.stack)})},renderLayout:function(e){return this.$el.empty(),this.$el.html(y({lang:E})),this._initDate(),this._initStatus(),this._initType(),this._initIntegration(),t.isEmpty(this.collection.pageNo)&&t.isEmpty(this.collection.pageSize)?this._initPage(0,20):this._initPage(this.collection.pageNo,this.collection.pageSize),this.isSearch&&this.renderSearchParam(),this.contentTop.setTitle(w["\uc591\uc2dd\ubcc4 \ubb38\uc11c \uc870\ud68c"]),this.manageType.isOfficialDocMaster()&&this.contentTop.setTitle(w["\uc804\uc0ac \uacf5\ubb38 \ubc1c\uc1a1\ud568"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.renderPageSize(),this._makeCsvDownloadButton(),(this.manageType.type=="docMaster"||this.manageType.type=="formAdmin")&&this._makeBulkActionButtons(),this.$el},renderFormView:function(){this.formSelectView=new C("#formId"),this.formSelectView.render(e.proxy(this.docManageSearch,this))},toggleCheckboxDocManage:function(t){var n=e(t.currentTarget),r=e(n).is(":checked");n.attr("id")==this.checkboxColumn.id&&e('input[name="checkbox_docmanage"]:not([disabled])').prop("checked",r),n.hasClass("doc_manager_item_checkbox")&&(r||e("#"+this.checkboxColumn.id).prop("checked",r))},renderSearchParam:function(){var e=r.router.getSearch(),n=e.startAt||"",i=e.endAt||"",s=e.docStatus,o=e.docType,u=e.integration,a=e.apprStatus;this.$("#startDate").val(n.split("T")[0]),this.$("#endDate").val(i.split("T")[0]),this.$("#drafterName").val(e.drafterName||""),this.$("#drafterDeptName").val(e.drafterDeptName||""),this.$("#activityUserName").val(e.activityUserName||""),this.$("#docNum").val(e.docNum||""),this.$("#title").val(e.title.replace(/\+/gi," ")||""),this.$("#docId").val(e.docId||""),this.$("#apprStatus").val(a||""),this.$("input[type=checkbox][name=docStatCheck]").attr("checked",!1),(s.length==7||s.length==8)&&this.$("#docStatAllCheck").attr("checked",!0),t.each(s,function(e){this.$("#"+e.toLowerCase()).attr("checked",!0)},this),t.contains(s,"draft_waiting")&&t.contains(s,"tempsave")&&a=="cancel"&&this.$("#cancel_draft").attr("checked",!0),this.$("input[type=checkbox][name=docTypeCheck]").attr("checked",!1),o.length==2&&this.$("#docTypeAllCheck").attr("checked",!0),t.each(o,function(e){var e=e.toLowerCase();this.$("input[type=checkbox][name=docTypeCheck][value="+e+"]").attr("checked",!0)},this),this.$("input[type=checkbox][name=docIntegrationCheck]").attr("checked",!1),u.length==2&&this.$("#docIntegrationAllCheck").attr("checked",!0),t.each(u,function(e){this.$("input[type=checkbox][name=docIntegrationCheck][value="+e+"]").attr("checked",!0)},this)},renderPageSize:function(){this.pageSizeView=new l({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new f({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el)},resetList:function(t){var n=this.collection.url().slice(this.collection.url().indexOf("api/")+4),i=r.router.getUrl().replace("#","");i.indexOf("?")<0?r.router.navigate(n,{replace:!0}):i!=n&&r.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty(),t.isEmpty()?e(".list_approval > tbody").html(g({columns:this.columns,lang:{doclist_empty:w["\uac80\uc0c9 \ub41c \ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})):t.each(function(t){var n="manage";this.manageType.isFormAdmin()?n="manageform":this.manageType.isOfficialDocMaster()&&(n="companyofficial");var r=new h({listType:n,columns:this.columns,isManager:!0,model:t});e(".list_approval > tbody").append(r.render().el)},this),this.renderPages()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},sort:function(t){var n="#"+e(t.currentTarget).attr("id"),r=e(n).attr("sort-id"),i="desc",s="",o="";e(n).hasClass("sorting")&&(s="sorting",o="sorting_desc"),e(n).hasClass("sorting_desc")&&(s="sorting_desc",o="sorting_asc",i="asc"),e(n).hasClass("sorting_asc")&&(s="sorting_asc",o="sorting_desc"),e(n).removeClass(s).addClass(o);var u=this.$el.find("th");u.each(function(){!e(this).hasClass("sorting_disabled")&&"#"+e(this).attr("id")!=n&&(e(this).removeClass("sorting").addClass("sorting"),e(this).removeClass("sorting_desc").addClass("sorting"),e(this).removeClass("sorting_asc").addClass("sorting"))}),this.collection.setSort(r,i),this.collection.fetch()},docManageSearch:function(){if(this.isSearch)this.isSearch=!1,this.collection.setListParam(),this.collection.setSearch(r.router.getSearch());else{var n=r.util.toISO8601(r.util.toMoment(e("#startDate").val())),i=r.util.toISO8601(r.util.toMoment(e("#endDate").val()).add("days",1).subtract("seconds",1)),s=e.trim(e("#drafterName").val()),o=e.trim(e("#drafterDeptName").val()),u=e.trim(e("#activityUserName").val()),a=e.trim(e("#docNum").val()),f=e.trim(e("#title").val().replace(/\+/gi," ")),l=e.trim(e("#docId").val()),c="",h=[];t.each(e("input[type=checkbox][name=docStatCheck]:checked"),function(t){e(t).attr("id")!="docStatAllCheck"&&(e(t).val()=="cancel_draft"?(h.push("draft_waiting"),h.push("tempsave"),c="cancel"):h.push(e(t).val()))});var p=[];t.each(e("input[type=checkbox][name=docTypeCheck]:checked"),function(t){e(t).attr("id")!="docTypeAllCheck"&&p.push(e(t).val())});var d=[];t.each(e("input[type=checkbox][name=docIntegrationCheck]:checked"),function(t){e(t).attr("id")!="docIntegrationAllCheck"&&d.push(e(t).val())});if(h.length==0){e.goError(w["\ubb38\uc11c \uc0c1\ud0dc\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]);return}if(p.length==0){e.goError(w["\ubb38\uc11c \uad6c\ubd84\uc744 \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]);return}if(d.length==0){e.goError(w["\uc5f0\ub3d9 \uc5ec\ubd80\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694."]);return}if(e.trim(l)!=""&&!e.isNumeric(l)){e.goError(w["DocID\ub294 \uc22b\uc790\ub9cc \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"]);return}var v=this.formSelectView.getSelectedFormIdList();this.collection.setSearch({startAt:n,endAt:i,drafterName:s,drafterDeptName:o,activityUserName:u,docNum:a,title:f,docType:p,docStatus:h,formId:v,page:0,offset:this.collection.pageSize,property:this.initProperty,direction:this.initDirection,integration:d,docId:l,apprStatus:c}),this.setInitSort(this.initProperty,this.initDirection)}this.collection.fetch()},_makeCsvDownloadButton:function(){(new p({getDownloadURL:e.proxy(this.collection.getCsvURL,this.collection),appendTarget:this.$el.find("#docToolbar > ul.critical > li")})).render()},_makeBulkActionButtons:function(){var e=this;(new d({appendTarget:this.$el.find("#downloadListCsv"),getSelectedDocs:function(){return e._getSelectedDocs()},resetList:function(){e.collection.fetch()}})).render()},_getSelectedDocs:function(){var n=e(".list_approval input[type=checkbox][data-id]:checked"),r=t.map(n,function(t){return parseInt(e(t).attr("data-id"))});return this.collection.select(function(e){return t.contains(r,e.get("id"))})},getCheckedIds:function(){return t.map(e(".list_approval input[type=checkbox][name='checkbox_docmanage'][data-id]:checked"),function(t){return e(t).attr("data-id")})},release:function(){this.$el.off(),this.$el.empty()}});return k});