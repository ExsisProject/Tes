define(["jquery","backbone","when","hogan","approval/models/ref_document","approval/views/mobile/document/m_attach_file","approval/views/mobile/document/m_appr_attach_file","approval/views/mobile/document/m_preview","content_viewer","hgn!approval/templates/mobile/document/m_document","hgn!approval/templates/mobile/document/m_reference_doc_view","i18n!nls/commons","i18n!approval/nls/approval","formutil","jquery.go-popup","jquery.ui","iscroll"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p={confirm:c["\ud655\uc778"],cancel:c["\ucde8\uc18c"],save:c["\uc800\uc7a5"],noti:c["\uc54c\ub9bc"],ref_doc:h["\uad00\ub828\ubb38\uc11c"],view:h["\ubcf4\uae30"],preview:h["\ubbf8\ub9ac\ubcf4\uae30"],amt:h["\uac1c"],"\uc6d0\ubcf8\ubb38\uc11c":h["\uc6d0\ubcf8\ubb38\uc11c"]},d="body {margin: 0px;}",v=t.View.extend({initialize:function(e){this.options=e||{},_.bindAll(this,"render"),this.title=this.options.title,this.docType=this.options.type,this.docId=this.options.docId,this.docModel=this.options.model,this.actionModel=this.options.actionModel,this.infoModel=this.options.infoData,this.formIntegrator=this.options.formIntegrator||{}},events:{"vclick a#btnRefDocPreview":"refDocPreview"},render:function(){var t=this,r=n.defer(),i=!1,s=this.infoModel.formScriptType,o=this.infoModel.externalScript,u=this.infoModel.scriptBody;this.setDocVariables(),this.$el.html(f({lang:p})),this.docContents=e("#document_content");var a=0;return this.setAttachTemplate(),this.formOpts={data:this.docModel.docBodyContent,contextRoot:"/",userId:this.docModel.drafterId,userProfileApi:"api/user/profile",docType:this.docModel.docType,draftDate:this.docModel.draftedAt?GO.util.formatDatetime(this.docModel.draftedAt,null,"YYYY-MM-DD(ddd)"):GO.util.formatDatetime(GO.util.toISO8601(new Date),null,"YYYY-MM-DD(ddd)")},this.docModel.docStatus=="CREATE"||this.docModel.docStatus=="TEMPSAVE"?(this.setDocumentTemplate(_.clone(this.formOpts)),s=="SRC"&&!_.isEmpty(o)?(this.renderIntegrationByExternalScript({mode:"create",moduleName:o}).then(r.resolve,r.reject),i=!0):s=="EDIT"&&!_.isEmpty(u)?this.renderIntegrationByScriptText({mode:"create",scriptBody:u}):this.onNewFormMode()):s=="SRC"&&!_.isEmpty(o)?(this.renderIntegrationByExternalScript({mode:"view",moduleName:o}).then(r.resolve,r.reject),i=!0):s=="EDIT"&&!_.isEmpty(u)?this.renderIntegrationByScriptText({mode:"view",scriptBody:u}):this.setViewMode(),this.hideApprovalLineWrap(),i?r.promise:r.resolve()},hideApprovalLineWrap:function(){this.docContents.find(".approval_header").hide()},setAttachTemplate:function(){var e=this;if(this.docModel.docStatus=="TEMPSAVE")return;this.docModel.attachCount>0&&(s.render({el:"#attachView",docId:this.docId,attaches:this.docModel.attaches}),s.resize(this.$el)),this.$el.find("div#refDocPart").append(l({lang:p,data:function(){var t=e.docModel.receptionOrigin;return!t||0?{references:e.docModel.references}:{references:_.filter(e.docModel.references,function(e){return e.id!=t.id}),receptionOriginInReferences:_.find(e.docModel.references,function(e){return e.id==t.id})}}}))},setDocumentTemplate:function(e){GO.util.store.set("document.docMode","EDIT",{type:"session"});var t=e;t.angleBracketReplace=!1,this.docContents.setTemplate(t)},setViewMode:function(){GO.util.store.set("document.docMode","VIEW",{type:"session"});var t=e.goFormUtil.convertViewMode(this.docModel.docBodyContent);this.docContents.html(t)},renderIntegrationByExternalScript:function(e){var t=this,r=n.defer(),i=e.moduleName,s=e.mode,o=null;return _.isEmpty(i)?(r.reject(),console.log("module name Empty!!")):require([i],function(e){_.isUndefined(e)||(o=new e({variables:_.clone(t.docModel.variables),docModel:t.docModel,infoData:t.infoModel}),s=="create"?(_.isFunction(o.render)&&o.render(),t.formIntegrator.setIntegrationView(o),t.onNewFormMode()):(t.setViewMode(),_.isFunction(o.renderViewMode)&&o.renderViewMode(),t.formIntegrator.setIntegrationView(o),t.hideApprovalLineWrap()),t.decideIscrollInit()),r.resolve()},r.reject),r.promise},renderIntegrationByScriptText:function(e){var t=this,n=e.mode,r=e.scriptBody,i,s=new Function(r);if(s){var o=new s;i=new o({variables:_.clone(t.docModel.variables),docModel:t.docModel,infoData:t.infoModel}),this.formIntegrator.setIntegrationView(i),n=="create"?(_.isFunction(i.render)&&i.render(),this.onNewFormMode()):n=="view"&&(this.setViewMode(),_.isFunction(i.renderViewMode)&&i.renderViewMode())}else console.log("scriptBody is Empty");this.decideIscrollInit()},decideIscrollInit:function(){e(document).width()<this.$el.width()&&GO.util.initDetailiScroll("document_iscroll","document_hscroll","document_view")},onNewFormMode:function(){this.docModel.docStatus=="CREATE"&&this.docContents.setDocVariables(this.docModel.variables),this.setNewFormMode()},setNewFormMode:function(){this.mode="NEW",e(this.el).find("div#editView").show(),e(this.el).find("div#attachView").hide()},refDocPreview:function(t){var n=e(t.currentTarget).attr("data-id"),r=i.create(this.docId,n);r.fetch({async:!1});var s=r.get("document").docBodyContent,o=r.get("document").attaches,a=r.get("document").references,f=r.actionCheckModel.attributes.isDocReadAuthority;GO.router.navigate(GO.router.getUrl()+"#preview"),this.preView=new u({title:p.view,docId:n,docBody:s,attaches:o,references:a,isDocReadAuthority:f}),this.preView.render(),this.$el.hide()},getTitle:function(){return this.docContents.getApprovalSubject()},getDocBodyContents:function(){return this.docContents.find(".approval_header").show(),this.mode=="NEW"||this.mode=="EDIT"?this.docContents.getFormData():this.docContents.html()},getDocVariables:function(){return this.actionModel.useIntegration&&e.goIntegrationForm?e.goIntegrationForm.getIntegrationData():null},setDocVariables:function(){GO.util.store.set("document.variables",this.docModel.variables,{type:"session"})},changeActivityGroups:function(t,n){e.fn.changeActivityGroups({groups:t,config:{activityBox:{headerType:this.actionModel.activityBoxHeaderType,bodyElement:{sign:this.actionModel.activityBoxContentSign,name:this.actionModel.activityBoxContentName,position:this.actionModel.activityBoxContentPosition,duty:this.actionModel.activityBoxContentDuty,dept:this.actionModel.activityBoxContentDept}},isReception:n,displayDrafter:this.infoModel.displayDrafter,includeAgreement:this.infoModel.includeAgreement}})},changeActivity:function(t){e.fn.changeActivity(t)},setDocNum:function(e){return this.docContents.setDocNo(e)},setApprovalData:function(e){return this.docContents.setApprovalData(e)},setRecipient:function(e){return this.docContents.setRecipient(e)},setPreserveDuration:function(e){return this.docContents.setPreserveDuration(e)},setSecurityLevel:function(e){return this.docContents.setSecurityLevel(e)},setDocClassification:function(e){return this.docContents.setDocClassification(e)},setDocReference:function(e){return this.docContents.setDocReference(e)},isCompleteRequiredForm:function(){return this.docContents.isCompleteRequiredForm()},getMaxLengthCheck:function(){return this.docContents.getMaxLengthCheck()},setDocFocus:function(t){e("#"+t).focus()}});return v});