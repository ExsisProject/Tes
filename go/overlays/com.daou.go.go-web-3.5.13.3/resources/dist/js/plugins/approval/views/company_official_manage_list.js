define(["jquery","underscore","backbone","app","when","calendar/libs/util","helpers/form","collections/paginated_collection","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/base_doclist","approval/views/doclist/doclist_item","approval/views/doclist/doclist_csv_download","approval/models/doclist_item","approval/collections/apprFormCoreCollection","hgn!approval/templates/doclist_search_null","hgn!approval/templates/company_official_manage_main","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-popup","jquery.ui"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b){var w={"\uc804\uccb4":b["\uc804\uccb4"],"\uc2b9\uc778":b["\uc2b9\uc778"],"\uc2b9\uc778\ub300\uae30":b["\uc2b9\uc778\ub300\uae30"],"\ubc18\ub824":b["\ubc18\ub824"],"\uc0c1\ud0dc":b["\uc0c1\ud0dc"],"\uae30\uac04":y["\uae30\uac04"],"\uac80\uc0c9 \uae30\uac04":b["\uac80\uc0c9 \uae30\uac04"],"\uae30\uc548\uc790":b["\uae30\uc548\uc790"],"\uae30\uc548\ubd80\uc11c":b["\uae30\uc548\ubd80\uc11c"],"\uacb0\uc7ac\uc120":b["\uacb0\uc7ac\uc120"],"\uc81c\ubaa9":y["\uc81c\ubaa9"],"\uac80\uc0c9":y["\uac80\uc0c9"],"\uc120\ud0dd":y["\uc120\ud0dd"],"\uc0ad\uc81c":y["\uc0ad\uc81c"],"\ubd80\uc11c\uba85":y["\ubd80\uc11c\uba85"],"\uae30\uc548\uc77c":b["\uae30\uc548\uc77c"],"\uacb0\uc7ac\uc591\uc2dd":b["\uacb0\uc7ac\uc591\uc2dd"],"\ucca8\ubd80":b["\ucca8\ubd80"],"\uacb0\uc7ac\uc77c":b["\uacb0\uc7ac\uc77c"],"\ubb38\uc11c\ubc88\ud638":b["\ubb38\uc11c\ubc88\ud638"],"\uc5f4\ub78c\uc790 \ucd94\uac00":b["\uc5f4\ub78c\uc790 \ucd94\uac00"],"\uc2b9\uc778 \uc0c1\ud0dc":b["\uc2b9\uc778 \uc0c1\ud0dc"],"\ubc1c\uc1a1\ucde8\uc18c":b["\ubc1c\uc1a1\ucde8\uc18c"],"\uc2b9\uc778 \uc0c1\ud0dc\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694":b["\uc2b9\uc778 \uc0c1\ud0dc\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694"]},E=null,S=u.extend({manageType:null,model:d,url:function(){return this._makeURL(!1)},getCsvURL:function(){return this._makeURL(!0)},_makeURL:function(t){var n="/api/approval/company/official";return t&&(n+="/csv"),n+"?"+e.param({startAt:this.startAt,endAt:this.endAt,drafterName:this.drafterName,drafterDeptName:this.drafterDeptName,activityUserName:this.activityUserName,docNum:this.docNum,title:this.title,"officialStatus[]":this.officialStatusList,"formId[]":this.formIdList,page:this.pageNo,offset:this.pageSize,property:this.property,direction:this.direction})},setInit:function(e,t,n){this.startAt=r.util.toISO8601(r.util.toMoment(r.util.now().format("YYYY-MM-DD"))),this.endAt=r.util.toISO8601(r.util.searchEndDate(r.util.shortDate(r.util.now().format("YYYY-MM-DD")))),this.property=e,this.direction=t,this.officialStatusList=n,this.pageNo=0},setSort:function(e,t){this.property=e,this.direction=t,this.pageNo=0},fetch:function(n){typeof n!="undefined"||(n={});var r=this,i=n.beforeSend;t.isFunction(i)||(E=e.goPreloader(),E.render());var s=n.complete;return n.complete=function(e){E!=null&&E.release(),t.isFunction(s)&&s(r,e)},u.prototype.fetch.call(this,n)},setSearch:function(e){this.startAt=e.startAt,this.endAt=e.endAt,this.drafterName=e.drafterName,this.drafterDeptName=e.drafterDeptName,this.activityUserName=e.activityUserName,this.docNum=e.docNum,this.title=e.title,this.officialStatusList=e.officialStatus,this.formIdList=e.formId,this.pageNo=e.page,this.pageSize=e.offset,this.property=e.property,this.direction=e.direction},setListParam:function(){this.pageNo=sessionStorage.getItem("list-history-pageNo"),this.pageSize=sessionStorage.getItem("list-history-pageSize"),this.property=sessionStorage.getItem("list-history-property"),this.direction=sessionStorage.getItem("list-history-direction")}}),x=n.View.extend({initialize:function(t){this.$el=e(t),this.collection=new v},render:function(t){this.collection.fetch({success:e.proxy(function(e,n,i){var s=[];s.push(['<option value="',0,'" selected="selected">',w["\uc804\uccb4"],"</option>"].join("")),e.each(function(e){s.push(['<option value="',e.get("id"),'">',e.get("name"),"</option>"].join(""))}),this.$el.html(s.join("\n"));var o=r.router.getSearch(),u=o.formId&&o.formId.length==1?o.formId[0]:"0";u&&this.$el.val(u),t()},this)},this)},getSelectedFormIdList:function(){var e=this.$el.find("option:selected").val();return e==0?null:e}}),T=n.Model.extend({initialize:function(e){this.docId=e},url:function(){var e=["/api/approval/document",this.docId,"draft"].join("/");return e},setUrl:function(e){this.url=e}}),N=c.extend({el:"#content",docFolderType:null,columns:{"\uc120\ud0dd":b["\uc120\ud0dd"],"\uae30\uc548\uc77c":b["\uae30\uc548\uc77c"],"\uae30\uc548\uc790":b["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc591\uc2dd":b["\uacb0\uc7ac\uc591\uc2dd"],"\uc81c\ubaa9":y["\uc81c\ubaa9"],"\ucca8\ubd80":b["\ucca8\ubd80"],"\uacb0\uc7ac\uc0c1\ud0dc":b["\uacb0\uc7ac\uc0c1\ud0dc"],"\ubb38\uc11c\ubc88\ud638":b["\ubb38\uc11c\ubc88\ud638"],count:8},initialize:function(e){this.isSearch=location.search?!0:!1,r.router.getUrl().indexOf("?")>0&&(this.isSearch=!0),this.options=e||{},t.bindAll(this,"render","renderPageSize","renderPages"),this.contentTop=a.getInstance(),this.docFolderType="manage_official",this.collection=new S,this.collection.bind("reset",this.resetList,this),this.initProperty="document.draftedAt",this.initDirection="desc",this.collection.setSearch(r.router.getSearch()),sessionStorage.clear(),this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},c.prototype.initialize.call(this,e)},events:{"click input[name=officialStatCheck]":"toggleOfficialStatCheckbox","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click a#btn_search_document":"docManageSearch","click input[name=checkedAllDeptDoc]":"toggleCheckboxDocManage"},_initDate:function(){e.datepicker.setDefaults(e.datepicker.regional[r.config("locale")]);var t=this.$el.find("#startDate"),n=this.$el.find("#endDate");return this.$el.find("#startDate").val(r.util.fromNow("days",-7).format("YYYY-MM-DD")),this.$el.find("#endDate").val(r.util.now().format("YYYY-MM-DD")),t.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onClose:function(e){n.datepicker("option","minDate",e)}}),n.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",minDate:t.val()}),this},toggleOfficialStatCheckbox:function(t){if(e(t.currentTarget).attr("id")=="officialStatAllCheck"){var n=this.$el.find("#officialStatAllCheck").is(":checked");e('input[type="checkbox"][name="officialStatCheck"]').attr("checked",n)}else{var n=e(t.currentTarget).is(":checked");e(t.currentTarget).attr("checked",n),n||e("#officialStatAllCheck").attr("checked",!1)}},_initStatus:function(){this.$el.find("input[type=checkbox][name=officialStatCheck]").prop("checked",!0)},_initPage:function(e,t){this.collection.setPageSize(t),this.collection.setPageNo(e)},render:function(){i(this.fetchDocField.call(this)).then(t.bind(this.renderLayout,this)).then(t.bind(this.renderDocFieldSettingView,this)).then(t.bind(this.renderDocFieldColumnTpl,this)).then(t.bind(this.renderFormView,this)).then(t.bind(this.setInitSort,this)).otherwise(function(t){console.log(t.stack)})},renderLayout:function(e){return this.$el.empty(),this.$el.html(g({lang:w})),this._initDate(),this._initStatus(),this._initPage(0,20),this.isSearch&&this.renderSearchParam(),this.contentTop.setTitle(b["\uc804\uc0ac \uacf5\ubb38 \ubc1c\uc1a1\ud568"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.renderPageSize(),this._makeCsvDownloadButton(),this.$el},renderFormView:function(){this.formSelectView=new x("#formId"),this.formSelectView.render(e.proxy(this.docManageSearch,this))},toggleCheckboxDocManage:function(t){var n=e(t.currentTarget),r=e(n).is(":checked");n.attr("id")==this.checkboxColumn.id&&e('input[name="checkbox_docmanage"]:not([disabled])').prop("checked",r),n.hasClass("doc_manager_item_checkbox")&&(r||e("#"+this.checkboxColumn.id).prop("checked",r))},renderSearchParam:function(){var e=r.router.getSearch(),n=e.startAt||"",i=e.endAt||"",s=e.officialStatus;this.$("#startDate").val(n.split("T")[0]),this.$("#endDate").val(i.split("T")[0]),this.$("#drafterName").val(e.drafterName||""),this.$("#drafterDeptName").val(e.drafterDeptName||""),this.$("#activityUserName").val(e.activityUserName||""),this.$("#docNum").val(e.docNum||""),this.$("#title").val(e.title.replace(/\+/gi," ")||""),this.$("input[type=checkbox][name=officialStatCheck]").attr("checked",!1),s.length==3&&this.$("#officialStatAllCheck").attr("checked",!0),t.each(s,function(e){this.$("#"+e.toLowerCase()).attr("checked",!0)},this)},renderPageSize:function(){this.pageSizeView=new l({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new f({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el)},resetList:function(t){var n=this.collection.url().slice(this.collection.url().indexOf("api/")+4),i=r.router.getUrl().replace("#","");i.indexOf("?")<0?r.router.navigate(n,{replace:!0}):i!=n&&r.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty(),t.isEmpty()?e(".list_approval > tbody").html(m({columns:this.columns,lang:{doclist_empty:b["\uac80\uc0c9 \ub41c \ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})):t.each(function(t){var n="officialDoc",r=new h({listType:n,columns:this.columns,isManager:!0,model:t,useDocInfo:!1});e(".list_approval > tbody").append(r.render().el)},this),this.renderPages()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},sort:function(t){var n="#"+e(t.currentTarget).attr("id"),r=e(n).attr("sort-id"),i="desc",s="",o="";e(n).hasClass("sorting")&&(s="sorting",o="sorting_desc"),e(n).hasClass("sorting_desc")&&(s="sorting_desc",o="sorting_asc",i="asc"),e(n).hasClass("sorting_asc")&&(s="sorting_asc",o="sorting_desc"),e(n).removeClass(s).addClass(o);var u=this.$el.find("th");u.each(function(){!e(this).hasClass("sorting_disabled")&&"#"+e(this).attr("id")!=n&&(e(this).removeClass("sorting").addClass("sorting"),e(this).removeClass("sorting_desc").addClass("sorting"),e(this).removeClass("sorting_asc").addClass("sorting"))}),this.collection.setSort(r,i),this.collection.fetch()},docManageSearch:function(){if(this.isSearch)this.isSearch=!1,this.collection.setListParam(),this.collection.setSearch(r.router.getSearch());else{var n=r.util.toISO8601(r.util.toMoment(e("#startDate").val())),i=r.util.toISO8601(r.util.toMoment(e("#endDate").val()).add("days",1).subtract("seconds",1)),s=e.trim(e("#drafterName").val()),o=e.trim(e("#drafterDeptName").val()),u=e.trim(e("#activityUserName").val()),a=e.trim(e("#docNum").val()),f=e.trim(e("#title").val().replace(/\+/gi," ")),l=[];t.each(e("input[type=checkbox][name=officialStatCheck]:checked"),function(t){e(t).attr("id")!="officialStatAllCheck"&&l.push(e(t).val())});if(l.length==0){e.goError(w["\uc2b9\uc778 \uc0c1\ud0dc\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694"]);return}var c=this.formSelectView.getSelectedFormIdList();this.collection.setSearch({startAt:n,endAt:i,drafterName:s,drafterDeptName:o,activityUserName:u,docNum:a,title:f,officialStatus:l,formId:c,offset:this.collection.pageSize,property:this.initProperty,direction:this.initDirection}),this.setInitSort(this.initProperty,this.initDirection)}this.collection.fetch()},_makeCsvDownloadButton:function(){(new p({getDownloadURL:e.proxy(this.collection.getCsvURL,this.collection),appendTarget:this.$el.find("#docToolbar > ul.critical > li")})).render()},release:function(){this.$el.off(),this.$el.empty()}});return N});