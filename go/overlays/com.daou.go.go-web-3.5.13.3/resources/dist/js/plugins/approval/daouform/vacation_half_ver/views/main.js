define(function(require){var e=require("jquery"),t=require("backbone"),n=require("underscore"),r=require("approval/daouform/vacation_half_ver/models/non_holiday_count"),i=require("hgn!approval/daouform/vacation_half_ver/templates/typeTemplate"),s=require("hgn!approval/daouform/vacation_half_ver/templates/halfTemplate"),o=require("hgn!approval/daouform/vacation_half_ver/templates/pointTemplate"),u=require("i18n!nls/commons"),a=require("i18n!vacation/nls/vacation"),f=t.View.extend({initialize:function(t){this.$startDateEl=e(t.startDateEl),this.$endDateEl=e(t.endDateEl),this.$vacationTypeAreaEl=e(t.vacationTypeAreaEl),this.$vacationHalfAreaEl=e(t.vacationHalfAreaEl),this.$restPointAreaEl=e(t.restPointAreaEl),this.$selectedDaysAreaEl=e(t.selectedDaysAreaEl),this.$applyPointAreaEl=e(t.applyPointAreaEl),this.$descriptionEl=e(t.descriptionEl),this.variablesData=t.variables,this.vacationTypes=n.pluck(t.models,"attributes"),this.drafterId=t.docModel.drafterId},render:function(){function t(e){if(!e.length)return;e.html(s({checkStartEnd:"{{check_\uc2dc\uc791\uc77c_\uc885\ub8cc\uc77c}}",checkHalf:"{{check_\uc624\uc804_\uc624\ud6c4}}"}))}function r(e,t,n,r){if(!e.length)return;var i={text:t,dsl:["{{number:",n,"}}"].join(""),name:n,id:n,value:r};e.html(o({data:i}))}function u(t,r){var s=["cSel"],o=n.pluck(r,"name");s=e.merge(s,o);var u={dsl:"{{"+s.join("_")+"}}",options:r};t.html(i({data:u}))}this.$startDateEl.datepicker("setDate",new Date),this.$endDateEl.datepicker("setDate",new Date),u(this.$vacationTypeAreaEl,this.vacationTypes),r(this.$selectedDaysAreaEl,"\uc120\ud0dd\uc77c\uc218","usingPoint",1),r(this.$restPointAreaEl,"\uc794\uc5ec\uc5f0\ucc28","restPoint",parseFloat(this.variablesData.restPoint)),r(this.$applyPointAreaEl,"\uc2e0\uccad\uc5f0\ucc28","applyPoint",1),t(this.$vacationHalfAreaEl),this.refresh(),this._eventBind()},getVacationType:function(e){return this.vacationTypes.filter(function(t){return t.name==e})[0]},renderEditDocument:function(){this.$selectedDaysAreaEl.find("input").attr("readOnly",!0),this.$applyPointAreaEl.find("input").attr("readOnly",!0),this.$restPointAreaEl.find("input").attr("readOnly",!0),this.$vacationHalfAreaEl.find("input[name^='checkHalf']").unwrap("span"),this._eventBind(),this.$endDateEl.trigger("change")},_eventBind:function(){function s(){return n.isEqual(t.$startDateEl.val(),t.$endDateEl.val())}function o(){e.goError("(\ubc18)\ubc18\ucc28\ub294 \uc5f0\uc774\uc5b4\uc11c\ub9cc \uc120\ud0dd\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. (\ubd84\ub9ac\ud574\uc11c \uc0ac\uc6a9\ud558\ub824\uba74 \ub098\ub220\uc11c \uc2e0\uccad\ud574\uc8fc\uc138\uc694)")}function u(e){e.filter(":first").nextUntil(e.filter(":last"),"input").prop("checked",!0)}function a(){t.$vacationHalfAreaEl.find("input#startHalf").prop("checked")?t.$vacationHalfAreaEl.find("input#startQuarter4").prop("checked",!0).trigger("change"):t.$vacationHalfAreaEl.find("input#endHalf").prop("checked")&&t.$vacationHalfAreaEl.find("input#endQuarter1").prop("checked",!0).trigger("change")}function f(){s()?t.$vacationHalfAreaEl.find("input[id^='end']").prop("checked",!1).prop("disabled",!0):(t.$vacationHalfAreaEl.find("input[id^='end']").prop("disabled",!1),a())}function l(){t.$endDateEl.datepicker("option","minDate",t.$startDateEl.val())}var t=this;l(),e.merge(t.$startDateEl,t.$endDateEl).on("change",function(){l(),f(),t.refresh()}),this.$vacationTypeAreaEl.on("change",function(n){t.refresh();var r=e(n.currentTarget).find("select");r.attr("data-selectval",r.val())}),this.$vacationHalfAreaEl.on("change",function(){t.refresh()}),this.$vacationHalfAreaEl.find("input:checkbox").filter("input[name^='checkStartEnd']").on("change",function(t){var n=e(t.currentTarget);n.is(":checked")?!s()&&n.attr("id")=="startHalf"?n.closest("span.halfArea").find("input#startHalf2").prop("checked",!0):n.closest("span.halfArea").find("input[id$='Half1']").prop("checked",!0):n.closest("span.halfArea").find(":checkbox").prop("checked",!1)});var r=this.$vacationHalfAreaEl.find("input:checkbox").filter("input[name^='checkHalf']").filter("input[name$='startHalf']");r.on("change",function(t){var n=e(t.currentTarget);if(!s()){n.prevAll().filter("input:checked").length&&(n.prop("checked",!0),o());if(n.attr("id")!=="startHalf2"){var i=n.nextAll().filter("input");i.filter(":not(:checked)").length&&o(),i.prop("checked",!0)}}var a=r.filter(":checked").length;a>1&&u(r.filter(":checked")),n.closest("span.halfArea").find("input#startHalf").prop("checked",a>0?!0:!1)});var i=this.$vacationHalfAreaEl.find("input:checkbox").filter("input[name^='checkHalf']").filter("input[name$='endHalf']");i.on("change",function(t){var n=e(t.currentTarget);if(!s()){n.nextAll().filter("input:checked").length&&(n.prop("checked",!0),o());if(n.attr("id")!=="endHalf1"){var r=n.prevAll().filter("input");r.filter(":not(:checked)").length&&o(),r.prop("checked",!0)}}var a=i.filter(":checked").length;a>1&&u(i.filter(":checked")),n.closest("span.halfArea").find("input#endHalf").prop("checked",a>0?!0:!1)})},isVacation:function(){var e=!1,t=this.getVacationName();return n.each(this.vacationTypes,function(n){if(n.name==t){e=n.useVacationPoint;return}},this),e},refresh:function(){function i(e,t){var n=new Date(GO.util.customDate(e.val().split("(")[0],"YYYY-MM-DD")),r=new Date(GO.util.customDate(t.val().split("(")[0],"YYYY-MM-DD")),i=r.getTime()-n.getTime(),s=i/864e5+1;return s}function s(e,t){var n=.5,r=e.find("input[name^='checkStartEnd']").filter(":checked").length,i=e.find("input[name^='checkHalf']").filter(":checked").length;return t-r+n*i}function o(t,n,i,s){var o=GO.util.customDate(t.val().split("(")[0],"YYYY-MM-DD"),a=GO.util.customDate(n.val().split("(")[0],"YYYY-MM-DD"),f={startDate:o,endDate:a,vacationName:i,drafterId:s},l=new r;l.fetch({data:f,async:!1,error:function(t,n,r){e.goError(u["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"]),GO.router.navigate("approval",{trigger:!0})},success:function(e,t){l.nonHolidayCount=t.data}});var c=l.nonHolidayCount*1;return c}var t=o(this.$startDateEl,this.$endDateEl,this.getVacationName(),this.drafterId);this.applyPoint=this.isVacation()?s(this.$vacationHalfAreaEl,t):0;var n=i(this.$startDateEl,this.$endDateEl);this.$selectedDaysAreaEl.find("input").val(n),this.$applyPointAreaEl.find("input").attr("value",this.applyPoint),this.validate().applyPoint(this.applyPoint,n)},getVacationName:function(){return this.$vacationTypeAreaEl.find("select").val()},getVariablesData:function(){return{title:this.getVacationName(),isAnnualVacation:this.isVacation(),year:this.variablesData.year,startDate:GO.util.customDate(this.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),endDate:GO.util.customDate(this.$endDateEl.val().split("(")[0],"YYYY-MM-DD"),startQuarter1:e("#startHalf1").is(":checked"),startQuarter2:e("#startHalf1").is(":checked"),startQuarter3:e("#startHalf2").is(":checked"),startQuarter4:e("#startHalf2").is(":checked"),endQuarter1:e("#endHalf1").is(":checked"),endQuarter2:e("#endHalf1").is(":checked"),endQuarter3:e("#endHalf2").is(":checked"),endQuarter4:e("#endHalf2").is(":checked"),applyPoint:this.isVacation()?this.applyPoint:0,description:this.$descriptionEl.val(),version:"2.5.8.0"}},validate:function(){var t=this;return{applyPoint:function(n,r){var i=t.getVacationType(t.getVacationName());if(i.limited&&i.availableMax<r){e("#usingPoint_Comment").text(GO.i18n(a["\uc0ac\uc6a9 \uac00\ub2a5\uc77c \uc218 \uc5d0\ub7ec\uba54\uc2dc\uc9c0"],{availableMax:i.availableMax}));return}if(n>parseFloat(t.variablesData.restPoint)){e("#usingPoint_Comment").text(u["\uc2e0\uccad\uac00\ub2a5\uc77c\uc744 \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4."]);return}e("#usingPoint_Comment").text("")},descriptionLength:function(){var n=1333,r=e(t.$descriptionEl).attr("data-maxlength")?parseInt(e(t.$descriptionEl).attr("data-maxlength")):n;r>n&&(r=n);var i=t.$descriptionEl.val()&&e(t.$descriptionEl).val().length>r;return i?(r===n&&(r="(4000byte)1333"),e.goSlideMessage(GO.i18n(u["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],"arg1",r)),!1):!0}}}});return f});