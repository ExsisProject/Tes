define(["jquery","underscore","backbone","app","approval/views/content_top","approval/views/doclist/rulelist_item","approval/views/create_rule","approval/views/side","hgn!approval/templates/doclist_empty","hgn!approval/templates/doc_classify_list","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-popup","jquery.go-orgslide","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=n.Model.extend({url:function(){return this.deptId?"/api/approval/classify/dept/rule/reorder/"+this.deptId:"/api/approval/classify/user/rule/reorder"},setDeptId:function(e){this.deptId=e}}),p=n.Collection.extend({url:function(){return this.deptId?"/api/approval/classify/dept/"+this.deptId+"/rulelist":"/api/approval/classify/user/"+this.userId+"/rulelist"},setUserId:function(e){this.userId=e},setDeptId:function(e){this.deptId=e}}),d=n.Model.extend({url:function(){return this.deptId?"/api/approval/classify/dept/owner/"+this.deptId:"/api/approval/classify/owner"},setDeptId:function(e){this.deptId=e}}),v={"\ub2f4\ub2f9\uc790 \ucd94\uac00":c["\ub2f4\ub2f9\uc790 \ucd94\uac00"],"\uc21c\uc11c \ubc14\uafb8\uae30":c["\uc21c\uc11c \ubc14\uafb8\uae30"],"\uc0ad\uc81c":l["\uc0ad\uc81c"],"\ucd94\uac00":l["\ucd94\uac00"],"\ubb38\uc11c\ud568 \uc774\ub984":c["\ubb38\uc11c\ud568 \uc774\ub984"],"\uc0dd\uc131\uc77c":c["\uc0dd\uc131\uc77c"],"\uc0ad\uc81c":l["\uc0ad\uc81c"],"\ubb38\uc11c \uac1c\uc218":c["\ubb38\uc11c \uac1c\uc218"],"\uc218\uc815":l["\uc218\uc815"],"\uc218\uc815\uc644\ub8cc":l["\uc218\uc815\uc644\ub8cc"],"\ucde8\uc18c":l["\ucde8\uc18c"],migration:c["\ubb38\uc11c\ud568 \uc774\uad00"],"\uac1c\uc778 \ubb38\uc11c\ud568 \ucd94\uac00":c["\uac1c\uc778 \ubb38\uc11c\ud568 \ucd94\uac00"],"\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac":c["\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac"],"\uac1c\uc778 \ubb38\uc11c\ud568\uba85":c["\uac1c\uc778 \ubb38\uc11c\ud568\uba85"],"\uac1c\uc778 \ubb38\uc11c\ud568 \ud3f4\ub354\uba85\uc744 \uc785\ub825\ud558\uc138\uc694":c["\uac1c\uc778 \ubb38\uc11c\ud568 \ud3f4\ub354\uba85\uc744 \uc785\ub825\ud558\uc138\uc694"],"\uac1c\uc778 \ubb38\uc11c\ud568 \uad00\ub9ac":c["\uac1c\uc778 \ubb38\uc11c\ud568 \uad00\ub9ac"],"\uc774\ubbf8 \ub3d9\uc77c\ud55c \uc774\ub984\uc758 \ubb38\uc11c\ud568\uc774 \uc788\uc2b5\ub2c8\ub2e4":c["\uc774\ubbf8 \ub3d9\uc77c\ud55c \uc774\ub984\uc758 \ubb38\uc11c\ud568\uc774 \uc788\uc2b5\ub2c8\ub2e4"],"\uac1c\uc778 \ubb38\uc11c\ud568 \uc774\uad00":c["\uac1c\uc778 \ubb38\uc11c\ud568 \uc774\uad00"],"\uc124\uc815":l["\uc124\uc815"],"\uc774 \ubb38\uc11c\ud568\uc758 \uacf5\uc720 \uc124\uc815\uc740 \ubaa8\ub450 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4":c["\uc774 \ubb38\uc11c\ud568\uc758 \uacf5\uc720 \uc124\uc815\uc740 \ubaa8\ub450 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4"],"\ubb38\uc11c\ud568":c["\ubb38\uc11c\ud568"],"\uc790\ub3d9\ubd84\ub958":c["\uc790\ub3d9\ubd84\ub958"],"\uc790\ub3d9\ubd84\ub958 \uaddc\uce59":c["\uc790\ub3d9\ubd84\ub958 \uaddc\uce59"],"\uc801\uc6a9\ud568":c["\uc801\uc6a9\ud568"],"\uc801\uc6a9\ud558\uc9c0 \uc54a\uc74c":c["\uc801\uc6a9\ud558\uc9c0 \uc54a\uc74c"],"\ubd84\ub958\uaddc\uce59":c["\ubd84\ub958\uaddc\uce59"],"\ubd84\ub958 \uc870\uac74":c["\ubd84\ub958 \uc870\uac74"],"\ubcf4\uad00\ubb38\uc11c\ud568":c["\ubcf4\uad00\ubb38\uc11c\ud568"],"\uad00\ub9ac":c["\uad00\ub9ac"],"\uc800\uc7a5":l["\uc800\uc7a5"],"\ucde8\uc18c":l["\ucde8\uc18c"]},m=n.View.extend({columns:{"\uc120\ud0dd":c.\uc120\ud0dd,count:5},initialize:function(e){this.options=e||{},this.deptId=this.options.deptId,this.contentTop=i.getInstance(),this.userId=r.session("id"),this.collection=new p,this.model=new d,this.deptId?(this.collection.setDeptId(this.deptId),this.model.setDeptId(this.deptId)):this.collection.setUserId(this.userId),this.collection.bind("reset",this.generateList,this),this.collection.fetch({reset:!0}),this.model.fetch({async:!1})},events:{"click .tab_menu > li":"selectTab","click #saveApplyRuleSetting":"saveApplyRuleSetting","click div.critical .btnReorder":"reorderRules","click div.critical .btnCreate":"createRule","click tbody .subject":"updateRule","click div.critical .btnDelete":"deleteRule","click #checkAll":"checkAll"},render:function(){this.$el.html(f({lang:v,model:this.model.toJSON()})),this.deptId?this.contentTop.setTitle(v["\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac"]):this.contentTop.setTitle(v["\uac1c\uc778 \ubb38\uc11c\ud568 \uad00\ub9ac"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el)},selectTab:function(t){if(e(t.currentTarget).attr("class")==="active")return!1;var n=e(t.currentTarget).attr("id"),i="/approval/";n=="tab_folder"?this.deptId?i+="deptfolder/"+this.deptId+"/manage":i+="userfolder/manage":n=="tab_folder_classify"&&(this.deptId?i+="deptfolder/"+this.deptId+"/classify/manage":i+="userfolder/classify/manage"),r.router.navigate(i,{trigger:!0}),e("html, body").animate({scrollTop:0})},saveApplyRuleSetting:function(){this.model.set({inUse:e("#apply").is(":checked")},{silent:!0}),this.model.save({},{type:"PUT",success:function(){e.goMessage(l["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(t,n){var r=JSON.parse(n.responseText);e.goError(r.message)}})},generateList:function(t){e(".tb_part_doc > tbody").empty();var n=this.columns;t.each(function(t){var r=new s({lang:v,model:t,columns:n,userId:this.userId});e(".tb_part_doc > tbody").append(r.render().el)}),t.length==0&&e(".tb_part_doc > tbody").html(a({columns:n,lang:{doclist_empty:c["\ubd84\ub958\uaddc\uce59\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]}}))},reorderRules:function(t){var n=this;if(n.$el.find(".data_null").size()!=0)return e.goMessage(c["\ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;e(t.currentTarget).find("span.txt").text()==c["\uc21c\uc11c \ubc14\uafb8\uae30"]?n.listSortable(t):n.actionListSortPut(t)},listSortable:function(e){this.$el.find(".btnReorder").addClass("btn_save").find("span.txt").html(c["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"]),this.$el.find(".btnCreate").hide(),this.$el.find(".btnDelete").hide(),this.$el.find("input:checkbox").parent("th").hide(),this.$el.find("input:checkbox").parent("td").hide(),this.$el.find("#tableList>tbody").sortable({opacity:"1",delay:100,cursor:"move",items:"tr",containment:".content_page",hoverClass:"ui-state-hover",forceHelperSize:"true",helper:"clone",placeholder:"ui-sortable-placeholder",start:function(e,t){t.placeholder.html("<td colspan='3'>&nbsp;</td>")}}).sortable("enable")},actionListSortPut:function(t){var n=this.$el.find("#tableList tbody"),r=n.find(".subject").map(function(t,n){return e(n).attr("data-id")}).get();if(r){var i;this.deptId?(i=new h,i.setDeptId(this.deptId)):i=new h,i.save({ids:r},{type:"PUT"})}this.$el.find(".btnReorder").removeClass("btn_save").find("span.txt").html(c["\uc21c\uc11c \ubc14\uafb8\uae30"]),this.$el.find(".btnCreate").show(),this.$el.find(".btnDelete").show(),this.$el.find("input:checkbox").parent("th").show(),this.$el.find("input:checkbox").parent("td").show(),this.$el.find("#tableList tbody").sortable("destroy")},changeSelect:function(){e("#changeSelect").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1)},createRule:function(){var t=this,n;t.deptId?n=new o({deptId:t.deptId}):n=new o;var r=e.goPopup({pclass:"layer_normal layer_auto",header:v["\uc790\ub3d9\ubd84\ub958"],modal:!0,width:380,contents:"",buttons:[{btext:l["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){n.validate()&&(n.createRule().done(function(){t.collection.fetch({reset:!0})}),e.close())}},{btext:l["\ucde8\uc18c"],btype:"cancel"}]});r.find(".content").html(n.render().el),r.reoffset()},updateRule:function(t){if(e(t.currentTarget).parents("tbody").hasClass("ui-sortable"))return;var n=e(t.currentTarget).attr("data-id"),r=this,i;r.deptId?i=new o({deptId:r.deptId,ruleId:n}):i=new o({ruleId:n});var s=e.goPopup({pclass:"layer_normal layer_auto",header:v["\uc790\ub3d9\ubd84\ub958"],modal:!0,width:380,contents:"",buttons:[{btext:l["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){i.validate()&&(i.createRule().done(function(){r.collection.fetch({reset:!0})}),e.close())}},{btext:l["\ucde8\uc18c"],btype:"cancel"}]});s.find(".content").html(i.render().el),s.reoffset()},deleteRule:function(){var t=this,n=[],i=this.columns,s=0;e("td.check :checkbox:checked").each(function(){n.push(e(this).val()),s++});if(s==0)return e.goMessage(c["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;var o=r.config("contextRoot")+"api/approval/classify/user/rule";this.deptId&&(o=r.config("contextRoot")+"api/approval/classify/dept/"+this.deptId+"/rule"),e.goConfirm(c["\ubb38\uc11c\ud568 \uc0ad\uc81c \uacbd\uace0 \ub0b4\uc6a9"],"",function(){if(n.length){var r=e.goPreloader();r.render(),e.ajax({url:o,contentType:"application/json",dataType:"json",data:JSON.stringify({ids:n}),type:"DELETE",success:function(n){r.release(),t.collection.fetch({reset:!0}),e.goMessage(l["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(t,n,i){var s=JSON.parse(t.responseText);e.goError(s.message),r.release()}})}})},checkAll:function(){e("#checkAll").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1)},release:function(){this.$el.off(),this.$el.empty()}});return m});