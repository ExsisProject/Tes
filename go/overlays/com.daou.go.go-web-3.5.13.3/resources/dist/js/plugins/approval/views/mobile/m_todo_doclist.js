define(["views/mobile/m_more_list","jquery","backbone","when","hogan","app","i18n!nls/commons","i18n!approval/nls/approval","i18n!admin/nls/admin","i18n!works/nls/works","approval/views/mobile/m_pagination","approval/views/mobile/m_doclist_item","approval/views/mobile/document/m_appr_form_select","approval/models/doclist_item","collections/paginated_collection","views/mobile/header_toolbar","views/layouts/m_action_bar_default","approval/views/mobile/base_approval","approval/views/mobile/document/m_action_document","hgn!approval/templates/mobile/m_doclist_empty","hgn!approval/templates/mobile/m_doclist_bulk_toolbar","hgn!approval/templates/mobile/m_doclist_item","jquery.go-validation","GO.util","jquery.go-preloader"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E){var S={approval:u["\uc804\uc790\uacb0\uc7ac"],"\uacb0\uc7ac \ub300\uae30 \ubb38\uc11c":u["\uacb0\uc7ac \ub300\uae30 \ubb38\uc11c"],move_to_home:o["\ud648\uc73c\ub85c \uc774\ub3d9"],"\uc77c\uad04\uacb0\uc7ac":u["\uc77c\uad04 \uacb0\uc7ac"],"\uc804\uccb4\uc120\ud0dd":o["\uc804\uccb4"]+o["\uc120\ud0dd"],"\uc804\uccb4\ud574\uc81c":o["\uc804\uccb4"]+a["\ud574\uc81c"],waitingMsg:f["\uc800\uc7a5\uc911 \uba54\uc138\uc9c0"],"\uc0c8\uacb0\uc7ac":u["\uc0c8\uacb0\uc7ac"],"\uc591\uc2dd\uc120\ud0dd":u["\uacb0\uc7ac\uc591\uc2dd \uc120\ud0dd"]},x=n.Model.extend({url:"/api/approval/apprconfig"}),T=n.Model.extend({url:"/api/approval/authBulkComplete"}),N=n.Model.extend({url:"/api/approval/usersetting/userconfig",getDefaultPhoto:function(){return"resources/images/stamp_approved.png"}}),C=d.extend({initialize:function(e){d.prototype.initialize.call(this,e),_.extend(this.options,e||{})},model:p,url:function(){return"/api/approval/todo/all?"}}),k=null,L=!1;return e.extend({el:"#content",events:{},authBulkComplete:!1,initialize:function(e){g.prototype.initialize.call(this),s.util.appLoading(!0),this.options=e||{},_.bindAll(this,"render","renderPages"),this.collection=new C;var t=this.collection.url().replace("/api/",""),n=s.router.getUrl();n.indexOf("?")<0?s.router.navigate(t,{replace:!0}):n!=t&&s.router.navigate(t,{trigger:!1,pushState:!0}),this.headerToolbarView=v,this.addEvent();var r={};this.setFetchInfo(r,this.collection)},addEvent:function(){s.EventEmitter.on("trigger-action","selectTodoCheckbox",this.selectTodoCheckbox,this),s.EventEmitter.on("trigger-action","dSelectTodoCheckbox",this.dSelectTodoCheckbox,this),s.EventEmitter.on("trigger-action","onBulkCompleteClicked",this.onBulkCompleteClicked,this),this.$el.off("change","#document_todo input"),this.$el.on("change","#document_todo input",t.proxy(this.setToolbarTitle,this)),this.$el.off("vclick","#document_todo input"),this.$el.on("vclick","#document_todo input",t.proxy(function(e){var n=t(e.currentTarget);n.is(":checked")?t("#document_todo input:checked").length==1&&this.headerToolbarView.checkBoxHeader(e):!t("#document_todo input:checked").length>0&&t("#checkedHeaderMenu").css("display")==="none"&&this.headerToolbarView.checkBoxHeader(e)},this))},setToolbarTitle:function(){var e=t('#document_todo input[name="todoCheck"]:checked').length,n=t('#document_todo input[name="todoCheck"]').length;n===e?(t("#allTodoSelect").hide(),t("#allTodoDeselect").show()):(t("#allTodoSelect").show(),t("#allTodoDeselect").hide())},getUseMenus:function(){var e=[],t={"\uc804\uccb4\uc120\ud0dd":{id:"allTodoSelect",text:S["\uc804\uccb4\uc120\ud0dd"],triggerFunc:"selectTodoCheckbox"},"\uc804\uccb4\ud574\uc81c":{id:"allTodoDeselect",text:S["\uc804\uccb4\ud574\uc81c"],style:"display:none",triggerFunc:"dSelectTodoCheckbox"},"\uc77c\uad04\uacb0\uc7ac":{id:"btnBulkComplete",text:S["\uc77c\uad04\uacb0\uc7ac"],triggerFunc:"onBulkCompleteClicked"}};return e.push(t.\uc804\uccb4\uc120\ud0dd),e.push(t.\uc804\uccb4\ud574\uc81c),this.authBulkComplete&&e.push(t.\uc77c\uad04\uacb0\uc7ac),e},renderPages:function(){this.$el.find("div.paging br_no").remove()},render:function(){var e=this;r(this.fetchConfig.call(this)).then(_.bind(this.isAuthBulkComplete,this)).then(_.bind(function(){this.toolBarData={title:S["\uacb0\uc7ac \ub300\uae30 \ubb38\uc11c"],isList:!0,isSideMenu:!0,isHome:!0,isSearch:!0,checkedActionMenu:this.getUseMenus(),checkedTargetEl:"#document_todo input",isWriteBtn:!0,writeBtnCallback:function(){var n={title:S["\uc591\uc2dd\uc120\ud0dd"],isClose:!0,closeCallback:function(){e.headerToolbarView.render(e.toolBarData),e.formSelectView.release(),e.onScrollEvent(),e.$el.find("#document_action").hide(),e.$el.find("#document_todo").show()}};e.formSelectView=new h({toolBarData:n}),e.formSelectView.release(),e.offScrollEvent(),e.$el.find("#document_todo").hide(),e.$el.find("#document_action").show(),e.dSelectTodoCheckbox(),t("#headerToolbar").removeClass("check_nav"),e.assign(e.formSelectView,"#document_action")}},this.headerToolbarView.render(this.toolBarData);var n={listFunc:t.proxy(function(e){this.renderList(e)},this),emptyListFunc:t.proxy(function(){this.$el.find("ul.list_box").append(b({lang:{doclist_empty:u["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}}))},this)};this.setRenderListFunc(n),s.util.appLoading(!1)},this)).then(_.bind(this.fetchCollection,this)).then(_.bind(function(){s.util.pageDone(),this.$el.html(E({ulWrapperId:"document_todo",otherClass:"list_box_approval",documentAction:!0})),this.dataFetch().done(t.proxy(function(e){e.length===0?this.renderListFunc.emptyListFunc():(this.renderListFunc.listFunc(e),this.scrollToEl())},this))},this)).otherwise(function(t){console.log(t.stack)}),s.util.appLoading(!1)},fetchConfig:function(){var e=this;return this.useHold=!0,this.config.fetch({success:function(t){e.useHold=t.get("useHold")}})},fetchCollection:function(){var e=r.defer();return this.collection.fetch({success:function(){e.resolve()},error:e.reject}),e.promise},selectTodoCheckbox:function(e){t("input[name=todoCheck]").prop("checked",!0),t("#allTodoSelect").hide(),t("#allTodoDeselect").show()},dSelectTodoCheckbox:function(e){t("input[name=todoCheck]").prop("checked",!1),t("#allTodoSelect").show(),t("#allTodoDeselect").hide()},isAuthBulkComplete:function(){var e=this,t=r.defer();return this.toolBarModel=new T,this.authBulkComplete=!0,this.toolBarModel.fetch({success:function(n){e.authBulkComplete=n.get("authBulkComplete"),t.resolve()},error:t.reject}),t.promise},onBulkCompleteClicked:function(e){var n=t("input[name=todoCheck]:checked"),r=this,i=[],a=[];if(n.length<1){alert(u["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var f=new N;f.fetch({success:function(e){var i=e.get("passwordUseFlag"),a={title:u["\uacb0\uc7ac\ud558\uae30"],rightButton:{text:u["\uacb0\uc7ac"],callback:function(){var e=t("#textarea-desc").val(),i=t("#apprPassword").val(),a=_.map(n,function(e){return parseInt(t(e).attr("data-id"))});r.bulkComplete(a,e,i).done(function(e,t,n){alert(s.i18n(u["{{arg1}}\uac1c\uc758 \uacb0\uc7ac\uac00 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],{arg1:e.data.length}))}).fail(function(e,t,n){e.responseJSON.name=="pwd.not.match"?alert(e.responseJSON.message):alert(o["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"])}).complete(function(){k.release(),L=!1,t("#headerToolbar").removeClass("check_nav"),s.router.navigate("/approval/todo/all",{trigger:!0})})}},cancelButton:{callback:t.proxy(function(){this.headerToolbarView.render(this.toolBarData),this.documentAction.release(),t("#document_action").hide(),t("#document_todo").show(),this.dSelectTodoCheckbox(),t("#headerToolbar").removeClass("check_nav")},r)}};r.documentAction=new y({toolBarData:a,isPassword:i,nextApproval:!1,useNextApproval:!1}),t("#document_todo").hide(),t("#document_action").show(),r.assign(r.documentAction,"#document_action")}})},bulkComplete:function(e,n,r){if(L){alert(S.waitingMsg);return}return k=t.goPreloader(),L=!0,t.ajax({url:s.contextRoot+"api/approval/document/bulkcomplete",type:"PUT",dataType:"json",contentType:"application/json",data:JSON.stringify({comment:n,password:r,docIds:e})})},assign:function(e,t){e.setElement(this.$(t)).render()},resetList:function(e){var t=this;this.$el.append(E({otherClass:"list_box_approval"})),this.$el.find("ul.list_box").removeClass("list_apprChk"),this.$el.find("ul.list_box").empty();var n="approval",r=this.useHold,i=this.authBulkComplete;e.each(function(s){var o=new c({model:s,listType:n,useHold:r,total:e.total,isCheckboxVisible:i});t.$el.find("ul.list_box").append(o.render().el)})},renderList:function(e){var t=this,n="approval",r=this.useHold,i=this.authBulkComplete;e.each(function(s){var o=new c({model:s,listType:n,useHold:r,total:e.total,isCheckboxVisible:i});t.$el.find("ul.list_box").append(o.render().el)})}},{__instance__:null,create:function(){return this.__instance__=new this.prototype.constructor({el:t("#content")}),this.__instance__},render:function(){var e=this.create(),t=arguments.length>0?Array.prototype.slice.call(arguments):[];return this.prototype.render.apply(e,t)}})});