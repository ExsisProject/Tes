(function(){define(["jquery","backbone","app","i18n!nls/commons","i18n!board/nls/board","hgn!approval/templates/document/post_regist","board/collections/dept_list","board/collections/board_list","board/collections/header_list","attach_file"],function(e,t,n,r,i,s,o,u,a,f){var l={all:r["\uc804\uccb4"],postTitle:r["\uc81c\ubaa9"],content:r["\ub0b4\uc6a9"],location:r["\uc704\uce58"],attach:r["\ucca8\ubd80\ud30c\uc77c"],head:i["\ub9d0\uba38\ub9ac"],selectHeader:i["\ub9d0\uba38\ub9ac \uc120\ud0dd"],board_list_null:i["\uc120\ud0dd\uac00\ub2a5\ud55c \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]},c=t.View.extend({initialize:function(e){this.departments=o.getDeptList({apiUrl:"/api/board/menu/target/owners"}),this.departments.options.retry&&_.each(this.departments.models,function(e){e.attributes.ownerId=e.attributes.id}),this.boards=u.init(),this.headers=a.init()},events:{"change #deptId":"fetchBoards","change #boardId":"fetchHeaders"},render:function(){var t=this.model.get("document").docBodyContent,n=e.goFormUtil.convertViewMode(t);this.$el.html(s({lang:l,model:this.model.toJSON(),content:n,hasAttach:this.model.get("document").attaches.length>0,hasHead:this.headers.length>0,headers:this.headers.toJSON()})),this.fetchDepts(),f.create("#attachArea",this.model.get("document").attaches,this.model.get("document").id,function(e,t){return GO.contextRoot+"api/approval/document/"+t+"/download/"+e.id})},fetchDepts:function(){var e=this;return this.departments.fetch({success:function(){e.renderDepartments(),e.fetchBoards()}})},fetchBoards:function(){var e=this,t=this.getCurrentDepartmentId(),n=this.departments.getDept(t),r=null;n.isCompany()?(this.boards.setDeptId(!1,null,"Company","classic"),r=this.boards.fetch()):(this.boards.setDeptId(!1,t,"Department","classic"),r=this.boards.fetch()),r.done(function(){e.renderBoards(),e.fetchHeaders()})},fetchHeaders:function(){var e=this,t=this.$("#boardId").val();this.headers.setBoardId(t),this.headers.fetch({success:function(){e.renderHeaders()}})},renderDepartments:function(){this.$("#deptId").empty();var e=Hogan.compile('<option value="{{ownerId}}">{{name}}</option>');_.each(this.departments.models,function(t){this.$("#deptId").append(e.render(t.toJSON()))},this)},renderBoards:function(){this.$("#boardId").empty();var e=Hogan.compile('<option value="{{id}}">{{name}}</option>'),t=this.boards.getWritableBoards();if(t.length==0){var n=Hogan.compile('<option value="">{{lang.board_list_null}}</option>'),r={lang:l};this.$("#boardId").append(n.render(r))}else _.each(t,function(t){this.$("#boardId").append(e.render(t.toJSON()))},this)},renderHeaders:function(){this.$("#headerId").find("option").not("option[value=default]").remove();var e=this.headers.models.length>0;this.$("#headerArea").toggle(e);if(!e)return;var t=Hogan.compile('<option value="{{id}}">{{name}}</option>');_.each(this.headers.models,function(e){this.$("#headerId").append(t.render(e.toJSON()))},this),this.$("#headerAsterisk").toggle(this.isHeaderRequired())},submit:function(){var t=this.$("#postTitle"),n=t.val();if(n.length>100||n.length<2)return e.goError(GO.i18n(r["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:2,arg2:100}),t,!1,!0),e.Deferred().reject();var s=this.getCurrentBoardId();if(_.isEmpty(s))return e.goError(i["\uac8c\uc2dc\ud310\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],this.$("#select_board"),!1,!0),e.Deferred().reject();var o=this.$("#headerId"),u=o.val();if(this.isHeaderRequired()&&u=="default")return e.goError(i["\ub9d0\uba38\ub9ac\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694."],o,!1,!0),e.Deferred().reject();var a=this.model.get("document").id,f={boardId:s,contentType:"HTML",notiFlag:!1,postId:"",status:"OPEN",stickable:!1,title:n,writeType:""};return u!="default"&&(f.headerId=u),e.ajax({type:"POST",url:GO.contextRoot+"api/approval/document/"+a+"/sendpost",dataType:"json",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",success:function(t){e.goMessage(i["\uac8c\uc2dc\uae00\uc774 \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},error:function(t){e.goAlert(t.responseJSON.message),console.log(t)}})},getCurrentDepartmentId:function(){return this.$("#deptId").val()},getCurrentBoardId:function(){return this.$("#boardId").val()},isHeaderRequired:function(){var e=this.getCurrentBoardId(),t=this.boards.getBoard(e);return t.isHeaderRequired()}});return c})}).call(this);