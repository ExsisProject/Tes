define(["backbone","approval/models/appr_activity_group","approval/collections/appr_activity_groups","approval/collections/activities","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s){var o={header:s["\uacb0\uc7ac \uc815\ubcf4"],save_as_my_line:s["\uac1c\uc778 \uacb0\uc7ac\uc120\uc73c\ub85c \uc800\uc7a5"],delete_as_my_line:s["\uac1c\uc778 \uacb0\uc7ac\uc120 \uc0ad\uc81c"],my_line_name:s["\uacb0\uc7ac\uc120 \uc774\ub984"],normal:s["\uc77c\ubc18"],my_lines:s["\ub098\uc758\uacb0\uc7ac\uc120"],draft:s["\uae30\uc548"],name:i["\uc774\ub984"],dept:s["\ubd80\uc11c"],line:s["\ub77c\uc778"],status:s["\uc0c1\ud0dc"],approval:s["\uacb0\uc7ac"],agreement:s["\ud569\uc758"],check:s["\ud655\uc778"],agreement_type:s["\ud569\uc758\ubc29\uc2dd"],agreement_linear:s["\uc21c\ucc28\ud569\uc758"],agreement_parallel:s["\ubcd1\ub82c\ud569\uc758"],activityType:s["\ud0c0\uc785"],add:i["\ucd94\uac00"],"delete":i["\uc0ad\uc81c"],confirm:i["\ud655\uc778"],cancel:i["\ucde8\uc18c"],add_activity:s["\ub4dc\ub798\uadf8\ud558\uc5ec \uacb0\uc7ac\uc120\uc744 \ucd94\uac00\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],msg_duplicate_activity:s["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."],msg_max_approval_count_exceed:s["\uacb0\uc7ac\uc790 \uc218\uac00 \ucd5c\ub300 \uacb0\uc7ac\uc790 \uc218\ub97c \ub118\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_selected:s["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_deletable_status_activity:s["\uc0ad\uc81c\ud560 \uc218 \uc5c6\ub294 \uc0c1\ud0dc\uc758 \uacb0\uc7ac\uc790 \uc785\ub2c8\ub2e4."],msg_not_deletable_assigned_activity:s["\uc9c0\uc815 \uacb0\uc7ac\uc790\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_save_success:i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],msg_not_addable_position:s["\uc644\ub8cc\ub41c \uacb0\uc7ac \uc55e\uc5d0 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_duplicated_my_line_title:s["\uc911\ubcf5\ub41c \uc774\ub984\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_maxCount:s["\uacb0\uc7ac\uc790\ub97c \ucd5c\ub300\uce58\ubcf4\ub2e4 \ub118\uac8c \ud560\ub2f9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_assigned_deleted:s["\ub098\uc758 \uacb0\uc7ac\uc120 \uc801\uc6a9 \ubd88\uac00 \uba54\uc138\uc9c0"],msg_my_line_set_error_not_matching_group_count:s["\uacb0\uc7ac\uc120\uc758 \uac2f\uc218\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],msg_parallel_agreement_should_has_2_more_agreement:s["\ubcd1\ub82c\ud569\uc758\ub294 \uc5f0\uc18d\ub41c \ub458 \uc774\uc0c1\uc758 \ud569\uc758\uac00 \ud544\uc694\ud569\ub2c8\ub2e4."],msg_not_belong_to_department_user:s["\ubd80\uc11c\uac00 \uc5c6\ub294 \uc0ac\uc6a9\uc790\ub294 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],notAddable:s["\uc774 \uacb0\uc7ac\uce78\uc5d0\ub294 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],not_allowed_apprline:s["\uc120\ud0dd\ud55c \ub300\uc0c1\uc740 \uc774 \uacb0\uc7ac\uadf8\ub8f9\uc5d0 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]},u=e.Model.extend({originGroups:null,assignedActivityDeletable:!1,initialize:function(e,t){t=t||{},_.isBoolean(t.assignedActivityDeletable)&&(this.assignedActivityDeletable=t.assignedActivityDeletable),_.isArray(t.original)&&(this.originGroups=new n(t.original)),_.isNull(this.originGroups)&&this.throwError('No "original" was set - required.'),_.isBoolean(t.includeAgreement)&&(this.includeAgreement=t.includeAgreement),this.apprAllowType=t.apprAllowType,this.actionCheck=t.actionCheck},makeData:function(e){var t=new n(e);return this._validateGroupCountMatching(t)||this.throwError(o.msg_my_line_set_error_not_matching_group_count),this.originGroups.each(function(e,n){var r=t.at(n);this._preValidateForGroupMerge(e,r)||this.throwError(o.msg_my_line_set_error_maxCount),this._preValidateActivityForGroupMerge(e,r)||this.throwError(o.not_allowed_apprline);var i=this._mergeNewGroupToOldGroup(e,r);this._postValidateForGroupMerge(e,i)||this.throwError(o.msg_my_line_set_error_assigned_deleted),e.set("activities",i.get("activities"))},this),this.originGroups.toJSON()},_validateGroupCountMatching:function(e){return this.originGroups.length==e.length},_preValidateForGroupMerge:function(e,t){return t.getApprovalAndDraftActivities().length>e.get("maxApprovalCount")?!1:this.includeAgreement&&t.getApprovalAndAgreementAndDraftActivities().length>e.get("maxApprovalCount")?!1:!0},_preValidateActivityForGroupMerge:function(e,t){var n=!0,i=new r(t.get("activities")),s=e.getAvailableApprovalType(this.actionCheck);return _.isUndefined(s)?(n=!1,n):(i.each(function(t){var r=t.get("userId")==null;_.contains(_.pluck(s,"type"),t.get("type"))?this.apprAllowType=="USER"&&r&&(n=!1):n=!1,t.get("type")=="AGREEMENT"&&(e.agreementAllowTypeValidate(this.actionCheck.agreementAllowType,r)||(n=!1))},this),n)},_mergeNewGroupToOldGroup:function(e,n){var i=new t,s=new r(n.get("activities")),o=new r(e.get("activities")),u=o.selectOnlyAssigned();return i.set("activities",[]),o.each(function(e){e.isDraft()&&i.addActivity(e.clone().toJSON())}),s.each(function(e){var t=e.clone().toJSON();u.isExistActivity(e)&&(t.assigned=!0),i.addActivity(t)}),i},_postValidateForGroupMerge:function(e,t){if(this.assignedActivityDeletable)return!0;var n=!0,i=new r(e.get("activities")),s=new r(t.get("activities")),o=i.selectOnlyAssigned();return o.each(function(e){s.isExistActivity(e)||(n=!1)}),n},throwError:function(e){var t=function(e){this.name="ActivityGroupsSetter",this.message=e};throw new t(e)}});return u});