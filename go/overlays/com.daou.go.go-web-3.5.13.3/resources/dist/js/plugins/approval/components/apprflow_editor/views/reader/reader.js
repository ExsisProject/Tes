define("approval/components/apprflow_editor/views/reader/reader",["approval/components/apprflow_editor/views/base_tab_item","hgn!approval/components/apprflow_editor/templates/tab/layout","text!approval/components/apprflow_editor/templates/tab/header_read.html","text!approval/components/apprflow_editor/templates/tab/footer_dept.html","approval/components/apprflow_editor/views/activity_list/activity_list","approval/components/apprflow_editor/views/activity_list/doc_reader_activity_group","approval/models/subscriber_group","i18n!nls/commons","i18n!approval/nls/approval","i18n!calendar/nls/calendar","jquery.go-orgtab"],function(e,t,n,r,i,s,o,u,a,f){function p(){this.$el.html(t({lang:l},{activityHeader:n,activityFooter:r}))}function d(){var e=new Backbone.Collection(this.model.docInfoModel.get("docReadingReaders"));this.activityGroupsView=new i({el:this.$el.find(".list_approval_line_wrap"),observer:this.observer}),this.activityGroupsView.addGroupView(new c({activities:e,disable:!this.editable(),observer:this.observer,receiveAllowType:"USER",tabId:this.getTabId(),actionCheck:this.model.get("actionCheck")})),this.listenTo(this.observer,"mySubscriberSelected",function(t){if(!this.isActivated())return;if(!y.call(this,t.nodes))return console.log("!validateSubscriber.call"),$.goError(a["\uc120\ud0dd\ud55c \uadf8\ub8f9\uc73c\ub85c \uc5f4\ub78c\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),this.observer.trigger("deselectSubscriber"),!1;var n=[];_.each(e.toJSON(),function(e){n.push(e.reader.id)}),_.each(t.nodes,function(t){if(!_.contains(n,t.nodeId)){var r={reader:{deptId:t.nodeDeptId,deptType:t.nodeType=="department"?!0:!1,deptName:t.nodeDeptName,id:t.nodeId,name:t.nodeValue.split(" ")[0],position:t.nodeValue.split(" ")[1]?t.nodeValue.split(" ")[1]:""}};e.add(new Backbone.Model(r))}})}),this.listenTo(e,"add remove reset",_.bind(function(t){var n;t instanceof Backbone.Collection?n=t:t instanceof Backbone.Model&&t.collection&&(n=t.collection),n&&(this.model.docInfoModel.set("docReadingReaders",n.toJSON()),this.model.set("docInfoChanged",!0),this.observer.trigger("changedTabItem",this.getTabId()))},this))}function v(e){var t={};return e&&e.type&&e.type.toLowerCase()==="org"?t={id:e.id,name:e.name,deptId:e.id,deptName:e.name,deptType:!0}:(t=_.pick(e,"id","name","position","deptId","deptName","thumbnail"),t.deptType=!1),t}function y(e){var t=[];return t=_.filter(e,function(e){return e.nodeType=="department"||String(e.actions)=="false"}),t.length<1}function b(){var e=!0;return _.each(this.activityGroupsView.groupViewList,function(t){t.collection.each(function(t){t.get("removable")||(e=!1)})},this),e}function w(e,t){if(this.model.docInfoModel.get("docReadingReaders").length==0)return $.goMessage(GO.i18n(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])),!1;var n=$("input#my_subscriber_title_input").val();if(_.isEmpty(n)||n.length>this._MAX_LENGTH_OF_MY_LINE_TITLE)return $.goMessage(GO.i18n(a["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"1",arg2:"20"})),!1;var r=new o({subscriber:{nodes:(new g(this.model.docInfoModel.get("docReadingReaders"))).toJSON()},title:n});r.save({},{success:$.proxy(function(n,r,i){$.goMessage(l.msg_save_success),this.observer.trigger("reloadMySubscriber"),e.close("",t)},this),error:function(e,t,n){$.goMessage(l.msg_duplicated_my_line_title)}})}function E(){return['<table class="table_form_mini"><form>',"<tbody><tr>","</tr><tr>",'    <th><span class="txt">'+a["\uadf8\ub8f9 \uc774\ub984"]+"</span></th>",'    <td><input id="my_subscriber_title_input" class="txt_mini w_max" type="text"></td>',"</tr>","</tbody></form></table>"].join("\n")}var l={name:u["\uc774\ub984"],department:a["\ubd80\uc11c"],remove:u["\uc0ad\uc81c"],readAt:"\ud655\uc778\uc2dc\uac04",saveMyASubscruber:a["\uac1c\uc778 \uadf8\ub8f9\uc73c\ub85c \uc800\uc7a5"],msg_duplicated_my_line_title:a["\uc911\ubcf5\ub41c \uc774\ub984\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_save_success:u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]},c=s.extend({initialize:function(e){e=e||{},_.isString(e.receiveAllowType)&&(this.receiveAllowType=e.receiveAllowType),this.options.includeReadAt=!0,this.hash={},_.each(e.activities.models,function(e){this.hash[e.get("reader").id]=!0},this),s.prototype.initialize.apply(this,arguments)},parseOrgTreeData:function(e){return e&&e.type&&e.type.toLowerCase()==="org"?!1:s.prototype.parseOrgTreeData.apply(this,arguments)},addReaders:function(e){var t=this,n,r={};if(!e)return;_.each(e,function(e){if(this.hash[e.id])return;n={reader:v(e)},this.hash[e.id]=!0,t.collection.add(n,r)},this),this.observer.trigger("resize")},addActivity:function(e,t){var n;if(e&&e.type==="company")return;var r={};if(e.type!="org"){n=this.parseOrgTreeData(e);if(!n)return;_.isNumber(t)&&this.collection.length>t&&(r.at=t,r.merge=!0),this.collection.add(n,r),this.observer.trigger("resize")}else this.addActivityByOrg(e)},addActivityByOrg:function(e){function s(t,n,r){r=r||!1;var i=GO.config("contextRoot")+"api/organization/user?deptid="+e.id+(r?"&scope=subdept":"");return $.ajax(i).done(_.bind(function(e){var n=[];_.each(e,function(e){n.push(e.metadata)},this),t.resolve(this.addReaders(n))},this)).fail(function(){console.log("error"),t.reject()})}var t=this,n="gopopup-orgtab",r=[];if($("#"+n).length>0)return;var i=$.Deferred();if(!e.subdept){s.call(t,i,e.id);return}$.goPopup({id:n,pclass:"layer_confim",allowPrevPopup:!0,title:a["\uc5f4\ub78c\uc790 \ucd94\uac00"],message:GO.i18n(a["\uc5f4\ub78c\uc790 \ucd94\uac00 \ud655\uc778 \uba54\uc2dc\uc9c0"],{dept:e.name}),modal:!0,buttons:[{btype:"confirm",btext:f["\ud604\uc7ac \ubd80\uc11c\uc6d0\ub9cc \ucd94\uac00"],callback:function(){s.call(t,i,e.id)}},{btype:"confirm",btext:f["\ud558\uc704 \ubd80\uc11c\uc6d0 \ubaa8\ub450 \ucd94\uac00"],callback:function(){s.call(t,i,e.id,!0)}},{btype:"close",btext:u["\ucde8\uc18c"]}]})}}),h=e.extend({className:"set_data wrap_approvalLine_set",tabId:"reader",tabName:a["\uc5f4\ub78c\uc790"],activityGroupsView:null,viewerType:"",initialize:function(t){e.prototype.initialize.apply(this,arguments),t=t||{},t.observer&&t.observer.hasOwnProperty("bind")?this.observer=t.observer:this.observer=_.extend({},Backbone.Events),this.viewerType="",t.hasOwnProperty("viewerType")&&(this.viewerType=t.viewerType),p.call(this),d.call(this)},events:{"click .save-mysubscriber-btn":"_saveAsPeronalSubscriber"},render:function(){this.activityGroupsView.render()},remove:function(){this.activityGroupView.remove(),e.prototype.remove.apply(this,arguments)},editable:function(){return this.viewerType==="docmaster"||this.viewerType==="formadmin"||this.viewerType==="officialdocmaster"||this.model.Permission.canEditReaderList()},usable:function(){return this.model.Permission.canUseReaderList()},activate:function(){e.prototype.activate.apply(this,arguments),this.activityGroupsView.activate()},_saveAsPeronalSubscriber:function(e){var t="gopopup-personalsubscriber";e.preventDefault();if($("#"+t).length>0)return;if(!this.editable())return;if(this.model.docInfoModel.get("docReadingReaders").length==0)return $.goMessage(GO.i18n(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])),!1;var n=$.goPopup({id:t,allowPrevPopup:!0,pclass:"layer_normal",header:a["\uac1c\uc778 \uadf8\ub8f9\uc73c\ub85c \uc800\uc7a5"],modal:!0,width:300,contents:E(),buttons:[{btext:u["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:_.bind(w,this)},{btext:u["\ucde8\uc18c"],btype:"cancel"}]});$("input#my_subscriber_title_input").keypress(_.bind(function(e){if(e.which==13)return w.call(this,n,e),!1},this))},deactivate:function(){e.prototype.deactivate.apply(this,arguments),this.activityGroupsView.deactivate()}}),m=Backbone.Model.extend({defaults:{nodeId:0,nodeDeptId:"",nodeCompanyId:null,nodeCompanyName:null,nodeType:"user",nodeValue:"",actions:"",members:[]},initialize:function(){this.convert(this.get("reader"))},convert:function(e){this.set("nodeId",e.id),this.set("nodeDeptId",e.deptId),this.set("nodeValue",e.name),this.set("nodeType",e["deptType"]==0?"user":"department")}}),g=Backbone.Collection.extend({model:m});return h});