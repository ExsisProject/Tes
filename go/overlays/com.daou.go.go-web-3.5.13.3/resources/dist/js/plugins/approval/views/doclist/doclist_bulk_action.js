define(["jquery","underscore","backbone","app","i18n!nls/commons","i18n!admin/nls/admin","i18n!approval/nls/approval","jquery.go-orgslide"],function(e,t,n,r,i,s,o){var u=n.Model.extend({initialize:function(e){this.docId=e},url:function(){return"/api/approval/manage/document/addreaders"}}),a=n.Model.extend({url:"/api/approval/auth/docmanage",isDocDeletable:function(){return this.get("docDeletable")},isMultiCompanySupporting:function(){return this.get("multiCompanySupporting")}});return n.View.extend({initialize:function(e){this.$appendTarget=e.appendTarget,this.getSelectedDocs=e.getSelectedDocs,this.resetList=e.resetList,this.authModel=new a},render:function(){this.authModel.fetch().done(e.proxy(this._renderButtons,this))},_renderButtons:function(){var n=[{id:"bulkReaderAdd",label:o["\uc5f4\ub78c\uc790 \ucd94\uac00"],"class":"member",onClicked:e.proxy(this._onReaderAddClicked,this)}];this.authModel.isDocDeletable()&&n.push({id:"bulkDocDelete",label:i["\uc77c\uad04 \uc0ad\uc81c"],"class":"del",onClicked:e.proxy(this._onDocDeleteClicked,this)});var r=[];r.push("{{#buttons}}"),r.push('<a id="{{id}}" class="btn_tool" data-role="button">'),r.push('  <span class="ic_toolbar {{class}}"></span> <span class="txt">{{label}}</span>'),r.push("</a>"),r.push("{{/buttons}}"),this.$appendTarget.after(Hogan.compile(r.join("")).render({buttons:n})),t.each(n,function(t){e("#"+t.id).bind("click",t.onClicked)})},_onReaderAddClicked:function(){var t=this.getSelectedDocs(),n=this._selectReaderAddable(t);if(!this._validateReaderAdd(t,n))return;if(t.length!=n.length){e.goConfirm(o["\uc644\ub8cc\ub41c \ubb38\uc11c\uc5d0\ub9cc \uc5f4\ub78c\uc790 \ucd94\uac00?"],"",e.proxy(this._showReaderAddOrgSlide,this,n));return}this._showReaderAddOrgSlide(n)},_selectReaderAddable:function(e){return t.select(e,function(e){return e.isCompleted()})},_validateReaderAdd:function(t,n){if(n.length<1){var r=o["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."];return t.length>0&&(r=o["\uc120\ud0dd\ub41c \ub300\uc0c1\uc5d0 \uc644\ub8cc\ub41c \ubb38\uc11c\uac00 \uc5c6\uc74c"]),e.goMessage(r),!1}return!0},_showReaderAddOrgSlide:function(n){var s=t.map(n,function(e){return e.get("id")});e.goOrgSlide({header:o["\uc5f4\ub78c\uc790 \ucd94\uac00"],contextRoot:r.config("contextRoot"),callback:e.proxy(this._addReaders,this,s),memberTypeLabel:o["\uc5f4\ub78c\uc790"],externalLang:i,isBatchAdd:!0,useTag:!0,type:"node",multiCompanyVisible:this.authModel.isMultiCompanySupporting()})},_addReaders:function(n,r){var s=t.map(r,function(e){return{reader:e}}),a=new u;if(t.isEmpty(s)){e.goError(o["\uc5f4\ub78c\uc790\ub97c \ucd94\uac00\ud574 \uc8fc\uc138\uc694."]);return}a.set({docIds:n,readers:s}),a.save(null,{type:"POST",success:function(t,n){n.code=="200"&&(e(".list_approval input[type=checkbox][data-id]").prop("checked",!1),e.goMessage(o["\uc5f4\ub78c\uc790 \ucd94\uac00\uac00 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]))},error:function(t,n){e.goMessage(i["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})},_onDocDeleteClicked:function(){var t=this.getSelectedDocs(),n=this._selectDeletable(t);if(t.length==0){e.goAlert(o["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}if(t.length>0&&n.length==0){e.goAlert(o["\uc120\ud0dd\ud55c \ubb38\uc11c \uc911\uc5d0 \uc0ad\uc81c \uac00\ub2a5\ud55c \ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]);return}e.goConfirm(o["\ubc18\ub824 / \ubc18\uc1a1 \ubc0f \uc644\ub8cc \uc0c1\ud0dc\uc758 \ubb38\uc11c\ub9cc \uc0ad\uc81c\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],"",e.proxy(this._deleteDocs,this,n))},_selectDeletable:function(e){return t.select(e,function(e){return e.isCompleted()&&!e.get("hasNotReturnedReceive")&&!e.get("useIntegration")||e.isReturn()||e.isRecvReturned()})},_deleteDocs:function(n){var s=r.contextRoot+"api/approval/manage/document/delete",u=t.map(n,function(e){return e.get("id")}),a=JSON.stringify({ids:u}),f=this,l=e.ajax({contentType:"application/json",dataType:"json",type:"DELETE",url:s,data:a});l.done(function(t){var n=t.data.ids.length,i=u.length;if(n==0)e.goAlert(o["\uc120\ud0dd\ud55c \ubb38\uc11c\uc758 \uc0ad\uc81c \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]);else if(n!=i){var s=r.i18n(o["{{arg1}}\uac1c\uc758 \ubb38\uc11c\uac00 \uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],{arg1:n}),a=r.i18n(o["\uc0ad\uc81c \uc548\ub41c {{arg1}}\uac1c\uc758 \ubb38\uc11c \uad8c\ud55c \uc548\ub0b4"],{arg1:i-n});e.goAlert(s,a)}else e.goAlert(o["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]);f.resetList()}),l.fail(function(n,r,s){var o=JSON.parse(n.responseText);!t.isUndefined(o)&&o.message?e.goAlert(o.message):e.goAlert(i["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"])})}})});