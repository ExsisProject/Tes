define(["jquery","underscore","backbone","app","when","approval/views/side","hgn!approval/templates/docfolder_share","i18n!nls/commons","i18n!approval/nls/approval","i18n!admin/nls/admin","jquery.go-orgslide"],function(e,t,n,r,i,s,o,u,a,f){var l={"\ud558\uc704 \ubd80\uc11c \ud3ec\ud568":f["\ud558\uc704 \ubd80\uc11c \ud3ec\ud568"],"\uc0ad\uc81c":u["\uc0ad\uc81c"],"\ud3f4\ub354\uba85":u["\ud3f4\ub354\uba85"],"\uacf5\uc720 \ub300\uc0c1":a["\uacf5\uc720 \ub300\uc0c1"],"\uacf5\uc720 \ucd94\uac00":a["\uacf5\uc720 \ucd94\uac00"]},c=['<span class="user_info">','<span class="name">{{data.name}}</span>','<span class="bar"> / </span>','<span class="position">{{data.position}}</span>','<span class="bar"> / </span>','<span class="email">{{data.email}}</span>','<span class="btn_wrap btn_del" title="{{lang.\uc0ad\uc81c}}"><span class="ic_classic ic_del"></span></span>'].join(""),h=['<span class="user_info">','<span class="name">{{data.name}}</span>','<span class="bar"> / </span>','( <input type="checkbox" name="include_sub_dept" {{#data.includeSubDept}}checked="checked"{{/data.includeSubDept}}><label for="">{{lang.\ud558\uc704 \ubd80\uc11c \ud3ec\ud568}}</label> )','<span class="btn_wrap btn_del" title="{{lang.\uc0ad\uc81c}}"><span class="ic_classic ic_del"></span></span>'].join(""),p=n.Model.extend({}),d=n.Collection.extend({model:p,initialize:function(e){this.folderId=e.folderId,this.folderType=e.folderType},url:function(){return this.folderType=="user"?r.contextRoot+"api/approval/userfolder/share/"+this.folderId:r.contextRoot+"api/approval/deptfolder/share/"+this.folderId}}),v=n.Model.extend({initialize:function(e){this.set("folderType",e.folderType),this.set("docFolderId",e.folderId)},url:function(){return this.get("folderType")=="user"?r.contextRoot+"api/approval/userfolder/share/":r.contextRoot+"api/approval/deptfolder/share/"}}),m=n.View.extend({initialize:function(e){this.type=e.type,this.model=e.model,this.$el.data("instance",this)},tagName:"li",events:{"click .ic_del":"deleteItem",'change input[name="include_sub_dept"]':"changeIncludeSubDept"},changeIncludeSubDept:function(t){this.model.set("includeSubDept",e(t.currentTarget).is(":checked"))},deleteItem:function(e){this.remove()},render:function(){return this.type=="user"?this.$el.html(Hogan.compile(c).render({data:{position:this.model.get("targetUserPosition"),name:this.model.get("targetUserName"),email:this.model.get("targetUserEmail")},lang:l})):this.$el.html(Hogan.compile(h).render({data:{name:this.model.get("targetDeptName"),includeSubDept:this.model.get("includeSubDept")},lang:l})),this}}),g=n.View.extend({initialize:function(e){this.options=e||{},this.popupEl=this.options.popupEl,this.folderType=this.options.folderType,this.folderType=="dept"&&(this.deptId=this.options.deptId),this.folderId=this.options.folderId,this.folderName=this.options.folderName,this.collection=new d({folderId:this.folderId,folderType:this.folderType}),this.on("docFolderSave",t.bind(this.docFolderSave,this))},orgSlide:null,el:".layer_folder_share .content",events:{"click #btnAddShare":"callOrgSlide","click .btn_del":"deleteShare"},fetchData:function(){var e=this,t=this.folderType,n=i.defer();return this.collection.fetch({data:{folderType:t},success:n.resolve,error:n.reject}),n.promise},render:function(){var e=this;i(this.fetchData()).then(function(){e.$el.html(o({lang:l,folderName:e.folderName})),e.renderList(),e.popupEl.reoffset()}).otherwise(function(t){console.log(t.stack)})},renderList:function(){this.collection.each(function(e){var n=t.isUndefined(e.get("targetUserId"))?"dept":"user";this.addShare(n,e)},this)},callOrgSlide:function(t){t.preventDefault();var n=this;this.orgSlide=e.goOrgSlide({type:"node",autoClose:!1,contextRoot:r.contextRoot,useApprReference:!0,useDisableNodeStyle:!0,callback:e.proxy(function(e){this.onAddShare(e)},this)})},onAddShare:function(t){var n=t.type!="org"?"user":"dept",r=new p;n=="user"?r.set({targetUserId:t.id,targetUserPosition:t.position,targetUserName:t.name,targetUserEmail:t.email}):r.set({targetDeptId:t.id,targetDeptName:t.name,includeSubDept:!1});if(n=="dept"&&!t.useReference)return e.goError(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc744 \ucd94\uac00 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;var i=this.validate(n,r);if(!i)return e.goError(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc744 \ucd94\uac00 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;this.addShare(n,r)},validate:function(e,t){var n=this.validateDupl(e,t);if(e=="user"&&this.folderType=="user"){if(r.session("id")==t.get("targetUserId"))return!1}else if(e=="dept"&&this.folderType=="dept"&&this.deptId==t.get("targetDeptId"))return!1;return n?!1:!0},validateDupl:function(e,n){var r,i={};return e=="user"?i=t.findWhere(this.getData(),{targetUserId:n.get("targetUserId")}):i=t.findWhere(this.getData(),{targetDeptId:n.get("targetDeptId")}),r=i?!0:!1,r},addShare:function(e,t){var n=new m({type:e,model:t});this.$el.find("#share_list_wrap").append(n.render().$el)},getData:function(){var n=[],r=this.folderId,i=this.folderType;return t.each(this.$el.find("#share_list_wrap li"),function(t){var s=e(t).data("instance");s.type=="user"?n.push({docFolderId:r,folderType:i,targetUserId:s.model.get("targetUserId")}):n.push({docFolderId:r,folderType:i,targetDeptId:s.model.get("targetDeptId"),includeSubDept:s.model.get("includeSubDept")})},this),n},docFolderSave:function(){var t=this,n=new v({folderType:this.folderType,folderId:this.folderId});n.set("targets",this.getData()),n.save({},{type:"PUT"}).done(function(){e.goMessage(u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.trigger("successDocFolderSave",n.get("targets").length),s.reload(!0)}).fail(function(){e.goError(u["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])})}});return g});