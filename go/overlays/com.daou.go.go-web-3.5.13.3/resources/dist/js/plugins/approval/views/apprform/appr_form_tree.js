(function(){define(["jquery","backbone","app","i18n!nls/commons","i18n!approval/nls/approval","i18n!admin/nls/admin","jquery.go-sdk","jquery.jstree"],function(e,t,n,r,i,s){var o,u,a;return o={folder_name:s["\ud3f4\ub354\uba85"],select_folder:s["\ud3f4\ub354\ub97c \uc120\ud0dd\ud574 \uc8fc\uc2ed\uc2dc\uc624."],cannot_update:s["\ucd5c\uc0c1\uc704 \ud3f4\ub354\ub97c \uc218\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete:s["\uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete_root:r["\ucd5c\uc0c1\uc704 \ud3f4\ub354\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],cannot_delete_parent:s["\uc591\uc2dd\uc774 \uc788\uac70\ub098 \ud558\uc704 \ud3f4\ub354\uac00 \uc788\ub294 \uacbd\uc6b0\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],folder_add:s["\ud3f4\ub354 \ucd94\uac00"],folder_modify:r["\uc218\uc815"],folder_delete:r["\uc0ad\uc81c"],folder_delete_message:s["\ud3f4\ub354 \uc0ad\uc81c"],folder_delete_confirm:s["\ud3f4\ub354\ub97c \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],selected_folder:s["\uc120\ud0dd\ub41c \ud3f4\ub354"],save_success:r["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],already_used_name:s["\uc774\ubbf8 \uc0ac\uc6a9\uc911\uc778 \uc774\ub984\uc785\ub2c8\ub2e4."],move_success:i["{{arg1}}\uc591\uc2dd\uc774 {{arg2}} \ud3f4\ub354\ub85c \uc774\ub3d9\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],move_fail:s["\uc774\ub3d9\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."],cannot_search:r["\ud574\ub2f9 \uac80\uc0c9 \uacb0\uacfc\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]},u=function(e){this.message=e,this.name="FormTreeException"},a=t.View.extend({treeElement:null,treeElementId:null,apiCommonUrl:null,isAdmin:!1,keyword:"",initialize:function(e){this.options=e||{},_.isString(this.options.keyword)&&(this.keyword=this.options.keyword),_.isString(this.options.treeElementId)&&(this.treeElementId=this.options.treeElementId),_.isFunction(this.options.selectCallback)&&(this.selectCallback=this.options.selectCallback),_.isFunction(this.options.renameCallback)&&(this.renameCallback=this.options.renameCallback),_.isBoolean(this.options.isAdmin)&&(this.isAdmin=this.options.isAdmin);if(_.isNull(this.treeElementId))throw new u("\uc635\uc158:treeElementId\uc774 \ud544\uc694\ud569\ub2c8\ub2e4.")},selectCallback:function(){console.log("\uc544\ubb34\ub7f0 selectCallback\ub3c4 \uc9c0\uc815\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4.")},renameCallback:function(){console.log("\uc544\ubb34\ub7f0 renameCallback\ub3c4  \uc9c0\uc815\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4.")},getSelectedNodeData:function(e){e=e||this._getTreeElement().jstree("get_selected");if(!e||e.length==0||!e.data())return{};var t=_.extend(e.data(),{el:e,folderName:this._getTreeElement().jstree("get_text"),type:e.find("a:eq(0)").attr("rel"),hasChildren:e.find("ul").length>0});return t},renderNewFolderInput:function(e){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData().el;this._getTreeElement().jstree("create",t,"last",{data:e||o.folder_name})},renderRenameFolderInput:function(){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData();if(!t.id)return e.goMessage(o.select_folder),!1;if(t["type"]=="ROOT")return e.goMessage(o.cannot_update),!1;this._getTreeElement().jstree("rename"),this._getTreeElement().find(".jstree-clicked").css({background:"transparent",border:0}),this._getTreeElement().find("input.jstree-rename-input").css({left:"20px",top:"2px"})},deleteSelectedFolder:function(){if(!this.isAdmin)return!1;var t=this.getSelectedNodeData();console.log(t);if(!t.id)return e.goMessage(o.select_folder),!1;if(t["type"]=="ROOT")return e.goMessage(o.cannot_delete_root),!1;if(t.hasChildren)return e.goMessage(o.cannot_delete_parent),!1;e.goCaution(o.folder_delete_message,o.folder_delete_confirm,e.proxy(function(){this._getTreeElement().jstree("remove")},this))},render:function(){var t=this,n=t._getCommonUrl();this.keyword!==""&&(n=n+"?"+e.param({keyword:this.keyword})),this.treeElement=this._getTreeElement().jstree({plugins:["themes","json_data","crrm","ui","cookies","types","dnd"],core:{animation:120},json_data:{ajax:{url:n,data:function(e){var n=null;return typeof e.data=="function"&&(n=e.data()),{folderId:n?n.id:t.loadId}},cache:!0,async:!1,success:function(n){if(_.isEmpty(n)){e("#"+t.treeElementId).append(o.cannot_search);return}e.each(n,function(e,t){t.metadata&&t.metadata.folderState=="HIDDEN"&&(t.data.attr.nodeState="DISABLE")})}}},core:{animation:120},"defaults ":{html_titles:!1,move_node:!1,ccp:!0,width:200},ui:{select_multiple_modifier:!1,select_limit:1},types:{max_depth:10,max_children:10,valid_children:["root"],start_drag:!1,move_node:!1,start_drag:!1,move_node:!1,delete_node:!1,remove:!1,types:{"default":{start_drag:t.isAdmin?!0:!1,move_node:t.isAdmin?!0:!1,delete_node:t.isAdmin?!0:!1},root:{valid_children:t._getValidChildrenOfFolder(),start_drag:!1,move_node:!1,delete_node:!1,remove:!1},form:{valid_children:["none"],start_drag:!1,move_node:!1,delete_node:!1,remove:!1},normal:{max_depth:10,max_children:10,valid_children:t._getValidChildrenOfFolder(),start_drag:!1,move_node:!1,delete_node:!1,remove:!1}}}}).bind("loaded.jstree",e.proxy(t._onLoaded,t)).bind("load_node.jstree",e.proxy(t._onLoadNode,t)).bind("select_node.jstree",e.proxy(t._onSelectNode,t)),this.isAdmin&&this.treeElement.bind("create.jstree",e.proxy(t._onJstreeCreate,t)).bind("rename.jstree",e.proxy(t._onJstreeRename,t)).bind("move_node.jstree",e.proxy(t._onJstreeMove,t)).bind("remove.jstree",e.proxy(t._onJstreeRemove,t))},getDroppable:function(){var t="li a[rel=FOLDER],li a[rel=ROOT]",r,i,s;return r=function(e){return{id:e.find("td.title > a").attr("data-id"),name:e.find("td.title > a").text()}},s=e.proxy(this.getSelectedNodeData,this),i=function(e){return{id:e.attr("nodeid"),name:e.text()}},{selector:t,overCallback:function(t,n){var o=r(t),u=i(n),a=s(),f=e.Deferred();return a["id"]==u["id"]?f.reject():(n.addClass("jstree-hovered"),f.resolve()),f},outCallback:function(n,r){var i=e.Deferred();return e(t).removeClass("jstree-hovered"),i.resolve(),i},dropCallback:function(u,a){e(t).removeClass("jstree-hovered");var f=r(u),l=i(a),c=s();if(c["id"]==l["id"])return!1;var h=GO.contextRoot+"ad/api/approval/apprform/"+f.id+"/move",p=JSON.stringify({id:f.id,folder:{id:l.id},seq:0}),d=e.ajax({type:"PUT",async:!0,url:h,data:p,contentType:"application/json",dataType:"json"});return d.done(function(t){e.goMessage(n.i18n(o.move_success,{arg1:f.name,arg2:l.name}))}),d.fail(function(t,n,r){e.goMessage(o.move_fail)}),d}}},_getTreeElement:function(){return e("#"+this.treeElementId)},_getCommonUrl:function(){return this.isAdmin?GO.contextRoot+"ad/api/approval/formfolder":GO.contextRoot+"api/approval/apprform/tree"},_getValidChildrenOfFolder:function(){var e=["FOLDER"];return this.isAdmin||e.push("FORM"),e},_onLoaded:function(){e.cookie("jstree_open")||(this.treeElement.find('a[rel="ROOT"]').trigger("click"),this.treeElement.jstree("open_node",this._getTreeElement().find("li:eq(0)")))},_onLoadNode:function(e,t,n){this.treeElement.find('a[href="#"]').attr("data-bypass",1),this.treeElement.find('a[rel="form"] > ins').addClass("appr_form")},_onSelectNode:function(t,n){if(this._isForm(this.getSelectedNodeData().type)){var r=e(n.rslt.obj[0]),i=r.parents("li:eq(0)");this.treeElement.jstree("select_node",i,!0);var s=this.getSelectedNodeData(i);s&&_.isFunction(this.selectCallback)&&this.selectCallback(s)}else{var s=this.getSelectedNodeData(e(n.rslt.obj[0]));s&&_.isFunction(this.selectCallback)&&this.selectCallback(s)}},_isForm:function(e){return e==="form"},_onJstreeCreate:function(t,n){var r=this,i=this.getSelectedNodeData().el,s=n.rslt,u={name:e.trim(s.name),parentId:this.getSelectedNodeData().id,seq:s.position};if(u.name==o["folder_name"]||u.name=="")return this._getTreeElement().jstree("refresh",i),!1;e.go(this._getCommonUrl(),JSON.stringify(u),{contentType:"application/json",responseFn:function(e){r._getTreeElement().jstree("refresh",i)}})},_onJstreeRename:function(t,n){var r=this;this._getTreeElement().find(".jstree-clicked").removeAttr("style");var i=n.rslt,s=e(n.rslt.obj[0]).data(),u=JSON.stringify({id:s.id,name:i.new_name});if(!i.new_name)return!1;if(i.new_name==i.old_name)return!1;e.go(this._getCommonUrl()+"/"+s.id,u,{qryType:"PUT",contentType:"application/json",responseFn:function(e){_.isFunction(r.renameCallback)&&r.renameCallback(i.new_name),this._getTreeElement().find(".go_alert").html("")},error:function(t){n.rlbk&&e.jstree.rollback(rlbk),this._getTreeElement().find(".go_alert").html(o.already_used_name)}})},_getSeq:function(e,t){var n=e.filter("[rel=ROOT]").length>0;if(!n)return 0;var r=t.rslt.o.index(),i=t.inst._get_children(t.inst._get_parent());return i!=undefined&&(i=i.filter("[rel=form]").length),r-i},_onJstreeMove:function(t,n){var r=this,i=n.inst._get_parent(n.rslt.o),s=n.rslt.o.data("id"),o={parentId:i.data("id"),seq:this._getSeq(i,n)};e.go(this._getCommonUrl()+"/"+s+"/move",JSON.stringify(o),{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200?r.render():e.jstree.rollback(n.rlbk)}})},_onJstreeRemove:function(t,n){var r=e(n.rslt.obj[0]);e.go(this._getCommonUrl()+"/"+r.data().id,{},{qryType:"DELETE",contentType:"application/json",success:e.proxy(function(e){var t=r.parents("li:eq(0)");this._getTreeElement().jstree("select_node",t)},this),error:e.proxy(function(t){n.rlbk&&e.jstree.rollback(n.rlbk),this._getTreeElement().find(".go_alert").html(o.cannot_delete)},this)})}}),a})}).call(this);