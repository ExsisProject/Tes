(function(){define(["jquery","underscore","backbone","app","approval/views/content_top","approval/views/document/document_print","hgn!approval/templates/document/actcopy","hgn!approval/templates/document/actcopy_document","hgn!approval/templates/add_org_member","i18n!nls/commons","i18n!approval/nls/approval","jquery.jstree","jquery.go-popup","jquery.go-orgslide","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f,l){var c={"\ubc1c\uc1a1":l["\ubc1c\uc1a1"],"\ucde8\uc18c":f["\ucde8\uc18c"],"\ubaa9\ub85d":f["\ubaa9\ub85d"],"\uac80\uc0c9":f["\uac80\uc0c9"],"\uc778\uc1c4":f["\uc778\uc1c4"],"\uc218\uc2e0\ucc98":l["\uc218\uc2e0\ucc98"],"\uc218\uc2e0\ucc98 \ucd94\uac00":l["\uc218\uc2e0\ucc98 \ucd94\uac00"],"\ubb38\uc11c\uc815\ubcf4":l["\ubb38\uc11c\uc815\ubcf4"],"\uc2dc\ud589\ubb38 \ubc1c\uc1a1":l["\uc2dc\ud589\ubb38 \ubc1c\uc1a1"],"\ubc1c\uc2e0\uc790":l["\ubc1c\uc2e0\uc790"],"\uc2dc\ud589\ubb38 \uc81c\ubaa9":l["\uc2dc\ud589\ubb38 \uc81c\ubaa9"],"\uc218\uc2e0\ucc98\ub97c \uc9c0\uc815\ud574\uc8fc\uc138\uc694":l["\uc218\uc2e0\ucc98\ub97c \uc9c0\uc815\ud574\uc8fc\uc138\uc694"],"\ubb38\uc11c\uc5f4\ub78c":l["\ubb38\uc11c\uc5f4\ub78c"],"\uc5f4\ub78c\uc790 \ucd94\uac00":l["\uc5f4\ub78c\uc790 \ucd94\uac00"],"\ubb38\uc11c\uc5f4\ub78c \uc800\uc7a5":l["\ubb38\uc11c\uc5f4\ub78c \uc800\uc7a5"]},h=n.Model.extend({initialize:function(e){this.options=e||{}},url:function(){return"/api/approval/document/"+this.docId+"/actcopy/"+this.actCopyFormId},getYear:function(){var e=this.attributes.preserveDurationInYear;return e==0?l["\uc601\uad6c"]:r.i18n(CommonLang["{{arg1}}\ub144"],{arg1:e})},setId:function(e){this.docId=e.docId,this.actCopyFormId=e.actCopyFormId}}),p=n.View.extend({el:".report_detail",initialize:function(e){this.model,this.apprFlow,this.docId=e.docId,this.actCopyFormId=e.actCopyFormId,this.infoModel=e.infoModel,this.contentTop=i.getInstance(),this.apprFlow=e.apprFlow},events:{"click a.btnSend":"actSend","click a.btnCancel":"actCancel","click a.btnList":"actList","click a.btnPrint":"actPrint","click span#addAddress":"addAddress","click span.ic_del":"deleteItem"},render:function(t){this.model=new h,this.model.setId({docId:this.docId,actCopyFormId:this.actCopyFormId}),this.model.fetch({async:!1});var n=this.model.attributes.document,r=this.apprFlow.activityGroups,i=n.orgDocBodyContent,s=n.docBodyContent;this.orgContentEl=e(i);var u=e(s);u.setApprovalContent(e(i).getApprovalContent()),this.docStatus=n.docStatus;var a=o({dataset:n,content:u.html(),infoData:this.model.attributes.docInfo,action:{isActCopy:!1},sender:this.getSender(r),lang:c,isActivityUser:!1});this.$el.html(a),e("#addressList").hide(),this.setActDocument(),this.options.isPopup?this.$el.find("header.content_top").remove():(this.title=l["\uc2dc\ud589\ubb38 \uc804\ud658 \ubc0f \ubc1c\uc1a1"]+" > "+this.model.get("document").formName,this.contentTop.setTitle(this.title),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el))},setActDocument:function(){var t=e(".approval_import"),n={docNo:this.orgContentEl.getDocNo(),recipient:this.orgContentEl.getRecipient(),preserveDuration:this.orgContentEl.getPreserveDuration(),securityLevel:this.orgContentEl.getSecurityLevel(),docClassification:this.orgContentEl.getDocClassification(),docReference:this.orgContentEl.getDocReference()};t.setApprovalData(n),t.setApprovalSubject(this.orgContentEl.getApprovalSubject())},getSender:function(t){var n=[];return e.each(t,function(t,r){e.each(r.activities,function(e,t){t.type=="DRAFT"&&n.push({deptId:t.deptId,deptName:t.deptName,userId:t.userId,userName:t.userName,userPosition:t.userPosition})})}),n},addAddress:function(t){var n=this,r=e.goPopup({pclass:"layer_normal",header:l["\uc218\uc2e0\ucc98 \ucd94\uac00"],modal:!0,width:300,contents:'<div id="orgtab" class="content_tab_wrap"></div>',buttons:[{btext:l["\ucd94\uac00"],btype:"confirm",autoclose:!1,callback:function(e){n.addReceive(e)}},{btext:f["\ub2eb\uae30"],btype:"cancel"}]});this.orgTab=e.goOrgTab({elId:"orgtab",css:{minHeight:310,maxHeight:310,"overflow-y":"auto"}}),r.reoffset()},addReceive:function(t){var n=this.orgTab.getSelectedData(),r=e("#addressNameTag"),i=n.type==="org"?"true":"false";n&&i=="false"&&GO.session("id")===n.id?e.goError(l["\ubc1c\uc2e0\uc790\ub294 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]):n&&!r.find('li[data-id="'+n.id+'"][data-deptType="'+i+'"]').length?(r.find("li.creat").before(a(e.extend(n,{lang:c,deptType:i}))),this.setRecipient()):e.goMessage(l["\uc774\ubbf8 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},setRecipient:function(){var t=[],n=e("#addressNameTag").find("li[data-id]");n.each(function(){var n=e(this).attr("data-userposition")?" "+e(this).attr("data-userposition"):"";t.push(e(this).attr("data-username")+n)}),e(".approval_import").setRecipient(t.join(","))},deleteItem:function(t){e(t.currentTarget).parents("li[data-userid]").remove(),this.setRecipient()},actSend:function(){var t=this,n=this.getAddressIds();n.length==0?e.goError(l["\uc218\uc2e0\ucc98\ub97c \uc9c0\uc815\ud574\uc8fc\uc138\uc694"]):e.goPopup({pclass:"layer_normal",header:l["\ubc1c\uc1a1\ud558\uae30"],modal:!0,width:450,contents:t.getActDocument(),buttons:[{btext:l["\ubc1c\uc1a1"],btype:"confirm",autoclose:!1,callback:function(){var r=e("#docTitle").val();if(!r)return e.goError(f["\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694."]),!1;t.actCopySave(n,r)}},{btext:f["\ucde8\uc18c"],btype:"cancel"}]})},getActDocument:function(){var e=this.model.attributes.document,t=this.getSender(this.apprFlow.activityGroups),n=e.formName,r=t[0].userName+" "+t[0].userPosition,i=t[0].deptName;return contents=u({lang:c,documentTitle:n,userName:r,userDept:i})},getAddressIds:function(){var t=[],n=e("#addressNameTag").find("li[data-id]");return n.each(function(){t.push({id:e(this).attr("data-sid"),reader:{id:e(this).attr("data-userid"),name:e(this).attr("data-username"),position:e(this).attr("data-userposition"),deptType:e(this).attr("data-deptType")}})}),t},actCopySave:function(e,t){var n=e,r=t,i=this.model.attributes.document,s=this.model.attributes.docInfo;this.model.setId({docId:this.docId,actCopyFormId:this.actCopyFormId}),this.model.set({document:this.getDocumentData(this.docId,i,r),docInfo:this.getDocInfoData(this.docId,n,s),apprFlow:this.apprFlow},{silent:!0}),this.model.save({},{type:"POST",success:function(e,t){t.code==200&&GO.router.navigate("/approval/doclist/draft/all",{trigger:!0})}})},getDocumentData:function(t,n,r){var i=r;return documentData={id:n.id,documentId:n.documentId,docStatus:n.docStatus,attachCount:n.attachCount,attaches:n.attaches,comments:n.comments,references:n.references,docBodyContent:e(".approval_import").html(),title:i}},getDocInfoData:function(e,t,n){return docInfoData={id:n.id,securityLevel:n.securityLevel,docYear:n.docYear,folderId:n.folderId,folderName:n.folderName,docReceptionReaders:t,docReferenceReaders:n.docReferenceReaders}},actCancel:function(e){var t="",n=GO.router.getUrl().indexOf("docfolder");n==-1?t="approval/document/"+this.docId:t="docfolder/document/"+this.docId,GO.router.navigate(t,!0)},actList:function(){var e=sessionStorage.getItem("list-history-baseUrl");e?GO.router.navigate(e,{trigger:!0}):GO.router.navigate("approval",{trigger:!0})},actPrint:function(t){var n=e.goPopup({pclass:"layer_normal",header:f["\uc778\uc1c4"],modal:!0,width:900,contents:"",buttons:[{btext:f["\uc778\uc1c4"],btype:"confirm",callback:function(){GO.util.print(e("#printArea"))}},{btext:f["\ucde8\uc18c"],btype:"cancel"}]}),r=e(".approval_import").html(),i=new s({docBody:r});i.render(),n.reoffset()},release:function(){this.$el.off(),this.$el.empty()}});return p})}).call(this);