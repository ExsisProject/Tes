define(["jquery","underscore","backbone","app","approval/models/comment","approval/collections/comments","approval/views/document/comment_attaches","approval/views/document/comment_reply","views/profile_card","components/emoticon/views/emoticons","hgn!approval/templates/document/comment","hgn!approval/templates/document/comments","hgn!approval/templates/document/comment_reply_modify","i18n!approval/nls/approval","i18n!nls/commons","file_upload","jquery.go-sdk","jquery.go-popup","GO.util","jquery.placeholder","go-fancybox"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m={"\uc800\uc7a5":d["\uc800\uc7a5"],"\uc0ad\uc81c":d["\uc0ad\uc81c"],"\ucde8\uc18c":d["\ucde8\uc18c"],"\uc0ac\uc9c4":d["\uc0ac\uc9c4"],"\ub4f1\ub85d":d["\ub4f1\ub85d"],"\ub313\uae00":p["\ub313\uae00"],"\ub313\uae00 \uc791\uc131":p["\ub313\uae00 \uc791\uc131"],"\ub313\uae00 \uc218\uc815":p["\ub313\uae00 \uc218\uc815"],"\ub313\uae00 \uc0ad\uc81c":p["\ub313\uae00 \uc0ad\uc81c"],"\ub313\uae00\uc744 \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?":p["\ub313\uae00\uc744 \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"\ub313\uae00\uc774 \ub4f1\ub85d\ub41c \uae00\uc740 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.":p["\ub313\uae00\uc774 \ub4f1\ub85d\ub41c \uae00\uc740 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],"\uac1c":p["\uac1c"],"\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4.":p["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4.":p["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"\ud655\uc7a5\uc790\uac00 \ub561\ub561\uc778 \uac83\ub4e4\uc740 \ucca8\ubd80 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.":p["\ud655\uc7a5\uc790\uac00 \ub561\ub561\uc778 \uac83\ub4e4\uc740 \ucca8\ubd80 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],"0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4.":p["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],"\ud30c\uc77c \ucca8\ubd80":d["\ud30c\uc77c \ucca8\ubd80"],"\uc774\ubbf8\uc9c0 \ucca8\ubd80":d["\uc774\ubbf8\uc9c0 \ucca8\ubd80"],commentPlaceholder:d["\ub313\uae00\uc744 \ub0a8\uaca8\ubcf4\uc138\uc694"]},g=n.View.extend({initialize:function(e){this.options=e||{},this.comments=this.options.comments,this.docId=this.options.docId,this.originalDocId=this.options.originalDocId,this.isBrowseByReference=this.options.isBrowseByReference,this.dateFormat=e.dateFormat?e.dateFormat:"SNS",this.commentModel=new i,this.emoticonView=new f({}),this.collection=s.getCollection({docId:this.docId}),this.collection.on("reset",this.render,this),this.isSaaS=r.session().brandName=="DO_SAAS",this.totalAttachSize=0,this.totalAttachCount=0},events:{"click span.photo a":"showProfileCard","click span.btn-comment-reply":"addCommentReplyForm","click span.comment_modify":"addModifyForm","click span.comment_delete":"actionDeleteComment","click span.comment_modify_save":"actionModifyComment","click span.comment_modify_cancel":"removeModifyForm","click span#apprComment":"commentSave","keyup .reply_wrap textarea.w_max":"expandEditor","click a.preview":"commentAttachPreview","click #emoticonBtn":"toggleEmoticonGroup","click [data-emoticon-delete-btn]":"deleteEmoticon","click [data-upload-btn]":"_validClickAttaches"},expandEditor:function(e){r.util.textAreaExpand(e)},render:function(){var t=this,n=this.collection.toJSON();this.$el.html(c({commentCount:n.length>5?n.length:!1,thumbnail:r.session("thumbnail"),lang:m})),e.each(n,function(n,i){var s=l({lang:m,data:i,hasEmoticon:!!i.emoticonPath,emoticonPathSrc:i.emoticonPath?r.config("emoticonBaseUrl")+i.emoticonPath:"",dateformat:function(){return t.dateFormat=="basicDate"?r.util.basicDate(this.createdAt):r.util.snsDate(this.createdAt)},messageParse:function(){return r.util.escapeHtml(this.message)},isReply:function(){return this.id===this.thread?!1:!0},isWritable:function(){return this.writer.id===r.session("id")?!0:!1},attachFiles:function(){return this.attaches?o.render({attaches:this.attaches,writer:this.writer,docId:t.docId,commentId:this.id,originalDocId:t.originalDocId,isBrowseByReference:t.isBrowseByReference}):""},sizeCal:function(){var e=this.size,t=r.util.getHumanizedFileSize(e);return t},attachWrap:function(){return this.attaches?!0:!1}});e("ul#comment_reply").append(s)}),this.initUpload(),e(".fancybox-thumbs").goFancybox(),this.$el.find("[data-replies-wrapper]").append(this.emoticonView.render().el)},showProfileCard:function(t){var n=e(t.currentTarget).attr("data-userid");a.render(n,t.currentTarget)},commentAttachPreview:function(t){var n=e(t.currentTarget);return r.util.preview(n.attr("data-id")),!1},addCommentReplyForm:function(t){var n=e(t.currentTarget).parents("li"),r=["reply",this.docId,n.attr("data-id")].join("_");this.$el.has("#"+r).length?(e(t.currentTarget).find(".comment_reply").html(m["\ub313\uae00"]),this.emoticonView.moveToMainEmoticonView(e(t.currentTarget)),u.close("#"+r)):(e(t.currentTarget).find(".comment_reply").html(m["\ucde8\uc18c"]),this.$el.find('li[data-thread="'+n.attr("data-id")+'"]:last').after('<li id="'+r+'" class="depth_in reply_create" />'),u.render({docId:this.docId,commentId:n.attr("data-id"),el:"#"+r,lang:m,collection:this.collection,emoticonView:this.emoticonView}))},commentSave:function(t){var n=this,s=new i;messageForm=this.$el.find("#formApprComment");if(!messageForm.val()||!e.goValidation.isCheckLength(2,1e3,e.trim(messageForm.val()))||messageForm.val()==p["\ub313\uae00\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]){messageForm.focus(),e.goMessage(r.i18n(m["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"1000"}));return}var o=[],u=e("#commentAttachPart").find("li:not(.attachError)");u.each(function(){o.push({path:e(this).attr("data-tmpname"),name:e(this).attr("data-name")})}),s.set({docId:this.docId},{silent:!0}),s.save({writer:this.writer,message:messageForm.val(),attaches:o,emoticonPath:this.emoticonView.getSelectedEmoticonImgSrc(e(t.currentTarget))},{type:"POST",success:function(e,t){n.collection.fetch({async:!1,reset:!0})}})},addModifyForm:function(n){var i=e(n.currentTarget).parents("li"),s=this.collection.get(i.attr("data-id"));i.find("div.action_wrap").hide(),i.addClass("reply_create reply_edit");var o=[],u=[];e.each(s.get("attaches"),function(e,t){t.humanSize=r.util.getHumanizedFileSize(t.size);if(t.thumbSmall)o.push(t);else{var n=new RegExp("(zip|doc|docx|ppt|pptx|xls|xlsx|hwp|pdf|txt|html|htm|jpg|jpeg|png|gif|tif|tiff|bmp|exe|avi|mp3|mp4|mov|mpg|mpeg|lzh|xml|log|csv|eml)","gi");n.test(t.extention)||(t.extention="def"),u.push(t)}}),i.find("p.message").after(h({isAttaches:s.get("attaches").length?!0:!1,hasFiles:u.length?!0:!1,hasImages:o.length?!0:!1,hasEmoticon:!t.isUndefined(s.get("emoticonPath")),emoticonPathSrc:r.config("emoticonBaseUrl")+s.get("emoticonPath"),emoticonPath:s.get("emoticonPath"),contextRoot:r.contextRoot,files:u,images:o,docId:this.docId,commentId:s.get("thread"),writer:s.get("writer"),message:r.util.unescapeHtml(s.get("message")),id:s.get("id"),lang:m})).hide(),i.find("ul.origin").hide(),i.find("#emoticonPart").hide(),this.initCommentModifyUpload(this.docId,s.get("thread"))},actionDeleteComment:function(t){var n=this,r=e(t.currentTarget).parents("li"),i=r.attr("data-id"),s=this.collection.get(i).toJSON();if(s.replyCount>0)e.goAlert(m["\ub313\uae00 \uc0ad\uc81c"],m["\ub313\uae00\uc774 \ub4f1\ub85d\ub41c \uae00\uc740 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);else{var o=function(){n.commentModel.set({docId:n.docId,commentId:i},{silent:!0}),n.commentModel.save({},{type:"DELETE",success:function(e,t){t.code==200&&n.collection.fetch({async:!1,reset:!0})}})};e.goCaution(m["\ub313\uae00 \uc0ad\uc81c"],m["\ub313\uae00\uc744 \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],o)}},toggleEmoticonGroup:function(t){console.info("toggleEmoticonGroup"),t.preventDefault(),t.stopPropagation();if(this.emoticonView.hasAttaches(e(t.currentTarget)))return!1;this.emoticonView.renderEmoticonGroup(e(t.currentTarget))},deleteEmoticon:function(t){var n=e(t.currentTarget).parent();n.empty(),n.removeClass()},initCommentModifyUpload:function(t,n){var i=this,s={el:"#commentAttach_"+t+"_"+n,context_root:r.contextRoot,button_text:"",button_width:36,button_height:26,url:"api/file?GOSSOcookie="+e.cookie("GOSSOcookie"),mode:"COMMENT",progressBarUse:!0,progressEl:"#progress_"+t+"_"+n},o=parseInt(r.config("commonAttachConfig").maxAttachSize),u=o*1024*1024,a=parseInt(r.config("commonAttachConfig").maxAttachNumber);(new v(s)).queue(function(e,t){}).start(function(s,f){if(i.emoticonView.hasSelectedEmoticon(e(s.currentTarget)))return!1;if(!r.config("attachFileUpload"))return e.goAlert(d["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1;if(i.isSaaS){if(u<f.size)return e.goMessage(r.i18n(d["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",o)),!1;i.totalAttachSize+=f.size;var l=e("#commentFileModifyWrap_"+t+"_"+n).find("li").length+i.totalAttachCount+1;if(a<l)return e.goMessage(r.i18n(d["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",a)),!1;i.totalAttachCount++}}).progress(function(e,t){}).success(function(s,o,u){var a="",f="";if(r.util.fileUploadErrorCheck(o))a="<strong class='caution'>"+r.util.serverMessage(o)+"</strong>",f="attachError";else if(r.util.isFileSizeZero(o))return e.goAlert(r.util.serverMessage(o)),!1;var l=o.data,c=l.filePath,h=l.fileName,p=l.fileExt,d=l.fileSize,v=r.util.getHumanizedFileSize(d),m=l.thumbnail,g="",y=l.hostId;if(r.util.isImage(p))g='<li class="'+f+'" data-tmpname="'+c+'" data-name="'+h+'" data-hostid="'+y+'" data-size="'+d+'">'+'<span class="item_image">'+'<span class="thumb">'+'<img src="'+m+'" alt="'+h+'" />'+"</span>"+'<span class="btn_wrap">'+'<span class="ic_classic ic_del" title="\uc0ad\uc81c" data-docId='+t+"></span>"+"</span>"+"</span>"+"</li>",e("#commentFileModifyWrap_"+t+"_"+n).find("ul.img_wrap").length==0&&e("#commentFileModifyWrap_"+t+"_"+n).append('<ul class="img_wrap"></ul>'),e("#commentFileModifyWrap_"+t+"_"+n).find("ul.img_wrap").append(g);else{var b="def";r.util.fileExtentionCheck(p)&&(b=p),g='<li class="'+f+'" data-tmpname="'+c+'" data-name="'+h+'" data-hostid="'+y+'" data-size="'+d+'">'+'<span class="item_file">'+'<span class="ic_file ic_'+b+'"></span>'+'<span class="name">'+h+"</span>"+'<span class="size">('+v+")</span>"+'<span class="btn_wrap" title="\uc0ad\uc81c">'+'<span class="ic_classic ic_del" data-docId='+t+"></span>"+"</span>"+a+"</span>"+"</li>",e("#commentFileModifyWrap_"+t+"_"+n).find("ul.file_wrap").length==0&&e("#commentFileModifyWrap_"+t+"_"+n).append('<ul class="file_wrap"></ul>'),e("#commentFileModifyWrap_"+t+"_"+n).find("ul.file_wrap").append(g)}i.resetAttachSizeAndCount()}).complete(function(e,t){}).error(function(t,n){n.jqXHR&&(n.jqXHR.statusText=="abort"?e.goAlert(d["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):e.goAlert(d["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."]),i.resetAttachSizeAndCount())})},actionModifyComment:function(t){var n=this,i=e(t.currentTarget).parents("li");i.removeClass("reply_create reply_edit"),messageForm=i.find("textarea");var s=i.attr("data-id"),o=e(t.currentTarget).attr("data-docId"),u=e(t.currentTarget).attr("data-commentid");if(!e.goValidation.isCheckLength(2,1e3,e.trim(messageForm.val()))||!messageForm.val()){messageForm.focus(),e.goMessage(r.i18n(m["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"1000"}));return}var a={id:s,docId:this.docId,writer:this.writer,message:messageForm.val(),emoticonPath:this.emoticonView.getSelectedEmoticonImgSrc(e(t.currentTarget)),thread:u},f=[],l,c=e("#commentFileModifyWrap_"+o+"_"+u).find("li:not(.attachError)");c.each(function(){l={},e(this).attr("data-tmpname")&&(l.path=e(this).attr("data-tmpname")),e(this).attr("data-name")&&(l.name=e(this).attr("data-name")),e(this).attr("data-id")&&(l.id=e(this).attr("data-id")),f.push(l)}),f.length>0&&(a.attaches=f),this.commentModel.clear(),this.commentModel.set({docId:this.docId},{silent:!0}),this.commentModel.save(a,{type:"PUT",success:function(e,t){n.collection.fetch({async:!1,reset:!0})}})},removeModifyForm:function(t){var n=e(t.currentTarget).parents("li"),r=this.collection.get(n.attr("data-id"));this.emoticonView.moveToMainEmoticonView(e(t.currentTarget)),n.removeClass("reply_create reply_edit"),n.find("div.action_wrap, p.message, ul.origin, #emoticonPart").attr("style",""),n.find(".appr-doc-replyform").remove()},commentAttachDelete:function(t){e(t.target).parents("li").first().remove(),e("#commentAttachPart").find("li").length<1&&e("#commentAttachPart").css("margin-bottom","0px")},initUpload:function(){var t=this,n={el:"#commentAttachBtn",context_root:r.contextRoot,button_text:"",button_width:36,button_height:26,url:"api/file?GOSSOcookie="+e.cookie("GOSSOcookie"),mode:"COMMENT",progressBarUse:!0,progressEl:"#commentProgressBar"},i=parseInt(r.config("commonAttachConfig").maxAttachSize),s=i*1024*1024,o=parseInt(r.config("commonAttachConfig").maxAttachNumber);(new v(n)).queue(function(e,t){}).start(function(n,u){if(t.emoticonView.hasSelectedEmoticon(e(n.currentTarget)))return!1;if(!r.config("attachFileUpload"))return e.goAlert(d["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1;if(t.isSaaS){if(s<u.size)return e.goMessage(r.i18n(d["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",i)),!1;t.totalAttachSize+=u.size;var a=e("#commentAttachPart").find("li").length+t.totalAttachCount+1;if(o<a)return e.goMessage(r.i18n(d["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",o)),!1;t.totalAttachCount++}}).progress(function(e,t){}).success(function(n,i,s){var o="",u="";if(r.util.fileUploadErrorCheck(i))o="<strong class='caution'>"+r.util.serverMessage(i)+"</strong>",u="attachError";else if(r.util.isFileSizeZero(i))return e.goAlert(r.util.serverMessage(i)),!1;var a=i.data,f=a.filePath,l=a.fileName,c=a.fileExt,h=a.fileSize,p=r.util.getHumanizedFileSize(h),d=a.thumbnail,v=a.hostId,g="";if(r.util.isImage(c))g='<li class="'+u+'" data-tmpname="'+f+'" data-name="'+l+'" data-hostid="'+v+'" data-size="'+h+'">'+'<span class="item_image">'+'<span class="thumb">'+'<img src="'+d+'" alt="'+l+'" />'+"</span>"+'<span class="btn_wrap">'+'<span class="ic_classic ic_del" title="'+m["\uc0ad\uc81c"]+'"></span>'+"</span>"+"</span>"+"</li>",e("#commentAttachPart").find("ul.img_wrap").append(g);else{var y="def";r.util.fileExtentionCheck(c)&&(y=c),g='<li class="'+u+'" data-tmpname="'+f+'" data-name="'+l+'" data-hostid="'+v+'" data-size="'+h+'">'+'<span class="item_file">'+'<span class="ic_file ic_'+y+'"></span>'+'<span class="name">'+l+"</span>"+'<span class="size">('+p+")</span>"+'<span class="btn_wrap" title="'+m["\uc0ad\uc81c"]+'">'+'<span class="ic_classic ic_del"></span>'+"</span>"+o+"</span>"+"</li>",e("#commentAttachPart").find("ul.file_wrap").append(g)}t.resetAttachSizeAndCount()}).complete(function(e,t){}).error(function(n,r){r.jqXHR&&(r.jqXHR.statusText=="abort"?e.goAlert(d["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):e.goAlert(d["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."]),t.resetAttachSizeAndCount())})},getViewedTotalAttachSize:function(t){var n=0;return e(t).find("li").each(function(){n+=parseInt(this.getAttribute("data-size"),0)}),n},resetAttachSizeAndCount:function(){this.isSaaS&&(this.totalAttachSize=0,this.totalAttachCount=0)},_validClickAttaches:function(t){if(this.emoticonView.hasSelectedEmoticon(e(t.currentTarget)))return!1}});return g});