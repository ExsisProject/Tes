define(["jquery","underscore","backbone","when","app","hgn!approval/templates/create_rule","hgn!approval/templates/update_rule","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a){var f=n.Model.extend({url:function(){var e="/api/approval/classify/user/rule";return this.deptId&&(e="/api/approval/classify/dept/"+this.deptId+"/rule"),this.ruleId!=undefined&&(e=e+"/"+this.ruleId),e},setRuleId:function(e){this.ruleId=e},setDeptId:function(e){this.deptId=e}}),l=n.Collection.extend({model:n.Model.extend(),url:function(){return this.deptId?"/api/approval/deptfolder/"+this.deptId:"/api/approval/userfolder/"+this.userId},setUserId:function(e){this.userId=e},setDeptId:function(e){this.deptId=e}}),c=n.Model.extend({url:function(){return this.deptId?"/api/approval/classify/dept/owner/"+this.deptId:"/api/approval/classify/owner"},setDeptId:function(e){this.deptId=e}}),h={draftFolder:a["\uae30\uc548 \ubb38\uc11c\ud568"],approvalFolder:a["\uacb0\uc7ac \ubb38\uc11c\ud568"],refferenceReadFolder:a["\ucc38\uc870/\uc5f4\ub78c \ubb38\uc11c\ud568"],receiveFolder:a["\uc218\uc2e0 \ubb38\uc11c\ud568"],deptDraftFolder:a["\uae30\uc548 \uc644\ub8cc\ud568"],deptRefferenceReadFolder:a["\ubd80\uc11c \ucc38\uc870\ud568"],deptReceiveFolder:a["\ubd80\uc11c \uc218\uc2e0\ud568"],document:a["\uc758 \ubb38\uc11c\uc5d0"],title:a["\uc81c\ubaa9\uc774"],formName:a["\uc591\uc2dd\uba85\uc774"],drafter:a["\uae30\uc548\uc790\uac00"],draftDept:a["\uae30\uc548\ubd80\uc11c\uac00"],include:a["\uc744(\ub97c) \ud3ec\ud568 \ud560 \ub54c"],allCondition:a["\ubaa8\ub450 \ub9cc\uc871"],matchAllCondition:a["\uc704\uc758 \uc870\uac74\uc744 \ubaa8\ub450 \ub9cc\uc871\ud560 \ub54c \ubd84\ub958\ud569\ub2c8\ub2e4"],oneCondition:a["\ud558\ub098\ub9cc \ub9cc\uc871"],matchOneCondition:a["\uc704\uc758 \uc870\uac74 \uc911 \ud558\ub098\ub9cc \ub9cc\uc871\ud574\ub3c4 \ubd84\ub958\ud569\ub2c8\ub2e4"],classifyDocument:a["\ud574\ub2f9 \ubb38\uc11c\ub97c \ub2e4\uc74c \ubb38\uc11c\ud568\uc5d0 \ubd84\ub958"],completeDocumentOnly:a["\ubb38\uc11c\uc758 \uc9c4\ud589 \uc0c1\ud0dc\uac00 \uc644\ub8cc\ub41c \uac83\ub9cc \ubd84\ub958\ub429\ub2c8\ub2e4"],notClassifyDocumentOnly:a["\uc774\ubbf8 \uc218\ub3d9\uc73c\ub85c \ubd84\ub958\ub41c \ubb38\uc11c\ub294 \uc790\ub3d9\ubd84\ub958\uc5d0 \ud3ec\ud568\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4"],docFolderIsEmpty:a["\ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]},p=n.View.extend({initialize:function(e){this.options=e||{},this.userId=i.session("id"),this.deptId=this.options.deptId,this.docId=this.options.docId,this.docInfo=this.options.docInfo,this.collection=new l,this.ownerModel=new c,this.deptId?(this.collection.setDeptId(this.deptId),this.ownerModel.setDeptId(this.deptId)):this.collection.setUserId(this.userId),this.collection.fetch({async:!1}),this.ownerModel.fetch({async:!1}),this.ruleId=this.options.ruleId,this.ruleId!=undefined&&(this.model=new f,this.deptId&&this.model.setDeptId(this.deptId),this.model.setRuleId(this.ruleId),this.model.fetch({async:!1}))},events:{"click input:checkbox":"toggleCheckbox"},render:function(){var e=this.collection.toJSON();return this.ruleId?this.renderUpdateView(e):this.docId?this.renderCreateFromList(e):this.renderCreateView(e),this},renderCreateView:function(e){this.$el.html(s({lang:h,docFolders:e,isDept:this.deptId?!0:!1}))},renderUpdateView:function(t){var n=!1,r=!1,i=!1,s=!1,u,a,f,l,c=this.model.toJSON();e.each(c.ruleSetModel.rules,function(e,t){t.type=="TITLE"?(u=t.target,n=!0):t.type=="FORM"?(a=t.target,r=!0):t.type=="DRAFTER"?(f=t.target,i=!0):t.type=="DRAFT_DEPT"&&(l=t.target,s=!0)}),this.$el.html(o({lang:h,docFolders:t,title:u,useTitle:n,form:a,useForm:r,drafter:f,useDrafter:i,draftDept:l,useDraftDept:s,condition:c.ruleSetModel.condition=="AND"?!0:!1,destinationFolder:function(){if(c.ruleSetModel.postActionList[0].destinationDocFolderId==this.folderId)return"selected"},isDept:this.deptId?!0:!1}));var p=c.ruleSetModel.targetDocfolder.docFolderType;this.$el.find("#folderType option[value='"+p+"']").attr("selected","selected"),this.toggleCheckbox()},renderCreateFromList:function(e){this.$el.html(o({lang:h,docFolders:e,title:this.docInfo.title,useTitle:!0,form:this.docInfo.form,useForm:!0,drafter:this.docInfo.drafter,useDrafter:!0,draftDept:this.docInfo.draftDeptName,useDraftDept:!0,isDept:this.deptId?!0:!1})),this.$el.find("#folderType option[value='"+this.docInfo.docFolderType+"']").attr("selected","selected"),this.toggleCheckbox()},createRule:function(){var t=r.defer(),n=new f;this.deptId&&n.setDeptId(this.deptId);var i="POST";this.ruleId&&(n=this.model,i="PUT");var s={},o=[];return e("#titleCheck").is(":checked")&&o.push({type:"TITLE",target:e("#titleText").val()}),e("#formNameCheck").is(":checked")&&o.push({type:"FORM",target:e("#formNameText").val()}),e("#drafterCheck").is(":checked")&&o.push({type:"DRAFTER",target:e("#drafterText").val()}),e("#draftDeptCheck").is(":checked")&&o.push({type:"DRAFT_DEPT",target:e("#draftDeptText").val()}),s.rules=o,s.condition=e("#allCondition").is(":checked")?"AND":"OR",s.targetDocfolder={type:this.deptId?"DEPT":"USER",docFolderType:e("#folderType option:selected").val()},s.postActionList=[{actionType:"CLASSIFY",docFolderType:this.deptId?"DEPT":"USER",destinationDocFolderId:e("#destinationFolder option:selected").val()}],n.set({ruleSetModel:s},{silent:!0}),n.set({ownerId:this.ownerModel.get("id")},{silent:!0}),n.save({},{type:i,success:function(){return e.goMessage(u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.resolve()},error:function(n,r){var i=JSON.parse(r.responseText);e.goError(i.message),t.reject()}}),t.promise},validate:function(){var t=!0,n;if(e("#destinationFolder option:checked").val()==""||e("#destinationFolder option:checked").val()==undefined)return t=!1,e.goError(a["\ubd84\ub958\ud560 \ubb38\uc11c\ud568 \uc5c6\uc74c"]),t;var r=e("#titleCheck").is(":checked"),i=e("#formNameCheck").is(":checked"),s=e("#drafterCheck").is(":checked"),o=e("#draftDeptCheck").is(":checked");return!r&&!i&&!s&&!o?(t=!1,e.goError(a["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),t):(r&&e("#titleText").val()==""&&(t=!1,n=e("#titleText")),i&&e("#formNameText").val()==""&&(t=!1,n=e("#formNameText")),s&&e("#drafterText").val()==""&&(t=!1,n=e("#drafterText")),o&&e("#draftDeptText").val()==""&&(t=!1,n=e("#draftDeptText")),t||(e.goError(a["\uaddc\uce59\uc124\uc815 \ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694."]),n.focus()),t)},toggleCheckbox:function(){var e=this.$("input:checkbox:checked");e.length>1?this.$(".condition_view").show():this.$(".condition_view").hide()}});return p});