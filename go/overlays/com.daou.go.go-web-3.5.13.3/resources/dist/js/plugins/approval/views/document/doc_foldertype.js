define(["jquery","underscore","backbone","app","approval/views/apprform/appr_company_folder_searchTree","hgn!approval/templates/document/doc_foldertype","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-sdk","jquery.jstree","jquery.go-popup","jquery.go-grid","jquery.go-validation"],function(e,t,n,r,i,s,o,u){var a=n.Collection.extend({initialize:function(e){this.docId=e},model:n.Model.extend(),url:function(){return"/api/approval/document/"+this.docId+"/folder"}}),f={"\ubb38\uc11c\ud568":u["\ubb38\uc11c\ud568"],empty_folder:u["\ubb38\uc11c\ud568\uc744 \ucd94\uac00\ud574 \uc8fc\uc138\uc694"],"\ubd80\uc11c":u["\ubd80\uc11c"],"\uc774\ub984":o["\uc774\ub984"],"\ubd80\uc11c\uba85":o["\ubd80\uc11c\uba85"],"\uc774\uba54\uc77c":o["\uc774\uba54\uc77c"],"\ud655\uc778":o["\ud655\uc778"],"\ucde8\uc18c":o["\ucde8\uc18c"],"\uc0ad\uc81c":o["\uc0ad\uc81c"],"\uac80\uc0c9":o["\uac80\uc0c9"]},l=n.View.extend({initialize:function(e){this.$el=e.el,this.defaultFolder=e.defaultFolder,this.collection=e.collection,this.collection.each(function(e){e.set("modifiable",!1)})},events:{"click .ic_basket":"deleteFolder"},render:function(){var e=this._compileTemplate(),n=this.collection.toJSON();return n=t.map(n,function(e,t,n){return e.modifiable=this.defaultFolder["id"]!=e["id"],e},this),this.$el.html(e.render({lang:f,folders:n})),this.$el},addFolder:function(e){return this.collection.add({id:e.id,name:e.parentName,modifiable:!0}),this.render(),this.$el},deleteFolder:function(t){var n=e(t.currentTarget).parent().parent().attr("data-id"),r=this.collection.find(function(e){return e.get("id")==n});r&&this.collection.remove(r),this.render()},_compileTemplate:function(){return Hogan.compile(["{{#folders}}","    <tr>",'        <td class="name">{{name}}</td>','        <td class="func" data-id={{id}} data-folderid="{{id}}" data-folderName="{{name}}">',"        {{#modifiable}}",'            <span class="btn_bdr" title="{{lang["\uc0ad\uc81c"]}}"><span class="ic_classic ic_basket"></span></span>',"        {{/modifiable}}","        </td>","    </tr>","{{/folders}}","{{^folders}}","    <tr>",'        <td class="name">{{lang.empty_folder}}</td>',"    </tr>","{{/folders}}"].join("\n"))}}),c=n.View.extend({el:".layer_normal .content",searchTreeView:null,listView:null,initialize:function(e){this.options=e||{},this.docId=this.options.docId,this.defaultFolder=e.defaultFolder,this.collection=new a(this.docId),this.collection.fetch({async:!1})},events:{"click .btn_langth":"addFolder"},render:function(){this.$el.html(s({lang:f})),this.searchTreeView=new i({isAdmin:!1,elId:"company_Folder_searchTree",treeElId:"formTree",searchInputId:"searchInput",apiCommonUrl:"api/docfolder/sidetree",searchResultElId:"searchResult"}),this.listView=new l({el:this.$el.find("#folder_list"),defaultFolder:this.defaultFolder,collection:this.collection}),this.searchTreeView.render(),this.listView.render()},addFolder:function(){var t=this.searchTreeView.getSelectedNodeData(),n=t.parentName,r=t.id;if(!r)return e.goMessage(u["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;if(this.isExistFolder(r))return e.goMessage(u["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."]),!1;this.listView.addFolder(t),this.listView.render()},isExistFolder:function(t){var n=!1,r=e("#addDocFolder").find(".func[data-folderid]");return r.each(function(){if(e(this).attr("data-folderid")==t)return n=!0,!1}),n},getFolderIds:function(){return this.collection.map(function(e){return e.get("id")})},release:function(){this.$el.off(),this.$el.empty()}});return c});