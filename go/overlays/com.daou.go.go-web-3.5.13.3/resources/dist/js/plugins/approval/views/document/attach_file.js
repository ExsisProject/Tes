define(function(require){function f(e){var t='<li><span class="item_image"><span class="{{classname}}">{{^isBrowseByReference}}<a href="{{contextRoot}}api/approval/document/{{docId}}/download/{{attachId}}" data-bypass class="fancybox-thumbs fancybox-button" data-fancybox-group="attachImgThumb_" title="{{filename}}"><img src="{{path}}" alt="{{filename}}" /></a>{{/isBrowseByReference}}{{#isBrowseByReference}}<a href="{{contextRoot}}api/approval/document/{{docId}}/reference/{{originalDocId}}/download/{{attachId}}" data-bypass class="fancybox-thumbs fancybox-button" data-fancybox-group="attachImgThumb_" title="{{filename}}"><img src="{{path}}" alt="{{filename}}" /></a>{{/isBrowseByReference}}</span></span></li>',r=n.compile(t);return r.render(e)}function l(e){var t='<li><span class="item_file"><span class="ic_file ic_{{fileType}}"></span><span class="name btn_attach"><a href="{{contextRoot}}api/approval/document/{{docId}}{{^isBrowseByReference}}/download/{{attachId}}{{/isBrowseByReference}}{{#isBrowseByReference}}/reference/{{originalDocId}}/download/{{attachId}}{{/isBrowseByReference}}"data-bypass>{{filename}}</a></span><span class="size">({{filesize}})</span>{{#usePreview}}<a href="#" data-func="preview" data-bypass data-id="{{encrypt}}"><span class="btn_fn4"><span class="txt"> {{lang.preview}} </span></span></a>{{/usePreview}}{{^isBrowseByReference}}<a href="{{contextRoot}}api/approval/document/{{docId}}/download/{{attachId}}" data-bypass><span class="btn_fn4"><span class="txt"> {{lang.download}} </span></span></a></span>{{/isBrowseByReference}}{{#isBrowseByReference}}<a href="{{contextRoot}}api/approval/document/{{docId}}/reference/{{originalDocId}}/download/{{attachId}}" data-bypass><span class="btn_fn4"><span class="txt"> {{lang.download}} </span></span></a></span>{{/isBrowseByReference}}</li>',r=n.compile(t);return r.render(e)}var e=require("backbone"),t=require("when"),n=require("hogan"),r=require("app"),i=require("hgn!approval/templates/document/attach_file_view"),s=require("go-ignoreduplicatemethod"),o=require("i18n!nls/commons"),u=require("i18n!approval/nls/approval"),a={img_attach:o["\uc774\ubbf8\uc9c0 \ucca8\ubd80"],file_attach:o["\ud30c\uc77c \ucca8\ubd80"],doc_search:u["\ubb38\uc11c \uac80\uc0c9"],attach_file:u["\ucca8\ubd80\ud30c\uc77c"],view:u["\ubcf4\uae30"],preview:u["\ubbf8\ub9ac\ubcf4\uae30"],amt:u["\uac1c"],no_authority:u["\uc5f4\ub78c \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]},c=e.View.extend({events:{},initialize:function(e){var t=e||{};this.attaches=t.attaches||[],this.userApprSetting=t.userApprSetting||{},this.docId=t.docId,this.originalDocId=t.originalDocId,this.isBrowseByReference=t.isBrowseByReference,this.totalSize=this.getTotalAttachSize(),this._initRender()},render:function(){var e=this.getAttachImageMode();this.getAttachCount()>0&&(_.each(this.attaches,function(t){e!=="FILENAME"&&r.util.isImage(t.extention)?this._renderImage(t):this._renderFile(t)},this),this.$el.find("#img_wrap").is(":empty")&&this.$el.find("#img_wrap").remove(),this.$el.find("#file_wrap").is(":empty")&&this.$el.find("#file_wrap").remove())},remove:function(){e.View.prototype.remove.apply(this,arguments),this.undelegateEvents(),this.$el.empty()},getAttachImageMode:function(){return this.userApprSetting.attachImageMode},getAttachCount:function(){return this.attaches.length||0},getTotalAttachSize:function(){var e=0;return _.each(this.attaches,function(t){e+=parseInt(t.size)}),r.util.getHumanizedFileSize(e)},_initRender:function(){this.$el.html(i({lang:a,totSize:this.totalSize,total:this.getAttachCount()}))},_renderImage:function(e){function l(e){return t.promise(function(t,n){setTimeout(function(){e.find("img").each(function(){$(this).attr("data-orgwidth",$(this).outerWidth()),$(this).attr("data-orgheight",$(this).outerHeight())}),t()},200)})}function c(e){setTimeout(function(){var t=e.innerWidth();e.find("img").each(function(){var e=parseInt($(this).data("orgwidth")),n=parseInt($(this).data("orgheight"));e>t&&($(this).outerWidth(t),$(this).outerHeight(n*(t/e)))})},200)}function h(e){var t=new s;$(window).on("resize.appr.document",function(n){if(!$.isWindow(n.target))return;t.bind(function(){c(e)})})}var n,i,o=this.$el.find("#img_wrap"),u=this.getAttachImageMode(),a=this.docId;u==="ORIGINAL"?(i="original",o.addClass(i),n=e.thumbOriginal):(i="thumb",n=e.thumbSmall),o.append(f({contextRoot:r.config("contextRoot"),classname:i,attachId:e.id,filename:e.name,docId:a,path:n,originalDocId:this.originalDocId,isBrowseByReference:this.isBrowseByReference})),u==="ORIGINAL"&&l(o).then(function(){c(o),h(o)})},_renderFile:function(e){var t=r.util.getHumanizedFileSize(e.size),n="def",i=this.docId,s=new RegExp("(zip|doc|docx|ppt|pptx|xls|xlsx|hwp|pdf|txt|html|htm|jpg|jpeg|png|gif|tif|tiff|bmp|exe|avi|mp3|mp4|mov|mpg|mpeg|lzh|xml|log|csv|eml)","gi");s.test(e.extention)&&(n=e.extention.toLowerCase()),this.$el.find("#file_wrap").append(l({contextRoot:r.config("contextRoot"),fileType:n,attachId:e.id,filename:e.name,filesize:t,usePreview:!!e.preview,encrypt:e.encrypt,docId:i,originalDocId:this.originalDocId,isBrowseByReference:this.isBrowseByReference,lang:{preview:a.preview,download:o["\ub2e4\uc6b4\ub85c\ub4dc"]}}))}},{appendTo:function(e,t,n,r,i){var s=i||{},o=new c({el:e,attaches:t||[],userApprSetting:n,docId:r,originalDocId:s.originalDocId,isBrowseByReference:s.isBrowseByReference});return o.render(),o}});return c});