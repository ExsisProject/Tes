(function(){define(["jquery","backbone","hogan","app","when","approval/models/doclist_item","views/mobile/header_toolbar","approval/views/mobile/official_document/m_toolbar","approval/views/mobile/official_document/m_document","approval/views/mobile/official_document/m_action_document","hgn!approval/templates/mobile/official_document/m_main","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-validation","GO.util","iscroll"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p={"\uc2b9\uc778\ud558\uae30":h["\uc2b9\uc778\ud558\uae30"],move_to_home:c["\ud648\uc73c\ub85c \uc774\ub3d9"],approval:h["\uc804\uc790\uacb0\uc7ac"],"\uacf5\ubb38 \ubc1c\uc1a1 \ucde8\uc18c \uc5ec\ubd80":h["\uacf5\ubb38 \ubc1c\uc1a1 \ucde8\uc18c \uc5ec\ubd80"],"\uacf5\ubb38 \uc7ac\ubc1c\uc1a1 \uc5ec\ubd80":h["\uacf5\ubb38 \uc7ac\ubc1c\uc1a1 \uc5ec\ubd80"]},d=t.Model.extend({url:function(){return["/api/approval/official",this.officialId].join("/")},initialize:function(e){this.officialId=e.officialId},getOfficialId:function(){return this.get("officialVersion").id}}),v=t.View.extend({el:"#content",events:{"vclick #copyUrl":"copyUrl"},initialize:function(e){this.allowAction=!0,r.util.appLoading(!0),this.options=e||{},this.officialId=this.options.officialId,this.model=new d({officialId:this.officialId}),this.toolBarData={title:h["\uc0c1\uc138 \ub0b4\uc6a9 \uc870\ud68c"],isPrev:!0},r.EventEmitter.off("change:comment"),r.EventEmitter.on("common","change:comment",_.bind(function(e){this.$el.find("#commentCount").text(e)},this))},render:function(){i(this.fetchModel()).then(_.bind(function(){var t={title:this.model.get("title")};this.$el.html(l({doc:t})),this.renderTitleToolbarView(),this.renderSubView(),this.bindSubView()},this)).then(_.bind(this.show_document,this)).otherwise(function(t){r.util.linkToErrorPage(t)})},copyUrl:function(e){r.util.copyUrl(e)},renderSubView:function(){var e=this;this.toolbarView=new u({model:this.model}),this.assign(this.toolbarView,"div.tool_bar"),this.documentView=new a({model:this.model}),this.assign(this.documentView,"#document_view")},bindSubView:function(){this.toolbarView.bind("actList",this.actList,this),this.toolbarView.bind("approved",this.doApprove,this),this.toolbarView.bind("returned",this.doReturn,this),this.toolbarView.bind("retracted",this.doRetract,this),this.toolbarView.bind("rerequested",this.doRerequest,this),this.toolbarView.bind("show_document",this.show_document,this)},renderTitleToolbarView:function(){this.headerToolbarView=o,this.headerToolbarView.render(this.toolBarData)},fetchModel:function(){var e=i.defer();return this.model.fetch({success:e.resolve,error:e.reject}),e.promise},doApprove:function(){var t=this,n={title:p["\uc2b9\uc778\ud558\uae30"],rightButton:{text:h["\uc2b9\uc778"],callback:function(){t.saveApprAction("APPROVE")}},cancelButton:{callback:e.proxy(function(){this.docActionRelease()},this)}};this.documentAction=new f({toolBarData:n,header:t.$el.find("#doc_header").html()}),this.$el.find("#document_main").hide(),this.$el.find("#document_action").show(),this.assign(this.documentAction,"#document_action")},doReturn:function(){var t=this,n={title:h["\ubc18\ub824\ud558\uae30"],rightButton:{text:h["\ubc18\ub824"],callback:function(){t.saveApprAction("RETURN")}},cancelButton:{callback:e.proxy(function(){this.docActionRelease()},this)}};this.documentAction=new f({toolBarData:n,header:t.$el.find("#doc_header").html()}),this.$el.find("#document_main").hide(),this.$el.find("#document_action").show(),this.assign(this.documentAction,"#document_action")},doRetract:function(){var e=this;if(confirm(p["\uacf5\ubb38 \ubc1c\uc1a1 \ucde8\uc18c \uc5ec\ubd80"])){var t=new d({id:this.model.get("officialVersion").id,officialId:this.model.get("officialVersion").id});t.save({},{type:"PUT",url:["/api/approval/official/cancel",this.model.getOfficialId()].join("/"),success:function(t,n){n.code==200&&e.actList()},error:function(e,t){var n=JSON.parse(t.responseText);return n.message?(alert(n.message),!1):(alert(h["\ubc1c\uc1a1 \ucde8\uc18c\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4"]),!1)}})}else _.delay(function(){e.toolbarView.$("#selectAction").val("")},100)},doRerequest:function(){var e=this;if(confirm(p["\uacf5\ubb38 \uc7ac\ubc1c\uc1a1 \uc5ec\ubd80"])){var t=new d({id:this.model.get("officialVersion").id,officialId:this.model.get("officialVersion").id});t.save({},{type:"PUT",url:["/api/approval/official/rerequest",this.model.getOfficialId()].join("/"),success:function(t,n){n.code==200&&e.actList()},error:function(e,t){var n=JSON.parse(t.responseText);return n.message?(alert(n.message),!1):(alert(h["\ubc1c\uc1a1\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4"]),!1)}})}else _.delay(function(){e.toolbarView.$("#selectAction").val("")},100)},saveApprAction:function(t){var n=this;if(!this.allowAction)return;if(!this.actionApprValidate("#textarea-desc",t))return this.allowAction=!0,!1;this.allowAction=!1;var i="document.draftedAt",s="desc",o=sessionStorage.getItem("list-history-searchtype"),u=sessionStorage.getItem("list-history-keyword")&&sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),a="all",f="",l="";sessionStorage.getItem("list-history-duration")&&sessionStorage.getItem("list-history-duration")!=""&&(a=sessionStorage.getItem("list-history-duration")),a=="period"&&sessionStorage.getItem("list-history-fromDate")&&sessionStorage.getItem("list-history-fromDate")!=""&&(f=sessionStorage.getItem("list-history-fromDate"),l=sessionStorage.getItem("list-history-toDate"));var c=new d({id:this.model.get("officialVersion").id,officialId:this.model.get("officialVersion").id});t=="APPROVE"?url=["/api/approval/official/approve",this.model.getOfficialId()].join("/"):t=="RETURN"&&(url=["/api/approval/official/return",this.model.getOfficialId()].join("/"));var p=e.param({comment:e("#textarea-desc").val()});url+="?"+p;var v=c.save({},{type:"PUT",url:url,success:function(e,i){n.allowAction=!0,i.code==200&&(t=="APPROVE"||t=="RETURN")&&(sessionStorage.setItem("list-history-pageNo",0),r.util.navigateToBackList())},error:function(e,t){n.allowAction=!0;var r=JSON.parse(t.responseText);return r.message?(alert(r.message),!1):(alert(h["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),!1)}});r.util.preloader(v)},actionApprValidate:function(t,n){var i=e(t).val(),s=1e3;return n=="RETURN"&&e.trim(i)==""?(setTimeout(function(){alert(h["\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694"])},10),!1):i&&i.length>s?(setTimeout(function(){alert(r.i18n(h["{{max}}\uc790 \uc774\ud558\ub85c \uc785\ub825\ud574 \uc8fc\uc2ed\uc2dc\uc624"],{max:s}))},10),!1):!0},show_document:function(){var t=this;this.documentView.$el.parent().show(),this.decideIscrollInit(),e(window).on("orientation",function(){t.decideIscrollInit()})},show_official_doc_receiver:function(){this.documentView.$el.parent().hide(),this.decideIscrollInit()},decideIscrollInit:function(){e(document).width()<this.documentView.$el.width()&&r.util.initDetailiScroll("document_iscroll","document_hscroll","document_view")},actList:function(e){var t=sessionStorage.getItem("list-history-baseUrl");t?r.router.navigate(t,{trigger:!0}):r.router.navigate("approval",{trigger:!0})},docActionRelease:function(){this.headerToolbarView.render(this.toolBarData),this.$el.find("#document_main").show(),this.$el.find("#document_action").hide(),this.$el.find("#selectAction").val(""),this.documentAction.release()},assign:function(e,t){e.setElement(this.$(t)).render()},append:function(e,t){this.$(t).append(e.render().el)}},{__instance__:null,create:function(){return this.__instance__=new this.prototype.constructor({el:e("#content")}),this.__instance__},render:function(){var e=this.create(),t=arguments.length>0?Array.prototype.slice.call(arguments):[];return this.prototype.render.apply(e,t)}});return v})}).call(this);