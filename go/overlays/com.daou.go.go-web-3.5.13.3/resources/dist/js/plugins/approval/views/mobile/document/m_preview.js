(function(){define(["jquery","backbone","approval/models/ref_document","approval/views/mobile/document/m_attach_file","hgn!approval/templates/mobile/document/m_preview","hgn!approval/templates/mobile/document/m_reference_doc_view","i18n!nls/commons","i18n!approval/nls/approval","GO.util","iscroll"],function(e,t,n,r,i,s,o,u){var a={confirm:o["\ud655\uc778"],cancel:o["\ucde8\uc18c"],attach_file:u["\ucca8\ubd80\ud30c\uc77c"],ref_doc:u["\uad00\ub828\ubb38\uc11c"],view:u["\ubcf4\uae30"],preview:u["\ubbf8\ub9ac\ubcf4\uae30"],amt:u["\uac1c"],"\uc6d0\ubcf8\ubb38\uc11c":u["\uc6d0\ubcf8\ubb38\uc11c"]},f=t.View.extend({initialize:function(t){_.bindAll(this,"render"),this.options=t||{},this.docId=t.docId,this.title=t.title||a.preview,this.docBody=e.goFormUtil.convertViewMode(this.options.docBody),this.attaches=this.options.attaches,this.references=this.options.references,this.images=[],this.files=[],this.callback=_.isFunction(this.options.callback)?this.options.callback:this.back,_.isNull(t.isDocReadAuthority)?this.isDocReadAuthority=!0:this.isDocReadAuthority=t.isDocReadAuthority},id:"mobileDocPreview",attributes:{"data-role":"layer",style:"background:#fff; position:absolute; width:100%; min-height:100%; top:0; left:0; z-index:999"},unbindEvent:function(){this.$el.off("vclick","a[data-btn='cancel']")},bindEvent:function(){this.$el.on("vclick","a[data-btn='cancel']",e.proxy(this.callback,this))},events:{"vclick ul.feed_img a.imageview":"showImages","vclick ul.file_wrap a.filedown":"showFiles","vclick ul.file_wrap span.name a":"showFiles","vclick li a.preview":"preview","vclick li a.wrap_ic_file_preview":"preview"},render:function(){this.unbindEvent(),this.bindEvent();var t=this,n="length_",r=0;e.each(this.attaches,function(e,n){n.byteSize=n.size,n.size=GO.util.getHumanizedFileSize(n.size),n.thumbSmall?t.images.push(n):(GO.util.fileExtentionCheck(n.extention)||(n.extention="def"),t.files.push(n))}),this.$el.html(i({title:this.title,docBody:this.docBody,hasFiles:this.files.length?!0:!1,files:this.files,docId:this.docId,isDocReadAuthority:this.isDocReadAuthority,contextRoot:GO.contextRoot,hasImages:this.images.length?!0:!1,getImageClass:function(){return t.images.length<=4?n+t.images.length:t.images.length==5?n+3:t.images.length==6?n+3:n+4},midImageSize:function(){return t.images.length==1?!0:!1},smallImageSize:function(){return t.images.length>1?!0:!1},isGif:function(){return this.extention.toLowerCase()=="gif"?!0:!1},reoffsetImg:function(){return t.images.length==1?!1:"if($(this).parents('li').height() > this.height) { this.style.marginTop = ($(this).parents('li').height()-this.height)/2 + 'px'; } "},images:this.images,isMobile:GO.util.isMobile()})),this.$el.find("div#refDocPart").append(s({lang:a,data:function(){var e=t.receptionOrigin;return!e||0?{references:t.references}:{references:_.filter(t.references,function(t){return t.id!=e.id}),receptionOriginInReferences:_.find(t.references,function(t){return t.id==e.id})}}})),this.$el.css("height",e(document).height()+"px"),e("body").append(this.el),GO.util.initDetailiScroll("preview_doc_iscroll","preview_doc_hscroll","preview_document",!0,20,!0)},showFiles:function(t){var n=e(t.currentTarget),r=location.protocol+"//"+window.location.host,i=GO.contextRoot+"api/approval/document/"+this.docId+"/download/"+n.attr("data-id"),s=n.attr("title"),o=n.attr("data-size");return GO.util.attachFiles(r+i,s,o),!1},showImages:function(t){var n=[],r=0;return $eTarget=e(t.currentTarget),selectedId=$eTarget.attr("data-id"),n.push({fileName:$eTarget.attr("title"),url:GO.contextRoot+"api/approval/document/"+this.docId+"/download/"+$eTarget.attr("data-id")}),GO.util.attachImages(n,r),!1},resize:function(t){if(!t)return!1;var n=e.Deferred(),r=t.find(".feed_img >li[data-resize!=true]"),i=r.length;return i&&e(r).each(function(t,n){var r=e(n),s=r.find("img");s.attr("src",s.attr("data-src")),i>1&&r.height(r.width()).attr("data-resize",!0)}),n.resolveWith(this,[this]),n},back:function(e){return window.history.back(),e&&e.stopPropagation(),!1},release:function(){this.$el.off(),this.$el.empty()},preview:function(t){var n=e(t.currentTarget);return GO.util.preview(n.attr("data-id")),!1}});return f})}).call(this);