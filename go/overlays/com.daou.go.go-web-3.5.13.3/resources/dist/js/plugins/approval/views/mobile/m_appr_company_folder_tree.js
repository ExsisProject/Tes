(function(){define(["underscore","backbone","amplify","app","hgn!approval/templates/mobile/m_treeItemList","hgn!approval/templates/mobile/m_treeItemChildList","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o){var u=t.Collection.extend({}),a=t.View.extend({apiCommonUrl:null,isAdmin:!1,treeElementId:null,selectCallback:null,disabledSelect:!1,folderId:null,disabledClassName:"disable",ulTagClassName:"side_depth",toggleIconOpenClassName:"close",toggleIconCloseClassName:"open",initialize:function(t){this.options=t||{},e.isString(this.options.treeElementId)&&(this.treeElementId=this.options.treeElementId),e.isString(this.options.apiCommonUrl)&&(this.apiCommonUrl=this.options.apiCommonUrl),e.isBoolean(this.options.isAdmin)&&(this.isAdmin=this.options.isAdmin),e.isBoolean(this.options.disabledSelect)&&(this.disabledSelect=this.options.disabledSelect),e.isFunction(this.options.selectCallback)&&(this.selectCallback=this.options.selectCallback),this.folderId=this.options.folderId,this.collection=new u,this.collection.url=this._getCommonUrl(),this.collection.fetch({async:!1}),this.bindEvents()},bindEvents:function(){this._getTreeElement().off("click","span[evt-rol=toggle-folder"),this._getTreeElement().off("click","li.folder a"),this._getTreeElement().on("click","span[evt-rol=toggle-folder]",$.proxy(this._toggleSlide,this)),this._getTreeElement().on("click","li.folder a",$.proxy(this._select,this))},_getTreeElement:function(){return $("#"+this.treeElementId)},_getTargetElementById:function(e){return $(this._getTreeElement().find("li[data-id="+e+"]"))},_toggleSlide:function(e){var t=$(e.target),n=t.attr("status"),r=t.closest("li").attr("data-id");n=="opened"?this._closeNode(r):this._openNode(r)},_loadChildrenData:function(e){if(e){this._getTargetElementById(e).append(this._wrapUltag()),this.collection.url=this._getCommonUrl()+"?folderId="+e,this.collection.fetch({async:!1}),this._drawTreeAppendTarget(e);var t=this._getTargetElementById(e),n=$(t.find('> p > span[evt-rol="toggle-folder"]'));n.attr("childrenLoaded",1)}},getFullPathName:function(){var e=this._getSelectedNode(),t=[],n="",r={},i;if(e.length>0){var s=$(e).parentsUntil(this._getTreeElement()).filter("li").length,o=$(e);for(var u=0;u<s+1;u++)r={name:o.find("span.txt").eq(0).text()},t.push(r),o=$(o).parent().closest("li");var a=$(t).length;$($(t).get().reverse()).each(function(e,t){e===a-1?n+=t.name:n+=t.name+" > "})}return n},_getData:function(e){var t={},n=this._getTargetElementById(e);return t={id:$(n).attr("data-id"),name:$(n).find("span.txt").eq(0).text(),rel:$(n).attr("rel"),auth:$(n).attr("data-auth")},t},_getSelectedNode:function(){return $(this._getTreeElement()).find("p.on").closest("li")},_getSelectedNodeData:function(){var e=this._getSelectedNode().attr("data-id");return this._getData(e)},_drawTreeAppendTarget:function(e){var t=this,n=this.collection.toJSON(),r=this._getTargetElementById(e).find("ul").eq(0),i=this.disabledClassName,o=this.toggleIconCloseClassName;$(n).each(function(e,t){var n=!1;t.metadata.children.length>0?n=!0:n=!1,r.append(s({rel:t.data.attr.rel,model:t.metadata,hasChildren:n,disabledClassName:i,toggleIconCloseClassName:o}))})},_openNode:function(e){var t=this,n=this._getTargetElementById(e),r=$(n.find('> p > span[evt-rol="toggle-folder"]'));if(n.length==0||r.length==0)return console.log("no exist"),!1;var i=n.find('> p > span[evt-rol="toggle-folder"]').attr("status"),s=n.find('> p > span[evt-rol="toggle-folder"]').attr("childrenLoaded");if(i=="opened")return!1;s==0?(this._loadChildrenData(e,r),this._targetOpenStyle(r)):this._targetOpenStyle(r),n.children("ul").show()},_openNodeAll:function(){var e=this,t=[],n=this._getTreeElement().find('span[evt-rol="toggle-folder"]');$(n).each(function(e,n){$(n).attr("status")=="closed"&&t.push($(n).closest("li").attr("data-id"))}),$(t).each(function(t,n){e._openNode(n)});var r=this._checkStatusAllToggleIcon("closed");r&&this._openNodeAll()},_checkStatusAllToggleIcon:function(e){var t=!1,n=this._getTreeElement().find('span[evt-rol="toggle-folder"]');return $(n).each(function(n,r){$(r).attr("status")==e&&(t=!0)}),t},_closeNode:function(e){var t=this,n=this._getTargetElementById(e),r=$(n.find('> p > span[evt-rol="toggle-folder"]'));if(n.length==0||r.length==0)return!1;var i=n.find('> p > span[evt-rol="toggle-folder"]').attr("status"),s=n.find('> p > span[evt-rol="toggle-folder"]').attr("childrenLoaded");if(i=="closed")return!1;this._targetCloseStyle(r),n.children("ul").hide()},_targetOpenStyle:function(e){e.removeClass(this.toggleIconCloseClassName).addClass(this.toggleIconOpenClassName),e.attr("status","opened")},_targetCloseStyle:function(e){e.removeClass(this.toggleIconOpenClassName).addClass(this.toggleIconCloseClassName),e.attr("status","closed")},_isSelectAble:function(e){return!this.disabledSelect&&e.hasClass(this.disabledClassName)?!1:!0},_select:function(t){var n=this;obj=$(t.currentTarget);if(!this._isSelectAble(obj))return!1;if(obj&&e.isFunction(this.selectCallback)){var r=obj.closest("li").attr("data-id"),i=n._getData(r);this.selectCallback(i)}this._highlightStyle(obj.closest("li").attr("data-id"))},_highlightStyle:function(e){this._removeAllHighlightStyle(),this._getTargetElementById(e).find("p:first").addClass("on")},_removeAllHighlightStyle:function(){this._getTreeElement().find("p.on").removeClass("on")},_getCommonUrl:function(){return e.isEmpty(this.apiCommonUrl)?this.isAdmin?r.contextRoot+"ad/api/approval/manage/companyfolder":r.contextRoot+"api/approval/companyfolder/tree":r.contextRoot+this.apiCommonUrl},render:function(){this._init_load(),this._openNodeAll();var e=this.folderId;e&&this._highlightStyle(e)},_init_load:function(){var e=this,t=this.collection.toJSON(),n=this.disabledClassName;this._getTreeElement().append(this._wrapUltag()),$(t).each(function(t,r){var s=!1;r.metadata.children.length>0?s=!0:s=!1,e._getTreeElement().find("ul").eq(0).append(i({rel:r.data.attr.rel,model:r.metadata,disabledClassName:n,hasChildren:s}))})},_wrapUltag:function(){return"<ul class='"+this.ulTagClassName+"'></ul>"},selectCallback:function(){}});return a})}).call(this);