(function(){define(["jquery","backbone","app","hgn!approval/templates/mobile/document/m_doc_receive","i18n!nls/commons","i18n!approval/nls/approval","GO.util","iscroll"],function(e,t,n,r,i,s){var o=t.Collection.extend({initialize:function(t){this.options=t||{},this.docId=this.options.docId,this.deptId=e(this.options.deptId).get()},model:t.Model.extend(),url:function(){return"/api/approval/document/"+this.docId+"/receptionreader/"+this.deptId}}),u=t.Collection.extend({initialize:function(){}}),a=t.Collection.extend({initialize:function(){},url:function(){var e=GO.config("contextRoot")+"api/organization/list?"+this.deptIdsParam+"&type=custom&scope=none";return e},setDeptIdsUrlParam:function(t){var n="",r=[];_.isArray(t)&&t.length==1?(n=t.slice(0,1),r.push("deptid="+n)):_.isArray(t)&&t.length>1&&(n=t.slice(0,1),r.push("deptid="+n),e(t).slice(1).each(function(e,t){r.push("includeDeptIds[]="+t)})),this.deptIdsParam=e(r).get().join("&")}}),f=t.View.extend({id:"mobileOrg",attributes:{"data-role":"layer",style:"background:#fff; position:absolute; width:100%; min-height:100%; top:0; left:0; z-index:999"},unbindEvent:function(){this.$el.off("vclick","a[data-btn='cancel']"),this.$el.off("vclick","a[data-btn='ok']"),this.$el.off("vclick","li span.ic_del"),this.$el.off("change","ul#userListEls input[value]"),this.$el.off("change","input#userCheckedAll")},bindEvent:function(){this.$el.on("vclick","a[data-btn='cancel']",e.proxy(this.back,this)),this.$el.on("vclick","a[data-btn='ok']",e.proxy(this.checkedSave,this)),this.$el.on("vclick","ul#userCheckedEls span.ic_del",e.proxy(this.deleteUserEl,this)),this.$el.on("change","ul#userListEls input[value]",e.proxy(this.changeCheckedUser,this)),this.$el.on("change","input#userCheckedAll",e.proxy(this.changeCheckedAll,this))},initialize:function(t){var n=this;this.options=t||{},this.$listEl=null,this.$checkedUserEl=null,this.checkedUserScroll=null,this.docReceive=null,this.checkedUser=null,this.docId=this.options.docId,this.deptId=this.options.receptAddDeptId;var r={offset:100,btn_ok:i["\ud655\uc778"],btn_cancel:i["\ucde8\uc18c"]};e.extend(this.options,r),this.docReceive=new o({docId:n.docId,deptId:n.deptId}),this.docReceive.fetch({async:!1}),this.checkedUser=this.docReceive.toJSON(),this.tplUnit={search_result:Hogan.compile('<div class="search_result"><input type="checkbox" id="userCheckedAll"><span class="txt">{{search_result}} {{{totalCount}}}</span></div>'),listUser:Hogan.compile('<li><input type="checkbox" value="{{metadata.id}}" id="userSort{{metadata.id}}" {{checked}}><label for="userSort{{data.id}}"><a class="tit" data-bypass><div class="photo"><img src="{{metadata.thumbnail}}"></div><div class="info"><span class="name txt_ellipsis">{{metadata.name}} {{metadata.position}}</span><span class="mail txt_ellipsis">{{metadata.email}} {{deptName}}</span></div></a></label></li>'),listNull:Hogan.compile('<li class="creat data_null"><span class="txt">{{search_result_null}}</span></li>'),checkedUser:Hogan.compile('<li data-userid="{{metadata.id}}"><span class="name">{{metadata.name}} {{metadata.position}}</span><span class="btn_wrap" data-btntype="attendeeDelete"><span class="ic ic_del"></span></span></li>')},this.collection=new a,this.childCollection=new u,this.collection.on("reset",function(t,r){var i=[],s=n.getCheckedIds(),o;_.each(t.models,function(e,t){o=e.get("metadata").name,_.each(e.get("children"),function(e,t){e.deptName=o,n.childCollection.add(e)})}),e.each(n.childCollection.toJSON(),function(t,r){i.push(n.tplUnit.listUser.render(e.extend(r,{checked:e.inArray(r.metadata.id,s)>-1?"checked":""})))}),i.length||i.push(n.tplUnit.listNull.render(n.options)),n.$listEl.html(i.join(""))})},render:function(){var t=this;this.unbindEvent(),this.bindEvent(),this.options=e.extend(this.options,arguments[0]||{}),this.$el.html(r(this.options)),this.$listEl=this.$el.find("ul#userListEls"),this.$checkedUserEl=this.$el.find("ul#userCheckedEls"),e("body").append(this.el),this.getUserList("",this.deptId);var n={};e.each(this.checkedUser||[],function(e,r){n={id:r.reader.id,name:r.reader.name,position:r.reader.position,deptId:r.reader.deptId},t.addCheckedUserEl({metadata:n})})},getUserList:function(t,n){this.collection.setDeptIdsUrlParam(n),this.collection.fetch({async:!0,reset:!0}),e("#mobileOrg").css("min-height",e("#main").height()+"px")},getCheckedIds:function(){return e(this.$checkedUserEl.find("li")).map(function(t,n){return Number(e(n).attr("data-userid"))}).get()},getCheckedData:function(){return e(this.$checkedUserEl.find("li")).map(function(t,n){return e(n).data()}).get()},changeCheckedUser:function(t){var n=e(t.currentTarget),r=n.val(),i=n.is(":checked"),s=null;this.$checkedUserEl.find('li[data-userid="'+r+'"]').remove();if(i){var o;o=this.childCollection.find(function(e){return r==e.toJSON().metadata["id"]}),s=o.toJSON(),this.addCheckedUserEl(s)}this.checkedSameUser(r,i),this._toggleCheckedScrollCss()},checkedSameUser:function(e,t){this.$listEl.find('input[value="'+e+'"]').attr("checked",t)},changeCheckedAll:function(t){var n=e(t.currentTarget),r=n.is(":checked"),i='input[type="checkbox"]'+(r?'[checked!="checked"]':":checked");e.each(this.$listEl.find(i),function(t,n){e(n).trigger("click")})},deleteUserEl:function(t){var n=e(t.currentTarget).parents("li");this.$listEl.find('input[type="checkbox"][value="'+n.data("userid")+'"]').removeAttr("checked"),n.remove(),this._toggleCheckedScrollCss();return},addCheckedUserEl:function(t){var n=this.$el.find("#userCheckedScroll");if(this.checkedUserScroll==null){n.css({position:"relative","max-height":"98px"}).find("ul").css({padding:"5 0"});var r=!GO.util.isMobileApp()&&(GO.util.checkOS()=="iphone"||GO.util.checkOS()=="ipad");this.checkedUserScroll=new IScroll("#userCheckedScroll",{bounce:!1,disablePointer:!0,disableMouse:!1,disableTouch:r,preventDefault:r}),r||(this.checkedUserScroll.on("zoomStart",function(t){e("#userCheckedScroll").css("overflow-x","").css("overflow-y","")}),this.checkedUserScroll.on("zoomEnd",function(t){e("#userCheckedScroll").css("overflow-x","scroll").css("overflow-y","hidden")}))}else this.checkedUserScroll.refresh();var i=this.tplUnit.checkedUser.render(t);this.$checkedUserEl.append(e(i).data({id:t.metadata.id,name:t.metadata.name,position:t.metadata.position})),this._toggleCheckedScrollCss()},_toggleCheckedScrollCss:function(){var e=this.$el.find("#userCheckedScroll"),t=this.$checkedUserEl.find("li");t.length>0?e.attr("class","list_employee"):e.attr("class","")},checkedSave:function(t){if(confirm(s["\uc800\uc7a5\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])){t&&e(t.currentTarget).blur().trigger("focusout"),typeof this.options.callback=="function"&&this.options.callback(this.getCheckedData()),this.back();return}},back:function(e){return window.history.back(),e&&e.stopPropagation(),!1}});return f})}).call(this);