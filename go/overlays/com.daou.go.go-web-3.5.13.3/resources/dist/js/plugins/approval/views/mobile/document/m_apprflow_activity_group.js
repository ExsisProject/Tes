define(["backbone","approval/models/activity","approval/collections/activities","hgn!approval/templates/mobile/document/m_apprflow_activity_group","views/mobile/m_dept","approval/views/mobile/document/m_apprflow_sort","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-popup"],function(e,t,n,r,i,s,o,u){var a={edit:o["\ud3b8\uc9d1"],add_approval:u["\uacb0\uc7ac\uc790 \ucd94\uac00"],header:u["\uacb0\uc7ac \uc815\ubcf4"],save_as_my_line:u["\uac1c\uc778 \uacb0\uc7ac\uc120\uc73c\ub85c \uc800\uc7a5"],delete_as_my_line:u["\uac1c\uc778 \uacb0\uc7ac\uc120 \uc0ad\uc81c"],my_line_name:u["\uacb0\uc7ac\uc120 \uc774\ub984"],normal:u["\uc77c\ubc18"],my_lines:u["\ub098\uc758\uacb0\uc7ac\uc120"],draft:u["\uae30\uc548"],name:o["\uc774\ub984"],dept:u["\ubd80\uc11c"],line:u["\ub77c\uc778"],status:u["\uc0c1\ud0dc"],approval:u["\uacb0\uc7ac"],agreement:u["\ud569\uc758"],check:u["\ud655\uc778"],agreement_type:u["\ud569\uc758\ubc29\uc2dd"],agreement_linear:u["\uc21c\ucc28\ud569\uc758"],agreement_parallel:u["\ubcd1\ub82c\ud569\uc758"],activityType:u["\ud0c0\uc785"],add:o["\ucd94\uac00"],"delete":o["\uc0ad\uc81c"],confirm:o["\ud655\uc778"],cancel:o["\ucde8\uc18c"],inspection:u["\uac10\uc0ac"],add_activity:u["\ub4dc\ub798\uadf8\ud558\uc5ec \uacb0\uc7ac\uc120\uc744 \ucd94\uac00\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],msg_duplicate_activity:u["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."],msg_max_approval_count_exceed:u["\uacb0\uc7ac\uc790 \uc218\uac00 \ucd5c\ub300 \uacb0\uc7ac\uc790 \uc218\ub97c \ub118\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_selected:u["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_deletable_status_activity:u["\uc0ad\uc81c\ud560 \uc218 \uc5c6\ub294 \uc0c1\ud0dc\uc758 \uacb0\uc7ac\uc790 \uc785\ub2c8\ub2e4."],msg_not_deletable_assigned_activity:u["\uc9c0\uc815 \uacb0\uc7ac\uc790\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_save_success:o["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],msg_not_addable_position:u["\uc644\ub8cc\ub41c \uacb0\uc7ac \uc55e\uc5d0 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_duplicated_my_line_title:u["\uc911\ubcf5\ub41c \uc774\ub984\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_maxCount:u["\uacb0\uc7ac\uc790\ub97c \ucd5c\ub300\uce58\ubcf4\ub2e4 \ub118\uac8c \ud560\ub2f9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_assigned_deleted:u["\uc9c0\uc815 \uacb0\uc7ac\uc790\ub294 \uaf2d \ud3ec\ud568\ub418\uc5b4\uc57c \ud569\ub2c8\ub2e4."],msg_my_line_set_error_not_matching_group_count:u["\uacb0\uc7ac\uc120\uc758 \uac2f\uc218\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],msg_parallel_agreement_should_has_2_more_agreement:u["\ubcd1\ub82c\ud569\uc758\ub294 \uc5f0\uc18d\ub41c \ub458 \uc774\uc0c1\uc758 \ud569\uc758\uac00 \ud544\uc694\ud569\ub2c8\ub2e4."],msg_not_belong_to_department_user:u["\ubd80\uc11c\uac00 \uc5c6\ub294 \uc0ac\uc6a9\uc790\ub294 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_addable_before_draft:u["\uae30\uc548\uc790 \uc55e\uc73c\ub85c \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],notAddable:u["\uc774 \uacb0\uc7ac\uce78\uc5d0\ub294 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],msg_not_addable_item:u["\ud56d\ubaa9\uc744 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],not_allowed_apprgroup:u["\uc120\ud0dd\ud55c \ub300\uc0c1\uc740 \uc774 \uacb0\uc7ac\uadf8\ub8f9\uc5d0 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],data_null:u["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]},f=e.View.extend({observer:null,actionCheck:null,index:null,isNullGroup:!1,isArbitraryCheckVisible:!1,__disabled__:!1,events:{"click span.editSort":"_modifyApprFlowSort","change select":"_onTypeOptionChanged","click .btn_add":"_activityAddPopup"},initialize:function(e){e=e||{},this.index=e.index,this.observer=e.observer,this.actionCheck=e.actionCheck,this.isArbitraryCheckVisible=e.isArbitraryCheckVisible,this.isPermissibleArbitraryDecision=e.isPermissibleArbitraryDecision,_.isNull(this.model)&&(this.isNullGroup=!0),this.__disabled__=!1,e.disable&&this.disable(),this.isReceiveDoc=e.isReceiveDoc||!1,this.includeAgreement=e.includeAgreement,this.apprAllowType=e.apprAllowType,this.docStatus=e.docStatus},render:function(){var e={"isNullGroup?":this.isNullGroup,isArbitraryCheckVisible:this.isArbitraryCheckVisible,isPermissibleArbitraryDecision:this.isPermissibleArbitraryDecision,lang:a,disabled:this.isDisabled()};return this.isNullGroup||(e=_.extend(this._convertToTmplData(this.model),e),e.useCheckActivity=this.actionCheck.useCheckActivity,e.isNotAddableEmptyGroup=this.model.isNotAddableEmptyGroup(),e.isActivityEditable=this.actionCheck.isActivityEditable,e.isAssignedActivityDeletable=this.actionCheck.assignedActivityDeletable,e.isComplete=this.docStatus=="COMPLETE",e.isAddButtonShow=this._addApprovalButtonShow()),this.$el.html(""),this.$el.append(r(e)),this.activitySortView=new s({data:e,saveCallBack:$.proxy(function(e){$("#main .go_wrap").show(),this.model.sortActivitiesByUserIdAndDeptId(e),this.render()},this),cancelCallBack:function(){$("#main .go_wrap").show()}}),this},_addApprovalButtonShow:function(){return!this.isDisabled()},_modifyApprFlowSort:function(){$("#main").append(this.activitySortView.render().el),$("#main .go_wrap").hide(),this.activitySortView.$el.show()},_addActivity:function(e,t){if(_.isNull(e)||_.isUndefined(e)||_.isEmpty(e))return GO.util.toastMessage(a.msg_not_selected),!1;var n={};if(e["type"]=="MEMBER"||e["type"]=="MASTER"||e["type"]=="MODERATOR"||e["type"]=="user")n={isDept:!1,deptId:e.deptId,deptName:e.deptName,userId:e.id,userName:e.name,userDuty:e.duty,userPosition:e.position,displayName:e.displayName,thumbnail:e.thumbnail};else{if(e["type"]!="org")return!1;n={isDept:!0,deptId:e.id,deptName:e.name,userId:null,userName:null,userPosition:null,displayName:e.name}}return n.type=this.model.getValidApprovalType(this.actionCheck,n)&&this.model.getValidApprovalType(this.actionCheck,n).type,n.name=this.model.getValidApprovalType(this.actionCheck,n)&&this.model.getValidApprovalType(this.actionCheck,n).name,this.checkAddableActivity(n,t)?(this.model.addActivity(n,t),this.render(),!0):!1},disable:function(){this.__disabled__=!0},isDisabled:function(){return this.__disabled__},_convertToTmplData:function(e){var t=this,r=new n(e.get("activities")||[]),i=e.canUseApproval(this.actionCheck),s=e.canUseAgreement(this.actionCheck),o=e.canUseCheck(this.actionCheck),u=e.canUseInspection(this.actionCheck),a=this.isArbitraryCheckVisible,f=this.actionCheck.agreementAllowType||"ALL";return{groupName:e.get("name"),hasActivities:r.length>0,activities:r.map(function(n,l){var c=n.isCheck()&&!o||n.isAgreement()&&!s||n.isApproval()&&!i||n.isInspection()&&!u;return{status:n.get("status"),userId:n.get("userId"),userName:n.get("userName"),thumbnail:n.get("thumbnail"),deptId:n.get("deptId"),deptName:n.get("deptName"),activityType:n.get("name"),statusName:n.get("statusName"),activitiesCount:r.length,isAgreementType:n.isAgreement(),isApprovalType:n.isApproval(),isCheckType:n.isCheck(),isInspectionType:n.isInspection(),isDisabledAssignedCheckType:c,isApprovalTypeVisible:i||c&&n.isApproval(),isCheckTypeVisible:o||c&&n.isCheck(),isInspectionTypeVisible:u||c&&n.isInspection(),isAgreementTypeVisible:function(){var t=_.isNull(n.get("userId"))&&!_.isNull(n.get("deptId")),r=s||c&&n.isAgreement(),i=e.agreementAllowTypeValidate(f,t);return i||(r=!1),r},arbitraryCheckable:a&&n.isApproval(),isArbitraryChecked:n.isArbitraryChecked(),isLast:l+1===r.length?!0:!1,isEnabled:!t.__disabled__&&n.isDeletable(),isAssigned:n.get("assigned")}})}},_onRemoveButtonClicked:function(e){var t=$(e.currentTarget).hasClass("delete_activity")?$(e.currentTarget):$(e.currentTarget).hasClass("delete_activity").parent(),r=t.parent().parent(),i=r.attr("data-userId"),s=r.attr("data-deptId");i==""&&(i=null),s==""&&(s=null);var o=new n(this.model.get("activities")),u=o.getByUserIdAndDeptId(i,s);return this.checkRemovableActivity(u)?(this.model.removeActivityByUserIdAndDeptId(i,s),this.render(),!0):!1},checkAddableActivity:function(e,n){var r=this.actionCheck.agreementAllowType||"ALL";if(!this.isReceiveDoc)if(this.model.isAllApprovalTypeBlock(this.actionCheck)||_.isUndefined(e.type))return GO.util.toastMessage(a.not_allowed_apprgroup),!1;if(this.apprAllowType=="USER"&&e["isDept"]==1)return GO.util.toastMessage(a.not_allowed_apprgroup),!1;if(this.model.isExistActivity(e))return GO.util.toastMessage(a.msg_duplicate_activity),!1;if(!t.validate(e))return GO.util.toastMessage(a.msg_not_belong_to_department_user),!1;if(this.model.isFullMaxApprovalCount())return GO.util.toastMessage(a.msg_max_approval_count_exceed),!1;if(this.includeAgreement&&this.model.isFullMaxApprovalAndAgreementCount())return GO.util.toastMessage(a.msg_max_approval_count_exceed),!1;if(e["isDept"]==1){if(!this.model.canUseAgreement(this.actionCheck))return GO.util.toastMessage(a.not_allowed_apprgroup),!1;if(r=="USER")return GO.util.toastMessage(a.not_allowed_apprgroup),!1}return this.model.onlyCanAgreement(this.actionCheck)&&!this.model.agreementAllowTypeValidate(this.actionCheck.agreementAllowType,e.isDept)?(GO.util.toastMessage(a.not_allowed_apprgroup),!1):n!="last"&&!this.model.validateAddPosition(n)?(GO.util.toastMessage(a.msg_not_addable_position),!1):!0},checkRemovableActivity:function(e){return e.isAssigned()&&!this.actionCheck.assignedActivityDeletable?($.goMessage(a.msg_not_deletable_assigned_activity),!1):e.isDeletableStatus()?!0:($.goMessage(a.msg_not_deletable_status_activity),!1)},_removeEachActivityGroup:function(e,t){var e=e||null,t=t||null,r=new n(this.model.get("activities")),i=r.getByUserIdAndDeptId(e,t);return i.isAssigned()&&!this.actionCheck.assignedActivityDeletable?($.goMessage(a.msg_not_deletable_assigned_activity),!1):i.isDeletableStatus()?(this.model.removeActivityByUserIdAndDeptId(e,t),this.render(),!0):($.goMessage(a.msg_not_deletable_status_activity),!1)},_onTypeOptionChanged:function(e){var t=$(e.target),n=t.parent().parent(),r=n.attr("data-userId"),i=n.attr("data-deptId");this.model.setActivityType(r,i,t.val(),a[t.val().toLowerCase()]),this.render()},_onArbitraryClicked:function(e){var t=$(e.target),n=t.parent().parent(),r=n.attr("data-userId"),i=n.attr("data-deptId"),s=t.is(":checked");this.model.setArbitrarilyDecidable(r,i,s)},_activityAddPopup:function(e){var t=new i({type:"mydept",sendSelectedNodesCallback:$.proxy(function(e,t,n){return _.each(n,$.proxy(function(e){this._addActivity(e)},this)),e.$el.remove(),!1},this)});t.render()},getAddableApprType:function(){}});return f});