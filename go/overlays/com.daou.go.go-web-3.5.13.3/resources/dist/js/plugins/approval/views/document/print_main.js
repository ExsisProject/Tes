define(["backbone","app","approval/models/document","approval/models/appr_flow","approval/views/document/comments","approval/views/document/apprflow","approval/views/document/attach_file","hgn!approval/templates/document/print_main","hgn!approval/templates/document/print_toolbar","hgn!approval/templates/document/print_document","hgn!approval/templates/document/attach_file_view","hgn!approval/templates/doc_attaches_file","hgn!approval/templates/doc_attaches_img","hgn!approval/templates/document/reference_doc_view","i18n!nls/commons","i18n!approval/nls/approval","formutil","jquery.fancybox","jquery.go-popup","jquery.ui","json","json2","jquery.placeholder"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=n.extend({initialize:function(e,t){this.options=t||{},this.docId=this.options.docId,n.prototype.initialize.apply(this,arguments)},url:function(){var e="/api/approval/document/"+this.docId;return e},getShowUrl:function(){var e=this.docId.split("?")[0];return"/approval/document/"+e},getFullShowUrl:function(){return window.location.protocol+"//"+window.location.host+GO.contextRoot+"app"+this.getShowUrl()}},{create:function(e){return new m({},{docId:e})}}),g={"\uacb0\uc7ac\ubb38\uc11c\uba85":v["\uacb0\uc7ac\ubb38\uc11c\uba85"],"\uae30\uc548\uc790":v["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc790":v["\uacb0\uc7ac\uc790"],"\uae30\uc548\uc758\uacac":v["\uae30\uc548\uc758\uacac"],"\uacb0\uc7ac\uc758\uacac":v["\uacb0\uc7ac\uc758\uacac"],"\ub313\uae00":d["\ub313\uae00"],"\uacb0\uc7ac\ube44\ubc00\ubc88\ud638":v["\uacb0\uc7ac\ube44\ubc00\ubc88\ud638"],"\uc804\uacb0":v["\uc804\uacb0"],"\uc804\uacb0\uc124\uba85":v["\uc804\uacb0\uc124\uba85"],"\uacb0\uc7ac\uc635\uc158":v["\uacb0\uc7ac\uc635\uc158"],"\uacb0\uc7ac\uc120":v["\uacb0\uc7ac\uc120"],"\ubb38\uc11c\uc815\ubcf4":v["\ubb38\uc11c\uc815\ubcf4"],"\ubcc0\uacbd\uc774\ub825":v["\ubcc0\uacbd\uc774\ub825"],"\uacf5\ubb38\ubc1c\uc1a1":v["\uacf5\ubb38\ubc1c\uc1a1"],"\uc778\uc1c4 \ubbf8\ub9ac\ubcf4\uae30":d["\uc778\uc1c4 \ubbf8\ub9ac\ubcf4\uae30"],"\uc778\uc1c4":d["\uc778\uc1c4"],"\uc5f4\ub78c\uc790 \ucd94\uac00":v["\uc5f4\ub78c\uc790 \ucd94\uac00"],"\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694":v["\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694"],"\ubaa9\ub85d\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4":v["\ubaa9\ub85d\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4"],"\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud574\uc8fc\uc138\uc694":v["\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud574\uc8fc\uc138\uc694"],"\ub2f4\ub2f9\uc790\uac00 \uc9c0\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4":v["\ub2f4\ub2f9\uc790\uac00 \uc9c0\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4"],"\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4":v["\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],img_attach:d["\uc774\ubbf8\uc9c0 \ucca8\ubd80"],file_attach:d["\ud30c\uc77c \ucca8\ubd80"],del:d["\uc0ad\uc81c"],confirm:d["\ud655\uc778"],cancel:d["\ucde8\uc18c"],save:d["\uc800\uc7a5"],noti:d["\uc54c\ub9bc"],doc_search:v["\ubb38\uc11c \uac80\uc0c9"],attach_file:v["\ucca8\ubd80\ud30c\uc77c"],ref_doc:v["\uad00\ub828\ubb38\uc11c"],view:v["\ubcf4\uae30"],preview:v["\ubbf8\ub9ac\ubcf4\uae30"],amt:v["\uac1c"],msg_no_approval_document:v["\uacb0\uc7ac \ubb38\uc11c\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694"],msg_duplicate_approval_document:v["\uc911\ubcf5\ub41c \uad00\ub828\ubb38\uc11c\uac00 \uc788\uc2b5\ub2c8\ub2e4"],"\uc6d0\ubcf8\ubb38\uc11c":v["\uc6d0\ubcf8\ubb38\uc11c"]},y=e.View.extend({events:{"click span#addRelatedDocument":"onAddRelatedDocumentClicked","click span.ic_del":"attachDelete","click #refDocPart a.btn_fn4":"refPreviewBtnClicked","click #refDocPart span.name":"refPreviewTitleClicked","click #refDoc a.btn_fn4":"refPreviewBtnClicked","click #refDoc span.name":"refPreviewTitleClicked","click a[data-func]":"attachPreview"},initialize:function(e){this.options=e||{},this.formOpts={},_.bindAll(this,"render","setViewMode"),this.docType=this.options.type,this.docId=this.options.docId,this.docModel=this.options.model,this.infoModel=this.options.infoData,this.apprFlowModel=this.options.apprFlowModel,this.actionModel=this.options.actionModel,this.userApprSettingModel=this.options.userApprSettingModel,this.mode="VIEW"},render:function(){var e=this,t=this.infoModel.formScriptType,n=this.infoModel.externalScript,r=this.infoModel.scriptBody;return this.$el.html(f({lang:g,data:this.docModel})),this.docContents=$("#document_content"),this.initAttachFileView(),this.$el.find("div#attachView").append(p({lang:g,data:function(){var t=e.docModel.receptionOrigin;return!t||0?{references:e.docModel.references}:{references:_.filter(e.docModel.references,function(e){return e.id!=t.id}),receptionOriginInReferences:_.find(e.docModel.references,function(e){return e.id==t.id})}}})),t=="SRC"&&!_.isEmpty(n)?this.renderIntegrationByExternalScript({mode:"view",moduleName:n}):t=="EDIT"&&!_.isEmpty(r)?this.renderIntegrationByScriptText({mode:"view",scriptBody:r}):this.setViewMode(),this},renderIntegrationByExternalScript:function(e){var t=this,n=e.moduleName,r=e.mode,i=null;_.isEmpty(n)?console.log("module name Empty!!"):require([n],function(e){_.isUndefined(e)||(i=new e({variables:_.clone(t.docModel.variables),docModel:t.docModel,infoData:t.infoModel}),t.setViewMode(),_.isFunction(i.renderViewMode)&&i.renderViewMode())})},renderIntegrationByScriptText:function(e){var t=this,n=e.mode,r=e.scriptBody,i,s=new Function(r);if(s){var o=new s;i=new o({variables:_.clone(t.docModel.variables),docModel:t.docModel,infoData:t.infoModel}),t.setViewMode(),_.isFunction(i.renderViewMode)&&i.renderViewMode()}else console.log("scriptBody is Empty")},initAttachFileView:function(){_.isEmpty(this.docModel.attaches)||o.appendTo(this.$el.find("div#attachView"),this.docModel.attaches,this.userApprSettingModel,this.docId)},setViewMode:function(){this.mode="VIEW",GO.util.store.set("document.docMode",this.mode,{type:"session"}),$(this.el).find("div#editView").hide(),$(this.el).find("div#attachView").show(),$(this.el).find("section.article_reply").show();var e=$.goFormUtil.convertViewMode(GO.util.escapeXssFromHtml(this.docModel.docBodyContent));e=this.convertSelect(e),this.docContents.html(e),this.setApprovalData(),this.setApprovalDataCorrectHeight()},setApprovalDataCorrectHeight:function(){var e=$("#document_content").prop("scrollHeight"),t=$("#document_content").height(),n=$("#toolbar").outerHeight();e-n>t&&$("#document_content").height(e-n)},setApprovalData:function(){var e={preserveDuration:this.showPreserveYears(this.infoModel.docYear)};$("#document_content").setApprovalData(e)},showPreserveYears:function(e){return e==0?v["\uc601\uad6c"]:e+v["\ub144"]},convertSelect:function(e){var t=$(e);return $.each(t.find("select"),function(e,t){var n=$(t).parent("span"),r=n.attr("data-selecttext");$(t).remove(),n.text(r)}),t},onAddRelatedDocumentClicked:function(){var e=$.goPopup({pclass:"layer_normal layer_doc_attach",header:v["\uacb0\uc7ac \ubb38\uc11c \ucca8\ubd80"],modal:!0,width:"800px",contents:"",buttons:[{btext:d["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){var t=$("#reference_tbody tr"),n=0,r=[],i=[],s=[];$(t).each(function(e,t){$(t).find("input[type=checkbox]").is(":checked")&&(n++,r.push($(t).find("input[type=checkbox]").attr("data-id")),i.push($(t).find("input[type=checkbox]").attr("data-docnum")),s.push($(t).find(".subject").text()))});if(n==0)return $.goError(g.msg_no_approval_document),!1;var o=[],u=$("#refDocPart").find("li[data-id]"),a=!1;$(u).each(function(e,t){o.push($(t).attr("data-id"))}),$(r).each(function(e,t){$(o).each(function(e,n){t==n&&(a=!0)})});if(a)return $.goError(g.msg_duplicate_approval_document),!1;for(var f=0;f<n;f++){var l='<li data-id="'+r[f]+'" data-name="'+s[f]+'">'+'<span class="item_file">'+'<span class="name" data-id="'+r[f]+'">['+i[f]+"] "+s[f]+"</span>"+'<span class="optional">'+'<a class="btn_fn4"><span class="txt">'+g.preview+"</span></a>"+'<span class="btn_wrap" title="'+g.del+'">'+'<span class="ic_classic ic_del"></span>'+"</span>"+"</span>"+"</span>"+"</li>";$("#refDocPart").find("ul.file_wrap").append(l)}e.close()}},{btext:d["\ucde8\uc18c"],btype:"cancel"}]}),t=new RelatedDocumentAttachView({});t.render(),e.reoffset()},attachPreview:function(e){var t=$(e.currentTarget);return GO.util.preview(t.attr("data-id")),!1},refPreviewBtnClicked:function(e){var t=$(e.currentTarget).parents("li").data("id");this.previewRefDoc(t)},refPreviewTitleClicked:function(e){this.refPreviewBtnClicked(e)},previewRefDoc:function(e){var t=window.location.protocol+"//"+window.location.host+GO.contextRoot+"app/approval/document/"+this.docId+"/preview/reference/"+e;window.open(t,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},setAttaches:function(){var e=[],t=[];$.each(this.model.attaches,function(n,r){r.thumbSmall?e.push(r):t.push(r)});var n=function(){var e="def";return GO.util.fileExtentionCheck(this.extention)&&(e=this.extention),e},r=function(){var e=this.size,t=GO.util.getHumanizedFileSize(e);return t};this.$el.find("#fileWrap").html(c({dataset:t,checkFileType:n,sizeCal:r,contextRoot:GO.contextRoot})),this.$el.find("#imgWrap").html(h({dataset:e,sizeCal:r}))},getTitle:function(){return this.docContents.getApprovalSubject()}}),b=e.View.extend({el:"#content",initialize:function(e){this.options=e||{},this.formId=this.options.formId,this.docId=this.options.docId,this.type=_.isUndefined(this.options.type)?"DOCUMENT":this.options.type,this.model=m.create(this.docId),this.documentInit(),this.unbindEvent(),this.bindEvent(),this.commentsView=new i({docId:this.docId,dateFormat:"basicDate",comments:this.model.comments})},render:function(){this.allowAction=!0;if(this.model.get("document")==null)return;this.$el.html(u({lang:g})),this.$el.prepend(a({lang:g})),this.assign(this.documentView,"div.approval_type"),this.append(this.apprFlowView,"div.doc-meta-container"),this.commentsView.setElement($(this.el).parent().find("#commentSection")).render(),this.setReadOnlyModeCommentView(this.commentsView),this.setApprFlowStyle(),this.toggleDisplay(),$("body").addClass("print"),GO.util.isIE8()&&$("body").css("min-width","300px")},unbindEvent:function(){this.$el.parent().off("click","#toolbar input[type='chk']"),this.$el.parent().off("click","#printDoc")},bindEvent:function(){this.$el.parent().on("click","#toolbar input[name='chk']",$.proxy(this.toggleDisplay,this)),this.$el.parent().on("click","#printDoc",$.proxy(this.printDoc,this))},setReadOnlyModeCommentView:function(e){var t=['<li class="view_option" data-role="button" style="display:">','    <span class="ic_classic ic_reply"></span>','<span class="txt_b">{{lang.\ub313\uae00}}<span class="num" id="replyCount">{{commentsCount}}</span></span>',"</li>"],n=Hogan.compile(t.join(""));e.$el.find("ul.reply").prepend(n.render({lang:g,commentsCount:this.model.get("document").comments.length})),e.$el.find("#comment_creat").remove(),e.$el.find(".btn_wrap").remove()},printDoc:function(){GO.util.print(this.$el)},toggleDisplay:function(){var e=$("#commentChecked").is(":checked"),t=$("#apprChecked").is(":checked");t?$(this.el).find("#apprSection").show():$(this.el).find("#apprSection").hide(),e?$(this.el).find("#commentSection").show():$(this.el).find("#commentSection").hide()},docInitError:function(e,t){var n=this,r=function(){n.options.isPopup?window.close():n.navigateToBackList()};$.goAlert(v["\uacb0\uc7ac\ubb38\uc11c\ub97c \uc5f4\ub78c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],e,null,d["\ub2eb\uae30"],r)},documentInit:function(){var e=this;this.model.fetch({async:!1,success:function(t,n){e.title=_.isUndefined(t.get("document").title)?t.get("document").formName:t.get("document").title,e.initDocument()},error:function(t,n){var r=d["500 \uc624\ub958\ud398\uc774\uc9c0 \ub0b4\uc6a9"];$.parseJSON(n.responseText).message&&(r=$.parseJSON(n.responseText).message),n.status==400&&e.docInitError(r),n.status==403&&e.docInitError(v["\uc870\ud68c\uad8c\ud55c\uc5c6\uc74c"]),n.status==404&&e.docInitError(r),n.status==500&&e.docInitError(r),n.status!=400&&n.status!=403&&n.status!=404&&n.status!=500&&e.docInitError(r)},reset:!0})},initDocument:function(){this.docId=this.model.get("document").documentId,this.documentView=new y({type:this.type,docId:this.model.get("document").documentId,model:this.model.get("document"),apprFlowModel:this.model.get("apprFlow"),userApprSettingModel:this.model.get("userApprSetting"),infoData:this.model.get("docInfo"),isPopup:this.options.isPopup}),this.apprFlowView=new s({type:this.type,docId:this.model.get("document").documentId,model:new r(this.model.get("apprFlow"))})},setApprFlowStyle:function(){var e=['<li class="view_option" data-role="button" style="display:">','    <span class="ic_classic ic_reply"></span>','<span class="txt_b">{{lang.\uacb0\uc7ac\uc758\uacac}}<span class="num">{{activityCount}}</span></span>',"</li>"],t=0;_.each(this.model.get("apprFlow").activityGroups,function(e,n){_.each(e.activities,function(e,n){t++})});var n=Hogan.compile(e.join(""));this.$("div.doc-meta-container .reply").prepend(n.render({lang:g,activityCount:t}));var r=this.$("div.doc-meta-container").find("form").html();this.$("div.doc-meta-container").find("form").replaceWith(r)},append:function(e,t){this.$(t).append(e.render().el)},assign:function(e,t){e.setElement(this.$(t)).render()},prepend:function(e,t){this.$(t).prepend(e.render().el)}});return b});