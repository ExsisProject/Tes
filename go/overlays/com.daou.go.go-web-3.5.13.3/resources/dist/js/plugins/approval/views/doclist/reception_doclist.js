define(["jquery","underscore","backbone","app","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/doclist_item","approval/views/doclist/doclist_csv_download","approval/views/doclist/user_doc_folder","approval/views/doclist/base_doclist","approval/views/create_rule","approval/collections/reception_doclist","approval/models/doclist_item","hgn!approval/templates/reception_doclist","hgn!approval/templates/doclist_empty","approval/models/all_documents_action","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y){var b=n.Model.extend({url:function(){var e=["/api/approval/userfolder/"+this.folderId+"/document/add"].join("/");return e},setFolderId:function(e){this.folderId=e}}),w={"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\ub2f4\ub2f9\uc790":y["\ub2f4\ub2f9\uc790"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uacb0\uc7ac\uc120":y["\uacb0\uc7ac\uc120"],"\uae30\uc548\ubd80\uc11c":y["\uae30\uc548\ubd80\uc11c"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],"\uc6d0\ubb38\ubc88\ud638":y["\uc6d0\ubb38\ubc88\ud638"],"\uac80\uc0c9":g["\uac80\uc0c9"],"\uc804\uccb4":y["\uc804\uccb4"],"\uc811\uc218\ub300\uae30":y["\uc811\uc218\ub300\uae30"],"\uc811\uc218":y["\uc811\uc218"],"\uc9c4\ud589":y["\uc9c4\ud589"],"\uc644\ub8cc":y["\uc644\ub8cc"],"\ubc18\ub824":y["\ubc18\ub824"],"\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958":y["\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958"],"\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958":y["\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958"],"\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4":y["\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"\uc790\ub3d9\ubd84\ub958":y["\uc790\ub3d9\ubd84\ub958"],"\ubd84\ub958":y["\ubd84\ub958"],"\ubc18\uc1a1":y["\ubc18\uc1a1"]},E=l.extend({el:"#content",columns:{"\uc811\uc218\uc77c":y["\uc811\uc218\uc77c"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":y["\uae34\uae09"],"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\ucca8\ubd80":y["\ucca8\ubd80"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\ub2f4\ub2f9\uc790":y["\ub2f4\ub2f9\uc790"],"\uacb0\uc7ac\uc0c1\ud0dc":y["\uacb0\uc7ac\uc0c1\ud0dc"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],"\uc6d0\ubb38\ubc88\ud638":y["\uc6d0\ubb38\ubc88\ud638"],count:10},docFieldModel:null,docFolderType:null,events:{"click input:checkbox":"toggleCheckbox","click #deptDocCopy":"deptDocCopy","click #userDocClassify":"docClassify","click #deptDocClassify":"docClassify","click .tab_nav > li":"selectTab","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click .btn_search2":"search","keypress input#keyword":"searchByEnter","click #userDocCopy":"userDocCopy","click #checkedAllDeptDoc":"checkedAllDoc","click p#allSelectMsg3":"toggleSelectScope","click #docClassifyMenu":"toggleDocClassifyMenu"},initialize:function(e){this.options=e||{},this.type=this.options.type,t.contains(this.type,"?")&&(this.type=this.type.substr(0,this.type.indexOf("?"))),this.deptId=this.options.deptId,this.docFolderType=t.isEmpty(this.deptId)?"user_reception":"dept_reception",this.contentTop=i.getInstance(),this.collection=new h(this.type,this.deptId),this.initProperty="receivedAt",this.initDirection="desc",this.initPage=20,this.ckeyword="",this.userId=r.session("id"),t.bindAll(this,"render","renderPageSize","renderPages");var n=sessionStorage.getItem("list-history-baseUrl"),s=!1;if(n){var o=["approval/doclist/reception/"+this.type,"approval/deptfolder/receive/"+this.deptId+"/"+this.type];s=t.contains(o,n)}s?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.initSearchtype=sessionStorage.getItem("list-history-searchtype"),this.ckeyword=sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),this.collection.setListParam()):(this.collection.pageSize=this.initPage,this.collection.setSort(this.initProperty,this.initDirection)),sessionStorage.clear(),this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},this.collection.bind("reset",this.resetList,this),l.prototype.initialize.call(this,e)},userDocCopy:function(){var n=this,r=[],i=e("input[name=checkbox]:checked");i.each(function(){r.push(e(this).attr("data-id"))});if(e.isEmptyObject(r)){e.goError(y["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var s=this.userId,o,u=new f({docIds:r,userId:s});if(u.isEmptyDocFolder())return u.release(),e.goAlert(w["\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;u.release();var a=e.goPopup({pclass:"layer_normal layer_doc_type_select",header:w["\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958"],modal:!0,width:300,contents:"",buttons:[{btext:g["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(i){var s=i.find(".on span[data-folderid]").attr("data-folderid");if(!s)return e.goError(y["\uc774\ub3d9\ud558\uc2e4 \ubb38\uc11c\ud568\uc744 \uc120\ud0dd\ud574\uc8fc\uc2ed\uc2dc\uc694."],e(".list_wrap ")),!1;var u=e.goPreloader();i.parent().find("#allSelectTr").is(":visible")&&i.parent().find("#allSelectMsg3").attr("data-value")=="folder"?(o=new m({folderType:"userreceptionfolder"}),!t.isUndefined(n.collection.keyword)&&n.collection.keyword.trim().length>0&&o.setSearch(n.collection.searchtype,n.collection.keyword)):o=new b({ids:r}),o.setFolderId(s),o.save({},{silent:!0,type:"PUT",beforeSend:function(){u.render()},success:function(t,r){e.goMessage(y["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \ubcf5\uc0ac\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),i.close(),n.$el.find("#checkedAllDeptDoc").attr("checked",!1),n.collection.fetch()},error:function(n,r){var i=r.responseJSON;return!t.isUndefined(i)&&i.message?(e.goError(i.message),!1):(e.goError(g["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),!1)},complete:function(){u.release()}})}},{btext:g["\ucde8\uc18c"],btype:"cancel"}]}),l=new f({docIds:r,userId:s});l.render(),r!=""&&a.reoffset()},docClassify:function(){var t=this,n=[],r=this.$("input[name=checkbox]:checked");r.each(function(){n.push(e(this).attr("data-id"))});if(e.isEmptyObject(n)){e.goError(y["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}if(n.length!=1){e.goError(y["\ud558\ub098\uc758 \ubb38\uc11c\ub9cc \uc790\ub3d9\ubd84\ub958\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"]);return}var i=this.collection.filter(function(e){return e.attributes.id==n[0]})[0],s={title:i.get("title"),form:i.get("formName"),drafter:i.get("drafterName"),draftDeptName:i.get("drafterDeptName"),docFolderType:"RECEIVE"},o=new c({deptId:this.deptId,docId:n[0],docInfo:s}),u=e.goPopup({pclass:"layer_normal layer_auto",header:y["\uc790\ub3d9\ubd84\ub958"],modal:!0,width:380,contents:"",buttons:[{btext:g["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){o.validate()&&o.createRule().done(function(){e.close()})}},{btext:g["\ucde8\uc18c"],btype:"cancel"}]});u.find(".content").html(o.render().el),u.reoffset()},renderLayout:function(){this.$el.html(d({isUserReception:this.docFolderType=="user_reception"?!0:!1,isDeptReception:this.docFolderType=="dept_reception"?!0:!1,lang:w})),this.type.indexOf("?")>=0&&(this.type=this.type.substr(0,this.type.indexOf("?"))),e("#tab_"+this.type).addClass("on");var n=t.isEmpty(this.deptId)?y["\uc218\uc2e0 \ubb38\uc11c\ud568"]:y["\ubd80\uc11c \uc218\uc2e0\ud568"];this.contentTop.setTitle(n),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.$el.find("input[placeholder]").placeholder(),this.renderPageSize(),(new a({getDownloadURL:e.proxy(this.collection.getCsvURL,this.collection),appendTarget:this.$el.find("#docToolbar > div.critical")})).render()},toggleCheckbox:function(t){e(t.currentTarget).is(":checked")?(e(t.currentTarget).attr("checked",!0),e("td.check :checkbox:checked").length==this.collection.getCompletedDocumentCount()&&(this.$el.find("#checkedAllDeptDoc").attr("checked",!0),(this.collection.type=="complete"||this.collection.type=="all")&&this.toggleSelectAllTpl(!0))):(this.$el.find("#checkedAllDeptDoc").attr("checked",!1),e(t.currentTarget).attr("checked",!1),(this.collection.type=="complete"||this.collection.type=="all")&&this.toggleSelectAllTpl(!1))},renderTitle:function(e){this.contentTop.setTitle(e),this.contentTop.render()},renderPageSize:function(){this.pageSizeView=new o({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new s({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el),this.$el.find("#checkedAllDeptDoc").attr("checked",!1)},resetList:function(t){this.collection.extData!=null&&(this.deptName=this.collection.extData.deptName,this.renderTitle(this.collection.extData.folderName+' <span class="meta">in '+this.collection.extData.deptName+"</span>"),this.deptId=this.collection.extData.deptId);var n=this.collection.url().replace("/api/",""),i=r.router.getUrl().replace("#","");i.indexOf("?")<0?r.router.navigate(n,{replace:!0}):i!=n&&r.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty(),this.completeDocumentTotal=this.completeDocumentCount(),this.renderSelectAllTpl();var s=this.columns,o="approval";t.each(function(t){var n=new u({model:t,isCheckboxVisible:t.isCompleted(),listType:o,columns:s,isReception:!0});e(".list_approval > tbody").append(n.render().el)}),t.length==0&&e(".list_approval > tbody").html(v({columns:this.columns,lang:{doclist_empty:y["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectTab:function(t){this.collection.setPageNo(0),e(".tab_nav > li").removeClass("on"),e(t.currentTarget).addClass("on"),this.$el.find("#checkedAllDeptDoc").attr("checked",!1);var n=e(t.currentTarget).attr("id");n=="tab_all"?this.collection.setType("all"):n=="tab_waiting"?this.collection.setType("waiting"):n=="tab_received"?this.collection.setType("received"):n=="tab_inprogress"?this.collection.setType("inprogress"):n=="tab_complete"?this.collection.setType("complete"):n=="tab_returned"?this.collection.setType("returned"):n=="tab_recv_returned"&&this.collection.setType("recv_returned"),this.collection.fetch()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},sort:function(t){var n="#"+e(t.currentTarget).attr("id"),r=e(n).attr("sort-id"),i="desc",s="",o="";e(n).hasClass("sorting")&&(s="sorting",o="sorting_desc"),e(n).hasClass("sorting_desc")&&(s="sorting_desc",o="sorting_asc",i="asc"),e(n).hasClass("sorting_asc")&&(s="sorting_asc",o="sorting_desc"),e(n).removeClass(s).addClass(o);var u=this.$el.find("th");u.each(function(){!e(this).hasClass("sorting_disabled")&&"#"+e(this).attr("id")!=n&&(e(this).removeClass("sorting").addClass("sorting"),e(this).removeClass("sorting_desc").addClass("sorting"),e(this).removeClass("sorting_asc").addClass("sorting"))}),this.collection.setSort(r,i),this.collection.fetch()},search:function(){var t=e("#searchtype").val(),n=e.trim(e("#keyword").val());e("input#keyword").attr("placeholder")===this.$el.find("input#keyword").val()&&(n="");if(!n)return e.goMessage(y["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."]),e("#keyword").focus(),!1;if(!e.goValidation.isCheckLength(2,64,n))return e.goMessage(r.i18n(y["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"})),e("#keyword").focus(),!1;this.collection.setSearch(t,n),this.collection.fetch()},searchByEnter:function(t){if(t.keyCode!=13)return;t&&t.preventDefault(),e(t.currentTarget).focusout().blur(),this.search()},checkedAllDoc:function(){e("#checkedAllDeptDoc").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1),(this.collection.type=="complete"||this.collection.type=="all")&&this.toggleSelectAllTpl(e("#checkedAllDeptDoc").is(":checked"))},toggleDocClassifyMenu:function(t){var n=e(t.currentTarget).find(".array_option");n.is(":visible")?n.hide():n.show()},release:function(){this.$el.off(),this.$el.empty()},makeCompleteDocumentCountingUrl:function(){var e=r.contextRoot+"api/approval/doclist/reception/complete/count?";return e+this.makeParams()}});return E});