define(["jquery","underscore","backbone","app","when","approval/models/doc_list_field","approval/views/doclist/doclist_docfiled_setting","hgn!approval/templates/document/doclist_period","hgn!approval/templates/doclist_field_column","hgn!approval/templates/select_all_layout","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=n.View.extend({initialize:function(e){this.options=e||{},this.duration=this.options.duration,this.fromDate=this.options.fromDate,this.toDate=this.options.toDate},events:{"change #duration":"_changeDuration"},render:function(){var e={search_all:c["\uc804\uccb4\uae30\uac04"],search_month:c["\uac1c\uc6d4"],search_year:c["\ub144"],search_input:c["\uae30\uac04\uc785\ub825"]};return this.$el.prepend(u({lang:e})),this.initDatePicker(),this},initDatePicker:function(){var t=this;e.datepicker.setDefaults(e.datepicker.regional[r.config("locale")]),this.$("#fromDate").datepicker({defaultDate:"+1w",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){t.$("#toDate").datepicker("option","minDate",e)}}),this.$("#toDate").datepicker({defaultDate:"+1w",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){t.$("#fromDate").datepicker("option","maxDate",e)}})},_changeDuration:function(){var e=this.$("#duration").val();e=="period"?this.$("#durationPeriod").show():this.$("#durationPeriod").hide()},_setDuration:function(){var e=this.duration,t=this.fromDate,n=this.toDate;this.$("#duration").val(e),e=="period"&&(this.$("#durationPeriod").show(),this.$("#fromDate").val(r.util.toMoment(t).format("YYYY-MM-DD")),this.$("#toDate").val(r.util.toMoment(n).format("YYYY-MM-DD")))}}),p={all_select_page:c["\ud604\uc7ac \ud398\uc774\uc9c0\uc5d0 \uc788\ub294 \ubaa8\ub4e0 \ubb38\uc11c\ub4e4\uc774 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],count_msg:c["\ud574\ub2f9 \ubb38\uc11c\ud568\uc758 \ubaa8\ub4e0 \ubb38\uc11c 0\uac1c\ub97c \uc120\ud0dd\uba54\uc2dc\uc9c0"],select_all:c["\ubaa8\ub4e0 \ubb38\uc11c \uc120\ud0dd"],all_select_folder:c["\ud574\ub2f9 \ubb38\uc11c\ud568\uc758 \ubaa8\ub4e0 \ubb38\uc11c\ub4e4\uc774 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],cancel_msg:c["\ud574\ub2f9 \ubb38\uc11c\ud568\uc758 \uc120\ud0dd \ucde8\uc18c\uba54\uc2dc\uc9c0"],select_cancel:c["\uc120\ud0dd \ud574\uc81c"]},d=n.View.extend({checkboxColumn:null,toRemoveColumns:null,initialize:function(e){this.options=e||{},this.toRemoveColumns=this.options.toRemoveColumns||[],this.collection.usePeriod=this.usePeriod||!1},events:{"click .btn_search2":"search","click p#allSelectMsg3":"toggleSelectScope","keypress input#keyword":"searchByEnter"},render:function(){this.usePeriod?i(this.fetchDocField.call(this)).then(t.bind(this.renderLayout,this)).then(t.bind(this.renderPeriodView,this)).then(t.bind(this.renderDocFieldSettingView,this)).then(t.bind(this.renderDocFieldColumnTpl,this)).then(t.bind(this.fetchDocList,this)).then(t.bind(this.setInitSort,this)).otherwise(function(t){console.log(t.stack)}):i(this.fetchDocField.call(this)).then(t.bind(this.renderLayout,this)).then(t.bind(this.renderDocFieldSettingView,this)).then(t.bind(this.renderDocFieldColumnTpl,this)).then(t.bind(this.fetchDocList,this)).then(t.bind(this.setInitSort,this)).otherwise(function(t){console.log(t.stack)})},renderPeriodView:function(){this.periodView=new h({duration:this.duration||"all",fromDate:this.fromDate,toDate:this.toDate}),this.periodView.setElement(this.$el.find(".table_search")).render(),this.periodView._setDuration()},fetchDocList:function(){var e=i.defer();return this.collection.fetch({success:e.resolve,error:e.reject,statusCode:{403:function(){r.util.error("403")},404:function(){r.util.error("404",{msgCode:"400-common"})},500:function(){r.util.error("500")}}}),e.promise},fetchDocField:function(){var e=this;this.docFieldModel=new s({docFolderType:this.docFolderType});var t=i.defer();return this.docFieldModel.fetch({success:function(n){var r=n.getCollection();e.columns=r.makeDoclistColumn(e.columns),e.sorts=r.makeDoclistSort(),e.checkboxColumn&&e.addCheckboxColumn(e.checkboxColumn),t.resolve()},error:t.reject}),t.promise},renderDocFieldSettingView:function(){this.docFieldModel.isUserType()&&(new o({docFolderType:this.docFolderType,targetView:this,toRemoveColumns:this.toRemoveColumns,appendTarget:this.$el.find("div#docFieldArea")})).render()},renderDocFieldColumnTpl:function(){this.$("#doclist_field_header").html(a({columns:this.columns,sorts:this.sorts,checkboxColumn:this.checkboxColumn}))},renderLayout:function(){console.log("\uac1c\ubcc4\ubdf0\uc5d0\uc11c override \ud55c\ub2e4")},addCheckboxColumn:function(e){this.columns["\uc120\ud0dd"]=c["\uc120\ud0dd"],this.columns.count=parseInt(this.columns.count)+1,this.checkboxColumn.id=e.id,this.checkboxColumn.name=e.name},search:function(){var t=e("#searchtype").val(),n=e.trim(e("#keyword").val()),i,s,o;o=e("#duration").val();if(this.usePeriod){i=e("#fromDate").val()||"",s=e("#toDate").val()||"";if(o=="period"&&(i==""||s==""))return e.goMessage(c["\uac80\uc0c9\uae30\uac04\uc744 \uc785\ub825\ud558\uc138\uc694."]),i!=""&&s==""&&e("#toDate").focus(),i==""&&e("#fromDate").focus(),!1}e("input#keyword").attr("placeholder")===this.$el.find("input#keyword").val()&&(n="");if(!n)return e.goMessage(c["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."]),e("#keyword").focus(),!1;if(!e.goValidation.isCheckLength(2,64,n))return e.goMessage(r.i18n(c["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"64"})),e("#keyword").focus(),!1;this.usePeriod&&(o=="period"?this.collection.setDuration({duration:o,fromDate:r.util.toISO8601(i),toDate:r.util.searchEndDate(s)}):this.collection.setDuration({duration:o})),this.collection.setSearch(t,n),this.collection.fetch()},searchByEnter:function(t){if(t.keyCode!=13)return;t&&t.preventDefault(),e(t.currentTarget).focusout().blur(),this.search()},setInitSort:function(){var t=this.initProperty,n=this.initDirection;if(t&&n){var r=null,i=this.$el.find("th");i.each(function(){e(this).attr("sort-id")==t&&(r=e(this).attr("id")),e(this).hasClass("sorting_disabled")||(e(this).removeClass("sorting").addClass("sorting"),e(this).removeClass("sorting_desc").addClass("sorting"),e(this).removeClass("sorting_asc").addClass("sorting"))}),e("#"+r).removeClass("sorting").addClass("sorting_"+n),e("#keyword").val(this.ckeyword),this.initSearchtype&&this.$("#searchtype").val(this.initSearchtype)}},sort:function(t){var n="#"+e(t.currentTarget).attr("id"),r=e(n).attr("sort-id"),i="desc",s="",o="";e(n).hasClass("sorting")&&(s="sorting",o="sorting_desc"),e(n).hasClass("sorting_desc")&&(s="sorting_desc",o="sorting_asc",i="asc"),e(n).hasClass("sorting_asc")&&(s="sorting_asc",o="sorting_desc"),e(n).removeClass(s).addClass(o);var u=this.$el.find("th");u.each(function(){!e(this).hasClass("sorting_disabled")&&"#"+e(this).attr("id")!=n&&(e(this).removeClass("sorting").addClass("sorting"),e(this).removeClass("sorting_desc").addClass("sorting"),e(this).removeClass("sorting_asc").addClass("sorting"))}),this.collection.setSort(r,i),this.collection.fetch()},completeDocumentCount:function(){var t;return e.ajax({type:"GET",async:!1,dataType:"json",url:this.makeCompleteDocumentCountingUrl(),success:function(e){t=e.data.docCount},error:function(t){e.goError(t.responseJSON.message)}}),t},makeParams:function(){var n={};return!t.isUndefined(this.collection.keyword)&&this.collection.keyword.trim().length>0&&(n.searchtype=this.collection.searchtype,n.keyword=this.collection.keyword,t.isUndefined(this.collection.duration)||(n.duration=this.collection.duration,this.collection.duration=="period"&&(n.fromDate=r.util.toISO8601(this.collection.fromDate),n.toDate=r.util.searchEndDate(this.collection.toDate)))),e.param(n)},renderSelectAllTpl:function(){e(".list_approval > tbody").append(f({columnCount:this.columns.count,lang:p,totalCount:r.i18n(p.count_msg,{totalCount:this.completeDocumentTotal})}))},toggleSelectAllTpl:function(t){var n=this.completeDocumentTotal>this.collection.pageSize||this.completeDocumentTotal>this.collection.getCompletedDocumentCount();t&&n?e("#allSelectTr").show():(e("#allSelectTr").hide(),this.toggleSelectAllMsg("folder"))},toggleSelectScope:function(n){var r=e(n.target).parent(),i=r.attr("data-value");if(t.isUndefined(i))return;this.toggleSelectAllMsg(i)},toggleSelectAllMsg:function(t){var n=e("#allSelectMsg1").empty(),i=e("#allSelectMsg2").empty(),s=e("#allSelectMsg3").find("a").empty();t=="page"?(e("#allSelectMsg3").attr("data-value","folder"),n.append(p.all_select_folder),i.append(p.cancel_msg),s.append(p.select_cancel)):t=="folder"&&(e("#allSelectMsg3").attr("data-value","page"),n.append(p.all_select_page),i.append(r.i18n(p.count_msg,{totalCount:this.completeDocumentTotal})),s.append(p.select_all))}});return d});