define(["jquery","backbone","app","i18n!nls/commons","i18n!approval/nls/approval","approval/models/ref_document","approval/views/mobile/document/m_preview","views/mobile/layer_toolbar","views/mobile/header_toolbar","approval/views/mobile/document/m_related_document_attach","hgn!approval/templates/mobile/document/m_appr_attach_file","hgn!approval/templates/mobile/document/m_attach_reference_item","attach_file","components/go-fileuploader/mobile"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d={del:r["\uc0ad\uc81c"],"\ud655\uc778":r["\ud655\uc778"],msg_duplicate_approval_document:i["\uc911\ubcf5\ub41c \uad00\ub828\ubb38\uc11c\uac00 \uc788\uc2b5\ub2c8\ub2e4"],"\uc0c1\uc138\ub0b4\uc6a9\uc870\ud68c":i["\uc0c1\uc138 \ub0b4\uc6a9 \uc870\ud68c"],"\uacb0\uc7ac\ubb38\uc11c\ucca8\ubd80":i["\uacb0\uc7ac \ubb38\uc11c \ucca8\ubd80"]},v=t.View.extend({initialize:function(e){GO.util.appLoading(!0),this.docModel=this.options.docModel,this.docId=this.docModel.documentId,this.toolBarData=this.options.toolBarData,this.mode=this.options.mode,this.layerToolbarView=u},unbindEvent:function(){this.$el.off("vclick","#related_document_upload"),this.$el.off("vclick","#filePreview"),this.$el.off("vclick","#tempFilePreview"),this.$el.off("vclick","#referenceAttachDelete")},bindEvent:function(){this.$el.on("vclick","#related_document_upload",e.proxy(this.doRelatedDocument,this)),this.$el.on("vclick","#filePreview",e.proxy(this.refDocPreview,this)),this.$el.on("vclick","#tempFilePreview",e.proxy(this.tempFilePreview,this)),this.$el.on("vclick","#referenceAttachDelete",e.proxy(this.referenceAttachDelete,this))},render:function(){return GO.util.pageDone(),GO.util.appLoading(!0),this.unbindEvent(),this.bindEvent(),this.$el.html(l({isMobileApp:GO.config("isMobileApp"),isAndroidApp:GO.util.isAndroidApp()})),this.makeAttachTmpl(),this},attachFileUploader:function(){var t={};t.success=e.proxy(function(t){var n=this,r=typeof t=="string"?JSON.parse(t):t.data;e("#attachPart").show(),r.mode="edit";var i=h.makeTempItem(r);return i.done(function(t){if(e("div.option_display").data("attachable")==="false")return;try{n.attachValidate(r)}catch(i){i.message==="overMaxAttachNumber"&&e("div.option_display").data("attachable","false");return}GO.util.isImage(r.fileExt)?e(".img_wrap").append(t.$el):e(".file_wrap").append(t.$el),t.$el.on("removedFile",function(t,n){var r=n.el;r.preventDefault(),e(r.currentTarget).parents("li").first().remove();var i=e("#attachPart");return e("div.option_display").data("attachable","true"),i.find("li").size()<1&&i.hide(),!1})}),i.promise()},this),t.error=function(e){alert(r["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},p.bind(this.$el.find("#go-fileuploader"),t)},attachValidate:function(t){var i=null,s=GO.util.getFileNameAndTypeData(t);GO.config("allowedFileUploadSize")&&(i=GO.config("allowedFileUploadSize")/1024/1024);try{e.goValidation.attachValidate("#attachPart ul li",s,i),GO.session().brandName=="DO_SAAS"&&p.attachFileValidateBySaaS(s.size)}catch(o){var u=o.message;if(u=="AttachSizeException")GO.util.delayAlert(n.i18n(r["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",i));else{if(u=="AttachNumberExceptionBySaaS")throw GO.util.delayAlert(n.i18n(r["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",GO.config("commonAttachConfig").maxAttachNumber)),new Error("overMaxAttachNumber");u=="NotFoundExtException"&&GO.util.delayAlert(r["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},referenceAttachDelete:function(t){e(t.target).parents("li").first().remove();var n=e(".option_display");return n.find("li").length<1&&n.removeClass("option_display"),!1},makeAttachTmpl:function(){var t=this;e.each(this.docModel.attaches,function(n,r){var i={id:r.id,fileName:r.name,fileExt:r.extention,fileSize:r.size,filePath:r.path,mobilePreview:r.mobilePreview,download:r.download,preview:r.preview,encrypt:r.encrypt,thumbnail:r.thumbSmall,mode:_.isUndefined(r.mode)?t.mode:r.mode},s=h.makeTempItem(i);s.done(function(t){var n=e(".wrap_attach");GO.util.isImage(i.fileExt)?n.children(".img_wrap").append(t.$el):n.children(".file_wrap").append(t.$el)})}),e.each(this.docModel.references,function(e,n){t.$el.find("#attachPart ul.file_wrap").append(c({docnum:n.docNum,id:n.id,title:n.title,lang:d}))})},doRelatedDocument:function(){console.log("doRelatedDocument");var t=e("#document_action"),n={title:d["\uacb0\uc7ac\ubb38\uc11c\ucca8\ubd80"],rightButton:{text:d["\ud655\uc778"],callback:e.proxy(function(){var t=e(".list_apprChk > li"),n=0,r=[],i=[],s=[];e(t).each(function(t,o){e(o).find("input[type=checkbox]").is(":checked")&&(n++,r.push(e(o).find("input[type=checkbox]").attr("data-id")),i.push(e(o).find("input[type=checkbox]").attr("data-docnum")),s.push(e(o).find(".txt").text()))});var o=[],u=e(".file_wrap").children(".refDoc"),a=!1;e(u).each(function(t,n){o.push(e(n).attr("data-id"))}),e(r).each(function(t,n){e(o).each(function(e,t){n==t&&(a=!0)})});if(a)return GO.util.toastMessage(d.msg_duplicate_approval_document),!1;for(var f=0;f<n;f++)e(".wrap_attach").find("ul.file_wrap").append(c({docnum:i[f],id:r[f],title:s[f],lang:d}));this.docActionRelease()},this)},cancelButton:{callback:e.proxy(function(){this.docActionRelease()},this)}};this.relatedDocumentView=new f({toolBarData:n,isCheckboxVisible:!0,docId:this.docId}),e("#document_main").hide(),t.show(),this.relatedDocumentView.setElement(t).render()},refDocPreview:function(t){var n=e(t.currentTarget).attr("data-id"),r=s.create(this.docId,n);r.fetch({async:!1});var i=r.get("document").docBodyContent,u=r.get("document").attaches,a=r.get("document").references;this.preView=new o({title:d.view,docId:n,docBody:i,attaches:u,references:a,callback:function(e){return this.$el.remove(),e&&e.stopPropagation(),!1}}),this.preView.render(),e("html").scrollTop(0)},tempFilePreview:function(t){t.stopPropagation(),t.preventDefault();var n=e(t.currentTarget).closest("li"),r={filePath:n.data("path"),fileName:n.data("name"),hostId:e(t.currentTarget).data("hostid")};GO.util.showTempAttach(r)},docActionRelease:function(){a.render(this.toolBarData),e("#document_main").show(),e("#document_action").hide(),this.relatedDocumentView.release()}});return v});