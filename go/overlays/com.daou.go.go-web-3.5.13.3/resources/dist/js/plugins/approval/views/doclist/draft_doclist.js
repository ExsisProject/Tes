define(["jquery","underscore","backbone","app","when","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/doclist_item","approval/views/doclist/base_doclist","approval/views/doclist/doclist_csv_download","approval/views/doclist/user_doc_folder","approval/views/create_rule","approval/models/doc_list_field","approval/collections/doc_list_field","approval/models/doclist_item","approval/collections/draft_doclist","approval/models/all_documents_action","hgn!approval/templates/doclist_empty","hgn!approval/templates/draft_doclist","i18n!nls/commons","i18n!approval/nls/approval","jquery.placeholder"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E){var S=n.Model.extend({url:function(){var e=["/api/approval/userfolder/"+this.folderId+"/document/add"].join("/");return e},setFolderId:function(e){this.folderId=e}}),x={"\uc804\uccb4":E["\uc804\uccb4"],"\uc9c4\ud589":E["\uc9c4\ud589"],"\uc644\ub8cc":E["\uc644\ub8cc"],"\ubc18\ub824":E["\ubc18\ub824"],"\uc784\uc2dc\uc800\uc7a5":E["\uc784\uc2dc\uc800\uc7a5"],"\uc81c\ubaa9":w["\uc81c\ubaa9"],"\uae30\uc548\uc790":E["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc120":E["\uacb0\uc7ac\uc120"],"\uae30\uc548\ubd80\uc11c":E["\uae30\uc548\ubd80\uc11c"],"\ubb38\uc11c\ubc88\ud638":E["\ubb38\uc11c\ubc88\ud638"],"\uac80\uc0c9":w["\uac80\uc0c9"],"\uacb0\uc7ac\uc591\uc2dd":E["\uacb0\uc7ac\uc591\uc2dd"],placeholder_search:w["\ud50c\ub808\uc774\uc2a4\ud640\ub354\uac80\uc0c9"],"\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958":E["\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958"],"\uc790\ub3d9\ubd84\ub958":E["\uc790\ub3d9\ubd84\ub958"],"\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4":E["\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"],"\ubd84\ub958":E["\ubd84\ub958"]},T=f.extend({el:"#content",columns:{"\uae30\uc548\uc77c":E["\uae30\uc548\uc77c"],"\uacb0\uc7ac\uc591\uc2dd":E["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":E["\uae34\uae09"],"\uc81c\ubaa9":w["\uc81c\ubaa9"],"\ucca8\ubd80":E["\ucca8\ubd80"],"\uacb0\uc7ac\uc0c1\ud0dc":E["\uacb0\uc7ac\uc0c1\ud0dc"],"\ubb38\uc11c\ubc88\ud638":E["\ubb38\uc11c\ubc88\ud638"],count:7},docFolderType:"user_draft",usePeriod:!0,initialize:function(e){this.options=e||{},t.bindAll(this,"render","renderPageSize","renderPages"),this.contentTop=s.getInstance(),this.type=this.options.type,this.options.type.indexOf("?")>=0&&(this.type=this.options.type.substr(0,this.options.type.indexOf("?"))),this.collection=new m,this.collection.setType(this.type),this.initProperty="draftedAt",this.initDirection="desc",this.ckeyword="",this.userId=r.session("id");var n=sessionStorage.getItem("list-history-baseUrl"),i=new RegExp("(#)?approval/doclist/draft/"+this.type+"$");n&&i.test(n)?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.initSearchtype=sessionStorage.getItem("list-history-searchtype"),this.ckeyword=sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),this.duration=sessionStorage.getItem("list-history-duration"),this.fromDate=sessionStorage.getItem("list-history-fromDate"),this.toDate=sessionStorage.getItem("list-history-toDate"),this.collection.setListParam()):(this.collection.setDuration(),this.collection.setSort(this.initProperty,this.initDirection)),sessionStorage.clear(),this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},this.collection.bind("reset",this.resetList,this),f.prototype.initialize.call(this,e)},events:function(){return t.extend({},f.prototype.events,{"click input:checkbox":"toggleCheckbox","click .tab_nav > li":"selectTab","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click #userDocCopy":"userDocCopy","click #userDocClassify":"userDocClassify","click #checkedAllDeptDoc":"checkedAllDoc","click #docClassifyMenu":"toggleDocClassifyMenu"})},userDocCopy:function(){var n=this,i=[],s=e("input[name=checkbox]:checked");s.each(function(){i.push(e(this).attr("data-id"))});if(e.isEmptyObject(i)){e.goError(E["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var o=this.userId,u,a=new c({docIds:i,userId:o});if(a.isEmptyDocFolder())return a.release(),e.goAlert(x["\uac1c\uc778 \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;a.release();var f=e.goPopup({pclass:"layer_normal layer_doc_type_select",header:x["\uac1c\uc778 \ubb38\uc11c\ud568 \ubd84\ub958"],modal:!0,width:300,contents:"",buttons:[{btext:w["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(s){var o=s.find(".on span[data-folderid]").attr("data-folderid");if(!o)return e.goError(E["\uc774\ub3d9\ud558\uc2e4 \ubb38\uc11c\ud568\uc744 \uc120\ud0dd\ud574\uc8fc\uc2ed\uc2dc\uc694."],e(".list_wrap ")),!1;var a=e.goPreloader();s.parent().find("#allSelectTr").is(":visible")&&s.parent().find("#allSelectMsg3").attr("data-value")=="folder"?(u=new g({folderType:"userdraftfolder"}),!t.isUndefined(n.collection.keyword)&&n.collection.keyword.trim().length>0&&(u.setSearch(n.collection.searchtype,n.collection.keyword),n.collection.duration=="period"&&u.setDuration({duration:n.collection.duration,fromDate:r.util.toISO8601(n.collection.fromDate),toDate:r.util.searchEndDate(n.collection.toDate)}))):u=new S({ids:i}),u.setFolderId(o),u.save({},{silent:!0,type:"PUT",beforeSend:function(){a.render()},success:function(t,r){e.goMessage(E["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \ubcf5\uc0ac\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),s.close(),n.$el.find("#checkedAllDeptDoc").attr("checked",!1),n.collection.fetch()},error:function(n,r){var i=r.responseJSON;return!t.isUndefined(i)&&i.message?(e.goError(i.message),!1):(e.goError(w["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),!1)},complete:function(){a.release()}})}},{btext:w["\ucde8\uc18c"],btype:"cancel"}]}),l=new c({docIds:i,userId:o});l.render(),i!=""&&f.reoffset()},userDocClassify:function(){var t=this,n=[],r=this.$("input[name=checkbox]:checked");r.each(function(){n.push(e(this).attr("data-id"))});if(e.isEmptyObject(n)){e.goError(E["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}if(n.length!=1){e.goError(E["\ud558\ub098\uc758 \ubb38\uc11c\ub9cc \uc790\ub3d9\ubd84\ub958\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"]);return}var i=this.collection.get(n[0]),s={title:i.get("title"),form:i.get("formName"),drafter:i.get("drafterName"),draftDeptName:i.get("drafterDeptName"),docFolderType:"DRAFT"},o=new h({docId:n[0],docInfo:s}),u=e.goPopup({pclass:"layer_normal layer_auto",header:x["\uc790\ub3d9\ubd84\ub958"],modal:!0,width:380,contents:"",buttons:[{btext:w["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){o.validate()&&o.createRule().done(function(){e.close()})}},{btext:w["\ucde8\uc18c"],btype:"cancel"}]});u.find(".content").html(o.render().el),u.reoffset()},renderLayout:function(){var t=this;this.$el.html(b({lang:x})),this.type.indexOf("?")>=0&&(this.type=this.type.substr(0,this.type.indexOf("?"))),e("#tab_"+this.type).addClass("on"),this.contentTop.setTitle(E["\uae30\uc548 \ubb38\uc11c\ud568"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.$el.find("input[placeholder]").placeholder(),this.renderPageSize(),(new l({getDownloadURL:e.proxy(this.collection.getCsvURL,this.collection),appendTarget:this.$el.find("#docToolbar > div.critical")})).render()},toggleCheckbox:function(t){e(t.currentTarget).is(":checked")?(e(t.currentTarget).attr("checked",!0),e("td.check :checkbox:checked").length==this.collection.getCompletedDocumentCount()&&(this.$el.find("#checkedAllDeptDoc").attr("checked",!0),(this.collection.type=="complete"||this.collection.type=="all")&&this.toggleSelectAllTpl(!0))):(this.$el.find("#checkedAllDeptDoc").attr("checked",!1),e(t.currentTarget).attr("checked",!1),(this.collection.type=="complete"||this.collection.type=="all")&&this.toggleSelectAllTpl(!1))},renderPageSize:function(){this.pageSizeView=new u({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new o({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el)},resetList:function(t){var n=this.collection.url().replace("/api/",""),i=r.router.getUrl().replace("#","");i.indexOf("?")<0?r.router.navigate(n,{replace:!0}):i!=n&&r.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty(),this.completeDocumentTotal=this.completeDocumentCount(),this.renderSelectAllTpl();var s=this.columns,o="approval";t.each(function(t){var n=new a({model:t,isCheckboxVisible:t.isCompleted(),listType:o,columns:s});e(".list_approval > tbody").append(n.render().el)}),t.length==0&&e(".list_approval > tbody").html(y({columns:this.columns,lang:{doclist_empty:E["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectTab:function(t){this.collection.setPageNo(0),e(".tab_nav > li").removeClass("on"),e(t.currentTarget).addClass("on"),this.$el.find("#checkedAllDeptDoc").attr("checked",!1);var n=e(t.currentTarget).attr("id");n=="tab_all"?this.collection.setType("all"):n=="tab_inprogress"?this.collection.setType("inprogress"):n=="tab_complete"?this.collection.setType("complete"):n=="tab_return"?this.collection.setType("return"):n=="tab_temp"&&this.collection.setType("temp"),this.collection.fetch()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},checkedAllDoc:function(){e("#checkedAllDeptDoc").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1),(this.collection.type=="complete"||this.collection.type=="all")&&this.toggleSelectAllTpl(e("#checkedAllDeptDoc").is(":checked"))},toggleDocClassifyMenu:function(t){var n=e(t.currentTarget).find(".array_option");n.is(":visible")?n.hide():n.show()},release:function(){this.$el.off(),this.$el.empty()},makeCompleteDocumentCountingUrl:function(){var e=r.contextRoot+"api/approval/doclist/draft/complete/count?";return e+this.makeParams()}});return T});