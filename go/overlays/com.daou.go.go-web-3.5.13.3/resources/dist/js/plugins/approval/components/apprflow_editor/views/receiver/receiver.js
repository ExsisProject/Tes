define("approval/components/apprflow_editor/views/receiver/receiver",["approval/components/apprflow_editor/views/base_tab_item","hgn!approval/components/apprflow_editor/templates/tab/layout","text!approval/components/apprflow_editor/templates/tab/header_dept.html","text!approval/components/apprflow_editor/templates/tab/footer_dept.html","approval/components/apprflow_editor/views/activity_list/activity_list","approval/components/apprflow_editor/views/activity_list/doc_reader_activity_group","approval/models/subscriber_group","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a){function c(e){var t={};return e&&e.type&&e.type.toLowerCase()==="org"?t={id:e.id,name:e.name,deptId:e.id,deptName:e.name,deptType:!0}:(t=_.pick(e,"id","name","position","deptId","deptName","thumbnail"),t.deptType=!1),t}function v(){this.$el.html(t({lang:f},{activityHeader:n,activityFooter:r}))}function m(){this.docReceptionReaders=new Backbone.Collection(this.model.docInfoModel.get("docReceptionReaders")),this.activityGroupsView=new i({el:this.$el.find(".list_approval_line_wrap"),observer:this.observer}),this.activityGroupsView.addGroupView(new l({activities:this.docReceptionReaders,disable:!this.editable(),observer:this.observer,receiveAllowType:this.model.getReceiveAllowType()})),this.listenTo(this.observer,"mySubscriberSelected",function(e){if(!this.isActivated())return;if(!g.call(this,e.nodes))return $.goError(f.not_allowed_group_for_receiver),this.observer.trigger("deselectSubscriber"),!1;var t=_.map(e.nodes,function(e){return{reader:{deptId:e.nodeDeptId,deptType:e.nodeType=="department"?!0:!1,deptName:e.nodeDeptName,id:e.nodeId,name:e.nodeValue.split(" ")[0],position:e.nodeValue.split(" ")[1]?e.nodeValue.split(" ")[1]:""}}});this.docReceptionReaders.reset(t)}),this.listenTo(this.docReceptionReaders,"add remove reset",_.bind(function(t){var n;t instanceof Backbone.Collection?n=t:t instanceof Backbone.Model&&t.collection&&(n=t.collection),n&&(this.model.docInfoModel.set("docReceptionReaders",n.toJSON()),this.model.set("docInfoChanged",!0),this.observer.trigger("changedTabItem",this.getTabId()))},this))}function g(e){var t=[];return this.model.getReceiveAllowType()=="DEPARTMENT"?t=_.filter(e,function(e){return e.nodeType!="department"||String(e.JSON.parse(e.actions).useReception)=="false"}):this.model.getReceiveAllowType()=="USER"?t=_.filter(e,function(e){return e.nodeType=="department"||String(e.actions)=="false"}):this.model.getReceiveAllowType()=="ALL"&&(t=_.filter(e,function(e){return e.nodeType=="department"&&String(JSON.parse(e.actions).useReception)=="false"||e.nodeType!="department"&&String(e.actions)=="false"})),t.length<1}function y(e,t){if(this.model.docInfoModel.get("docReceptionReaders").length==0)return $.goMessage(GO.i18n(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])),!1;var n=$("input#my_subscriber_title_input").val();if(_.isEmpty(n)||n.length>this._MAX_LENGTH_OF_MY_LINE_TITLE)return $.goMessage(GO.i18n(a["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"1",arg2:"20"})),!1;var r=new o({subscriber:{nodes:(new p(this.model.docInfoModel.get("docReceptionReaders"))).toJSON()},title:n});r.save({},{success:$.proxy(function(n,r,i){$.goMessage(f.msg_save_success),this.observer.trigger("reloadMySubscriber"),e.close("",t)},this),error:function(e,t,n){$.goMessage(f.msg_duplicated_my_line_title)}})}function b(){return['<table class="table_form_mini"><form>',"<tbody><tr>","</tr><tr>",'    <th><span class="txt">'+a["\uadf8\ub8f9 \uc774\ub984"]+"</span></th>",'    <td><input id="my_subscriber_title_input" class="txt_mini w_max" type="text"></td>',"</tr>","</tbody></form></table>"].join("\n")}var f={name:u["\uc774\ub984"],department:a["\ubd80\uc11c"],remove:u["\uc0ad\uc81c"],saveMyASubscruber:a["\uac1c\uc778 \uadf8\ub8f9\uc73c\ub85c \uc800\uc7a5"],msg_duplicated_my_line_title:a["\uc911\ubcf5\ub41c \uc774\ub984\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_save_success:u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],not_allowed_form:a["\uc120\ud0dd\ud55c \ub300\uc0c1\uc740 \uc774 \uc591\uc2dd\uc5d0 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],not_allowed_group_for_receiver:a["\uc120\ud0dd\ud55c \uadf8\ub8f9\uc73c\ub85c \uc218\uc2e0\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],dept_not_exist_user:a["\ubd80\uc11c\uac00 \uc5c6\ub294 \uc0ac\uc6a9\uc790\ub294 \uc218\uc2e0\uc790\ub85c \uc9c0\uc815 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]},l=s.extend({initialize:function(e){e=e||{},_.isString(e.receiveAllowType)&&(this.receiveAllowType=e.receiveAllowType),s.prototype.initialize.apply(this,arguments)},parseOrgTreeData:function(e){if(e.type=="MEMBER"&&e.deptName.length==0)return $.goError(f.dept_not_exist_user),!1;if(e&&!e.hasOwnProperty("id"))return!1;if(!this.isValidOrgData(e))return $.goError(f.not_allowed_form),!1;var t={},n=this.collection.find(function(t){var n=t.get("reader");if(n)return e.type=="org"?n.deptType&&n.id===e.id:!n.deptType&&n.id===e.id});return n?($.goMessage(a["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."]),!1):{reader:c(e)}},isValidOrgData:function(e){return this.receiveAllowType=="USER"&&e.type=="org"?!1:this.receiveAllowType!="DEPARTMENT"||e.type=="org"&&e.useReception!=0?this.receiveAllowType=="ALL"&&e.useReception==0?!1:!0:!1}}),h=Backbone.Model.extend({defaults:{nodeId:0,nodeDeptId:"",nodeCompanyId:null,nodeCompanyName:null,nodeType:"user",nodeValue:"",actions:"",members:[]},initialize:function(){this.convert(this.get("reader"))},convert:function(e){this.set("nodeId",e.id),this.set("nodeDeptId",e.deptId),this.set("nodeValue",e.name),this.set("nodeType",e["deptType"]==0?"user":"department")}}),p=Backbone.Collection.extend({model:h}),d=e.extend({className:"set_data wrap_approvalLine_set",tabId:"receiver",tabName:a["\uc218\uc2e0\uc790"],activityGroupsView:null,viewerType:"",_MAX_LENGTH_OF_MY_LINE_TITLE:20,initialize:function(t){e.prototype.initialize.apply(this,arguments),t=t||{},t.observer&&t.observer.hasOwnProperty("bind")?this.observer=t.observer:this.observer=_.extend({},Backbone.Events),this.viewerType="",t.hasOwnProperty("viewerType")&&(this.viewerType=t.viewerType),v.call(this),m.call(this)},events:{"click .save-mysubscriber-btn":"_saveAsPeronalSubscriber"},render:function(){this.activityGroupsView.render()},remove:function(){this.activityGroupView.remove(),e.prototype.remove.apply(this,arguments)},editable:function(){return this.model.isStatusReturned()?!1:this.viewerType==="docmaster"||this.model.Permission.canEditReceiverList()},usable:function(){return this.model.Permission.canUseReceiverList()},activate:function(){e.prototype.activate.apply(this,arguments),this.activityGroupsView.activate()},_saveAsPeronalSubscriber:function(e){var t="gopopup-personalsubscriber";e.preventDefault();if($("#"+t).length>0)return;if(!this.editable())return;if(this.model.docInfoModel.get("docReceptionReaders").length==0)return $.goMessage(GO.i18n(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])),!1;var n=$.goPopup({id:t,allowPrevPopup:!0,pclass:"layer_normal",header:a["\uac1c\uc778 \uadf8\ub8f9\uc73c\ub85c \uc800\uc7a5"],modal:!0,width:300,contents:b(),buttons:[{btext:u["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:_.bind(y,this)},{btext:u["\ucde8\uc18c"],btype:"cancel"}]});$("input#my_subscriber_title_input").keypress(_.bind(function(e){if(e.which==13)return y.call(this,n,e),!1},this))},deactivate:function(){e.prototype.deactivate.apply(this,arguments),this.activityGroupsView.deactivate()}});return d});