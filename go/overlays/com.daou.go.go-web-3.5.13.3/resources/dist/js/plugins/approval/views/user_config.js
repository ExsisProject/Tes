define(["jquery","underscore","backbone","app","approval/views/content_top","approval/views/changePwdForm","approval/models/user_appr_config","hgn!approval/templates/usersetting_userconfig","hgn!approval/templates/changePwdForm","i18n!nls/commons","i18n!approval/nls/approval","i18n!admin/nls/admin","i18n!nls/user","file_upload","jquery.go-popup","jquery.ui","json","json2","jquery.go-validation","jquery.placeholder","jquery.progressbar"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d={"\uae30\ubcf8 \uc124\uc815":l["\uae30\ubcf8 \uc124\uc815"],"\ubd80\uc7ac/\uc704\uc784 \uc124\uc815":l["\ubd80\uc7ac/\uc704\uc784 \uc124\uc815"],"\uac1c\uc778 \uacb0\uc7ac\uc120 \uad00\ub9ac":l["\uac1c\uc778 \uacb0\uc7ac\uc120 \uad00\ub9ac"],"\ucd94\uac00":l["\ucd94\uac00"],"\uc9c1\uae09":c["\uc9c1\uae09"],"\uc9c1\uc704":c["\uc9c1\uc704"],"\uc774\ub984":l["\uc774\ub984"],"\uc11c\uba85 \uc62c\ub9ac\uae30":l["\uc11c\uba85 \uc62c\ub9ac\uae30"],"\uc11c\uba85 \ubcc0\uacbd":l["\uc11c\uba85 \ubcc0\uacbd"],"\uc11c\uba85 \uc0ad\uc81c":l["\uc11c\uba85 \uc0ad\uc81c"],"\uacb0\uc7ac\uc77c":l["\uacb0\uc7ac\uc77c"],"\uc0ad\uc81c":l["\uc0ad\uc81c"],"\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd\ud558\uae30":l["\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd\ud558\uae30"],"\uacb0\uc7ac \uc791\uc131 \ubc29\uc2dd":l["\uacb0\uc7ac \uc791\uc131 \ubc29\uc2dd"],"\uc77c\ubc18 \uc791\uc131":l["\uc77c\ubc18 \uc791\uc131"],"\ud31d\uc5c5 \uc791\uc131":l["\ud31d\uc5c5 \uc791\uc131"],"\uacb0\uc7ac\ube44\ubc00\ubc88\ud638":l["\uacb0\uc7ac\ube44\ubc00\ubc88\ud638"],"\uc11c\uba85\uad00\ub9ac":l["\uc11c\uba85\uad00\ub9ac"],"\uc800\uc7a5":f["\uc800\uc7a5"],"\ucde8\uc18c":f["\ucde8\uc18c"],img_attach:f["\uc774\ubbf8\uc9c0 \ucca8\ubd80"],file_attach:f["\ud30c\uc77c \ucca8\ubd80"],del:f["\uc0ad\uc81c"],confirm:f["\ud655\uc778"],cancel:f["\ucde8\uc18c"],noti:f["\uc54c\ub9bc"],"\ucca8\ubd80 \uc774\ubbf8\uc9c0 \uc124\uc815":l["\ucca8\ubd80 \uc774\ubbf8\uc9c0 \uc124\uc815"],"\uae30\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc":l["\uae30\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc"],"\uae30\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc \uc124\uba85":l["\uae30\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc \uc124\uba85"],"\uc6d0\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc":l["\uc6d0\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc"],"\uc6d0\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc \uc124\uba85":l["\uc6d0\ubcf8 \uc0ac\uc774\uc988\ub85c \ud45c\uc2dc \uc124\uba85"],"\ud30c\uc77c\uba85\uc73c\ub85c \ud45c\uc2dc":l["\ud30c\uc77c\uba85\uc73c\ub85c \ud45c\uc2dc"],"\ud30c\uc77c\uba85\uc73c\ub85c \ud45c\uc2dc \uc124\uba85":l["\ud30c\uc77c\uba85\uc73c\ub85c \ud45c\uc2dc \uc124\uba85"],"\uc11c\uba85\uc740 \uc774\ubbf8\uc9c0 \ud06c\uae30 \uc548\ub0b4":l["\uc11c\uba85\uc740 \uc774\ubbf8\uc9c0 \ud06c\uae30 \uc548\ub0b4"]},v=n.Model.extend({url:"/api/approval/usersetting/password"}),m=n.View.extend({el:"#content",model:null,pwdLayerModel:null,delegateEvents:function(t){return this.undelegateEvents(),n.View.prototype.delegateEvents.call(this,t),this.$el.on("click.apprconfig",".tab_menu > li",e.proxy(this.selectTab,this)),this.$el.on("click.apprconfig","#btn_chnPwd",e.proxy(this._goPopChangePwdForm,this)),this.$el.on("click.apprconfig","#save_apprconfig",e.proxy(this._onSaveClicked,this)),this.$el.on("click.apprconfig","#cancel_apprconfig",e.proxy(this._onCancelClicked,this)),this.$el.on("click.apprconfig","#delete_sign",e.proxy(this.deleteSignImage,this)),this},undelegateEvents:function(){return n.View.prototype.undelegateEvents.call(this),this.$el.off(".apprconfig"),this},initialize:function(){this.contentTop=i.getInstance(),this.model=new o,this.model.fetch({async:!1,statusCode:{403:function(){r.util.error("403")},404:function(){r.util.error("404",{msgCode:"400-common"})},500:function(){r.util.error("500")}}}),t.isEmpty(this.model.get("signPath"))?this.model.set("signPath",r.contextRoot+this.model.getDefaultPhoto()):this.model.set("signPath",this.model.get("signPath"))},render:function(){var n=t.extend(this.model.toJSON(),{writeModes:[{value:"NORMAL",label:d["\uc77c\ubc18 \uc791\uc131"],isSelected:this.model.get("writeMode")=="NORMAL"},{value:"POPUP",label:d["\ud31d\uc5c5 \uc791\uc131"],isSelected:this.model.get("writeMode")=="POPUP"}],userChangFlag:this.model.get("userChangFlag")});this.$el.html(u({lang:d,data:n})),this._checkAuth(n),this.initFileUpload(),e("#tab_"+this.type).addClass("on"),this.contentTop.setTitle(l["\uacb0\uc7ac\ud658\uacbd\uc124\uc815"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this._checkImageMode()},_checkImageMode:function(){var e='input[name="attachImageMode"][value="'+this.model.get("attachImageMode")+'"]';this.$el.find(e).attr("checked",!0)},_checkAuth:function(t){t.userUseFlag==0&&(this.$el.find(".sign_name").text(f["\uc774\ub984"]),e("#swfupload-control").parent().hide()),t.userChangFlag==0&&(e("#swfupload-control").parent().hide(),e("#delete_sign").hide())},_goPopChangePwdForm:function(t){t.stopPropagation(),t.preventDefault();var n=new s({}),r=this,i=e.goPopup({pclass:"layer_normal layer_password_change",header:l["\uacb0\uc7ac \ube44\ubc00\ubc88\ud638 \ubcc0\uacbd"],modal:!0,width:"350px",contents:n.render().$el.html(),buttons:[{btext:f["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){r._savePassword(e)}},{btext:f["\ucde8\uc18c"],btype:"cancel"}]});e(i).find("input[type=password]").on("keypress",function(t){e(this).removeClass("enter error"),e(i).find("span.go_error").remove()})},_savePassword:function(t){var n={currentPassword:e(t).find('input[id="currentPassword"]'),newPassword:e(t).find('input[id="newPassword"]'),newPasswordConfirm:e(t).find('input[id="newPasswordConfirm"]')};if(!this._validatePassword(n))return!1;this.pwdLayerModel=new v,this.pwdLayerModel.set({oldPasswd:n.currentPassword.val(),apprPasswd:n.newPassword.val()},{silent:!0}),this.pwdLayerModel.save({},{type:"PUT",success:function(n,r){r.code=="200"&&(e.goMessage(f["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.close())},error:function(t,n){e.goError(h["\ud604\uc7ac \ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],e("#currentPassword")),e("#currentPassword").addClass("enter error").focus()}})},_validatePassword:function(e){return this._isPasswordEmpty(e)?!1:this._isPasswordEqual(e)?!0:!1},_isPasswordEmpty:function(n){var r=!1;return t.each(n,function(t,n){t.val()==""&&(e.goMessage(f["\ube44\ubc00\ubc88\ud638\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694"]),t.focus(),r=!0)}),r},_isPasswordEqual:function(t){return t.newPassword.val()!=t.newPasswordConfirm.val()?(e.goError(f["\ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4"],e("#newPassword")),e("#newPassword").addClass("enter error").focus(),!1):!0},_onSaveClicked:function(t){this.model.set({writeMode:this.$el.find("select[name=writeMode]").val(),attachImageMode:this.$el.find('input[name="attachImageMode"]:checked').val(),sign:{filePath:e("#thumbnail_image").attr("data-filepath").replace(r.contextRoot,""),fileName:e("#thumbnail_image").attr("data-filename"),hostId:e("#thumbnail_image").attr("host-id")}},{silent:!0}),this.model.save({},{type:"POST",success:function(t,n){n.code=="200"&&(e.goMessage(f["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),r.router.navigate("approval/usersetting/userconfig",{trigger:!0}))},error:function(t,n){var r=JSON.parse(n.responseText);return r.message?(e.goError(r.message),!1):(e.goError(f["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),!1)}})},_onCancelClicked:function(e){console.log("canceled.."),this.initialize(),this.render()},selectTab:function(t){if(e(t.currentTarget).attr("class")==="active")return!1;var n=e(t.currentTarget).attr("id"),i="/approval/";n=="tab_user_config"?i+="usersetting/userconfig":n=="tab_user_deputy"&&(i+="usersetting/deputy"),r.router.navigate(i,{trigger:!0}),e("html, body").animate({scrollTop:0})},search:function(){},release:function(){this.$el.off(),this.$el.empty()},initFileUpload:function(){var t=this,n={el:"#swfupload-control",context_root:r.contextRoot,button_text:'<span class="buttonText" id="uploadSignTitle">'+(t.model.get("useFlag")==1?l["\uc11c\uba85 \ubcc0\uacbd"]:l["\uc11c\uba85 \uc62c\ub9ac\uae30"])+"</span>",button_width:80,button_height:24,url:"api/file?GOSSOcookie="+e.cookie("GOSSOcookie")};(new p(n)).queue(function(e,t){}).start(function(t,n){console.log("uploadStart"),console.log(n);var r=new RegExp("(jpeg|jpg|gif|png|bmp)","gi"),i=n.type;if(!r.test(i))return e.goMessage(f["\ud3ec\uba67 \uacbd\uace0"]),!1;if(n.size>5242880)return e.goMessage(f["\ucca8\ubd80\ud30c\uc77c \uc6a9\ub7c9\uc740 5MB\uc774\ud558 \uc785\ub2c8\ub2e4."]),!1}).progress(function(e,t){}).success(function(n,i,s){if(r.util.fileUploadErrorCheck(i))return e.goAlert(r.util.serverMessage(i)),!1;if(r.util.isFileSizeZero(i))return e.goAlert(r.util.serverMessage(i)),!1;var o=i.data,u=o.fileName,a=o.filePath,f=o.hostId,l=o.thumbnail;console.log("fileName :: "+u),e("#thumbnail_image").attr("src",l).attr("data-filepath",a).attr("data-filename",u).attr("host-id",f),e("#delete_sign").show(),t.model.set({signDeleteFlag:!1})}).complete(function(e,t){console.info(t)}).error(function(e,t){console.info(t)})},deleteSignImage:function(){e("#thumbnail_image").attr("src",r.contextRoot+this.model.getDefaultPhoto()).attr("data-filepath","").attr("data-filename","").attr("host-id",""),this.model.set({signDeleteFlag:!0}),e("#delete_sign").hide()}});return m});