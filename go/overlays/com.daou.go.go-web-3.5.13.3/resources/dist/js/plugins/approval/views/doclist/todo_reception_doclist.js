define(["jquery","underscore","backbone","when","app","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/doclist_item","approval/views/doclist/base_doclist","approval/views/doclist/doclist_csv_download","approval/views/document/doc_receiver_assign","approval/views/document/apprflow_editor","approval/collections/todo_reception_doclist","approval/models/doclist_item","approval/models/user_appr_config","hgn!approval/templates/todo_reception_doclist","hgn!approval/templates/doclist_empty","hgn!approval/templates/bulk_draft_popup","approval/models/document","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E){var S=n.Model.extend({url:"/api/approval/authBulkReceive"}),x=n.Model.extend({url:"/api/approval/todoreception/count"}),T=n.Model.extend({url:"/api/approval/document/bulkdraft"}),N=b.extend({initialize:function(e,t){this.options=t||{},this.docId=this.options.docId,b.prototype.initialize.apply(this,arguments)},url:function(){var e="/api/approval/document/"+this.docId;return e}},{create:function(e){return new N({},{docId:e})}}),C=f.extend({columns:{"\uc811\uc218\uc77c":E["\uc811\uc218\uc77c"],"\uacb0\uc7ac\uc591\uc2dd":E["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":E["\uae34\uae09"],"\uc81c\ubaa9":w["\uc81c\ubaa9"],"\ucca8\ubd80":E["\ucca8\ubd80"],"\uae30\uc548\uc790":E["\uae30\uc548\uc790"],"\ub2f4\ub2f9\uc790":E["\ub2f4\ub2f9\uc790"],"\uacb0\uc7ac\uc0c1\ud0dc":E["\uacb0\uc7ac\uc0c1\ud0dc"],"\uc6d0\ubb38\ubc88\ud638":E["\uc6d0\ubb38\ubc88\ud638"],"\uc218\uc2e0\ubd80\uc11c":E["\uc218\uc2e0\ubd80\uc11c"],count:10},el:"#content",docFolderType:"appr_reception",events:{"click input:checkbox":"toggleCheckbox","click #deptDocCopy":"deptDocCopy","click .tab_nav > li":"selectTab","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click .btn_search2":"search","keypress input#keyword":"searchByEnter","click #bulkReceive":"onBulkReception","click #bulkChangeReceiver":"onBulkChangeReceiver","click #bulkReceiveCancel":"onBulkReceptionCancel","click #bulkDraft":"onBulkDraft"},initialize:function(e){this.options=e||{},this.type=this.options.type,t.contains(this.type,"?")&&(this.type=this.type.substr(0,this.type.indexOf("?"))),this.deptId=this.options.deptId,this.contentTop=s.getInstance(),this.collection=new p(this.type,this.deptId),this.initProperty="receivedAt",this.initDirection="desc",this.initPage=20,this.ckeyword="",t.bindAll(this,"render","renderPageSize","renderPages"),this.todoReceptionCountModel=new x;var n=sessionStorage.getItem("list-history-baseUrl");n&&(n=n.replace(/#/gi,"")),n&&n=="approval/todoreception/"+this.type?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.initSearchtype=sessionStorage.getItem("list-history-searchtype"),this.ckeyword=sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),this.collection.setListParam()):(this.collection.pageSize=this.initPage,this.collection.setSort(this.initProperty,this.initDirection)),sessionStorage.clear(),this.checkboxColumn={id:"checkedAllReceiveDoc",name:"checkedAllReceiveDoc"},this.collection.bind("reset",this.resetList,this),this.isAuthBulkReceive(),this.isUsePassword()},authBulkReceive:!1,usePassword:!1,renderLayout:function(){var t={"\uc81c\ubaa9":w["\uc81c\ubaa9"],"\uae30\uc548\uc790":E["\uae30\uc548\uc790"],"\uae30\uc548\ubd80\uc11c":E["\uae30\uc548\ubd80\uc11c"],"\ub2f4\ub2f9\uc790":E["\ub2f4\ub2f9\uc790"],"\uacb0\uc7ac\uc591\uc2dd":E["\uacb0\uc7ac\uc591\uc2dd"],"\uacb0\uc7ac\uc120":E["\uacb0\uc7ac\uc120"],"\ubb38\uc11c\ubc88\ud638":E["\ubb38\uc11c\ubc88\ud638"],"\uc6d0\ubb38\ubc88\ud638":E["\uc6d0\ubb38\ubc88\ud638"],"\uac80\uc0c9":w["\uac80\uc0c9"],"\uc804\uccb4":E["\uc804\uccb4"],"\uc811\uc218\ub300\uae30":E["\uc811\uc218\ub300\uae30"],"\uc811\uc218":E["\uc811\uc218"],"\uc9c4\ud589":E["\uc9c4\ud589"],"\uc644\ub8cc":E["\uc644\ub8cc"],"\ubc18\ub824":E["\ubc18\ub824"],"\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958":E["\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958"],"\uc218\uc2e0\ubd80\uc11c":E["\uc218\uc2e0\ubd80\uc11c"],"\uc77c\uad04 \uc811\uc218":E["\uc77c\uad04 \uc811\uc218"],"\uc77c\uad04 \uc811\uc218 \ucde8\uc18c":E["\uc77c\uad04 \uc811\uc218 \ucde8\uc18c"],"\ub2f4\ub2f9\uc790 \uc9c0\uc815":E["\ub2f4\ub2f9\uc790 \uc9c0\uc815"],"\uacb0\uc7ac \uc815\ubcf4 \uc124\uc815 \ubc0f \uc694\uccad":E["\uacb0\uc7ac \uc815\ubcf4 \uc124\uc815 \ubc0f \uc694\uccad"]};this.type.indexOf("?")>=0&&(this.type=this.type.substr(0,this.type.indexOf("?"))),this.$el.html(m({buttons:this.buttons,lang:t,authBulkReceive:this.authBulkReceive,useToolbarType:this.type=="all"?!1:!0,isWaitingStatus:this.type=="waiting"?!0:!1,isReceiveStatus:this.type=="received"?!0:!1})),e("#tab_"+this.type).addClass("on");var n=E["\uacb0\uc7ac \uc218\uc2e0 \ubb38\uc11c"];this.contentTop.setTitle(n),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.$el.find("input[placeholder]").placeholder(),this.renderPageSize()},isAuthBulkReceive:function(){var e=this,t=r.defer();return this.toolBarModel=new S,this.authBulkReceive=!1,this.toolBarModel.fetch({async:!1,success:function(n){e.authBulkReceive=n.get("authBulkReceive"),t.resolve()},error:t.reject}),t.promise},isUsePassword:function(){var e=this,t=r.defer();return this.config=new v,this.usePassword=!0,this.config.fetch({success:function(n){e.usePassword=n.get("passwordUseFlag"),t.resolve()},error:t.reject}),t.promise},toggleCheckbox:function(t){var n=e(t.currentTarget),r=e("input#checkedAllReceiveDoc"),i=n.is(":checked");n.attr("id")==r.attr("id")&&e('input[type="checkbox"][name="checkbox"]').attr("checked",i),n.hasClass("doclist_item_checkbox")&&(i||r.attr("checked",i))},renderTitle:function(e){this.contentTop.setTitle(e),this.contentTop.render()},renderPageSize:function(){this.pageSizeView=new u({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new o({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el),this.$el.find("#checkedAllReceiveDoc").attr("checked",!1)},resetList:function(t){this.collection.extData!=null&&(this.deptName=this.collection.extData.deptName,this.renderTitle(this.collection.extData.folderName+' <span class="meta">in '+this.collection.extData.deptName+"</span>"),this.deptId=this.collection.extData.deptId);var n=this.collection.url().replace("/api/",""),r=i.router.getUrl().replace("#","");r.indexOf("?")<0?i.router.navigate(n,{replace:!0}):r!=n&&i.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty();var s=this.columns,o="approval";t.each(function(t){var n=new a({isCheckboxVisible:!0,model:t,listType:o,columns:s,isReception:!0});e(".list_approval > tbody").append(n.render().el)}),t.length==0&&e(".list_approval > tbody").html(g({columns:this.columns,lang:{doclist_empty:E["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectTab:function(t){this.collection.setPageNo(0),e(".tab_nav > li").removeClass("on"),e(t.currentTarget).addClass("on");var n=e(t.currentTarget).attr("id");n=="tab_all"?(this.collection.setType("all"),e("#receive_toolbar").hide()):n=="tab_waiting"?(this.collection.setType("waiting"),e("#receive_toolbar").show(),e("#waitingStatus").show(),e("#receiveStatus").hide()):n=="tab_received"?(this.collection.setType("received"),e("#receive_toolbar").show(),e("#waitingStatus").hide(),e("#receiveStatus").show()):n=="tab_inprogress"?this.collection.setType("inprogress"):n=="tab_complete"?this.collection.setType("complete"):n=="tab_returned"&&this.collection.setType("returned"),this.collection.fetch()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},release:function(){this.$el.off(),this.$el.empty()},validateCheckItem:function(){var t=e("input.doclist_item_checkbox:checked");return t.length<1?(e.goAlert(E["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1):!0},onBulkReception:function(){var n=this,r=this.validateCheckItem();if(!r)return;e.goConfirm('<p class="q">'+E["\uc77c\uad04\uc811\uc218 \ud31d\uc5c5\uc124\uba85"]+"</p>","",function(){var r=t.map(e("input.doclist_item_checkbox:checked"),function(t){return parseInt(e(t).attr("data-id"))});i.EventEmitter.trigger("common","layout:setOverlay",""),n.bulkReceptionAction(r,"api/approval/document/bulkreception").done(function(t,n,r){e.goAlert(i.i18n(E["{{arg1}}\uac74\uc758 \ubb38\uc11c\uac00 \uc811\uc218\ub418\uc5c8\uc2b5\ub2c8\ub2e4. \uc811\uc218 \ud0ed\uc5d0\uc11c \ud655\uc778\ud558\uc138\uc694."],{arg1:t.data.docCount}))}).fail(function(t,n,r){t.responseJSON.message?e.goAlert(t.responseJSON.message):e.goAlert(w["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"])}).complete(function(){n.collection.fetch(),i.EventEmitter.trigger("common","layout:clearOverlay",!0),n.todoReceptionCountModel.fetch({success:function(t){e('#apprSide a[data-navi="todoreception"] span.num').text(t.get("docCount")||"")}})})})},bulkReceptionAction:function(t,n){return e.ajax({url:i.contextRoot+n,type:"PUT",dataType:"json",contentType:"application/json",data:JSON.stringify({docIds:t})})},onBulkChangeReceiver:function(){var n=this,r=this.validateCheckItem();if(!r)return;var s=e("input.doclist_item_checkbox:checked"),o=t.map(s,function(t){return parseInt(e(t).attr("data-id"))}),u=t.map(s,function(t){return parseInt(e(t).attr("data-receive-deptId"))});if(t.uniq(u).length>1){e.goAlert(i.i18n(E["{{arg1}} \uc77c\uad04\uc9c0\uc815 \uacbd\uace0"],{arg1:E["\ub2f4\ub2f9\uc790"]}));return}docReceiverAssignView=new c({type:"bulk",docIds:o,receivedDocOwnerDeptId:u[0]});var a=e.goPopup({pclass:"layer_normal layer_item_move",header:E["\ub2f4\ub2f9\uc790 \uc77c\uad04 \uc9c0\uc815"],modal:!0,width:320,allowPrevPopup:!0,contents:"",buttons:[{btext:E["\ub2f4\ub2f9\uc790 \uc9c0\uc815"],btype:"confirm",autoclose:!1,callback:function(t){docReceiverAssignView.assignReceiver(function(t){e.goAlert(i.i18n(E["{{arg1}}\uac74\uc758 \ubb38\uc11c\uc5d0 \ub2f4\ub2f9\uc790\uac00 \uc9c0\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],{arg1:t.data.docCount})),n.collection.fetch()},function(){e.goAlert(lang["\ub2f4\ub2f9\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"])})}},{btext:w["\ucde8\uc18c"],btype:"cancel",callback:function(){docReceiverAssignView.slide&&docReceiverAssignView.slide.close()}}]});docReceiverAssignView.render(a,"div.content")},onBulkReceptionCancel:function(){var n=this,r=this.validateCheckItem();if(!r)return;e.goConfirm('<p class="q">'+E["\uc77c\uad04\uc811\uc218 \ucde8\uc18c \ud31d\uc5c5\uc124\uba85"]+"</p>","",function(){var r=t.map(e("input.doclist_item_checkbox:checked"),function(t){return parseInt(e(t).attr("data-id"))});i.EventEmitter.trigger("common","layout:setOverlay",""),n.bulkReceptionAction(r,"api/approval/document/bulkreceptioncancel").done(function(t,n,r){e.goAlert(i.i18n(E["{{arg1}}\uac74\uc758 \ubb38\uc11c\uac00 \uc811\uc218\uac00 \ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],{arg1:t.data.docCount}))}).fail(function(t,n,r){t.responseJSON.message?e.goAlert(t.responseJSON.message):e.goAlert(w["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"])}).complete(function(){n.collection.fetch(),i.EventEmitter.trigger("common","layout:clearOverlay",!0),n.todoReceptionCountModel.fetch({success:function(t){e('#apprSide a[data-navi="todoreception"] span.num').text(t.get("docCount")||"")}})})})},onBulkDraft:function(){var n=this.validateCheckItem();if(!n)return;var r=e("input.doclist_item_checkbox:checked"),s=this,o=[],u=[],a=[],f=[],l=[];t.each(r,function(t){o.push(parseInt(e(t).attr("data-id"))),u.push(parseInt(e(t).attr("data-origin-companyid"))),a.push(parseInt(e(t).attr("data-receiverid"))),f.push(parseInt(e(t).attr("data-receive-deptid"))),l.push(e(t).attr("data-use-self-approval"))});if(t.uniq(a).length>1||a[0]!=i.session("id")){e.goAlert(E["\uc77c\uad04 \uc218\uc2e0 \uacb0\uc7ac \uacbd\uace0"]);return}if(t.uniq(f).length>1){e.goAlert(i.i18n(E["{{arg1}} \uc77c\uad04\uc9c0\uc815 \uacbd\uace0"],{arg1:E["\uacb0\uc7ac\uc120"]}));return}if(t.uniq(u).length>1){e.goAlert(E["\ud0c0\uc0ac\uc774\ud2b8\ubb38\uc11c\uc77c\uad04\uacb0\uc7ac\uacbd\uace0"]);return}var c=N.create(o[0]);c.fetch({async:!1,success:function(e,n){e.get("apprFlow").activityGroups[0].activities=t.filter(e.get("apprFlow").activityGroups[0].activities,function(e){return e.type=="DRAFT"}),e.get("docInfo").docReadingReaders=[],e.get("docInfo").docReferenceReaders=[],e.get("actionCheck").isArbitraryCheckVisible=!1,s.bulkDraftFlowEditor(e,o,l)},reset:!0});return},bulkDraftFlowEditor:function(t,n,i){var s=this,o=this.makeBulkDraftPopupContents(this.usePassword);r(this.renderFlowEditor(t,n,i)).then(function(){e.goPopup({pclass:"layer_normal layer_approval",header:E["\uc77c\uad04\uacb0\uc7ac\uc694\uccad"],modal:!0,draggable:!0,width:500,contents:o,buttons:[{btext:E["\uacb0\uc7ac\uc694\uccad"],btype:"confirm",autoclose:!1,callback:function(e){console.log(e),s.saveDraftDocument(e)}},{btext:w["\ucde8\uc18c"],btype:"cancel"}]})}).otherwise(function(t){console.log(t.stack)})},renderFlowEditor:function(t,n,i){var s=r.defer(),o=this;this.bulkDraftModel=new T;var u=new h({apprDocumentModel:t,saveCallback:e.proxy(function(e){o.bulkDraftModel.set({docIds:n,activities:e.apprFlowModel.get("activityGroups")[0].activities,docReferenceReaders:e.docInfoModel.get("docReferenceReaders"),docReadingReaders:e.docInfoModel.get("docReadingReaders"),useParallelAgreement:e.apprFlowModel.get("useParallelAgreement")});var t=e.apprFlowModel.get("activityGroups")[0].activities.length;o.validateSelfApproval(i,t)?s.resolve():s.reject()},this),defaultActiveTab:null});return u.render(),e(u)[0].$el.closest("div#gpopupLayer").find("footer.btn_layer_wrap a.btn_major_s span.txt").text(E["\uacb0\uc7ac \uc815\ubcf4 \uc800\uc7a5 \ud6c4 \uacb0\uc7ac \uc694\uccad"]),s.promise},validateSelfApproval:function(n,r){return r<=1&&t.contains(n,"false")?(e.goAlert(E["\uacb0\uc7ac\uc120 1\uc778\uacb0\uc7ac \uacbd\uace0"]),!1):!0},makeBulkDraftPopupContents:function(t){var n=new v,r,i={"\uc77c\uad04\uacb0\uc7ac\uc694\uccad\uc548\ub0b4":E["\uc77c\uad04\uacb0\uc7ac\uc694\uccad\uc548\ub0b4"],"\uae30\uc548\uc758\uacac":E["\uae30\uc548\uc758\uacac"],"\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694":E["\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694"],"\uacb0\uc7ac\ube44\ubc00\ubc88\ud638":E["\uacb0\uc7ac\ube44\ubc00\ubc88\ud638"]};return r=e(y({lang:i,usePassword:t})),t&&r.delegate("#apprPassword","keyup",function(t){if(t.keyCode!=13)return;var n=e(t.currentTarget),r=n.closest("div.go_popup").find("footer a.btn_major_s");r.trigger("click")}),r},saveDraftDocument:function(t){var n=this,r=e("#textarea-desc").val();if(!this.actionApprValidate("#apprPassword","#textarea-desc",t))return!1;this.bulkDraftModel.set({comment:r}),console.log(this.bulkDraftModel),i.EventEmitter.trigger("common","layout:setOverlay",""),this.bulkDraftModel.save({},{success:function(t,r){var s=e("input.doclist_item_checkbox:checked");e.goAlert(i.i18n(E["{{arg1}}\uac74\uc758 \uacb0\uc7ac\uac00 \uc694\uccad\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],{arg1:s.length}),"",function(){i.EventEmitter.trigger("common","layout:clearOverlay",!0),n.collection.fetch()})},error:function(){var n=t.responseJSON;e.goError(n.message)}})},actionApprValidate:function(t,n,r){var s=!0;e(t).removeClass("enter error"),e(n).removeClass("enter error"),r.find("span.go_error").remove();var o=e(t).val(),u=e(n).val();return this.usePassword&&(o?e.ajax({type:"PUT",dataType:"json",contentType:"application/json",async:!1,url:i.contextRoot+"api/approval/usersetting/validate/apprpassword",data:JSON.stringify({apprPasswd:o}),error:function(n){e.goError(w["\ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4"],e(t)),e(t).addClass("enter error").focus(),s=!1}}):(e.goError(E["\uacb0\uc7ac \ube44\ubc00\ubc88\ud638\ub97c \uc785\ub825\ud558\uc138\uc694."],e(t)),e(t).addClass("enter error").focus(),s=!1)),u&&u.length>1e3&&(e.goError(i.i18n(E["{{max}}\uc790 \uc774\ud558\ub85c \uc785\ub825\ud574 \uc8fc\uc2ed\uc2dc\uc624"],{max:1e3}),e(n)),e(n).addClass("enter error").select(),s=!1),s}});return C});