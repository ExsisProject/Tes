define(["jquery","underscore","backbone","when","app","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/doclist_item","approval/views/doclist/base_doclist","approval/models/doclist_item","approval/models/doc_list_field","approval/collections/appr_base_doclist","hgn!approval/templates/doclist_empty","hgn!approval/templates/official_todo_doclist","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g=n.Model.extend({url:"/api/approval/apprconfig"}),y=n.Model.extend({url:"/api/approval/usersetting/userconfig",getDefaultPhoto:function(){return"resources/images/stamp_approved.png"}}),b=n.Model.extend({url:"/api/approval/officialtodo/count"}),w=h.extend({model:l.extend({idAttribute:"_id"}),url:function(){return"/api/approval/officialtodo?"+this._makeParam()},getCsvURL:function(){return"/api/approval/officialtodo/csv?"+this._makeParam()}}),E=f.extend({columns:{"\uc120\ud0dd":v["\uc120\ud0dd"],"\uae30\uc548\uc77c":m["\uae30\uc548\uc77c"],"\uae30\uc548\uc790":m["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc591\uc2dd":m["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":m["\uae34\uae09"],"\uc81c\ubaa9":v["\uc81c\ubaa9"],"\ucca8\ubd80":m["\ucca8\ubd80"],count:8,"\uc0c1\ud0dc":v["\uc0c1\ud0dc"]},el:"#content",usePeriod:!0,initialize:function(e){var n=this;this.options=e||{},t.bindAll(this,"render","renderPageSize","renderPages"),this.officialTodoCountModel=new b,this.contentTop=s.getInstance(),this.collection=new w,this.initProperty="document.completedAt",this.initDirection="desc",this.initPage=20,this.ckeyword="";var r=sessionStorage.getItem("list-history-baseUrl");r&&(r=r.replace(/#/gi,"")),r&&r=="approval/officialtodo"?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.initSearchtype=sessionStorage.getItem("list-history-searchtype"),this.ckeyword=sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),this.duration=sessionStorage.getItem("list-history-duration"),this.fromDate=sessionStorage.getItem("list-history-fromDate"),this.toDate=sessionStorage.getItem("list-history-toDate"),this.collection.setListParam()):(this.collection.pageSize=this.initPage,this.collection.setDuration(),this.collection.setSort(this.initProperty,this.initDirection)),sessionStorage.clear(),this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},this.collection.bind("reset",this.resetList,this),f.prototype.initialize.call(this,e)},docFieldModel:null,docFolderType:"official_todo",events:function(){return t.extend({},f.prototype.events,{"click input:checkbox":"toggleCheckbox","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click a#bulkApproval":"onBulkApprovalClicked"})},render:function(){r(this.fetchConfig.call(this)).then(t.bind(this.fetchDocField,this)).then(t.bind(this.renderLayout,this)).then(t.bind(this.renderPeriodView,this)).then(t.bind(this.renderDocFieldSettingView,this)).then(t.bind(this.renderDocFieldColumnTpl,this)).then(t.bind(this.fetchDocList,this)).then(t.bind(this.setInitSort,this)).otherwise(function(t){console.log(t.stack)})},renderLayout:function(){var e=this,t={"\uc81c\ubaa9":v["\uc81c\ubaa9"],"\uae30\uc548\uc790":m["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc120":m["\uacb0\uc7ac\uc120"],"\uac80\uc0c9":v["\uac80\uc0c9"],"\uc77c\uad04 \uc2b9\uc778":m["\uc77c\uad04 \uc2b9\uc778"],"\uacb0\uc7ac\uc591\uc2dd":m["\uacb0\uc7ac\uc591\uc2dd"],placeholder_search:v["\ud50c\ub808\uc774\uc2a4\ud640\ub354\uac80\uc0c9"],"\uc804\uccb4":m["\uc804\uccb4"],"\ub300\uae30":m["\ub300\uae30"],"\ubcf4\ub958":m["\ubcf4\ub958"],"\ubb38\uc11c\ubc88\ud638":m["\ubb38\uc11c\ubc88\ud638"],"\uae30\uc548\ubd80\uc11c":m["\uae30\uc548\ubd80\uc11c"],search_all:m["\uc804\uccb4\uae30\uac04"],search_month:m["\uac1c\uc6d4"],search_year:m["\ub144"],search_input:m["\uae30\uac04\uc785\ub825"]};this.$el.html(d({lang:t,columns:this.columns})),this.contentTop.setTitle(m["\uacf5\ubb38 \ub300\uae30 \ubb38\uc11c"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.renderPageSize()},fetchDocField:function(){var e=this;this.docFieldModel=new c({docFolderType:this.docFolderType});var t=r.defer();return this.docFieldModel.fetch({success:function(n){var r=n.getCollection(),i=r.findWhere({columnMsgKey:"\uc0c1\ud0dc"});e.columns=r.makeDoclistColumn(e.columns),e.sorts=r.makeDoclistSort(),e.checkboxColumn&&e.addCheckboxColumn(e.checkboxColumn),t.resolve()},error:t.reject}),t.promise},fetchConfig:function(){var e=this,t=r.defer();return this.configModel=new g,this.useHold=!0,this.configModel.fetch({success:function(e){t.resolve()},error:t.reject}),t.promise},renderPageSize:function(){this.pageSizeView=new u({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new o({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el)},resetList:function(t){var n=this.collection.url().replace("/api/",""),r=i.router.getUrl().replace("#","");r.indexOf("?")<0?i.router.navigate(n,{replace:!0}):r!=n&&i.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty();var s=this.columns,o="officialDoc";t.each(function(t){var n=new a({model:t,isCheckboxVisible:!0,listType:o,columns:s});e(".list_approval > tbody").append(n.render().el)}),t.length==0&&e(".list_approval > tbody").html(p({columns:s,lang:{doclist_empty:m["\uacb0\uc7ac\ud560 \ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},toggleCheckbox:function(t){var n=e(t.currentTarget),r=e("input#checkedAllDeptDoc"),i=n.is(":checked");n.attr("id")==r.attr("id")&&e('input[type="checkbox"][name="checkbox"]').attr("checked",i),n.hasClass("doclist_item_checkbox")&&(i||r.attr("checked",i))},onBulkApprovalClicked:function(){var n=e("input.doclist_item_checkbox:checked"),r=this,s=[],o=[];if(n.length<1){e.goAlert(m["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var u=new y;u.fetch({success:function(s){var o=[];o.push('<p class="q">'+m["\uc815\ub9d0\ub85c \uc77c\uad04 \uc2b9\uc778 \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"]+"</p>"),o.push('<textarea id="bulkApprovalComment" class="w_max" placeholder="'+m["\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694"]+'" autofocus="autofocus"></textarea>'),e.goConfirm(o.join(""),"",function(){var s=e("#bulkApprovalComment").val(),o=t.map(n,function(t){return parseInt(e(t).attr("data-versionId"))});i.EventEmitter.trigger("common","layout:setOverlay",""),r.bulkApproval(o,s).done(function(t,n,s){e.goAlert(i.i18n(m["{{arg1}}\uac1c\uc758 \uc2b9\uc778\uc774 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],{arg1:o.length})),r.$("table.list_approval input[type=checkbox]").attr("checked",!1)}).fail(function(t,n,r){t.responseJSON.name=="pwd.not.match"?e.goAlert(t.responseJSON.message):e.goAlert(v["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"])}).complete(function(){r.collection.fetch(),i.EventEmitter.trigger("common","layout:clearOverlay",!0),r.officialTodoCountModel.fetch({success:function(t){e('#apprSide a[data-navi="officialtodo"] span.num').text(t.get("docCount")||"")}})})})}})},bulkApproval:function(t,n){var r=e.param({comment:n});return e.ajax({url:i.contextRoot+"api/approval/official/approve?"+r,type:"PUT",dataType:"json",contentType:"application/json",data:JSON.stringify({ids:t})})},release:function(){this.$el.off(),this.$el.empty()}});return E});