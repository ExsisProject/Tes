define("approval/components/apprflow_editor/views/apprline/activity_group",["backbone","approval/models/activity","approval/collections/activities","hgn!approval/components/apprflow_editor/templates/apprline/activity_group","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-popup"],function(e,t,n,r,i,s){var o={header:s["\uacb0\uc7ac \uc815\ubcf4"],save_as_my_line:s["\uac1c\uc778 \uacb0\uc7ac\uc120\uc73c\ub85c \uc800\uc7a5"],delete_as_my_line:s["\uac1c\uc778 \uacb0\uc7ac\uc120 \uc0ad\uc81c"],my_line_name:s["\uacb0\uc7ac\uc120 \uc774\ub984"],normal:s["\uc77c\ubc18"],my_lines:s["\ub098\uc758\uacb0\uc7ac\uc120"],draft:s["\uae30\uc548"],name:i["\uc774\ub984"],dept:s["\ubd80\uc11c"],line:s["\ub77c\uc778"],status:s["\uc0c1\ud0dc"],approval:s["\uacb0\uc7ac"],agreement:s["\ud569\uc758"],check:s["\ud655\uc778"],agreement_type:s["\ud569\uc758\ubc29\uc2dd"],agreement_linear:s["\uc21c\ucc28\ud569\uc758"],agreement_parallel:s["\ubcd1\ub82c\ud569\uc758"],activityType:s["\ud0c0\uc785"],add:i["\ucd94\uac00"],"delete":i["\uc0ad\uc81c"],confirm:i["\ud655\uc778"],cancel:i["\ucde8\uc18c"],inspection:s["\uac10\uc0ac"],add_activity:s["\ub4dc\ub798\uadf8\ud558\uc5ec \uacb0\uc7ac\uc120\uc744 \ucd94\uac00\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],msg_duplicate_activity:s["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."],msg_max_approval_count_exceed:s["\uacb0\uc7ac\uc790 \uc218\uac00 \ucd5c\ub300 \uacb0\uc7ac\uc790 \uc218\ub97c \ub118\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_selected:s["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_deletable_status_activity:s["\uc0ad\uc81c\ud560 \uc218 \uc5c6\ub294 \uc0c1\ud0dc\uc758 \uacb0\uc7ac\uc790 \uc785\ub2c8\ub2e4."],msg_not_deletable_assigned_activity:s["\uc9c0\uc815 \uacb0\uc7ac\uc790\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_save_success:i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],msg_not_addable_position:s["\uc644\ub8cc\ub41c \uacb0\uc7ac \uc55e\uc5d0 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_duplicated_my_line_title:s["\uc911\ubcf5\ub41c \uc774\ub984\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_maxCount:s["\uacb0\uc7ac\uc790\ub97c \ucd5c\ub300\uce58\ubcf4\ub2e4 \ub118\uac8c \ud560\ub2f9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_assigned_deleted:s["\uc9c0\uc815 \uacb0\uc7ac\uc790\ub294 \uaf2d \ud3ec\ud568\ub418\uc5b4\uc57c \ud569\ub2c8\ub2e4."],msg_my_line_set_error_not_matching_group_count:s["\uacb0\uc7ac\uc120\uc758 \uac2f\uc218\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],msg_parallel_agreement_should_has_2_more_agreement:s["\ubcd1\ub82c\ud569\uc758\ub294 \uc5f0\uc18d\ub41c \ub458 \uc774\uc0c1\uc758 \ud569\uc758\uac00 \ud544\uc694\ud569\ub2c8\ub2e4."],msg_not_belong_to_department_user:s["\ubd80\uc11c\uac00 \uc5c6\ub294 \uc0ac\uc6a9\uc790\ub294 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_addable_before_draft:s["\uae30\uc548\uc790 \uc55e\uc73c\ub85c \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],notAddable:s["\uc774 \uacb0\uc7ac\uce78\uc5d0\ub294 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],msg_not_addable_item:s["\ud56d\ubaa9\uc744 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],not_allowed_apprgroup:s["\uc120\ud0dd\ud55c \ub300\uc0c1\uc740 \uc774 \uacb0\uc7ac\uadf8\ub8f9\uc5d0 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]},u=e.View.extend({tagName:"div",className:"activity_group",observer:null,actionCheck:null,index:null,isNullGroup:!1,isArbitraryCheckVisible:!1,__disabled__:!1,events:{"click .add_activity":"_onAddArrowClicked","click .delete_activity":"_onRemoveButtonClicked","change select":"_onTypeOptionChanged","change input[type=checkbox]":"_onArbitraryClicked"},initialize:function(e){e=e||{},this.index=e.index,this.observer=e.observer,this.actionCheck=e.actionCheck,this.isArbitraryCheckVisible=e.isArbitraryCheckVisible,this.isPermissibleArbitraryDecision=e.isPermissibleArbitraryDecision,_.isNull(this.model)&&(this.isNullGroup=!0),this.__disabled__=!1,e.disable&&this.disable(),this.isReceiveDoc=e.isReceiveDoc||!1,this.includeAgreement=e.includeAgreement,this.apprAllowType=e.apprAllowType},render:function(){var e={"isNullGroup?":this.isNullGroup,isArbitraryCheckVisible:this.isArbitraryCheckVisible,isPermissibleArbitraryDecision:this.isPermissibleArbitraryDecision,lang:o,disabled:this.isDisabled()};return this.isNullGroup||(e=_.extend(this._convertToTmplData(this.model),e),e.useCheckActivity=this.actionCheck.useCheckActivity,e.isNotAddableEmptyGroup=this.model.isNotAddableEmptyGroup()),this.$el.html(r(e)),this.isNullGroup?this.$el.addClass("hidden_and_empty_group"):(this._applySortableFunction(),this.$el.attr("data-index",this.index),this.observer.trigger("activateDNDDroppable"),this.observer.trigger("resize")),this.$el.data("data-view",this),this},_applySortableFunction:function(){if(this.isDisabled())return;var e=".activity_group",t=function(t,r){var i=this.index,s=r.item.closest(e),u=parseInt(s.data("index")||0);if(u==0&&r.item.index()==0)return $.goMessage(o.msg_not_addable_before_draft),!1;if(u!==this.index)return function(){var t=r.item;userId=t.attr("data-userId"),deptId=t.attr("data-deptId"),userId==""&&(userId=null),deptId==""&&(deptId=null);var i=new n(this.model.get("activities")),s=i.getByUserIdAndDeptId(userId,deptId),o={fromGroupIndex:this.index,toGroupIndex:u,am:s,userId:userId,deptId:deptId,dataContainer:t,targetIndex:t.index()};this.trigger("moveActivityToOtherGroup",o)}.call(this),!1;if(!this.model.validateAddPosition(r.item.index()))return $.goMessage(o.msg_not_addable_position),!1;var a=[];this.$el.find("tr").each(function(e,t){a.push({userId:$(t).attr("data-userId"),deptId:$(t).attr("data-deptId")})}),this.model.sortActivitiesByUserIdAndDeptId(a),this.render()};this.$el.sortable({items:"tbody tr",cancel:"tr.inactive, select",connectWith:e,placeholder:"ui-state-highlight",stop:$.proxy(t,this)}),this.$el.filter("input").disableSelection()},addActivity:function(e,t){if(_.isNull(e)||_.isUndefined(e)||_.isEmpty(e))return $.goMessage(o.msg_not_selected),!1;var n={};if(e["type"]=="MEMBER"||e["type"]=="MASTER"||e["type"]=="MODERATOR")n={isDept:!1,deptId:e.deptId,deptName:e.deptName,userId:e.id,userName:e.name,userDuty:e.duty,userPosition:e.position,displayName:e.displayName,thumbnail:e.thumbnail};else{if(e["type"]!="org")return!1;n={isDept:!0,deptId:e.id,deptName:e.name,userId:null,userName:null,userPosition:null,displayName:e.name}}return n.type=this.model.getValidApprovalType(this.actionCheck,n)&&this.model.getValidApprovalType(this.actionCheck,n).type,n.name=this.model.getValidApprovalType(this.actionCheck,n)&&this.model.getValidApprovalType(this.actionCheck,n).name,this.checkAddableActivity(n,t)?(this.model.addActivity(n,t),this.render(),!0):!1},clearDragDropLineCss:function(){this.$el.find("tr.activity > td").attr("style","")},drawDragDropLineCss:function(e){var t;e=="last"?t=this.$el.find("tr.activity:last"):t=this.$el.find("tr.activity:eq("+e+")");var n=10;setTimeout(function(){t.find("td").each(function(){$(this).css({"border-bottom":"2px solid black"})})},n)},disable:function(){this.__disabled__=!0},isDisabled:function(){return this.__disabled__},_convertToTmplData:function(e){var t=this,r=new n(e.get("activities")||[]),i=e.canUseApproval(this.actionCheck),s=e.canUseAgreement(this.actionCheck),o=e.canUseCheck(this.actionCheck),u=e.canUseInspection(this.actionCheck),a=this.isArbitraryCheckVisible,f=this.actionCheck.agreementAllowType||"ALL";return{groupName:e.get("name"),hasActivities:r.length>0,activities:r.map(function(n,l){var c=n.isCheck()&&!o||n.isAgreement()&&!s||n.isApproval()&&!i||n.isInspection()&&!u;return{status:n.get("status"),userId:n.get("userId"),userName:n.get("userName"),deptId:n.get("deptId"),deptName:n.get("deptName"),activityType:n.get("name"),statusName:n.get("statusName"),activitiesCount:r.length,isAgreementType:n.isAgreement(),isApprovalType:n.isApproval(),isCheckType:n.isCheck(),isInspectionType:n.isInspection(),isDisabledAssignedCheckType:c,isApprovalTypeVisible:i||c&&n.isApproval(),isCheckTypeVisible:o||c&&n.isCheck(),isInspectionTypeVisible:u||c&&n.isInspection(),isAgreementTypeVisible:function(){var t=_.isNull(n.get("userId"))&&!_.isNull(n.get("deptId")),r=s||c&&n.isAgreement(),i=e.agreementAllowTypeValidate(f,t);return i||(r=!1),r},arbitraryCheckable:a&&n.isApproval(),isArbitraryChecked:n.isArbitraryChecked(),isLast:l+1===r.length?!0:!1,isEnabled:!t.__disabled__&&n.isDeletable()}})}},_onAddArrowClicked:function(e){if(this.isDisabled())return;this.observer.trigger("addActivity",$.proxy(this.addActivity,this),this)},_onRemoveButtonClicked:function(e){var t=$(e.currentTarget).hasClass("delete_activity")?$(e.currentTarget):$(e.currentTarget).hasClass("delete_activity").parent(),r=t.parent().parent(),i=r.attr("data-userId"),s=r.attr("data-deptId");i==""&&(i=null),s==""&&(s=null);var o=new n(this.model.get("activities")),u=o.getByUserIdAndDeptId(i,s);return this.checkRemovableActivity(u)?(this.model.removeActivityByUserIdAndDeptId(i,s),this.render(),!0):!1},checkAddableActivity:function(e,n){var r=this.actionCheck.agreementAllowType||"ALL";if(!this.isReceiveDoc)if(this.model.isAllApprovalTypeBlock(this.actionCheck)||_.isUndefined(e.type))return $.goMessage(o.not_allowed_apprgroup),!1;if(this.apprAllowType=="USER"&&e["isDept"]==1)return $.goMessage(o.not_allowed_apprgroup),!1;if(this.model.isExistActivity(e))return $.goMessage(o.msg_duplicate_activity),!1;if(!t.validate(e))return $.goMessage(o.msg_not_belong_to_department_user),!1;if(this.model.isFullMaxApprovalCount())return $.goMessage(o.msg_max_approval_count_exceed),!1;if(this.includeAgreement&&this.model.isFullMaxApprovalAndAgreementCount())return $.goMessage(o.msg_max_approval_count_exceed),!1;if(e["isDept"]==1){if(!this.model.canUseAgreement(this.actionCheck))return $.goMessage(o.not_allowed_apprgroup),!1;if(r=="USER")return $.goMessage(o.not_allowed_apprgroup),!1}return this.model.onlyCanAgreement(this.actionCheck)&&!this.model.agreementAllowTypeValidate(this.actionCheck.agreementAllowType,e.isDept)?($.goMessage(o.not_allowed_apprgroup),!1):n!="last"&&!this.model.validateAddPosition(n)?($.goMessage(o.msg_not_addable_position),!1):!0},checkRemovableActivity:function(e){return e.isAssigned()&&!this.actionCheck.assignedActivityDeletable?($.goMessage(o.msg_not_deletable_assigned_activity),!1):e.isDeletableStatus()?!0:($.goMessage(o.msg_not_deletable_status_activity),!1)},_removeEachActivityGroup:function(e,t){var e=e||null,t=t||null,r=new n(this.model.get("activities")),i=r.getByUserIdAndDeptId(e,t);return i.isAssigned()&&!this.actionCheck.assignedActivityDeletable?($.goMessage(o.msg_not_deletable_assigned_activity),!1):i.isDeletableStatus()?(this.model.removeActivityByUserIdAndDeptId(e,t),this.render(),!0):($.goMessage(o.msg_not_deletable_status_activity),!1)},_onTypeOptionChanged:function(e){var t=$(e.target),n=t.parent().parent(),r=n.attr("data-userId"),i=n.attr("data-deptId");this.model.setActivityType(r,i,t.val(),o[t.val().toLowerCase()]),this.render()},_onArbitraryClicked:function(e){var t=$(e.target),n=t.parent().parent(),r=n.attr("data-userId"),i=n.attr("data-deptId"),s=t.is(":checked");this.model.setArbitrarilyDecidable(r,i,s)},getAddableApprType:function(){}});return u});