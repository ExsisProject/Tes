define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("underscore"),i=require("approval/daouform/vacation/models/vacation"),s=require("hgn!approval/daouform/vacation/templates/typeTemplate"),o=require("hgn!approval/daouform/vacation/templates/halfTemplate"),u=require("hgn!approval/daouform/vacation/templates/pointTemplate"),a=require("i18n!nls/commons"),f=require("i18n!vacation/nls/vacation"),l=t.View.extend({initialize:function(t){this.$startDateEl=e(t.startDateEl),this.$endDateEl=e(t.endDateEl),this.$vacationTypeAreaEl=e(t.vacationTypeAreaEl),this.$vacationHalfAreaEl=e(t.vacationHalfAreaEl),this.$restPointAreaEl=e(t.restPointAreaEl),this.$usingPointAreaEl=e(t.usingPointAreaEl),this.$applyPointAreaEl=e(t.applyPointAreaEl),this.$descriptionEl=e(t.descriptionEl),this.variablesData=t.variables,this.vacationTypes=t.type,this.calculationType=t.calculationType,this.closedDayOfWeek=t.closedDayOfWeek},render:function(){function t(e){if(!e.length)return;e.html(o({check:"{{check_\uc2dc\uc791\uc77c_\uc885\ub8cc\uc77c}}",radio:"{{radio_\uc624\uc804_\uc624\ud6c4}}"}))}function n(e,t,n,r){if(!e.length)return;var i={text:t,dsl:["{{number:",n,"}}"].join(""),name:n,id:n,value:r};e.html(u({data:i}))}function i(t,n){var i=r.pluck(t,"text"),o=[],u=n.attr("name")=="select";u?o.push("cSel"):o.push("radio"),o=e.merge(o,i);var a={dsl:"{{"+o.join("_")+"}}",options:t,isSelectMode:u};n.html(s({data:a})),u||n.find("input:radio:first").attr("checked","checked")}this.$startDateEl.datepicker("setDate",new Date),this.$endDateEl.datepicker("setDate",new Date),i(this.vacationTypes,this.$vacationTypeAreaEl),n(this.$usingPointAreaEl,"\uc0ac\uc6a9\uc77c\uc218","usingPoint",1),n(this.$restPointAreaEl,"\uc794\uc5ec\uc5f0\ucc28","restPoint",parseFloat(this.variablesData.restPoint)),n(this.$applyPointAreaEl,"\uc2e0\uccad\uc5f0\ucc28","applyPoint",1),t(this.$vacationHalfAreaEl),this.refresh(),this._eventBind()},getVacationType:function(e){return this.vacationTypes.filter(function(t){return t.text==e})[0]},renderEditDocument:function(){this.$usingPointAreaEl.find("input").attr("readOnly",!0),this.$applyPointAreaEl.find("input").attr("readOnly",!0),this.$restPointAreaEl.find("input").attr("readOnly",!0),this._eventBind()},_eventBind:function(){function n(){t.$vacationHalfAreaEl.find("input").attr("checked",!1).attr("disabled",!0),t.$vacationHalfAreaEl.find("#startHalf").attr("disabled",!1),r.isEqual(t.$startDateEl.val(),t.$endDateEl.val())||t.$vacationHalfAreaEl.find("#endHalf").attr("disabled",!1)}function i(){t.$endDateEl.datepicker("option","minDate",t.$startDateEl.val())}var t=this;i(),e.merge(t.$startDateEl,t.$endDateEl).on("change",function(){i(),n(),t.refresh()}),this.$vacationTypeAreaEl.on("change",function(n){t.refresh();var r=e(n.currentTarget).find("select");r.attr("data-selectval",r.val())}),this.$vacationHalfAreaEl.on("change",function(){t.refresh()}),this.$vacationHalfAreaEl.find("input:checkbox").on("change",function(n){var i=e(n.currentTarget);i.closest("span.halfArea").find(":radio").attr("disabled",!i.is(":checked")).attr("checked",!1),r.isEqual(t.$startDateEl.val(),t.$endDateEl.val())||e("#startAMHalf, #endPMHalf").attr("disabled",!0)})},isVacation:function(){var e=!1,t=this.getVacationName();return r.each(this.vacationTypes,function(n){if(n.text==t){e=n.isVacation;return}},this),e},refresh:function(){function o(t){var n=0;return e.each(t.find("input:radio"),function(e,t){t.checked&&(n+=.5)}),n}function u(n,r,s){var o=GO.util.customDate(n.val().split("(")[0],"YYYY-MM-DD"),u=GO.util.customDate(r.val().split("(")[0],"YYYY-MM-DD"),f={startDate:o,endDate:u,vacationName:s,calculationType:t.calculationType,closedDayOfWeek:JSON.stringify(t.closedDayOfWeek)},l=new i;l.fetch({data:f,async:!1,error:function(t,n,r){e.goError(a["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"]),GO.router.navigate("approval",{trigger:!0})}});var c=l.get("vacationCount")*1;return c}var t=this,n=u(this.$startDateEl,this.$endDateEl,this.getVacationName()),r=o(this.$vacationHalfAreaEl),s=n-r;this.applyPoint=this.isVacation()?s:0,this.$usingPointAreaEl.find("input").val(s),this.$applyPointAreaEl.find("input").attr("value",this.applyPoint),this.validate().applyPoint(this.applyPoint,s)},getVacationName:function(){var e;return this.$vacationTypeAreaEl.attr("name")=="select"?e=this.$vacationTypeAreaEl.find("select").val():e=this.$vacationTypeAreaEl.find("input:radio:checked").val(),e},getVariablesData:function(){return{title:this.getVacationName(),isAnnualVacation:this.isVacation(),year:this.variablesData.year,startDate:GO.util.customDate(this.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),endDate:GO.util.customDate(this.$endDateEl.val().split("(")[0],"YYYY-MM-DD"),startAMHalf:e("#startAMHalf").is(":checked"),startPMHalf:e("#startPMHalf").is(":checked"),endAMHalf:e("#endAMHalf").is(":checked"),applyPoint:this.isVacation()?this.applyPoint:0,description:this.$descriptionEl.val()}},validate:function(){var t=this;return{applyPoint:function(n,r){var i=t.getVacationType(t.getVacationName());if(i.limited&&i.availableMax<r){e("#usingPoint_Comment").text(GO.i18n(f["\uc0ac\uc6a9 \uac00\ub2a5\uc77c \uc218 \uc5d0\ub7ec\uba54\uc2dc\uc9c0"],{availableMax:i.availableMax}));return}if(n>parseFloat(t.variablesData.restPoint)){e("#usingPoint_Comment").text(a["\uc2e0\uccad\uac00\ub2a5\uc77c\uc744 \ucd08\uacfc\ud558\uc600\uc2b5\ub2c8\ub2e4."]);return}e("#usingPoint_Comment").text("")},descriptionLength:function(){var n=1333,r=e(t.$descriptionEl).attr("data-maxlength")?parseInt(e(t.$descriptionEl).attr("data-maxlength")):n;r>n&&(r=n);var i=t.$descriptionEl.val()&&e(t.$descriptionEl).val().length>r;return i?(r===n&&(r="(4000byte)1333"),e.goSlideMessage(GO.i18n(a["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],"arg1",r)),!1):!0}}}});return l});