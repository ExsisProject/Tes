define(function(require){var e=require("jquery"),t=require("backbone"),n=require("underscore"),r=require("approval/daouform/timeline_2580/models/timelineApproval"),i=require("approval/daouform/timeline_2580/models/requestApproval"),s=require("approval/daouform/timeline_2580/models/requestApprovals"),o=require("i18n!nls/commons"),u=require("i18n!timeline/nls/timeline"),a=require("hgn!approval/daouform/timeline_2580/templates/previousApproval"),f=require("hgn!approval/daouform/timeline_2580/templates/currentApproval"),l=require("hgn!approval/daouform/timeline_2580/templates/workingTime"),c=t.View.extend({el:"#document_content",events:{"click #timelineApprovalAddBtn":"addTimelineApproval","click #timelineApprovalDelBtn":"delTimelineApproval","change #startTime [data-select-type=hour]":"refreshTime","change #startTime [data-select-type=minute]":"refreshTime","change #endTime [data-select-type=hour]":"refreshTime","change #endTime [data-select-type=minute]":"refreshTime"},initialize:function(t){this.$el=e(this.el),this.$timelineApprovalFormEl=this.$el.find("#timelineApprovalFormSection"),this.$timelineApprovalDetailsEl=this.$el.find("#timelineApprovalDetailsSection"),this.isChecked=!1,this.$startDateEl=this.$el.find("#startDate"),this.$startTimeHourEl=this.$el.find('#startTime [data-select-type="hour"]'),this.$endTimeHourEl=this.$el.find('#endTime [data-select-type="hour"]'),this.$totalTimeEl=this.$el.find("#totalTime"),this.$approvalNameEl=this.$el.find("#name"),this.$descriptionEl=this.$el.find("#description"),this.variablesData=t.variables,this.prevApprovals=[],this.requestApprovals=new s,this.requestApprovals.convertJsonToCollection({data:this.variablesData.requestApprovals}),this.drafterId=t.docModel.drafterId,this.prevRequestApprovalIds=[],this.variablesData.prevRequestApprovals&&(this.prevRequestApprovalIds=JSON.parse(this.variablesData.prevRequestApprovals).map(function(e){return e.approvalId})),this.addDataOption()},render:function(){this.$startDateEl.datepicker("setDate",new Date),this.renderData()},addDataOption:function(){var e="<option value='24'>24</option>",t="<span style='font-size: 12px;'>* "+u["\uacb0\uc7ac \uadfc\ubb34\uc2dc\uac04 \ub3c4\uc6c0\ub9d0"]+"</span>";this.$startTimeHourEl.append(e),this.$endTimeHourEl.append(e),this.$approvalNameEl.append(t)},renderData:function(){function t(){var t=f({data:e.requestApprovals.toJSON()});e.$timelineApprovalDetailsEl.append(t)}function n(){var t=e.prevApprovals.reduce(function(e,t,n){return e.map(function(e){return e.id}).indexOf(t.id)<0&&e.push(t),e},[]).filter(function(t){return e.prevRequestApprovalIds.indexOf(t.id)<0}).map(function(t){return t.workingTimeRange=e.getSimpleTimeStr(t),t}),n=a({data:t});e.$timelineApprovalDetailsEl.append(n)}var e=this;this.$timelineApprovalDetailsEl.html(""),t(),n()},addTimelineApproval:function(){var t={drafterId:this.drafterId,startDate:GO.util.customDate(this.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),startTime:GO.util.toISO8601(this.getStartTimeMoment()),endTime:GO.util.toISO8601(this.getEndTimeMoment())},n=new r;n.fetch({data:t,async:!1,success:e.proxy(function(e){var n=e.attributes;this.isChecked=!0;var r=new i({workingDay:t.startDate,startTime:t.startTime,endTime:t.endTime,timeRange:this.getTimeStr(t.startTime,t.endTime),reasons:this.$descriptionEl.val(),reasonsMaxLength:this.$descriptionEl.attr("data-maxlength"),name:this.$approvalNameEl.children("span").find(":checked").data("label"),totalTime:n.nowApprovalWorkingTime.workingDetailStr,weeklyTotalTimeStr:n.weekWorkingTime.totalStr,weeklyExtensionTimeStr:n.weekWorkingTime.extensionStr,monthlyTotalTimeStr:n.monthWorkingTime.totalStr,monthlyExtensionTimeStr:n.monthWorkingTime.extensionStr,normalTimeStr:n.nowApprovalWorkingTime.normalStr,extensionStr:n.nowApprovalWorkingTime.extensionStr,nightTimeStr:n.nowApprovalWorkingTime.nightStr});this.prevApprovals=this.prevApprovals.concat(n.approvals.filter(function(e){return!e.timeType})),this.requestApprovals.add(r),this.renderData()},this),error:function(t,n){n.responseJSON&&n.responseJSON.message?e.goError(n.responseJSON.message):e.goError(o["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"])}})},delTimelineApproval:function(){var e=this.requestApprovals.pop();if(!e)return;var t=moment(e.attributes.workingDay).format("YYYY-MM"),n=this.requestApprovals.map(function(e){return moment(e.attributes.workingDay).format("YYYY-MM")}).filter(function(e){return e===t}).length>0;n||(this.prevApprovals=this.prevApprovals.filter(function(e){return moment(e.baseDate).format("YYYY-MM")!==t})),this.renderData()},getSimpleTimeStr:function(e){return!e.simpleStartTime||!e.simpleEndTime?"":e.simpleStartTime+"~"+e.simpleEndTime},getTimeStr:function(e,t){return!e||!t?"":e.slice(11,16)+"~"+t.slice(11,16)},refreshTime:function(){var e=this.getStartTimeMoment(),t=this.getEndTimeMoment(),n=(t-e)/1e3,r=parseInt(n/3600),i=parseInt(n%3600/60);this.$totalTimeEl.text(r+"\uc2dc\uac04 "+i+"\ubd84 ")},getStartTimeMoment:function(){var e=this,t=GO.util.customDate(this.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),n=e.$timelineApprovalFormEl.find("#startTime [data-select-type=hour]").val(),r=e.$timelineApprovalFormEl.find("#startTime [data-select-type=minute]").val(),i=moment(t).hour(n).minute(r);return i.hour()=="24"&&i.add(1,"days"),i},getEndTimeMoment:function(){var e=this,t=GO.util.customDate(this.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),n=e.$timelineApprovalFormEl.find("#endTime [data-select-type=hour]").val(),r=e.$timelineApprovalFormEl.find("#endTime [data-select-type=minute]").val(),i=this.getStartTimeMoment(),s=moment(t).hour(n).minute(r);return s-i<0&&s.add(1,"days"),s},getVariablesData:function(){return{requestApprovals:this.requestApprovals.convertCollectionToJson()}},validate:function(){var t=this;return{checkEmptyRequestApprovals:function(){return t.requestApprovals.length==0?(e.goSlideMessage(u["\uc2e0\uccad\ub0b4\uc5ed \uccb4\ud06c \uba54\uc138\uc9c0"]),!1):!0}}}});return c});