define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("underscore"),i=require("hogan"),s=require("approval/daouform/timeline/models/timelineApproval"),o=require("i18n!timeline/nls/timeline"),u=require("i18n!nls/commons"),a=require("i18n!timeline/nls/timeline"),f=t.View.extend({initialize:function(t){this.isChecked=!1,this.$startDateEl=e(t.startDate),this.$totalTimeEl=e(t.totalTime),this.$approvalNameEl=e(t.approvalName),this.$weeklyTotalTimeEl=e(t.weeklyTotalTime),this.$monthlyTotalTimeEl=e(t.monthlyTotalTime),this.$descriptionEl=e(t.description),this.variablesData=t.variables,this.drafterId=t.docModel.drafterId,this.closedDayOfWeek=t.closedDayOfWeek,this.startHour=0,this.startMinute=0,this.endHour=0,this.endMinute=0},render:function(){var e=this;this.$startDateEl.datepicker("setDate",new Date),this.startDate=GO.util.customDate(e.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),this.renderData(),this.bindEvent(),this.unBindEvent()},renderButton:function(){this.$totalTimeEl.append("<span id='timeCheck' class='btn_minor'>\ud655\uc778</span>")},renderData:function(){var t=this;this.$monthlyTotalTimeEl.text(this.variablesData.monthlyTotalTimeStr+" (\ucd08\uacfc : "+this.variablesData.monthlyExtensionTimeStr+" )"),this.$weeklyTotalTimeEl.text(this.variablesData.weeklyTotalTimeStr+" (\ucd08\uacfc : "+this.variablesData.weeklyExtensionTimeStr+" )");var n=this.variablesData.approvals;if(n){this.approvals=e.parseJSON(this.variablesData.approvals),this.approvals=r.filter(this.approvals,function(e){return e.id!=t.variablesData.approvalId});var s={data:this.approvals,getSimpleTimeStr:this.getSimpleTimeStr},o='{{#data}}\n    <tr>\n        <td data-value="{{approvalStatus}}" style="width:150px;padding: 3px; border: 1px solid black; width: 700px; height: 22px; text-align: left; color: rgb(0, 0, 0); font-size: 12px;  vertical-align: middle; background: rgb(255, 255, 255);">\n            <span id="statusHistory" style="font-family: malgun gothic, dotum, arial, tahoma; font-size: 9pt; line-height: normal; margin-top: 0px; margin-bottom: 0px;">{{approvalStatus}}</span>\n        </td>\n        <td style="width:150px;padding: 3px; border: 1px solid black; width: 700px; height: 22px; text-align: left; color: rgb(0, 0, 0); font-size: 12px;  vertical-align: middle; background: rgb(255, 255, 255);">\n            <span id="workingDateHistory" style="font-family: malgun gothic, dotum, arial, tahoma; font-size: 9pt; line-height: normal; margin-top: 0px; margin-bottom: 0px;">{{name}}</span>\n        </td>\n        <td style="width:150px;padding: 3px; border: 1px solid black; width: 700px; height: 22px; text-align: left; color: rgb(0, 0, 0); font-size: 12px;  vertical-align: middle; background: rgb(255, 255, 255);">\n             <span id="workingDateHistory" style="font-family: malgun gothic, dotum, arial, tahoma; font-size: 9pt; line-height: normal; margin-top: 0px; margin-bottom: 0px;">{{baseDate}}</span>\n        </td>\n        <td style="width:150px;padding: 3px; border: 1px solid black; width: 700px; height: 22px; text-align: left; color: rgb(0, 0, 0); font-size: 12px;  vertical-align: middle; background: rgb(255, 255, 255);">\n             <span style="font-family: malgun gothic, dotum, arial, tahoma; font-size: 9pt; line-height: normal; margin-top: 0px; margin-bottom: 0px;">{{getSimpleTimeStr}}</span>        </td>\n        <td style="width:150px;padding: 3px; border: 1px solid black; width: 700px; height: 22px; text-align: left; color: rgb(0, 0, 0); font-size: 12px;  vertical-align: middle; background: rgb(255, 255, 255);">\n            <span id="descriptionHistory" style="font-family: malgun gothic, dotum, arial, tahoma; font-size: 9pt; line-height: normal; margin-top: 0px; margin-bottom: 0px;">{{reasons}}</span>\n        </td>\n    </tr>{{/data}}',u=i.compile(o).render(s);e("#historyList").html(u)}},getSimpleTimeStr:function(){return!this.simpleStartTime||!this.simpleEndTime?"":this.simpleStartTime+"~"+this.simpleEndTime},bindEvent:function(){function t(t){var n=e(t.currentTarget);n.parent("span").parent("span").attr("id")=="startTime"?self.startHour=n.val():self.endHour=n.val()}function n(t){var n=e(t.currentTarget);n.parent("span").parent("span").attr("id")=="startTime"?self.startMinute=n.val():self.endMinute=n.val()}self=this,this.$startDateEl.on("change",function(e){self.startDate=GO.util.customDate(self.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),self.refreshTime()}),e('[data-select-type="hour"]').on("change",function(e){t(e),self.refreshTime()}),e('[data-select-type="minute"]').on("change",function(e){n(e),self.refreshTime()})},unBindEvent:function(){},refreshTime:function(){this.isChecked=!1,this.startTime=moment(this.startDate).hour(this.startHour?this.startHour:e("#startTime").find('[data-select-type="hour"]').val()).minute(this.startMinute?this.startMinute:e("#startTime").find('[data-select-type="minute"]').val()),this.endTime=moment(this.startDate).hour(this.endHour?this.endHour:e("#endTime").find('[data-select-type="hour"]').val()).minute(this.endMinute?this.endMinute:e("#endTime").find('[data-select-type="minute"]').val()),this.endTime-this.startTime<0&&this.endTime.add(1,"days");var t=(this.endTime-this.startTime)/1e3,n=parseInt(t/3600),r=parseInt(t%3600/60);this.$totalTimeEl.text(n+"\uc2dc\uac04 "+r+"\ubd84 "),this.renderButton(),this.bindButtonEvent()},renderEditDocument:function(){this.startDate=GO.util.customDate(this.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),this.bindEvent(),this.refreshTime()},bindButtonEvent:function(){var t=this,n={drafterId:this.drafterId,startDate:this.startDate,startTime:this.startTime.format("YYYY-MM-DDTHH:mm:ss.SSSZ"),endTime:this.endTime.format("YYYY-MM-DDTHH:mm:ss.SSSZ")};e("#timeCheck").on("click",function(){var r=new s;r.fetch({data:n,async:!1,success:function(e){var n=e.attributes;t.$totalTimeEl.text(n.nowApprovalWorkingTime.workingDetailStr),t.variablesData.monthlyTotalTimeStr=n.monthWorkingTime.totalStr,t.variablesData.weeklyTotalTimeStr=n.weekWorkingTime.totalStr,t.variablesData.weeklyExtensionTimeStr=n.weekWorkingTime.overtimeStr,t.variablesData.monthlyExtensionTimeStr=n.monthWorkingTime.overtimeStr,t.variablesData.approvals=JSON.stringify(n.approvals.filter(function(e){return!e.timeType})),t.isChecked=!0,t.renderData()},error:function(t,n,r){e.goError(u["500 \uc624\ub958\ud398\uc774\uc9c0 \ud0c0\uc774\ud2c0"]),GO.router.navigate("approval",{trigger:!0})}})})},getVariablesData:function(){return{startDate:GO.util.customDate(this.$startDateEl.val().split("(")[0],"YYYY-MM-DD"),startTime:GO.util.toISO8601(this.startTime),endTime:GO.util.toISO8601(this.endTime),description:this.$descriptionEl.val(),name:this.$approvalNameEl.children("span").find(":checked").data("label")}},validate:function(){var t=this;return{buttonClick:function(){return t.isChecked?!0:(e.goSlideMessage(a["\ub0a0\uc9dc\uc124\uc815 \ud6c4 \ud655\uc778\ubc84\ud2bc\uc744 \ub20c\ub7ec\uc8fc\uc138\uc694."]),!1)},descriptionLength:function(){var n=t.$descriptionEl.val();if(!n)return e.goSlideMessage(o["\uc0ac\uc720\ub97c\uc785\ub825\ud574\uc8fc\uc138\uc694"]),!1;var r=1333,i=e(t.$descriptionEl).attr("data-maxlength")?parseInt(e(t.$descriptionEl).attr("data-maxlength")):r;i>r&&(i=r);var s=n&&n.length>i;return s?(i===r&&(i="(4000byte)1333"),e.goSlideMessage(GO.i18n(u["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],"arg1",i)),!1):!0},selectApprovalName:function(){return t.$approvalNameEl.children("span").find(":checked").data("label")?!0:(e.goSlideMessage(a["\uadfc\ubb34 \uad6c\ubd84\uc744 \uc120\ud0dd\ud558\uc5ec \uc8fc\uc2ed\uc2dc\uc624."]),!1)}}}});return f});