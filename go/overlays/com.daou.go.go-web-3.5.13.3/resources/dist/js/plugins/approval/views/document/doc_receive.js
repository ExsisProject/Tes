define(["jquery","underscore","backbone","app","hgn!approval/templates/document/doc_receive","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-sdk","jquery.jstree","jquery.go-popup","jquery.go-grid","jquery.go-orgtab","jquery.go-validation"],function(e,t,n,r,i,s,o){var u=n.Collection.extend({initialize:function(e,t){this.docId=e,this.deptId=t},model:n.Model.extend(),url:function(){return"/api/approval/document/"+this.docId+"/receptionreader/"+this.deptId}}),a={"\uc218\uc2e0\uc790":o["\uc218\uc2e0\uc790"],"\ubd80\uc11c":o["\ubd80\uc11c"],"\ud655\uc778":s["\ud655\uc778"],"\ucde8\uc18c":s["\ucde8\uc18c"],"\ucd94\uac00":s["\ucd94\uac00"],"\uc0ad\uc81c":s["\uc0ad\uc81c"],empty_reader:o["\uc218\uc2e0\uc790\ub97c \ucd94\uac00\ud574 \uc8fc\uc138\uc694."]},f=n.View.extend({events:{"click .ic_basket":"deleteReader"},initialize:function(e){this.$el=e.el,this.collection=e.collection},render:function(){var e=this._compileTmpl(),t=this.collection.toJSON();return this.$el.html(e.render({lang:a,readers:t})),this.$el},addReader:function(e){this.collection.add({reader:{id:e.id,name:e.name,position:e.position,deptId:e.deptId,deptName:e.deptName}})},deleteReader:function(t){var n=e(t.currentTarget).parent().parent().attr("data-userid"),r=this.collection.find(function(e){return e.get("reader")["id"]==n});r&&this.collection.remove(r),this.render()},_compileTmpl:function(){return Hogan.compile(["{{#readers}}","    <tr>",'        <td class="name">{{reader.name}} {{reader.position}}</td>','        <td class="func" data-id="{{id}}" data-userId="{{reader.id}}" data-deptId="{{reader.deptId}}">','            <span class="btn_bdr" title="{{lang["\uc0ad\uc81c"]}}"><span class="ic_classic ic_basket"></span></span>',"        </td>","    </tr>","{{/readers}}","{{^readers}}","    <tr>",'        <td class="name">{{lang.empty_reader}}</td>',"    </tr>","{{/readers}}"].join("\n"))}}),l=n.View.extend({el:".layer_normal .content",events:{"click .btn_langth":"addMember"},initialize:function(e){this.docId=e.docId,this.apprFlow=e.apprFlow,this.deptId=e.receptAddDeptId,this.collection=new u(this.docId,this.deptId.join(",")),this.collection.fetch({async:!1})},render:function(){this.$el.html(i({lang:a})),this._renderMemberTree(),this._renderReaderList()},_renderMemberTree:function(){var n=null,r=[];if(t.isArray(this.deptId)&&this.deptId.length>0)for(var i=0;i<this.deptId.length;i++)i==0?n=this.deptId[i]:r.push(this.deptId[i]);this.orgTab=e.goOrgTab({elId:"org_content",loadId:n,includeLoadIds:r,css:{minHeight:306,maxHeight:306}})},_renderReaderList:function(){this.listView=new f({el:this.$el.find("#pAddReceive"),collection:this.collection}),this.listView.render()},addMember:function(){var t=this.orgTab.getSelectedData();if(!t.type)return e.goMessage(o["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;if(t.type=="org")return e.goMessage(o["\ubd80\uc11c\ub294 \uc120\ud0dd\ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;if(this.isExistMember(t.id))return e.goMessage(o["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."]),!1;if(this.isExistActivity(t.id))return e.goMessage(o["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."]),!1;this.listView.addReader(t),this.listView.render()},isExistMember:function(t){var n=!1,r=e("#pAddReceive").find(".func[data-userId]");return r.each(function(){if(e(this).attr("data-userId")==t)return n=!0,!1}),n},isExistActivity:function(e){var t=!1,n=this.apprFlow.activityGroups;for(var r=0;r<n.length;r++){var i=n[r].activities;for(var s=0;s<i.length;s++)if(i[s].userId==e){t=!0;break}}return t},isExist:function(){return this.collection.length>0?!0:!1},getReaders:function(){return this.collection.map(function(e){var t=e.get("reader");return{id:e.get("id"),reader:{id:t.id,name:t.name,position:t.position,deptId:t.deptId,deptType:!1}}})},release:function(){this.$el.off(),this.$el.empty()}});return l});