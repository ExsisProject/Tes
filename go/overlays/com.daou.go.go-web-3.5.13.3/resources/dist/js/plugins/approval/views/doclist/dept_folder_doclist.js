define(["jquery","underscore","backbone","app","approval/collections/dept_folder_doclist","approval/views/content_top","views/pagination","views/pagesize","approval/views/doclist/base_doclist","approval/views/doclist/doclist_item","approval/views/doclist/doclist_csv_download","approval/views/doclist/dept_doc_folder","approval/views/create_rule","approval/models/all_documents_action","approval/views/side","hgn!approval/templates/doclist_empty","hgn!approval/templates/dept_folder_doclist","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y){var b=n.Model.extend({url:function(){var e=["/api/approval/deptfolder/"+this.folderId+"/document/add"].join("/");return e},setFolderId:function(e){this.folderId=e}}),w=n.Model.extend({url:function(){var e=["/api/approval/deptfolder/"+this.folderId+"/document/move"].join("/");return e},setFolderId:function(e){this.folderId=e}}),E=n.Model.extend({url:function(){var e=["/api/approval/deptfolder/"+this.folderId+"/document/remove"].join("/");return e},setFolderId:function(e){this.folderId=e}}),S=a.extend({docFolderType:null,deptDraftCols:{"\uc120\ud0dd":g["\uc120\ud0dd"],"\uae30\uc548\uc77c":y["\uae30\uc548\uc77c"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":y["\uae34\uae09"],"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\ucca8\ubd80":y["\ucca8\ubd80"],"\ubd80\uc11c \ubb38\uc11c\ud568":y["\ubd80\uc11c \ubb38\uc11c\ud568"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],count:9},deptRefCols:{"\uc120\ud0dd":g["\uc120\ud0dd"],"\uae30\uc548\uc77c":y["\uae30\uc548\uc77c"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":y["\uae34\uae09"],"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\ucca8\ubd80":y["\ucca8\ubd80"],"\uacb0\uc7ac\uc0c1\ud0dc":y["\uacb0\uc7ac\uc0c1\ud0dc"],"\ubd80\uc11c \ubb38\uc11c\ud568":y["\ubd80\uc11c \ubb38\uc11c\ud568"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],count:10},deptOfficialCols:{"\ubd80\uc11c\uacf5\ubb38\uacb0\uc7ac\uc77c":y["\uacb0\uc7ac\uc77c"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":y["\uae34\uae09"],"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\ucca8\ubd80":y["\ucca8\ubd80"],"\uacb0\uc7ac\uc0c1\ud0dc":y["\uacb0\uc7ac\uc0c1\ud0dc"],"\ubd80\uc11c \ubb38\uc11c\ud568":y["\ubd80\uc11c \ubb38\uc11c\ud568"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],count:9},deptFolderCols:{"\uc120\ud0dd":g["\uc120\ud0dd"],"\uae30\uc548\uc77c":y["\uae30\uc548\uc77c"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uae34\uae09":y["\uae34\uae09"],"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\ucca8\ubd80":y["\ucca8\ubd80"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],count:8},buttons:{},el:"#content",initialize:function(n){this.options=n||{},t.bindAll(this,"render","renderPageSize","renderPages"),this.contentTop=s.getInstance(),this.type=this.options.type,this.isRef=!1,this.type=="deptdraft"?(this.buttons.copy=!0,this.buttons.move=!1,this.buttons.remove=!1,this.docFolderType="dept_complete",this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},this.usePeriod=!0,this.showDeptSearchType=!0,this.initProperty="draftedAt"):this.type=="deptreference"?(this.buttons.copy=!0,this.buttons.move=!1,this.buttons.remove=!1,this.docFolderType="dept_ref",this.isRef=!0,this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},this.usePeriod=!0,this.showDeptSearchType=!0,this.initProperty="document.draftedAt"):this.type=="deptofficial"?(this.buttons.copy=!1,this.buttons.move=!1,this.buttons.remove=!1,this.docFolderType="dept_official",this.usePeriod=!1,this.showDeptSearchType=!0,this.initProperty="isEmergency"):(this.buttons.copy=!1,this.buttons.move=!0,this.buttons.remove=!0,this.docFolderType="custom_add",this.checkboxColumn={id:"checkedAllDeptDoc",name:"checkedAllDeptDoc"},this.usePeriod=!0,this.showDeptSearchType=!0,this.initProperty="draftedAt"),this.initDirection="desc",this.folderId=this.options.folderId;if(this.options.deptId){var o=this.options.deptId,u=o.indexOf("?");u>=0?this.deptId=o.substring(0,u):this.deptId=o}this.classifyManagable=!1,this.deptAdmin=!1,this.deptAdminData=d.getManageble();var f=this;f.deptAdminData.length&&r.session("useOrg")&&e.each(f.deptAdminData,function(t,n){f.type=="deptdraft"&&n.managable&&f.deptId==n.deptId&&(f.deptAdmin=!0),n.managable&&f.deptId==n.deptId&&(f.classifyManagable=!0),n.managable&&n.containsSubDept&&e.each(n.deptFolders,function(e,t){t.folderId==f.folderId&&(f.deptAdmin=!0)})}),this.collection=new i({folderId:this.folderId,deptId:this.deptId,type:this.type}),this.ckeyword="";var l=sessionStorage.getItem("list-history-baseUrl");l&&(l=l.replace(/#/gi,""));var c="approval/deptfolder/"+this.folderId+"/documents";this.type=="deptdraft"?c="approval/deptfolder/draft/"+this.deptId:this.type=="deptreference"?c="approval/deptfolder/reference/"+this.deptId:this.type=="deptofficial"&&(c="approval/deptfolder/official/"+this.deptId),l&&l==c?(this.initProperty=sessionStorage.getItem("list-history-property"),this.initDirection=sessionStorage.getItem("list-history-direction"),this.initSearchtype=sessionStorage.getItem("list-history-searchtype"),this.ckeyword=sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),this.usePeriod&&(this.duration=sessionStorage.getItem("list-history-duration"),this.fromDate=sessionStorage.getItem("list-history-fromDate"),this.toDate=sessionStorage.getItem("list-history-toDate")),this.collection.setListParam()):(this.usePeriod&&this.collection.setDuration(),this.collection.setSort(this.initProperty,this.initDirection)),sessionStorage.clear(),this.collection.bind("reset",this.resetList,this),this.collection.usePeriod=this.usePeriod,a.prototype.initialize.call(this,n)},events:function(){return t.extend({},a.prototype.events,{"click input:checkbox":"toggleCheckbox","click #deptDocCopy":"deptDocCopy","click #deptDocClassify":"deptDocClassify","click #deptDocMove":"deptDocMove","click #deptDocDelete":"deptDocDelete","click .sorting":"sort","click .sorting_desc":"sort","click .sorting_asc":"sort","click #checkedAllDeptDoc":"checkedAllDoc","click #docClassifyMenu":"toggleDocClassifyMenu"})},deptDocCopy:function(){var n=this,i=[],s=e("input[name=checkbox]:checked");s.each(function(){i.push(e(this).attr("data-id"))});if(e.isEmptyObject(i)){e.goError(y["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var o=this.deptName,u=this.deptId,a,f=new c({docIds:i,deptId:u,deptName:o});if(f.isEmptyDocFolder())return f.release(),e.goAlert(y["\ubd80\uc11c \ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;f.release();var l=e.goPopup({pclass:"layer_normal layer_doc_type_select",header:y["\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958"],modal:!0,width:300,contents:"",buttons:[{btext:g["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(s){var o=s.find(".on span[data-folderid]").attr("data-folderid");if(!o)return e.goError(y["\uc774\ub3d9\ud558\uc2e4 \ubb38\uc11c\ud568\uc744 \uc120\ud0dd\ud574\uc8fc\uc2ed\uc2dc\uc694."],e(".list_wrap ")),!1;var f=e.goPreloader();s.parent().find("#allSelectTr").is(":visible")&&s.parent().find("#allSelectMsg3").attr("data-value")=="folder"?(a=new p({folderType:n.collection.type+"folder"}),!t.isUndefined(n.collection.keyword)&&n.collection.keyword.trim().length>0&&(a.setSearch(n.collection.searchtype,n.collection.keyword),n.collection.duration=="period"&&a.setDuration({duration:n.collection.duration,fromDate:r.util.toISO8601(n.collection.fromDate),toDate:r.util.searchEndDate(n.collection.toDate)})),a.set({deptId:u})):a=new b({ids:i}),a.setFolderId(o),a.save({},{silent:!0,type:"PUT",beforeSend:function(){f.render()},success:function(t,r){e.goMessage(y["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \ubcf5\uc0ac\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),s.close(),n.$el.find("#checkedAllDeptDoc").attr("checked",!1),n.collection.fetch()},error:function(n,r){var i=r.responseJSON;return!t.isUndefined(i)&&i.message?(e.goError(i.message),!1):(e.goError(g["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."]),!1)},complete:function(){f.release()}})}},{btext:g["\ucde8\uc18c"],btype:"cancel"}]}),h=new c({docIds:i,deptId:u,deptName:o});h.render(),i!=""&&l.reoffset()},deptDocClassify:function(){var t=this,n=[],r=this.$("input[name=checkbox]:checked");r.each(function(){n.push(e(this).attr("data-id"))});if(e.isEmptyObject(n)){e.goError(y["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}if(n.length!=1){e.goError(y["\ud558\ub098\uc758 \ubb38\uc11c\ub9cc \uc790\ub3d9\ubd84\ub958\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"]);return}var i=this.collection.get(n[0]),s={title:i.get("title"),form:i.get("formName"),drafter:i.get("drafterName"),draftDeptName:i.get("drafterDeptName"),docFolderType:this.type=="deptreference"?"REFERRENCE_READ":"DRAFT"},o=new h({deptId:this.deptId,deptId:this.deptId,docId:n[0],docInfo:s}),u=e.goPopup({pclass:"layer_normal layer_auto",header:y["\uc790\ub3d9\ubd84\ub958"],modal:!0,width:380,contents:"",buttons:[{btext:g["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){o.validate()&&o.createRule().done(function(){e.close()})}},{btext:g["\ucde8\uc18c"],btype:"cancel"}]});u.find(".content").html(o.render().el),u.reoffset()},deptDocMove:function(){var n=this,i=[],s=e("input[name=checkbox]:checked");s.each(function(){i.push(e(this).attr("data-id"))});if(e.isEmptyObject(i)){e.goError(y["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var o=this.deptName,u=this.deptId,a=this.folderId,f,l=e.goPopup({pclass:"layer_normal layer_doc_type_select",header:y["\ubb38\uc11c \uc774\ub3d9"],modal:!0,width:300,contents:"",buttons:[{btext:g["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(s){var o=s.find(".on span[data-folderid]").attr("data-folderid");if(!o)return e.goError(y["\uc774\ub3d9\ud558\uc2e4 \ubb38\uc11c\ud568\uc744 \uc120\ud0dd\ud574\uc8fc\uc2ed\uc2dc\uc694."]),e("#deptFolderError").addClass("enter error").focus(),!1;if(o==a)return e.goError(y["\ub3d9\uc77c\ud55c \ubb38\uc11c\ud568\uc785\ub2c8\ub2e4."]),e("#deptFolderError").addClass("enter error").focus(),!1;var u=e.goPreloader();s.parent().find("#allSelectTr").is(":visible")&&s.parent().find("#allSelectMsg3").attr("data-value")=="folder"?(f=new p({folderType:"deptfolder",action:"move"}),!t.isUndefined(n.collection.keyword)&&n.collection.keyword.trim().length>0&&(f.setSearch(n.collection.searchtype,n.collection.keyword),n.collection.duration=="period"&&f.setDuration({duration:n.collection.duration,fromDate:r.util.toISO8601(n.collection.fromDate),toDate:r.util.searchEndDate(n.collection.toDate)}))):f=new w({ids:i}),f.set({folderId:o}),f.setFolderId(a),f.save({},{silent:!0,type:"PUT",beforeSend:function(){u.render()},success:function(){e.goMessage(y["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \uc774\ub3d9\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),s.close(),n.$el.find("#checkedAllDeptDoc").attr("checked",!1),n.collection.fetch()},error:function(t,n){var r=JSON.parse(n.responseText);e.goError(r.message)},complete:function(){u.release()}})}},{btext:g["\ucde8\uc18c"],btype:"cancel"}]}),h=new c({docIds:i,deptId:u,deptName:o});h.render(),i!=""&&l.reoffset()},deptDocDelete:function(){var n=this,i=[],s=this.folderId,o=e("input[name=checkbox]:checked");o.each(function(){i.push(e(this).attr("data-id"))});if(e.isEmptyObject(i)){e.goError(y["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var u;e.goConfirm(y["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",function(o){var a=e.goPreloader();o.parent().find("#allSelectTr").is(":visible")&&o.parent().find("#allSelectMsg3").attr("data-value")=="folder"?(u=new p({folderType:"deptfolder",action:"remove"}),!t.isUndefined(n.collection.keyword)&&n.collection.keyword.trim().length>0&&(model.setSearch(n.collection.searchtype,n.collection.keyword),n.collection.duration=="period"&&model.setDuration({duration:n.collection.duration,fromDate:r.util.toISO8601(n.collection.fromDate),toDate:r.util.searchEndDate(n.collection.toDate)}))):u=new E({ids:i}),u.setFolderId(s),u.save({},{silent:!0,type:"PUT",beforeSend:function(){a.render()},success:function(){e.goMessage(y["\uc120\ud0dd\ud55c \ud56d\ubaa9\uc774 \uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4"]),n.$el.find("#checkedAllDeptDoc").attr("checked",!1),n.collection.fetch()},error:function(){e.goError(g["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])},complete:function(){a.release()}})})},renderLayout:function(){var t={"\uc81c\ubaa9":g["\uc81c\ubaa9"],"\uae30\uc548\uc790":y["\uae30\uc548\uc790"],"\uac80\uc0c9":g["\uac80\uc0c9"],"\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958":y["\ubd80\uc11c \ubb38\uc11c\ud568 \ubd84\ub958"],"\uc774\ub3d9":g["\uc774\ub3d9"],"\uc0ad\uc81c":g["\uc0ad\uc81c"],"\uacb0\uc7ac\uc591\uc2dd":y["\uacb0\uc7ac\uc591\uc2dd"],"\uacb0\uc7ac\uc120":y["\uacb0\uc7ac\uc120"],"\ubb38\uc11c\ubc88\ud638":y["\ubb38\uc11c\ubc88\ud638"],"\uae30\uc548\ubd80\uc11c":y["\uae30\uc548\ubd80\uc11c"],placeholder_search:g["\ud50c\ub808\uc774\uc2a4\ud640\ub354\uac80\uc0c9"],"\uc790\ub3d9\ubd84\ub958":y["\uc790\ub3d9\ubd84\ub958"],"\ubd84\ub958":y["\ubd84\ub958"]};this.$el.html(m({lang:t,buttons:this.buttons,isRef:this.isRef,classifyManagable:this.classifyManagable,showDeptSearchType:this.showDeptSearchType})),this.contentTop.render(),this.contentTop.setTitle(""),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.$el.find("input[placeholder]").placeholder(),this.renderPageSize(),(new l({getDownloadURL:e.proxy(this.collection.getCsvURL,this.collection),appendTarget:this.$el.find("#docToolbar > div.critical")})).render()},toggleCheckbox:function(t){e(t.currentTarget).is(":checked")?(e(t.currentTarget).attr("checked",!0),e("td.check :checkbox:checked").length==this.collection.pageSize&&(this.$el.find("#checkedAllDeptDoc").attr("checked",!0),this.toggleSelectAllTpl(!0))):(this.$el.find("#checkedAllDeptDoc").attr("checked",!1),e(t.currentTarget).attr("checked",!1),this.toggleSelectAllTpl(!1))},renderTitle:function(e){this.contentTop.setTitle(e),this.contentTop.render()},renderPageSize:function(){this.pageSizeView=new u({pageSize:this.collection.pageSize}),this.pageSizeView.render(),this.pageSizeView.bind("changePageSize",this.selectPageSize,this)},renderPages:function(){this.pageView=new o({pageInfo:this.collection.pageInfo()}),this.pageView.bind("paging",this.selectPage,this),this.$el.find("div.tool_absolute > div.dataTables_paginate").remove(),this.$el.find("div.tool_absolute").append(this.pageView.render().el),this.$el.find("#checkedAllDeptDoc").attr("checked",!1)},resetList:function(t){this.collection.extData!=null&&(this.deptName=this.collection.extData.deptName,this.renderTitle(this.collection.extData.folderName+' <span class="meta">in '+this.collection.extData.deptName+"</span>"),this.deptId=this.collection.extData.deptId);var n=this.collection.url().replace("/api/",""),i=r.router.getUrl().replace("#","");i.indexOf("?")<0?r.router.navigate(n,{replace:!0}):i!=n&&r.router.navigate(n,{trigger:!1,pushState:!0}),e(".list_approval > tbody").empty(),this.completeDocumentTotal=this.collection.total,this.renderSelectAllTpl();var s=this.columns,o="approval";t.each(function(t){var n=new f({model:t,isCheckboxVisible:t.isCompleted(),listType:o,columns:s});e(".list_approval > tbody").append(n.render().el)}),t.length==0&&e(".list_approval > tbody").html(v({columns:this.columns,lang:{doclist_empty:y["\ubb38\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}})),this.renderPages()},selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch()},selectPageSize:function(e){this.collection.setPageSize(e),this.collection.fetch()},toggleDocClassifyMenu:function(t){var n=e(t.currentTarget).find(".array_option");n.is(":visible")?n.hide():n.show()},release:function(){this.$el.off(),this.$el.empty()},checkedAllDoc:function(){e("#checkedAllDeptDoc").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1),this.toggleSelectAllTpl(e("#checkedAllDeptDoc").is(":checked"))},toggleSelectAllTpl:function(t){var n=this.completeDocumentTotal>this.collection.pageSize;t&&n?e("#allSelectTr").show():e("#allSelectTr").hide()}});return S});