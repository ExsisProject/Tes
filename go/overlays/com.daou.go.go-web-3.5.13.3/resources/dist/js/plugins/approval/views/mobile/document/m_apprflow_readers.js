define(["backbone","approval/collections/subscriber_groups","views/mobile/m_dept","hgn!approval/templates/mobile/document/m_apprflow_my_lines","hgn!approval/templates/mobile/document/m_apprflow_readers","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-popup"],function(e,t,n,r,i,s,o){function f(e){var t={};return e&&e.type&&e.type.toLowerCase()==="org"?t={id:e.id,name:e.name,deptId:e.id,deptName:e.name,deptType:!0}:(t=_.pick(e,"id","name","position","deptId","deptName","thumbnail"),t.deptType=!1),t}var u={not_allowed_docReferenceReaders:o["\uc120\ud0dd\ud55c \uadf8\ub8f9\uc73c\ub85c \ucc38\uc870\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],not_allowed_docReceptionReaders:o["\uc120\ud0dd\ud55c \uadf8\ub8f9\uc73c\ub85c \uc218\uc2e0\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],not_allowed_docReadingReaders:o["\uc120\ud0dd\ud55c \uadf8\ub8f9\uc73c\ub85c \uc5f4\ub78c\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],add_approval:o["\ucd94\uac00"],docReferenceReaders:o["\ucc38\uc870\uc790"],docReceptionReaders:o["\uc218\uc2e0\uc790"],docReadingReaders:o["\uc5f4\ub78c\uc790"],my_save:o["\ub0b4\uac00 \uc800\uc7a5\ud55c \uacb0\uc7ac\uc120 \ubaa9\ub85d"],only_pc_modify:o["\uc218\uc815\uc740 \uc624\uc9c1 PC"],my_group:o["\uac1c\uc778 \uadf8\ub8f9"],msg_empty_my_lines:o["\uac1c\uc778 \uadf8\ub8f9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],data_null:s["\ub370\uc774\ud130\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]},a=e.View.extend({events:{"click .myGroupButton":"_myApprFlowButton","click .mygroups li a[data-id]":"_selectApprFlow","click #readersAdd":"_readersAddPopup","click .readersDel":"_readersDelete"},initialize:function(n){n=n||{},this.observer=n.observer,this.docReaderType=n.readerCollection,this.docReadersCollection=new e.Collection(this.model.docInfoModel.get(this.docReaderType)),this.subscriberCollection=new t,this.observer.bind("saveApprFlowReaders",this.saveApprFlowReaders,this),this.listenTo(this.docReadersCollection,"reset change add remove",_.bind(function(){this._renderList(this.docReadersCollection),this._renderMySubscriberList()},this))},render:function(){return this._renderList(this.docReadersCollection),this.subscriberCollection.fetch({success:$.proxy(this._renderMySubscriberList,this)}),this},_renderList:function(e){var t=i({lang:u,readersName:this._getReadersName(),data:e.toJSON(),editable:this._editable(),isDept:function(){return this.reader.deptType?!0:!1},isReadingReders:this._isReadingReders(),assignedReadingReadersRemovable:this._assignedReadingReadersRemovable()});this.$el.html(t)},_getReadersName:function(){var e=u.docReferenceReaders;return this.docReaderType=="docReferenceReaders"?e=u.docReferenceReaders:this.docReaderType=="docReceptionReaders"?e=u.docReceptionReaders:this.docReaderType=="docReadingReaders"&&(e=u.docReadingReaders),e},_editable:function(){if(this.docReaderType=="docReferenceReaders")return this.model.isStatusComplete()||this.model.isStatusReturned()?!1:this.model.Permission.canEditRefererList();if(this.docReaderType=="docReceptionReaders")return this.model.isStatusReturned()?!1:this.model.Permission.canEditReceiverList();if(this.docReaderType=="docReadingReaders")return this.model.Permission.canEditReaderList()||this.model.get("actionCheck").readerEditable},_isReadingReders:function(){return this.docReaderType=="docReadingReaders"?!0:!1},_assignedReadingReadersRemovable:function(){return this.model.get("actionCheck").readerEditable?!0:!1},_readersDelete:function(e){var t=$(e.currentTarget).attr("data-id"),n=this.docReadersCollection.find(function(e){return this._getUniqId(e)==t},this);this.docReadersCollection.remove(n)},_getUniqId:function(e){return e.get("reader").id},_renderMySubscriberList:function(){$(".mygroups").html(r({lang:u,hasMyLines:!this.subscriberCollection.isEmpty(),myLines:this.subscriberCollection.map(function(e){return{id:e.get("id"),title:e.get("title"),groupCount:e.get("subscriber").nodes.length}})}))},_myApprFlowButton:function(e){var t=$(e.currentTarget);t.toggleClass("on"),t.hasClass("on")?t.siblings(".wrap_list_myApproval").slideDown(300):t.siblings(".wrap_list_myApproval").slideUp(300)},_selectApprFlow:function(e){e.preventDefault();var t=$(e.currentTarget),n=this.subscriberCollection.get(t.attr("data-id")),r=n.get("subscriber").nodes;if(!this._validateSubscriber(r))return GO.util.toastMessage(u["not_allowed_"+this.docReaderType]),!1;var i=_.map(r,function(e){return{reader:{deptId:e.nodeDeptId,deptType:e.nodeType=="department"?!0:!1,deptName:e.nodeDeptName,id:e.nodeId,name:e.nodeValue.split(" ")[0],position:e.nodeValue.split(" ")[1]?e.nodeValue.split(" ")[1]:"",thumbnail:"/"+e.nodeThumbnail}}});this.docReadersCollection=this.docReadersCollection.reset(i)},_validateSubscriber:function(e){var t=[];return this.docReaderType=="docReferenceReaders"?t=_.filter(e,function(e){return String(e.actions)=="false"}):this.docReaderType=="docReceptionReaders"?this.model.getReceiveAllowType()=="DEPARTMENT"?t=_.filter(e,function(e){return e.nodeType!="department"||String(e.actions)=="false"}):this.model.getReceiveAllowType()=="USER"?t=_.filter(e,function(e){return e.nodeType=="department"||String(e.actions)=="false"}):this.model.getReceiveAllowType()=="ALL"&&(t=_.filter(e,function(e){return String(e.actions)=="false"})):this.docReaderType=="docReadingReaders"&&(t=_.filter(e,function(e){return e.nodeType=="department"||String(e.actions)=="false"})),t.length<1},saveApprFlowReaders:function(){var e=this.model.get("docInfo");e[this.docReaderType]=this.docReadersCollection.toJSON()},_readersAddPopup:function(){var e=new n({type:this.docReaderType,sendSelectedNodesCallback:$.proxy(function(e,t,n){return _.each(n,$.proxy(function(e){this.addActivity(e)},this)),e.$el.remove(),!1},this)});e.render()},addActivity:function(e){var t;if(e&&e.type==="company")return;var n={};t=this.parseOrgTreeData(e);if(!t)return;e.type!="org"||e.type=="org"&&!e.includedSubDept?(n.merge=!0,this.docReadersCollection.add(t,n)):this.addActivityByOrg(e)},parseOrgTreeData:function(e){if(e&&!e.hasOwnProperty("id"))return!1;if(!this.isValidOrgData(e))return GO.util.toastMessage("\uc120\ud0dd\ud55c \ub300\uc0c1\uc740 \uc774 \uc591\uc2dd\uc5d0 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."),!1;var t={},n=this.docReadersCollection.find(function(t){var n=t.get("reader");if(n)return e.type=="org"?n.deptType&&n.id===e.id:!n.deptType&&n.id===e.id});return n?(GO.util.toastMessage(o["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."]),!1):{reader:f(e)}},isValidOrgData:function(e){return this.receiveAllowType=="USER"&&e.type=="org"?!1:this.receiveAllowType!="DEPARTMENT"||e.type=="org"&&e.useReference!=0?this.receiveAllowType=="ALL"&&e.useReference==0?!1:!0:!1},addActivityByOrg:function(e){function s(e,n,r){r=r||!1;var i=[];i.push(n);if(r){var s=GO.config("contextRoot")+"api/organization/dept/tree?deptid="+n.id+(r?"&scope=subdept":"");return $.ajax(s).done(_.bind(function(n){_.each(n,function(e){e.metadata.useReference&&i.push(o.call(t,e.metadata))},this),e.resolve(this.addReaders(i))},this)).fail(function(){console.log("error"),e.reject()})}e.resolve(this.addReaders(i))}function o(e){return{id:e.id,companyId:e.companyId,email:e.email,originalEmail:e["originalEmail"]==undefined?e.email:e.originalEmail,name:e.name,type:"org",code:e.code,subdept:e["childrenCount"]==0?!1:!0,useReception:!!e.useReception,useReference:!!e.useReference}}var t=this,n="gopopup-orgtab",r=[];if($("#"+n).length>0)return;var i=$.Deferred();e.includedSubDept?s.call(this,i,e,!0):s.call(this,i,e)},addReaders:function(e){var t=this,n,r={};if(!e)return;_.each(e,function(e){var i=t.docReadersCollection.find(function(t){return t.get("reader").id===e.id});if(i)return;n={reader:f(e)},t.docReadersCollection.add(n,r)})}});return a});