define("approval/components/apprflow_editor/views/referer/referer",["approval/components/apprflow_editor/views/base_tab_item","hgn!approval/components/apprflow_editor/templates/tab/layout","text!approval/components/apprflow_editor/templates/tab/header_read.html","text!approval/components/apprflow_editor/templates/tab/footer_dept.html","approval/components/apprflow_editor/views/activity_list/activity_list","approval/components/apprflow_editor/views/activity_list/doc_reader_activity_group","approval/models/subscriber_group","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a){function c(e){var t={};return e&&e.type&&e.type.toLowerCase()==="org"?t={id:e.id,name:e.name,deptId:e.id,deptName:e.name,deptType:!0}:(t=_.pick(e,"id","name","position","deptId","deptName","thumbnail"),t.deptType=!1),t}function v(){this.$el.html(t({lang:f},{activityHeader:n,activityFooter:r}))}function m(){this.docReferenceReaders=new Backbone.Collection(this.model.docInfoModel.get("docReferenceReaders")),this.activityGroupsView=new i({el:this.$el.find(".list_approval_line_wrap"),observer:this.observer}),this.activityGroupsView.addGroupView(new l({activities:this.docReferenceReaders,disable:!this.editable(),observer:this.observer,receiveAllowType:"ALL",tabId:this.getTabId(),actionCheck:this.model.get("actionCheck")})),this.listenTo(this.observer,"mySubscriberSelected",function(e){if(!this.isActivated())return;if(!g.call(this,e.nodes))return $.goError(a["\uc120\ud0dd\ud55c \uadf8\ub8f9\uc73c\ub85c \ucc38\uc870\uc790\ub97c \uc9c0\uc815\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),this.observer.trigger("deselectSubscriber"),!1;var t=_.map(e.nodes,function(e){return{reader:{deptId:e.nodeDeptId,deptType:e.nodeType=="department"?!0:!1,deptName:e.nodeDeptName,id:e.nodeId,name:e.nodeValue.split(" ")[0],position:e.nodeValue.split(" ")[1]?e.nodeValue.split(" ")[1]:""}}});this.docReferenceReaders.reset(t)}),this.listenTo(this.docReferenceReaders,"add remove reset",_.bind(function(t){var n;t instanceof Backbone.Collection?n=t:t instanceof Backbone.Model&&t.collection&&(n=t.collection),n&&(this.model.docInfoModel.set("docReferenceReaders",n.toJSON()),this.model.set("docInfoChanged",!0),this.observer.trigger("changedTabItem",this.getTabId()))},this))}function g(e){var t=[];return t=_.filter(e,function(e){return e.nodeType=="department"&&String(JSON.parse(e.actions).useReference)=="false"}),t.length<1}function y(e,t){if(this.model.docInfoModel.get("docReferenceReaders").length==0)return $.goMessage(GO.i18n(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])),!1;var n=$("input#my_subscriber_title_input").val();if(_.isEmpty(n)||n.length>this._MAX_LENGTH_OF_MY_LINE_TITLE)return $.goMessage(GO.i18n(a["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"1",arg2:"20"})),!1;var r=new o({subscriber:{nodes:(new p(this.model.docInfoModel.get("docReferenceReaders"))).toJSON()},title:n});r.save({},{success:$.proxy(function(n,r,i){$.goMessage(f.msg_save_success),this.observer.trigger("reloadMySubscriber"),e.close("",t)},this),error:function(e,t,n){$.goMessage(f.msg_duplicated_my_line_title)}})}function b(){return['<table class="table_form_mini"><form>',"<tbody><tr>","</tr><tr>",'    <th><span class="txt">'+a["\uadf8\ub8f9 \uc774\ub984"]+"</span></th>",'    <td><input id="my_subscriber_title_input" class="txt_mini w_max" type="text"></td>',"</tr>","</tbody></form></table>"].join("\n")}var f={name:u["\uc774\ub984"],department:a["\ubd80\uc11c"],readAt:"\ud655\uc778\uc2dc\uac04",remove:u["\uc0ad\uc81c"],saveMyASubscruber:a["\uac1c\uc778 \uadf8\ub8f9\uc73c\ub85c \uc800\uc7a5"],msg_duplicated_my_line_title:a["\uc911\ubcf5\ub41c \uc774\ub984\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_save_success:u["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]},l=s.extend({initialize:function(e){e=e||{},_.isString(e.receiveAllowType)&&(this.receiveAllowType=e.receiveAllowType),this.options.includeReadAt=!0,s.prototype.initialize.apply(this,arguments)},parseOrgTreeData:function(e){if(e&&!e.hasOwnProperty("id"))return!1;if(!this.isValidOrgData(e))return $.goError("\uc120\ud0dd\ud55c \ub300\uc0c1\uc740 \uc774 \uc591\uc2dd\uc5d0 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."),!1;var t={},n=this.collection.find(function(t){var n=t.get("reader");if(n)return e.type=="org"?n.deptType&&n.id===e.id:!n.deptType&&n.id===e.id});return n?($.goMessage(a["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."]),!1):{reader:c(e)}},addActivity:function(e,t){var n;if(e&&e.type==="company")return;var r={};n=this.parseOrgTreeData(e);if(!n)return;e.type!="org"||e.type=="org"&&!e.subdept?(_.isNumber(t)&&this.collection.length>t&&(r.at=t,r.merge=!0),this.collection.add(n,r),this.observer.trigger("resize")):this.addActivityByOrg(e)},addReaders:function(e){var t=this,n,r={};if(!e)return;_.each(e,function(e){var i=t.collection.find(function(t){return t.get("reader").id===e.id});if(i)return;n={reader:c(e)},t.collection.add(n,r)}),this.observer.trigger("resize")},addActivityByOrg:function(e){function s(e,n,r){r=r||!1;var i=[];i.push(n);if(r){var s=GO.config("contextRoot")+"api/organization/dept/tree?deptid="+n.id+(r?"&scope=subdept":"");return $.ajax(s).done(_.bind(function(n){_.each(n,function(e){e.metadata.useReference&&i.push(o.call(t,e.metadata))},this),e.resolve(this.addReaders(i))},this)).fail(function(){console.log("error"),e.reject()})}e.resolve(this.addReaders(i))}function o(e){return{id:e.id,companyId:e.companyId,email:e.email,originalEmail:e["originalEmail"]==undefined?e.email:e.originalEmail,name:e.name,type:"org",code:e.code,subdept:e["childrenCount"]==0?!1:!0,useReception:!!e.useReception,useReference:!!e.useReference}}var t=this,n="gopopup-orgtab",r=[];if($("#"+n).length>0)return;var i=$.Deferred();$.goPopup({id:n,pclass:"layer_confim",allowPrevPopup:!0,title:a["\ucc38\uc870\uc790 \ucd94\uac00"],message:GO.i18n(a["\ucc38\uc870\uc790 \ucd94\uac00 \ud655\uc778 \uba54\uc2dc\uc9c0"],{dept:e.name}),modal:!0,buttons:[{btype:"confirm",btext:a["\ud604\uc7ac \ubd80\uc11c\ub9cc \ucd94\uac00"],callback:function(){s.call(t,i,e)}},{btype:"confirm",btext:a["\ud558\uc704 \ubd80\uc11c \ubaa8\ub450 \ucd94\uac00"],callback:function(){s.call(t,i,e,!0)}},{btype:"close",btext:u["\ucde8\uc18c"]}]})},isValidOrgData:function(e){return this.receiveAllowType=="USER"&&e.type=="org"?!1:this.receiveAllowType!="DEPARTMENT"||e.type=="org"&&e.useReference!=0?this.receiveAllowType=="ALL"&&e.useReference==0?!1:!0:!1}}),h=Backbone.Model.extend({defaults:{nodeId:0,nodeDeptId:"",nodeCompanyId:null,nodeCompanyName:null,nodeType:"user",nodeValue:"",actions:"",members:[]},initialize:function(){this.convert(this.get("reader"))},convert:function(e){this.set("nodeId",e.id),this.set("nodeDeptId",e.deptId),this.set("nodeValue",e.name),this.set("nodeType",e["deptType"]==0?"user":"department")}}),p=Backbone.Collection.extend({model:h}),d=e.extend({className:"set_data wrap_approvalLine_set",tabId:"referer",tabName:a["\ucc38\uc870\uc790"],activityGroupsView:null,viewerType:"",_MAX_LENGTH_OF_MY_LINE_TITLE:20,initialize:function(t){e.prototype.initialize.apply(this,arguments),t=t||{},t.observer&&t.observer.hasOwnProperty("bind")?this.observer=t.observer:this.observer=_.extend({},Backbone.Events),this.viewerType="",t.hasOwnProperty("viewerType")&&(this.viewerType=t.viewerType),v.call(this),m.call(this)},events:{"click .save-mysubscriber-btn":"_saveAsPeronalSubscriber"},render:function(){this.activityGroupsView.render()},remove:function(){this.activityGroupView.remove(),e.prototype.remove.apply(this,arguments)},editable:function(){return this.model.isStatusComplete()||this.model.isStatusReturned()?!1:this.viewerType==="docmaster"||this.model.Permission.canEditRefererList()},usable:function(){return this.model.Permission.canUseRefererList()},activate:function(){e.prototype.activate.apply(this,arguments),this.activityGroupsView.activate()},_saveAsPeronalSubscriber:function(e){var t="gopopup-personalsubscriber";e.preventDefault();if($("#"+t).length>0)return;if(!this.editable())return;if(this.model.docInfoModel.get("docReferenceReaders").length==0)return $.goMessage(GO.i18n(a["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."])),!1;var n=$.goPopup({id:t,allowPrevPopup:!0,pclass:"layer_normal",header:a["\uac1c\uc778 \uadf8\ub8f9\uc73c\ub85c \uc800\uc7a5"],modal:!0,width:300,contents:b(),buttons:[{btext:u["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:_.bind(y,this)},{btext:u["\ucde8\uc18c"],btype:"cancel"}]});$("input#my_subscriber_title_input").keypress(_.bind(function(e){if(e.which==13)return y.call(this,n,e),!1},this))},deactivate:function(){e.prototype.deactivate.apply(this,arguments),this.activityGroupsView.deactivate()}});return d});