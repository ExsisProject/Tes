(function(){define(["jquery","backbone","app","approval/collections/comments","approval/models/comment","approval/views/mobile/document/m_attach_file","approval/views/mobile/document/m_comments_reply","hgn!approval/templates/mobile/document/m_comment_create","hgn!approval/templates/mobile/document/m_comment_modify","hgn!approval/templates/mobile/document/m_comment_reply_item","i18n!nls/commons","i18n!board/nls/board","i18n!approval/nls/approval","GO.util","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p={reply:c["\ub313\uae00"],save:l["\uc800\uc7a5"],cancel:l["\ucde8\uc18c"],modify:l["\uc218\uc815"],"delete":l["\uc0ad\uc81c"],comment_delete_msg:c["\ub313\uae00\uc744 \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],comment_has_reply:c["\ub313\uae00\uc774 \ub4f1\ub85d\ub41c \uae00\uc740 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],alert_length:c["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],comment_save:c["\ub313\uae00 \uc791\uc131"],comment_focus:c["\ub313\uae00 \uc4f0\uae30"],comment_modify:c["\ub313\uae00 \uc218\uc815"],comment_placeholder:c["\ub313\uae00\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694."]},d=t.View.extend({initialize:function(e){this.options=e||{};var t=this;this.docId=this.options.docId,this.options={docId:this.docId},this.commentModel=new i,this.CommentCollection=r.getCollection(this.options),this.CommentCollection.on("reset",function(){t.dataset=t.CommentCollection.toJSON(),t.render()},this),this.dataset=this.CommentCollection.toJSON()},unbindEvent:function(){this.$el.off("vclick","a.comment_delete"),this.$el.off("vclick","a#btnPostComment"),this.$el.off("vclick","a.comment_modify"),this.$el.off("vclick","a.comment_reply"),this.$el.off("vclick","a.comment_modify_cancel"),this.$el.off("vclick","a.comment_modify_save"),this.$el.off("keydown","#formPostComment"),this.$el.off("keydown","span.textarea_edit textarea")},bindEvent:function(){this.$el.on("vclick","a.comment_delete",e.proxy(this.actionDeleteComment,this)),this.$el.on("vclick","a#btnPostComment",e.proxy(this.actionPostComment,this)),this.$el.on("vclick","a.comment_modify",e.proxy(this.addModifyForm,this)),this.$el.on("vclick","a.comment_reply",e.proxy(this.addCommentReplyForm,this)),this.$el.on("vclick","a.comment_modify_cancel",e.proxy(this.removeModifyForm,this)),this.$el.on("vclick","a.comment_modify_save",e.proxy(this.actionModifyComment,this)),this.$el.on("keydown","#formPostComment",e.proxy(this.expandTextarea,this)),this.$el.on("keydown","span.textarea_edit textarea",e.proxy(this.expandTextarea,this))},setShowReplayButton:function(t){var n=5,r=e("#writeReplay");size=t||e("section.article_reply li:not(.creat)").length,size>=n?r.parents("div.optional").show():size<n&&r.parents("div.optional").hide()},render:function(){var e=this,t=u({lang:p,dataset:this.dataset,depth:function(){return this.id==this.thread?1:2},commentReply:function(){return this.id==this.thread?!0:!1},dateformat:function(){return n.util.basicDate(this.createdAt)},isWritable:function(){return this.writer.id===n.session("id")?!0:!1},parseMessage:function(){return n.util.escapeHtml(this.message)},postAttachFiles:function(){if(this.attaches)return s.render({docId:this.docId,attaches:this.attaches})}});this.$el.html(t),this.unbindEvent(),this.bindEvent(),this.setShowReplayButton(),this.renderCommentCount(),s.initImageView(this.$el)},expandTextarea:function(e){n.util.textAreaExpand(e)},renderCommentCount:function(){this.trigger("renderCommentCount")},addModifyForm:function(t){var r=this,i=e(t.currentTarget).parents("li"),s=this.CommentCollection.get(i.attr("data-id"));return t&&(t.preventDefault(),t.stopPropagation()),i.find("div.btn_wrap").hide(),i.find("p.subject").hide().after(a({docId:this.docId,commentId:s.get("thread"),id:s.get("id"),message:n.util.unescapeHtml(s.get("message")),lang:p})),i.find("textarea").focus(),!1},removeModifyForm:function(t,n){var r={};return n?r=e('li[data-id="'+n+'"]'):r=e(t.currentTarget).parents("li"),r.find("p.edit_mode, div.btn_wrap.edit, div.ipt_wrap").remove(),r.find("div.btn_wrap, p.subject").attr("style",""),!1},addCommentReplyForm:function(t){var n=e(t.currentTarget).parents("li"),r=["reply",this.docId,n.attr("data-id")].join("_"),i=this.$el.find('li[data-thread="'+n.attr("data-id")+'"]:last'),s=this.$el.has("#"+r).length;return s?this.$el.find("#"+r+" textarea").focus():(i.after('<li id="'+r+'" class="depth2" />'),o.render({docId:this.docId,commentId:n.attr("data-id"),thread:n.attr("data-id"),el:"#"+r,lang:p,collection:this.CommentCollection})),!1},actionModifyComment:function(t){var r=this,i=e(t.currentTarget).parents("li"),s=i.find("textarea"),o=s.val();docId=e(t.currentTarget).attr("data-docid"),commentId=e(t.currentTarget).attr("data-commentid"),thread=i.attr("data-thread"),data={};if(!o)return s.focus(),!1;data={message:o};var u=[],a,f=i.find("li");return f.each(function(){a={},e(this).attr("data-tmpname")&&(a.path=e(this).attr("data-tmpname")),e(this).attr("data-name")&&(a.name=e(this).attr("data-name")),e(this).attr("data-id")&&(a.id=e(this).attr("data-id")),e(this).attr("data-hostid")&&(a.hostId=e(this).attr("data-hostid")),u.push(a)}),u.length>0&&(data.attaches=u),this.commentModel.clear(),this.commentModel.set({docId:this.docId,id:i.attr("data-id"),thread:thread},{silent:!0}),this.commentModel.save(data,{success:function(t,s){i.find(".ipt_wrap").remove(),r.CommentCollection.get(t.id).set("message",t.get("message")),i.find("p.subject span.txt").html(n.util.escapeHtml(t.get("message"))).fadeOut(500,function(){e(this).fadeIn(500)}),r.removeModifyForm("",t.id),n.util.iscrollRefresh()}}),!1},actionDeleteComment:function(t){var r=this,i=e(t.currentTarget).parents("li"),s=i.attr("data-id"),o=this.CommentCollection.get(s).toJSON();return s?(o.replyCount>0?alert(p.comment_has_reply):confirm(p.comment_delete_msg)&&(console.log(r.CommentCollection.length),this.commentModel.set({docId:this.docId,commentId:s},{silent:!0}),this.commentModel.save({},{type:"DELETE",success:function(t,i){i.code==200&&r.$el.find('li[data-id="'+s+'"]').fadeOut(500,function(){e(this).remove(),r.CommentCollection.removeById(s),r.renderCommentCount(),r.setShowReplayButton(),n.util.iscrollRefresh()})}})),!1):!1},actionPostComment:function(t){var r=this,i=this.$el.find("#formPostComment"),s=i.val();if(!e.goValidation.isCheckLength(2,1e3,e.trim(s))||s==p.comment_placeholder){alert(n.i18n(p.alert_length,{arg1:"2",arg2:"1000"}));return}e(t.currentTarget).hide(),this.commentModel.clear(),this.commentModel.set({docId:this.docId},{silent:!0}),this.commentModel.save({message:s},{success:function(e,t){r.CommentCollection.fetch({data:{offset:"1000"},async:!1,reset:!0}),r.setShowReplayButton(),n.util.iscrollRefresh()}}),t.stopPropagation()}},{__instance__:null,create:function(){return this.__instance__=new this.prototype.constructor({el:e("#content")}),this.__instance__},render:function(){var e=this.create(),t=arguments.length>0?Array.prototype.slice.call(arguments):[];return this.prototype.render.apply(e,t)}});return d})}).call(this);