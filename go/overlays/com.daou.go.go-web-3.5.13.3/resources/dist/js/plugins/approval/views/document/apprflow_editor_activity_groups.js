(function(){define(["jquery","backbone","app","approval/models/activity","approval/models/appr_activity_group","approval/models/appr_line","approval/collections/appr_activity_groups","approval/collections/activities","hgn!approval/templates/document/apprflow_activity_group","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-sdk","jquery.jstree","jquery.go-popup","jquery.go-grid","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f,l){var c={header:l["\uacb0\uc7ac \uc815\ubcf4"],save_as_my_line:l["\uac1c\uc778 \uacb0\uc7ac\uc120\uc73c\ub85c \uc800\uc7a5"],delete_as_my_line:l["\uac1c\uc778 \uacb0\uc7ac\uc120 \uc0ad\uc81c"],my_line_name:l["\uacb0\uc7ac\uc120 \uc774\ub984"],normal:l["\uc77c\ubc18"],my_lines:l["\ub098\uc758\uacb0\uc7ac\uc120"],draft:l["\uae30\uc548"],name:f["\uc774\ub984"],dept:l["\ubd80\uc11c"],line:l["\ub77c\uc778"],status:l["\uc0c1\ud0dc"],approval:l["\uacb0\uc7ac"],agreement:l["\ud569\uc758"],check:l["\ud655\uc778"],agreement_type:l["\ud569\uc758\ubc29\uc2dd"],agreement_linear:l["\uc21c\ucc28\ud569\uc758"],agreement_parallel:l["\ubcd1\ub82c\ud569\uc758"],activityType:l["\ud0c0\uc785"],add:f["\ucd94\uac00"],"delete":f["\uc0ad\uc81c"],confirm:f["\ud655\uc778"],cancel:f["\ucde8\uc18c"],add_activity:l["\ub4dc\ub798\uadf8\ud558\uc5ec \uacb0\uc7ac\uc120\uc744 \ucd94\uac00\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],msg_duplicate_activity:l["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."],msg_max_approval_count_exceed:l["\uacb0\uc7ac\uc790 \uc218\uac00 \ucd5c\ub300 \uacb0\uc7ac\uc790 \uc218\ub97c \ub118\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_selected:l["\uc120\ud0dd\ub41c \ub300\uc0c1\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_not_deletable_status_activity:l["\uc0ad\uc81c\ud560 \uc218 \uc5c6\ub294 \uc0c1\ud0dc\uc758 \uacb0\uc7ac\uc790 \uc785\ub2c8\ub2e4."],msg_not_deletable_assigned_activity:l["\uc9c0\uc815 \uacb0\uc7ac\uc790\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_save_success:f["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],msg_not_addable_position:l["\uc644\ub8cc\ub41c \uacb0\uc7ac \uc55e\uc5d0 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_duplicated_my_line_title:l["\uc911\ubcf5\ub41c \uc774\ub984\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_maxCount:l["\uacb0\uc7ac\uc790\ub97c \ucd5c\ub300\uce58\ubcf4\ub2e4 \ub118\uac8c \ud560\ub2f9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],msg_my_line_set_error_assigned_deleted:l["\uc9c0\uc815 \uacb0\uc7ac\uc790\ub294 \uaf2d \ud3ec\ud568\ub418\uc5b4\uc57c \ud569\ub2c8\ub2e4."],msg_my_line_set_error_not_matching_group_count:l["\uacb0\uc7ac\uc120\uc758 \uac2f\uc218\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."],msg_parallel_agreement_should_has_2_more_agreement:l["\ubcd1\ub82c\ud569\uc758\ub294 \uc5f0\uc18d\ub41c \ub458 \uc774\uc0c1\uc758 \ud569\uc758\uac00 \ud544\uc694\ud569\ub2c8\ub2e4."],msg_not_belong_to_department_user:l["\ubd80\uc11c\uac00 \uc5c6\ub294 \uc0ac\uc6a9\uc790\ub294 \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],notAddable:l["\uc774 \uacb0\uc7ac\uce78\uc5d0\ub294 \uacb0\uc7ac\uc790\ub97c \ucd94\uac00\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]},h=t.Model.extend({originGroups:null,assignedActivityDeletable:!1,initialize:function(e){_.isBoolean(e.assignedActivityDeletable)&&(this.assignedActivityDeletable=e.assignedActivityDeletable),_.isArray(e.original)&&(this.originGroups=new o(e.original)),_.isNull(this.originGroups)&&this.throwError('No "original" was set - required.')},makeData:function(e){var t=new o(e);return this._validateGroupCountMatching(t)||this.throwError(c.msg_my_line_set_error_not_matching_group_count),this.originGroups.each(function(e,n){var r=t.at(n);this._preValidateForGroupMerge(e,r)||this.throwError(c.msg_my_line_set_error_maxCount);var i=this._mergeNewGroupToOldGroup(e,r);this._postValidateForGroupMerge(e,i)||this.throwError(c.msg_my_line_set_error_assigned_deleted),e.set("activities",i.get("activities"))},this),this.originGroups.toJSON()},_validateGroupCountMatching:function(e){return this.originGroups.length==e.length},_preValidateForGroupMerge:function(e,t){return e.get("maxApprovalCount")>=t.getApprovalAndDraftActivities().length},_mergeNewGroupToOldGroup:function(e,t){var n=new i,r=new u(t.get("activities")),s=new u(e.get("activities")),o=s.selectOnlyAssigned();return n.set("activities",[]),s.each(function(e){e.isDraft()&&n.addActivity(e.clone().toJSON())}),r.each(function(e){var t=e.clone().toJSON();o.isExistActivity(e)&&(t.assigned=!0),n.addActivity(t)}),n},_postValidateForGroupMerge:function(e,t){if(this.assignedActivityDeletable)return!0;var n=!0,r=new u(e.get("activities")),i=new u(t.get("activities")),s=r.selectOnlyAssigned();return s.each(function(e){i.isExistActivity(e)||(n=!1)}),n},throwError:function(e){var t=function(e){this.name="ActivityGroupsSetter",this.message=e};throw new t(e)}}),p=t.View.extend({tagName:"div",className:"activity_group",observer:null,actionCheck:null,index:null,isNullGroup:!1,isArbitraryCheckVisible:!1,initialize:function(t){this.model=t.model,this.index=t.index,this.observer=t.observer,this.actionCheck=t.actionCheck,this.isArbitraryCheckVisible=t.isArbitraryCheckVisible,_.isNull(this.model)&&(this.isNullGroup=!0),this.$el.off("click",".add_activity"),this.$el.off("click",".delete_activity"),this.$el.off("change","input[name=type]"),this.$el.off("click","input[type=checkbox]"),this.$el.on("click",".add_activity",e.proxy(this._onAddArrowClicked,this)),this.$el.on("click",".delete_activity",e.proxy(this._onRemoveButtonClicked,this)),this.$el.on("change","select",e.proxy(this._onTypeOptionChanged,this)),this.$el.on("click","input[type=checkbox]",e.proxy(this._onArbitraryClicked,this))},render:function(){var e={"isNullGroup?":this.isNullGroup,isArbitraryCheckVisible:this.isArbitraryCheckVisible,isPermissibleArbitraryDecision:this.actionCheck.isPermissibleArbitraryDecision,lang:c};return this.isNullGroup||(e=_.extend(this._convertToTmplData(this.model),e),e.useCheckActivity=this.actionCheck.useCheckActivity,e.isNotAddableEmptyGroup=this.model.isNotAddableEmptyGroup()),this.$el.html(a(e)),this.isNullGroup?this.$el.addClass("hidden_and_empty_group"):(this._applySortableFunction(),this.$el.attr("data-index",this.index),this.observer.trigger("activateDNDDroppable"),this.observer.trigger("resize")),this},_applySortableFunction:function(){var t=function(t,n){var r=[];this.$el.find("tr").each(function(t,n){r.push({userId:e(n).attr("data-userId"),deptId:e(n).attr("data-deptId")})}),this.model.sortActivitiesByUserIdAndDeptId(r),this.render()};this.$el.sortable({items:"tr:not(.inactive)",placeholder:"ui-state-highlight",stop:e.proxy(t,this)}),this.$el.filter("input").disableSelection()},addActivity:function(t,n){if(_.isNull(t)||_.isUndefined(t)||_.isEmpty(t))return e.goMessage(c.msg_not_selected),!1;var i={};return t["type"]=="MEMBER"||t["type"]=="MASTER"||t["type"]=="MODERATOR"?i={type:"APPROVAL",name:c.approval,deptId:t.deptId,deptName:t.deptName,userId:t.id,userName:t.name,userDuty:t.duty,userPosition:t.position,displayName:t.displayName,thumbnail:t.thumbnail}:i={type:"AGREEMENT",name:c.agreement,deptId:t.id,deptName:t.name,userId:null,userName:null,userPosition:null,displayName:t.name},this.model.isExistActivity(i)?(e.goMessage(c.msg_duplicate_activity),!1):r.validate(i)?this.model.isFullMaxApprovalCount()?(e.goMessage(c.msg_max_approval_count_exceed),!1):n!="last"&&!this.model.validateAddPosition(n)?(e.goMessage(c.msg_not_addable_position),!1):(this.model.addActivity(i,n),this.render(),!0):(e.goMessage(c.msg_not_belong_to_department_user),!1)},clearDragDropLineCss:function(){this.$el.find("tr.activity > td").attr("style","")},drawDragDropLineCss:function(t){var n;t=="last"?n=this.$el.find("tr.activity:last"):n=this.$el.find("tr.activity:eq("+t+")");var r=10;setTimeout(function(){n.find("td").each(function(){e(this).css({"border-bottom":"2px solid black"})})},r)},_convertToTmplData:function(e){var t=new u(e.get("activities")||[]),n=this.actionCheck.useCheckActivity;return isArbitraryCheckVisible=this.isArbitraryCheckVisible,{groupName:e.get("name"),hasActivities:t.length>0,activities:t.map(function(e,r){var i=e.isCheck()&&!n;return{status:e.get("status"),userId:e.get("userId"),userName:e.get("userName"),deptId:e.get("deptId"),deptName:e.get("deptName"),activityType:e.get("statusName"),activitiesCount:t.length,isAgreementType:e.isAgreement(),isApprovalType:e.isApproval(),isCheckType:e.isCheck(),isDisabledAssignedCheckType:i,isCheckTypeVisible:i||n,arbitraryCheckable:isArbitraryCheckVisible&&e.isApproval(),isArbitraryChecked:e.isArbitraryChecked(),isEnabled:e.isDeletable()}})}},_onAddArrowClicked:function(){this.observer.trigger("addActivity",e.proxy(this.addActivity,this),this)},_onRemoveButtonClicked:function(t){var n=e(t.currentTarget).hasClass("delete_activity")?e(t.currentTarget):e(t.currentTarget).hasClass("delete_activity").parent(),r=n.parent().parent(),i=r.attr("data-userId"),s=r.attr("data-deptId");i==""&&(i=null),s==""&&(s=null);var o=new u(this.model.get("activities")),a=o.getByUserIdAndDeptId(i,s);return a.isAssigned()&&!this.actionCheck.assignedActivityDeletable?(e.goMessage(c.msg_not_deletable_assigned_activity),!1):a.isDeletableStatus()?(this.model.removeActivityByUserIdAndDeptId(i,s),this.render(),!0):(e.goMessage(c.msg_not_deletable_status_activity),!1)},_onTypeOptionChanged:function(t){var n=e(t.target),r=n.parent().parent(),i=r.attr("data-userId"),s=r.attr("data-deptId");this.model.setActivityType(i,s,n.val(),c[n.val().toLowerCase()]),this.render()},_onArbitraryClicked:function(t){var n=e(t.target),r=n.parent().parent(),i=r.attr("data-userId"),s=r.attr("data-deptId"),o=n.is(":checked");this.model.setArbitrarilyDecidable(i,s,o)}}),d=t.View.extend({el:"#activity_groups",observer:null,collection:null,actionCheck:null,groupViewList:null,isArbitraryCheckVisible:!1,initialize:function(e){this.observer=e.observer;if(_.isArray(e.activityGroups)){this.collection=new o;var t=new o(e.activityGroups);t.each(function(e){var t=e.clone();this.collection.add(t)},this)}_.isObject(e.actionCheck)&&(this.actionCheck=e.actionCheck),_.isBoolean(e.isArbitraryCheckVisible)&&(this.isArbitraryCheckVisible=e.isArbitraryCheckVisible),_.isBoolean(e.isPermissibleArbitraryDecision)&&(this.isPermissibleArbitraryDecision=e.isPermissibleArbitraryDecision),this.observer.bind("myLineSelected",this.replaceActivityGroupsByMyLine,this),this.observer.bind("dropCheck",this.drawDNDLine,this),this.observer.bind("dropFinish",this.addActivityByDND,this),this.observer.bind("dropOut",this.clearAllGroupsDragDropLineCss,this)},render:function(){return this.$el.empty(),this.groupViewList=[],this.collection.each(function(e,t){var n=new p({model:e,observer:this.observer,actionCheck:this.actionCheck,isArbitraryCheckVisible:this.isArbitraryCheckVisible,isPermissibleArbitraryDecision:this.isPermissibleArbitraryDecision,index:t});n.render(),this.groupViewList.push(n),this.$el.append(n.$el)},this),this._makeEmptyGroupToSpareSpace(),this._resizeEmptyGroupView(),this.observer.trigger("activateDNDDroppable"),this.observer.bind("resize",this._resizeEmptyGroupView,this),this.$el},_makeEmptyGroupToSpareSpace:function(){this.emptyGroupView=new p({model:null}),this.emptyGroupView.render(),this.$el.append(this.emptyGroupView.$el)},_resizeEmptyGroupView:function(){var e=parseInt(this.$el.css("height")),t=0,n=0,r=20;_.each(this.groupViewList,function(e){t+=parseInt(e.$el.css("height"))}),n=e-t;if(n<r)return;this.emptyGroupView.$el.css({height:n-r})},getCollectionJSON:function(){return this.collection.toJSON()},getActivityGroupsWithoutDraftActivity:function(){var e=[];return this.collection.each(function(t){var n=t.clone(),r=new u(n.get("activities"));r.removeDraftActivity(),n.set("activities",r.toJSON()),e.push(n.toJSON())}),e},validateMaxApprovalCount:function(){var e=!1;return this.collection.each(function(t){t.isExceedMaxApprovalCount()&&(e=!0)}),!e},hasSerialParallelAgreement:function(){var e=!1;return this.collection.each(function(t){var n=new u(t.get("activities")),r=!1;n.each(function(t){t.isAgreement()?r?e=!0:r=!0:r=!1})}),e},drawDNDLine:function(){var e=arguments[0],t=arguments[1];if(e=="last"&&t=="last"){var n=_.last(this.groupViewList);return n.drawDragDropLineCss("last"),!0}if(!this.collection.validateAddPosition(e,t))return!1;this.clearAllGroupsDragDropLineCss();var n=this.groupViewList[e];return n.drawDragDropLineCss(t-1),!0},addActivityByDND:function(){var e=arguments[0],t=arguments[1],n=arguments[2];this.clearAllGroupsDragDropLineCss();if(e=="last"&&t=="last"){var r=_.last(this.groupViewList);r.addActivity(n,"last")}else if(this.collection.validateAddPosition(e,t)){var r=this.groupViewList[e];r.addActivity(n,t)}},clearAllGroupsDragDropLineCss:function(){_.each(this.groupViewList,function(e){e.clearDragDropLineCss()})},replaceActivityGroupsByMyLine:function(t){var n=new h({assignedActivityDeletable:this.actionCheck.assignedActivityDeletable,original:this.collection.toJSON()});try{var r=n.makeData(t);this.collection=new o(r),this.render()}catch(i){e.goMessage(i.message)}}});return d})}).call(this);