define(["backbone","app","when","approval/views/content_top","approval/views/official_document/toolbar","approval/views/official_document/document","approval/views/document/official_doc_receiver_list","approval/models/document","approval/models/official_preview","approval/views/document/apprflow_editor","approval/views/side","hgn!approval/templates/official_document/main","i18n!nls/commons","i18n!approval/nls/approval"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d={"\uacb0\uc7ac\ubb38\uc11c\uba85":p["\uacb0\uc7ac\ubb38\uc11c\uba85"],"\uae30\uc548\uc790":p["\uae30\uc548\uc790"],"\uacb0\uc7ac\uc790":p["\uacb0\uc7ac\uc790"],"\uae30\uc548\uc758\uacac":p["\uae30\uc548\uc758\uacac"],"\uacb0\uc7ac\uc758\uacac":p["\uacb0\uc7ac\uc758\uacac"],"\uacb0\uc7ac\ube44\ubc00\ubc88\ud638":p["\uacb0\uc7ac\ube44\ubc00\ubc88\ud638"],"\uc804\uacb0":p["\uc804\uacb0"],"\uc804\uacb0\uc124\uba85":p["\uc804\uacb0\uc124\uba85"],"\uacb0\uc7ac\uc635\uc158":p["\uacb0\uc7ac\uc635\uc158"],"\uacb0\uc7ac\uc120":p["\uacb0\uc7ac\uc120"],"\ubb38\uc11c\uc815\ubcf4":p["\ubb38\uc11c\uc815\ubcf4"],"\ubcc0\uacbd\uc774\ub825":p["\ubcc0\uacbd\uc774\ub825"],"\uacf5\ubb38\ubc1c\uc1a1":p["\uacf5\ubb38\ubc1c\uc1a1"],"\uc5f4\ub78c\uc790 \ucd94\uac00":p["\uc5f4\ub78c\uc790 \ucd94\uac00"],"\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694":p["\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694"],"\ubaa9\ub85d\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4":p["\ubaa9\ub85d\uc73c\ub85c \uc774\ub3d9\ud569\ub2c8\ub2e4"],"\uc218\uc2e0":p["\uc218\uc2e0"],"\uc758\uacac":"\uc758\uacac","\uacf5\ubb38 \ubc1c\uc1a1 \ucde8\uc18c \uc5ec\ubd80":"\uacf5\ubb38 \ubc1c\uc1a1\uc744 \ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?","\uacf5\ubb38 \uc7ac\ubc1c\uc1a1 \uc5ec\ubd80":"\uacf5\ubb38\uc744 \uc7ac\ubc1c\uc1a1 \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"},v=['<form onsubmit="return false;">',"<fieldset>",'<table class="form_type">',"<tbody>","<tr>",'<th><span class="title">{{lang.\uc758\uacac}}</span></th>',"<td>",'<div class="wrap_txtarea">','<textarea class="w_max textarea" id="textarea-desc" name="description" placeholder="{{lang.\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694}}" rows="7"></textarea>',"</div>","</td>","</tr>","</tbody>","</table>","</fieldset>","</form>"].join(""),m=e.Model.extend({url:function(){return["/api/approval/official",this.officialId].join("/")},initialize:function(e){this.officialId=e.officialId},getShowUrl:function(){var e=this.officialId.split("?")[0];return"/approval/official/"+e},getFullShowUrl:function(){return window.location.protocol+"//"+window.location.host+GO.contextRoot+"app"+this.getShowUrl()},getOfficialId:function(){return this.get("officialVersion").id},convertToApprDocModel:function(){var e=new u({document:{documentId:this.get("officialVersion").documentId,title:this.get("title")},actionCheck:{},docInfo:{officialVersions:this.getOfficialVersions()},approvable:this.get("approvable"),reRequestable:this.get("reRequestable"),retractable:this.get("retractable")});return e},getOfficialVersions:function(){return[this.get("officialVersion")]}}),g=e.Model.extend({}),y=e.View.extend({el:"#content",initialize:function(e){this.options=e||{},this.officialId=this.options.officialId,this.allowAction=!0,this.isPopup=this.options.isPopup||!1,this.model=new m({officialId:this.officialId}),this.selectSideMenu()},render:function(){n(this.fetchModel()).then(_.bind(function(){this.$el.html(c({lang:d})),this.renderContentTop(),this.renderSubView(),this.bindEvent()},this)).otherwise(function(t){console.log(t.stack)})},renderSubView:function(){this.toolbarView=new i({model:this.model,isPopup:this.isPopup}),this.documentView=new s({model:this.model,isPopup:this.isPopup}),this.officialDocReceiverView=new o({dataList:this.model.getOfficialVersions(),type:"official",isAdmin:!1}),this.assign(this.toolbarView,"div.tool_bar"),this.assign(this.documentView,"div.approval_type"),this.append(this.officialDocReceiverView,"div.doc-meta-container")},bindEvent:function(){this.toolbarView.bind("officialFlow",this.officialFlow,this),this.toolbarView.bind("showPopup",this.showPopup,this),this.toolbarView.bind("showDocumentPopup",this.showDocumentPopup,this),this.toolbarView.bind("doPrint",this.doPrint,this),this.toolbarView.bind("actList",this.navigateToBackList,this),this.toolbarView.bind("actReturn",this.actReturn,this),this.toolbarView.bind("actApprove",this.actApprove,this),this.toolbarView.bind("actRetractable",this.actRetractable,this),this.toolbarView.bind("actReRequestable",this.actReRequestable,this)},renderContentTop:function(){this.contentTop=r.getInstance(),this.contentTop.setTitle(this.model.get("title")),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el),this.isPopup&&this.$el.find("header.content_top .combine_search").remove()},selectSideMenu:function(){GO.router.getPackageName()==="approval"&&this.docId!==sessionStorage.getItem("list-history-doc-id")&&l.apprSelectSideMenu(sessionStorage.getItem("list-history-baseUrl"))},officialFlow:function(e){var t=new f({apprDocumentModel:this.model.convertToApprDocModel(),viewerType:"official_document",saveCallback:$.proxy(function(e){e.get("docInfoChanged")&&(this.model.set("officialVersion",_.first(e.get("docInfo").officialVersions)),this.updateOfficialInfo())},this)});t.render()},updateOfficialInfo:function(){var e=this,t=new g(this.model.get("officialVersion"));t.save({},{type:"PUT",url:["/api/approval/official/addreceiver",this.model.getOfficialId()].join("/"),success:function(t,n){n.code==200&&e.render()},error:function(e,t){var n=JSON.parse(t.responseText);$.goAlert(data.responseJSON.message)}})},showPopup:function(){var e=this.model.getFullShowUrl()+"/popup";window.open(e,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},showDocumentPopup:function(){var e=window.location.protocol+"//"+window.location.host+GO.contextRoot+"app"+"/approval/document/"+this.model.get("officialVersion").documentId+"/popup";window.open(e,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},doPrint:function(){var e=this.model.get("officialVersion"),t=this.model.get("title"),n={docInfo:{officialVersions:[e]},document:{documentId:e.documentId,docBodyContent:e.docBody,title:t}},r=new a(n);GO.util.store.set("official-preview-data",r.toJSON());var i=r.getFullShowUrl();window.open(i,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},actReturn:function(){var e=this,t=[];t.push({btext:p["\ubc18\ub824"],btype:"confirm",autoclose:!1,callback:function(t){e.saveApprAction(t,"RETURN")}}),t.push({btext:h["\ucde8\uc18c"],btype:"cancel"}),$.goPopup({pclass:"layer_normal layer_approval",header:p["\ubc18\ub824"],modal:!0,draggable:!0,width:500,contents:e.getActDocument(),buttons:t})},actApprove:function(){var e=this,t=[];t.push({btext:p["\uc2b9\uc778"],btype:"confirm",autoclose:!1,callback:function(t){e.saveApprAction(t,"APPROVE")}}),t.push({btext:h["\ucde8\uc18c"],btype:"cancel"}),$.goPopup({pclass:"layer_normal layer_approval",header:p["\uc2b9\uc778"],modal:!0,draggable:!0,width:500,contents:e.getActDocument(),buttons:t})},actRetractable:function(){var e=this,t=$.goConfirm(d["\uacf5\ubb38 \ubc1c\uc1a1 \ucde8\uc18c \uc5ec\ubd80"],"",function(t){e.saveApprAction(t,"RETRACT")})},actReRequestable:function(){var e=this,t=$.goConfirm(d["\uacf5\ubb38 \uc7ac\ubc1c\uc1a1 \uc5ec\ubd80"],"",function(t){e.saveApprAction(t,"REREQUEST")})},saveApprAction:function(e,t){var n=this;if(!this.allowAction)return;var r="",i="document.draftedAt",s="desc",o=sessionStorage.getItem("list-history-searchtype"),u=sessionStorage.getItem("list-history-keyword")&&sessionStorage.getItem("list-history-keyword").replace(/\+/gi," "),a="all",f="",l="",c="",h="",p=!1;sessionStorage.getItem("list-history-keyword")&&sessionStorage.getItem("list-history-property")!=""&&(i=sessionStorage.getItem("list-history-property")),sessionStorage.getItem("list-history-direction")&&sessionStorage.getItem("list-history-direction")!=""&&(s=sessionStorage.getItem("list-history-direction")),sessionStorage.getItem("list-history-duration")&&sessionStorage.getItem("list-history-duration")!=""&&(a=sessionStorage.getItem("list-history-duration")),a=="period"&&sessionStorage.getItem("list-history-fromDate")&&sessionStorage.getItem("list-history-fromDate")!=""&&(f=sessionStorage.getItem("list-history-fromDate"),l=sessionStorage.getItem("list-history-toDate"));if(_.contains(["APPROVE","RETURN"],t)){c=$("#textarea-desc").val();if(!this.actionApprValidate("#textarea-desc",e,t))return!1}h=$.param({comment:c}),t=="APPROVE"?(r=["/api/approval/official/approve",this.model.getOfficialId()].join("/"),p=!0):t=="RETURN"?(r=["/api/approval/official/return",this.model.getOfficialId()].join("/"),p=!0):t=="RETRACT"?r=["/api/approval/official/cancel",this.model.getOfficialId()].join("/"):t=="REREQUEST"&&(r=["/api/approval/official/rerequest",this.model.getOfficialId()].join("/"));var d=$.goPreloader();this.allowAction=!1,$.ajax({url:_.isEmpty(h)?r:r+"?"+h,type:"PUT",beforeSend:function(){d.render()},dataType:"json",contentType:"application/json"}).done(function(e,t,r){n.isPopup?window.close():p?n.navigateToBackList():n.navigateToShow(n.model.getOfficialId())}).fail(function(e,t,n){$.goAlert(e.responseJSON.message)}).complete(function(){d.release(),n.allowAction=!0,e.close()})},getActDocument:function(e){return Hogan.compile(v).render({lang:d})},actionApprValidate:function(e,t,n){var r=!0;$(e).removeClass("enter error"),t.find("span.go_error").remove();var i=$(e).val();return $.trim(i)==""&&_.isEqual("RETURN",n)&&($.goError(p["\uc758\uacac\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694"],$(e)),$(e).addClass("enter error").select(),r=!1),i&&i.length>1e3&&($.goError(GO.i18n(p["{{max}}\uc790 \uc774\ud558\ub85c \uc785\ub825\ud574 \uc8fc\uc2ed\uc2dc\uc624"],{max:1e3}),$(e)),$(e).addClass("enter error").select(),r=!1),r},fetchModel:function(){var e=n.defer();return this.model.fetch({success:e.resolve,error:e.reject}),e.promise},release:function(){this.$el.off(),this.$el.empty()},assign:function(e,t){e.setElement(this.$(t)).render()},append:function(e,t){this.$(t).append(e.render().el)},navigateToBackList:function(){var e=sessionStorage.getItem("list-history-baseUrl");if(e){var t=$.param(GO.router.getSearch()),n=t?"?"+t:"";GO.router.navigate(e+n,{trigger:!0})}else GO.router.navigate("approval",{trigger:!0})},navigateToShow:function(e){this.options.isPopup?GO.router.navigate("/approval/official/"+e+"/popup",{trigger:!0}):GO.router.navigate("/approval/official/"+e,{trigger:!0})}});return y});