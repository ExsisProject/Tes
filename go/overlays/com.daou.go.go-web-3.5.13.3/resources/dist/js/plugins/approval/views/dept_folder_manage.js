define(["jquery","underscore","backbone","app","approval/views/content_top","approval/views/doclist/folderlist_item","approval/models/folderlist_item","approval/views/side","hgn!approval/templates/doclist_empty","hgn!approval/templates/dept_folder_list","hgn!approval/templates/add_org_member","hgn!approval/templates/dept_folder_add","i18n!nls/commons","i18n!approval/nls/approval","jquery.go-popup","jquery.go-orgslide","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d=n.Collection.extend({model:o,url:function(){return"/api/approval/deptfolder/"+this.deptId},setDeptId:function(e){this.deptId=e}}),v=n.Model.extend({url:function(){var e=["/api/approval/deptfolder",this.deptId,"managers"].join("/");return e},setDeptId:function(e){this.deptId=e}}),m=n.Collection.extend({model:v,url:function(){return"/api/approval/deptfolder/"+this.deptId+"/manager"},setDeptId:function(e){this.deptId=e},getUserIds:function(){return this.map(function(e){return e.get("userId")})}}),g=n.Model.extend({url:function(){var e=["/api/approval/deptfolder",this.deptId,"folder"].join("/");return e},setDeptId:function(e){this.deptId=e}}),y=n.Model.extend({url:function(){return"/api/approval/deptfolder/"+this.deptId+"/folder/sort"},setDeptId:function(e){this.deptId=e}}),b={"\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac":p["\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac"],"\ubd80\uc11c \ubb38\uc11c\ud568 \ud3f4\ub354\uba85":p["\ubd80\uc11c \ubb38\uc11c\ud568 \ud3f4\ub354\uba85"],"\ubd80\uc11c \ubb38\uc11c\ud568\uba85":p["\ubd80\uc11c \ubb38\uc11c\ud568\uba85"],"\ubd80\uc11c \ubb38\uc11c\ud568 \ub2f4\ub2f9\uc790":p["\ubd80\uc11c \ubb38\uc11c\ud568 \ub2f4\ub2f9\uc790"],"\ub2f4\ub2f9\uc790 \ucd94\uac00":p["\ub2f4\ub2f9\uc790 \ucd94\uac00"],"\uc21c\uc11c \ubc14\uafb8\uae30":p["\uc21c\uc11c \ubc14\uafb8\uae30"],"\uc0ad\uc81c":h["\uc0ad\uc81c"],"\ucd94\uac00":h["\ucd94\uac00"],"\ubb38\uc11c\ud568 \uc774\ub984":p["\ubb38\uc11c\ud568 \uc774\ub984"],"\uc0dd\uc131\uc77c":p["\uc0dd\uc131\uc77c"],"\uc0ad\uc81c":h["\uc0ad\uc81c"],"\ubb38\uc11c \uac1c\uc218":p["\ubb38\uc11c \uac1c\uc218"],"\uc218\uc815":h["\uc218\uc815"],"\uc218\uc815\uc644\ub8cc":h["\uc218\uc815\uc644\ub8cc"],"\ucde8\uc18c":h["\ucde8\uc18c"],migration:p["\ubb38\uc11c\ud568 \uc774\uad00"],"\uc124\uc815":h["\uc124\uc815"],"\uc774 \ubb38\uc11c\ud568\uc758 \uacf5\uc720 \uc124\uc815\uc740 \ubaa8\ub450 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4":p["\uc774 \ubb38\uc11c\ud568\uc758 \uacf5\uc720 \uc124\uc815\uc740 \ubaa8\ub450 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4"],"\ubb38\uc11c\ud568":p["\ubb38\uc11c\ud568"],"\uc790\ub3d9\ubd84\ub958":p["\uc790\ub3d9\ubd84\ub958"]},w=n.View.extend({columns:{"\uc120\ud0dd":p.\uc120\ud0dd,count:5},initialize:function(e){this.contentTop=i.getInstance(),this.deptId=e.deptId,this.managerCollection=new m,this.managerCollection.setDeptId(this.deptId),this.managerCollection.fetch({async:!1}),this.collection=new d,this.collection.setDeptId(this.deptId),this.collection.bind("reset",this.generateList,this),this.collection.fetch({reset:!0})},events:{"click .tab_menu > li":"selectTab","click #changeSelect":"changeSelect","click .creat .btn_wrap":"addManager","click .btn_wrap .ic_del":"deleteManager","click div.critical .btnSortable":"changeSort","click div.critical .btnAdd":"addFolder","click div.critical .btnDelete":"deleteFolder","click #migration":"callOrg"},render:function(){var e=this.managerCollection.toJSON();this.$el.html(f({managerData:e,lang:b})),this.contentTop.setTitle(p["\ubd80\uc11c \ubb38\uc11c\ud568 \uad00\ub9ac"]),this.contentTop.render(),this.$el.find("header.content_top").replaceWith(this.contentTop.el)},selectTab:function(t){if(e(t.currentTarget).attr("class")==="active")return!1;var n=e(t.currentTarget).attr("id"),i="/approval/";n=="tab_dept_folder"?i+="deptfolder/manage":n=="tab_folder_classify"&&(i+="deptfolder/"+this.deptId+"/classify/manage"),r.router.navigate(i,{trigger:!0}),e("html, body").animate({scrollTop:0})},generateList:function(t){e(".tb_part_doc > tbody").empty();var n=this.columns;t.each(function(t){var r=new s({lang:b,model:t,columns:n,deptId:this.deptId,type:"up_dept"});e(".tb_part_doc > tbody").append(r.render().el)},this),t.length==0&&e(".tb_part_doc > tbody").html(a({columns:n,lang:{doclist_empty:p["\ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]}}))},addManager:function(t){var n=this;e.goOrgSlide({header:p["\ub2f4\ub2f9\uc790 \ucd94\uac00"],desc:"",contextRoot:r.contextRoot,isCustomType:!0,memberTypeLabel:p["\ub2f4\ub2f9\uc790"],externalLang:h,isBatchAdd:!0,callback:function(e){n.addMember(e)}})},addMember:function(n){var r=this,i=e("#addMembers");if(n&&!i.find('li[data-userId="'+n.id+'"]').length){var s=new v,o=t.isArray(n)?n:[n],u=t.map(o,function(e){return e.id}),a=this.managerCollection.getUserIds(),f=t.difference(u,a);if(!f.length)return;s.setDeptId(r.deptId),s.save({},{data:JSON.stringify({ids:f}),contentType:"application/json",type:"PUT",success:function(n,s){if(s.code=="200"){e.goMessage(h["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]);var u=t.reject(o,function(e){return t.contains(a,e.id)});t.each(u,function(t){i.find("li.creat").before(l(e.extend(t,{lang:b})))}),r.managerCollection.fetch({async:!1})}},error:function(t,n){e.goMessage(h["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})}else e.goMessage(p["\uc774\ubbf8 \uc120\ud0dd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."])},deleteManager:function(t){var n=this,i=e(t.currentTarget).parents("li").attr("data-userId");e.ajax({url:r.config("contextRoot")+"api/approval/deptfolder/"+this.deptId+"/manager",contentType:"application/json",dataType:"json",data:JSON.stringify({userId:i}),type:"DELETE",success:function(){e.goMessage(h["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),e(t.currentTarget).parents("li").remove(),n.managerCollection.fetch({async:!1})},error:function(t,n,r){var i=JSON.parse(t.responseText);e.goError(i.message)}})},changeSort:function(t){var n=this;if(n.$el.find(".data_null").size()!=0)return e.goMessage(p["\ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;e(t.currentTarget).find("span.txt").text()==p["\uc21c\uc11c \ubc14\uafb8\uae30"]?n.listSortable(t):n.actionListSortPut(t)},listSortable:function(e){this.$el.find(".btnSortable").addClass("btn_save").find("span.txt").html(p["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"]),this.$el.find(".btnAdd").hide(),this.$el.find(".btnDelete").hide(),this.$el.find("#migration").hide(),this.$el.find("#tableList>tbody").sortable({opacity:"1",delay:100,cursor:"move",items:"tr",containment:".content_page",hoverClass:"ui-state-hover",forceHelperSize:"true",helper:"clone",placeholder:"ui-sortable-placeholder",start:function(e,t){t.placeholder.html("<td colspan='5'>&nbsp;</td>")}}).sortable("enable")},actionListSortPut:function(t){var n=this.$el.find("#tableList tbody"),r=n.find(".subject").map(function(t,n){return e(n).attr("data-id")}).get();if(r){var i=new y;i.setDeptId(this.deptId),i.save({ids:r},{type:"PUT"}),u.renderDeptFolder(!0)}this.$el.find(".btnSortable").removeClass("btn_save").find("span.txt").html(p["\uc21c\uc11c \ubc14\uafb8\uae30"]),this.$el.find(".btnAdd").show(),this.$el.find(".btnDelete").show(),this.$el.find("#migration").show(),this.$el.find("#tableList tbody").removeClass().sortable("disable"),u.renderDeptFolder(!0)},changeSelect:function(){e("#changeSelect").is(":checked")?e("td.check :checkbox:not(checked)").attr("checked",!0):e("td.check :checkbox:checked").attr("checked",!1)},addFolder:function(){var t=this;e.goPopup({pclass:"layer_normal",header:p["\ubd80\uc11c \ubb38\uc11c\ud568 \ucd94\uac00"],modal:!0,width:370,contents:c({lang:b}),buttons:[{btext:h["\ud655\uc778"],btype:"confirm",autoclose:!1,callback:function(e){t.deptFolderAdd(e)}},{btext:h["\ucde8\uc18c"],btype:"cancel"}]})},deptFolderAdd:function(t){var n=this,r=e("#deptFolderName").val();if(this.validate(r)){var i=new g;i.setDeptId(this.deptId),i.set({deptId:this.deptId,folderName:r},{silent:!0}),i.save({},{success:function(){e.goMessage(p["\ubb38\uc11c\ud568\uc774 \ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),n.collection.fetch({reset:!0}),t.close(),u.renderDeptFolder(!0)},error:function(t,n){var r=JSON.parse(n.responseText);e.goError(r.message)}})}},deleteFolder:function(){var t=this,n=[],i=this.columns,s=0;e("td.check :checkbox:checked").each(function(){n.push(e(this).val()),s++});if(s==0)return e.goMessage(p["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]),!1;e.goConfirm(p["\ubb38\uc11c\ud568 \uc0ad\uc81c \uacbd\uace0 \ub0b4\uc6a9"],"",function(){if(n.length){var s=e.goPreloader();s.render(),e.ajax({url:r.config("contextRoot")+"api/approval/deptfolder/"+t.deptId+"/folder",contentType:"application/json",dataType:"json",data:JSON.stringify({ids:n}),type:"DELETE",success:function(o){if(n.length>1)e.goMessage(r.i18n(p["\ubcf5\uc218\uac1c \ubb38\uc11c\ud568\uc0ad\uc81c \uc548\ub0b4\uba54\uc2dc\uc9c0"],{arg1:n.length}));else if(n.length==1){var f=t.$("#tableList tbody input:checkbox:checked").closest("tr").find("td.subject").text();e.goMessage(r.i18n(p["\ubb38\uc11c\ud568\uc0ad\uc81c \uc548\ub0b4\uba54\uc2dc\uc9c0"],{arg1:f}))}e("td.check :checkbox:checked").each(function(){e(this).parents("tr:first").remove()}),e(".tb_part_doc > tbody tr").size()==0&&e(".tb_part_doc > tbody").html(a({columns:i,lang:{doclist_empty:p["\ubb38\uc11c\ud568\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"]}})),e("#changeSelect").attr("checked",!1),u.renderDeptFolder(!0),s.release()},error:function(t,n,r){var i=JSON.parse(t.responseText);e.goError(i.message),s.release()}})}})},validate:function(t){var n=this;return t?t.length<2||t.length>20?(e.goMessage(r.i18n(h["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"2",arg2:"20"})),n.$el.find("#deptFolderName").focus(),!1):!0:(e.goMessage(p["\ubd80\uc11c \ubb38\uc11c\ud568 \ud3f4\ub354\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."]),n.$el.find("#deptFolderName").focus(),!1)},release:function(){this.$el.off(),this.$el.empty()},getCheckedFolderIds:function(){return t.map(this.$("input[type=checkbox][value]:checked"),function(t){return e(t).val()})},migration:function(t,n){var i=this,s=this.getCheckedFolderIds(),o=r.contextRoot+"api/approval/deptfolder/transfertouser/"+t;n=="MEMBER"?o=r.contextRoot+"api/approval/deptfolder/transfertouser/"+t:n=="org"&&(o=r.contextRoot+"api/approval/deptfolder/transfertodept/"+t),e.ajax({url:o,data:JSON.stringify({ids:s}),type:"PUT",dataType:"json",contentType:"application/json",success:function(t){e.goOrgSlide.close(),e.goMessage(p["\uc774\uad00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),i.collection.fetch({reset:!0}),u.reload(!0)},error:function(t,n,r){var i=JSON.parse(t.responseText);e.goError(i.message)}})},callOrg:function(){if(this.$("input[type=checkbox][value]:checked").length==0){e.goMessage(p["\uc120\ud0dd\ub41c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var t=this;e.goOrgSlide({type:"node",contextRoot:r.contextRoot,useApprReference:!0,useDisableNodeStyle:!0,callback:e.proxy(function(n){var i=n.type!="org"?"user":"dept";if(i=="dept"&&t.deptId==n.id)return e.goError(p["\uc120\ud0dd\ub41c \ub300\uc0c1\uc744 \ucd94\uac00 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;if(i=="dept"&&!n.useReference)return e.goError(p["\uc120\ud0dd\ub41c \ub300\uc0c1\uc744 \ucd94\uac00 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"]),!1;var s='<p class="add">'+r.i18n(p["\ubb38\uc11c\ud568 \uc774\uad00 \ud655\uc778"],{arg1:n.displayName?n.displayName:n.name})+"</p>"+'<p class="txt_caution">\u203b '+b["\uc774 \ubb38\uc11c\ud568\uc758 \uacf5\uc720 \uc124\uc815\uc740 \ubaa8\ub450 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4"]+"</p>";e.goConfirm(p["\ubd80\uc11c \ubb38\uc11c\ud568 \uc774\uad00"],s,function(){t.migration(n.id,n.type)})},this)})}});return w});