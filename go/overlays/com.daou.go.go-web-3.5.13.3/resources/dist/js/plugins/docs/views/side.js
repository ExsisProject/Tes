define("docs/views/side",function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("docs/collections/doc_folder_infos"),s=require("hgn!docs/templates/side"),o=require("hgn!docs/templates/docs_tree_menu"),u=require("docs/views/docs_tree_menu"),a=require("favorite"),f=require("i18n!nls/commons"),l=require("i18n!docs/nls/docs"),c=r.session("loginId")+"-docs-approval-toggle",h={collapse:f["\uc811\uae30"],expand:f["\ud3bc\uce58\uae30"],folder:l["\ubb38\uc11c\ud568"],addDocs:l["\ubb38\uc11c \ub4f1\ub85d"],latestRead:l["\ucd5c\uadfc \uc5f4\ub78c \ubb38\uc11c"],latestUpdate:l["\ucd5c\uadfc \uc5c5\ub370\uc774\ud2b8 \ubb38\uc11c"],approveWaiting:l["\uc2b9\uc778 \ub300\uae30 \ubb38\uc11c"],completeWaiting:l["\ub4f1\ub85d \ub300\uae30 \ubb38\uc11c"]};return t.View.extend({className:"go_side docs_side",events:{"click section.lnb span.docs.ic_side":"slideToggle","click section.lnb span.txt":"slideToggle","click #docsHome":"goDocsHome","click #addDocs":"addDocs","click a[data-navi]":"goDocsList","click a.node-value":"showList","click #toggleFolder":"toggleFolder"},initialize:function(){this.docFolderList=new i,this.appName=r.util.getAppName("docs")},render:function(){var t=this;e.when(t.getRegistwaiting(),t.getApprovewaiting()).done(e.proxy(function(){this.$el.html(s({appName:t.appName,isDocsOpen:t.getStoredCategoryIsOpen(c),lang:h,hasRegistwaiting:t.registwaitingCnt?t.registwaitingCnt>0:!1,hasApprovewaiting:t.approvewaitingCnt?t.approvewaitingCnt>0:!1,registwaitingCnt:t.registwaitingCnt,approvewaitingCnt:t.approvewaitingCnt})),this.renderFavorite(),this.docFoldersRender()},this))},selectSideMenu:function(e){var t=null,n=e.split("?")[0].split("/"),r=n[2];return r=="latestread"||r=="latestupdate"||r=="approvewaiting"||r=="registwaiting"?t=this.$el.find('ul.side_depth li a[data-navi="'+r+'"]'):t=this.$el.find('ul.side_depth li a[data-id="'+r+'"]'),_.isNull(t)?!1:(t.parents("p:eq(0)").addClass("on"),!0)},refreshWaitingCount:function(){var t=this;e.when(t.getRegistwaiting(),t.getApprovewaiting()).done(e.proxy(function(){this.registwaitingCnt>0?e("#registwaitingCnt").show().empty().append(this.registwaitingCnt):e("#registwaitingCnt").hide(),this.approvewaitingCnt>0?e("#approvewaitingCnt").show().empty().append(this.approvewaitingCnt):e("#approvewaitingCnt").hide(),t.selectSideMenu(r.router.getUrl())},this))},getRegistwaiting:function(){var t=this,i=n.defer();return e.ajax({type:"GET",dataType:"json",url:r.config("contextRoot")+"api/docs/registwaiting/count",success:function(e){i.resolve(),t.registwaitingCnt=e.data.count},error:function(){return i.reject(),0}})},getApprovewaiting:function(){var t=this,i=n.defer();return e.ajax({type:"GET",dataType:"json",url:r.config("contextRoot")+"api/docs/approvewaiting/count",success:function(e){i.resolve(),t.approvewaitingCnt=e.data.count},error:function(){return i.reject(),0}})},renderFavorite:function(){var t=this,n=a.create({el:"#side_favorite",url:r.config("contextRoot")+"api/docs/folder/favorite",type:"docs",liClass:"docs folder",link:function(e){return"docs/folder/"+e.get("id")},overrideDataSet:function(e){return{id:e.get("id"),name:e.get("name"),newMark:t.isNew(e.get("lastDocsCompleteDate"))}}});n.$el.on("refresh",function(){n.reload()}),n.$el.on("changeFavorite",function(t,n){var r=!1;e.each(n,function(t,n){if(n.get("id")==e("ins#favorite").attr("data-folder-id")){r=!0;return}}),r||e("ins#favorite").addClass("ic_star_off").attr("value",!1)})},isNew:function(e){return e?r.util.isCurrentDate(e,1):!1},docFoldersRender:function(){function u(n,i){var s,o=t.getStoredCategoryIsOpen(r.session("loginId")+n.id+n.getName()+"-docs-folder-toggle"),u=["company",r.session("companyId"),"docs"].join("."),a=t._renderMenuTree(n.id,i,u);return s=e(t.renderBoardTreeMenuNode({nodeId:n.id,nodeType:"FOLDER",nodeValue:n.getName(),isDeleted:n.attributes.state?n.attributes.state!="NORMAL":!0,isAccessible:this.isDeleted?!1:n.isReadable()?n.isReadable():!1,hasChild:i.length>0,close:o,isNew:t.isNew(n.get("lastDocsCompleteDate")),iconType:"folder",managable:!1,isWritable:n.isWritable()})),s.append(a.el),o||a.$el.hide(),s}var t=this,n=e("#docFolders"),s=n.find("ul:first"),o=[];n.show(),this.docFolderList.comparator="seq",this.docFolderList.fetch({success:function(e){var n=new i;e.each(function(e){n.get(e)?n.get(e).attributes=e.attributes:n.push(e),e.attributes.parent=_.sortBy(e.attributes.parent,"depth");var t=0;for(var r=0;r<e.getParent().length;r++)r>0&&(e.getParent()[r].parentId=t),n.push(n.getExistModel(e.getParent()[r])),t=e.getParent()[r].id}),_.each(n.getRootFolders(),function(e){var t=u(e,n.getEveryChildrenFolder(e.id));t&&o.push(t)}),s.append.apply(s,o),t.selectSideMenu(r.router.getUrl())}})},getStoredCategoryIsOpen:function(e){var t=r.util.store.get(e);return _.isUndefined(t)&&(t=!0),t},renderBoardTreeMenuNode:function(){return o.apply(undefined,arguments)},_renderMenuTree:function(e,t,n){var r=new u({nodes:t,menuId:n,parentId:e});return r.render(),r},slideToggle:function(t){var n=e(t.currentTarget),r=n.parents("h1:first"),i=r.find(".ic_side"),s=this;r.next("ul").slideToggle("fast",function(){e(this).css("display")=="block"?(r.removeClass("folded"),i.attr("title",h.collapse)):(r.addClass("folded"),i.attr("title",h.expand));var t=r.hasClass("docs"),n=!r.hasClass("folded");t&&s.storeCategoryIsOpen(c,n)})},toggleFolder:function(t){var n=e(t.currentTarget),i=n.parent().find("a").attr("data-id"),s=n.parent().find("a").attr("title"),o=n.hasClass("close");this.storeCategoryIsOpen(r.session("loginId")+i+s+"-docs-folder-toggle",!o),o?(n.removeClass("close").addClass("open"),n.parent().next("ul").hide()):(n.removeClass("open").addClass("close"),n.parent().next("ul").show())},storeCategoryIsOpen:function(e,t){r.util.store.set(e,t)},goDocsHome:function(){r.router.navigate("docs",!0)},addDocs:function(){var t=e("#docFolders ul.side_depth li.folder > p.on"),n;t.length>0&&t.attr("data-writable")&&(n=t.parent().attr("data-id"));var i="";n?i="docs/folder/"+n+"/create":i="docs/create";var s=function(){r.router.navigate(i,!0)};r.util.editorConfirm(s)},goDocsList:function(t){var n=e(t.currentTarget),i=n.attr("data-navi"),s="/docs/folder/"+i;this.$el.find(".on").removeClass("on"),n.parent().addClass("on"),r.router.navigate(s,{trigger:!0})},showList:function(t){var n=e(t.currentTarget).attr("data-id");if(!n||!this.docFolderList.isReadableFolder(n))return!1;this.$el.find(".on").removeClass("on"),e(t.currentTarget).parent().addClass("on");var i="docs/folder/"+n;r.router.navigate(i,!0)}})});