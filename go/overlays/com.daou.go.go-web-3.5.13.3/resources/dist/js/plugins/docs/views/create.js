define("docs/views/create",function(require){var e=require("underscore"),t=require("docs/views/base_docs"),n=require("hgn!docs/templates/create"),r=require("docs/views/content_top"),i=require("backbone"),s=require("i18n!docs/nls/docs"),o=require("i18n!approval/nls/approval"),u=require("i18n!nls/commons"),a=require("app"),f=require("file_upload"),l=require("docs/models/docs_doc_item"),c=require("docs/models/doc_folder_info"),h=require("docs/views/select_folder_popup");require("go-webeditor/jquery.go-webeditor");var p=i.Collection.extend({model:l,initialize:function(e){this.docsId=e.docsId},url:function(){return GO.contextRoot+"api/docs/"+this.docsId+"/versions"}}),d=i.Model.extend({initialize:function(e){this.option=e||{docYear:5}}},{PRESERVE_YEARS:[1,3,5,10,0]}),v={attach:u["\ud30c\uc77c\ucca8\ubd80"],docsYear:s["\ubcf4\uc874\uc5f0\ud55c"],docNum:s["\ubb38\uc11c\ubc88\ud638"],title:s["\uc81c\ubaa9"],location:s["\uc704\uce58"],reason:s["\ubcc0\uacbd \uc0ac\uc720"],regist:u["\ub4f1\ub85d"],tempsave:s["\uc784\uc2dc\uc800\uc7a5"],"\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694":u["\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694"],"\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694 \ub610\ub294":u["\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694 \ub610\ub294"],"\ud30c\uc77c\uc120\ud0dd":u["\ud30c\uc77c\uc120\ud0dd"],"\ucca8\ubd80\ud30c\uc77c 1\uac1c\uc758 \ucd5c\ub300 \uc6a9\ub7c9\uc740 NNN MB \uc774\uba70 \ucd5c\ub300 N\uac1c \uae4c\uc9c0 \ub4f1\ub85d \uac00\ub2a5\ud569\ub2c8\ub2e4":GO.i18n(u["\ucca8\ubd80\ud30c\uc77c 1\uac1c\uc758 \ucd5c\ub300 \uc6a9\ub7c9\uc740 {{size}} MB \uc774\uba70 \ucd5c\ub300 {{number}} \uac1c \uae4c\uc9c0 \ub4f1\ub85d \uac00\ub2a5\ud569\ub2c8\ub2e4"],{size:GO.config("commonAttachConfig").maxAttachSize,number:GO.config("commonAttachConfig").maxAttachNumber})};return t.extend({events:{"click span.ic_del":"attachDelete","click #submitDocs":"submitDocs","click #folderBtn":"selectFolder","click #tempSaveDocs":"tempSaveDocs","dragover #dropZone":"_dragOver","dragleave #dropZone":"_dragLeave","drop #dropZone":"_drop"},initialize:function(e){t.prototype.initialize.apply(this,arguments),this.isCreate=this.options.docsId?!1:!0,this.docsId=this.options.docsId,this.folderId=this.options.folderId,this.isSaaS=GO.session().brandName=="DO_SAAS",this.totalAttachSize=0,this.totalAttachCount=0},_dragOver:function(e){e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",$("#dropZone").addClass("drag_file")},_dragLeave:function(e){e.preventDefault(),e.stopPropagation(),$("#dropZone").removeClass("drag_file")},_drop:function(e){this._dragLeave(e)},dataFetchForEdit:function(){var e=$.Deferred(),t=$.Deferred(),n=$.Deferred(),r=this;this.docsId?(this.docsModel=new l({id:this.docsId}),this.docsModel.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}}}).done($.proxy(function(){t.resolve(),this.folderId=this.docsModel.getFolderId(),this.folderModel=new c({id:this.folderId}),this.folderModel.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}}}).done(function(){e.resolve()})},this))):(this.docsModel=new l,t.resolve(),e.resolve()),this.setEditFolderOption(n);var i=$.Deferred();return $.when(t,e,n).done(function(){i.resolve(r)}),i},dataFetchForCreate:function(){var e=$.Deferred(),t=this;this.folderId?(this.folderModel=new c({id:this.folderId}),this.folderModel.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}}}).done(function(){e.resolve()})):e.resolve();var n=$.Deferred();return $.when(e).done(function(){n.resolve(t)}),n},render:function(){if(this.docsModel&&this.docsModel.getDocsStatus()=="APPROVEWAITING"){var e="docs";$.goAlert("\uc2b9\uc778 \ub300\uae30 \uc911 \ubb38\uc11c\ub294 \uc218\uc815 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.","",function(){GO.router.navigate(e,!0)});return}t.prototype.render.apply(this,arguments),this.$el.parent().parent().find(".docs_side").find(".on").removeClass("on"),this.docsModel&&(this.isCreate=this.disableEditFolder?!1:!0);var r;return this.docsModel?r=this.makeDocInfo(this.docsModel.getDocsYear()):this.folderModel?r=this.makeDocInfo(this.folderModel.getDocYear()):r=this.makeDocInfo(),this.$el.html(n({lang:v,docsId:this.options.id,isCreate:this.isCreate,docsData:this.docsModel?this.docsModel.toJSON():null,isTempsave:this.docsModel?this.docsModel.get("docsStatus")=="TEMPSAVE":!1,folderData:this.folderModel?this.folderModel.toJSON():null,files:this.docsModel?this.docsModel.getFiles():null,images:this.docsModel?this.docsModel.getImages():null,disableEditFolder:this.disableEditFolder,preserveYears:r,isSaaS:this.isSaaS})),this.initSmartEditor(),this.initFileUpload(),this.docsFolderSelectListener(),this.setViewedTotalAttachSize(),this},renderContentTop:function(e){var t=this,n=new r({});e.getContentElement().html(n.el),n.render(),e.setContent(t),n.setTitle(this.isCreate?s["\ubb38\uc11c \ub4f1\ub85d"]:s["\ubb38\uc11c \uc5c5\ub370\uc774\ud2b8"])},makeDocInfo:function(t){typeof t!="number"&&(t=5),this.yearsModel=new d({docYear:t});var n=e.map(d.PRESERVE_YEARS,function(e){return{value:e,label:e==0?o["\uc601\uad6c"]:e+o["\ub144"],isSelected:this.yearsModel.get("docYear")*1==e*1?!0:!1}},this);return n},attachDelete:function(e){$(e.target).parents("li").remove(),this.setViewedTotalAttachSize()},editorCallback:function(){GO.Editor.getInstance("editor").setContent(this.docsModel.get("content")||"")},initSmartEditor:function(){$("#editor").goWebEditor({contextRoot:GO.config("contextRoot"),lang:GO.session("locale"),onLoad:e.bind(this.editorCallback,this)})},initFileUpload:function(e){var t=this,e={el:"#swfupload-control",context_root:GO.contextRoot,button_title:v["\ud30c\uc77c\uc120\ud0dd"],button_text:"<span class='txt'>"+v["\ud30c\uc77c\uc120\ud0dd"]+"</span>",url:"api/file?GOSSOcookie="+$.cookie("GOSSOcookie"),textTmpl:["<span class='btn_file''>","{text}","<input type='file' name='file' title='{title}' multiple='' accept={accept} />","</span>"].join(""),dropZone:"#dropZone",progressEl:"div.progress"},n=parseInt(GO.config("commonAttachConfig").maxAttachSize),r=n*1024*1024,i=parseInt(GO.config("commonAttachConfig").maxAttachNumber);(new f(e)).queue(function(e,t){}).start(function(e,s){if(!GO.config("attachFileUpload"))return $.goAlert(u["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),t.$("#dropZone").removeClass("drag_file"),!1;if(t.isSaaS){if(r<s.size)return $.goMessage(GO.i18n(u["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",n)),t.$("#dropZone").removeClass("drag_file"),!1;t.totalAttachSize+=s.size;var o=$("#fileWrap").children().size()+$("#imgWrap").children().size()+t.totalAttachCount+1;if(i<o)return $.goMessage(GO.i18n(u["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",i)),t.$("#dropZone").removeClass("drag_file"),!1;t.totalAttachCount++}}).progress(function(e,t){}).success(function(e,n,r){if(GO.util.fileUploadErrorCheck(n))r.find(".item_file").append("<strong class='caution'>"+GO.util.serverMessage(n)+"</strong>"),r.addClass("attachError");else if(GO.util.isFileSizeZero(n))return $.goAlert(GO.util.serverMessage(n)),!1;var i=n.data.hostId,s=n.data.fileSize,o=GO.util.getHumanizedFileSize(s),u=n.data.fileExt,f=n.data.fileName;r.attr("data-hostId",i),r.attr("data-size",s),a.util.isImage(u)?(r.find(".item_image").append("<span class='name'>"+f+"</span>"+"<span class='size'>("+o+")</span>"),t.$("#attachArea").find("ul.img_wrap").append(r)):t.$("#attachArea").find("ul.file_wrap").append(r),t.setViewedTotalAttachSize(),t.resetAttachSizeAndCount()}).complete(function(e,t){}).error(function(e,n){n.jqXHR&&(n.jqXHR.statusText=="abort"?$.goAlert(u["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):$.goAlert(u["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."]),t.resetAttachSizeAndCount())})},_getData:function(){return{folderId:this.folderId,title:$("#docsName").val(),reason:this.isCreate?s["\ucd5c\ucd08 \ub4f1\ub85d"]:$("#docsReason").val(),docNum:$("#docsNum").val()?$("#docsNum").val():"",docsYear:$("#docYear").val()*1,attaches:this._getFiles(),content:this.getContent()}},submitDocs:function(){if(!GO.Editor.getInstance("editor").validate())return $.goError(u["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=this._getData();if(this.validate(e)==0)return;e.docsStatus="COMPLETE",this.saveRequest(e)},tempSaveDocs:function(){if(!GO.Editor.getInstance("editor").validate())return $.goError(u["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=this._getData();if(this.validate(e)==0)return;e.docsStatus="TEMPSAVE",this.saveRequest(e)},saveRequest:function(e){this.docsModel==undefined&&(this.docsModel=new l),this.docsModel.set(e),this.docsId==undefined?this.docsModel.save({},{success:function(e){e.get("docsStatus")=="TEMPSAVE"?$.goAlert(s["\ubb38\uc11c\uc784\uc2dc\uc800\uc7a5\ud655\uc778"],"",function(){a.router.navigate("docs/edit/"+e.get("id"),!0)}):a.router.navigate("docs/detail/"+e.get("id"),!0)},error:function(e,t){$.goError(t.responseJSON.message)}}):(this.docsModel.id=this.docsId,this.docsModel.save({},{type:"PUT",success:function(e){e.get("docsStatus")=="TEMPSAVE"?$.goAlert(s["\ubb38\uc11c\uc784\uc2dc\uc800\uc7a5\ud655\uc778"],"",function(){a.router.navigate("docs/edit/"+e.get("id"),!0)}):a.router.navigate("docs/detail/"+e.get("id"),!0)},error:function(e,t){$.goError(t.responseJSON.message)}}))},getContent:function(){var e=GO.Editor.getInstance("editor").getContent();return e==""||$.trim(e)=="<br>"?"":e},validate:function(e){if(!e.folderId)return $.goError(s["\ubb38\uc11c\ud568\uc120\ud0dd\ud574\uc8fc\uc138\uc694"],$("#folderBtn"),!1,!0),$(document).scrollTop(0),!1;var t=$.trim(e.title);if(t.length>100||t.length<2){var n=a.i18n(s["0\uc740 0\uc790\uc774\uc0c1 0\uc790\uc774\ud558 \uc785\ub825\ud574\uc57c \ud569\ub2c8\ub2e4."],{arg0:s["\uc81c\ubaa9"],arg1:"2",arg2:"100"});return $.goError(n,$("#docsName"),!1,!0),$(document).scrollTop(0),!1}var r=$.trim(e.reason);if(r.length>64||r.length<2){var n=a.i18n(s["0\uc740 0\uc790\uc774\uc0c1 0\uc790\uc774\ud558 \uc785\ub825\ud574\uc57c \ud569\ub2c8\ub2e4."],{arg0:s["\ubcc0\uacbd \uc0ac\uc720"],arg1:"2",arg2:"64"});return $.goError(n,$("#docsReason"),!1,!0),$(document).scrollTop(0),!1}var i=$.trim(e.docNum);if(i&&(i.length>32||i.length<2)){var n=a.i18n(s["0\uc740 0\uc790\uc774\uc0c1 0\uc790\uc774\ud558 \uc785\ub825\ud574\uc57c \ud569\ub2c8\ub2e4."],{arg0:s["\ubb38\uc11c\ubc88\ud638"],arg1:"2",arg2:"32"});return $.goError(n,$("#docsNum"),!1,!0),$(document).scrollTop(0),!1}return!0},_getFiles:function(){var t=[];return e.each($("#attachArea").find("li:not(.attachError)"),function(e){t.push({id:$(e).attr("data-id")||null,path:$(e).attr("data-id")?"":$(e).attr("data-path"),name:$(e).attr("data-name"),hostId:$(e).attr("data-hostId"),size:$(e).attr("data-size")})}),t},selectFolder:function(){this.popup=$.goPopup({pclass:"layer_normal doc_layer",header:s["\uc704\uce58 \uc120\ud0dd"],width:300,top:"40%",contents:"<div class='list_wrap'></div>",buttons:[{btext:u["\ucde8\uc18c"],btype:"normal",callback:function(){}}]}),(new h).renderList().then($.proxy(function(){this.popup.reoffset()},this))},docsFolderSelectListener:function(){$("#docsPath").on("docsFolder:select",$.proxy(function(e,t){this.folderId=t.id,this.folderModel==undefined&&(this.folderModel=new c),this.folderModel.id=this.folderId,this.folderModel.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}}}).done($.proxy(function(){document.getElementById("docYear").options[this.folderModel.getDocYearIndex()].selected=!0,$("#docsPath").empty().append(t._getParentPathName()+" "),$("#docsNum").val(""),t.useDocNum()?$("#docsNumLayout").show():$("#docsNumLayout").hide(),this.popup.close()},this))},this))},setEditFolderOption:function(e){var t=this,n=new p({docsId:this.docsModel.id});n.comparator="completDate",n.fetch({statusCode:{400:function(){GO.util.error("404",{msgCode:"400-common"})},403:function(){GO.util.error("403",{msgCode:"400-common"})},404:function(){GO.util.error("404",{msgCode:"400-common"})},500:function(){GO.util.error("500")}},success:function(e){t.disableEditFolder=e.length>0}}).done(function(){e.resolve()})},getViewedTotalAttachSize:function(){var e=0;return $("#fileWrap, #imgWrap").find("li").each(function(){e+=parseInt(this.getAttribute("data-size"),0)}),e},setViewedTotalAttachSize:function(){if(this.isSaaS){var e=this.getViewedTotalAttachSize();this.$el.find("#total_size").html(GO.util.displayHumanizedAttachSizeStatus(e))}},resetAttachSizeAndCount:function(){this.isSaaS&&(this.totalAttachSize=0,this.totalAttachCount=0)}})});