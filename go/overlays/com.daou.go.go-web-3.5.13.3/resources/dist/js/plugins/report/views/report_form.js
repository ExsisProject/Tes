(function(){define(["jquery","underscore","backbone","hogan","app","i18n!nls/commons","i18n!report/nls/report","hgn!report/templates/report_form","hgn!report/templates/report_attaches_file","hgn!report/templates/report_attaches_image","report/models/report","report/models/report_folder","file_upload","report/views/report_title","jquery.go-popup","go-webeditor/jquery.go-webeditor","formutil"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d={temp_save_call:o["\uc784\uc2dc\uc800\uc7a5 \ubd88\ub7ec\uc624\uae30"],temp_report_msg:o["\uc791\uc131\uc911\uc778 \ubcf4\uace0\uc11c\uac00 \uc788\uc2b5\ub2c8\ub2e4. \ubd88\ub7ec\uc624\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],temp_report_success:o["\uc784\uc2dc\uc800\uc7a5 \ub418\uc5c8\uc2b5\ub2c8\ub2e4."],temp_report_error:o["\uc591\uc2dd\uc774 \ubcc0\uacbd\ub418\uc5b4 \uc784\uc2dc\uc800\uc7a5\uac12\uc744 \ubd88\ub7ec\uc62c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],tiny_empty_msg:o["\uc0dd\uc131\ub41c \ubcf4\uace0\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],save:o["\ub4f1\ub85d"],attach_file:s["\ud30c\uc77c\ucca8\ubd80"],remove:s["\uc0ad\uc81c"],title:o["\uc81c\ubaa9"],temp_save:s["\uc784\uc2dc\uc800\uc7a5"],"\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694":s["\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694"],"\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694 \ub610\ub294":s["\uc774 \uacf3\uc5d0 \ud30c\uc77c\uc744 \ub4dc\ub798\uadf8 \ud558\uc138\uc694 \ub610\ub294"],"\ud30c\uc77c\uc120\ud0dd":s["\ud30c\uc77c\uc120\ud0dd"],"\ucca8\ubd80\ud30c\uc77c 1\uac1c\uc758 \ucd5c\ub300 \uc6a9\ub7c9\uc740 NNN MB \uc774\uba70 \ucd5c\ub300 N\uac1c \uae4c\uc9c0 \ub4f1\ub85d \uac00\ub2a5\ud569\ub2c8\ub2e4":i.i18n(s["\ucca8\ubd80\ud30c\uc77c 1\uac1c\uc758 \ucd5c\ub300 \uc6a9\ub7c9\uc740 {{size}} MB \uc774\uba70 \ucd5c\ub300 {{number}} \uac1c \uae4c\uc9c0 \ub4f1\ub85d \uac00\ub2a5\ud569\ub2c8\ub2e4"],{size:i.config("commonAttachConfig").maxAttachSize,number:i.config("commonAttachConfig").maxAttachNumber})};return n.View.extend({el:"#content",events:{"click #actions a.save":"save","click #actions a.tempSave":"tempSave","click span.ic_del":"deleteFile","dragover #dropZone":"_dragOver","dragleave #dropZone":"_dragLeave","drop #dropZone":"_drop"},initialize:function(e){this.options=e||{},this.$el.off(),this.folder=c.get(this.options.folderId),this.isCreate=this.options.reportId?!1:!0,this.report=this.isCreate?new l:l.get(this.options.reportId),this.$el.addClass("go_renew"),this.isSaaS=i.session().brandName=="DO_SAAS",this.totalAttachSize=0,this.totalAttachCount=0},render:function(){var t=this,n="",r=this.report.toJSON();this.$el.html(u({data:r,lang:d,isCreate:this.isCreate,isSaaS:this.isSaaS})),e("#reportCreateForm").on("edit:complete",function(){e("#reportCreateForm").off("edit:complete"),t.checkTempSave()}),this.folder.get("formFlag")?n=this.isCreate?this.folder.get("form").content:this.report.get("content"):this.isCreate||(n=i.util.convertMSWordTag(this.report.get("content")),this.report.get("contentType")=="TEXT"&&(n=i.util.convertRichText(n))),this._setContent(n),this._setAttaches(r.attaches),this.setViewedTotalAttachSize(),this.initFileUpload(),p.create({text:this.folder.get("name"),meta_data:this.folder.get("department").name}),e("#side").trigger("set:leftMenu",this.folder.get("id"))},_dragOver:function(t){t.preventDefault(),t.stopPropagation(),t.originalEvent.dataTransfer.dropEffect="move",e("#dropZone").addClass("drag_file")},_dragLeave:function(t){t.preventDefault(),t.stopPropagation(),e("#dropZone").removeClass("drag_file")},_drop:function(e){this._dragLeave(e)},_setContent:function(t){var n=t||"",r=this;if(this.folder.get("formFlag")){e("#reportCreateForm").html("");var s=this.folder.get("department").name;e.go(i.contextRoot+"api/user/representative/dept","",{qryType:"GET",async:!0,contentType:"application/json",responseFn:function(t){var r=t.data;r&&(s=r.name);var o={data:n,contextRoot:i.contextRoot,userId:i.session().id,userProfileApi:"api/user/profile",deptName:s};e("#reportCreateForm").setTemplate(o)},error:function(){var t={data:n,contextRoot:i.contextRoot,userId:i.session().id,userProfileApi:"api/user/profile",deptName:s};e("#reportCreateForm").setTemplate(t)}})}else setTimeout(function(){r._initSmartEditor("editor",n)},1e3)},_setAttaches:function(t){var n=[],r=[];t&&e.each(t,function(){this.icon=i.util.getFileIconStyle({extention:this.extention}),this.humanSize=i.util.getHumanizedFileSize(this.size),i.util.isImage(this.extention)?r.push(this):n.push(this)}),r.length>0&&this.$el.find("#imgWrap").html(f({images:r})),n.length>0&&this.$el.find("#fileWrap").html(a({files:n}))},deleteFile:function(t){e(t.currentTarget).parents("li").remove(),this.setViewedTotalAttachSize()},checkTempSave:function(){var t=i.contextRoot+"api/report/folder/"+this.folder.get("id")+"/form",n=this;e.go(t,"",{qryType:"GET",async:!0,contentType:"application/json",responseFn:function(t){if(t.data.tempExist){if(t.data.status=="INVALID"){e.goAlert(o["\uc591\uc2dd\uc774 \ubcc0\uacbd\ub418\uc5b4 \uc784\uc2dc\uc800\uc7a5\uac12\uc744 \ubd88\ub7ec\uc62c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}e.goConfirm(d.temp_save_call,d.temp_report_msg,function(){e("#reportName").val(t.data.name),n._setContent(t.data.content),n._setAttaches(t.data.attaches),n.setViewedTotalAttachSize()})}},error:function(e){}})},tempSave:function(){if(!this.folder.get("formFlag")&&!i.Editor.getInstance("editor").validate())return this.showMimeError(),!1;if(this.folder.get("formFlag")&&!this.formValidate())return this.showMimeError(),!1;this.report.set(this.getData()),this.report.set({status:"TEMP",contentType:"HTML"});if(!this.validate())return!1;var t=this;this.report.save(null,{success:function(){e.goMessage(d.temp_report_success),t.render()}})},renderGrid:function(){this.dataTable=e.goGrid({el:"#report_list",method:"GET",url:i.contextRoot+"api/report/department/"+this.options.deptId+"/inactive",emptyMessage:"<p class='data_null'> <span class='ic_data_type ic_no_data'></span><span class='txt'>"+d.tiny_empty_msg+"</span>"+"</p>",defaultSorting:[[1,"asc"]],sDomUse:!0,checkbox:!0,checkboxData:"id",columns:[{mData:"createdAt",bSortable:!1,sClass:"date",sWidth:"180px",fnRender:function(e){var t=e.aData;return i.util.basicDate(t.createdAt)}},{mData:"name",bSortable:!1,sClass:"subject",sWidth:"1170px"},{mData:null,bSortable:!1,sClass:"reporter",sWidth:"180px",fnRender:function(e){var t=e.aData;return t.reporter.name+" "+t.reporter.position}}],fnDrawCallback:function(){self.$el.find("tr>td:nth-child(2) span").css("cursor","pointer").click(function(t){var n=e(t.currentTarget),r="report/folder/series/"+n.attr("data-id");i.router.navigate(r,{trigger:!0})})}})},save:function(){if(!this.folder.get("formFlag")&&!i.Editor.getInstance("editor").validate())return this.showMimeError(),!1;if(this.folder.get("formFlag")&&!this.formValidate())return this.showMimeError(),!1;var e=this;this.report.set(this.getData()),this.report.set({status:"DONE",contentType:"HTML"});if(!this.validate())return!1;this.report.save(null,{success:function(){var t="report/folder/"+e.folder.get("id")+"/report/"+e.report.get("id");i.router.navigate(t,{trigger:!0})}})},formValidate:function(){var n=!0;return t.each(e('span[data-dsl*="editor"]'),function(t){var r=e(t).attr("id");n=i.Editor.getInstance(r).validate()},this),n},getData:function(){return{name:this.$el.find("#reportName").val(),content:this.getContent(),attaches:this.getAttaches(),folder:{id:this.folder.id}}},showMimeError:function(){e.goError(s["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"])},getContent:function(){return this.folder.get("formFlag")?e("#reportCreateForm").getFormData():i.Editor.getInstance("editor").getContent()},validate:function(){return this.report.get("name").length==0?(e.goMessage(s["\ud544\uc218\ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."]),e("#reportName").focus(),!1):e.goValidation.isCheckLength(2,100,this.report.get("name"))?!0:(e.goMessage(i.i18n(s["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:2,arg2:100})),e("#reportName").focus(),!1)},getAttaches:function(){var t=[];return e.each(this.$el.find("#fileComplete li:not(.attachError)"),function(n,r){var i=e(r);t.push({id:i.attr("data-id"),name:i.attr("data-name"),path:i.attr("data-path"),hostId:i.attr("host-id"),size:i.attr("data-size")})}),t},initFileUpload:function(){var t=this,n={el:"#swfupload-control",context_root:i.contextRoot,button_title:d["\ud30c\uc77c\uc120\ud0dd"],button_text:"<span class='txt'>"+d["\ud30c\uc77c\uc120\ud0dd"]+"</span>",url:"api/file?GOSSOcookie="+e.cookie("GOSSOcookie"),textTmpl:["<span class='btn_file''>","{text}","<input type='file' name='file' title='{title}' multiple='' accept={accept} />","</span>"].join(""),dropZone:"#dropZone",progressEl:"div.progress"},r=parseInt(i.config("commonAttachConfig").maxAttachSize),o=r*1024*1024,u=parseInt(i.config("commonAttachConfig").maxAttachNumber);(new h(n)).queue(function(e,t){}).start(function(n,a){if(!i.config("attachFileUpload"))return e.goAlert(s["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),t.$("#dropZone").removeClass("drag_file"),!1;if(t.isSaaS){if(o<a.size)return e.goMessage(i.i18n(s["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",r)),t.$("#dropZone").removeClass("drag_file"),!1;t.totalAttachSize+=a.size;var f=e("#fileWrap").children().size()+e("#imgWrap").children().size()+t.totalAttachCount+1;if(u<f)return e.goMessage(i.i18n(s["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",u)),t.$("#dropZone").removeClass("drag_file"),!1;t.totalAttachCount++}}).progress(function(e,t){}).success(function(n,r,s){if(i.util.fileUploadErrorCheck(r))s.find(".item_file").append("<strong class='caution'>"+i.util.serverMessage(r)+"</strong>"),s.addClass("attachError");else if(i.util.isFileSizeZero(r))return e.goAlert(i.util.serverMessage(r)),!1;var o=r.data.fileSize,u=i.util.getHumanizedFileSize(o),a=r.data.fileExt,f=r.data.fileName;s.attr("data-size",r.data.fileSize),i.util.isImage(a)?(s.find(".item_image").append("<span class='name'>"+f+"</span>"+"<span class='size'>("+u+")</span>"),t.$("#imgWrap").append(s)):t.$("#fileWrap").append(s),t.setViewedTotalAttachSize(),t.resetAttachSizeAndCount()}).complete(function(e,t){}).error(function(n,r){r.jqXHR&&(r.jqXHR.statusText=="abort"?e.goAlert(s["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]):e.goAlert(s["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."]),t.resetAttachSizeAndCount())})},release:function(){this.childView.release(),this.$el.off(),this.$el.empty(),this.remove()},_initSmartEditor:function(t,n){function s(){i.Editor.getInstance(t).setContent(n||""),e("#"+t).trigger("edit:complete")}var r=i.session("locale");i.Editor.getInstance(t)&&i.Editor.getInstance(t).$el.parents("body").length>0&&s(),e("#"+t).goWebEditor({contextRoot:i.config("contextRoot"),lang:r,onLoad:s})},getViewedTotalAttachSize:function(){var t=0;return e("#fileWrap, #imgWrap").find("li").each(function(){t+=parseInt(this.getAttribute("data-size"),0)}),t},setViewedTotalAttachSize:function(){if(this.isSaaS){var e=this.getViewedTotalAttachSize();this.$el.find("#total_size").html(i.util.displayHumanizedAttachSizeStatus(e))}},resetAttachSizeAndCount:function(){this.isSaaS&&(this.totalAttachSize=0,this.totalAttachCount=0)}},{__instance__:null,create:function(){return this.__instance__===null&&(this.__instance__=new this.prototype.constructor),this.__instance__}})})})();