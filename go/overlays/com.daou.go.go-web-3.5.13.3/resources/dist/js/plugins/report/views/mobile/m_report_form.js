(function(){define(["jquery","backbone","app","i18n!report/nls/report","i18n!nls/commons","views/mobile/header_toolbar","report/models/report_folder","report/models/report","hgn!report/templates/mobile/m_report_form","attach_file","components/go-fileuploader/mobile","formutil","GO.util","GO.m.util"],function(e,t,n,r,i,s,o,u,a,f,l){var c=t.View.extend({el:"#content",events:{},initialize:function(e){this.options=e||{},this.isCreateMode=this.options.reportId?!1:!0,this.model=this.isCreateMode?new u:u.get(this.options.reportId),this.folderModel=this.isCreateMode?o.get(this.options.folderId):(new o).set(this.model.get("folder")),this.useForm=this.folderModel.get("formFlag"),this.editorTml='<span class="comp_wrap" data-dsl="{{editor}}"></span>',this.$el.off(),this.headerBindEvent()},headerBindEvent:function(){n.EventEmitter.off("trigger-action"),n.EventEmitter.on("trigger-action","report-save",this.saveReport,this)},render:function(){this.renderHeaderToolbar(),this.$el.html(a({isPeriodic:this.folderModel.isPeriodic(),titleDesc:r["\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694."],title:this.folderModel.get("name")}));var e=this,t="",n="",i=[];return this.isCreateMode?this.getTempsavedData().done(function(s){e.savedData=s.data,e.savedData.tempExist&&confirm(r["\uc791\uc131\uc911\uc778 \ubcf4\uace0\uc11c\uac00 \uc788\uc2b5\ub2c8\ub2e4. \ubd88\ub7ec\uc624\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])?e.savedData.status=="INVALID"?(alert(r["\uc591\uc2dd\uc774 \ubcc0\uacbd\ub418\uc5b4 \uc784\uc2dc\uc800\uc7a5\uac12\uc744 \ubd88\ub7ec\uc62c \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]),t=e.getCleanContent()):(t=e.getSavedContent(e.savedData.content),n=e.savedData.name,i=e.savedData.attaches):t=e.getCleanContent()}).fail(function(e){alert(e.responseJSON.message)}):(t=this.getSavedContent(this.model.get("content")),n=this.model.get("name"),i=this.model.get("attaches")),this.renderContentAndName(t,n),this.useSavedContent&&f.edit("#attach_placeholder",i),this.$el.addClass("write"),this.attachFileUploader(),this},renderHeaderToolbar:function(){var t={isClose:!0,actionMenu:[{id:"report-save",text:i["\ub4f1\ub85d"],triggerFunc:"report-save"}]};this.isCreateMode&&(t.closeCallback=e.proxy(this.tempsaveReport,this)),s.render(t)},getTempsavedData:function(){var t=n.contextRoot+"api/report/folder/"+this.folderModel.get("id")+"/form";return e.ajax(t,{type:"GET",async:!1,contentType:"application/json"})},getSavedContent:function(t){return this.useSavedContent=!0,this.useForm?t:e(this.editorTml).append(t).prop("outerHTML")},getCleanContent:function(){return this.useSavedContent=!1,this.useForm?this.folderModel.get("form").content:this.editorTml},renderContentAndName:function(e,t){this.formOpts={data:e,contextRoot:n.contextRoot,userId:n.session().id,userProfileApi:"api/user/profile",deptName:this.folderModel.get("department").name},this.$el.find("#reportContent").setTemplate(this.formOpts),this.$el.find("#name").val(t)},attachFileUploader:function(){var t=this,r={};r.success=function(r){var i=typeof r=="string"?JSON.parse(r):r.data;e("#attach_wrap").show(),i.mode="edit";var s=f.makeTempItem(i);s.done(function(r){if(e("div.option_display").data("attachable")==="false")return;try{t.attachValidate(i)}catch(s){s.message==="overMaxAttachNumber"&&e("div.option_display").data("attachable","false");return}n.util.isImage(i.fileExt)?e("ul.img_wrap").show().append(r.$el):e("ul.file_wrap").show().append(r.$el),r.$el.on("removedFile",function(t,n){var r=n.el;r.preventDefault(),e(r.currentTarget).parents("li").first().remove(),e("div.option_display").data("attachable","true"),e("#attach_wrap").find("li").size()<1&&e("#attach_wrap").hide()})})},r.error=function(e){alert(i["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},l.bind(this.$el.find("#go-fileuploader"),r)},attachValidate:function(t){var r=null,s=n.util.getFileNameAndTypeData(t);n.config("allowedFileUploadSize")&&(r=n.config("allowedFileUploadSize")/1024/1024);try{e.goValidation.attachValidate("#attach_wrap ul li",s,r),n.session().brandName=="DO_SAAS"&&l.attachFileValidateBySaaS(s.size)}catch(o){var u=o.message;if(u=="AttachSizeException")n.util.delayAlert(n.i18n(i["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",r));else{if(u=="AttachNumberExceptionBySaaS")throw n.util.delayAlert(n.i18n(i["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",n.config("commonAttachConfig").maxAttachNumber)),new Error("overMaxAttachNumber");u=="NotFoundExtException"&&n.util.delayAlert(i["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},tempsaveReport:function(){function e(){n.util.isAndroidApp()?window.GOMobile.pressBackKey():window.history.back()}confirm(i["\uc784\uc2dc\uc800\uc7a5\uc744 \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c? \ucde8\uc18c\ub97c \ub204\ub974\uba74 \uc791\uc131 \uc911\uc778 \ub0b4\uc6a9\uc740 \uc0ac\ub77c\uc9d1\ub2c8\ub2e4."])?(this.setData("TEMP"),this.model.save(null,{success:function(){n.util.toastMessage(r["\uc784\uc2dc\uc800\uc7a5 \ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),e()},error:function(e,t){n.util.toastMessage(i["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."])}})):e()},saveReport:function(){var e=this;this.setData(),this.model.save(null,{success:function(t){var r="report/folder/"+e.folderModel.get("id")+"/report/"+e.model.get("id");n.router.navigate(r,{trigger:!0,replace:!0})}})},setData:function(e){this.model.set({status:e?e:"DONE",folder:{id:this.folderModel.get("id")},name:this.$el.find("#name").val(),content:this.$el.find("#reportContent").getFormData(),attaches:l.getAttachInfo("#attach_wrap"),contentType:"HTML"})}},{__instance__:null,create:function(e){return this.__instance__=new this.prototype.constructor({packageName:e}),this.__instance__}});return c})}).call(this);