(function(){define(["app","i18n!nls/commons","i18n!report/nls/report","i18n!calendar/nls/calendar","hgn!report/templates/folder_create","report/views/report_title","report/collections/report_recent_list","report/models/report_folder","views/circle","go-nametags","views/form_editor","views/form_list","collections/joined_depts","components/form_component_manager/report_form_manager","jquery.go-sdk","jquery.go-orgslide","jquery.go-validation","jquery.go-popup","jquery.go-preloader"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){function y(e){var t={};return $.each(e.split(";"),function(){var e="";value="",$.each(this.split("="),function(t,n){t==0?e=n:value=n}),t[e]=value}),t}function b(t){var n=t instanceof Array?t[0]:t;n.folder.save(null,{success:function(){var t=m.create_success;n.isCreate||(t=m.update_success),$.goMessage(t),setTimeout(function(){e.router.navigate("report/folder/"+n.folder.get("id")+"/reports",{trigger:!0})},100),S(!1)}})}function w(e,t){if(e.get("recurrence")!=t.get("recurrence"))return!0;if(e.get("formFlag")!=t.get("formFlag"))return!0;if(e.get("form").content!=t.get("form").content)return!0}function S(e){E=e}function x(){return E}var d=["SU","MO","TU","WE","TH","FR","SA"],v=[r["\uc77c\uc694\uc77c"],r["\uc6d4\uc694\uc77c"],r["\ud654\uc694\uc77c"],r["\uc218\uc694\uc77c"],r["\ubaa9\uc694\uc77c"],r["\uae08\uc694\uc77c"],r["\ud1a0\uc694\uc77c"]],m={addFolder:n["\ubcf4\uace0\uc11c \ucd94\uac00"],department:n["\uc704\uce58"],folderName:n["\uc81c\ubaa9"],desc:n["\uc124\uba85"],privateSetting:n["\ube44\uacf5\uac1c \uc124\uc815"],"private":n["\ube44\uacf5\uac1c"],share:n["\ubcf4\uace0\uc790 \uac04 \uacf5\uac1c"],shareDesc:n["\ubcf4\uace0\uc790 \uac04 \uacf5\uac1c \uc124\uba85"],alone:n["\ubcf4\uace0\uc790 \uac04 \ube44\uacf5\uac1c"],aloneDesc:n["\ubcf4\uace0\uc790 \uac04 \ube44\uacf5\uac1c \uc124\uba85"],reporter:n["\ubcf4\uace0\uc790"],all:n["\ubd80\uc11c\uc6d0 \uc804\uccb4"],rowRank:n["\ud558\uc704 \ubd80\uc11c\uc6d0 \ud3ec\ud568"],directly:n["\uc9c1\uc811 \uc9c0\uc815"],addReporter:n["\ubcf4\uace0\uc790 \ucd94\uac00"],referer:n["\ucc38\uc870\uc790"],addReferer:n["\ucc38\uc870\uc790 \ucd94\uac00"],admin:n["\uc6b4\uc601\uc790"],addAdmin:n["\uc6b4\uc601\uc790 \ucd94\uac00"],type:n["\uc720\ud615"],series:n["\uc815\uae30 \ubcf4\uace0\uc11c"],anytime:n["\uc218\uc2dc \ubcf4\uace0\uc11c"],everyDay:n["\ub9e4\uc77c"],everyWeek:n["\ub9e4\uc8fc"],everyMonth:n["\ub9e4\uc6d4"],daily:r["\uc77c\ub9c8\ub2e4"],weekly:r["\uc8fc\ub9c8\ub2e4"],monthly:r["\uc6d4\ub9c8\ub2e4"],last:n["\ub9c8\uc9c0\ub9c9"],date:n["\uc77c"],th:n["\ubc88\uc9f8"],day:n["\uc694\uc77c"],repeat:n["\ubc18\ubcf5"],reportForm:n["\ubcf4\uace0\uc591\uc2dd"],notUse:n["\uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc74c"],use:n["\uc0ac\uc6a9\ud568"],preview:n["\ubbf8\ub9ac\ubcf4\uae30"],editForm:n["\uc591\uc2dd\ud3b8\uc9d1"],ok:n["\ud655\uc778"],cancel:n["\ucde8\uc18c"],"delete":t["\uc0ad\uc81c"],save:t["\uc800\uc7a5"],otherForm:t["\ub2e4\ub978 \uc591\uc2dd \ubd88\ub7ec\uc624\uae30"],formEditorTitle:t["\uc591\uc2dd \ud3b8\uc9d1\uae30"],reportCreate:n["\ubcf4\uace0\uc11c \ucd94\uac00"],reportEdit:n["\ubcf4\uace0\uc11c \uc218\uc815"],require_admin:n["\uc6b4\uc601\uc790\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],require_reporter:n["\ubcf4\uace0\uc790\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],require_recurrence:n["\uc694\uc77c\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],folder_change_title:t["\ubcc0\uacbd\uc0ac\ud56d \ud655\uc778"],folder_change_content:n["\ud3f4\ub354 \uc218\uc815 \ubcc0\uacbd\uc0ac\ud56d \uc54c\ub9bc"],remove_msg:n["\ubcf4\uace0\uc11c \ubc0f \uc120\ud0dd\ud55c \ubcf4\uace0\uc11c \ub0b4 \ubaa8\ub4e0 \ub370\uc774\ud130\uac00 \uc0ad\uc81c \ub429\ub2c8\ub2e4. \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],create_success:t["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],update_success:t["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],delete_success:t["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],reporters:n["\ubcf4\uace0\uc790"],referrers:n["\ucc38\uc870\uc790"],admins:n["\uc6b4\uc601\uc790"],recurrence_desc:n["\uc815\uae30\ubcf4\uace0\uc548\ub0b4"],periodicToolTip:n["\uc815\uae30 \ubcf4\uace0\uc11c \ud234\ud301"]},g=Backbone.View.extend({events:{"change select[data-tag=repeatSelect]":"changeRepeatDate","change input[data-tag=repeatSelect]":"changeRepeatDate","change input[name=folderType]":"folderTypeOptionViewToggle","change input[name=reporter]":"reporterOptionViewToggle","click input#privateFlag":"privateOptionViewToggle","click ul#repeatTab li":"renderRepeatView","click a#submit":"submit","click a#cancel":"cancel","click a#delete":"remove","click #editForm":"editForm","click #formOption input:radio":"formUseToggle","click tr[data-repeat='MONTHLY'] span.monthRecurrenceOption":"monthRadioToggle","click #showFormPreview":"showFormPreview"},initialize:function(e){this.options=e||{};var t=this;this.$el.off(),this.isCreate=this.options.id?!1:!0,this.folder=this.isCreate?u.init():u.get(this.options.id),this.joinedFolder=h.fetch(),this.isCreate||(this.oldModel=this.folder.clone()),$("#content").on("insert:deptForm",function(e,n){t.popupEditForm(n)})},showFormPreview:function(){l.preview(this.folder.get("form").content,$.trim($("#deptId option:checked").text()))},formUseToggle:function(e){var t=$(e.target).val();t=="true"?$("#formUseOption").show():$("#formUseOption").hide()},editForm:function(){this.popupEditForm()},monthRadioToggle:function(e){var t=$(e.target),n=t.parents("span.monthRecurrenceOption");n.find("input:radio").attr("checked",!0),this.renderRepeatLabel(this.getRepeatType(e))},popupEditForm:function(e){var t=$("body"),n=t.find(".go_wrap, #organogram, .go_footer"),r=new p({lang:GO.config("locale")||"ko",title:!1,editorId:"formEditor",content:e||this.folder.get("form").content,saveCallback:_.bind(function(e,t){var n=this.folder.get("form");this.folder.set({form:$.extend({},n,{content:t})})},this),toggleEl:n});n.hide(),t.append(r.render().el)},render:function(){var e={lang:m,departmentList:this.getDepartmentList(),baseTerm:this.getTermData(1,30),dateTerm:this.getTermData(1,31),weekTerm:this.getTermData(1,5),dayTerm:this.getDay(),data:$.extend(this.folder.toJSON(),{isOpen:this.folder.isOpen(),isReporterOpen:!0,isPrivate:this.folder.isPrivate(),isMemberWrite:this.folder.isMemberWrite(),isDescendantWrite:this.folder.isDescendantWrite(),isSpecifiedWrite:this.folder.isSpecifiedWrite(),isPeriodic:this.folder.isPeriodic(),isOccasional:this.folder.isOccasional()})};return this.$el.html(i(e)),$("#content").addClass("go_renew"),this.renderNameTagView(),this.circleView=new a({selector:"#referrers",isAdmin:!1,isWriter:!0,circleJSON:this.folder.get("referrer"),nodeTypes:["user","department"]}),this.circleView.render(),this.renderRecurrence(),this.isCreate?(s.create({text:m.reportCreate}),$("#delete").hide()):(s.create({text:m.reportEdit,meta_data:this.folder.get("department").name}),$("#deptId").attr("disabled",!0),$("#delete").show()),this.options.id&&$("#side").trigger("set:leftMenu",this.options.id),this},cancel:function(){var n=this;if(this.isCreate)$.goConfirm(t["\ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],t["\uc785\ub825\ud558\uc2e0 \uc815\ubcf4\uac00 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4."],function(){n.render()});else{var r="report/folder/"+this.folder.get("id")+"/reports";e.router.navigate(r,{trigger:!0})}},submit:function(){if(x())return;this.setData();if(!this.validation())return!1;S(!0),!this.isCreate&&this.folder.isPeriodic()&&w.call(this,this.folder,this.oldModel)?$.goConfirm(m.folder_change_title,m.folder_change_content,$.proxy(b,this,this),function(){S(!1)}):b(this)},remove:function(){var n=this,r=[];if(x())return;r.push(this.folder.get("id"));var i=$("#deptId option:checked").val();$.goConfirm("",m.remove_msg,function(){var s=GO.contextRoot+"api/report/folder",o={id:i,ids:r};n.preloader=$.goPreloader(),n.preloader.render(),S(!0),$.go(s,JSON.stringify(o),{async:!0,qryType:"DELETE",data:JSON.stringify(o),contentType:"application/json",responseFn:function(t){n.preloader.release(),t.code==="200"&&($.goMessage(m.delete_success),e.router.navigate("report/folder",{trigger:!0})),S(!1)},error:function(e){n.preloader.release(),$.goAlert(t["\uc0ad\uc81c\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."]),S(!1)}})})},setData:function(){this.folder.set({department:{id:$("select#deptId").val()},name:$.trim($("input#folderName").val()),description:$.trim($("textarea#description").val()),publicOption:this._getPublicOption(),admin:this._getAdminIds(),reporter:this._getReporterIds(),type:$("#folderTypeOption input:radio[name='folderType']:checked").val(),formFlag:$("#formOption input:radio:checked").val()==="true"}),this.folder.set("referrer",this.circleView.getData())},_getAdminIds:function(){var e=[];return $.each($("#admins li[data-id]"),function(t,n){e.push({nodeId:parseInt($(this).attr("data-id")),nodeType:"user"})}),this.isCreate?{nodes:e}:{id:this.folder.get("admin").id,nodes:e}},_getReporterIds:function(){var e=[],t=$("#reporterOption input:radio:checked").val();if(t=="SPECIFIED")$.each($("#reporters li[data-id]"),function(t,n){e.push({nodeId:parseInt($(this).attr("data-id")),nodeType:"user"})});else{var n=$("#deptId option:checked").val(),r=$("#descendantUse"),i=r.is(":checked");t=="MEMBER"&&i?e.push({nodeId:n,nodeType:"subdepartment"}):e.push({nodeId:n,nodeType:"department"})}return this.isCreate?{nodes:e}:{id:this.folder.get("reporter").id,nodes:e}},_getPublicOption:function(){var e=$("#privateFlag"),t=e.is(":checked");return t?$("#privateOptionView input:radio:checked").val():e.val()},_getReporterOption:function(){var e=$("#descendantUse"),t=e.is(":checked");return t?e.val():$("#reporterOption input:radio:checked").val()},renderRecurrence:function(){var e=this,t=new Date,n="";this.isCreate&&$("tr[data-repeat=WEEKLY]").find("input:checkbox[value="+t.getDay()+"]").attr("checked",!0);var r=$("tr[data-repeat=MONTHLY]");r.find("select#date").val(t.getDate()),r.find("select#week").val(this.getWeekOfMonth(t)),r.find("select#day").val(t.getDay()),this.isCreate||(n=y(this.folder.get("recurrence")),$.each($("#recurrence_table tr").not(".recurrence_label"),function(){var t=$(this),r=t.attr("data-repeat");r==n.FREQ?(t.show(),e["set"+r+"Render"].call(e,n)):t.hide()}));var i=this.isCreate?"WEEKLY":n.FREQ;this.renderRepeatLabel(i)},setDAILYRender:function(e){var t=e.INTERVAL;$("tr[data-repeat=DAILY]").find("select [value='"+t+"']").attr("selected",!0)},setWEEKLYRender:function(e){var t=e.BYDAY.split(","),n=e.INTERVAL;$("tr[data-repeat=WEEKLY]").find("select [value='"+n+"']").attr("selected",!0),$.each(t,function(e,t){var e=d.indexOf(t);$("tr[data-repeat=WEEKLY]").find("input:checkbox[value="+e+"]").attr("checked",!0)})},setMONTHLYRender:function(e){var t=e.BYDAY,n=e.BYSETPOS,r=e.INTERVAL,i=e.BYMONTHDAY;$("tr[data-repeat=MONTHLY]").find("#month [value='"+r+"']").attr("selected",!0);if(i)$("tr[data-repeat=MONTHLY]").find("input:radio[value=byMonthDay]").attr("checked",!0),$("tr[data-repeat=MONTHLY]").find("#date option[value='"+i+"']").attr("selected",!0);else{$("tr[data-repeat=MONTHLY]").find("input:radio[value=bySetPos]").attr("checked",!0),$("tr[data-repeat=MONTHLY]").find("#week option[value='"+n+"']").attr("selected",!0);var s=d.indexOf(t);$("tr[data-repeat=MONTHLY]").find("#day option[value="+s+"]").attr("selected",!0)}},setWEEKLY:function(){recurrence=y(this.folder.get("recurrence"))},getWeekOfMonth:function(e){var t=new Date(e.getFullYear()+"/"+(e.getMonth()+1)+"/01");return Math.ceil((e.getDate()+t.getDay())/7)},getDepartmentList:function(){if(this.folder.isNew()){var t=[],r=this.isCreate?"":this.folder.get("department").id,i=this.joinedFolder.toJSON();if(!i.length)e.router.navigate("report",{trigger:!0,replace:!0}),$.goAlert("",n["\ubd80\uc11c\uac00 \uc124\uc815\ub418\uc9c0 \uc54a\uc544 \ubcf4\uace0\uc11c\ub97c \ucd94\uac00 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]);else{var s=_.sortBy(i,"id");t=$(s).map(function(e,t){return['<option value="',t.id,'"',t.id==r?'selected="selected"':"",">",t.name,"</option>"].join("")}).get()}return t.join("")}var o=this.folder.get("department");return['<option value="',o.id,'" selected="selected">',o.name,"</option>"].join("")},privateOptionViewToggle:function(){$("#privateOptionView").toggle()},reporterOptionViewToggle:function(e){$(e.target).val()=="SPECIFIED"?($("#descendantUse").attr("disabled",!0).attr("checked",!1),$("#reporterOptionView").show()):($("#descendantUse").attr("disabled",!1),$("#reporterOptionView").hide())},renderNameTagView:function(){var e=this;this.$el.find("div.wrap_name_tag").each(function(n,r){var i="";r.id=="reporters"&&!e.folder.isSpecifiedWrite()?i=f.create([],{useAddButton:!0}):i=f.create(e.folder[r.id+"NameTag"].call(e.folder),{useAddButton:!0}),$(this).empty().append(i.el).data("instance",i).data("type",$(this).attr("id")),i.$el.on("nametag:clicked-add",function(e,n){var r=n.$el.parent().data("type");$.goOrgSlide({header:m.manager_select,desc:m.manager_select_desc,type:"list",contextRoot:GO.contextRoot,memberTypeLabel:m[r],externalLang:t,isBatchAdd:!0,callback:$.proxy(function(e){n.addTags(e,{removable:!0,attrs:e})})})})})},folderTypeOptionViewToggle:function(e){$(e.currentTarget).val()=="PERIODIC"?$("#folderTypeOptionView").show():$("#folderTypeOptionView").hide()},renderRepeatView:function(e){var t=this.getRepeatType(e),n=$("ul.tab_nav");n.children().removeClass("on"),n.find("li[data-repeat="+t+"]").addClass("on"),$("tr[data-type=option]").hide(),this.renderRepeatLabel(t)},changeRepeatDate:function(e){this.renderRepeatLabel(this.getRepeatType(e))},getRepeatType:function(e){return $(e.target).attr("data-repeat")||$(e.target).parents("li").attr("data-repeat")||$(e.target).parents("tr").attr("data-repeat")},renderRepeatLabel:function(e){var t=this.getRepeatViewContext(e),n=this.getRepeatLabel(e),r=[];$.each(this.$el.find("#folderTypeOptionView tr[data-type='option']"),function(){$(this).hide()}),$.each(this.$el.find("#repeatTab li"),function(){var t=$(this);t.attr("data-repeat")==e?t.addClass("on"):t.removeClass("on")}),t.show(),$("span#repeatLabel").text(n)},getRepeatViewContext:function(e){return $("tr[data-repeat="+e+"]")},getRepeatLabel:function(e){var t="";return e=="DAILY"?t=this.getDailyLabel(e):e=="WEEKLY"?t=this.getWeeklyLabel(e):t=this.getMonthlyLabel(e),t},getDailyLabel:function(t){var i=this.getRepeatViewContext(t),s="",o=i.find("select[data-seq=1]").val();return o==1?s=n["\ub9e4\uc77c"]:s=e.i18n(r["{{monthday}}\uc77c\ub9c8\ub2e4"],{monthday:o}),this.setICalFormat({FREQ:"DAILY",INTERVAL:o}),s},getWeeklyLabel:function(t){var i=this.getRepeatViewContext(t),s=this.getDay(),o=[],u=[],a=[],f="",l="",c=i.find("select[data-seq=1]").val();return c==1?l=n["\ub9e4\uc8fc"]:l=e.i18n(r["{{week}}\uc8fc\ub9c8\ub2e4"],{week:c}),_.each(i.find("input[name=day]:checked"),function(e){u.push(d[e.getAttribute("value")]),a.push(v[e.getAttribute("value")])}),this.setICalFormat({FREQ:"WEEKLY",INTERVAL:c,BYDAY:u.join(",")}),f=e.i18n(r["{{frequecy}}\ub9c8\ub2e4 {{interval_options}}({{until_or_count}})"],{frequecy:l,interval_options:a.join(", ")}),f},getMonthlyLabel:function(t){var i=this.getRepeatViewContext(t),s=this.getDay(),o=i.find("select[data-seq=1]").val(),u=null,a=null,f="",l="",c={};o==1?f=n["\ub9e4\uc6d4"]:f=e.i18n(r["{{month}}\uac1c\uc6d4\ub9c8\ub2e4"],{month:o});var h=i.find("input[data-seq=2]:checked").parents("span.monthRecurrenceOption").find("select");if(h.attr("id")=="date"){var p=$(h[0]).val(),l=e.i18n(r["{{monthday}}\uc77c"],{monthday:p});c={FREQ:"MONTHLY",INTERVAL:o,BYMONTHDAY:p}}else{u=$(h[0]).val();var m=$(h[1]).val(),g="";c={FREQ:"MONTHLY",INTERVAL:o,BYDAY:d[m],BYSETPOS:u},u>0?(g=GO.util.parseOrdinaryNumber(u,GO.config("locale")),l=e.i18n(r["{{nth}}\ubc88\uc9f8 {{weekday}}"],{nth:g,weekday:v[m]})):(g=n["\ub9c8\uc9c0\ub9c9"],l=g+" "+v[m])}return this.setICalFormat(c),a=e.i18n(r["{{frequecy}}\ub9c8\ub2e4 {{interval_options}}({{until_or_count}})"],{frequecy:f,interval_options:l}),a},setICalFormat:function(e){var t=[];$.each(e,function(e,n){$.trim(n)!=""&&t.push(e+"="+n)}),this.folder.set({recurrence:t.join(";")})},getTermData:function(e,t){var n=[];for(var r=e;r<=t;r++)n.push({value:r});return n},getDay:function(){return[{text:n["\uc77c"],value:0},{text:n["\uc6d4"],value:1},{text:n["\ud654"],value:2},{text:n["\uc218"],value:3},{text:n["\ubaa9"],value:4},{text:n["\uae08"],value:5},{text:n["\ud1a0"],value:6}]},getStrLength:function(e){return escape(e).split("%u").join("").length},validation:function(){if(this.folder.get("name").length==0)return $.goMessage(t["\ud544\uc218\ud56d\ubaa9\uc744 \uc785\ub825\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."]),$("#folderName").focus(),!1;if(!$.goValidation.isCheckLength(2,100,this.folder.get("name")))return $.goMessage(e.i18n(t["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:2,arg2:100})),$("#folderName").focus(),!1;if(!$.goValidation.isCheckLength(0,2e3,this.folder.get("description")))return $.goMessage(e.i18n(t["\ucd5c\ub300 {{arg1}}\uc790 \uae4c\uc9c0 \uc785\ub825\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],{arg1:2e3})),$("#description").focus(),!1;var n=y(this.folder.get("recurrence"));return this.folder.isPeriodic()&&n.FREQ=="WEEKLY"&&$("#recurrence_table tr[data-repeat='WEEKLY'] input:checkbox:checked").length==0?($.goMessage(m.require_recurrence),!1):this.folder.get("admin").nodes.length==0?($.goMessage(m.require_admin),!1):this.folder.get("reporter").nodes.length==0?($.goMessage(m.require_reporter),!1):!0}}),E=!1;return g})}).call(this);