(function(){define(["jquery","underscore","backbone","app","hogan","report/models/report","hgn!report/templates/report_detail","hgn!report/templates/report_detail_content","hgn!report/templates/report_info_preview","attach_file","report/views/report_title","comment","content_viewer","i18n!nls/commons","i18n!report/nls/report","GO.util","jquery.go-popup","jquery.go-grid","formutil"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){function y(e,t,n){}var v="body {margin: 22px;}",m={empty_msg:d["\uc0dd\uc131\ub41c \ubcf4\uace0\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],print_preview:d["\uc778\uc1c4 \ubbf8\ub9ac\ubcf4\uae30"],empty_prev_report:d["\uc774\uc804 \ubcf4\uace0\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],empty_next_report:d["\ub2e4\uc74c \ubcf4\uace0\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],remove_desc:d["\ud574\ub2f9 \ubcf4\uace0\uc11c\ub97c \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],created_at:d["\ubcf4\uace0\uc77c"],report_title:d["\ubcf4\uace0 \uc81c\ubaa9"],reporter:d["\ubcf4\uace0\uc790"],print:p["\uc778\uc1c4"],remove:p["\uc0ad\uc81c"],edit:p["\uc218\uc815"],prev:p["\uc544\ub798"],next:p["\uc704"],copy:p["URL \ubcf5\uc0ac"],list:p["\ubaa9\ub85d"],comment:p["\ub313\uae00"],viewPopup:d["\ud31d\uc5c5\ubcf4\uae30"]},g=n.View.extend({el:"#content",events:{"click section.tool_bar a.remove":"remove","click section.tool_bar a.update":"update","click ul.controlButton li.list":"list","click ul.controlButton li.print":"print","click ul.controlButton li.next":"next","click ul.controlButton li.prev":"prev","click ul.controlButton li.viewPopup":"viewPopup"},initialize:function(e){this.options=e||{};var t=this.options.id;this.$el.off(),this.model=s.get(t),this.unreadableIds=[]},render:function(){var t=this.getDetailContent();this.$el.html(o({data:e.extend({},this.model.toJSON(),{}),lang:m})),this.$el.find("#report_detail_content").replaceWith(t);var n="table {width: 100%;}";n+=v;if(!this.options.isPrintMode){var r=this.$el.find("#reportContent");h.init({$el:r,content:this._getReportContent(),style:n})}l.create({text:this.model.get("folder").name,meta_data:this.model.get("department").name}),e("#side").trigger("set:leftMenu",this.options.folderId),this.model.get("folder").actions.writable||this.$el.find("div.reply_wrap li.creat").html(""),this.renderGrid(),this.commentCountUpdate()},viewPopup:function(){var e=window.location.protocol+"//"+window.location.host+r.contextRoot+"app/report/"+this.options.id+"/popup";window.open(e,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},commentCountUpdate:function(){var e=this;this.$el.on("comment:change",function(t,n,r){var i=e.$el.find("header.article_header span.reply_count"),s=e.$el.find("section.article_reply span.num");i.text(r),s.html(r)})},renderGrid:function(){var n=this;this.dataTable=e.goGrid({el:"#report_list",method:"GET",url:r.contextRoot+"api/report/"+this.options.id+"/tiny",emptyMessage:"<p class='data_null'> <span class='ic_data_type ic_no_data'></span><span class='txt'>"+m.empty_msg+"</span>"+"</p>",defaultSorting:[[1,"asc"]],sDomUse:!1,checkbox:!1,pageUse:!1,checkboxData:"id",columns:[{mData:null,bSortable:!1,sClass:"date",sWidth:"140px",fnRender:function(e){var t=e.aData,i=[];return t.id==n.options.id&&i.push("<span class='ic_classic ic_now'></span>"),i.push("<span class='date'>"+r.util.customDate(t.submittedAt,"YYYY-MM-DD")+"</span>"),i.join("")}},{mData:null,bSortable:!1,sClass:"subject",sWidth:"600px",fnRender:function(e){var t=e.aData,i=[],s="<span class='ic_side ic_private'></span>";if(!t.name){var o=e.aData.series.series,u=r.util.basicDate2(e.aData.series.closedAt);t.name=u+" "+r.i18n(d["\uc81c {{arg1}}\ud68c\ucc28"],{arg1:o})}return t.actions.readable||(n.unreadableIds.push(t.id),i.push(s)),i.push("<span class='subject' data-readable='"+t.actions.readable+"' data-folder-id='"+n.options.folderId+"' data-report-id='"+t.id+"'>"+t.name+"</span>"),t.commentCount>0&&i.push("<span class='ic_classic ic_reply'></span><span class='num'>[<strong>"+t.commentCount+"</strong>]</span>"),i.join("")}},{mData:null,bSortable:!1,sClass:"reporter",sWidth:"240px",fnRender:function(e){var t=e.aData;return t.reporter.name+" "+t.reporter.position}}],fnDrawCallback:function(i){t.each(n.$el.find("tr>td:nth-child(2) span.subject"),function(t){e(t).attr("data-readable")=="true"&&e(t).css("cursor","pointer").click(function(t){var n=e(t.currentTarget);url="report/folder/"+n.attr("data-folder-id")+"/report/"+n.attr("data-report-id"),r.router.navigate(url,{trigger:!0})})}),n.dataTable.find("tr span[data-report-id='"+n.options.id+"']").parents("tr").addClass("active")}}).tables},getDetailContent:function(t){var n=this,i=t==undefined||t.isPrintMode==undefined?!1:t.isPrintMode,s=this.model.get("name");if(!s){var o=this.model.get("series").series,a=r.util.basicDate2(this.model.get("series").closedAt);s=a+" "+r.i18n(d["\uc81c {{arg1}}\ud68c\ucc28"],{arg1:o})}var l=u({data:e.extend({},this.model.toJSON(),{submittedAtBasicDate:r.util.basicDate(this.model.get("submittedAt")),content:n._getReportContent(),name:s}),lang:m}),h=e(l);return c.render({el:h.find("#reportReply"),typeUrl:"report",typeId:this.model.get("id"),isPrintMode:i,isWritable:!this.model.get("department").deletedDept}),h.off(),f.create("#report-attach-placeholder",this.model.get("attaches"),function(e){return r.config("contextRoot")+"api/report/"+n.options.id+"/download/"+e.id}),h},_getReportContent:function(){var t=r.util.convertMSWordTag(r.util.escapeXssFromHtml(this.model.get("content")));return this.model.get("contentType")=="TEXT"&&(t=r.util.convertRichText(t)),t=e.goFormUtil.convertViewMode(t),t},list:function(){var e="report/folder/"+this.options.folderId+"/reports",t=sessionStorage.getItem("report-list-page")||0,n=sessionStorage.getItem("report-list-offset")||20;e+="?page="+t+"&offset="+n,r.router.navigate(e,{trigger:!0})},print:function(){var e=window.location.protocol+"//"+window.location.host+r.contextRoot+"app/report/"+this.options.id+"/print";window.open(e,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},makeReportInfo:function(){return i.compile(u.text)},prev:function(t){var n=e(t.currentTarget),i=n.attr("data-id"),s="";if(i==0){e.goMessage(m.empty_prev_report);return}if(this.unreadableIds.includes(parseInt(i))){e.goMessage(r.i18n(p["{{target}}\uc5d0 \ub300\ud55c \uc811\uadfc \uad8c\ud55c\uc774 \uc5c6\uc5b4 \ud655\uc778\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],{target:d["\ubcf4\uace0\uc11c"]}));return}s="report/folder/"+this.options.folderId+"/report/"+i,r.router.navigate(s,{trigger:!0})},next:function(t){var n=e(t.currentTarget),i=n.attr("data-id"),s="";if(i==0){e.goMessage(m.empty_next_report);return}if(this.unreadableIds.includes(parseInt(i))){e.goMessage(r.i18n(p["{{target}}\uc5d0 \ub300\ud55c \uc811\uadfc \uad8c\ud55c\uc774 \uc5c6\uc5b4 \ud655\uc778\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],{target:d["\ubcf4\uace0\uc11c"]}));return}s="report/folder/"+this.options.folderId+"/report/"+i,r.router.navigate(s,{trigger:!0})},remove:function(){var t=this;e.goConfirm("",m.remove_desc,function(){t.model.destroy({success:function(){var e="report/folder/"+t.options.folderId+"/reports";r.router.navigate(e,{trigger:!0})}})})},update:function(){var e="report/folder/"+this.options.folderId+"/update/"+this.options.id;r.router.navigate(e,{trigger:!0})},release:function(){this.childView.release(),this.$el.off(),this.$el.empty(),this.remove()}},{__instance__:null,create:function(){return this.__instance__===null&&(this.__instance__=new this.prototype.constructor),this.__instance__}});return g})})();