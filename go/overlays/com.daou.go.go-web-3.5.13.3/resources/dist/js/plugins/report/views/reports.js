(function(){define(["backbone","app","i18n!nls/commons","i18n!report/nls/report","report/models/report_folder","report/models/series_report","hgn!report/templates/reports","report/views/report_title","calendar/libs/recurrence_parser","jquery.go-grid","GO.util"],function(e,t,n,r,i,s,o,u,a){var f={series:r["\ubcf4\uace0 \ud68c\ucc28"],seriesStatus:r["\ubcf4\uace0\ud604\ud669"],write:r["\ubcf4\uace0 \uc791\uc131"],submmitedAt:r["\ubcf4\uace0\uc77c"],name:r["\ubcf4\uace0\uc11c \uc81c\ubaa9"],reporter:r["\ubcf4\uace0\uc790"],urltoclip_ie:r["\ubcf4\uace0\uc11c\uc8fc\uc18c\ubcf5\uc0acIE"],urltoclip_etc:r["\ubcf4\uace0\uc11c\uc8fc\uc18c\ubcf5\uc0acETC"],series_empty_msg:r["\ud68c\ucc28 \uc815\ubcf4\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],report_empty_msg:r["\ub4f1\ub85d\ub41c \ubcf4\uace0\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],report_address:r["\ubcf4\uace0\uc11c \uc8fc\uc18c"],close:n["\ub2eb\uae30"],copy:n["\ubcf5\uc0ac"],recurrence:r["\ubcf4\uace0\uc8fc\uae30"],refferer:r["\ucc38\uc870\uc790"],admin:r["\uc6b4\uc601\uc790"]},l=t.BaseView.extend({el:"#content",events:{"click #folderInfo":"folderInfoToggle","click #controlButtons a.createReport":"write","click header.content_top ins.ic_star":"favorite","click span.series_wrap":"_clickSeriesReport","click tr>td.write span.writeBtn":"_clickWriteButton","click .occasional_popup":"_clickOcassionalPopup","click .occasional_detail":"_clickOcassionalReport"},initialize:function(e){this.options=e||{};var t=this;this.$el.off(),this.folderModel=i.get(this.options.id),$("#side_favorite").on("changeFavorite",function(e,n){var r=!1;$.each(n,function(e,n){if(n.get("id")==t.folderModel.get("id")){r=!0;return}}),r||t.$el.find("header.content_top ins").addClass("ic_star_off")})},render:function(){this.searchParams=this._getSearchParams();var e=this,i={},s=e.folderModel.get("recurrence"),l=new a;this.folderModel.isPeriodic()?i={column1:f.series,column2:f.seriesStatus,column3:f.write}:i={column1:f.submmitedAt,column2:f.name,column3:f.reporter},this.$el.html(o({data:$.extend({},this.folderModel.toJSON(),{urlLink:window.location.href.split("?")[0],reporterNames:this.folderModel.reporterNames(),referrerNames:this.folderModel.referrerNames(),adminNames:this.folderModel.adminNames(),isPeriodic:function(){return e.folderModel.isPeriodic()},recurrence:s?l.parse(s).humanize():"",description:function(){return t.util.textToHtml(e.folderModel.get("description"))},isDescriptionExist:function(){return $.trim(e.folderModel.get("description"))!=""?!0:!1}}),lang:f,tableHeader:i}));var c="";this.folderModel.isPeriodic()?(this._renderPeriodic.call(this),c=t.i18n(r["\ucd1d {{arg1}} \ud68c\ucc28"],{arg1:this.folderModel.get("totalSeries")})):(this._renderOccasional.call(this),t.i18n(r["\ucd1d {{arg1}} \uac74"],{arg1:this.folderModel.get("totalSeries")})),u.create({text:this.folderModel.get("name"),meta_data:this.folderModel.get("department").name,meta_section:c,favorite:{isOn:this.folderModel.get("favorite"),text:n["\uc990\uaca8\ucc3e\uae30 \ucd94\uac00\ud558\uae30"]}}),$("#side").trigger("set:leftMenu",this.folderModel.get("id"));var h=$("#folderDetailInfo");h.toggle(!this.getFolderStatus())},favorite:function(e){var n=$(e.currentTarget),r=n.hasClass("ic_star_off"),i=t.contextRoot+"api/report/folder/"+this.folderModel.get("id")+"/favorite",s="";r?s="POST":s="DELETE",$.go(i,"",{contentType:"application/json",qryType:s,async:!1,responseFn:function(e){r?n.removeClass("ic_star_off"):n.addClass("ic_star_off"),$("#side_favorite").trigger("refresh")}})},write:function(e){var n="report/folder/"+this.folderModel.get("id")+"/write";t.router.navigate(n,{trigger:!0})},_renderPeriodic:function(){var e=this,n=$.goGrid({el:"#serise_report_list",method:"GET",url:t.contextRoot+"api/report/folder/"+this.options.id+"/series",params:this.searchParams,emptyMessage:"<p class='data_null'> <span class='ic_data_type ic_no_data'></span><span class='txt'>"+f.series_empty_msg+"</span>"+"</p>",defaultSorting:[[0,"desc"]],columns:[{mData:null,sClass:"times",bSortable:!1,fnRender:function(e){var n=e.aData,i=t.util.parseOrdinaryNumber(n.series,t.config("locale")),o=[],u=new s,a=t.session().id;return u.set(e.aData),reporter=u.findReporterByUserId(a),reporter.status=="undones"&&reporter.user.actions.writable?o.push('<span class="series_wrap" data-report-id="'+reporter.user.reportId+'"data-series-id="'+n.id+'">'):o.push('<span class="series_wrap" data-series-id="'+n.id+'">'),o.push(t.util.basicDate2(e.aData.closedAt)+" "+t.i18n(r["\uc81c {{arg1}}\ud68c\ucc28"],{arg1:i})),o.push("</span>"),o.join("\n")}},{mData:null,sClass:"status",bSortable:!1,fnRender:function(e){var n=e.aData,i=n.dones,o=n.undones,u=[],a=[],f=[];$.each(i,function(e,t){u.push(t.name+" "+t.position)}),$.each(o,function(e,t){a.push(t.name+" "+t.position)});var l=new s,c=t.session().id;return l.set(e.aData),reporter=l.findReporterByUserId(c),reporter.status=="undones"&&reporter.user.actions.writable?f.push('<span class="series_wrap" data-report-id="'+reporter.user.reportId+'"data-series-id="'+n.id+'" title="'+r["\ubcf4\uace0\uc790"]+": "+u.join(", ")+" / "+r["\ubbf8\ubcf4\uace0\uc790"]+": "+a.join(", ")+'">'):f.push('<span class="series_wrap" data-series-id="'+n.id+'" title="'+r["\ubcf4\uace0\uc790"]+": "+u.join(", ")+" / "+r["\ubbf8\ubcf4\uace0\uc790"]+": "+a.join(", ")+'">'),f.push(t.i18n(r["\ubcf4\uace0\uc790 {{arg1}}\uba85"],{arg1:i.length})),o.length==0?f.push('<span class="ok">('+r["\uc804\uc6d0\ubcf4\uace0"]+")</span>"):f.push('<span class="not">('+t.i18n(r["\ubbf8\ubcf4\uace0\uc790 {{arg1}}\uba85"],{arg1:o.length})+")</span>"),f.push("</span>"),n.commentCount>0&&f.push("<span class='ic_classic ic_reply'></span><span class='num'>[<strong>"+n.commentCount+"</strong>]</span>"),n.isNew&&f.push('<span class="ic_classic ic_new2"></span>'),f.join("\n")}},{mData:null,sClass:"write",bSortable:!1,fnRender:function(e){var n=new s,i=t.session().id;return n.set(e.aData),reporter=n.findReporterByUserId(i),reporter.status=="undones"&&reporter.user.actions.writable?'<span data-form-flag="'+n.get("folder").formFlag+'" data-report-id="'+reporter.user.reportId+'" data-series-id="'+n.get("id")+'"class="btn_fn7 writeBtn" data-role="button"><span class="txt">'+r["\ubcf4\uace0 \uc791\uc131"]+"</span></span>":"-"}}],fnDrawCallback:function(t,n,r){e.$el.find("span.series_wrap").css("cursor","pointer"),e.$el.find("tr>td:nth-child(3) span.writeBtn").css("cursor","pointer"),$(window).scrollTop(0),e._addSearchParam({page:r.page,offset:r.offset})}});this.reportsTable=n.tables},_clickSeriesReport:function(e){var n=$(e.currentTarget),r=n.attr("data-series-id"),i="report/series/"+r;n.attr("data-report-id")&&(i="report/series/"+r+"/report/"+n.attr("data-report-id")),t.router.navigate(i,{trigger:!0})},_clickWriteButton:function(e){var n=$(e.currentTarget);seriesId=n.attr("data-series-id"),reportId=n.attr("data-report-id"),url="report/series/"+seriesId+"/report/"+reportId,t.router.navigate(url,{trigger:!0})},_renderOccasional:function(){var e=this,n=$.goGrid({el:"#serise_report_list",method:"GET",url:t.contextRoot+"api/report/folder/"+this.options.id+"/reports",params:this.searchParams,emptyMessage:"<p class='data_null'> <span class='ic_data_type ic_no_data'></span><span class='txt'>"+f.report_empty_msg+"</span>"+"</p>",defaultSorting:[[0,"desc"]],columns:[{mData:"submittedAt",sWidth:"140px",sClass:"date",bSortable:!0,fnRender:function(e){return t.util.basicDate3(e.aData.submittedAt)}},{mData:"name",sWidth:"1280px",sClass:"subject",bSortable:!0,fnRender:function(e){var t=e.aData,n=t.readable,i=[],s="<span class='ic_side ic_private'></span>";return i.push("<span data-id='"+t.id+"'>"),t.actions.readable?(i.push("<a class='detail occasional_detail'>"),i.push("<span class='txt'>"+t.name+"</span>"),t.commentCount>0&&i.push("<span class='ic_classic ic_reply'></span><span class='num'>[<strong>"+t.commentCount+"</strong>]</span>"),i.push("</a>"),i.push("<a class='popup occasional_popup'>"),i.push("<span class='ic_gnb ic_popup' title='"+r["\ud31d\uc5c5\ubcf4\uae30"]+"'></span>"),i.push("</a>")):(i.push(s),i.push("<span class='txt'>"+t.name+"</span>"),t.commentCount>0&&i.push("<span class='num'>[<strong>"+t.commentCount+"</strong>]</span>"),i.push("<span class='ic_gnb ic_popup' title='"+r["\ud31d\uc5c5\ubcf4\uae30"]+"'></span>")),t.isNew&&i.push('<span class="ic_classic ic_new2"></span>'),i.push("</span>"),i.join("")}},{mData:"reporter",sWidth:"240px",sClass:"reporter",bSortable:!0,fnRender:function(e){var t=e.aData.reporter;return t.name+" "+t.position}}],fnDrawCallback:function(t,n,r){e.$el.find("div.tool_bar div.custom_header").append(e.$el.find("#controlButtons").show()),e.$el.find(".occasional_detail").css("cursor","pointer"),e.$el.find(".occasional_popup").css("cursor","pointer"),$(window).scrollTop(0),e._addSearchParam({page:r.page,offset:r.offset})}});this.reportsTable=n.tables,this.reportsTable.addClass("type_normal tb_lately_report_anytime")},_clickOcassionalPopup:function(e){var n=$(e.currentTarget),r=n.parents("span").attr("data-id"),i=window.location.protocol+"//"+window.location.host+t.contextRoot+"app/report/"+r+"/popup";window.open(i,"","location=no, directories=no,resizable=yes,status=no,toolbar=no,menubar=no, width=1280,height=650,left=0, top=0, scrollbars=yes")},_clickOcassionalReport:function(e){var n=$(e.currentTarget),r=n.parents("span").attr("data-id"),i="report/folder/"+this.folderModel.get("id")+"/report/"+r;t.router.navigate(i,{trigger:!0})},folderInfoToggle:function(e){var r=$(e.currentTarget),i="",s=$("#folderDetailInfo"),o=s.is(":visible"),u="reportInfo_"+t.session("id")+"_"+this.id;r.find("span.ic_classic").hasClass("ic_close")?i='<span class="ic_classic ic_open" title="'+n["\uc5f4\uae30"]+'"></span>':i='<span class="ic_classic ic_close" title="'+n["\ub2eb\uae30"]+'"></span>',s.toggle(!o),t.util.store.set(u,o,{type:"local"}),r.html(i)},getFolderStatus:function(){var e="reportInfo_"+t.session("id")+"_"+this.id;return t.util.store.get(e)||!1},searchParamKeys:["page","offset"],_addSearchParam:function(e){var n=t.router.getUrl(),r=this._getSearchParams(),e=e||{};sessionStorage.setItem("report-list-page",e.page),sessionStorage.setItem("report-list-offset",e.offset),$.each(this.searchParamKeys,function(t,n){e.hasOwnProperty(n)&&(r[n]=e[n])}),t.router.navigate(n.split("?")[0]+"?"+$.param(r),{replace:!0})},_getSearchParams:function(){var e=t.router.getSearch(),n=e||{};return n.page=e.page||0,n.offset=e.offset||20,n}});return l})})();