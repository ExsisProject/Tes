(function(){define(["backbone","when","app","dashboard/models/gadgets"],function(e,t,n,r){function a(e,t){return _.findWhere(o,{boxCount:e,layout:t})}function f(){return!this.fetchingFlag&&this.activated()&&!this.getGadgets().length}function l(){return[_.result(this,"url"),"move"].join("/")}function c(e){return $.extend(!0,e||{},{url:l.call(this)})}var i="go_dashboard",s={company:"COMPANY",user:"USER"},o=[],u;return o.push({id:1,boxCount:3,layout:1,desc:"3-1"}),o.push({id:2,boxCount:3,layout:2,desc:"3-2"}),o.push({id:3,boxCount:3,layout:3,desc:"3-3"}),o.push({id:4,boxCount:5,layout:1,desc:"5-1"}),u=e.Model.extend({fetchingFlag:!1,defaults:{title:"My Portal",type:s.user,boxCount:3,layout:1,gadgetAddable:!0,seq:0,activated:!1},initialize:function(){this.fetchingFlag=!1},urlRoot:function(){return"/api/dashboard"},fetchGadgets:function(e){var n=this,i=t.defer();if(e||!1||f.call(this)){var s=r.create(this.get("id"));this.fetchingFlag=!0,s.fetch({success:function(e){n.set("gadgets",e.toJSON()),n.fetchingFlag=!1,i.resolve(e)},error:function(e,t,n){i.reject(t)}})}return i.promise},removeGadgetsInBoxes:function(e){var t=(n.config("contextRoot")+[_.result(this,"urlRoot"),this.get("id"),"gadget/box"].join("/")).replace("//","/");return $.ajax({url:t,type:"DELETE",contentType:"application/json",data:JSON.stringify({boxNumbers:e||[]})})},changeLayout:function(e,t){var n=$.Deferred();return this.save({boxCount:e,layout:t},{success:n.resolve,error:n.reject}),n},updateLayout:function(e,t){var n=$.Deferred();return this.removeGadgetsInBoxes(this.diffBoxNumbers(e)).then(_.bind(function(){this.changeLayout(e,t).then(n.resolve,n.reject)},this),n.reject),n},getGadgets:function(){return this.get("gadgets")||[]},buildGadgets:function(){return r.create(this.get("id"),this.get("gadgets")||[])},activateFrom:function(e){this.get("id")===e?this.activate():this.deactivate()},activate:function(){this.set("activated",!0)},deactivate:function(){this.set("activated",!1)},move:function(e,t){this.save("seq",e,c.call(this,t))},getTitle:function(){return this.get("title")},getSeq:function(){return this.get("seq")||0},getLayout:function(){return this.get("layout")},getBoxCount:function(){return this.get("boxCount")},activated:function(){return this.get("activated")||!1},isCompanyType:function(){return this.get("type")===s.company},isUserType:function(){return this.get("type")===s.user},canAddGadget:function(){return this.get("gadgetAddable")||!1},getSelectorName:function(){return[i,this.get("boxCount"),this.getLayout()].join("_")},diffBoxNumbers:function(e){return _.difference(_.range(this.getBoxCount()),_.range(e))},hasEditableGadget:function(){var e=_.find(this.get("gadgets"),function(e){return e.actions.updatable||e.actions.removable});return _.isObject(e)},isEditable:function(){return this.hasEditableGadget()||this.canAddGadget()}}),u.TYPE_COMPANY=s.company,u.TYPE_USER=s.user,u.LAYOUT_SPECS=o,u})})();