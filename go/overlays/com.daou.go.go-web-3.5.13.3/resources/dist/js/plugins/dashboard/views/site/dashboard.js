(function(){define(["backbone","when","app","dashboard/models/dashboard","dashboard/models/gadget","dashboard/views/site/gadget","i18n!dashboard/nls/dashboard","go-webeditor/jquery.go-webeditor"],function(e,t,n,r,i,s,o){function T(e){e=e||[];for(var t=0,n=e.length;t<n;t++)if(N.call(this,e[t]))return!0;return!1}function N(e){return this.$el.find(d+e).has(a).length>0}function C(e){var t=$('<div class="go-gadget-draghelper go_gadget_move_warp"></div>'),n=e.data("view"),r=n.getSpecName(),i=[];return i.push('<div class="go-gadget">'),i.push('<div class="go-gadget-header go_gadget_header">'),i.push('<div class="gadget_h1">'),i.push('<span class="title">'+r+"</span>"),i.push("</div>"),i.push("</div>"),i.push("</div>"),t.width(g.width).height(g.height).append(i.join("\n")),t}function k(e){_.map(e||[],function(e){var t=e+1;this.$el.find(d+t).find(a).each(function(t,n){var r=$(n).data("view");r.setPosition(e,t)})},this)}function L(){return X.call(this)?i.TYPE_COMPANY:i.TYPE_USER}function A(e){return this.$el.find(d+(e+1))}function O(){return d+v}function M(){var e=$('<div class="'+h+'"></div>').css({border:"1px dashed #AAA","min-height":"100px"});this.$el.find(l).append(e)}function D(e){!e||(this.layoutTemplate=e),this.$el.empty().append(this.layoutTemplate)}function P(e){e.attr("unselectable","on").css("MozUserSelect","none").bind("selectstart.ui",function(){return!1})}function H(e){var t=$.Deferred();return require(["hgn!dashboard/templates/site/layouts/layout-"+e.getBoxCount()+"-"+e.getLayout()],function(e){t.resolve(e)}),t}function B(e){e.length>0?(e.rawSort().each(function(e){z.call(this,e.toJSON(),e.getBoxNumber()).load()},this),R.call(this)):j.call(this)}function j(){var e=o["\uac1c\uc778 \ub300\uc2dc\ubcf4\ub4dc \uac00\uc82f \uc5c6\uc74c \uba54\uc2dc\uc9c0"],t=[];F.call(this)?t.push(q()):e=o["\uac00\uc82f \uc5c6\uc74c \uba54\uc2dc\uc9c0"],t.unshift(e),this.$el.empty().append(I.apply(this,t))}function F(){return this.model.isUserType()?!0:n.session("dashboardAdmin")?!0:this.model.canAddGadget()?!0:!1}function I(e,t){var n=[];return n.push('<div class="null_data full_page">'),n.push('<span class="ic_data_type"></span>'),n.push('<p class="desc">'+e+"</p>"),!t||n.push(t),n.push("</div>"),n.join("\n")}function q(){var e=[];return e.push('<a href="#" class="btn-empty-add-gadget btn_w" data-bypass>'),e.push('<span class="ic_dashboard2 ic_mgmt_t" title="'+o["\uac00\uc82f\ucd94\uac00"]+'"></span>'),e.push('<span class="txt">'+o["\uac00\uc82f\ucd94\uac00"]+"</span>"),e.push("</a>"),e.join("\n")}function R(){this.model.activated()&&this.$el.find(a).trigger("gadget:request-content")}function U(e){return typeof e=="undefined"?v:e}function z(e,t){var r={data:e,locale:n.config("locale"),contextRoot:n.config("contextRoot"),canPersonalize:W.call(this),editorRunner:{load:function(e){var t=$(e).attr("name"),r=$(e).val(),i=n.config("locale"),s=t+"-"+(new Date).valueOf();$(e).attr("id",s),$("#"+s).goWebEditor({contextRoot:n.config("contextRoot"),lang:i,editorValue:r,theme:"simple"})},getData:function(e){var t=$(e).attr("id"),r=n.Editor.getInstance(t),i={},s="";return s=r.getContent(),s==="<br>"&&(s=""),r.options.name=="ActiveDesigner"&&(i.isMime=!0),i[$(e).attr("name")]=s,i}}};return typeof t!="undefined"&&(r.appendTo="#"+c+e.dashboardId+" "+d+U(t)),s.create(r)}function W(){return this.model.isUserType()?!1:n.session("dashboardAdmin")?!0:!1}function X(){return this.model.isCompanyType()&&n.session("dashboardAdmin")}function V(e){return"go-dashboard-"+e.get("id")}function J(e){return $("#"+c+e)}function K(e){return e.get("id")}var u="dashboard",a=".go-gadget",f=".go-gadget-header",l=".go-gadget-column",c="go-dashboard-",h="dashboard-box-guide",p="go-dashboard-editing",d=".gadget-col-",v=1,m=0,g={width:350,height:150},y={left:225,top:20},b=10,w=10,E={enable:"dashboard:enable-editing",disable:"dashboard:disable-editing"},S=[],x;return S.push({id:1,boxCount:3,layout:1,desc:"3-1"}),S.push({id:2,boxCount:3,layout:2,desc:"3-2"}),S.push({id:3,boxCount:3,layout:3,desc:"3-3"}),S.push({id:4,boxCount:5,layout:1,desc:"5-1"}),x=e.View.extend({className:"go-dashboard",editingMode:!1,layoutTemplate:"",initialize:function(e){this.id||this.$el.prop("id",V(this.model)),this.$el.addClass(this.model.getSelectorName()),this.$el.data(u,this),this.layoutTemplate=""},render:function(e){var n=this,r=t.defer(),i=H(this.model),s;return i.then(function(e){return D.call(n,e())}).then(function(){return n.model.fetchGadgets(e)}).then(function(e){return e.then(function(e){B.call(n,e),r.resolve()},r.reject)},function(e){console.log(e.stack),r.reject()}),r.promise},decideActivate:function(){this.model.activated()?this.$el.addClass("activated").show():this.$el.removeClass("activated").hide()},enableEditingMode:function(){this.editingMode||(this.$el.find(l).length||D.call(this),this.$el.addClass(p),M.call(this),this.enableSortable(),this.editingMode=!0)},enableSortable:function(){var e=this;$(l).sortable({items:a,cancel:".ui-not-sortable",connectWith:l,handle:f,distance:10,delay:250,placeholder:"go-gadget-placeholder",cursorAt:y,scrollSensitivity:b,scrollSpeed:w,helper:function(e,t){return C(t)},over:function(e,t){$(this).find("."+h).appendTo(this)},stop:function(t,n){var r=n.item,i=r.parent(),s=r.data("view"),u=s.getGadgetId(),f=s.getBoxNumber()-1,l=+i.data("columnid")-1,c=0;i.find(a).each(function(e,t){if($(t).data("view").getGadgetId()===u){c=e;return}}),s.move(l,c).done(function(t){k.call(e,_.uniq([f,l]))}).fail(function(){$.goError(o["\uac00\uc82f \uc774\ub3d9 \uc624\ub958 \uba54\uc2dc\uc9c0"]),r.sortable("cancel")})}}),$(a).addClass("ui-widget ui-widget-content ui-helper-clearfix ui-corner-all").find(f).addClass("ui-widget-header ui-corner-all").end(),P($(l))},disableSortable:function(){this.$el.find(a).trigger("gadget:disable-editing").removeClass("ui-widget ui-widget-content ui-helper-clearfix ui-corner-all").find(f).removeClass("ui-widget-header ui-corner-all").end(),this.$el.find(l).sortable("destroy")},disableEditingMode:function(){if(this.editingMode){var e=this;this.$el.find("."+h).remove(),this.model.fetchGadgets(!0).then(function(t){t.length>0?e.disableSortable():j.call(e),e.$el.removeClass(p),e.editingMode=!1,!n.router.getSearch("editmode")||n.router.navigate("home",{trigger:!1,replace:!0})})}},show:function(){this.$el.show()},hide:function(){this.$el.hide()},isEditingMode:function(){return this.editingMode},addGadget:function(e){var t,n=this.$el.find(O()),r=+n.data("columnid")-1,i={spec:e,type:L.call(this),dashboard:{id:this.model.id},boxNumber:r,boxOrder:m};t=z.call(this,i),n.prepend(t.el),t.load(),t.createGadget().then(_.bind(function(){k.call(this,[r])},this))},hasNoneSavedGadgets:function(){return this.$el.find("."+s.NEW_MARK).length>0},hasGadget:function(){return this.$el.find(a).length>0},changeLayout:function(e,t){var n=$.Deferred(),r=this.model.diffBoxNumbers(e);return T.call(this,r)?$.goConfirm(o["\ub808\uc774\uc544\uc6c3 \ubcc0\uacbd \uc548\ub0b4"],o["\ub808\uc774\uc544\uc6c3 \ubcc0\uacbd \ud655\uc778 \uba54\uc2dc\uc9c0"],_.bind(function(){this.model.updateLayout(e,t).then(n.resolve,n.reject)},this)):this.model.changeLayout(e,t).then(n.resolve,n.reject),n}},{LAYOUT_SPECS:r.LAYOUT_SPECS,exists:function(e){return J(e).length>0},getInstanceById:function(e){return this.exists(e)?J(e).data(u):undefined},loadTo:function(e,t){var n,r=$.Deferred();return this.exists(K(t))?(n=this.getInstanceById(K(t)),r.resolve(n)):(n=new x({model:t,id:c+t.get("id")}),$(e).append(n.el),n.render().then(function(){r.resolve(n)},r.reject)),n.isEditingMode()&&n.enableEditingMode(),r},forceLoadTo:function(e,t){var n,r=$.Deferred();return $(e).find("#"+c+t.get("id")).remove(),n=new x({model:t,id:c+t.get("id")}),$(e).append(n.el),n.render(!0).then(function(){r.resolve(n)},r.reject),r}}),x})})();