(function(undefined){define(["backbone","app","dashboard/models/gadget","hgn!dashboard/templates/site/gadget","i18n!nls/commons","i18n!dashboard/nls/dashboard","jquery.go-popup","go-gadget"],function(Backbone,GO,GadgetModel,GadgetTemplate,CommonLang,DashboardLang){function updateGadgetContent(){this.$el.data("view",this).find(".go-gadget-content").empty().show().end().find(".error-msg-wrapper").empty(),this.requestContent(),updateNewGadgetMark.call(this)}function getGadgetHeaderTitleOnEdit(){return this.model.getSpec("name")}function updateNewGadgetMark(){this.model.isNew()?this.$el.addClass(GADGET_NEW_MARK):this.$el.removeClass(GADGET_NEW_MARK)}function updateEditGadgetClass(e){e?this.$el.addClass(GADGET_EDIT_WRAP):this.$el.removeClass(GADGET_EDIT_WRAP)}function updateHighlightClass(){var e=JSON.parse(this.model.get("options"));e.highlight=="Y"?this.$el.addClass(GADGET_HIGHLIGHT):this.$el.removeClass(GADGET_HIGHLIGHT)}function showGadgetErrorContent(e){$(e).empty().append(makeGadgetContentLoadError.call(this))}function makeGadgetContentLoadError(){var e=this.contentProvider.pageTemplate;return e.loadError()}function makeGadgetContentLoadingImg(){return'<div class="img_loader_large" title="'+CommonLang["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]+'"></div>'}var GadgetView,GADGET_NEW_MARK="gadget-not-saved",GADGET_EDIT_WRAP="wrap_gadget_edit",GADGET_HIGHLIGHT="gadget_design_border";return GadgetView=Backbone.View.extend({className:"go-gadget",editMode:!1,langs:{},events:{"click .btn-refresh":"refreshContent","click .btn-edit":"setEditMode","click .btn-remove":"removeGadget","click .btn-option-save":"saveGadget","click .btn-option-cancel":"setNormalMode"},initialize:function(e){this.options=e,this.model||(this.model=new GadgetModel),this.editMode=!1,this.spec=this.model.get("spec"),this.locale=this.options.locale||"ko",this.contextRoot=this.options.contextRoot||"/",this.canPersonalize=e.canPersonalize||!1,this.contentProvider=new GO.gadget.ContentProvider(this.el,this.spec,{methodType:this.model.isNew()?"create":"update",locale:this.locale,contextRoot:this.contextRoot,canPersonalize:this.canPersonalize,langs:{refresh:{label:CommonLang["\uc0c8\ub85c\uace0\uce68"],none:DashboardLang["\uc0c8\ub85c\uace0\uce68 \uc548\ud568"],unit_minute:DashboardLang["\ubd84\ub2e8\uc704 \uc2dc\uac04 \ud45c\uc2dc"],unit_hour:DashboardLang["\uc2dc\ub2e8\uc704 \uc2dc\uac04 \ud45c\uc2dc"]},personalize:{label:DashboardLang["\uac1c\uc778\ud654"],editable:DashboardLang["\ud3b8\uc9d1 \uac00\ub2a5"],removable:DashboardLang["\uc0ad\uc81c \uac00\ub2a5"]},highlight:{label:DashboardLang["\uac00\uc82f \ud14c\ub450\ub9ac"],highlight:DashboardLang["\uac15\uc870"]},msg:{load_error:DashboardLang["\uac00\uc82f \ub85c\ub4dc \uc624\ub958 \uba54\uc2dc\uc9c0"]}}}),updateNewGadgetMark.call(this),this.$el.off().on("gadget:disable-editing",$.proxy(function(e){this.setNormalMode(),e.stopPropagation()},this)).on("gadget:request-content",$.proxy(this.requestContent,this)).data("view",this)},load:function(){this.render();if(this.spec.script&&typeof this.spec.script=="string")try{var e=new Function("gadget",this.spec.script),t={layout:this.model.get("dashboard").boxCount+"_"+this.model.get("dashboard").layout,column:parseInt(this.model.get("boxNumber"))+1};this.contentProvider.setOption($.extend({},$.parseJSON(this.model.get("options")),t)),e({load:$.proxy(function(){this.contentProvider.load.apply(this.contentProvider,arguments)},this)})}catch(n){this.raiseError()}this.model.isNew()&&(this.$el.find(".btn-mgmt").show(),this.setEditMode(),this.$el.find(".go-gadget-content").hide())},render:function(){this.$el.append(GadgetTemplate({title:getGadgetHeaderTitleOnEdit.call(this),"showConfigButton?":this.model.updatable(),"showRemoveButton?":this.model.removable(),label:{setup:CommonLang["\uc124\uc815"],refresh:CommonLang["\uc0c8\ub85c\uace0\uce68"],modify:CommonLang["\ud3b8\uc9d1"],remove:CommonLang["\uc0ad\uc81c"],save:CommonLang["\uc800\uc7a5"],cancel:CommonLang["\ucde8\uc18c"]}}))},getGadgetId:function(){return this.model.id},getSpecName:function(){return this.spec.name},move:function(e,t){var n=this,r=this.getSpecName().indexOf("HTML",0)!=-1?!0:!1;return r&&this.editMode==1&&this.setNormalMode(),deferred=$.Deferred(),this.model.savePosition(e,t).then(function(t){var r=t.get("dashboard");n.contentProvider.afterMoved(e+1,r.boxCount+"_"+r.layout),deferred.resolve(t)},function(){deferred.reject()}),deferred},setPosition:function(e,t){return this.model.setPosition(e,t)},getBoxNumber:function(){return this.model.getBoxNumber()},renderContent:function(e,t){this.contentProvider.renderContent(e,t),this.editMode||updateEditGadgetClass.call(this,!1),updateHighlightClass.call(this),$(e).find("a").attr("data-bypass",!0)},requestContent:function(e){var t=this;this.contentProvider.requestContent().progress(function(e){$(e).find(".img_loader_large").length||t.setGadgetContent(makeGadgetContentLoadingImg())}).done(function(e,n){t.renderContent(e,n)}).fail(function(e){t.raiseError()}).always(function(e){$(e).find(".img_loader_large").remove()})},setGadgetContent:function(e){return this.$el.find(".go-gadget-content").empty().append(e),this},setEditorRunner:function(e){return this.contentProvider.setEditorRunner(e),this},setEditMode:function(e){!e||e.preventDefault(),this.editMode||(this.showConfigPane(),this.editMode=!0,updateEditGadgetClass.call(this,!0))},setNormalMode:function(e){this.hideConfigPane(),this.contentProvider.reloadConfig(),this.editMode=!1,updateEditGadgetClass.call(this,!1)},refreshContent:function(e){this.editMode||this.requestContent()},createGadget:function(){var e=this,t=$.Deferred(),n=this.model;return n.save({options:JSON.stringify(this.contentProvider.getOption())},{success:function(n){updateGadgetContent.call(e),t.resolve(e,n)},error:function(){$.goError(DashboardLang["\uac00\uc82f \uc124\uc815\uc800\uc7a5 \uc624\ub958 \uba54\uc2dc\uc9c0"]),t.reject()}}),t},saveGadget:function(){var self=this,defer=$.Deferred(),gadget=this.model,isNew=gadget.isNew(),actions=gadget.getActions(),contentProvider=this.contentProvider,formData=contentProvider.serializeForm(),validateResult=contentProvider.validateForm(formData);return validateResult===!1?(gadget.isCompanyType()&&GO.session("dashboardAdmin")&&(actions.updatable=formData.editable==="Y",actions.removable=formData.removable==="Y",gadget.set("actions",actions)),gadget.save({options:JSON.stringify(formData)},{success:function(model){with(contentProvider)setGadgetOptions($.parseJSON(model.get("options"))),setTitle();updateGadgetContent.call(self),self.setNormalMode(),defer.resolve(self,model)},error:function(){$.goError(DashboardLang["\uac00\uc82f \uc124\uc815\uc800\uc7a5 \uc624\ub958 \uba54\uc2dc\uc9c0"]),defer.reject()}})):(this.$el.find(".error-msg-wrapper").empty().append(validateResult),defer.reject()),defer},removeGadget:function(e){var t=this;e.preventDefault();if(!this.model.removable())return;this.model.isNew()?this.remove():$.goCaution("'"+this.model.getSpec("name")+"'",DashboardLang["\uac00\uc82f \uc0ad\uc81c \uba54\uc2dc\uc9c0"],function(){t.model.destroy({success:function(){t.remove()},error:function(){$.goError(DashboardLang["\uac00\uc82f \uc0ad\uc81c \uc624\ub958 \uba54\uc2dc\uc9c0"])}})})},showConfigPane:function(){var e=this.$el.find(".go-gadget-config");e.data("initalized")||(this.contentProvider.renderConfig(),e.data("initalized",!0)),this.contentProvider.loadEditor(),e.show()},hideConfigPane:function(){this.model.isNew()?this.$el.remove():this.$el.find(".go-gadget-config").hide()},raiseError:function(){showGadgetErrorContent.call(this,this.$el.find(".go-gadget-content").get(0))},getContentProvider:function(){return this.contentProvider}},{NEW_MARK:GADGET_NEW_MARK,create:function(e){var t=new this.prototype.constructor({model:new GadgetModel(e.data||{}),locale:e.locale||"ko",contextRoot:e.contextRoot||"/",canPersonalize:e.canPersonalize||!1});return!e.appendTo||$(e.appendTo).append(t.el),!e.editorRunner||t.setEditorRunner(e.editorRunner),t}}),GadgetView})})();