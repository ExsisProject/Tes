(function(){define(["jquery","backbone","app","hgn!asset/templates/asset_weekly","hgn!asset/templates/weekly","asset/collections/asset_admin","asset/models/asset_item","asset/collections/asset_weekly","asset/views/rental_reserv_create","i18n!nls/commons","i18n!asset/nls/asset","jquery.ui"],function(e,t,n,r,i,s,o,u,a,f,l){var c=GO.session(),h={asset_detail:l["\uc0c1\uc138\uc815\ubcf4"],asset_detail_view:l["\uc790\uc138\ud788 \ubcf4\uae30"],asset_close:f["\ub2eb\uae30"],code:l["\ucf54\ub4dc"],name:l["\uc774\ub984"],no_reservation:l["\uc9c0\ub09c \uc2dc\uac04\uc740 \uc608\uc57d\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],confirm:f["\ud655\uc778"],cancel:f["\ucde8\uc18c"],reservation:l["\uc608\uc57d"],prev:f["\uc774\uc804"],next:f["\ub2e4\uc74c"]},p=t.View.extend({manage:!1,initialize:function(t){this.options=t||{},this.dragging=!1,this.availableDate={},e("#content").css("padding-bottom","0px")},events:{"click a[data-btntype='infoClose']":"closeInfoLayer","click ul.calendar_tag span.btn_wrap span.ic_classic":"setInfoExpander","click #weekCal table td.past":"alertReservation","click div.schedule_time":"reservationStatus",'click span[data-btntype="moveWeek"]':"moveWeek","click #weekTermDate":"showMiniCal","mouseup #timeWrap":"mouseUp","mouseup div.schedule_time":"mouseUp","mousedown #weekCal table td.future, #weekCal table td.today":"mouseDown"},render:function(){this.assetId=this.options.assetId,this.itemId=this.options.itemId,this.type=this.options.type,this.fromDate=this.options.fromDate;var t=this,n=this.getAssetItemInfo(this.assetId);n.on("reset",function(e,n){var i=r({dataset:e.toJSON(),lang:h});t.$el.html(i),t.setAssetData(),t.initDatePicker()}),e(window).on("resize",this.setWeekBodyHeight)},mouseDown:function(t){var n=this,r=e(t.currentTarget);t.preventDefault(),e(this).css("cursor","s-resize"),this.selectDate=moment(r.attr("data-date")).format("YYYY-MM-DDTHH:mm:ss.SSSZ");var i=t.clientX,s=t.clientY,o=r.width();this.reservationArray=[];var u=e(document.elementFromPoint(i,s));if(!u.hasClass("schedule_wrap"))return;e('td[data-date="'+this.selectDate+'"] div.schedule_time').each(function(){n.reservationArray.push(e(this).position().top)}),e("#timeWrap").css("z-index","10001"),this.selectStartTime=e(document.elementFromPoint(i,s)).attr("data-time"),e("#dragBar").css({top:e(document.elementFromPoint(i,s)).position().top-1,left:r.position().left+1,width:o,display:"",height:"28px"});var a=this.increaseMinute(this.selectStartTime,30);e("#dragBar").attr("data-date",this.selectDate).attr("data-starttime",this.selectStartTime).attr("data-endtime",a),e("#dragBar span").text(this.selectStartTime+" ~ "+a),this.$el.on("mouseover","#timeWrap div.timeline",e.proxy(this.mouseHover,this))},mouseHover:function(t){this.dragging=!0;var n=t.clientX,r=t.clientY,i=parseInt(e("#dragBar").css("top")),s=parseInt(e(document.elementFromPoint(n,r)).position().top),o=(s-i)%30,u=(s-i)/30,a=30;o>0?a*=u+1:a*=u;var f=!0;e.each(this.reservationArray,function(e,t){if(t>i&&t<i+parseInt(a))return f=!1,!1});if(f){e("#dragBar").css({height:a});var l=Math.floor(u+1),c=this.increaseMinute(this.selectStartTime,l*30);c=="00:00"&&(c="23:59"),e("#dragBar").attr("data-endtime",c),e("#dragBar span").text(this.selectStartTime+" ~ "+c)}},_isTurnOnRecurrenceOption:function(){return this.model.attributes.useRecurrence&&this.model.attributes.useLoopRecurrence},mouseUp:function(t){if(!this.dragging)return;var r=this,i=e(t.currentTarget);this.selectEndTime=i.attr("data-time"),e("#timeWrap").css("z-index",""),this.$el.off("mouseover","#timeWrap div.timeline");var s=e("#dragBar"),o=s.attr("data-starttime"),u=s.attr("data-endtime"),f=s.attr("data-date"),c=GO.util.toISO8601(GO.util.toMoment(f+" "+o,"YYYY-MM-DD HH:mm")),p=GO.util.toISO8601(GO.util.toMoment(f+" "+u,"YYYY-MM-DD HH:mm"));if(GO.util.dateDiff(c,p)<0){e("#timeWrap").css("z-index",""),s.hide();return}if(moment(c).isBefore(moment().startOf("day"))){e("#timeWrap").css("z-index",""),s.hide(),e.goSlideMessage(h.no_reservation,"caution");return}var d=[];this._isTurnOnRecurrenceOption()&&d.push({btext:l["\uc608\uc57d\uc0c1\uc138 \ub4f1\ub85d"],btype:"confirm",autoclose:!1,callback:e.proxy(function(){var t=GO.util.toISO8601(GO.util.toMoment(e("#startDate").val())),r=[];r.push("?useAnonym="+e("#useAnonym").is(":checked")),r.push("allDay="+e("#allday").is(":checked")),r.push("userId="+e("#userId").attr("data-userid")),r.push("userName="+e("#userName").text()),r=r.join("&"),n.router.navigate("asset/"+this.assetId+"/item/"+this.itemId+"/create/reservation/"+t+"/"+e("#startTime").val()+"/"+e("#endTime").val()+r,!0)},this)}),d.push({btext:h.confirm,btype:"confirm",autoclose:!1,callback:function(){m.reservCreate(!0).done(e.proxy(function(){var e=GO.util.toISO8601(GO.util.toMoment(f));r.renderWeeklyCal(e),v.close()},this))}}),d.push({btext:h.cancel,btype:"normal"});var v=e.goPopup({header:h.reservation,width:685,top:"40%",pclass:"layer_normal layer_temporary_save",contents:"",modal:!0,buttons:d,closeCallback:function(){r.dragging=!1,r.dragBarHide()}}),m=new a({el:e("#gpopupLayer div.content"),assetId:this.assetId,itemId:this.itemId,type:"reservation",selectDate:f,selectTime:o,endTime:u,status:"create",isPopup:!0});m.render().then(function(){v.reoffset()}),r.dragging=!1},dragBarHide:function(){var t=e("#dragBar");t.hide().css("height","22px").find("span").text("")},showMiniCal:function(){e("#weekCalendarHiddenInput").trigger("focus")},alertReservation:function(){e.goSlideMessage(h.no_reservation,"caution")},moveWeek:function(t){var n=e(t.currentTarget);this.renderWeeklyCal(n.attr("data-date"))},reservationStatus:function(t){t.stopPropagation();var r=e(t.currentTarget);n.router.navigate("asset/"+this.assetId+"/item/"+this.itemId+"/status/reservation/"+r.attr("data-id"),!0)},setInfoExpander:function(t){var n=e(t.currentTarget),r=this.$el.find("div.layer_slide");n.hasClass("ic_open")?(n.removeClass("ic_open").addClass("ic_close").attr("title",f["\ub2eb\uae30"]),r.show()):(n.removeClass("ic_close").addClass("ic_open").attr("title",l["\uc790\uc138\ud788 \ubcf4\uae30"]),r.hide())},closeInfoLayer:function(t){var n=e(t.currentTarget);n.parent().hide(),e("ul.calendar_tag span.ic_classic").removeClass("ic_close").addClass("ic_open").attr("title",l["\uc790\uc138\ud788 \ubcf4\uae30"])},getAssetItemInfo:function(e){var t=s.getCollection({assetId:this.assetId,type:"info"});return t},renderInfoData:function(t){var n=t.get("name");e("#code").text(t.get("code")),e("#name").text(n),e("#itemName").text(n),e.each(t.get("properties"),function(t,n){e('#calendar-tag-base li[data-id="'+n.attributeId+'"]').find("strong").text(n.content)})},setAssetData:function(){this.model=new o,this.model.clear(),this.model.set({assetId:this.assetId,itemId:this.itemId},{silent:!0}),this.model.fetch({async:!1}),this.renderInfoData(this.model),this.renderWeeklyCal(this.fromDate)},renderWeeklyCal:function(t){var n=this,r;t?r=t:r=GO.util.now();var t=GO.util.toISO8601(r),i=u.getCollection({assetId:this.assetId,itemId:this.itemId,fromDate:t});i.on("reset",function(t,r){var i=t.toJSON(),s=n.makeWeeklyTemplete({collection:i});n.$el.find("#weekCal").html(s),n.$("div.week_body_wrap").css("overflow-y","auto");var o=moment(i[0].startDay,"YYYY-MM-DD").clone().startOf("days"),u=moment(i[0].endDay,"YYYY-MM-DD").clone().startOf("days"),a=GO.util.formatDatetime(o,null,"YYYY.MM.DD"),f=GO.util.formatDatetime(u,null,"YYYY.MM.DD"),l=a+" ~ "+f;e("#timeWrap div:last-child").addClass("last"),e("#weekTermDate").text(l),e("#prevWeek").attr("data-date",GO.util.calDate(o,"days",-1)),e("#nextWeek").attr("data-date",GO.util.calDate(u,"days",1)),n.renderReservationData(t.toJSON()),n.setWeekBodyHeight(),n.currentTimeLine()})},currentTimeLine:function(){var t=GO.util.formatDatetime(GO.util.now(),null,"HH:mm").split(":"),n=e('#weekWrap div.time[data-time="'+t[0]+':00"]').position().top+parseInt(t[1]),r='<div id="current-timeline" class="real_time" style="top: '+n+'px; left: 0px"></div>';e("#weekWrap div.time_wrap").append(r)},setWeekBodyHeight:function(){var t=e("#timeWrap div").length*30,n=e(".content_top").outerHeight()+e(".calendar_tool_bar").outerHeight(!0)+e(".tb_week_header").outerHeight();n+=GO.session("theme")==="THEME_CLASSIC"?e(".go_header_advanced").height():0;var r=e(window).height()-n;t<r&&(r=t),e("#weekBodyWrap").css("height",r),e("#weekBody").css("height",r),e("#weekBody div.schedule_wrap").css("height",t),e("#weekBodyWrap").disableSelection()},renderReservationData:function(t){function s(e){var t="";return e?e.useAnonym?t:(e.user&&(t=e.user.name),t):t}var n=this,r=t[0].daily,i=150;GO.session()["theme"]=="THEME_CLASSIC"&&(i=192),_.each(r,function(t,n){t.reservations&&_.each(t.reservations,function(t,n){t.startTime=GO.util.toISO8601(t.startTime),t.endTime=GO.util.toISO8601(t.endTime);var r=GO.util.getDay(GO.util.toISO8601(t.startTime)),o,u=GO.util.formatDatetime(t.startTime,null,"HH:mm"),a=u,f=GO.util.formatDatetime(t.endTime,null,"HH:mm"),l=f,c=0,h=GO.util.formatDatetime(t.startTime,null,"mm");parseInt(h)<30?(u=GO.util.formatDatetime(t.startTime,null,"HH:00"),c=parseInt(h)):parseInt(h)<60&&(u=GO.util.formatDatetime(t.startTime,null,"HH:30"),c=parseInt(h)-30);var p=GO.util.toISO8601(t.startTime);try{var d=e("#weekBody").find('div[data-time="'+u+'"]');if(d.length===0)return;o=d.offset().top-i+c}catch(v){return!0}var m=GO.util.dateDiff(p,GO.util.toISO8601(t.endTime))/1e3/60/30,g=m*30,y="bgcolor_group";t.user.id==GO.session("id")&&(y="bgcolor17");var b="";e.each(t.properties,function(e,n){b+=GO.util.escapeToLtGt(n.content),t.properties.length!=e+1&&(b+=",\n")});var w=a+" ~ "+l+"\n"+s(t)+"\n"+b,E=t.otherCompanyReservation?t.user.companyName+" "||"":"",S=E+w,x='<div class="schedule_time '+y+'" data-id="'+t.id+'" style="z-index:10003;top: '+o+"px; left: 0; width: 100%; height:"+g+'px" title="'+S+'">'+'<p class="head"><span class="time">'+a+" ~ "+l+"</span></p>"+'<p class="content">'+s(t)+"<br/>"+b+"</p>"+'<div class="resize"></div>'+"</div>";e("#weekBody").find('td[data-week="'+r+'"] div.schedule_wrap').append(x);var T=GO.util.formatDatetime(t.startTime,null,"YYYY-MM-DD"),N=GO.util.formatDatetime(t.endTime,null,"YYYY-MM-DD");if(T!=N){r=GO.util.getDay(GO.util.toISO8601(t.endTime));var C=GO.util.toISO8601(GO.util.getMidNightTime(t.endTime)),k=GO.util.formatDatetime(C,null,"HH:mm");try{o=e("#weekBody").find('div[data-time="'+k+'"]').offset().top-i+c}catch(v){return!0}var m=GO.util.dateDiff(C,GO.util.toISO8601(t.endTime))/1e3/60/30,g=m*30,x='<div class="schedule_time '+y+'" data-id="'+t.id+'" style="z-index:10003;top: '+o+"px; left: 0; width: 100%; height:"+g+'px">'+'<p class="head"><span class="time">'+a+" ~ "+l+"</span></p>"+'<p class="content" title="'+s(t)+'">'+s(t)+"</p>"+'<div class="resize"></div>'+"</div>";e("#weekBody").find('td[data-week="'+r+'"] div.schedule_wrap').append(x)}},this)},this)},makeWeeklyTemplete:function(t){var n=t.collection,r=n[0].availabilityDate,s=r.ableDays.split(""),o=r.startTime.substr(0,2)+":"+r.startTime.substr(2,2),u=r.endTime.substr(0,2)+":"+r.endTime.substr(2,2);u=="24:00"&&(u="23:59");var a=GO.util.toISO8601(GO.util.formatDatetime(GO.util.now(),null,"YYYY-MM-DD "+o,"YYYY-MM-DD HH:mm")),f=GO.util.toISO8601(GO.util.formatDatetime(GO.util.now(),null,"YYYY-MM-DD "+u,"YYYY-MM-DD HH:mm"));this.availableDate={startTimeCon:o,endTimeCon:u};var l=[],c=function(){var e=a;for(var t=0;t<48;t++){var n=GO.util.toMoment(e),r=30;n.hour()==23&&n.minute()==30&&(r=29),l.push('<div class="timeline" data-time="'+GO.util.formatDatetime(e,null,"HH:mm")+'" data-endtime="'+GO.util.formatDatetime(GO.util.calDate(e,"minutes",r),null,"HH:mm")+'"></div>'),e=GO.util.calDate(e,"minutes",30);if(GO.util.dateDiff(e,f)<=0)break}return l.join("")},p=[],d=function(){var e=a;for(var t=0;t<24;t++){p.push('<div class="time" data-time="'+GO.util.formatDatetime(e,null,"HH:mm")+'">'+GO.util.formatDatetime(e,null,"HH")+"</div>"),e=GO.util.calDate(e,"hours",1);if(GO.util.dateDiff(e,f)<=0)break}return p.join("")},v=function(){var t=0;return e.each(s,function(e,n){n=="1"&&t++}),t},m=function(){return GO.util.formatDatetime(GO.util.toMoment(this.day),null,"MM.DD(ddd)")},g=function(){return GO.util.getDay(GO.util.toISO8601(this.day))},y=function(){var e=GO.util.isBeforeToday(this.day),t="future";return GO.util.isBeforeToday(this.day)?t="past":GO.util.isToday(this.day)&&(t="today"),t},b=function(){var t=[];return e.each(this.daily,function(e,n){s[e]=="1"&&(n.day=moment(n.day,"YYYY-MM-DD").clone().startOf("days"),t.push(n))}),t},w=i({dataset:n,parseWeek:m,parseWeekDay:g,dateMask:y,selectDaily:b,weekColCnt:v,parseTimeLine:c,parseTimeTh:d,lang:h});return w},increaseMinute:function(e,t){var n=GO.util.toMoment(this.selectDate+" "+e,"YYYY-MM-DD HH:mm"),r=GO.util.formatDatetime(GO.util.calDate(n,"minutes",t),null,"HH:mm");return r},initDatePicker:function(){var t=this,n=e("#weekCalendarHiddenInput");e.datepicker.setDefaults(e.datepicker.regional[GO.config("locale")]),n.datepicker({defaultDate:"+1w",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){t.renderWeeklyCal(e)}})},moveCompanyBoardTab:function(t){var n=e(t.currentTarget),r=n.attr("data-type");if(n.hasClass("active"))return;n.siblings("li").removeClass("active"),n.addClass("active"),r=="assetGuidance"?adminGuidance.render({assetId:this.assetId}):r=="assetInfo"?adminInfo.render({assetId:this.assetId}):r=="assetManage"?adminManage.render({assetId:this.assetId}):adminPurpose.render({assetId:this.assetId})}});return p})}).call(this);