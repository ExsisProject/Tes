(function(){define(["jquery","backbone","app","when","hgn!asset/templates/side","hgn!asset/templates/side_share_item","i18n!nls/commons","i18n!asset/nls/asset","asset/collections/side","asset/collections/asset_item_list","asset/models/asset_item","amplify","asset/components/asset_tree/asset_tree"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p={confirm:o["\ud655\uc778"],cancel:o["\ucde8\uc18c"],collapse:o["\uc811\uae30"],expand:o["\ud3bc\uce58\uae30"],asset_company:u["\uc804\uc0ac\uc790\uc0b0"],asset_title:o["\uc608\uc57d\ub300\uc5ec"],rental:u["\ub300\uc5ec"]},d=GO.session("loginId")+"-asset-toggle",v=h.AssetTreeMenuView,m=t.View.extend({el:"#side",assetTreeViews:null,unBindEvent:function(){this.$el.off("click","section.lnb span.ic_side[data-slide]"),this.$el.off("click","section.lnb a.txt"),this.$el.off("changeAssetItem")},bindEvent:function(){this.$el.on("click","section.lnb span.ic_side[data-slide]",e.proxy(this.slideToggle,this)),this.$el.on("click","section.lnb a.txt",e.proxy(this.slideToggle,this)),this.$el.on("changeAssetItem",e.proxy(this.loadAssetMenu,this))},initialize:function(){this.assetTreeViews=[],this.loadAssetMenu()},loadAssetMenu:function(){var e=a.getCollection();e.on("reset",_.bind(function(e){var t=0,n=i({contextRoot:GO.contextRoot,dataset:e.toJSON(),lang:p,companyId:GO.session("companyId"),isOpen:this.getStoredCategoryIsOpen(GO.session("companyId")+"-"+d),appName:GO.util.getAppName("asset")});this.$el.html(n);var r=this.$el.find("#assetSide"),s=r.find("ul"),o=[],u=e.toJSON(),a=this._getAssetNodes(u);a.length>0&&(this.assetTreeViews[t]=this._renderMenuTree(a),o.push(this.assetTreeViews[t].el)),s.append.apply(s,o);var f=GO.util.store.get("asset.unfold.list")||[];for(var l=0;l<f.length;l++){var c=f[l];this._openDefaultAsset(t,c,a)}this.loadAssetShareMenu()},this))},loadAssetShareMenu:function(){var e=a.getShareCollection();e.each(function(e,t){var n=a.createCollectionByList(e.get("assets")),r=t+1;this.$el.append(s({idx:t,contextRoot:GO.contextRoot,companyName:e.get("companyName"),lang:p,companyId:e.get("companyId"),isOpen:this.getStoredCategoryIsOpen(e.get("companyId")+"-"+d)}));var i=this.$el.find("#assetShareSide_"+t),o=i.find("ul"),u=[],f=n.toJSON(),l=this._getAssetNodes(f);l.length>0&&(this.assetTreeViews[r]=this._renderMenuTree(l),u.push(this.assetTreeViews[r].el)),o.append.apply(o,u);var c=GO.util.store.get("asset.unfold.list")||[];for(var h=0;h<c.length;h++){var v=c[h];this._openDefaultAsset(r,v,l)}},this)},isRentalItemType:function(){var e=n.router.getUrl().split("/");return e.length==6&&_.last(e)=="rental"?!0:!1},selectSideMenu:function(){var e=null,t=n.router.getUrl().split("/");this.$el.find(".on").removeClass("on"),this.isRentalItemType()||isNaN(t[3])?e=this.$el.find('ul.side_depth li a[data-id="'+t[1]+'"][data-parent=""]'):e=this.$el.find('ul.side_depth li a[data-id="'+t[3]+'"][data-parent="'+t[1]+'"]'),e.length&&e.parents("p:eq(0)").addClass("on")},render:function(e){this.unBindEvent(),this.bindEvent(),this.selectSideMenu()},_renderMenuTree:function(e){var t=this,r=new v({nodes:e,parentId:""});return r.$el.on("toggle",_.bind(function(e,n,r,i){var s=GO.util.store.get("asset.unfold.list")||[];if(r){var o=[];o.push(i),s=_.union(s,o),t._loadAssetItems(n,r,i)}else s=s.filter(function(e){return i!=e});GO.util.store.set("asset.unfold.list",s)},!0)),r.$el.on("itemClicked",_.bind(function(e,t,r,i){var s=t.attr("data-type")=="true";s?n.router.navigate("asset/"+i+"/list/rental",{trigger:!0,pushState:!0}):_.isEmpty(r)?n.router.navigate("asset/"+i+"/list/reservation",{trigger:!0,pushState:!0}):n.router.navigate("asset/"+r+"/item/"+i+"/weekly/reserve/"+GO.util.toISO8601(new Date),{trigger:!0,pushState:!0})},this)),r.$el.on("configClicked",function(e,t){var r="default";n.router.navigate("asset/"+t+"/admin/"+r,{trigger:!0,pushState:!0})}),r.render(),r},_loadAssetItems:function(e,t,n){var r=f.init();r.on("sync",_.bind(function(){var t=r.getItems(),i=this._getChildAssetItemNodes(t),s=[];if(i.length>0){var o=new v({nodes:i,parentId:n});o.render(),s.push(o.el)}e.append.apply(e,s),this.selectSideMenu()},this),this),r.setAssetId(n),r.fetch({data:{page:"0",offset:"100"}})},_getAssetNodes:function(e){var t=_.map(e,function(e){return{parentId:"",id:e.id,nodeValue:e.name,isFolderNode:e.hasItems,hasChildren:e.useRental==1?!1:e.hasItems,managable:e.managable,useRental:e.useRental,isCompanyShared:!!e.isCompanyShared}});return t},_getChildAssetItemNodes:function(e){var t=_.map(e,function(e){return{parentId:e.assetId.toString(),id:e.key,nodeValue:e.label,isFolderNode:!1,hasChildren:!1,managable:!1,useRental:e.useRental}});return t},slideToggle:function(t){var n=e(t.currentTarget),r=n.parents("h1"),i=r.find(".ic_side"),s=this;r.next("ul").slideToggle("fast",function(){e(this).css("display")=="block"?(r.removeClass("folded"),i.attr("title",p.collapse)):(r.addClass("folded"),i.attr("title",p.expand));var t=!r.hasClass("folded"),n=r.data("id");s.storeCategoryIsOpen(n+"-"+d,t)})},getStoredCategoryIsOpen:function(e){var t="";return window.sessionStorage?t=c.store.sessionStorage(e):t=c.store(e),t==undefined&&(t=!0),t},storeCategoryIsOpen:function(e,t){return c.store(e,t,{type:window.sessionStorage?"sessionStorage":null})},_openDefaultAsset:function(e,t,n){if(t<0)return;var r=-1;for(var i=0;i<n.length;i++){var s=n[i];s.id==t&&(r=i)}this.assetTreeViews[e]&&this.assetTreeViews[e].open(r)}});return m})}).call(this);