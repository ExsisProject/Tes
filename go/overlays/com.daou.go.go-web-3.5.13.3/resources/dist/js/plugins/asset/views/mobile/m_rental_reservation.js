(function(){define(["jquery","underscore","backbone","when","app","i18n!nls/commons","i18n!asset/nls/asset","hgn!asset/templates/mobile/m_rental_reservation","views/mobile/header_toolbar","calendar/helpers/datepicker","asset/collections/asset_admin","asset/models/asset_user_create","asset/models/asset_manage","asset/models/asset_admin","jquery.ui","jquery.go-sdk"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){var d={rent_date:o["\ub300\uc5ec\uc77c"],rent_user:o["\ub300\uc5ec\uc790"],reservation_date:o["\uc608\uc57d\uc77c"],reservation_user:o["\uc608\uc57d\uc790"],rent_change:o["\ubcc0\uacbd"],return_list:o["\ubaa9\ub85d\uc73c\ub85c \ub3cc\uc544\uac00\uae30"],reservation_cancel:o["\uc608\uc57d \ucde8\uc18c\ud558\uae30"],asset_return:o["\ubc18\ub0a9\ud558\uae30"],confirm:s["\ud655\uc778"],cancel:s["\ucde8\uc18c"],modify:s["\uc218\uc815\uc644\ub8cc"],no_reservation:o["\uc9c0\ub09c \uc2dc\uac04\uc740 \uc608\uc57d\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],alert_no_reservation:o["\uc608\uc57d\ud558\ub824\ub294 \uc2dc\uac04\ub300\uc5d0 \uc774\ubbf8 \uc608\uc57d\ub41c \uac74\uc774 \ud3ec\ud568\ub418\uc5b4\uc788\uc2b5\ub2c8\ub2e4."],alert_input:o["\ud544\uc218\ub4f1\ub85d\uc815\ubcf4\ub97c \uc785\ub825\ud558\uc138\uc694."],start:o["\uc2dc\uc791"],end:o["\uc885\ub8cc"],write_alert:o["\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694."],time_alert:o["\uc608\uc57d\ud560 \uc218 \uc5c6\ub294 \uc2dc\uac04\uc785\ub2c8\ub2e4."],day_alert:o["\uc608\uc57d\ud560 \uc218 \uc5c6\ub294 \uc694\uc77c\uc785\ub2c8\ub2e4."],allday:o["\uc885\uc77c"],reserve_anonym:o["\uc775\uba85\uc608\uc57d"],use_anonym:s["\uc0ac\uc6a9"]},v=n.View.extend({initialize:function(e){var t=e||{};this.assetId=t.assetId,this.itemId=t.itemId,this.type=t.type,this.status=t.status,this.reservationId=t.reservationId,this.selectDate=t.selectDate,this.startTime=t.startTime,this.endTime=t.endTime,this.assetModel=new p,this.assetCreateModel=new c,this.assetManagableModel=new h,this.isManagable=!1,this.reqType=t.reqType,this.isCreate=this.type=="create",this.headerToolbarView=a,this.param=t.queryString||"empty",i.EventEmitter.off("trigger-action"),i.EventEmitter.on("trigger-action","asset-save",this.save,this),i.EventEmitter.on("trigger-action","asset-modify",this.modify,this),i.EventEmitter.on("trigger-action","asset-cancel",this.cancel,this)},events:{"change #startDate":"disableSelectTime","change #endDate":"disableSelectTime","change #startTime":"disableSelectTime","change #endTime":"disableSelectTime","keyup textarea":"_expandTextarea","change #allday":"toggleCheck"},render:function(){var n=this;return r.promise(t.bind(function(r,i){this._loadAssetModel().then(t.bind(this._loadManagableModel,this)).then(t.bind(this._loadAssetCreateModel,this)).then(t.bind(function(){this.renderTitleToolBar(),e("#btnHeaderSearch").show().attr("data-assetid",this.assetId);var i=l.getCollection({assetId:this.assetId,type:"reservation"});i.on("reset",t.bind(function(e){var t=n.makeTemplete({collection:e.toJSON(),type:n.type,status:n.status,isCreate:n.type=="create"});n.$el.html(t),n.setData(),n.type=="reservation"&&n.disableSelectTime(),r()},this))},this)).otherwise(i)},this))},_loadAssetModel:function(){return r.promise(t.bind(function(e,t){this.assetModel.clear(),this.assetModel.set({assetId:this.assetId},{silent:!0}),this.assetModel.fetch({success:e,error:t})},this))},_loadManagableModel:function(){return r.promise(t.bind(function(e,n){this.assetManagableModel.clear(),this.assetManagableModel.set({assetId:this.assetId},{silent:!0}),this.assetManagableModel.fetch({success:t.bind(function(t){this.isManagable=t.get("managable"),e(t)},this),error:n})},this))},_loadAssetCreateModel:function(){return r.promise(t.bind(function(e,t){var n={assetId:this.assetId,itemId:this.itemId};this.assetCreateModel.clear(),this.status=="create"?n.type="title":this.reservationId?(n.type="reservationStatus",n.reservationId=this.reservationId):n.type="current",this.assetCreateModel.set(n,{silent:!0}),this.assetCreateModel.fetch({success:e,error:t})},this))},renderTitleToolBar:function(){var e=this,t={title:this.assetCreateModel.attributes.itemName,isClose:!0};this.hasToolBarAuth()&&(t.actionMenu=[{id:"asset-modify",text:s["\ud655\uc778"],triggerFunc:"asset-modify"},{id:"asset-cancel",text:s["\ucde8\uc18c"],triggerFunc:"asset-cancel"}]),this.status==="create"&&(t={isClose:!0,title:this.assetCreateModel.get("name"),actionMenu:[{id:"contactSave",text:s["\ud655\uc778"],triggerFunc:"asset-save"}]}),this.headerToolbarView.render(t)},hasToolBarAuth:function(){return!this.assetCreateModel.has("reservationId")||this.assetCreateModel.get("user").id===i.session("id")||!!this.isManagable},modify:function(e){this._isRecurrence()?this.reservationUpdateAction():this.reservCreate(e)},save:function(){this.preventSameAction(),this.reservCreate()},preventSameAction:function(){e("a[data-trigger=asset-save]").on("vclick",!1)},cancel:function(){this.type=="rental"?confirm(o["\uc774\uc6a9\uc744 \ubc18\ub0a9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])&&this.rentalCancelAction():confirm(o["\uc608\uc57d\uc744 \ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"])&&this.reservationDeleteAction()},_expandTextarea:function(e){i.util.textAreaExpand(e)},setStartTime:function(){var t=e('#startTime option[value="'+e("#startTime").val()+'"]').attr("disabled");if(t=="disabled"){var n=this.assetModel.get("availabilityDate").startTime.substr(0,2)+":"+this.assetModel.get("availabilityDate").startTime.substr(2,2),r=i.util.formatDatetime(i.util.calDate(e("#startDate").val()+"T"+n,"hours",1),null,"HH:mm");e("#startTime").val(n),e("#startTime").attr("data-prev",n),e("#endTime").val(r),e("#endTime").attr("data-prev",r),e("#startTime").trigger("change")}},disableSelectTime:function(){var t=this;this.ableDays=this.assetModel.get("availabilityDate").ableDays.split("");var n=this.assetModel.get("availabilityDate").startTime.substr(0,2)+":"+this.assetModel.get("availabilityDate").startTime.substr(2,2),r=this.assetModel.get("availabilityDate").endTime.substr(0,2)+":"+this.assetModel.get("availabilityDate").endTime.substr(2,2),s=i.util.formatDatetime(i.util.now(),null,"YYYY-MM-DD");this.disableTimeArray=[];for(var o=0;o<48;o++){if(i.util.formatDatetime(s,null,"HH:mm")==n)break;this.disableTimeArray.push(i.util.formatDatetime(s,null,"HH:mm")),s=i.util.calDate(s,"minutes",30)}var u=i.util.formatDatetime(i.util.now(),null,"YYYY-MM-DD");this.disableTimeArray2=[];for(var a=0;a<48;a++){u=i.util.calDate(u,"minutes",-30);if(i.util.formatDatetime(u,null,"HH:mm")==r||r=="24:00")break;this.disableTimeArray2.push(i.util.formatDatetime(u,null,"HH:mm"))}setTimeout(function(){e.each(t.disableTimeArray,function(t,n){e('#startTime option[value="'+n+'"]').attr("disabled",!0)}),e.each(t.disableTimeArray2,function(t,n){e('#startTime option[value="'+n+'"]').attr("disabled",!0)}),e.each(t.disableTimeArray,function(t,n){e('#endTime option[value="'+n+'"]').attr("disabled",!0)}),e.each(t.disableTimeArray2,function(t,n){e('#endTime option[value="'+n+'"]').attr("disabled",!0)}),t.setStartTime()},500)},setData:function(){var e=function(){};this.status=="create"?e=this._setDataForCreate:e=this._setDataForModify,e.call(this)},_setDataForCreate:function(){e("#userName").text(i.session("name")+" "+i.session("position")),e("#userId").attr("data-userid",i.session("id")),e("#titleToolbar h2").text(this.assetCreateModel.get("name"));if(this.type=="rental")e("#date").text(i.util.basicDate3(new Date));else if(this.startTime){var t=i.util.formatDatetime(this.startTime,null,"YYYY-MM-DD"),n=i.util.formatDatetime(this.endTime,null,"YYYY-MM-DD"),r=i.util.formatDatetime(this.startTime,null,"HH:mm"),s=i.util.formatDatetime(this.endTime,null,"HH:mm");e("#startDate").val(t).attr("disabled","disabled"),e("#endDate").val(n).attr("disabled","disabled"),e("#startTime").html('<option value="'+r+'">'+r+"</option>").attr("disabled","disabled"),e("#endTime").html('<option value="'+s+'">'+s+"</option>").attr("disabled","disabled");var o=i.util.store.get(this.param);o.allday&&(e("#allday").attr("checked","checked"),e("#startTime").hide(),e("#endTime").hide())}else this.datepickerHelper=new f(this.$el.find("#startDate"),this.$el.find("select[name=start_time]"),this.$el.find("#endDate"),this.$el.find("select[name=end_time]"),"detail"),this.datepickerHelper.updateSelectedTime(new Date),e("#startDate").val(this.selectDate),e("#endDate").val(this.selectDate),e("#startDate").attr("data-prev",this.selectDate),e("#endDate").attr("data-prev",this.selectDate)},_setDataForModify:function(){e("#userName").text(this.assetCreateModel.get("user").name+" "+this.assetCreateModel.get("user").positionName),e("#titleToolbar h2").text(this.assetCreateModel.get("itemName")),e.each(this.assetCreateModel.get("properties"),function(t,n){e('tr[data-id="'+n.attributeId+'"]').find("textarea").text(n.content)}),this._isEditable()||(e("#titleToolbar div.optional").hide(),e("#tool_bar").hide());if(this.type=="rental")e("#date").text(i.util.basicDate3(this.assetCreateModel.get("createdAt")));else{var t=i.util.formatDatetime(this.assetCreateModel.get("groupStartTime")!=undefined?this.assetCreateModel.get("groupStartTime"):this.assetCreateModel.get("startTime"),null,"YYYY-MM-DD"),n=i.util.formatDatetime(this.assetCreateModel.get("groupEndTime")!=undefined?this.assetCreateModel.get("groupEndTime"):this.assetCreateModel.get("endTime"),null,"YYYY-MM-DD"),r=i.util.formatDatetime(this.assetCreateModel.get("groupStartTime")!=undefined?this.assetCreateModel.get("groupStartTime"):this.assetCreateModel.get("startTime"),null,"HH:mm"),s=i.util.formatDatetime(this.assetCreateModel.get("groupEndTime")!=undefined?this.assetCreateModel.get("groupEndTime"):this.assetCreateModel.get("endTime"),null,"HH:mm");this.datepickerHelper=new f(this.$el.find("#startDate"),this.$el.find("select[name=start_time]"),this.$el.find("#endDate"),this.$el.find("select[name=end_time]"),"detail");var o=this.isCreate?new Date:i.util.toMoment(this.assetCreateModel.get("startTime"));e("#startDate").val(t),e("#startTime").val(r),e("#endDate").val(n),e("#endTime").val(s),e("#startDate").attr("data-prev",t),e("#endDate").attr("data-prev",n),this.dateForBack=t,this.assetCreateModel.get("allday")&&(e("#allday").attr("checked","checked"),e("#startTime").hide(),e("#endTime").hide())}},getStartTime:function(e){if(e)return new Date;if(!t.isUndefined(this.assetCreateModel.get("groupStartTime")))return this.assetCreateModel.get("groupStartTime");if(!t.isUndefined(this.assetCreateModel.get("startTime")))return this.assetCreateModel.get("startTime")},getEndTime:function(e){if(e)return new Date;if(!t.isUndefined(this.assetCreateModel.get("groupEndTime")))return this.assetCreateModel.get("groupEndTime");if(!t.isUndefined(this.assetCreateModel.get("endTime")))return this.assetCreateModel.get("endTime")},makeTemplete:function(e){var t=e.status=="create"?!0:!1,n=this.getStartTime(t),r=this.getEndTime(t),s=i.util.toMoment(n),a=i.util.toMoment(r),f=s.format("YYYY-MM-DD"),l=s.format("HH:mm"),c=a.format("YYYY-MM-DD"),h=a.format("HH:mm"),p=!!this.isManagable,v=this._isEditable(),m=!!this.assetModel.get("allowAnonym"),g=!!this.assetModel.get("alwaysAnonym"),y=!!this.assetCreateModel.get("useAnonym"),b=this.assetCreateModel.get("recurrence"),w=!0,E=!1;this.status=="create"?(y=m&&g,E=m):(m=m&&v,w=v||!y,E=v&&m,y=m&&y);var S=function(){return i.i18n(o["\uc744 \uc791\uc131\ud574 \uc8fc\uc138\uc694."],{arg1:this.name})};this.dateForBack=f;var x=u({dataset:e.collection,lang:d,isCreate:t,isRental:e.type=="rental"?!0:!1,hasToolbarAuth:!this.assetCreateModel.has("reservationId")||this.assetCreateModel.get("user").id===i.session("id")||p,prevStartDate:f,prevStartTime:l,prevEndDate:c,prevEndTime:h,attributeInfo:S,useAnonym:y,isManagable:p,isEditable:v,isAllowAnonym:m,isAlwaysAnonym:g,isShowUserRow:w,isShowAnonymRow:E,isRecurrence:b});return x},_isEditable:function(){var e=!1;return this.status==="create"?!0:(this.assetCreateModel&&this.assetCreateModel.get("user")&&(e=this.assetCreateModel.get("user").id==i.session("id")||this.isManagable),e)},returnList:function(){if(this.type=="reservation"){var t=e("#titleToolbar h2").text(),n=this.dateForBack;i.router.navigate("asset/monthly/"+this.assetId+"/"+this.itemId+"/"+t+"/"+n,!0)}else i.router.navigate("asset/"+this.assetId+"/list/"+this.type,!0)},getData:function(){var t={};if(this.type=="reservation"){var n=e("#startTime").val(),r=e("#endTime").val();if(e("#allday").is(":checked")){var s=this.assetModel.attributes.availabilityDate.startTime,o=this.assetModel.attributes.availabilityDate.endTime;o=="2400"&&(o="2359");var u=s.substring(0,2)+":"+s.substring(2,4),a=o.substring(0,2)+":"+o.substring(2,4);e("#startTime").find("option[value='"+u+"']").size()>0?e("#startTime").val(u):e("#startTime").append('<option value="'+u+'">'+u+"</option>").val(u),e("#endTime").find("option[value='"+a+"']").size()>0?e("#endTime").val(a):e("#endTime").append('<option value="'+a+'">'+a+"</option>").val(a)}var f=e("#startTime").val(),l=e("#endTime").val();if(!f||!l)return t.alertMessage=d.time_alert,t;var s=i.util.toISO8601(i.util.toMoment(e("#startDate").val()+" "+f,"YYYY-MM-DD HH:mm")),o=i.util.toISO8601(i.util.toMoment(e("#endDate").val()+" "+l,"YYYY-MM-DD HH:mm"));t.startTime=s,t.endTime=o,t.allday=e("#allday").is(":checked");if(moment(s).isBefore(moment().startOf("day")))return e("#startTime").val(n),e("#endTime").val(r),t.alertMessage=d.no_reservation,t}t.useAnonym=e("#useAnonym").is(":checked");var c=[],h=e('tr[data-type="attribute"]');return h.each(function(){var t={};t.attributeId=e(this).attr("data-id"),t.content=e(this).find("textarea").val(),c.push(t)}),t.properties=c,t},reservationUpdateAction:function(){var t=this,n=i.contextRoot+"api/asset/item/loop/reservation?"+e.param({reservationId:this.assetCreateModel.attributes.reservationId,recurChange:"instance"});e.ajax(n,{type:"PUT",data:JSON.stringify(t.getData()),dataType:"json",contentType:"application/json",success:function(){i.router.navigate("asset/"+t.assetCreateModel.attributes.assetId+"/list/reservation",!0)},error:function(){e.goError(o["\uc608\uc57d\ud558\ub824\ub294 \uc2dc\uac04\ub300\uc5d0 \uc774\ubbf8 \uc608\uc57d\ub41c \uac74\uc774 \ud3ec\ud568\ub418\uc5b4\uc788\uc2b5\ub2c8\ub2e4."])}})},reservCreate:function(){function s(e){return alert(e),o(),!1}function o(){e("a[data-trigger=asset-save]").off("vclick",!1)}var t=this,n=this.getData(),r=n.properties;if(this.type=="reservation"){var u=!1;if(this.ableDays[i.util.toMoment(e("#startDate").val()).day()]==0)return i.EventEmitter.trigger("common","layout:scrollToTop",this),s(d.day_alert);e.each(this.disableTimeArray,function(t,n){e("#startTime").val()==n&&(u=!0)}),e.each(this.disableTimeArray2,function(t,n){e("#endTime").val()==n&&(u=!0)})}if(n.alertMessage)return i.EventEmitter.trigger("common","layout:scrollToTop",this),s(n.alertMessage);var a=!1;e.each(this.$('tr[data-type="attribute"]'),function(t){if(e.trim(e(this).find("textarea").val())=="")return a=!0,!1});if(a)return s(d.alert_input);if(this.reservationId)e.ajax({url:i.contextRoot+"api/asset/"+this.assetCreateModel.get("assetId")+"/item/"+this.assetCreateModel.get("itemId")+"/reserve/"+this.assetCreateModel.id,data:JSON.stringify(n),type:"PUT",dataType:"json",contentType:"application/json;",success:function(){i.router.navigate("asset",!0)},error:function(){o(),console.log("error")}});else{var f=new c({assetId:this.assetId,reservationId:"",itemId:this.itemId,type:"reserve"});if(this.reqType=="c")if(i.util.toISO8601(t.startTime)){var l=i.util.store.get(this.param),h=e("#startTime").val(),p=e("#endTime").val(),v=h.substring(0,2)+":"+h.substring(2,4),m=p.substring(0,2)+":"+p.substring(2,4);l.asset.push({assetId:t.assetId,assetName:e("#appTitle").text(),reservationId:"",itemId:t.itemId,assetStartTime:v,assetEndTime:m,properties:r}),l.allday=e("#allday").is(":checked"),i.util.store.set(this.param,l);var g=["calendar","asset","write",i.util.toISO8601(t.startTime),i.util.toISO8601(t.endTime),this.param];i.router.navigate(g.join("/"),!0)}else t.returnList();else f.save(n,{success:function(n,r){if(t.startTime){var s=i.util.store.get(this.param);s.asset.push({assetId:t.assetId,assetName:e("#titleToolbar h2").text(),reservationId:"",itemId:t.itemId}),i.util.store.set(this.param,s);var o=["calendar","asset","write",i.util.toISO8601(t.startTime),i.util.toISO8601(t.endTime),this.param];i.router.navigate(o.join("/"),!0)}else t.returnList()},error:function(e,t){o(),alert(d.alert_no_reservation)}})}},rentalCancelAction:function(){var e=this,t={};t.id=this.assetId;var n=new c({assetId:this.assetId,itemId:this.itemId,type:"return"});n.save(t,{success:function(t,n){e.returnList()}})},updateItem:function(){var e=this,t=this.getData();t.id=this.assetId;var n=new c({assetId:this.assetId,itemId:this.itemId});n.save(t,{success:function(t,n){i.router.navigate("asset/"+e.assetId+"/admin/manage",!0)}})},reservationDeleteAction:function(){var t=this;if(this._isRecurrence()){var n=i.contextRoot+"api/asset/item/loop/reservation?"+e.param({reservationId:this.assetCreateModel.attributes.reservationId,recurChange:e(this.popupEl).find("input[name=remove_option]:checked").val()});e.ajax(n,{type:"DELETE",success:function(){i.router.navigate("asset/"+t.assetCreateModel.attributes.assetId+"/list/reservation",!0)}})}var n=i.contextRoot+"api/asset/item/reservation",r=[];r.push(this.reservationId),e.ajax(n,{type:"DELETE",dataType:"json",contentType:"application/json",data:JSON.stringify({ids:r}),success:function(){t.returnList()}})},_isRecurrence:function(){var e=this.assetCreateModel.get("exclude"),n=this.assetCreateModel.get("recurrence");return!t.isEmpty(n)&&!e},toggleCheck:function(t){e(t.currentTarget).is(":checked")?(e("#startTime").hide(),e("#endTime").hide()):(e("#startTime").show(),e("#endTime").show()),t.stopImmediatePropagation()}});return v})}).call(this);