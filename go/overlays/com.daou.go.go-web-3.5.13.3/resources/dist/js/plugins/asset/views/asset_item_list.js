define(["jquery","backbone","app","hgn!asset/templates/asset_item_list","asset/collections/asset_admin","asset/models/asset_guide","hgn!asset/templates/asset_attach_file","i18n!nls/commons","i18n!asset/nls/asset","asset/models/asset_manage","asset/views/rental_reserv_create","asset/views/asset_timeline","jquery.go-grid","jquery.go-validation","smarteditor"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h={open:u["\uc5f4\uae30"],close:u["\ub2eb\uae30"],code:a["\ucf54\ub4dc"],name:a["\ud56d\ubaa9"],reservation:a["\uc608\uc57d"],setting:a["\uc124\uc815"],all:a["\uc804\uccb4"],rent:a["\ub300\uc5ec\uac00\ub2a5"],no_rent:a["\ub300\uc5ec\ubd88\uac00"],"return":a["\ubc18\ub0a9"],search:u["\uac80\uc0c9"],rental:a["\ub300\uc5ec"],asset_return:a["\ubc18\ub0a9"],no_asset:a["\uc774\uc6a9\uac00\ub2a5\ud55c \uc790\uc0b0\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],alert_keyword:u["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."],confirm:u["\ud655\uc778"],cancel:u["\ucde8\uc18c"],preview:u["\ubbf8\ub9ac\ubcf4\uae30"],download:u["\ub2e4\uc6b4\ub85c\ub4dc"]},p=t.View.extend({initialize:function(e){this.guidemodel=new s,this.isManagable=new f,this.assetId=e.assetId,this.type=e.type},events:{"click span.btn_search2":"search","click div.content_info_wrap span.btn_wrap span.ic_classic":"setTitleExpander","click a[data-btntype='settingItem']":"settingItem","click a[data-btntype='reservation']":"weeklyReserv","click a[data-btntype='rentable']":"rentable","click a[data-btntype='norentable']":"returnItem","click a[data-btntype='return']":"returnItem","click #fileWrap li span.name":"fileDownload","click li a.preview":"preview","keydown div.search_wrap input":"searchKeyboardEvent","change #rentalSelect":"rentalSelect"},render:function(){var t=this;this.attributesLen=0,this.codeVisible=!1,this.isManagable.clear(),this.isManagable.set({assetId:this.assetId},{silent:!0}),this.isManagable.fetch({async:!1}),this.isManagable=this.isManagable.get("managable");var n=i.getCollection({assetId:this.assetId,type:"info"});n.on("reset",function(n,r){t.codeVisible=n.models[0].get("useCodeVisibility"),e.each(n.models[0].get("attributes"),function(e,n){n.visibility&&t.attributesLen++});var i=t.makeTemplete({collection:n.toJSON()});t.$el.html(i),t.renderDataTables(),t.renderGuide(),t._isReservationType()&&t._renderMatrix()})},preview:function(t){var n=e(t.currentTarget);return GO.util.preview(n.attr("data-id")),!1},rentable:function(t){var n=this,r=e(t.currentTarget),i=e.goPopup({header:h.rental,width:515,top:"40%",pclass:"layer_normal layer_temporary_save",contents:"",modal:!0,buttons:[{btext:h.confirm,btype:"confirm",autoclose:!1,callback:function(){var e=s.reservCreate();if(!e)return;setTimeout(function(){n.dataTable.tables.fnSettings().sAjaxSource=GO.contextRoot+"api/asset/"+n.assetId+"/item/rental/ALL",n.dataTable.tables.fnClearTable()},100),i.close()}},{btext:h.cancel,btype:"normal"}]}),s=new l({el:e("#gpopupLayer div.content"),assetId:this.assetId,itemId:r.attr("data-id"),type:"rental",status:"create"});s.render()},returnItem:function(t){var r=e(t.currentTarget);n.router.navigate("asset/"+this.assetId+"/item/"+r.attr("data-id")+"/status/rental",!0)},weeklyReserv:function(t){var r=e(t.currentTarget);n.router.navigate("asset/"+this.assetId+"/item/"+r.attr("data-id")+"/weekly/reserve/"+GO.util.toISO8601(GO.util.now()),!0)},settingItem:function(t){var r=e(t.currentTarget);n.router.navigate("asset/"+this.assetId+"/modify/"+r.attr("data-id"),!0)},setTitleExpander:function(t){var n=e(t.currentTarget),r=this.$el.find("ul.detail_info"),i=this.$el.find("ul.simple_info");n.hasClass("ic_open")?(n.removeClass("ic_open").addClass("ic_close").attr("title",u["\ub2eb\uae30"]),r.show(),i.css("height","100%")):(n.removeClass("ic_close").addClass("ic_open").attr("title",a["\uc790\uc138\ud788 \ubcf4\uae30"]),r.hide(),i.css("height","20px"))},fileDownload:function(t){var n=e(t.currentTarget).parents("li").first().attr("data-id");location.href=GO.contextRoot+"api/asset/"+this.assetId+"/attach/"+n},renderGuide:function(){this.guidemodel.clear(),this.guidemodel.set({assetId:this.assetId},{silent:!0}),this.guidemodel.fetch({async:!1});var t=this.guidemodel.get("description");e("#guideDescription").html(t),e("#guideModifiedAt").html(GO.util.basicDate3(this.guidemodel.get("descLastModifiedAt"))),e("#assetName").text(this.guidemodel.get("name")),this.guidemodel.get("attaches").length>0&&this.setAttachFile(),!this.guidemodel.get("description")&&this.guidemodel.get("attaches").length==0&&e("div.content_info_wrap").hide()},setAttachFile:function(){var t=[];e.each(this.guidemodel.get("attaches"),function(e,n){t.push(n)});var n=function(){var e=this.size,t=GO.util.getHumanizedFileSize(e);return t},r=function(){var e=new RegExp("(jpeg|jpg|png|gif|tif|bmp)","gi");return e.test(this.extention)?!0:!1};this.$el.find("#fileWrap").html(o({dataset:t,sizeCal:n,assetId:this.assetId,contextRoot:GO.contextRoot,lang:h,isImgFile:r,modify:!1})),this.$el.find("#fileWrap span.btn_wrap").hide()},renderDataTables:function(){var t=this,n=GO.contextRoot+"api/asset/"+this.assetId+"/item";columns=[],this._isReservationType()?columns.push({mData:"name",sClass:"name",bSortable:!1,fnRender:function(e){return'<a data-bypass class="txt" data-btntype="reservation" data-id="'+e.aData.id+'">'+e.aData.name+"</span>"}}):columns.push({mData:"name",sClass:"name",bSortable:!1,fnRender:function(e){var t,n;return e.aData.rentStatus=="RENTABLE"?(t="rentable",n='<span class="txt_b">'+h.rental+"</span>"):e.aData.rentStatus=="RETURN"?(t="return",n='<span class="txt_b">'+h.asset_return+"</span>"):(t="norentable",n=h.no_rent),'<a data-bypass class="txt" data-btntype="'+t+'" data-id="'+e.aData.id+'">'+e.aData.name+"</span>"}}),this.codeVisible&&columns.push({mData:"code",sClass:"code",bSortable:!0,fnRender:function(e){return'<span class="txt">'+e.aData.code+"</span>"}});var r=this.codeVisible?2:1;for(var i=0;i<this.attributesLen;i++)columns.push({mData:null,bSortable:!1,fnRender:function(e){return'<span class="txt">'+e.aData.properties[e.iDataColumn-r].content+"</span>"}});this._isReservationType()?(columns.push({mData:null,bSortable:!1,sClass:"action",fnRender:function(e){return'<a class="btn_fn7" data-bypass data-btntype="reservation" data-id="'+e.aData.id+'"><span class="txt_b">'+h.reservation+"</span></a>"}}),this.isManagable&&columns.push({mData:null,bSortable:!1,sClass:"action",fnRender:function(e){return'<a class="btn_fn7" data-bypass data-btntype="settingItem" data-id="'+e.aData.id+'">'+h.setting+"</a>"}})):(n=GO.contextRoot+"api/asset/"+this.assetId+"/item/rental/ALL",columns.push({mData:null,bSortable:!1,sClass:"action",fnRender:function(e){var t,n;return e.aData.rentStatus=="RENTABLE"?(t="rentable",n='<span class="txt_b">'+h.rental+"</span>"):e.aData.rentStatus=="RETURN"?(t="return",n='<span class="txt_b">'+h.asset_return+"</span>"):(t="norentable",n=h.no_rent),'<a class="btn_fn7" data-bypass data-btntype="'+t+'" data-id="'+e.aData.id+'">'+n+"</a>"}}));var s=this;this.dataTable=e.goGrid({el:"#assetItemDataTable",method:"GET",url:n,emptyMessage:'<tr><td colspan="7" class="code"><p class="data_null"><span class="ic_data_type ic_no_data"></span><span class="txt">'+h.no_asset+"</span></p></td></tr>",columns:columns,fnDrawCallback:function(t){e(window).scrollTop(0),t.siblings("div.tool_bar").find("div.custom_header").html('<h1 class="s_title">'+a["\uc790\uc0b0\ubcc4 \uc0c1\uc138 \uc815\ubcf4"]+"</h1>")}})},rentalSelect:function(t){var n=e(t.currentTarget).val();this.dataTable.tables.fnSettings().sAjaxSource=GO.contextRoot+"api/asset/"+this.assetId+"/item/rental/"+n,this.dataTable.tables.fnClearTable()},search:function(){var t=this.$el.find("#keyword"),n=t.val();if(e.trim(n)=="")return e.goMessage(h.alert_keyword),!1;this.dataTable.tables.customParams={nameKeyword:n},this.dataTable.tables.fnClearTable()},searchKeyboardEvent:function(e){e.keyCode==13&&this.search()},makeTemplete:function(e){var t=e.collection,n=r({dataset:t,isRental:this.type=="rental"?!0:!1,lang:h,isManage:this.isManagable});return n},assetItemAdd:function(){n.router.navigate("asset/"+this.assetId+"/create",!0)},settingItem:function(t){var r=e(t.currentTarget);n.router.navigate("asset/"+this.assetId+"/modify/"+r.attr("data-id"),!0)},_isReservationType:function(){return this.type=="reservation"},_renderMatrix:function(){this.$("div[data-matrix-area]").html((new c({assetId:this.assetId})).render().el)}});return p});