(function(){define(["backbone","app","hogan","i18n!nls/commons","hgn!note/templates/note_write","file_upload","jquery.autocomplete","go-webeditor/jquery.go-webeditor","jquery.go-preloader"],function(e,t,n,r,i,s){var o=null;window.setEmail=function(e,t){var n=o.$("#to"),r=e+"<"+t+">";o.makeFormatUnit(n,r)};var u={to:r["\ubc1b\ub294\uc0ac\ub78c"],subject:r["\uc81c\ubaa9"],attach:r["\ucca8\ubd80\ud30c\uc77c"],addAttach:r["\ud30c\uc77c \ucca8\ubd80"],send:r["\ubcf4\ub0b4\uae30"],fileName:r["\ucca8\ubd80\ud30c\uc77c\uba85"],size:r["\ud06c\uae30"],"delete":r["\uc0ad\uc81c"]},a=n.compile('<tr data-path="{{path}}" data-name="{{name}}" data-size="{{size}}" data-uid="{{uid}}" data-hostid="{{hostId}}"><td></td><td class="align_l"><span class="item_file"><span class="ic_file {{ext}}"></span><span class="name">{{name}}</span></span></td><td class="align_r"><span class="size">{{sizeUnit}}</span></td><td><span class="btn_bdr" data-btn="deleteAttach"><span class="ic_classic ic_basket" title=""></span></span></td></tr>'),f=e.Model.extend({getAttachList:function(){return this.get("attaches")},convertAttach:function(){_.each(this.getAttachList(),function(e){e.size||(e.isDelete=!0)},this)},hasAttach:function(){return this.getAttachList().length>0},getTotalAttachSize:function(){var e=_.reduce(this.getAttachList(),function(e,t){return e+t.size},0);return GO.util.getHumanizedFileSize(e)},getAliveAttachPart:function(){var e=_.map(this.getAttachList(),function(e){return e.isDelete?"":e.path});return _.compact(e).join("_")}}),l=e.View.extend({events:{"click span[data-btn=deleteAttach]":"deleteAttach","click #send":"send"},initialize:function(e){var t=GO.router.getSearch();this.uid=t.uids,this.type=t.type||"normal",this.folder=t.folder,this.model=new f},render:function(){var e=i({lang:u});this.$el.html(e),this.makeInputAddresskeyEvt("to");var t={autoResizeWidth:!0,makeFormat:!0,makeFormatFunc:this.makeFormatUnit,multiple:!1,width:"400px",matchCase:!0,notContact:"F",excSearchOption:"O",offKeyPress:$.browser.msie?!0:!1,customLeft:!0};return this.$("#to").autocomplete("/api/mail/address/search/name",t),this.initSmartEditor(),this.initFileUpload(),this.model.get("uids")&&this.renderData(),this},fetch:function(){var e=this,t={folderName:this.folder,uids:[this.uid],wtype:this.type,sharedFlag:"user",sharedUserSeq:0};this.type=="forward"&&(t.fwmode="parsed");var n=$.ajax({url:"/api/mail/message/write",data:JSON.stringify(t),type:"POST",contentType:"application/json",success:function(t){var n=t.data;e.model.set(n)},error:function(e){console.log(e)}});return n},send:function(){if(!GO.Editor.getInstance("content").validate())return $.goError(r["\ub9c8\uc784 \uc0ac\uc774\uc988 \ucd08\uacfc"]),!1;var e=this,t=GO.session(),n=GO.Editor.getInstance("content").getContent(),i=t.email,s=t.name,o=this.getRecipientEmail(),u=t.name?'"'+t.name+'"'+" <"+t.email+">":t.email||"",a=this.$("#subject").val(),f=this.getAttaches(),l=this.isInvalidRecipient();if(!o||l){this.$("#recipientsArea").focus(),$.goError(r["\ubc1b\ub294 \uc0ac\ub78c\uc744 \ub2e4\uc2dc \ud655\uc778\ud574 \uc8fc\uc138\uc694."],this.$("#recipientsArea"),!1,!0);return}if(!a){this.$("#subject").focus(),$.goError(r["\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694."],this.$("#subject"),!1,!0);return}var c={senderEmail:i,senderName:s,sendType:"__sent_go_note__",sendFlag:null,charset:"EUC-KR",folderName:null,uids:[],draftMessageId:null,attachSign:!1,signSeq:"",bannerDisplay:!1,bannerContent:null,to:o,cc:"",bcc:"",massMode:!1,senderMode:!0,senderUserEmail:u,subject:a,writeMode:"html",sendEmailCheckResult:!1,sendAttachCheckResult:!1,sendKeywordCheckResult:!1,sendInfoCheck:!1,content:n,receivenoti:!0,saveSent:!0,attachList:f,bigAttachMode:!1,bigAttachContent:"",sharedFlag:"user",sharedUserSeq:0,sharedFolderName:""},h=$.Deferred();this.initPreloader(h);var p="/api/mail/message/send";$.ajax({url:p,data:JSON.stringify(c),type:"POST",contentType:"application/json",success:function(t){h.resolve(),t.data.sendError?e.externalSendComplete(!1,t.data.errorMessage):e.externalSendComplete(!0,"success")},error:function(t){console.log(t),e.externalSendComplete(!1,t.statusText)}})},initPreloader:function(e){var t=$.goPreloader();return e.progress(function(){t.render()}),e.always(function(){t.release()}),e},getRecipientEmail:function(){var e=_.map(this.$("#recipients").find("span.name"),function(e){return $(e).data("email")});return e.join(",")},isInvalidRecipient:function(){return this.$("#recipients").find("li.invalid").length>0},getAttaches:function(){var e=[];return _.each(this.$("#attachArea").find("tr"),function(t){var n=[$(t).attr("data-path"),$(t).attr("data-name"),$(t).attr("data-size"),$(t).attr("data-hostid"),$(t).attr("data-uid")];e.push(n.join("	"))}),$.trim(e.join("\n"))},makeAddressUnitFormat:function(e,t){if($.trim(t)=="")return;var n=$("#"+e);this.makeFormatUnit(n,t),n.focus(),n.width("80px")},makeFormatUnit:function(e,t){function d(e){var t=null,n=null;return $.ajax({url:GO.contextRoot+"api/user/sort/list",data:{keyword:e},type:"GET",async:!1,success:function(e){hasName=e.data.length>0,hasName&&(t=e.data[0].name,n=e.data[0].email)},error:function(e){console.log(e)}}),{hasName:hasName,name:t,email:n}}if($.trim(t)=="")return;addressArray=new Array,addressSplit=t.split(">,");for(var n=0;n<addressSplit.length;n++){tempAddressArray=addressSplit[n].split(",");for(var r=0;r<tempAddressArray.length;r++)tempAddressArray[r]=$.trim(tempAddressArray[r]);addressArray=addressArray.concat(GO.util.makeFormatEmail(tempAddressArray))}for(var n=0;n<addressArray.length;n++){t=addressArray[n];var i=GO.util.checkEmailFormat(t),s=null;i||(s=d(t),s.email&&s.name&&(t='"'+s.name+'" <'+s.email+">",i=GO.util.checkEmailFormat(s.email)));var o=i?GO.util.get_name(t):t,u=i?o||GO.util.get_email(t):t,a=i?GO.util.getEmailFormatName(t):t,f=$('<span class="name" id="nameField" evt-rol="select-field" onselectstart="return false"></span>').attr("title",u).data("email",a).data("select",!1).text(u),l="",c=$('<span class="ic_classic ic_del"></span>');c.attr("title","\uc0ad\uc81c").click(function(){var t=$(this).closest("li");t.find("input.edit").unautocomplete(),t.remove(),e.focus()});var h=$('<span class="btn_wrap"></span>').append(c),p=$("<li></li>");p.addClass(!i||!o?"invalid":""),p.append(f).append(l).append(h),e.closest("li").before(p),e.val("")}},makeFormatEmail:function(e){var t=new Array,n=0,r=!1;for(var i=0;i<e.length;i++)if(e[i].indexOf('"')>-1){for(var s=i+1;s<e.length;s++)if(e[s].indexOf('"')>-1){r=!0;for(var o=i;o<=s;o++)o==i?t[n]=e[o]+",":o==s?t[n]=t[n]+e[o]:t[n]=t[n]+e[o]+",";n++;break}r||(t[n]=e[i]),i=s}else t[n]=e[i],n++;return t},makeInputAddresskeyEvt:function(e){var t=this,n=$("#"+e);n.keydown(function(n){var r=$.trim($(this).val());n.which==188&&!n.shiftKey&&(t.makeInputAddressFormat(e,r),n.preventDefault())}),n.blur(function(n){n.preventDefault();var r=$.trim($(this).val()),i=$("#"+e+"_actb");i.length==0||i.css("display")=="none"?$("div.layer_auto_complete:hover").length?$(this).val(""):t.makeInputAddressFormat(e,r):$("div.layer_auto_complete:hover").length?$(this).val(""):t.makeInputAddressFormat(e,r)}),n.keydown(function(e){e.which==8&&$(this).val()==""&&$(this).closest("ul.name_tag").find("li:not(.creat):last").remove()})},makeInputAddressFormat:function(e,t){if(!t)return;var n=$.trim(t),r=n.split(">,");for(var i=0;i<r.length;i++)this.makeAddressUnitFormat(e,r[i])},initSmartEditor:function(e){this.$("#content").goWebEditor({contextRoot:GO.config("contextRoot"),lang:GO.session("locale"),editorValue:this.model.get("htmlContent")||"",bUseVerticalResizer:!1},!0)},renderData:function(e){var t=this.$("#to");this.makeFormatUnit(t,this.model.get("to")),this.$("#subject").val(this.model.get("subject")),this.model.hasAttach()&&this.renderAttaches()},renderAttaches:function(){this.$("#attachArea").show(),_.each(this.model.getAttachList(),function(e){this.$("#attachList").append(a.render({path:e.upkey,name:e.name,size:e.size,sizeUnit:GO.util.getHumanizedFileSize(e.size),hostId:e.hostId,uid:e.uid,ext:GO.util.getFileIconStyle({extention:e.name.split(".")[1]})}))})},initFileUpload:function(){var e=this,n={el:"#file-control",context_root:GO.contextRoot,button_text:"<span class='buttonText'>"+u.addAttach+"</span>",url:"api/mail/file/upload",button_height:22,isMail:!0,file_post_name:"theFile",post_params:{uploadType:"flash",email:GO.session().email}};(new s(n)).queue(function(e,t){}).start(function(n,i){if(!GO.config("attachFileUpload"))return $.goAlert(r["\ud30c\uc77c\ucca8\ubd80\uc6a9\ub7c9\ucd08\uacfc"]),!1;if(GO.config("excludeExtension")){var s=$.inArray(i.type.substr(1).toLowerCase(),GO.config("excludeExtension").split(","));if(s>=0)return $.goMessage(t.i18n(r["\ud655\uc7a5\uc790\uac00 \ub561\ub561\uc778 \uac83\ub4e4\uc740 \ucca8\ubd80 \ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],"arg1",GO.config("excludeExtension"))),!1}var o=e.model.get("maxAttachSize");if(o){var u=i.size/1024/1024;if(o<u)return $.goMessage(t.i18n(r["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",o)),!1}if(GO.config("attachNumberLimit")){var a=$("#fileWrap").children().size()+$("#img_wrap").children().size(),f=GO.config("maxAttachNumber");if(f<=a)return $.goMessage(t.i18n(r["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",f)),!1}}).progress(function(e,t){}).success(function(t,n,r){var i=n.data,s=GO.util.isImage(i.fileExt);e.$("#attachArea").show(),r.attr("data-hostId",i.hostId),e.$("#attachList").append(a.render({name:i.fileName,size:i.fileSize,sizeUnit:GO.util.getHumanizedFileSize(i.fileSize),path:i.filePath,uid:i.uid,hostId:i.hostId,ext:GO.util.getFileIconStyle({extention:i.fileExt.split(".").join("")})}))}).complete(function(e,t){console.info(t)}).error(function(e,t){console.info(t)})},deleteAttach:function(e){$(e.currentTarget).parents("tr[data-path]").remove(),this.$("#attachArea").toggle(this.hasAttach())},setData:function(){console.log("setData")},hasAttach:function(){return this.$("#attachList").find("tr").length>0},externalSendComplete:function(e,t){console.log("note:"+JSON.stringify({"function":"sendComplete",param1:e,param2:t}))}});return{init:function(e){return o=new l(e),o}}})}).call(this);