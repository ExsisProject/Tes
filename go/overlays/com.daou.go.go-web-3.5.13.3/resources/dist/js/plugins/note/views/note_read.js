(function(){define(["backbone","app","i18n!nls/commons","hgn!note/templates/note_read","jquery.go-preloader"],function(e,t,n,r){var i={from:n["\ubcf4\ub0b8\uc0ac\ub78c"],to:n["\ubc1b\ub294\uc0ac\ub78c"],sendDate:n["\ubcf4\ub0b8\ub0a0\uc9dc"],attach:n["\ucca8\ubd80\ud30c\uc77c"],count:n["\uac1c"],reply:n["\ub2f5\uc7a5"],replyAll:n["\uc804\uccb4 \ub2f5\uc7a5"],delivery:n["\uc804\ub2ec"],"delete":n["\uc0ad\uc81c"],saveAll:n["\ubaa8\ub450\uc800\uc7a5"],deleteAll:n["\ubaa8\ub450\uc0ad\uc81c"],preview:n["\ubbf8\ub9ac\ubcf4\uae30"],deleted:n["\uc0ad\uc81c\ub41c \ucca8\ubd80\ud30c\uc77c"],subject:n["\uc81c\ubaa9"],more:n["\ub354\ubcf4\uae30"],fold:n["\uc811\uae30"]},s=e.Model.extend({acceptConverter:function(e){e=e.toLowerCase();var t="doc|docx|hwp|ppt|pptx|xls|xlsx|pdf|gif|jpg|jpeg|bmp|tif|png",n=new RegExp("("+t+")$","i");return n.test(e)?!0:!1},getAttachList:function(){return this.get("msgContent").attachList},convertAttach:function(){_.each(this.getAttachList(),function(e){e.isPreviewable=this.acceptConverter(e.fileType),e.size||(e.isDelete=!0),e.ext=GO.util.getFileIconStyle({extention:e.fileType})},this)},hasAttach:function(){return this.getAttachList().length>0},getTotalAttachSize:function(){var e=_.reduce(this.getAttachList(),function(e,t){return e+t.size},0);return GO.util.getHumanizedFileSize(e)},getAliveAttachPart:function(){var e=_.map(this.getAttachList(),function(e){return e.isDelete?"":e.path});return _.compact(e).join("_")}}),o=e.View.extend({className:"s_note",events:{"click span.ic_del":"deleteAttach","click #reply":"reply","click #replyAll":"replyAll","click #delivery":"delivery","click #destroy":"destroy","click #downloadAll":"downloadAll","click #deleteAll":"deleteAll","click span[data-btn=preview]":"preview","click #moreBtn":"toggleToList","click a[href]":"windowOpen","click ul.file_wrap span.name":"download"},initialize:function(e){var t=GO.router.getSearch();this.uid=t.uid,this.sid=t.sid,this.folder=t.folder,this.model=new s},render:function(){var e=r({lang:i,model:this.model.toJSON(),hasAttach:this.model.hasAttach(),totalAttachSize:this.model.getTotalAttachSize()});this.$el.html(e),this.initToList(),console.log("note:"+JSON.stringify({"function":"loadComplete",param1:this.model.get("msgContent").subject}))},windowOpen:function(e){var t=$(e.currentTarget);return window.open(t.attr("href")),!1},fetch:function(){var e=this,t=this.sid?{sid:this.sid}:{folder:this.folder,sharedFlag:"user",uid:this.uid,sharedUserSeq:0,sharedFolderName:""};return $.ajax({type:"POST",url:"/api/mail/message/read",contentType:"application/json",data:JSON.stringify(t),success:function(t){var n=t.data;e.sid&&(e.folder=n.msgContent.folderFullName,e.uid=n.msgContent.uid),e.model.set(n),e.model.convertAttach()},error:function(e){console.log(e)}})},initToList:function(){var e=this.$("#toList").find("li:not(.add):gt(9)"),t=e.length>0;t&&(e.hide(),e.attr("data-more",""),this.$("#moreBtn").show())},toggleToList:function(){var e=this.$("#toList").find("li[data-more]"),t=this.$("#moreBtn"),r=t.find("#moreBtnArrow"),i=r.hasClass("ic_arrow_up"),s=i?n["\ub354\ubcf4\uae30"]:n["\uc811\uae30"];e.toggle(!i),t.find("#moreBtnText").text(s),r.toggleClass("ic_arrow_up"),r.toggleClass("ic_arrow_down")},initPreloader:function(e){var t=$.goPreloader();return e.progress(function(){t.render()}),e.always(function(){t.release()}),e},deleteAttach:function(e){var t=$(e.currentTarget).parents("li"),n=this,r=$.Deferred();this.initPreloader(r),$.ajax({url:"/api/mail/message/attach/delete",type:"POST",data:"folderName="+this.folder+"&uid="+this.uid+"&part="+t.attr("part"),success:function(e){var t=e.data;n.uid=t,n.fetch().done(function(){n.render(),r.resolve()})},error:function(e){console.log(e)}})},downloadAll:function(){var e=this.model.getAliveAttachPart();if(!e){$.goAlert(n["\ub2e4\uc6b4\ub85c\ub4dc \ud560 \ud30c\uc77c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);return}var t={folderName:this.folder,uid:this.uid,part:e,sharedFlag:"user",sharedUserSeq:0,sharedFolderName:""},r=this;$.ajax({url:"/api/mail/message/attach/download/all",type:"POST",contentType:"application/json",data:JSON.stringify(t),success:function(e){var t=e.data,n={downloadFileName:t.downloadFileName,zipFileName:t.zipFileName},r="/api/mail/message/attach/download/all?"+$.param(n);console.log("note:"+JSON.stringify({"function":"downloadAll",param1:r,param2:t.downloadFileName}))},error:function(e){console.log(e)}})},deleteAll:function(){var e={folderNames:[this.folder],uids:[this.uid]},t=$.Deferred();this.initPreloader(t);var n=this;$.ajax({url:"/api/mail/message/attach/delete/all",type:"POST",data:e,traditional:!0,success:function(e){var r=e.data;n.uid=r,n.fetch().done(function(){n.render(),t.resolve()})},error:function(e){console.log(e)}})},reply:function(){var e="?type=reply&uids="+this.uid+"&folder="+this.folder,t=GO.contextRoot+"app/#note/write"+e;this.externalSetUrl(t)},replyAll:function(){var e="?type=replyall&uids="+this.uid+"&folder="+this.folder,t=GO.contextRoot+"app/#note/write"+e;this.externalSetUrl(t)},delivery:function(){var e="?type=forward&uids="+this.uid+"&folder="+this.folder,t=GO.contextRoot+"app/#note/write"+e;this.externalSetUrl(t)},destroy:function(){var e=this,t=function(){var t=$.Deferred();e.initPreloader(t);var n={folderNames:[e.folder],uids:[e.uid]};$.ajax({url:"/api/mail/message/delete",type:"POST",data:n,traditional:!0,success:function(){t.resolve()},error:function(){console.log('note:{"function" : "deleteComplete", "param1" : "false"}')}})};$.goPopup({message:n["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],modal:!0,allowPrevPopup:!0,pclass:"layer_confim layer_colleage layer_smallmail smail_pop",buttons:[{btext:n["\ud655\uc778"],btype:"confirm",callback:t},{btext:n["\ucde8\uc18c"],btype:"normal"}]})},preview:function(e){var t=$(e.currentTarget).parents("li[part]").attr("part"),n={folderName:this.folder,uid:this.uid,part:t,type:"normal",sharedFlag:"user",sharedFolderName:"",sharedUserSeq:"0"},r=GO.contextRoot+"app/mail/popup/process?path=previewAttach&data="+encodeURIComponent(JSON.stringify(n));console.log("note:"+JSON.stringify({"function":"preview",param1:r}))},download:function(e){var t=$(e.currentTarget),n=t.parents("li[part]").attr("part"),r={folderName:this.folder,uid:this.uid,part:n,type:"normal",sharedFlag:"user",sharedFolderName:"",sharedUserSeq:"0"},i="/api/mail/message/attach/download?"+$.param(r);console.log("note:"+JSON.stringify({"function":"download",param1:i,param2:t.text()}))},externalSetUrl:function(e){console.log("note:"+JSON.stringify({"function":"setUrl",param1:e}))}});return o})}).call(this);