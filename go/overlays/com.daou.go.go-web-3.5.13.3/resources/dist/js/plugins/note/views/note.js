(function(){define(["backbone","app","i18n!nls/commons","hgn!note/templates/note","jquery.go-grid"],function(e,t,n,r){var i=null;window.reloadList=function(){i.dataTable.tables.fnClearTable()};var s={inbox:n["\ubc1b\uc740 \ucabd\uc9c0\ud568"],sent:n["\ubcf4\ub0b8 \ucabd\uc9c0\ud568"],allBox:n["\uc804\uccb4 \ucabd\uc9c0\ud568"],write:n["\ucabd\uc9c0 \uc4f0\uae30"],reply:n["\ub2f5\uc7a5"],replyAll:n["\uc804\uccb4 \ub2f5\uc7a5"],delivery:n["\uc804\ub2ec"],"delete":n["\uc0ad\uc81c"],from:n["\ubcf4\ub0b8\uc0ac\ub78c"],subject:n["\uc81c\ubaa9"],received:n["\ubc1b\uc740\ub0a0\uc9dc"],size:n["\ud06c\uae30"],empty:n["\ucabd\uc9c0\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"],totalPeriod:n["\uc804\uccb4\uae30\uac04"],subjectAndContent:n["\uc81c\ubaa9+\ub0b4\uc6a9"],search:n["\uac80\uc0c9"]},o="__go_note__",u=e.View.extend({events:{"click #tab li":"changeTab","click table td:has(span)":"read","click a[data-btn=write]":"write","click a[data-btn=reply]":"reply","click a[data-btn=replyAll]":"replyAll","click a[data-btn=delivery]":"delivery","click a[data-btn=delete]":"destroy","click #checkAll":"checkAll","click #search":"search","change select[aria-controls]":"setOffset"},initialize:function(e){var t=GO.router.getSearch();this.tabType=t.tabType||o,this.listOption={page:0,offset:10,tabType:this.tabType},t.keyWord&&(this.listOption.keyWord=t.keyWord)},render:function(){var e=r({lang:s});this.$el.html(e),this.renderDataTable(),this.renderButton(),this.setSearchData(),this.markTab()},markTab:function(){this.$("li[data-type]").removeClass("on"),this.$("li[data-type='"+this.tabType+"']").addClass("on")},setSearchData:function(){this.listOption.keyWord&&this.$("#searchKeyword").val(decodeURIComponent(this.listOption.keyWord))},getApiUrl:function(){return"/api/mail/note/list"},renderDataTable:function(){var e=this,t=GO.router.getSearch();t.folder=this.tabType,this.dataTable=$.goGrid({el:"#messageList",url:this.getApiUrl(),params:t,lengthMenu:[10,20,30,40],displayLength:GO.util.store.get("messageOffset")||10,defaultSorting:[[3,"desc"]],method:"POST",emptyMessage:'<tr class="tb_option"><td colspan="5"><p class="desc" id="empty">'+n["\ucabd\uc9c0\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"]+"</p>"+"</td>"+"</tr>",columns:[{mData:null,sClass:null,bSortable:!1,fnRender:function(e){return'<input type="checkbox" data-id="'+e.aData.id+'" data-seen="'+e.aData.seen+'">'}},{mData:"fromToSimple",sClass:null,bSortable:!0,fnRender:function(t){var n=e.tabType==o?t.aData.fromToSimple:t.aData.sendToSimple;return"<span class='name'>"+n+"</span>"},sortKey:e.tabType==o?"from":"to"},{mData:"subject",sClass:null,bSortable:!0,fnRender:function(e){var t=e.aData.flag.indexOf("T")!=-1?'<span class="ic ic_file_s" title=""></span>':"",r="<span class='subject'>"+t+(e.aData.subject||n["\uc81c\ubaa9\uc5c6\uc74c"])+"</span>";return r},sortKey:"subj"},{mData:"dateUtc",sClass:null,bSortable:!0,fnRender:function(e){var t,n=moment(e.aData.dateUtc),r=new Date;return n.isSame(r,"day")?t="HH:mm":t="YY-MM-DD HH:mm","<span class='date'>"+n.format(t)+"</span>"},sortKey:"arrival"},{mData:"size",sClass:null,bSortable:!0,fnRender:function(e){return"<span class='size'>"+e.aData.size+"</span>"}}],fnDrawCallback:function(t,n,r){e.defaultTableStyle(n),e.toggleText(),e.markUnRead(),e.fillEmptyArea(t),e.listOption.page=r.page,e.listOption.offset=r.offset,e.changeSearchUrl(!1),e.$("select").remove()}})},reloadDataTable:function(){this.dataTable.tables.fnSettings().sAjaxSource=this.getApiUrl(),this.dataTable.tables.customParams=this.listOption,this.dataTable.tables.fnPageChange("first"),this.dataTable.tables.fnClearTable(),this.changeSearchUrl(!0)},fillEmptyArea:function(e){var t=e.find("tr:not([role=row])").length,n=10-t;for(var r=0;r<n;r++)this.$("tbody").append('<tr class="" style="height:28px"></tr>')},defaultTableStyle:function(e){this.$(".dataTables_paginate").css("padding-top","43px"),e.aoData.length||this.$("#empty").parents("tr").addClass("tb_option")},toggleText:function(){var e=this.tabType==o?n["\ubcf4\ub0b8\uc0ac\ub78c"]:n["\ubc1b\ub294\uc0ac\ub78c"],t=this.tabType==o?"fromaddr":"toaddr",r=this.$("#addrType");this.$("#name").text(e),r.text(e),r.attr("value",t)},markUnRead:function(){_.each(this.$("input[data-seen=false]"),function(e){$(e).parents("tr").addClass("read_no")})},renderButton:function(){var e=this.makeButton("write",!0),t=this.makeButton("reply",!1),n=this.makeButton("replyAll",!1),r=this.makeButton("delivery",!1),i=this.makeButton("delete",!1),s=e+t+n+r+i;this.$("div.critical").append(s)},makeButton:function(e,t){var n=t?"btn_major_s":"btn_minor_s";return'<a class="'+n+'" data-btn="'+e+'">'+'<span class="ic"></span>'+'<span class="txt">'+s[e]+"</span>"+"</a>"},changeTab:function(e){var t=$(e.currentTarget);t.siblings().removeClass("on"),t.addClass("on"),this.tabType=t.attr("data-type"),this.listOption={page:0,offset:10,tabType:this.tabType},this.reloadDataTable()},read:function(e){var t=$(e.currentTarget).parents("tr"),n=t.find("input").attr("data-id"),r="?uid="+n+"&folder="+this.tabType,i=GO.contextRoot+"app/#note/read"+r;t.removeClass("read_no"),this.externalSetUrl(i)},write:function(){var e=GO.contextRoot+"app/#note/write";this.externalSetUrl(e)},reply:function(){if(!this.hasChecked()){this.messagePopup(n["\ucabd\uc9c0\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."]);return}if(this.isMultiCheck()){this.messagePopup(n["\ud558\ub098\uc758 \ucabd\uc9c0\ub9cc \ub2f5\uc7a5 \uac00\ub2a5\ud569\ub2c8\ub2e4."]);return}var e=this.getCheckedMessage(),t="?type=reply&uids="+e.attr("data-id")+"&folder="+this.tabType,r=GO.contextRoot+"app/#note/write"+t;this.externalSetUrl(r)},replyAll:function(){if(!this.hasChecked()){this.messagePopup(n["\ucabd\uc9c0\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."]);return}if(this.isMultiCheck()){this.messagePopup(n["\ud558\ub098\uc758 \ucabd\uc9c0\ub9cc \uc804\uccb4 \ub2f5\uc7a5 \uac00\ub2a5\ud569\ub2c8\ub2e4."]);return}var e=this.getCheckedMessage(),t="?type=replyall&uids="+e.attr("data-id")+"&folder="+this.tabType,r=GO.contextRoot+"app/#note/write"+t;this.externalSetUrl(r)},delivery:function(){if(!this.hasChecked()){this.messagePopup(n["\ucabd\uc9c0\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."]);return}if(this.isMultiCheck()){this.messagePopup(n["\ud558\ub098\uc758 \ucabd\uc9c0\ub9cc \uc804\ub2ec \uac00\ub2a5\ud569\ub2c8\ub2e4."]);return}var e=this.getCheckedMessage(),t="?type=forward&uids="+e.attr("data-id")+"&folder="+this.tabType,r=GO.contextRoot+"app/#note/write"+t;this.externalSetUrl(r)},destroy:function(){if(!this.hasChecked()){this.messagePopup(n["\ucabd\uc9c0\ub97c \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."]);return}var e=this,t=function(){var t=[];_.each(e.getCheckedMessage(),function(e){t.push($(e).attr("data-id"))});var n={folderNames:[e.tabType],uids:t};$.ajax({url:"/api/mail/message/delete",dataType:"json",contentType:"application/json",type:"POST",data:JSON.stringify(n),traditional:!0,success:function(){e.dataTable.tables.fnClearTable()},error:function(){console.log("error")}})};$.goPopup({message:n["\uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],modal:!0,allowPrevPopup:!0,pclass:"layer_confim layer_colleage layer_smallmail smail_pop",buttons:[{btext:n["\ud655\uc778"],btype:"confirm",callback:t},{btext:n["\ucde8\uc18c"],btype:"normal"}]})},checkAll:function(e){var t=$(e.currentTarget).is(":checked");this.$("tbody input[type=checkbox]").attr("checked",t)},hasChecked:function(){return this.$("tbody input[type=checkbox]:checked").length>0},isMultiCheck:function(){return this.$("tbody input[type=checkbox]:checked").length>1},getCheckedMessage:function(){return this.$("input:checked").not("#checkAll")},getCheckedIds:function(){return _.map(this.getCheckedMessage(),function(e){return $(e).attr("data-id")})},search:function(){var e=this.$("#searchKeyword"),t=this.$("#searchType");if(e.val().length>64||e.val().length<2){$.goMessage(GO.i18n(n["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:2,arg2:64}),e,!1,!0);return}this.listOption.category="sb",this.listOption.listType="mail",this.listOption.adv="on",this.listOption.keyWord=e.val(),this.listOption.page=0,this.reloadDataTable()},setOffset:function(e){var t=$(e.currentTarget);GO.util.store.set("messageOffset",t.val(),{type:"session"})},messagePopup:function(e){$.goPopup({message:e,modal:!0,allowPrevPopup:!0,pclass:"layer_confim layer_colleage layer_smallmail smail_pop",buttons:[{btext:n["\ud655\uc778"],btype:"confirm"}]})},changeSearchUrl:function(e){var t=e||!1;GO.router.navigate(GO.router.getUrl().split("?")[0]+"?"+$.param(this.listOption),{replace:!t,trigger:t})},externalSetUrl:function(e){console.log("note:"+JSON.stringify({"function":"setUrl",param1:e}))}});return{init:function(e){return i=new u(e),i}}})}).call(this);