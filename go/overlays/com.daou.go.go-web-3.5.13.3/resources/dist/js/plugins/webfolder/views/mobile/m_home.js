(function(){define(["views/mobile/m_more_list","jquery","backbone","hogan","app","i18n!nls/commons","hgn!webfolder/templates/mobile/m_webfolder_list_unit","hgn!webfolder/templates/mobile/m_webfolder_list","webfolder/collections/webfolders_shared","webfolder/collections/webfolders_list","jquery.go-validation","GO.util"],function(e,t,n,r,i,s,o,u,a,f){var l={board:s["\uac8c\uc2dc\ud310"],webfolder_title:s["\uc790\ub8cc\uc2e4"],private_webfolder:s["\uac1c\uc778 \uc790\ub8cc\uc2e4"],public_webfolder:s["\uc804\uc0ac \uc790\ub8cc\uc2e4"],attach:s["\ucca8\ubd80"],no_list:s["\ub4f1\ub85d\ub41c \ud30c\uc77c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],select_all:s["\uc804\uccb4\uc120\ud0dd"],select_cancel:s["\uc804\uccb4\ud574\uc81c"]},c=e.extend({id:"webFolderView",attributes:{"data-role":"layer",style:"background:#fff; position:absolute; width:100%; min-height:100%; top:0; left:0; z-index:999"},unbindEvent:function(){this.$el.off("vclick","#closeWebFolder"),this.$el.off("vclick",".goSubWebFolder"),this.$el.off("vclick","#moveParentWebFolder"),this.$el.off("vclick",".clickFile"),this.$el.off("change","input[type=checkbox]"),this.$el.off("change","#webFolderDirectory"),this.$el.off("vclick","#uncheckAllFile"),this.$el.off("vclick","#selectAllFile"),this.$el.off("vclick","#attachFile")},bindEvent:function(){this.$el.on("vclick","#closeWebFolder",t.proxy(this.closeWebFolder,this)),this.$el.on("vclick",".goSubWebFolder",t.proxy(this.moveSubWebFolder,this)),this.$el.on("vclick","#moveParentWebFolder",t.proxy(this.moveParentWebFolder,this)),this.$el.on("vclick",".clickFile",t.proxy(this.clickFile,this)),this.$el.on("change","input[type=checkbox]",t.proxy(this.clickCheckbox,this)),this.$el.on("change","#webFolderDirectory",t.proxy(this.changeFolderDirectory,this)),this.$el.on("vclick","#uncheckAllFile",t.proxy(this.uncheckAllFile,this)),this.$el.on("vclick","#selectAllFile",t.proxy(this.selectAllFile,this)),this.$el.on("vclick","#attachFile",t.proxy(this.attachFile,this))},initialize:function(){GO.util.appLoading(!0),this.webFolderParamHistoryList=[],this.$listEl=null,this.webFolderListCollection=new f,this.webSharedFoldersCollection=a.getCollection(),t("#webFolderDirectory option[data-type=share]").remove();var e={listFunc:t.proxy(function(e){this.renderList(e)},this)};this.dataSet={path:"/",fullPath:"/",type:"user"},this.webFolderParamHistoryList.push(this.dataSet),this.setRenderListFunc(e),this.setFetchInfo(this.dataSet,this.webFolderListCollection),this.pageNo=1},render:function(){GO.util.pageDone(),this.unbindEvent(),this.bindEvent(),this.options=t.extend(this.options,arguments[0]||{});var e=this.webSharedFoldersCollection.toJSON(),n=u({lang:l});this.$el.html(n),t("body").append(this.el),this.renderSharedFolderNameList(e),this.renderHeader(this.dataSet),this.$el.find("#webfolderList").empty(),this.dataFetch().done(t.proxy(function(e){this.renderListFunc.listFunc(e)},this)),GO.util.appLoading(!1)},renderList:function(){var e=this.webFolderListCollection.toJSON()[0],t=function(e){if(e>1048576){var t=Math.floor(e*10/1048576);return parseInt(t/10)+"MB"}if(e>1024){var t=Math.floor(e*10/1024);return parseInt(t/10)+"KB"}return e+"B"};_.each(e.messages,function(e){e.formattedFileSize=t(e.webFolderFileSize),e.formattedUtcDate=moment(e.webFolderFileUtcDate).format("YYYY-MM-DD")}),e.messages.length===0&&e.folders.length===0&&(e=null);var n=o({dataSet:e,lang:l});this.pageNo===1&&this.$el.find("#webfolderList").empty(),this.$el.find("#webfolderList").append(n)},renderSharedFolderNameList:function(e){var n=this;_.each(e[0].webfolder,function(e){t("#webFolderDirectory").append("<option data-type='share' data-sroot='"+e.sroot+"' data-full-path='"+e.fullName+"' data-userseq='"+e.mailUserSeq+"' >"+e.name+"</option>")}),n.$el.find("#webFolderDirectory").val("user").prop("selected",!0)},closeWebFolder:function(){return t("#goBody").show(),t("#webFolderView").remove(),!1},moveSubWebFolder:function(e){e.preventDefault(),e.stopPropagation();var n=t(e.currentTarget);this.resetCheckedWebFolder(),this.dataSet={type:n.data("type"),path:n.data("full-path").split("WEBFOLDERROOT.")[1],fullPath:n.data("full-path"),nodeNum:n.data("node-num")},n.data("type")==="share"&&(this.dataSet.userSeq=n.data("userseq"),this.dataSet.sroot=n.data("sroot")),this.renderHeader(this.dataSet),this.pageNo=1,this.webFolderParamHistoryList.push(this.dataSet),this.dataFetch().done(t.proxy(function(e){this.renderListFunc.listFunc(e)},this))},moveParentWebFolder:function(){this.dataSet=this.webFolderParamHistoryList.pop(),this.resetCheckedWebFolder(),_.contains(this.dataSet.path,t("#webSubFolderToolbarWrap h1").text().trim())&&(this.dataSet=this.webFolderParamHistoryList.pop()),this.webFolderParamHistoryList.length===0&&this.webFolderParamHistoryList.push(this.dataSet),this.renderHeader(this.dataSet),this.pageNo=1,this.dataFetch().done(t.proxy(function(e){this.renderListFunc.listFunc(e)},this))},renderHeader:function(e){e.fullPath.split(".").length>=2?(t("#webFolderHomeToolbarWrap").hide(),t("#webSubFolderToolbarWrap").show(),t("div.webFolderHeader:visible h1").text(e.path.split(".").slice(-1)[0])):(t("#webSubFolderToolbarWrap").hide(),t("#webFolderHomeToolbarWrap").show()),t("div.webFolderHeader:visible").attr({"data-path":e.path,"data-userseq":e.userSeq,"data-sroot":e.sroot,"data-type":e.type})},resetCheckedWebFolder:function(){t("#webFolderSelectToolbarWrap").hide(),t("#webfolder_content input[type=checkbox]").prop("checked",!1),t("#select-all").text("\uc804\uccb4 \uc120\ud0dd")},clickFile:function(e){t(e.currentTarget).next().trigger("click"),this.clickCheckbox(e)},clickCheckbox:function(e){var n=t("#webfolder_content").find("li input:checked").length;n?t("#webFolderSelectToolbarWrap").show():t("#webFolderSelectToolbarWrap").hide(),t("#webFolderSelectToolbarWrap span.count").text(GO.i18n(webFolderLang.folder_select_number,{number:n}))},changeFolderDirectory:function(e){var n=t(e.currentTarget).find("option:selected");this.webFolderParamHistoryList=[],this.resetCheckedWebFolder(),this.dataSet={type:n.data("type"),fullPath:"WEBFOLDERROOT"},n.data("type")==="share"&&(this.dataSet=t.extend(this.dataSet,{sroot:n.data("sroot"),userSeq:n.data("userseq"),path:n.data("full-path").split(".")[1],fullPath:n.data("full-path")})),this.renderHeader(this.dataSet),t("#webFolderHomeToolbarWrap").show(),this.pageNo=1,this.webFolderParamHistoryList.push(this.dataSet),this.dataFetch().done(t.proxy(function(e){this.renderListFunc.listFunc(e)},this))},uncheckAllFile:function(e){e.stopImmediatePropagation(),e.preventDefault(),e.stopPropagation(),this.resetCheckedWebFolder()},selectAllFile:function(){t("#selectAllFile").text()===l.select_all?(t("#webfolder_content input[type=checkbox]").prop("checked",!0),t("#selectAllFile").text(l.select_cancel)):(t("#webfolder_content input[type=checkbox]").prop("checked",!1),t("#selectAllFile").text(l.select_all)),this.clickCheckbox()},attachFile:function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),GO.util.appLoading(!0);var n=t("div.webFolderHeader:visible"),r={path:n.data("path"),sharedUserSeq:n.data("userseq")===""?0:n.data("userseq"),sroot:n.data("sroot"),type:n.data("type")},i=[];_.each(t("#webfolder_content").find("li input:checked"),function(e){i.push(t(e).data("uid").toString())}),r.uids=i,this.resetCheckedWebFolder(),typeof this.options.callback=="function"&&this.options.callback(r),this.closeWebFolder()},detectScroll:function(e){var n=t(e.currentTarget).height(),r=t("#webfolder_content").height(),i=t(e.currentTarget).scrollTop(),s=r-n;i-s>-0.5&&this.appendWebFolderList()},appendWebFolderList:function(){if(this.collection.toJSON()[0].pageInfo.lastPage)return;this.pageNo++,this.dataSet.currentPage=this.pageNo,this.dataFetch().done(t.proxy(function(e){e.toJSON()[0].folders.length=0,this.renderListFunc.listFunc(e)},this))}});return c})}).call(this);