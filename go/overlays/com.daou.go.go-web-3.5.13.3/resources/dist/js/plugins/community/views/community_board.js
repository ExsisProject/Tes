define(function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("community/models/community_board"),s=require("hgn!community/templates/community_board"),o=require("i18n!board/nls/board"),u=require("i18n!nls/commons"),a=require("i18n!community/nls/community"),f=require("board/components/board_tree/board_tree"),l=require("community/models/comm_board_tree_node"),c=require("text!board/templates/_dept_board_toolbar.html"),h=require("board/constants");require("jquery.ui"),require("jquery.go-popup"),require("jquery.go-sdk"),require("GO.util"),require("jquery.go-validation");var p=null;lang={board_admin:o["\uac8c\uc2dc\ud310 \uad00\ub9ac"],board_admin_desc:a["\uc6b0\ub9ac \ucee4\ubba4\ub2c8\ud2f0\uc5d0 \uac1c\uc124\ub41c \uac8c\uc2dc\ud310 \uc21c\uc11c\ub97c \ubcc0\uacbd\ud558\uac70\ub098 , \uc911\ub2e8 \ub610\ub294 \uc0ad\uc81c \ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."],board_separator:o["\uad6c\ubd84\uc120"],board_separator_add:o["\uad6c\ubd84\uc120 \ucd94\uac00"],modify:u["\uc218\uc815"],save:u["\uc800\uc7a5"],cancel:u["\ucde8\uc18c"],"delete":u["\uc0ad\uc81c"],board_active_title:o["\uc0ac\uc6a9\uc911"],board_stop_title:o["\uc911\uc9c0"],board_reorder:o["\uc21c\uc11c \ubc14\uafb8\uae30"],board_reorder_save:o["\uc21c\uc11c\ubc14\uafb8\uae30 \uc644\ub8cc"],board_title:u["\uac8c\uc2dc\ud310"],board_manager:o["\uc6b4\uc601\uc790"],board_createat:o["\uac1c\uc124\uc77c"],board_updateat:o["\uc911\uc9c0\uc77c"],board_posts:o["\uac8c\uc2dc\uae00 \uc218"],board_setting:u["\uc124\uc815"],board_active_null:o["\uc0ac\uc6a9\uc911\uc778 \uac8c\uc2dc\ud310 \ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],board_stop_null:o["\uc911\uc9c0\ub41c \uac8c\uc2dc\ud310 \ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],"delete_separator?":o["\uad6c\ubd84\uc120\uc744 \uc0ad\uc81c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"delete_separator_desc?":o["\uad6c\ubd84\uc120\uc744 \uc0ad\uc81c\ud558\uba74 \ubcf5\uad6c\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4. <br />\uacc4\uc18d \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],delete_confirm:o["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],delete_title:o["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],stop_confirm:o["\uac8c\uc2dc\ud310 \uc911\uc9c0 \ud655\uc778"],stop_board:o["\uac8c\uc2dc\ud310 \uc911\uc9c0"],change_success:u["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],delete_success:u["\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],not_select_board:o["\uac8c\uc2dc\ud310\uc744 \uc120\ud0dd\ud574 \uc8fc\uc138\uc694."],board_stop:u["\uc911\uc9c0"],board_delete:u["\uc0ad\uc81c"],add_board:o["\uac8c\uc2dc\ud310 \ucd94\uac00"],add_group:o["\uac8c\uc2dc\ud310 \uadf8\ub8f9 \ucd94\uac00"],close_all:o["\ubaa8\ub450 \ub2eb\uae30"],open_all:o["\ubaa8\ub450 \uc5f4\uae30"],"\ucd94\uac00":u["\ucd94\uac00"]};var d=!1,v=f.BoardTreeConfigView,m=v.extend({getBoardAdminUrl:function(e){return["community",e.getCommunityId(),"board",e.getBoardId(),"admin"].join("/")}}),g=t.View.extend({events:{"click a.btnToggleAddMenu":"_onClickToggleAddMenu","click a.btnBoardDelete":"_onClickBoardDelete","click a.btnBoardStop":"_onClickBoardStop","click #checkAll":"_onClickCheckAll","click .btnAddBoard":"_onClickAddBoard","click .btnAddGroup":"_onClickAddGroup","click .btnAddSeperator":"_onClickAddSeperator","click a.btnBoardSortable":"_onClickSortableToggle","click a.btnToggleNodes":"_onClickToggleNodes"},initialize:function(e){this.$el.off();var t=e||{};this.communityId=t.communityId,this.status=t.status||Contstans.STATUS_ACTIVE,this.commBoardNodes=new l.Collection(null,{communityId:this.communityId,status:this.status}),this.boardTreeConfigView=null},render:function(){this.$el.empty();var e=this;console.debug("[board] CommBoardAdmin:render call"),this.$el.html(s({isStop:isStop=function(){return e.status=="closed"?!0:!1},lang:lang},{toolbar:c})),this.$el.find(".btnBoardMigration").remove(),this._renderBoardTree()},checkBoard:function(){var t=!1;return e.each(e("#tableBorderList tbody input"),function(n,r){if(e(r).is(":checked"))return t=!0,!1}),t},getSelectBoardIds:function(){var t=[];return e.each(e("#tableBorderList tbody input:checked"),function(n,r){t.push(e(r).val())}),t},_getCheckedBoardIds:function(){var t=[];return this.$("input:checkbox[name=board_id]:checked").each(function(n,r){t.push(e(r).val())}),t},_addFolder:function(){this.boardTreeConfigView&&this.boardTreeConfigView.addNode(new l.Model({nodeType:h.NODETYPE_FOLDER,nodeValue:o["\uc0c8\ub85c\uc6b4 \uadf8\ub8f9\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]}))},_addSeperator:function(){this.boardTreeConfigView&&this.boardTreeConfigView.addNode(new l.Model({nodeType:h.NODETYPE_SEPERATOR,nodeValue:o["\uc0c8\ub85c\uc6b4 \uad6c\ubd84\uc120\uba85\uc744 \uc785\ub825\ud574\uc8fc\uc138\uc694"]}))},_onClickToggleNodes:function(t){var n=e(t.currentTarget),r=n.attr("data-state");t.preventDefault();if(this.boardTreeConfigView===null)return;r==="opened"?(this.boardTreeConfigView.foldAllNodes(),n.attr("data-state","closed"),n.find("span.txt").text(lang.open_all)):(this.boardTreeConfigView.unfoldAllNodes(),n.attr("data-state","opened"),n.find("span.txt").text(lang.close_all))},_onClickCheckAll:function(t){this.$("input:checkbox[name=board_id]").attr("checked",e(t.currentTarget).is(":checked"))},_onClickToggleAddMenu:function(t){var n=e(t.currentTarget),r=n.siblings(".addActionContextMenu");t.preventDefault(),r.toggle()},_onClickAddBoard:function(t){var n=e(t.currentTarget).closest(".addActionContextMenu");n.hide(),GO.router.navigate("community/"+this.communityId+"/board/create",{trigger:!0})},_onClickAddGroup:function(t){var n=e(t.currentTarget).closest(".addActionContextMenu");this._addFolder(),n.hide()},_onClickAddSeperator:function(t){var n=e(t.currentTarget).closest(".addActionContextMenu");n.hide(),this._addSeperator()},_onClickSortableToggle:function(t){var n=this,r=e(t.currentTarget);t.preventDefault(),this._isSortableMode()?(e(".btnBoardStop").show(),e(".btnBoardDelete").show(),e(".btnToggleAddMenu").show(),this._distroyNodeSortable()):(e(".btnBoardStop").hide(),e(".btnBoardDelete").hide(),e(".btnToggleAddMenu").hide(),this._enableNodeSortable())},_isSortableMode:function(){return this.$("#board-tree-config").hasClass("tb_stair_edit")},_enableNodeSortable:function(){if(!this.boardTreeConfigView)return;this.boardTreeConfigView.enableSortable(),this.$(".tb-header").addClass("tb_stair_edit"),this._changeSortButtonText(lang.board_reorder_save)},_distroyNodeSortable:function(){if(!this.boardTreeConfigView)return;this.boardTreeConfigView.destroySortable(),this.$(".tb-header").removeClass("tb_stair_edit"),this._changeSortButtonText(lang.board_reorder)},_changeSortButtonText:function(t){e(".btnBoardSortable").find("span.txt").html(t)},_onClickBoardStop:function(t){var n=this,r=this._getCheckedBoardIds();t.preventDefault();if(d===!0){e.goSlideMessage(u["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(r.length==0){e.goMessage(lang.not_select_board);return}e.goConfirm(lang.stop_board,lang.stop_confirm,function(){e.ajax({type:"PUT",data:JSON.stringify({ids:r}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"api/board/status/closed",beforeSend:function(){d=!0}}).done(function(t){e.goMessage(lang.change_success),n.render(),GO.EventEmitter.trigger("community","changed:sideCommunityBoard",n.deptId)}).complete(function(){d=!1})})},_onClickBoardDelete:function(t){var n=this,r=this._getCheckedBoardIds();t.preventDefault();if(d===!0){e.goSlideMessage(u["\uc7a0\uc2dc\ub9cc \uae30\ub2e4\ub824\uc8fc\uc138\uc694"]);return}if(r.length==0){e.goMessage(lang.not_select_board);return}e.goConfirm(lang.delete_title,lang.delete_confirm,function(){e.ajax({type:"DELETE",data:JSON.stringify({ids:r}),dataType:"json",contentType:"application/json",url:GO.config("contextRoot")+"api/board/status/deleted",beforeSend:function(){d=!0}}).done(function(t){e.goMessage(lang.delete_success),n.render(),GO.EventEmitter.trigger("community","changed:sideCommunityBoard",n.deptId)}).complete(function(){d=!1})})},changeCheckedAll:function(t){var n=e(t.currentTarget),r=n.is(":checked");e.each(e("#tableBorderList tbody input"),function(t,n){e(n).attr("checked",r)})},_renderBoardTree:function(){var e=this,t=this.commBoardNodes;return this.$el.find("#board-tree-config").empty(),n.promise(function(n,r){t.fetch({silent:!0,success:function(t){var n=new m({nodes:t,communityId:this.communityId});n.setElement(e.$("#board-tree-config")),n.render(),e.boardTreeConfigView=n},error:r})}).otherwise(function(e){console.log(e.stack)})},getSeparator:function(e){var e=e||{},t=['<tr class="separator"  data-id="',e.id,'"><td colspan="6" class="depart_bg align_l">','<span class="title_depart vm">&lt;<span>',e.title,"</span>&gt;</span>&nbsp;",'<span class="btn_fn7 vm modify">',lang.modify,"</span>&nbsp;",'<span class="btn_fn7 vm delete">',lang["delete"],"</span></td></tr>"];return t.join("")},isSortable:function(){},bindListSortableToggle:function(t){var n=this;e(t.currentTarget).toggle(function(){n.bindListSortable(t)},function(){n.actionListSortPut(t)}).click()},bindListSortable:function(e){this.$el.find(".btnBoardSortable").addClass("btn_save").find("span.txt").html(lang.board_reorder_save),this.$el.find(".btnBoardAddLine").hide(),this.listEl.find("tbody").removeClass().sortable({opacity:"1",delay:100,cursor:"move",items:"tr",containment:"#tableBorderList",hoverClass:"ui-state-hover",forceHelperSize:"true",helper:"clone",placeholder:"ui-sortable-placeholder",start:function(e,t){t.placeholder.html("<td colspan='6'>&nbsp;</td>")}})},actionListSortPut:function(t){var n=this,r=this.listEl.find("tbody"),i=r.find("tr").map(function(t,n){return e(n).attr("data-id")}).get();this.model.clear(),this.model.set({id:this.deptId,deptId:this.deptId,ids:i},{silent:!0}),this.model.save({},{success:function(){GO.EventEmitter.trigger("community","changed:sideCommunityBoard",n.deptId),n.render()}})},actionSeparatorDelete:function(t){var n=e(t.currentTarget).parents("tr"),r=n.attr("data-id"),i=[GO.contextRoot+"api/community",this.deptId,"board/line",r];e.goCaution(lang["delete_separator?"],lang["delete_separator_desc?"],function(){e.go(i.join("/"),{},{qryType:"DELETE",responseFn:function(e){e.code==200&&n.slideUp(),GO.EventEmitter.trigger("community","changed:sideCommunityBoard",self.deptId)}})})},editSeparatorSave:function(t){var n=this,i=e(t.currentTarget).parents("tr"),s=i.attr("data-id"),o=i.find("input").val(),u=[GO.contextRoot+"api/community",this.deptId,"board/line",s],f=function(t,n){return e.goMessage(t),n&&n.focus(),!1};if(!e.goValidation.isCheckLength(1,17,o))return f(r.i18n(a["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:"1",arg2:"17"}),i.find("input")),!1;e.go(u.join("/"),JSON.stringify({title:o}),{qryType:"PUT",contentType:"application/json",responseFn:function(t){t.code==200&&(i.html(e(n.getSeparator({id:t.data.id,title:t.data.title})).html()),GO.EventEmitter.trigger("community","changed:sideCommunityBoard",n.deptId))}})},editSeparatorCancel:function(t){var n=e(t.currentTarget).parents("tr"),r=n.attr("data-id"),i=n.find("input").attr("data-before");n.html(e(this.getSeparator({id:r,title:i})).html())},editSeparatorTitle:function(t){var n=e(t.currentTarget).parents("tr"),r=n.attr("data-id"),i=n.find("td"),s=i.find("span.title_depart span").text(),o=["/api/community",this.deptId,"board/line",r],u=['<input type="text" class="input w_medium vm" value="',s,'" data-before="',s,'" />&nbsp;<span class="btn_fn7 vm save">',lang.save,'</span>&nbsp;<span class="btn_fn7 vm cancel">',lang.cancel,"</span>"];i.html(u.join("")).find("input").focus()},controlListCount:function(){this.listEl.find("tr[data-id]").length?this.listEl.find("tr.null").remove():this.listEl.append(['<tr class="null"><td colspan="6">',this.status=="closed"?lang.board_stop_null:lang.board_active_null,"</td></tr>"].join(""))},actionSeparatorPost:function(){var t=this,n=[GO.contextRoot+"api/community",this.deptId,"board/line"];e("body").animate({scrollTop:this.$el.height()},300),e.go(n.join("/"),{title:lang.board_separator},{qryType:"POST",responseFn:function(e){var n=t.getSeparator(e.data);e.code==200&&(t.listEl.append(n),GO.EventEmitter.trigger("community","changed:sideCommunityBoard",t.deptId),t.controlListCount())}})}});return{render:function(e){var e=e||{};return p=new g({el:".tab_conent_wrap",communityId:e.communityId,status:e.status}),p.render()}}});