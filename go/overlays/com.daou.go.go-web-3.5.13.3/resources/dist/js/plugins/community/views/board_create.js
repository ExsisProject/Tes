define(function(require){var e=require("app"),t=require("when"),n=require("board/views/board_create"),r=require("community/models/board"),i=require("board/models/board_config"),s=require("hgn!community/templates/board_create"),o=require("hgn!community/templates/board_modify"),u=require("hgn!community/templates/board_create_public_data"),a=require("hgn!community/templates/board_create_anonymous_data"),f=require("hgn!community/templates/board_create_public_members"),l=require("hgn!board/templates/board_create_header"),c=require("board/views/board_title"),h=require("i18n!board/nls/board"),p=require("i18n!nls/commons");require("jquery.go-orgslide");var d=e.session(),v={anonym_flag:h["\uc775\uba85 \uc124\uc815"],anonym_desc:h["\u203b \uc775\uba85 \uc124\uc815\uc740 \ub098\uc911\uc5d0 \ubcc0\uacbd\ud558\uc2e4 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],public_writer_for_post:h["\uac8c\uc2dc\ubb3c \uc791\uc131\uc790 \uacf5\uac1c \uc124\uc815 \ud5c8\uc6a9"],public_writer_for_post_comment:h["\ub313\uae00 \uc791\uc131\uc790 \uacf5\uac1c \uc124\uc815 \ud5c8\uc6a9"],all_user_option:p["\uc804\uccb4 \uc0ac\uc6a9\uc790"],specific_user_option:h["\uc0ac\uc6a9\uc790 \uc124\uc815"],me:h["\ub098"],board_add:h["\uac8c\uc2dc\ud310 \ucd94\uac00"],board_modify:p["\uac8c\uc2dc\ud310 \uc124\uc815"],board_add_desc:h["\uac8c\uc2dc\ud310 \ucd94\uac00\ud558\uae30"],search_detail:p["\uc0c1\uc138\uac80\uc0c9"],search:p["\uac80\uc0c9"],where:h["\uac8c\uc2dc\ud310\uadf8\ub8f9"],title:p["\uc81c\ubaa9"],desc:h["\uc124\uba85"],board_desc_null:h["\uac8c\uc2dc\ud310 \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694."],type:h["\uc720\ud615"],classic:h["\ud074\ub798\uc2dd"],feed:h["\ud53c\ub4dc"],manager:h["\uc6b4\uc601\uc790"],manager_add:h["\uc6b4\uc601\uc790 \ucd94\uac00"],manager_select:h["\uc6b4\uc601\uc790 \uc120\ud0dd"],share:h["\uacf5\uc720"],share_desc:h["\uacf5\uc720 \uc124\uba85"],use:h["\uc0ac\uc6a9\ud568"],unuse:p["\uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc74c"],share_dept_desc:h["\uacf5\uc720\ubd80\uc11c\uc9c0\uc815"],share_dept_select:h["\uacf5\uc720\ubd80\uc11c \uc120\ud0dd"],share_low_dept:h["\ud558\uc704 \ubd80\uc11c\uc5d0 \uacf5\uc720\ud568"],perm_write_read:h["\uc5f4\ub78c, \uc791\uc131 \ubaa8\ub450 \ud5c8\uc6a9"],perm_only_read:h["\uc5f4\ub78c\ub9cc \ud5c8\uc6a9"],dept_share:h["\ud2b9\uc815 \ubd80\uc11c\uc640 \uacf5\uc720\ud568"],dept_share_add:h["\uacf5\uc720 \ubd80\uc11c \ucd94\uac00"],close_set:h["\ube44\uacf5\uac1c \uc124\uc815"],open_set_desc:h["\uacf5\uac1c \uc124\uc815 \uc124\uba85"],open_member_desc:h["\uacf5\uac1c \uba64\ubc84 \uc9c0\uc815"],open_dept_member:h["\uacf5\uac1c \ubd80\uc11c \uba64\ubc84 \uc124\uc815"],open_dept_name:h["\ubd80\uc11c\uba85"],open_dept_value:h["\ubd80\uc11c \uacf5\uac1c \uc5ec\ubd80"],open_all:h["\uc804\uccb4\uacf5\uac1c"],open_dept_write_perm:h["\uc791\uc131\uad8c\ud55c"],board_add_confirm:p["\ud655\uc778"],board_add_submit:h["\ub9cc\ub4e4\uae30"],board_add_cancel:p["\ucde8\uc18c"],modify:p["\uc218\uc815"],stop:h["\uc911\uc9c0"],board_stop:h["\uac8c\uc2dc\ud310 \uc911\uc9c0"],board_stop_desc:h["\uac8c\uc2dc\ud310 \uc911\uc9c0 \uc124\uba85"],board_delete:h["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],board_delete_desc:h["\uac8c\uc2dc\ud310 \uc0ad\uc81c \uc124\uc815"],setting:p["\uc124\uc815"],"delete":p["\uc0ad\uc81c"],public_owner:h["\uc5f4\ub78c\uc790 \uc120\ud0dd"],add_public_member:h["\uacf5\uac1c \uba64\ubc84 \ucd94\uac00"],add_anonymous_member:h["\uba64\ubc84 \ucd94\uac00"],save_success:p["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],header:h["\ub9d0\uba38\ub9ac"],header_placeholder:h["\ub9d0\uba38\ub9ac\uba85 \uc785\ub825"],header_add:h["\ub9d0\uba38\ub9ac \ucd94\uac00"],header_subject:h["\ub9d0\uba38\ub9ac \uc81c\ubaa9"],modify_done:p["\uc218\uc815\uc644\ub8cc"],comment_flag:h["\ub313\uae00 \uc791\uc131"],comment_flag_true:p["\ud5c8\uc6a9"],comment_flag_false:p["\ud5c8\uc6a9\ud558\uc9c0 \uc54a\uc74c"],header_required_option:h["\uac8c\uc2dc\ubb3c \ub4f1\ub85d\uc2dc \ubc18\ub4dc\uc2dc \uc120\ud0dd\ud558\uac8c \ud568"],add_board_alert:h["\uac8c\uc2dc\ud310\uc774 \ucd94\uac00\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],select_group:h["\uac8c\uc2dc\ud310\uadf8\ub8f9 \uc120\ud0dd"],send_mail_title:p["\uba54\uc77c\ubc1c\uc1a1 \ud0c0\uc774\ud2c0"],send_mail_tooltip:p["\uba54\uc77c\ubc1c\uc1a1 \ud234\ud301"],yes:p["\uc608"],no:p["\uc544\ub2c8\uc624"],add_member:h["\uc0ac\uc6a9\uc790 \ucd94\uac00"],select_member:h["\uc0ac\uc6a9\uc790 \uc120\ud0dd"],add_member_desc:h["\uc775\uba85 \uc635\uc158 \uc0ac\uc6a9\uc790\ub97c \ucd94\uac00\ud558\uc138\uc694."],anonymous_option_value:h["\uc775\uba85 \uc635\uc158 \uc124\uc815 \uc5ec\ubd80"],settable:h["\uc124\uc815 \ud5c8\uc6a9 \uc5ec\ubd80"],anonymous_option_member:h["\uc775\uba85 \uc635\uc158 \uba64\ubc84 \uc124\uc815"],anonym_tooltip:h["\uc775\uba85 \uc124\uc815 \ud234\ud301"]},m=n.extend({rootKeyName:"communityId",events:function(){return _.extend({"click #publicFlagOptionTable .creat.ic_setup":"addCommunityMember","click #postGroupWrap .creat.ic_setup":"addPostGroup","click #postCommentGroupWrap .creat.ic_setup":"addPostCommentGroup"},n.prototype.events)},initialize:function(e){this.options=e||{},this.boardId=e.boardId,this.communityId=e.communityId,this.boardModel=this._getBoardModel()},render:function(){var t=this,n=null,r=null,i=[],u=!1,a={};if(this.isCreateMode())this.$el.html(s({communityId:this.communityId,isCreate:!0,lang:v,boardLang:h,hidePostAuthOption:u})),this._makeCommunitySelectList().then(_.bind(this._setBoardOperator,this));else{this.boardModel.isManageable()||e.util.error("403",{msgCode:"400-board"}),a.dataset=this.boardModel.toJSON(),$.each(a.dataset.owners,function(e,t){t.ownerType=="Community"?(n=t.ownerInfo,r=t.ownerId):t.ownerType=="User"&&i.push(t)}),_.isArray(a.dataset.pathName)&&(a.dataset.pathInfo=e.util.escapeXssFromHtml(a.dataset.pathName.join(" &gt; "))),this.$el.html(o($.extend(a,{isClassic:function(){return this.dataset.type=="CLASSIC"?!0:!1},isStream:function(){return this.dataset.type=="STREAM"?!0:!1},isAnonym:function(){return this.dataset.anonymFlag?!0:!1},lang:v,boardLang:h,isCreate:!0,communityName:n,communityId:r,hidePostAuthOption:u}))),this.boardDataset(a.dataset);if(i.length){this.$el.find("#publicFlagOptionTable ul.name_tag li.default_option").hide();var l=this.$el.find("#publicFlagOptionTable ul.name_tag");$.each(i,function(e,t){l.find("li.creat").before(f({id:t.ownerId,name:t.ownerInfo,communityId:r,lang:v}))})}else this.$el.find("#publicFlagOptionTable ul.name_tag li.default_option").show()}c.render({el:".content_top",dataset:{name:a.dataset?v.board_modify:v.board_add},isCommunity:!0})},_makeCommunitySelectList:function(){var n=this,r=[],i=t.defer(),s=this.communityId;return $.ajax(e.contextRoot+"api/community/list/menu").then(function(t){_.each(t.data,function(e,t){r.push(n._makeFolderOptionHtml(e.communityId,e.name,parseInt(s)))}),n.$("select[name=communityId]").html(r.join("\n")),i.resolve()}),i.promise},togglePublicWriterPostGroup:function(){var e=this.$el.find("input[name=targetForPost]:radio:checked").val();e=="false"?($("#postGroupWrap").show(),this.setAnonymousPost()):$("#postGroupWrap").hide()},togglePublicWriterPostCommentGroup:function(){var e=this.$el.find("input[name=targetForPostComment]:radio:checked").val();e=="false"?($("#postCommentGroupWrap").show(),this.setAnonymousComment()):$("#postCommentGroupWrap").hide()},setAnonymousPost:function(){var e=[a({lang:v,isCreate:this.isCreateMode()})];this.$el.find("#postGroupWrap").html(e.join("")),this.$el.find("#postGroupWrap ul.name_tag li.default_option").show()},setAnonymousComment:function(){var e=[a({lang:v,isCreate:this.isCreateMode()})];this.$el.find("#postCommentGroupWrap").html(e.join("")),this.$el.find("#postCommentGroupWrap ul.name_tag li.default_option").show()},_addChildNodesSelect:function(e){this.addChildNodesSelect("community")},addBoardManagers:function(){var t=this,n=t.$el.find("[name=communityId]").val();$.goOrgSlide({header:v.manager_select,desc:"",type:"community",contextRoot:e.contextRoot,loadId:n,callback:t.addBoardManagerEl,accessOrg:!0})},addPostGroup:function(t){var n=this,r=n.$el.find("[name=communityId]").val(),i=n.$el.find("#postGroupWrap"),s=i.find("ul.name_tag"),o=s.find("li.default_option"),u=function(e){e&&!s.find('li[data-id="'+e.id+'"]').length&&(e.communityId=r,s.find("li.creat").before(f($.extend(e,{lang:v}))),s.trigger("changePostGroup.public"))};$.goOrgSlide({header:v.add_member,desc:"",type:"community",contextRoot:e.contextRoot,loadId:r,callback:u,accessOrg:!0}),s.bind("changePostGroup.public",function(){s.find("li:not(.creat, .default_option)").length?o.hide():o.show()})},addPostCommentGroup:function(t){var n=this,r=n.$el.find("[name=communityId]").val(),i=n.$el.find("#postCommentGroupWrap"),s=i.find("ul.name_tag"),o=s.find("li.default_option"),u=function(e){e&&!s.find('li[data-id="'+e.id+'"]').length&&(e.communityId=r,s.find("li.creat").before(f($.extend(e,{lang:v}))),s.trigger("changePostCommentGroup.public"))};$.goOrgSlide({header:v.add_member,desc:"",type:"community",contextRoot:e.contextRoot,loadId:r,callback:u,accessOrg:!0}),s.bind("changePostCommentGroup.public",function(){s.find("li:not(.creat, .default_option)").length?o.hide():o.show()})},addCommunityMember:function(t){var n=this,r=n.$el.find("[name=communityId]").val(),i=n.$el.find("#publicFlagOption"),s=i.find("ul.name_tag"),o=s.find("li.default_option"),u=function(e){e&&!s.find('li[data-id="'+e.id+'"]').length&&(e.communityId=r,s.find("li.creat").before(f($.extend(e,{lang:v}))),s.trigger("contentChanged.public"))};$.goOrgSlide({header:v.public_owner,desc:"",type:"community",contextRoot:e.contextRoot,loadId:r,callback:u,accessOrg:!0}),s.bind("contentChanged.public",function(){s.find("li:not(.creat, .default_option)").length?o.hide():o.show()})},setPublicData:function(){var e=[u({lang:v,isCreate:this.isCreateMode()})];this.$el.find("#publicFlagOptionTable").html(e.join("")),this.$el.find("#publicFlagOptionTable ul.name_tag li.default_option").show()},boardDataset:function(e){var t=this,n=this.$el.find('form[name="'+t.formName+'"]');$.each(e.managers,function(e,n){t.addBoardManagerEl(n)}),e.publicFlag&&(this.$el.find('form[name="'+t.formName+'"] input[name="publicFlag"][value="true"]').attr("checked",!0),this.togglePublicFlag()),this.$el.find('input[name="headerFlag"][value="'+e.headerFlag+'"]').attr("checked",!0),this.$el.find('input[name="commentFlag"][value="'+e.commentFlag+'"]').attr("checked",!0),this.$el.find('input[name="sendMailFlag"][value="'+e.sendMailFlag+'"]').attr("checked",!0);if(e.postHeaders.length||e.headerFlag){this.$el.find('input[name="headerRequiredFlag"]').attr("checked",e.headerRequiredFlag),this.toggleHeaderFlag();var r=l({dataset:e.postHeaders,lang:v});t.$el.find("#headerListPart").append(r),t.$el.find('#headerFlagOption tr[data-headerdeleteflag="true"]').hide()}this.togglePublicWriterPostGroup(),this.togglePublicWriterPostCommentGroup(),!_.isUndefined(e.anonymousWriterPostOption)&&!_.isUndefined(e.anonymousWriterPostOption.specificUsers)&&this.getAnonymousOptionTarget(t.$el.find("#postGroupWrap"),e.anonymousWriterPostOption.specificUsers),!_.isUndefined(e.anonymousWriterPostCommentOption)&&!_.isUndefined(e.anonymousWriterPostCommentOption.specificUsers)&&this.getAnonymousOptionTarget(t.$el.find("#postCommentGroupWrap"),e.anonymousWriterPostCommentOption.specificUsers)},getAnonymousOptionTarget:function(e,t){_.each(t,function(t){var n={id:t.userId,displayName:t.name,name:t.name,communityId:this.communityId},r=f($.extend(n,{lang:v}));e.find(".creat").before(r)}),e.find("ul.name_tag li.default_option").hide()},boardSave:function(){var t=this,n=this.$el.find("form[name="+this.formName+"]"),r=n.find("[name=communityId]").val(),i=null,s=[],o=[],u=this.$(".select-node").length>1?this.$(".select-node").last().val():null,a=function(i){if(!t.isSaveDone)return;t.isSaveDone=!1,i.save({},{success:function(n,i){e.EventEmitter.trigger("common","layout:clearOverlay",!0);if(i.code=="200"){t.isCreateMode()?$.goMessage(v.add_board_alert):($.goMessage(v.save_success),e.EventEmitter.trigger("community","changed:sideCommunityBoard",t.deptId));if(n.get("publicFlag")){var s=[],o=_.filter(n.get("owners"),function(e){return e.ownerType=="User"});if(o.length!=0){$.each(n.get("managers"),function(){s.push(this.id)}),s=_.union(s,o);if($.inArray(d.id,s)<0){e.router.navigate("community/"+r,!0);return}}}t.isCreateMode()?e.router.navigate("community/"+r+"/board/"+i.data.id,!0):e.router.navigate("community/"+r+"/board/"+i.data.id+"/admin",!0)}else $.goMessage(i.message);t.isSaveDone=!0},error:function(r,i){e.EventEmitter.trigger("common","layout:clearOverlay",!0);var s=JSON.parse(i.responseText);s.message&&$.goMessage(s.message),s.name=="board.name.duplicated"&&(s.focus="name"),s.focus&&n.find('input[name="'+s.focus+'"]').focus(),t.isSaveDone=!0;return}})};if(!this.boardFormValidation())return!1;e.EventEmitter.trigger("common","layout:setOverlay",!0),i=this.boardModel,this.isCreateMode()?i.set({communityId:r,parentId:u},{silent:!0}):(i.clear(),i.set("id",this.boardId,{silent:!0})),this.publicFlag=null,$(n.serializeArray()).each(function(e,t){t.name=="publicFlag"&&(publicFlag=t.value),t.name=="managerIds"?s.push(t.value):i.set(t.name,t.value,{silent:!0})}),publicFlag&&this.$el.find('#publicFlagOptionTable form[name|="owners"]').each(function(e,t){var n={};$($(t).serializeArray()).each(function(e,t){n[t.name]=t.value}),o.push(n)}),o.push({ownerShip:"MASTER",ownerType:"Community",ownerId:r,permission:3,scope:t.$el.find('form[name|="owners-'+r+'-member"]').length==0||publicFlag=="false"?"ALL":"PART"});var f=[],l=this.$el.find("input[name=headerFlag]:radio:checked").val(),c=this.$el.find("input[name=headerRequiredFlag]").is(":checked"),p=0;l=="true"&&(this.$el.find('tr[data-type="headerPart"]').each(function(e){f.push({id:$(this).attr("data-headerid"),name:$(this).attr("data-headername"),deletedFlag:$(this).attr("data-headerdeleteflag"),sortOrder:e}),$(this).attr("data-headerdeleteflag")=="true"&&p++}),f.length-p<1&&(l=!1,c=!1));var m=$("input[name=publicWriterSettingForPost]:checkbox").is(":checked")||!1,g=$("input[name=publicWriterSettingForPostComment]:checkbox").is(":checked")||!1,y=$("div[name=publicWriterDetailForPost]"),b=$("div[name=publicWriterDetailForPostComment]"),w=y.find("input[name=targetForPost]:radio:checked").val(),E=b.find("input[name=targetForPostComment]:radio:checked").val(),S=[];S=y.find("#postGroupWrap ul.name_tag").find("li");var x=[];S!=undefined&&S.length!=0&&S.each(function(){$(this).attr("data-id")&&x.push({type:"User",typeId:$(this).attr("data-id"),userId:$(this).attr("data-id")})});var T=[];T=b.find("#postCommentGroupWrap ul.name_tag").find("li");var N=[];T!=undefined&&T.length!=0&&T.each(function(){$(this).attr("data-id")&&N.push({type:"User",typeId:$(this).attr("data-id"),userId:$(this).attr("data-id")})});var C=this.createAnonymousOption(m,w,x),k=this.createAnonymousOption(g,E,N);i.set({managerIds:s,owners:o,headerFlag:l,headerRequiredFlag:c,postHeaders:f,anonymFlag:this.$el.find("input[name=anonymFlag]:radio:checked").val()||!1,anonymousWriterPostOption:C,anonymousWriterPostCommentOption:k,postAuthOption:this.$el.find(".postAuthOption:checked").val(),closePostTitleShowOption:this.$el.find(".closePostTitleShowOption:checked").val()},{silent:!0}),i.get("status")=="DELETED"?$.goCaution(h["\uac8c\uc2dc\ud310 \uc0ad\uc81c"],h["\uac8c\uc2dc\ud310 \uc0ad\uc81c \ud655\uc778"],function(){i.destroy({success:function(t,n){e.router.navigate("community/"+r,{trigger:!0,pushState:!0}),e.EventEmitter.trigger("community","changed:sideCommunityBoard",!0)}})}):a(i)},boardSaveCancel:function(){var t=this;if(t.isCreateMode())$.goConfirm(p["\ucde8\uc18c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],p["\uc785\ub825\ud558\uc2e0 \uc815\ubcf4\uac00 \ucd08\uae30\ud654\ub429\ub2c8\ub2e4."],function(){t.render()});else{var n="community/"+t.communityId+"/board/"+t.boardId;e.router.navigate(n,{trigger:!0})}},_getBoardModel:function(){return this.isCreateMode()?new r:i.get(this.boardId)}});return m});