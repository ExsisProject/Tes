define(function(require){var e=require("jquery"),t=require("backbone"),n=require("when"),r=require("app"),i=require("hgn!community/templates/side2"),s=require("community/models/join"),o=require("community/views/side_communities"),u=require("community/views/side_members"),a=require("community/views/members"),f=require("community/views/add_member"),l=require("community/models/info"),c=require("community/models/leave"),h=require("hgn!community/templates/side_info"),p=require("admin/models/community_base_config"),d=require("i18n!board/nls/board"),v=require("i18n!nls/commons"),m=require("i18n!community/nls/community"),d=require("i18n!board/nls/board"),g=require("views/profile_card"),y=require("community/collections/boards"),b=require("components/backdrop/backdrop"),w=require("board/components/board_tree/board_tree"),E=require("community/models/comm_board_tree"),S=w.renderBoardTreeMenuNode;require("jquery.go-sdk");var x=null,T={community_board:d["\ucee4\ubba4\ub2c8\ud2f0\uac8c\uc2dc\ud310"],new_post:d["\uae00\uc4f0\uae30"],new_board:d["\uc0c8 \uac8c\uc2dc\ud310"],board_add:d["\uac8c\uc2dc\ud310 \ucd94\uac00"],community_home:v["\ucee4\ubba4\ub2c8\ud2f0 \ud648\uc73c\ub85c"],community_master:v["\uad00\ub9ac"],community_list:v["\ucee4\ubba4\ub2c8\ud2f0 \ubaa9\ub85d\ubcf4\uae30"],manage_flag:v["\uad00\ub9ac"],board_null:m["\uc0dd\uc131\ub41c \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],community:v["\ucee4\ubba4\ub2c8\ud2f0"],closed_board:d["\uc911\uc9c0\ub41c \uac8c\uc2dc\ud310 \uad00\ub9ac"]},N=w.BoardTreeMenuView,C=N.extend({communityId:null,initialize:function(e){var t=e||{};N.prototype.initialize.apply(this,arguments),this.communityId=null,t.hasOwnProperty("communityId")&&(this.communityId=t.communityId)},renderChildView:function(e){var t=new this.constructor({nodes:this.boardTreeNodes,parentId:e.getNodeId(),menuId:this.getMenuId(),communityId:this.communityId});return t.render(),t},getLinkUrl:function(e){var t="#";return e.isBoardNode()&&(t=["community",this.communityId,"board",e.getBoardId()].join("/")),t}}),k=t.View.extend({el:"#side",events:{"click a.go_board[data-boardId]":"getBoard","click a#writeBtn":"sideWriteBtnAction","click #masterHomeSide":"getCommunityMaster","click #dropDown":"getDropDown","click .communityName":"getCommunityHome","click #communityList":"getCommunityList","click #members":"getMember","click #memberDelete":"deleteMember","click #memberInvite":"addMember","click .btn-setting":"getBoardAdmin","click a.memberPhoto":"showProfileCard","click #addBoard":"createBoard","click .go_closedBoard":"goClosedBoard","click #communityHome":"communityHome"},initialize:function(){this.commBoardList=new E.Collection,this.$el.off()},goClosedBoard:function(t){var n=e(t.currentTarget).attr("data-communityid");r.router.navigate("community/"+n+"/board/closedList",!0),e("html, body").animate({scrollTop:0})},showProfileCard:function(t){var n=e(t.currentTarget).attr("data-userId");g.render(n,t.currentTarget)},render:function(e,t){this.boardId=t;var n=i({lang:T,context_root:r.config("contextRoot"),appName:r.util.getAppName("community")});this.$el.html(n),this.communityId=e,this.renderInfo(e),o.render({communityId:e}),u.render(e),this.renderBoards(e),this._selectSideMenu(),r.EventEmitter.off("boardTree","changed:nodes"),r.EventEmitter.on("boardTree","changed:nodes",function(){this.renderBoards(e),this._selectSideMenu()},this),r.EventEmitter.off("board","changed:deptBoard"),r.EventEmitter.on("board","changed:deptBoard",function(){this.renderBoards(e),this._selectSideMenu()},this),r.EventEmitter.off("community","changed:sideCommunityBoard"),r.EventEmitter.on("community","changed:sideCommunityBoard",function(){this.renderBoards(e),this._selectSideMenu()},this),r.EventEmitter.on("board","changed:lastPostedAt",function(){this.addNewIcon(arguments.length>0?arguments[0]:"")},this);var s=p.create();s.set({admin:!1}),s.fetch({success:function(e){var t=e.toJSON();r.config("attachNumberLimit",t.attachNumberLimit),r.config("attachSizeLimit",t.attachSizeLimit),r.config("maxAttachNumber",t.maxAttachNumber),r.config("maxAttachSize",t.maxAttachSize),r.config("excludeExtension",t.excludeExtension?t.excludeExtension:"")}})},renderInfo:function(t){this.model=l.read({communityId:t});var n=this.model.toJSON();n.communityId==undefined&&(r.router.navigate("community",{trigger:!0,pushState:!0}),e.goAlert(m["\uc0dd\uc131\ub41c \ucee4\ubba4\ub2c8\ud2f0\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."],"")),n.status=="WAIT"?(r.router.navigate("community",{trigger:!0,pushState:!0}),e.goAlert(m["\ucee4\ubba4\ub2c8\ud2f0 \uac1c\uc124 \uc2e0\uccad\uc774 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],m["\uad00\ub9ac\uc790\uc758 \uc2b9\uc778\uc774 \ud544\uc694\ud569\ub2c8\ub2e4."])):n.publicFlag==0&&n.memberStatus!="ONLINE"&&(r.router.navigate("community",{trigger:!0,pushState:!0}),e.goAlert(m["\uc544\uc9c1 \uac00\uc785\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],m["\ucee4\ubba4\ub2c8\ud2f0 \uad00\ub9ac\uc790\uc758 \uc2b9\uc778\uc774 \ud544\uc694\ud569\ub2c8\ub2e4."]));var i=this,s=h({lang:T,model:n,isMemberTypeMaster:function(){return i.model.get("memberType")=="MASTER"||i.model.get("memberType")=="MODERATOR"?!0:!1}});n.memberStatus=="NONE"?(e("#writeBtn span.txt").text(m["\uac00\uc785\ud558\uae30"]),e("#writeBtn span.ic_side").removeClass("ic_app_bbs").addClass("ic_app_join")):n.memberStatus=="WAIT"&&(e("#writeBtn span.txt").text(m["\uac00\uc785\uc9c4\ud589\uc911"]),e("#writeBtn span.ic_side").removeClass("ic_app_bbs").addClass("ic_app_join")),e("#sideNav").append(s)},renderBoards:function(t){var i=this,s=this.commBoardList,o=this.$("#communitySide"),u=o.find("ul"),a=[];return s.setCommunityId(t),u.empty(),n.promise(function(e,n){s.fetch({success:function(n){if(n.length<1)return;n.each(function(e){var n=e.getBoardTreeNodes();if(n.length>0){var r=["communty",t].join("."),s=i._renderMenuTree(n,r);u.show(),a.push(s.el)}});if(n.hasClosedBoards()){var s=r.config("contextRoot")+"app/community/"+t+"/board/closedList";a.push(i._renderClosedBoardLink(s))}u.append.apply(u,a),e()},error:n})}).then(function(){return i._selectSideMenu(),e("#side").find(".select_nav").attr("data-memberStatus")!="ONLINE"&&i.$el.find("div.list_action").remove(),n.resolve()})},_renderMenuTree:function(e,t){var n=new C({communityId:this.communityId,nodes:e,menuId:t});return n.render(),n},_renderClosedBoardLink:function(t){return e(S({nodeType:"LINK",nodeValue:T.closed_board,iconType:"closed",linkUrl:t,managable:!1}))},getCommunityHome:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"getCommunityHome"):this.goGetCommunityHome(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"getCommunityHome"):this.goGetCommunityHome(t)},goGetCommunityHome:function(t){var n=e(t.currentTarget).parents("li"),i=n.attr("data-id"),s=n.attr("data-status"),o=n.attr("data-publicFlag");memberStatus=n.attr("data-memberStatus"),s=="WAIT"?e.goAlert(m["\uc544\uc9c1 \uac1c\uc124\uc774 \uc2b9\uc778\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],m["\uad00\ub9ac\uc790\uc758 \uc2b9\uc778\uc774 \ud544\uc694\ud569\ub2c8\ub2e4."]):o=="false"&&memberStatus!="ONLINE"?e.goAlert(m["\uc544\uc9c1 \uac00\uc785\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."],m["\ucee4\ubba4\ub2c8\ud2f0 \uad00\ub9ac\uc790\uc758 \uc2b9\uc778\uc774 \ud544\uc694\ud569\ub2c8\ub2e4."]):r.router.navigate("community/"+i,!0)},getCommunityMaster:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"getCommunityMaster"):this.goGetCommunityMaster(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"getCommunityMaster"):this.goGetCommunityMaster(t)},goGetCommunityMaster:function(t){separatorli=e(t.currentTarget).parents("span.select_nav"),communityId=separatorli.attr("data-id"),r.router.navigate("community/"+communityId+"/admin",!0)},getCommunityList:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"getCommunityList"):this.goGetCommunityList(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"getCommunityList"):this.goGetCommunityList(t)},goGetCommunityList:function(e){r.router.navigate("community",!0)},getMember:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"getMember"):this.goGetMember(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"getMember"):this.goGetMember(t)},goGetMember:function(e){var t=this.$el.find(".select_nav").attr("data-id");r.router.navigate("community/"+t+"/member",!0)},deleteMember:function(t){var n=this.$el.find(".select_nav").attr("data-id"),i=this.$el.find(".select_nav").attr("data-memberType");i=="MASTER"?e.goConfirm(m["\ud604\uc7ac \ucee4\ubba4\ub2c8\ud2f0 \ub9c8\uc2a4\ud130\uc785\ub2c8\ub2e4."],m["\ub9c8\uc2a4\ud130 \uad8c\ud55c\uc744 \uc591\ub3c4\ud55c \ud6c4\uc5d0 \ud0c8\ud1f4\uac00 \uac00\ub2a5\ud569\ub2c8\ub2e4. \uad00\ub9ac \ud398\uc774\uc9c0\ub85c \uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],function(){r.router.navigate("community/"+n+"/admin",!0)}):e.goCaution(m["\ud604\uc7ac \ucee4\ubba4\ub2c8\ud2f0\uc5d0\uc11c \ud0c8\ud1f4\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],m["\ud0c8\ud1f4\ud558\uc5ec\ub3c4 \uc774\uc804\uc5d0 \uc791\uc131\ud558\uc600\ub358 \uac8c\uc2dc\ubb3c\ub4e4\uc740 \uc720\uc9c0\ub429\ub2c8\ub2e4."],function(){var t=this;this.model=new c,this.model.set("communityId",n,{silent:!0}),this.model.save({},{type:"DELETE",success:function(e,t){t.code=="200"&&r.router.navigate("community",!0)},error:function(t,i){var s=JSON.parse(i.responseText);s.name=="already.community.master"&&e.goConfirm(m["\ud604\uc7ac \ucee4\ubba4\ub2c8\ud2f0 \ub9c8\uc2a4\ud130\uc785\ub2c8\ub2e4."],m["\ub9c8\uc2a4\ud130 \uad8c\ud55c\uc744 \uc591\ub3c4\ud55c \ud6c4\uc5d0 \ud0c8\ud1f4\uac00 \uac00\ub2a5\ud569\ub2c8\ub2e4. \uad00\ub9ac \ud398\uc774\uc9c0\ub85c \uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],function(){r.router.navigate("community/"+n+"/admin",!0)},v["\ud655\uc778"])}})},v["\ud655\uc778"])},addMember:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"addMember"):this.goAddMember(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"addMember"):this.goAddMember(t)},goAddMember:function(e){var t=this.$el.find(".select_nav").attr("data-id");r.router.navigate("community/"+t+"/invite",{trigger:!0,pushState:!0})},getDropDown:function(){this.backdropView||(this.backdropView=new b,this.backdropView.backdropToggleEl=this.$("ul[el-backdrop]"),this.backdropView.linkBackdrop(this.$("span[el-backdrop-link]")))},getBoard:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"getBoard"):this.goGetBoard(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"getBoard"):this.goGetBoard(t)},goGetBoard:function(t){var n=e(t.currentTarget);n.attr("data-boardId")&&(r.router.navigate("community/"+this.communityId+"/board/"+n.attr("data-boardId"),!0),e("html, body").animate({scrollTop:0}))},sideWriteBtnAction:function(t){var n=e(t.currentTarget).parent().parent(),i=n.find("p.on .go_board").attr("data-boardId"),o=n.find("ul.side_depth li[data-type=BOARD]").length,u=this.$el.find(".select_nav").attr("data-memberStatus"),a=this.$el.find(".select_nav").attr("data-id"),f=this;if(u=="ONLINE")if(o<=0)e.goMessage(m["\ub4f1\ub85d\ub41c \uac8c\uc2dc\ud310\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."]);else{var l="";i?l="community/"+this.communityId+"/board/"+i+"/post/write":l="community/"+this.communityId+"/board/post/write";var h=function(){r.router.navigate(l,!0)};r.util.editorConfirm(h)}else u=="WAIT"?e.goConfirm(m["\uac00\uc785 \ucde8\uc18c\ub97c \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],"",function(){this.model=new c,this.model.set("communityId",a,{silent:!0}),this.model.save({},{type:"DELETE",success:function(t,n){n.code=="200"&&(e.goMessage(m["\ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),f.render(f.communityId))},error:function(t,n){n.msg&&e.goAlert(n.msg),n.focus&&form.find('input[name="'+n.focus+'"]').focus()}})}):e.goConfirm(m["\uac00\uc785\uc744 \uc2e0\uccad\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],m["\ucee4\ubba4\ub2c8\ud2f0 \uac00\uc785\uc740 \uad00\ub9ac\uc790\uc758 \uc2b9\uc778\uc774 \ud544\uc694\ud569\ub2c8\ub2e4."],function(){this.model=new s,this.model.set("communityId",a,{silent:!0}),this.model.save({},{success:function(t,n){n.code=="200"&&(e.goMessage(m["\uac00\uc785\uc2e0\uccad \uc644\ub8cc"]),f.render(f.communityId))},error:function(t,n){n.msg&&e.goAlert(n.msg),n.focus&&form.find('input[name="'+n.focus+'"]').focus()}})})},createBoard:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"createBoard"):this.goCreateBoard(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"createBoard"):this.goCreateBoard(t)},goCreateBoard:function(e){r.router.navigate("community/"+this.communityId+"/board/create",{trigger:!0,pushState:!0})},getBoardAdmin:function(t){r.util.hasActiveEditor()?r.util.isEditorWriting()?this.wirtePageMovePopup(t,"getBoardAdmin"):this.goGetBoardAdmin(t):e("#feedContent").val()&&e("#feedContent").val()!=d["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]?this.wirtePageMovePopup(t,"getBoardAdmin"):this.goGetBoardAdmin(t)},goGetBoardAdmin:function(t){var n=e(t.currentTarget),i=n.data("id");n.data("type")||(i=n.data("boardid")),r.router.navigate("community/"+this.communityId+"/board/"+i+"/admin",{trigger:!0,pushState:!0})},communityCreate:function(){r.router.navigate("community/create",!0)},_selectSideMenu:function(){var e=r.router.getUrl().split("?"),t=e[0].split("/");if(t[2]=="board"&&t[3]!="closedList"){this.$el.find(".on").removeClass("on");var n=this.$el.find('#communitySide li[data-type=BOARD] a[data-id="'+t[3]+'"]');n.length&&n.parent().addClass("on")}else if(t[3]=="closedList"){this.$el.find(".on").removeClass("on");var n=this.$el.find("#communitySide li[data-type=LINK] a");n.length&&n.parent().addClass("on")}else this.$el.find(".on").removeClass("on"),this.$el.find("#goClosedBoard p").addClass("on");return},wirtePageMovePopup:function(t,n){var i=this;e.goPopup({title:"",message:d["\ud604\uc7ac \uc791\uc131\uc911\uc778 \ub0b4\uc6a9\uc774 \uc788\uc2b5\ub2c8\ub2e4.<br>\ud654\uba74 \uc774\ub3d9 \uc2dc \uc791\uc131 \uc911\uc778 \ub0b4\uc6a9\uc740 \uc0ac\ub77c\uc9d1\ub2c8\ub2e4.<br>\uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],modal:!0,buttons:[{btext:v["\ud655\uc778"],btype:"confirm",callback:function(){if(n=="getBoardAdmin"){var s=e(t.currentTarget).attr("data-id");r.router.navigate("community/"+i.communityId+"/board/"+s+"/admin",{trigger:!0,pushState:!0})}else if(n=="addMember")i.goAddMember(t);else if(n=="getMember")i.goGetMember(t);else if(n=="getCommunityMaster")i.goGetCommunityMaster(t);else if(n=="getCommunityList")i.goGetCommunityList(t);else if(n=="getCommunityHome")i.goGetCommunityHome(t);else if(n=="getBoard"){var s=e(t.currentTarget).find("a.go_board").attr("data-boardId");r.router.navigate("community/"+i.communityId+"/board/"+s,!0),e("html, body").animate({scrollTop:0})}else n=="createBoard"&&i.goCreateBoard(t)}},{btext:v["\ucde8\uc18c"],btype:"normal",callback:function(){}}]})},addNewIcon:function(e){if(!e)return!1;this.render(this.communityId);return},communityHome:function(){var e=function(){r.router.navigate(r.contextRoot+"community",!0)};r.util.editorConfirm(e)},_clickBtnSettingHandler:function(t){var n=e(t.currentTarget),r=n.data("type");switch(r){case"BOARD":this.getBoardAdmin(t);break;default:}}},{create:function(){return x===null&&(x=new layoutView),x.render()}});return k});