define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("community/models/community_info"),i=require("community/collections/community_boards"),s=require("hgn!board/templates/mobile/m_side"),o=require("i18n!board/nls/board"),u=require("i18n!nls/commons"),a=require("community/models/comm_board_tree"),f=require("board/components/board_tree/board_tree"),l=f.MobileBoardTreeMenuView,c=l.extend({communityId:null,initialize:function(e){var t=e||{};l.prototype.initialize.apply(this,arguments),this.communityId=null,t.hasOwnProperty("communityId")&&(this.communityId=t.communityId)},renderChildView:function(e){var t=new this.constructor({nodes:this.boardTreeNodes,parentId:e.getNodeId(),communityId:this.communityId,menuId:this.menuId});return t.render(),t},getLinkUrl:function(e){var t="#";return e.isBoardNode()&&(t=["community",this.communityId,"board",e.getBoardId()].join("/")),t}}),h=function(){var e='<h3><span class="btn_wrap"><span class="txt_ellipsis">{{title}}</span></span></h3>',t=Hogan.compile(e);return t.render.apply(t,arguments)},p=t.View.extend({unBindEvent:function(){this.$el.off("vclick","h3")},bindEvent:function(){this.$el.on("vclick","h3",e.proxy(this.goCommunityHome,this))},initialize:function(e){var t=this;this.$el.off(),this.options=e||{},this.collection=new a.Collection,this.collection.on("reset",function(e,n){t.renderBoardsList()})},render:function(t){var n=this;this.packageName=this.options.packageName;var i=e.Deferred();return this.communityId!=t.communityId?(this.communityId=t.communityId,this.model=r.read({communityId:this.communityId}),this.collection.communityId=this.communityId,this.collection.fetch({data:{offset:100,page:0},reset:!0}).done(function(){i.resolveWith(n,[n])}),this.setSideApp()):i.resolveWith(this,[this]),this.unBindEvent(),this.bindEvent(),i},renderBoardsList:function(){this.collection.each(function(e){var t=e.getBoardTreeNodes(),n=t.filter(function(e){return!e.isSeperatorNode()}),r=["communty",this.communityId].join("."),i=this._renderMenuTree(n,r);this.$el.append(h({title:this.model.get("name")}),i.el)},this)},_renderMenuTree:function(e,t){var n=new c({communityId:this.communityId,nodes:e,menuId:t});return n.$el.addClass("side_depth"),n.render(),n},setSideApp:function(){e("body").data("sideApp",this.packageName)},goCommunityHome:function(t){return e(t).focusout().blur(),n.router.navigate("community/"+this.communityId,!0),!1},goBoard:function(t){debugger;var r=e(t.currentTarget),i=r.attr("href");return t.preventDefault(),t.stopPropagation(),i&&i!=="#"&&n.router.navigate(i,{trigger:!0}),!1}},{__instance__:null,create:function(e){return this.__instance__=new this.prototype.constructor({packageName:e}),this.__instance__}});return p});