nhn.husky.SE_FormEditor=jindo.$Class({name:"SE_FormEditor",bUsePallet:!0,agreementKey:"data-is-agreement",receptionKey:"data-is-reception",$init:function(e,t){this._assignHTMLObjects(e,t),this.approvalTpl={type1:["<td>",'<table class="sign_member">',"<tbody>",'<tr><td><span class="sign_rank">{userPosition}</span></td></tr>','<tr><td class="wrap_name"><span class="sign_name" id="status_{userId}">{userName}</span></td></tr>','<tr><td class="last"><span class="sign_date" id="date_{userId}"></span></td></tr>',"</tbody>","</table>","</td>"],type2:['<span class="sign_member">','<span class="department">{deptName}</span>','<span class="part">|</span>','<span class="name">{userName} {userPosition}</span>','<span class="status" id="status_{userId}"></span>','<span class="date" id="date_{userId}"></span>',"</span>"]}},_assignHTMLObjects:function(e,t){e=$(e)||document,this.oButtonDSL=cssquery(".editor_dsl",e),this.oButtonTab=cssquery("ul.tab_pallet li",e),this.oButtonDelete=cssquery(".ic_undo",e),this.oButtonApproval=cssquery(".custom_approval",e),this.oButtonAgreeMent=cssquery(".custom_agreement",e),this.oButtonLIDSL=cssquery("li.editor_dsl,li.custom_approval,li.custom_agreement",e)},_template:function(e,t){return e.replace(/{(\w*)}/g,function(e,n){return t.hasOwnProperty(n)?t[n]:""})},$ON_MSG_APP_READY:function(){var e=$$("div.husky_seditor_editing_area_container")[0].style.height;this.oApp.registerBrowserEvent(this.oButtonDSL,"click","PASTE_DSL"),this.oApp.registerBrowserEvent(this.oButtonTab,"click","PALLET_TAB"),this.oApp.registerBrowserEvent(this.oButtonDelete,"click","DELETE_ROOM"),this.oApp.registerBrowserEvent(this.oButtonApproval,"click","PASTE_APPROVAL"),this.oApp.registerBrowserEvent(this.oButtonAgreeMent,"click","PASTE_AGREEMENT"),this.oApp.registerBrowserEvent(this.oButtonLIDSL,"mouseover","MOUSEOVER_COMPO"),this.oApp.registerBrowserEvent(this.oButtonLIDSL,"mouseout","MOUSEOUT_COMPO"),this.oApp.registerBrowserEvent(this.oButtonLIDSL,"mousedown","MOUSEDOWN_COMPO"),this.oApp.registerBrowserEvent(this.oButtonLIDSL,"mouseup","MOUSEUP_COMPO")},$ON_MOUSEDOWN_COMPO:function(e){jindo.$Element(e.currentElement).addClass("liActive")},$ON_MOUSEUP_COMPO:function(e){jindo.$Element(e.currentElement).removeClass("liActive")},$ON_MOUSEOVER_COMPO:function(e){var t=jindo.$Element(e.currentElement).query("input");t&&(t.style.display="")},$ON_MOUSEOUT_COMPO:function(e){jindo.$Element(e.currentElement).removeClass("liActive");var t=jindo.$Element(e.currentElement).query("input");t&&(t.style.display="none")},$ON_PALLET_TAB:function(e){var t=cssquery("li"),n=cssquery("ul.pallet_item"),r=jindo.$Element(e.element).attr("data-tab");for(var i=0;i<t.length;i++)jindo.$Element(t[i]).removeClass("selected");for(var s=0;s<n.length;s++)jindo.$Element(n[s]).hide();jindo.$Element(e.element).addClass("selected"),jindo.$Element(r).show()},validAutoType:function(e,t){if(t.indexOf("radio$autotype$")!=-1||t.indexOf("cSel$autotype$")!=-1)if(e.indexOf("radio$autotype$")!=-1||e.indexOf("cSel$autotype$")!=-1)return!1;return e.indexOf("currency$autotype$")!=-1&&t.indexOf("currency$autotype$")!=-1?!1:!0},validOfficialComponent:function(e,t){return t.indexOf("officialDocSender")!=-1||t.indexOf("officialDocSign")!=-1?!1:!0},$ON_PASTE_DSL:function(e){var t=jindo.$Element(e.element).attr("data-type"),n=jindo.$Element(e.element).attr("data-dup");if(n=="false"){var r=this.oApp.getContents();if(r.match(t)){alert(this.oApp.$MSG("SE_Approval.DupError"));return}if(!this.validAutoType(t,r)){alert(this.oApp.$MSG("SE_Approval.DupError"));return}if(!this.validOfficialComponent(t,r)){alert(this.oApp.$MSG("SE_Approval.OfficialError"));return}}if(t.search("cOrg")>=0){var i=this.oApp.getContents().match(/cOrg:([0-9]*)/g),s=i?i:[],o=[],u=0;for(var a=0;a<s.length;a++){var f=s[a].split(":")[1];f&&o.push(parseInt(f))}o.length>0&&(u=o.sort(function(e,t){return t-e})[0]+1);var l=jindo.$Element(e.element).attr("data-orgtype");t="{{cOrg:"+u+l+"}}"}var c=this.oApp.getSelection();if(c.startContainer===c.endContainer&&c.startContainer.nodeType===3&&c.startContainer.tagName!=="BODY"&&c.startContainer.parentNode.nodeName==="P"){var h=c.getLineInfo(!1);oStart=h.oStart,oEnd=h.oEnd;var p=/BODY|TD|LI/i,d,v;oStart.bParentBreak&&!p.test(oStart.oLineBreaker.tagName)?d=oStart.oNode.parentNode:d=oStart.oNode,oEnd.bParentBreak&&!p.test(oEnd.oLineBreaker.tagName)?v=oEnd.oNode.parentNode:v=oEnd.oNode,c.setStartBefore(d),c.setEndAfter(v);var m=c.commonAncestorContainer;m.innerHTML=""}this.oApp.exec("PASTE_HTML",[t])},$ON_DELETE_ROOM:function(e){e._event.stopPropagation();var t=jindo.$Element(e.element).parent().child(),n;for(var r=0;r<t.length;r++)if(t[r].tag==="button"){n=t[r];break}var i=n.attr("data-type"),s=jindo.$Element(this.oApp.getContents()).$value(),o=this._getApprovalRoom($Json(n.attr("data-info")),i,s);this._deleteRoom(o,s)},_getApprovalRoom:function(e,t,n){e=e.$value(),n=n||jindo.$Element(this.oApp.getContents()).$value();var r='[data-group-seq="'+e.seq+'"]';return e.hasOwnProperty("isAgreement")?r+="["+this.agreementKey+'="true"]':e.isReception&&(r+="["+this.receptionKey+'="true"]'),t&&(r+='[data-group-type="'+t+'"]'),n.querySelectorAll(r)},_replaceRoom:function(e,t,n){for(var r=0;r<e.length;r++)e[r].outerHTML=t,r&&e[r].remove();this.oApp.setContents(jindo.$Element(n).html())},_deleteRoom:function(e,t){for(var n=0;n<e.length;n++)e[n].parentNode.removeChild(e[n]);this.oApp.setContents(jindo.$Element(t).html())},_pasteRoom:function(e){var t=jindo.$Element(e.element),n=t.attr("data-type"),r=$Json(t.attr("data-info"));if(!r._object)return;var i=!1,s=jindo.$Element(this.oApp.getContents()).$value(),o=this._getApprovalRoom(r,null,s);for(var u=0;u<o.length;u++){var a=o[u].getAttribute("data-group-type");if(n===a){i=!0;break}}if(i){alert(this.oApp.$MSG("SE_Approval.DupError"));return}var f=!!o.length&&!i;if(f){var l=this._makeRoomTemplate(n,r);this._replaceRoom(o,l,s);return}var c=this._makeRoomTemplate(n,r);this._pasteApprovalTpl(c)},_makeRoomTemplate:function(e,t){var n=parseInt(t.get("maxApprovalCount")),r=t.get("name"),i=t.get("seq"),s,o;e=="type2"?(o=this.approvalTpl.type2,s=""):(o=this.approvalTpl.type1,s="<th>"+r+"</th>");for(var u=0;u<n;u++)s+=this._template(o.join(""),{userPosition:"",userName:"",deptName:"",userId:""});e=="type1"&&(s=['<table class="tb_sign_'+e+'">',"<tbody>","<tr>",s,"</tr>","</tbody>","</table>"].join(""));var a,f=e=="type1"?"div":"span",l=t.$value(),c="<"+f+' class="sign_'+e+' sign_type_new" data-group-seq="'+i+'" data-group-name="'+r+'" data-group-max-count="'+n+'" data-group-type="'+e+'" ';if(l.hasOwnProperty("isAgreement")){var h=t.get("isAgreement");a=c+this.agreementKey+'="'+h+'" id="agreementWrap'}else{var p=t.get("isReception");a=c+this.receptionKey+'="'+p}return a+='">'+s+"</"+f+">",a},$ON_PASTE_APPROVAL:function(e){this._pasteRoom(e)},$ON_PASTE_AGREEMENT:function(e){this._pasteRoom(e)},_pasteApprovalTpl:function(e){var t=this.oApp.getWYSIWYGDocument().createElement("DIV");t.innerHTML=e;var n=t.firstChild,r=this.oApp.getWYSIWYGDocument().createElement("DIV"),i=this.oApp.getSelection();i.insertNode(r),i.selectNode(r);var s=jindo.$Agent().navigator();s.ie&&this.oApp.getWYSIWYGDocument().body.childNodes.length===1&&this.oApp.getWYSIWYGDocument().body.firstChild===r?r.insertBefore(n,null):(r.parentNode.insertBefore(n,r),r.parentNode.removeChild(r))}});