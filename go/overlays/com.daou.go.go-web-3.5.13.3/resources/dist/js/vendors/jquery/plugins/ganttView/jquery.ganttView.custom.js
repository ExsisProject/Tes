/*
jQuery.ganttView v.0.8.8
Copyright (c) 2010 JC Grubbs - jc.grubbs@devmynd.com
MIT License Applies
*/

(function(e){function t(t){function u(){var t=s.getMinMaxDateFromData(o.data);o.start=t[0],o.end=t[1];var i=new Date,u=i.clone().addMonths(-1),a=i.clone().addMonths(6);o.start>=i?(o.start=u,o.end=o.end.clone().addMonths(6)):(o.start=o.start.clone().addMonths(-1),o.end<=i?o.end=a:o.end=o.end.clone().addMonths(6));var f=e("<div>",{"class":"ganttview"});(new r(f,o)).render();var l=n;return l.append(f),o}var n=this,i={weekday:["S","M","T","W","T","F","S"],cellWidth:20,cellHeight:20,behavior:{clickable:!0,draggable:!0,resizable:!0,resizableDirection:"e,w"}},o=e.extend(!0,i,t);return u()}function n(t,n){if(t=="applyBehavior"){var r=e(this);(new i(r,n)).apply()}}e.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);if(e.length==1&&typeof e[0]=="object")return t.call(this,e[0]);e.length==2&&typeof e[0]=="string"&&n.call(this,e[0],e[1])};var r=function(t,n){function r(){var r=e("<div>",{"class":"ganttview-slide-container",css:{width:"100%"}}),s=i(n.start,n.end);o(r,s,n.cellWidth,n.weekday,n.contentHeight);var l=e("<div>",{"class":"ganttview-contents",id:"gantt_graph_contents",css:{height:n.contentHeight+"px"}});r.append(l),u(l,n.data,s,n.cellWidth),a(l,n.data),f(l,n.data,n.cellWidth,n.start,n.end),t.append(r),c(t.parent())}function i(e,t){var n=[];n[e.getFullYear()]=[],n[e.getFullYear()][e.getMonth()]=[e];var r=e;while(r.compareTo(t)==-1){var i=r.clone().addDays(1);n[i.getFullYear()]||(n[i.getFullYear()]=[]),n[i.getFullYear()][i.getMonth()]||(n[i.getFullYear()][i.getMonth()]=[]),n[i.getFullYear()][i.getMonth()].push(i),r=i}return n}function o(t,n,r,i,o){var u=0,a=[],f=[],l=[];n.map(function(e,t){e.map(function(e,n){var c=e.length*r;u+=c;var h="<div style='width:"+c+"px"+"' class='ganttview-hzheader-month'>"+t+"-"+(parseInt(n)+1)+"</div>";l.push(h),e.map(function(e,t,n){var r=["ganttview-hzheader-day"];s.isToday(e)&&r.push("today"),s.isLastOfMonth(n,t)&&r.push("month"),s.isSaturday(e)?r.push("sat"):s.isSunday(e)&&r.push("sun");var u="<div class='"+r.join(" ")+"'>"+e.getDate()+"</div>";a.push(u);var l="<div style='height:"+o+"px"+"' class='"+r.join(" ")+"'>"+i[e.getDay()]+"</div>";f.push(l)})})});var c="<div style='width:"+u+"px"+"' class='ganttview-hzheader-months'>"+l.join("")+"</div>",h="<div style='width:"+u+"px"+"' class='ganttview-hzheader-days'>"+a.join("")+"</div>",p="<div style='width:"+u+"px"+"' class='ganttview-hzheader-days week'>"+f.join("")+"</div>",d="<div style='width:"+u+"px"+"' class='ganttview-hzheader'>"+c+h+p+"</div>";t.append(e(d))}function u(t,n,r,i){var s=[],o=0;r.map(function(e){e.map(function(e){o+=e.length})});var u=[];u.push("<div class='ganttview-grid-row totalProgressRow'></div>");var a=s.join("");e.each(n,function(t,n){if(!n.type)return;e.each(n.series,function(e,t){var n="<div class='ganttview-grid-row";!_.isEmpty(t)&&_.isUndefined(t.parent_id)&&(n+=" folder"),n+="'",!_.isEmpty(t)&&!_.isUndefined(t.parent_id)&&(n+=" parent-id="+t.parent_id),n+=">"+a+"</div>",u.push(n)})});var f=o*i,l="<div style='width:"+f+"px"+"' class='ganttview-grid'>"+u.join("")+"</div>";t.append(l)}function a(t,n){var r=[];r.push("<div class='ganttview-block-container totalProgressRow'></div>"),e.each(n,function(t,i){if(!i.type)return;var s=n.length-1==t;e.each(i.series,function(e,t){var n="<div class='ganttview-block-container";s&&(n+=" last"),n+="'",!_.isEmpty(t)&&!_.isUndefined(t.parent_id)&&(n+=" parent-id="+t.parent_id),n+="></div>",r.push(n)})});var i="<div class='ganttview-blocks'>"+r.join("")+"</div>";t.append(i)}function f(t,n,r,i,o){var u=e("div.ganttview-blocks div.ganttview-block-container",t).not(".totalProgressRow"),a=0,f="<div class='bookmark left'><span class='ic_set ic_arrow_prev'></span></div>",c="<div class='bookmark right'><span class='ic_set ic_arrow_next'></span></div>";e.each(n,function(t,o){e.each(o.series,function(o,h){if(h.start==null||h.end==null)return a++,!0;var p=s.daysBetween(h.start,h.end)+1,d=s.daysBetween(i,h.start),v=p*r-3,m=d*r+1,g="ganttview-block";h.status_color&&(g+=" bgcolor"+h.status_color);var y="<div class='"+g+"' data-id='"+h.id+"' title='"+h.name+"' style='width:"+v+"px;"+"margin-left:"+m+"px;"+"'>";if(h.progress){var b="<div class='ganttview-block-progress' style='width:"+h.progress+"%"+"'></div>";y+=b}var w="<div class='ganttview-block-text'>";if(h.status_name){var E="<span class='state'>["+h.status_name+"]"+"</span>";w+=E}w+="<span class='txt'>"+h.name+"</span>",w+="</div>",y+=w;var S=e(y);l(S,n[t],h),e(u[a]).append(f+c),e(u[a]).append(S),a++})})}function l(t,n,r){var i={id:n.id,name:n.name};e.extend(i,r),t.data("block-data",i)}function c(t){e("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",t).addClass("last"),e("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",t).addClass("last"),e("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",t).addClass("last")}return{render:r}},i=function(t,n){function r(){n.behavior.clickable&&i(t,n.behavior.onClick),n.behavior.resizable&&s(t,n.cellWidth,n.start,n.behavior.onResize),n.behavior.draggable&&o(t,n.cellWidth,n.start,n.behavior.onDrag)}function i(t,n){e(t).on("click",function(){n&&n(e(this).data("block-data"))})}function s(t,r,i,s){e(t).resizable({grid:r,handles:n.behavior.resizableDirection,stop:function(n,o){var a=e(this);u(t,a,r,i,s,o)}})}function o(t,n,r,i){e(t).draggable({axis:"x",grid:[n,n],stop:function(s,o){var a=e(this);u(t,a,n,r,i,o)}})}function u(e,t,n,r,i,s){var o=s.originalSize?s.originalSize.width:t.css("width"),u=t.css("margin-left");a(e,t,n,r),i&&i(t.data("block-data")).fail($.proxy(function(e,t){$(this).css({width:e,"margin-left":t})},t,o,u))}function a(t,n,r,i){var s=e("div.ganttview-slide-container"),o=s.scrollLeft(),u=n.offset().left-s.offset().left+o,a=Math.round(u/r),f=i.clone().addDays(a);n.data("block-data").start=f;var l=n.outerWidth(),c=Math.round(l/r)-1;n.data("block-data").end=f.clone().addDays(c),n.css({top:"",left:"",position:"relative","margin-left":u+"px"})}return{apply:r}},s={daysBetween:function(e,t){if(!e||!t)return 0;e=Date.parse(e),t=Date.parse(t);if(e.getYear()==1901||t.getYear()==8099)return 0;var n=0,r=e.clone();while(r.compareTo(t)==-1)n+=1,r.addDays(1);return n},isWeekend:function(e){return e.getDay()%6==0},isToday:function(e){var t=new Date;return e.toDateString()==t.toDateString()},isSaturday:function(e){return e.getDay()===6},isSunday:function(e){return e.getDay()===0},isLastOfMonth:function(e,t){return e[e.length-1]==e[t]},getBoundaryDatesFromData:function(e,t){var n=s.getMinMaxDateFromData(e),r=n[0],i=n[1];return s.daysBetween(r,i)<t&&(i=r.clone().addDays(t)),[r,i]},getMinMaxDateFromData:function(t){var n=new Date,r=new Date;return e.each(t,function(t,i){e.each(i.series,function(e,i){var s=i.start,o=i.end;if(s==null||o==null)return!0;var u=Date.parse(s),a=Date.parse(o);t==0&&e==0&&(n=u,r=a),n.compareTo(u)==1&&(n=u),r.compareTo(a)==-1&&(r=a)})}),[n,r]}}})(jQuery);