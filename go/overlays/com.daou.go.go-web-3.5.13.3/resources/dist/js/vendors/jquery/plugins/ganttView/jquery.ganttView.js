/*
jQuery.ganttView v.0.8.8
Copyright (c) 2010 JC Grubbs - jc.grubbs@devmynd.com
MIT License Applies
*/

(function(e){function t(t){function a(){var t=Math.floor(u.slideWidth/u.cellWidth+5),s=o.getBoundaryDatesFromData(u.data,t);u.start=s[0],u.end=s[1],n.each(function(){var t=e(this),n=e("<div>",{"class":"ganttview"});(new r(n,u)).render(),t.append(n);var s=e("div.ganttview-vtheader",t).outerWidth()+e("div.ganttview-slide-container",t).outerWidth();t.css("width",s+2+"px"),(new i(t,u)).apply()})}var n=this,s={showWeekends:!0,cellWidth:21,cellHeight:31,slideWidth:400,vHeaderWidth:100,behavior:{clickable:!0,draggable:!0,resizable:!0}},u=e.extend(!0,s,t);u.data?a():u.dataUrl&&e.getJSON(u.dataUrl,function(e){u.data=e,a()})}function n(e,t){if(e=="setSlideWidth"){var n=$("div.ganttview",this);n.each(function(){var e=$("div.ganttview-vtheader",n).outerWidth();$(n).width(e+t+1),$("div.ganttview-slide-container",this).width(t)})}}e.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);e.length==1&&typeof e[0]=="object"&&t.call(this,e[0]),e.length==2&&typeof e[0]=="string"&&n.call(this,e[0],e[1])};var r=function(t,n){function r(){u(t,n.data,n.cellHeight);var r=e("<div>",{"class":"ganttview-slide-container",css:{width:n.slideWidth+"px"}});dates=s(n.start,n.end),a(r,dates,n.cellWidth),f(r,n.data,dates,n.cellWidth,n.showWeekends),l(r,n.data),c(r,n.data,n.cellWidth,n.start),t.append(r),p(t.parent())}function s(e,t){var n=[];n[e.getFullYear()]=[],n[e.getFullYear()][e.getMonth()]=[e];var r=e;while(r.compareTo(t)==-1){var i=r.clone().addDays(1);n[i.getFullYear()]||(n[i.getFullYear()]=[]),n[i.getFullYear()][i.getMonth()]||(n[i.getFullYear()][i.getMonth()]=[]),n[i.getFullYear()][i.getMonth()].push(i),r=i}return n}function u(t,n,r){var i=e("<div>",{"class":"ganttview-vtheader"});for(var s=0;s<n.length;s++){var o=e("<div>",{"class":"ganttview-vtheader-item"});o.append(e("<div>",{"class":"ganttview-vtheader-item-name",css:{height:n[s].series.length*r+"px"}}).append(n[s].name));var u=e("<div>",{"class":"ganttview-vtheader-series"});for(var a=0;a<n[s].series.length;a++)u.append(e("<div>",{"class":"ganttview-vtheader-series-name"}).append(n[s].series[a].name));o.append(u),i.append(o)}t.append(i)}function a(t,n,r){var s=e("<div>",{"class":"ganttview-hzheader"}),o=e("<div>",{"class":"ganttview-hzheader-months"}),u=e("<div>",{"class":"ganttview-hzheader-days"}),a=0;for(var f in n)for(var l in n[f]){var c=n[f][l].length*r;a+=c,o.append(e("<div>",{"class":"ganttview-hzheader-month",css:{width:c-1+"px"}}).append(i[l]+"/"+f));for(var h in n[f][l])u.append(e("<div>",{"class":"ganttview-hzheader-day"}).append(n[f][l][h].getDate()))}o.css("width",a+"px"),u.css("width",a+"px"),s.append(o).append(u),t.append(s)}function f(t,n,r,i,s){var u=e("<div>",{"class":"ganttview-grid"}),a=e("<div>",{"class":"ganttview-grid-row"});for(var f in r)for(var l in r[f])for(var c in r[f][l]){var h=e("<div>",{"class":"ganttview-grid-row-cell"});o.isWeekend(r[f][l][c])&&s&&h.addClass("ganttview-weekend"),a.append(h)}var p=e("div.ganttview-grid-row-cell",a).length*i;a.css("width",p+"px"),u.css("width",p+"px");for(var d=0;d<n.length;d++)for(var v=0;v<n[d].series.length;v++)u.append(a.clone());t.append(u)}function l(t,n){var r=e("<div>",{"class":"ganttview-blocks"});for(var i=0;i<n.length;i++)for(var s=0;s<n[i].series.length;s++)r.append(e("<div>",{"class":"ganttview-block-container"}));t.append(r)}function c(t,n,r,i){var s=e("div.ganttview-blocks div.ganttview-block-container",t),u=0;for(var a=0;a<n.length;a++)for(var f=0;f<n[a].series.length;f++){var l=n[a].series[f],c=o.daysBetween(l.start,l.end)+1,p=o.daysBetween(i,l.start),d=e("<div>",{"class":"ganttview-block",title:l.name+", "+c+" days",css:{width:c*r-9+"px","margin-left":p*r+3+"px"}});h(d,n[a],l),n[a].series[f].color&&d.css("background-color",n[a].series[f].color),d.append(e("<div>",{"class":"ganttview-block-text"}).text(c)),e(s[u]).append(d),u+=1}}function h(t,n,r){var i={id:n.id,name:n.name};e.extend(i,r),t.data("block-data",i)}function p(t){e("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",t).addClass("last"),e("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",t).addClass("last"),e("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",t).addClass("last")}var i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return{render:r}},i=function(t,n){function r(){n.behavior.clickable&&i(t,n.behavior.onClick),n.behavior.resizable&&s(t,n.cellWidth,n.start,n.behavior.onResize),n.behavior.draggable&&o(t,n.cellWidth,n.start,n.behavior.onDrag)}function i(t,n){e("div.ganttview-block",t).live("click",function(){n&&n(e(this).data("block-data"))})}function s(t,n,r,i){e("div.ganttview-block",t).resizable({grid:n,handles:"e,w",stop:function(){var s=e(this);u(t,s,n,r),i&&i(s.data("block-data"))}})}function o(t,n,r,i){e("div.ganttview-block",t).draggable({axis:"x",grid:[n,n],stop:function(){var s=e(this);u(t,s,n,r),i&&i(s.data("block-data"))}})}function u(t,n,r,i){var s=e("div.ganttview-slide-container",t),o=s.scrollLeft(),u=n.offset().left-s.offset().left-1+o,a=Math.round(u/r),f=i.clone().addDays(a);n.data("block-data").start=f;var l=n.outerWidth(),c=Math.round(l/r)-1;n.data("block-data").end=f.clone().addDays(c),e("div.ganttview-block-text",n).text(c+1),n.css("top","").css("left","").css("position","relative").css("margin-left",u+"px")}return{apply:r}},s={contains:function(e,t){var n=!1;for(var r=0;r<e.length;r++)e[r]==t&&(n=!0);return n}},o={daysBetween:function(e,t){if(!e||!t)return 0;e=Date.parse(e),t=Date.parse(t);if(e.getYear()==1901||t.getYear()==8099)return 0;var n=0,r=e.clone();while(r.compareTo(t)==-1)n+=1,r.addDays(1);return n},isWeekend:function(e){return e.getDay()%6==0},getBoundaryDatesFromData:function(e,t){var n=new Date;maxEnd=new Date;for(var r=0;r<e.length;r++)for(var i=0;i<e[r].series.length;i++){var s=Date.parse(e[r].series[i].start),u=Date.parse(e[r].series[i].end);r==0&&i==0&&(n=s,maxEnd=u),n.compareTo(s)==1&&(n=s),maxEnd.compareTo(u)==-1&&(maxEnd=u)}return o.daysBetween(n,maxEnd)<t&&(maxEnd=n.clone().addDays(t)),[n,maxEnd]}}})(jQuery);