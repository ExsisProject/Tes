(function(){define(["jquery","hogan","app","i18n!calendar/nls/calendar","jquery.ui"],function(e,t,n,r){function c(){var e=[],n;return e.push('<option value="{{option_value}}"{{#selected?}} selected="selected"{{/selected?}}{{#disabled?}} disabled="disabled"{{/disabled?}}>'),e.push("{{option_label}}{{duration}}"),e.push("</option>"),t.compile(e.join("\n"))}var i=30,s={regist:"regist",detail:"detail"},o="YYYY-MM-DD HH:mm",u="YYYY-MM-DD",a="HH:mm",f,l;return f=c(),l=function(){var t=function(t,n,r,s,o){console.log("[DatepickerHelper#constructor] called"),this.options=o||{},this.startDate=t,this.startTime=n,this.endDate=r,this.endTime=s,this.stepOfMinutes=this.options.stepOfMinutes||i,this.afterChangeCallbacks=e.Callbacks(),this._initData(),this._bindDatepicker(),this.delegateEvents(),this.sourceData={startDate:this.startDate.val(),startTime:this.startTime.val(),endDate:this.endDate.val(),endTime:this.endTime.val()}};return t.prototype={delegateEvents:function(){return this.undelegateEvents(),this.startDate.on("change:startdate",e.proxy(this._bindChangeStartDate,this)),this.startTime.on("change.datepicker",e.proxy(this._bindChangeStartTime,this)),this.endDate.on("change:enddate",e.proxy(this._bindChangeEndDate,this)),this.endTime.on("change.datepicker",e.proxy(this._bindChangeEndTime,this)),this},undelegateEvents:function(){return this.startDate.off("change:startdate"),this.startTime.off(".datepicker"),this.endDate.off("change:enddate"),this.endTime.off(".datepicker"),this},setStepOfMinutes:function(e){return this.stepOfMinutes=e,this},updateSelectedTime:function(e,t){var r=n.util.getIntervalTime(e,this.stepOfMinutes);return typeof t=="undefined"&&(t=r.clone().add("hours",1)),this.startTime.attr("data-prev",r.format(a)),this.startTime.empty().html(this._buildStartTimeOptions()),this.endTime.empty().html(this._buildEndTimeOptions(t)),this},getCurrentTimeInfo:function(){return{startTime:this.startDate.val()+"T"+this.startTime.val()+":00",endTime:this.endDate.val()+"T"+this.endTime.val()+":00"}},reset:function(){this.startDate.val(this.sourceData.startDate),this.startTime.val(this.sourceData.startTime),this.endDate.val(this.sourceData.endDate),this.endTime.val(this.sourceData.endTime),this.startDate.attr("data-prev",this.sourceData.startDate),this.startTime.attr("data-prev",this.sourceData.startTime),this.endDate.attr("data-prev",this.sourceData.endDate),this.endTime.attr("data-prev",this.sourceData.endTime)},afterChanged:function(e){this.afterChangeCallbacks.add(e)},_initData:function(){var e=this.endDate.val(),t=this.endTime.attr("data-prev"),r=n.util.toMoment([e,t].join(" "),o);return this.startTime.empty().html(this._buildStartTimeOptions()),this.endTime.empty().html(this._buildEndTimeOptions(r)),this},_buildTimeSlots:function(e){var t=n.util.now().startOf("days"),r=new Array(60/this.stepOfMinutes*24),i=e.split(":")[1];t.add("minutes",parseInt(i));for(var s=0,o=r.length;s<o;s++)r[s]={time:t.format(a)},t.add("minutes",this.stepOfMinutes);return _.where(r,{time:e}).length||(r.push({time:e}),r=_.sortBy(r,function(e){return parseInt((""+e.time).replace(":",""))})),r},_bindDatepicker:function(){var t=this.startDate,r=this.endDate;e.datepicker.setDefaults(e.datepicker.regional[n.config("locale")]),t.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,minDate:this.options.minDate?this.options.minDate:null,yearSuffix:"",onClose:function(e){e&&t.trigger("change:startdate",[e])}}),r.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,minDate:t.val(),yearSuffix:"",onClose:function(e){e&&r.trigger("change:enddate",[e])}})},_processDateConstraint:function(){var e=this.startDate.val(),t=this.endDate.val(),r=this.startDate.attr("data-prev"),i="",s=null;if(t){var a=n.util.toMoment(e+" "+this.startTime.find("option:selected").val(),o),f=n.util.toMoment(r+" "+this.startTime.attr("data-prev"),o),l=moment(t+" "+this.endTime.find("option:selected").val(),o),c=l.diff(f,"minutes");s=a.clone().add("minutes",c),i=s.format(u)}else i=n.util.toMoment(e).format(u);return this.endDate.datepicker("setDate",i),this.endTime.empty().html(this._buildEndTimeOptions(s)),this.endDate.datepicker("option","minDate",e),this},_bindChangeStartDate:function(e,t){return this.startTime.empty().html(this._buildStartTimeOptions()),this._processDateConstraint(),this.startDate.attr("data-prev",this.startDate.val()),this.afterChangeCallbacks.fire(),this},_bindChangeStartTime:function(t){var n=e(t.currentTarget);return this._processDateConstraint(),n.attr("data-prev",n.find("option:selected").val()),this.afterChangeCallbacks.fire(),this},_bindChangeEndDate:function(e,t){var n=moment(t+" "+this.endTime.find("option:selected").val(),o);return this.endTime.empty().html(this._buildEndTimeOptions(n)),this.endDate.attr("data-prev",t),this.afterChangeCallbacks.fire(),this},_bindChangeEndTime:function(e){return this.afterChangeCallbacks.fire(),this},_buildStartTimeOptions:function(){var e=[],t=this.startTime.attr("data-prev"),n=this._buildTimeSlots(t);for(var r=0,i=n.length;r<i;r++){if(!n[r])continue;var s=n[r].time;e.push(f.render({option_value:s,option_label:s,"selected?":s===t}))}return e.join("\n")},_buildEndTimeOptions:function(e){var t=[],i=this.startDate.val(),s=this.startTime.find("option:selected").val(),u=n.util.toMoment(i+" "+s,o),l=this.endDate.val(),c=n.util.isSameDate(i,l),h=e.format(a),p=this._buildTimeSlots(h);for(var d=0,v=p.length;d<v;d++){var m=p[d].time,g=n.util.toMoment(l+" "+m,o),y=Math.floor(g.diff(u,"hours",!0)*10)/10,b=null,w=!1;c&&y>=0&&(b="("+y+r["\uc2dc\uac04"]+")"),c&&y<0&&(w=!0);var E=f.render({option_value:m,option_label:m,"selected?":h===m,"disabled?":w,duration:b});t.push(E)}return t.join("\n")},_getClosestSteppedTime:function(e,t){return n.util.getIntervalTime(e,this.stepOfMinutes)}},t}(),l})}).call(this);