(function(e,t,n){function i(e){return e}function s(e){return decodeURIComponent(e.replace(r," "))}var r=/\+/g,o=e.cookie=function(r,u,a){if(u!==n){a=e.extend({},o.defaults,a),u===null&&(a.expires=-1);if(typeof a.expires=="number"){var f=a.expires,l=a.expires=new Date;l.setDate(l.getDate()+f)}return u=o.json?JSON.stringify(u):String(u),t.cookie=[encodeURIComponent(r),"=",o.raw?u:encodeURIComponent(u),a.expires?"; expires="+a.expires.toUTCString():"",a.path?"; path="+a.path:"",a.domain?"; domain="+a.domain:"",a.secure?"; secure":""].join("")}var c=o.raw?i:s,h=t.cookie.split("; ");for(var p=0,d=h.length;p<d;p++){var v=h[p].split("=");if(c(v.shift())===r){var m=c(v.join("="));return o.json?JSON.parse(m):m}}return null};o.defaults={},e.removeCookie=function(t,n){return e.cookie(t)!==null?(e.cookie(t,null,n),!0):!1}})(jQuery,document);var LoginStorage={cookiePath:"/",cookieExpire:30,cookieKey:{user:{id:"userLoginId",company:"userLoginCompany",isStoredInCookie:"userLoginInfoSaved"},admin:{id:"adminLoginId",company:"adminLoginCompany",isStoredInCookie:"adminLoginInfoSaved"},system:{id:"systemLoginId",company:"systemLoginCompany",isStoredInCookie:"systemLoginInfoSaved"}},isLoginInfoSaved:function(e){return $.cookie(this.cookieKey[e]["isStoredInCookie"])=="true"},getSavedInfo:function(e,t){return this.isLoginInfoSaved(e)?$.cookie(this.cookieKey[e][t]):null},saveInfo:function(e,t,n){if(_.contains(_.keys(this.cookieKey[e]),t)){var r={expires:this.cookieExpire,path:this.cookiePath};$.cookie(this.cookieKey[e][t],n,r),$.cookie(this.cookieKey[e].isStoredInCookie,!0,r)}},reset:function(e){_.each(this.cookieKey[e],function(e,t,n){$.removeCookie(e,{path:this.cookiePath})},this)}};$.urlParam=function(e){var t=(new RegExp("[\\?&amp;]"+e+"=([^&amp;#]*)")).exec(window.location.href);return t?t[1]||0:0};var LoginView=Backbone.View.extend({loginType:"user",concurrentLogoutAlarmCallback:null,findPasswordCallback:null,LOADING_IMAGE_ID:"popOverlay",events:{"focus #companySelect":"onCompanyFocused","blur #companySelect":"onCompanyBlured","click li.option":"onCompanySelected","click span.btn_dropdown":"toggleCompanySelect","click li":"toggleCompanySelect","click #login_submit":"submitLogin","click #login_id_save_label":"toggleSaveLoginId","click #findPwd":"findPassword","keypress #companySelect":"submitLoginByEnter","keypress input[type=text]":"submitLoginByEnter","keypress input[type=password]":"submitLoginByEnter",submit:"prohibitFormSubmit"},getContextRoot:function(){try{return document.getElementsByTagName("base")[0].attributes[0].nodeValue}catch(e){return"/"}},initialize:function(e){this.options=e,this.options.loginType&&(this.loginType=this.options.loginType),this.options.concurrentLogoutAlarmCallback&&(this.concurrentLogoutAlarmCallback=this.options.concurrentLogoutAlarmCallback),this.options.findPasswordCallback&&(this.findPasswordCallback=this.options.findPasswordCallback),this.useHttpsAlways=!1;var t=this,n="api/login/config";this.loginType=="admin"&&(n="ad/api/login/config"),this.contextRoot=GO.contextRoot||this.getContextRoot(),$.ajax({url:this.contextRoot+n,type:"GET",success:function(e){e.data.scope=="all"&&(t.useHttpsAlways=!0)}})},render:function(){$("input, textarea").placeholder(),$(".placeholder").css("color","#698687"),LoginStorage.isLoginInfoSaved(this.loginType)&&this._showSavedInfo(),this.options.oauthLogin&&this._setOauthLoginId(),this._focusCursorToInput(),$.urlParam("cause")=="concurrent"&&this.concurrentLogoutAlarmCallback&&this.concurrentLogoutAlarmCallback()},_showSavedInfo:function(){this.options.idInput.val(LoginStorage.getSavedInfo(this.loginType,"id")),this.toggleSaveLoginId()},_setOauthLoginId:function(){var e=$('form[name="oauthForm"] > input[name="email"]').val();$.trim(e)!=""&&this.options.idInput.val(e)},_focusCursorToInput:function(){var e;LoginStorage.isLoginInfoSaved(this.loginType)?e=document.getElementsByName(this.options.pwInput.attr("name"))[0]:e=this.options.idInput,setTimeout(function(){e.focus()},10)},toggleSaveLoginId:function(){var e=!this.options.saveIdCheckbox.attr("checked");this.options.saveIdCheckbox.attr("checked",e)},_preventDefaultEventHandling:function(e){return e=e||window.event,e.preventDefault?e.preventDefault():e.returnValue=!1,!1},_showLoadingImage:function(e){var t=Hogan.compile('<div class="overlay" id="'+this.LOADING_IMAGE_ID+'"><div class="processing"></div></div>');this.$el.append(t.render()),_.isNumber(e)&&e>0&&setTimeout($.proxy(this._hideLoadingImage,this),e)},_hideLoadingImage:function(){$("#"+this.LOADING_IMAGE_ID).remove()},submitLoginByEnter:function(e){if(e.keyCode!=13)return;$(e.currentTarget).focusout().blur(),this.submitLogin()},prohibitFormSubmit:function(){return!1},submitLogin:function(){return this._showLoadingImage(),this.hideValidationMessage(),this.options.saveIdCheckbox.is(":checked")?LoginStorage.saveInfo(this.loginType,"id",this.options.idInput.val()):LoginStorage.reset(this.loginType),this.processLoginByApiCall(),!1},processLoginByApiCall:function(){var e=this.contextRoot;this.loginType=="user"?e+="api/login":this.loginType=="admin"?e+="ad/api/login":e+="ad/api/system";var t={};t.url=e,t.type="POST",t.dataType="json",t.contentType="application/json",t.data=this.generateSubmitData(),t.success=$.proxy(this.onSubmitSuccess,this),t.error=this.onSubmitError,t.context=this;var n=this.getParameterByName("lang");!n||(t.headers={"Accept-Language":n.replace("_","-")}),$.ajax(t)},generateSubmitData:function(){var e={username:this.options.idInput.val(),password:this.options.pwInput.val(),captcha:$('input[name="captcha"]').val(),returnUrl:GO.util.XSSFilter(this.getParameterByName("returnUrl"))};return this.getParameterByName("lang")&&(e.locale=this.getParameterByName("lang")),JSON.stringify(e)},getParameterByName:function(e,t){var n=!0;typeof t=="boolean"&&!t&&(n=!1),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r="[\\?&]"+e+"=([^&#]*)",i=new RegExp(r),s=i.exec(window.location.search);return s?n?decodeURIComponent(s[1].replace(/\+/g," ")):s[1].replace(/\+/g," "):""},onSubmitSuccess:function(e){if($("form[data-pagetype]").length>0){this.getParameterByName("type")=="GET"&&opener.location.reload();try{var t=opener.document.getElementById("popOverlay");t&&$(t).remove()}catch(n){}finally{window.close()}}else{var r=this,i=r.getProtocol(),s=this.parseRedirectUrl(encodeURI(decodeURIComponent(e.data.redirect))),o=r.getHost();e.data.certType=="normal"?certModuleInit():e.data.certType=="regist"?document.location=GO.util.XSSFilter(i+o+s):(r._hideLoadingImage(),this.options.oauthLogin?document.oauthForm.submit():document.location=GO.util.XSSFilter(i+o+s))}return!1},parseRedirectUrl:function(e){return _.startsWith(e,"/")?e:"/"+e},getHost:function(){var e=location.host;if(this.loginType=="admin"&&!this.useHttpsAlways){var t=this.getAdminPort();e=location.host.split(":")[0]+":"+t}return e},getAdminPort:function(){var e=8e3;return $.ajax({async:!1,url:this.contextRoot+"ad/api/port/admin",type:"GET",success:function(t){e=t.data.port}}),e},getProtocol:function(){var e=this.useHttpsAlways?location.protocol+"//":"http://";return e},onSubmitError:function(e,t,n){var r=$.parseJSON(e.responseText),i=r.message;return this.showValidationMessage(i),e.status==423?this.showCaptcha():e.status==400&&this.options.pwInput.focus(),r.name==="invalid.company.period"&&this.showExtensionShortcut(),this._hideLoadingImage(),!1},showExtensionShortcut:function(){if(this.loginType!="user"||!this.isExpirationWithinOneMonth())return;var e={};e.url="api/payment/login",e.type="POST",e.dataType="json",e.contentType="application/json",e.data=this.generateSubmitData(),e.success=$.proxy(this.onPaymentSumitSuccess,this),$.ajax(e)},isExpirationWithinOneMonth:function(){var e,t,n;$.ajax({async:!1,url:this.contextRoot+"api/login/company/expiration/config",type:"POST",dataType:"json",contentType:"application/json",data:this.generateSubmitData(),success:function(r){var i=r.data;e=i.restrictCompanyPeriod||!1,_.isUndefined(i.restrictCompanyPeriodStart)||(t=i.restrictCompanyPeriodStart),_.isUndefined(i.restrictCompanyPeriodEnd)||(n=i.restrictCompanyPeriodEnd)}});if(e&&!_.isUndefined(n)){var r=GO.util.toMoment(n).add("months",1);if(GO.util.isAfterOrSameDate(GO.util.now(),r))return!0}return!1},onPaymentSumitSuccess:function(e){$("a.btn_extended").remove();var t=$("<a class='btn_extended' style='color: #fff;background: #000;padding: 7px 14px;margin-left: 22px;font-size: 12px;border-radius: 30px;margin-top: 10px;display: inline-block;'>\uc11c\ube44\uc2a4 \uc5f0\uc7a5 \ubc14\ub85c\uac00\uae30</a>");$("div.login_msg").append(t),t.on("click",function(){var t=e.data,n=$("<form action='"+t.url+"/user/sso' target='payment' method='post'><input type='hidden' name='token' value='"+t.token+"'></form>");$("body").append(n),window.open("about:blank","payment",""),n.submit()})},showCaptcha:function(){var e=this;$(".captchaContents").show(),$("#refreshBtn").unbind("click"),$("#refreshBtn").bind("click",function(){e.refreshCaptcha()}),this.refreshCaptcha()},refreshCaptcha:function(){$.ajax({url:GO.contextRoot+"api/captcha",type:"GET",success:function(e){$("#captchaImg").attr("src",e.data),$("#captcha").val("")}})},findPassword:function(){this.findPasswordCallback()},showValidationMessage:function(e){$("span.txt",this.options.failMessageLabel).html(e),this.options.failMessageLabel.show()},hideValidationMessage:function(){this.options.failMessageLabel.hide()},makeCookie:function(){$.cookie("changePassword",!0,{expires:15,path:"/"})}});