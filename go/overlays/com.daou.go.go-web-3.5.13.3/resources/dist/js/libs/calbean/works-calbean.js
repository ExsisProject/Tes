(function(e,t){var n=Array.prototype.slice,r=7,i={day:"day",time:"time"},s={timed:"timed",allday:"allday"},o={time:"txtcolor",day:"bgcolor"},u={update_period_color:"update:period-color",reset_events:"reset:events",change_date:"change:date",change_view_type:"change:view-type",resize:"resize:calendar",request_show_event:"request:show-event",request_create_event:"request:create-event",changed_date:"changed:date",changed_time:"changed:time",changed_view_type:"changed:view-type"},a=function(e,t){typeof t=="undefined"&&(t=!1);if(e.constructor===Array)return n.call(e);var r=new Object;for(var i in e)r[i]=typeof e[i]=="object"&&t?a(e[i]):e[i];return r},f=function(e,t){if(typeof e!="object")throw new Error("Invalid object.");for(var n in e)if(e[n]===t)return!0;return!1},l=function(){var e=function(){return new Error("Invalid date format")};return e}(),c=function(){var e=n.call(arguments),r=e.length;for(var i=0;i<r;i++)if(!t(e[i]).isValid())return!1;return!0},h=function(e,n){var r=t(e).clone().startOf("day"),i=t(n).clone().startOf("day");return r.diff(i)===0},p=function(e){return t(e).day()===0},d=function(e){return t(e).day()===6},v=function(e){return h(e,new Date)},m=function(e,n){var r=t(e).clone().startOf("month"),i=t(n).clone().startOf("month");return r.diff(i)===0},g=function(e,n){var r=t(n).clone().startOf("month").toDate(),i=t(e).clone().startOf("month").toDate();return i<r},y=function(e,n){var r=t(n).clone().startOf("month").toDate(),i=t(e).clone().startOf("month").toDate();return i>r},b=function(t){e(t).attr("unselectable","on").css("MozUserSelect","none").bind("selectstart.ui",function(){return!1})},w=function(e,n){return Math.ceil(t(n).diff(e,"day",!0))},E=function(){function i(e,t){var n=e.day()-t;return n<0&&(n=this.options.width+n),n}function o(){var e=new Date(this.options.date.getTime()),n=t(e),r=n.clone().startOf("month"),s=i(r,this.options.startday),o=n.clone().endOf("month"),u=r.clone().subtract("days",s),a={cols:this.options.width,rows:Math.ceil((o.date()+s)/this.options.width)};for(var f=0;f<a.rows;f++)for(var l=0;l<a.cols;l++)this.matrix[f]instanceof Array||(this.matrix[f]=[]),this.matrix[f][l]={instance:u.clone().toDate(),year:u.year(),month:u.month(),date:u.date(),day:u.day(),today:v(u),events:[],flags:[],axisX:f,axisY:l},u.add("days",1);return this.rows=a.rows,this.cols=a.cols,this.matrix}function u(e){return e.timeType===s.allday}function a(){var e=this.getFirstCell().instance,n=this.getLastCell().instance,r=this.options.events.length;for(var s=0;s<r;s++){var o,a,l=0,c=0,p=0,d,v,m,g={x:0,y:0},y=0,b=0,E=1,S=!0,x=-1,T=this.options.events[s],N=t(this.getFirstCell().instance);_.isUndefined(T.startTime)?T.startTime=T.endTime:_.isUndefined(T.endTime)&&(T.endTime=T.startTime);if(!this.isValidEvent(T))continue;u(T)?(o=t(T.startTime,"YYYY-MM-DD").clone().startOf("days"),a=t(T.endTime,"YYYY-MM-DD").clone()):(o=t(T.startTime).clone().startOf("days"),a=t(T.endTime).clone()),a.format("HH:mm:ss")==="00:00:00"&&T.timeType==="timed"?(T.endTime=a.format("YYYY-MM-DDTHH:mm:ss.SSSZ"),a.subtract("seconds",1)):a.endOf("days"),l=i(o,this.options.startday),c=w(o,a),this.options.width>1?p=Math.ceil((c+l)/this.options.width):p=c;var C=t(T.startTime).toDate()<e,k=t(T.endTime).toDate()>n;d=C?t(e).clone().startOf("days"):o,v=k?t(n).clone().endOf("days"):a,g=this.getAxis(d),m=w(d,v),y=+g.x,!C&&!k&&(m==-0||m<0)?b=1:b=+m;if(o.isBefore(t(N),"day")){var L=w(o,N),A=Math.ceil(L/this.options.width);E+=A}while(b>0){var O=this.getCell(g.x,g.y),M=O.events,D=this.options.width-d.day()-1+this.options.startday,P={id:T.id,type:T.type,summary:T.summary,range:m,total_rows:p,current_row:+E,_ref:T};P.render=!0,x===-1&&(x=f(M)),m>1&&(S?(D>0&&(P.colspan=b>D?D+1:b),S=!1):P.render=!1),O.events[x]=P,this.__eventsIndex__[T.id]=s;if(h(d,v))break;y=+g.x,d.add("days",1),g=this.getAxis(d),g.x>y&&(E++,S=!0,x=-1),b--}}}var n=function(t){this.options=e.extend({date:new Date,startday:0,width:r,events:[]},t||{}),this.matrix=[],this.rows=0,this.cols=0,this.__eventsIndex__={},o.call(this),a.call(this)};n.prototype={updateEvent:function(t){if(!t.id)throw new Error("\uc774\ubca4\ud2b8 ID\uac00 \ud544\uc694\ud569\ub2c8\ub2e4.");var n=this.findEventById(t.id);e.extend(!0,n,t),this.reset()},resetEvents:function(e){this.options.events=e,a.call(this)},setStartday:function(e){if(this.options.startday===e)return;this.options.startday=e,a.call(this)},isValidEvent:function(e){var n=t(e.startTime),r=t(e.endTime);return c(n,r)},findEventById:function(e){return this.options.events[this.__eventsIndex__[e]]},getAxis:function(e){var n=t(e),r=t(this.options.date).clone().startOf("month").day(),i=m(e,this.options.date)?r:n.clone().startOf("month").day()+this.options.startday,s=this.options.width===1?i:i%this.options.width,o=s+n.date(),u={x:0,y:0};g(e,this.options.date)?u.x=0:y(e,this.options.date)?u.x=this.getAxisXOfLast():u.x=this.options.width===1?o-1:Math.floor((o-1)/this.options.width),u.y=this.options.width===1?0:(s+n.date())%this.options.width-1,u.y<0&&(u.y=this.options.width+u.y);if(u.x<0||u.x>this.getRowCount()||u.y>this.getColCount())throw new Error("Invalid axis of matrix");return u},getCell:function(e,t){return this.matrix[e][t]},getCellByDate:function(e){var t=this.getAxis(e);return this.getCell(t.x,t.y)},getRow:function(e){return this.matrix[e]},getRowByDate:function(e){return this.getRow(this.getAxis(e).x)},getRowCount:function(){return this.rows},getColCount:function(){return this.cols},getFirstCell:function(){return this.matrix[0][0]},getLastCell:function(){return this.matrix[this.getAxisXOfLast()][this.getAxisYOfLast()]},getAxisXOfLast:function(){return this.rows-1},getAxisYOfLast:function(){return this.cols-1}};var f=function(e){var t=0;for(var n=0,r=e.length;n<=r;n++)if(typeof e[n]=="undefined"){t=n;break}return t};return n.__cache__={},n.getInstance=function(e){var r=t(e.date||new Date),i=r.format("YYYYMM");if(n.__cache__[i]==null||typeof n.__cache__[i]=="undefined")n.__cache__[i]=new n(e);return n.__cache__[i]},n}();e.fn.calbean=function(r){function U(e){return e=e||"td","<"+e+' class="scroll_area timeline-scrollfix"></'+e+">"}var m=e.extend(!0,{type:"weekly",startday:0,date:new Date,lang:"ko",lazy:!1,height:0,maxRows:4,events:[],i18n:{"\uc2dc\uac04":"\uc2dc\uac04","\ub2eb\uae30":"\ub2eb\uae30"}},r||{}),g=t.weekdaysShort(),y={d:"daily",w:"weekly",m:"monthly"},S="calbean-calendar-",x="calbean_calendar_view",T=m.i18n,N={},C=e(this);b(this);var k=function(){var t=e("."+x).length;C.attr("id")||C.attr("id",S+t),C.hasClass(x)||C.addClass(x),A(),I()},L=function(){function e(e,i){var s={allday:1,timed:2};return(new r(e,i)).pipe(function(t,r){return n(t.startTime,r.startTime)}).pipe(function(t,r){return n(r.endTime,t.endTime)}).pipe(function(t,n){return s[t.timeType]-s[n.timeType]}).pipe(function(n,r){return t(n.startTime).valueOf()-t(r.startTime).valueOf()}).pipe(function(n,r){return t(n.createdAt).valueOf()-t(r.createdAt).valueOf()}).run()}function n(e,t){if(_.isUndefined(e)||_.isUndefined(t))return 0;var n=e.split("T")[0],r=t.split("T")[0],i=-1;return n>r?i=1:n===r&&(i=0),i}function r(e,t){this.a=e,this.b=t,this.__result__=0,this.pipe=function(e){return this.__result__===0&&(this.__result__=e(this.a,this.b)),this},this.run=function(){return this.__result__}}m.events.sort(e)},A=function(){for(var e in u)C.off(u[e]);C.off("click","a.schedule")},O=function(t){t.preventDefault(),t.stopImmediatePropagation();var n=e(t.currentTarget);C.trigger(u.request_show_event,[n.attr("data-periodid"),n.attr("data-id")])},M=function(e,t){C.height(t),m.height=t,Q()},D=function(e,t){if(!f(y,t))throw new Error("Invalid view type.");m.type=t,Q()},P=function(e,n,r){var i=t(n);r=r||[];if(!c(i))throw new l;m.date=i.toDate(),j(r||[]),Q()},H=function(e,t,n){var r=!1,i=m.events.length;for(var s=0;s<i;s++){var o=m.events[s];if(o.periodId!=t)continue;if(o.color===n)continue;o.color=n,r=!0}r&&Q()},B=function(e){var t=m.events.length;for(var n=0;n<t;n++)if(m.events[n].id===e)return!0},j=function(e){var t=!1;e=e||[];if(e.length>0){var n=e.length;for(var r=0;r<n;r++){var i=e[r];if(B(i.id))continue;m.events.push(i),t=!0}t&&L()}return t},F=function(e,t,n){m.events=[],Q(t||[],n)},I=function(){C.on(u.update_period_color,H),C.on(u.reset_events,F),C.on(u.change_view_type,D),C.on(u.change_date,P),C.on(u.resize,M),C.on("click","a.schedule",O)},q=function(e,t){return t>1||t<=1&&e.timeType===s.allday},R=function(e){return['<span class="time">',t(e).format("HH:mm"),"</span>"].join("")},z=function(){var e={calendar:"calendar",timeline:"timeline"},n=function(t){this.matrix=t,this.limit=0,this.type=""+e.calendar,this.classnames={tr:[],td:[]}};return n.prototype={setLimit:function(e){return this.limit=e,this},setType:function(e){return this.type=e,this},addClass:function(e,t){return this.classnames[e].push(t),this},build:function(){var e=[],n=this.matrix.length,r=this._computeTotalRows(this.matrix,this.limit),i=this._generateClassForTable("tr"),s=this._generateClassForTable("td"),o=0;this._rebuildEventsAndFlags();do{e.push(["<tr",i,">"].join("")),o===0&&this._isTimelineType()&&e.push("<th",r>0?[' rowspan="',r+1,'"'].join(""):"","></th>");for(var u=0;u<n;u++){var a=this.matrix[u].rebuildSchedule,f=t(this.matrix[u].instance).format("YYYY-MM-DD"),l="",c="";if(a.length>o&&a[o]){if(a[o].render===!1)continue;a[o].colspan&&(c=' colspan="'+a[o].colspan+'"'),l=this._buildDayEvent(a[o])}e.push(["<td",s,c,' data-date="',f,'">'].join("")),e.push(l),e.push("</td>")}this._isTimelineType()&&e.push(U()),e.push("</tr>"),o++}while(o<r);return r>0&&e.push(this._buildBlankRow(r)),e.join("")},_computeTotalRows:function(){var e=this.matrix.length,t=0,n=0;for(var r=0;r<e;r++)t=Math.max(t,this._getEventCount(this.matrix[r].events)),this._isTimelineType()&&(n=Math.max(n,this._getEventCount(this.matrix[r].flags)));return t+n},_rebuildEventsAndFlags:function(){var e=this,t=0,n=this._isTimelineType();_.each(this.matrix,function(n){t=Math.max(e._getEventCount(n.flags),t)}),_.each(this.matrix,function(e){if(n){var r=[],i=e.events,s=e.flags,o=new Array(t-s.length);r=r.concat(o,s,i),e.rebuildSchedule=r}else e.rebuildSchedule=e.events})},_buildBlankRow:function(e){var n=[],r=this.matrix.length,i=this._generateClassForTable("tr"),s=this._generateClassForTable("td");n.push(["<tr",i,">"].join(""));for(var o=0;o<r;o++){var u=this.matrix[o].events,a=t(this.matrix[o].instance).format("YYYY-MM-DD"),f=u.length-e;n.push(["<td",s,' data-date="',a,'">'].join("")),!this._isTimelineType()&&f>0&&n.push(['<a class="btn_schedule_more" href="#" data-bypass>+',f,T["{{count}} \uac1c"],"</a>"].join("")),n.push("</td>")}return n.push("</tr>"),n.join("")},_getEventCount:function(e){var t=0;if(this._isTimelineType()){var n=e.length;for(var r=0;r<n;r++){var i=e[r];i&&q(i._ref,i.range)&&t++}}else t=this.limit>0?Math.min(e.length,this.limit):e.length;return t},_generateClassForTable:function(e){return this.classnames[e].length>0?[' class="',this.classnames[e].join(" "),'"'].join(""):""},_buildDayEvent:function(e){var t=[],n=[],r=["schedule"],o="schedule_",u=e.range,f=i.time+"",l=a(e._ref),c=[],h=l.summary,p=l.actions;return p&&p.updatable&&n.push("draggable"),q(l,u)&&(f=i.day),this._isTimelineType()&&f===i.time?"":(n.push(o+"day"),e.total_rows>1&&(e.current_row>1&&(n.push("schedule_day_left"),c.push('<div class="tail_l"><div></div></div>')),e.current_row<e.total_rows&&(n.push("schedule_day_right"),c.push('<div class="tail_r"><div></div></div>'))),n.push("bgcolor"+(l.color||"1")),n.push("ev-"+l.id),t.push('<div el-event class="',n.join(" "),'">',"\n"),t.push(c.join("\n")),t.push('<a href="#" class="',r.join(" "),'" title="',h,'" data-id="',e.id,'" data-docId="',l.docId,'" data-periodId="',l.periodId,'" data-duration="',e.range,'" data-startdate="',l.startTime,'" data-enddate="',l.endTime,'" data-bypass>',"\n"),l.timeType===s.timed&&t.push(R(l.startTime),"\n"),l.startTime>l.endTime&&t.push('<span class="ic ic_caution_mini"></span>'),t.push("<span>",h,"</span>","\n"),t.push("</a>","\n"),t.push("</div>","\n"),t.join(""))},_isTimelineType:function(){return this.type===e.timeline}},n}(),W=function(){var n=function(){this.id="layer-schedule-more",this.$el=this._createElement(),this.$el.draggable({containment:e("#calendar-viewport"),handle:".drag_area",cursor:"move"}),this.delegateEvents()};return n.prototype={render:function(e,n,r){return this._setPosition(e.currentTarget),this.$el.find("ul").empty().append(this._buildEventList(n,r)),this.$el.find("span.date").text(t(n).format("DD")),this._bindDraggable(),this},_bindDraggable:function(){var t=e("table.bg_row td").first().width();this.$el.find(".draggable").draggable({containment:".month_body",cursor:"move",appendTo:".month_body",revert:"invalid",cursorAt:{left:t/2,top:10},helper:function(n){var r=e(this).clone();return r.width(t),r.addClass("dragged"),r},start:function(){var t=e(this),n=t.find("a").data("id");e(".ev-"+n).css("opacity",.7)},stop:function(t,n){var r=e(this),i=r.find("a").data("id"),s=e(n.helper.context).data("promise");s===undefined?(e(".ev-"+i).css("opacity",1),this.remove()):s.done(e.proxy(function(){e(".ev-"+i).css("opacity",1),this.remove()},this))}})},delegateEvents:function(){return e("body").on("click.schedule-more",e.proxy(this._blur,this)),this.$el.on("click","a.schedule",e.proxy(this._showEvent,this)),this.$el.on("click",".ic_close_s2",e.proxy(this.remove,this)),this.$el.on("mouseover",".drag_area > .btn_border",e.proxy(this._disableDrag,this)),this.$el.on("mouseout",".drag_area > .btn_border",e.proxy(this._enableDrag,this)),this},undelegateEvents:function(){return e("body").off("click.schedule-more"),this.$el.off(),this},remove:function(){return this.undelegateEvents(),this.$el.remove(),n.__instance__=null,this},_showEvent:function(e){return O(e),this.remove(),this},_blur:function(t){var n=e(t.target);if(n.is("a.btn_schedule_more"))return;if(!this.$el.is(":visible"))return;if(n.parents("#"+this.id).length>0)return;return this.remove(),this},_enableDrag:function(){return this.$el.draggable("enable"),this},_disableDrag:function(){return this.$el.draggable("disable"),this},_setPosition:function(e){return this._setOffsetX(e),this._setOffsetY(e),this},_setOffsetX:function(t){var n=e(t),r=e(window).width(),i=n.offset().left,s=i+this.$el.outerWidth();return s>r&&(i=r-this.$el.outerWidth()),this.$el.css("left",i+"px"),this},_setOffsetY:function(t){var n=e(t),r=n.parent().parent().parent().offset().top;return this.$el.css("top",r+"px"),this},_createElement:function(){return e("#"+this.id).length||this._buildLayerWrapper(),e("#"+this.id)},_buildLayerWrapper:function(){var t=[];return t.push(['<div id="',this.id,'" class="layer_normal layer_schedule_more layer_calbean_calendar_view">'].join("")),t.push('<div class="title drag_area">'),t.push(['<span class="date"></span>'].join("")),t.push('<span class="btn_border">'),t.push('<span class="ic_classic ic_close_s2" title="'+T["\ub2eb\uae30"]+'"></span>'),t.push("</span>"),t.push("</div>"),t.push("<ul>"),t.push("</ul>"),t.push("</div>"),e("body").append(t.join("\n")),this},_buildEventList:function(e,n){var r=[];r.push("<li>");for(var s=0,u=n.length;s<u;s++){if(!n[s]||typeof n[s]=="undefined")continue;var a=n[s],f=a._ref,l=f.color,c=t(f.startTime),p=t(f.endTime),d=q(f,a.range),v=d&&a.range>1,m=h(e,c),g=h(e,f.endTime),y="",b=[],w=f.actions;w&&w.updatable&&b.push("draggable"),b.push("schedule_day"),v&&m&&b.push("schedule_day_left"),v&&g&&b.push("schedule_day_right"),y=o[i.day],b.push(y+l),r.push(['<div el-event class="',b.join(" "),'">'].join("")),v&&(m&&r.push('<div class="tail_l"><div></div></div>'),g&&r.push('<div class="tail_r"><div></div></div>')),r.push(['<a href="#" class="schedule" title="',f.summary,'" data-startdate="',c,'" data-enddate="',p,'" data-startTime="',f.startTime,'" data-endTime="',f.endTime,'" data-docid="',f.docId,'" data-periodid="',f.periodId,'" data-id="',a.id,'" data-duration="',1,'" data-bypass>'].join("")),f.startTime>f.endTime&&r.push('<span class="ic ic_caution_mini"></span>'),r.push(["<span>",f.summary,"</span>"].join("")),r.push("</a>"),r.push("</div>")}return r.push("</li>"),r.join("\n")}},n.__instance__=null,n.create=function(){return this.__instance__===null&&(this.__instance__=new n),this.__instance__},n.release=function(){var e=this.create();e.remove(),this.__instance__=null},n}(),X=function(){var n="calendar_month",r="calbean-monthly",i=function(e){this.options=_.clone(e),this.matrix=new E(this.options),this.rowCount=this.matrix.getRowCount(),this.maxRows=e.maxRows,this.undelegateEvents(),this.delegateEvents()};return i.prototype={render:function(){var e=[];return this.maxRows=Math.floor(this.options.height/this.rowCount/22)-2,e.push(this._buildTableHeader()),e.push(this._buildMonthBody()),C.empty().html(e.join("\n")),this._resetClass(this,y.m),this._resize(this.options.height),this._bindDND(),this},_bindDND:function(){var t=C.find("table.bg_row td").first().width();C.find(".draggable").draggable({containment:".month_body",cursor:"move",appendTo:".month_body",revert:"invalid",cursorAt:{left:t/2,top:10},helper:function(n){var r=e(this).clone();return r.width(t),r.addClass("dragged"),r},start:function(){var t=e(this),n=t.find("a").data("id");e(".ev-"+n).css("opacity",.7)},stop:function(t,n){var r=e(n.helper.context).data("promise"),i=e(this),s=i.find("a").data("id");r==undefined?e(".ev-"+s).css("opacity",1):r.done(function(){e(".ev-"+s).css("opacity",1)})}}),C.find("table.bg_row td").droppable({accept:".draggable",tolerance:"intersect",drop:function(t,n){var r=e(n.draggable).find("a"),i=r.data("docid"),s=r.data("periodid"),o=r.data("startdate"),a=e(this).data("date");e(this).removeClass("on"),h(o,a)||C.trigger(u.changed_date,[i,s,a,e(n.draggable)])},over:function(t,n){e(this).addClass("on")},out:function(t,n){e(this).removeClass("on")}})},delegateEvents:function(){return C.on(u.change_view_type+"."+r,e.proxy(this._resetClass,this)),C.on("click."+r,"table.bg_row, table.schedule_row th, table.schedule_row th note, table.schedule_row td:empty",e.proxy(this._requestCreateEvent,this)),C.on("click."+r,"table.schedule_row span.day",function(t){var n=e(t.target);C.trigger(u.changed_view_type,[y.d,n.parent().attr("data-date")])}),C.on("click."+r,"a.btn_schedule_more",e.proxy(this._showMoreEvent,this)),this},undelegateEvents:function(){return C.off("."+r),this},_showMoreEvent:function(t){t.preventDefault();var n=e(t.currentTarget),r=n.parent().attr("data-date"),i=this.matrix.getCellByDate(r),s=W.create();return s.render(t,r,i.events,this.options),t.stopImmediatePropagation(),this},_resetClass:function(e,t){return t===y.m?C.addClass(n):C.removeClass(n),this},_bindResizeJSEvent:function(e,t){return this._resize(t),this},_resize:function(e){var t=Math.floor((e-C.find(".tb_month_header").outerHeight())/this.rowCount);return C.find(".week_schedule").height(t),this},_requestCreateEvent:function(t){e(t.target).attr("data-date")&&C.trigger(u.request_create_event,this.options.collection.appletId)},_buildTableHeader:function(){var e=[],t=this.matrix.getRow(0);e.push('<table class="type_normal tb_month_header tb_fix">',"<thead><tr>","\n");for(var n=0,r=t.length;n<r;n++){var i=t[n].day,s=g[i],o=[];i===0&&o.push("sun"),i===6&&o.push("sat"),e.push('<th class="',o.join(" "),'">',s,"</th>","\n")}return e.push("</tr></thead>","</table>"),e.join("")},_buildMonthBody:function(){var e=[];e.push('<div class="month_body">');for(var t=0,n=this.matrix.getRowCount();t<n;t++){var r=this.matrix.getRow(t);e.push('<div class="week_schedule">'),e.push(this._buildWeekBgCells(r)),e.push(this._buildWeekScheduleRows(r)),e.push("</div>")}return e.push("</div>"),e.join("\n")},_buildWeekBgCells:function(e){var n=[];n.push("<tr>");for(var r=0,i=e.length;r<i;r++){var s=e[r],o=t(s.instance).format("YYYY-MM-DD"),u=["dt"+o];s.today&&u.push("today"),n.push('<td class="',u.join(" "),'" data-date="',o,'"></td>',"\n")}return n.push("</tr>"),this._tableRowDecorator(n.join(""),"bg_row")},_buildWeekScheduleRows:function(e){var t=[];return t.push(this._buildWeekHeaders(e)),t.push(this._buildWeekEvents(e)),this._tableRowDecorator(t.join(""),"schedule_row")},_buildWeekHeaders:function(e){var n=[],r=e.length;n.push("<tr>");for(var i=0;i<r;i++){var s=e[i],o=t(s.instance).format("YYYY-MM-DD"),u=this._generateClassesOfWeekHeaders(s,this.options.date);n.push('<th class="',u.join(" "),'" data-date="',o,'">',"\n"),n.push('<span class="day">',s.date,"</span>","\n"),n.push("</th>","\n")}return n.push("</tr>"),n.join("")},_buildWeekEvents:function(e){var t=new z(e);return t.setLimit(this.maxRows),t.build()},_generateClassesOfWeekHeaders:function(e,n){var r=[],i=t(n).month();return e.month===i&&e.day===0&&r.push("sun"),e.month===i&&e.day===6&&r.push("sat"),e.month<i&&r.push("before"),e.month>i&&r.push("next"),e.today&&r.push("today"),r},_tableRowDecorator:function(e,t){typeof t=="undefined"&&(t=""),t!==""&&(t+=" ");var n=[];return n.push('<table class="',t,'tb_fix"><tbody>',"\n"),n.push(e,"\n"),n.push("</tbody></table>"),n.join("")}},i}(),V=function(){var n=12,r=60/n,s=r,a=15,f="calendar_week",g="calbean-timeline",b=function(e,n){typeof n=="undefined"&&(n=e),this.__range={from:new Date,to:new Date};if(!c(e,n))throw new l;this.startday=0,this.__range.from=t(e).clone().toDate(),this.__range.to=t(n).clone().toDate(),this.__duration=this._computeDuration(this.__range.from,this.__range.to),this.__scrollTop=-1,this.matrix=new E({date:this.__range.from,width:this.__duration}),C.addClass(f),this.undelegateEvents(),this.delegateEvents()};return b.prototype={buildSkelecton:function(){var e=[];e.push(this._buildTimelineHeader()),e.push(this._buildTimelineBody()),C.empty().html(e.join("\n")),this._resize(m.height),this._scrollTo();var t=C.find("div.day_schedule table.schedule_row tr.row").length*19;C.find("div.day_schedule table.bg_row tr").height(t),C.find("div.day_schedule table.bg_row th").height(t)},render:function(n){var i=this;this.buildSkelecton();if(this.__duration>1){var o=C.find("table.schedule_row td").last().width();C.find("table.schedule_row .draggable").draggable({containment:"table.schedule_row tbody",cursor:"move",appendTo:"#calendar-viewport",revert:"invalid",cursorAt:{left:o/2,top:10},helper:function(t){var n=e(this).clone();return n.width(o),n.addClass("dragged"),n},start:function(){var t=e(this),n=t.find("a").attr("data-id");e(".ev-"+n).css("opacity",.7)},stop:function(){var t=e(this),n=t.find("a").data("id");e(".ev-"+n).css("opacity",1)}}),C.find("div.day_schedule table.bg_row td").droppable({greedy:!0,accept:"table.schedule_row .draggable",tolerance:"intersect",drop:function(t,n){var r=e(n.draggable).find("a"),i=r.data("docid"),s=r.data("periodid"),o=r.data("startdate"),a=e(this).data("date");e(this).removeClass("on"),h(o,a)||C.trigger(u.changed_date,[i,s,a,null])},over:function(t,n){e(this).addClass("on")},out:function(t,n){e(this).removeClass("on")}})}var f=0,l=e(".schedule_wrap").first().outerWidth();return C.find(".schedule_wrap .draggable").draggable({containment:".timeline_wrap",cursor:"move",appendTo:".timeline_wrap",revert:"invalid",grid:[e(".schedule_wrap").first().outerWidth()+21,a],drag:function(n,r){var i=r.offset.top,s=i-f,o=Math.abs(s)+5;if(o>a){var u=e(this),l=t(u.attr("data-starttime")),c=t(u.attr("data-endtime")),h=c.diff(l,"minutes"),p=l.clone().startOf("days"),d=Math.ceil(r.position.top+1),v=p.add("minutes",d),m=v.clone().add("minutes",h);e(this).find(".time").text(v.format("HH:mm")),e(this).attr("data-starttime",v.format("YYYY-MM-DDTHH:mm:ss.SSSZ")),e(this).attr("data-endtime",m.format("YYYY-MM-DDTHH:mm:ss.SSSZ")),f=+parseInt(i)}},start:function(t,n){var r=e(this).width(),s=parseInt(e(this).css("left")||"0")>0?e(this).width():l+16;i.preventClickEvent(),e(this).click(function(){return!1}),f=+parseInt(n.offset.top),e(this).css({width:s,opacity:.8,"z-index":"100"}),e(this).attr({"data-org-starttime":e(this).data("starttime"),"data-org-width":r})},stop:function(){e(this).css({width:e(this).attr("data-org-width"),opacity:1,"z-index":"auto"}),e(this).removeAttr("data-org-starttime").removeAttr("data-org-width"),f=0}}),C.find(".tb_week_body tr.cols td").droppable({greedy:!0,accept:".schedule_time",tolerance:"intersect",drop:function(n,r){var i=e(r.draggable),s=i.attr("data-id"),o=i.attr("data-periodid"),a=i.attr("data-org-starttime"),f=t(i.attr("data-starttime")),l=t(i.attr("data-endtime")),c=l.diff(f,"minutes"),h=e(this).data("date"),p=[h,"T",f.format("HH:mm:ss.SSSZ")].join(""),d=t(p).clone().add("minutes",c).format("YYYY-MM-DDTHH:mm:ss.SSSZ");t(d).format("HH:mm:ss")==="00:00:00"&&(d=t(d).subtract("seconds",1).format("YYYY-MM-DDTHH:mm:ss.SSSZ")),t(a).valueOf()!==t(p).valueOf()&&i.attr({"data-starttime":p,"data-endtime":d}),C.trigger(u.changed_time,[s,o,p,d,C.find("div.week_body_wrap").scrollTop()])}}),C.find(".schedule_wrap .resizable").resizable({containment:"parent",handles:{s:".resize"},grid:s,minHeight:s,autoHide:!0,start:function(e,t){i.preventClickEvent()},stop:function(n,i){var o=e(this),a=o.attr("data-id"),f=o.attr("data-periodid"),l=o.attr("data-starttime"),c=o.attr("data-endtime"),h=r*Math.ceil(o.outerHeight()/s),p=t(l).add("minutes",h).format("YYYY-MM-DDTHH:mm:ss.SSSZ");t(p).format("HH:mm:ss")==="00:00:00"&&(p=t(p).subtract("seconds",1).format("YYYY-MM-DDTHH:mm:ss.SSSZ")),C.trigger(u.changed_time,[a,f,l,p,C.find("div.week_body_wrap").scrollTop()])}}),this},scrollTo:function(e){this.__scrollTop=e},preventClickEvent:function(e){C.off(".calbean-timeline")},delegateEvents:function(){return C.on("click."+g,"div.schedule_time",O),C.on(u.change_view_type+"."+g,e.proxy(this._resetClass,this)),C.on("click."+g,"td.cell:not(:has(div.schedule_day))",e.proxy(this._createEvent,this)),C.on("click."+g,".timeline_wrap",e.proxy(this._createEvent,this)),C.on("click."+g,".schedule_wrap",e.proxy(this._createEvent,this)),C.on("mouseover."+g,".resizable",function(t){e(t.currentTarget).find(".resize").show()}),C.on("mouseleave."+g,".resizable",function(t){e(t.currentTarget).find(".resize").hide()}),this},undelegateEvents:function(){return C.off("."+g),this},setEvents:function(e){return this.matrix.resetEvents(e),this},resetEvents:function(e){this.matrix.resetEvents(e),this.render()},setStartday:function(e){this.matrix.setStartday(e)},_resetClass:function(t,n){e.inArray(n,[y.w,y.d])>-1?C.addClass(f):C.removeClass(f)},_bindResizeJSEvent:function(e,t){this._resize(t)},_createEvent:function(t){if(e(t.currentTarget).attr("data-date"))return C.trigger(u.request_create_event,this.options.collection.appletId),this},_resize:function(e){var t=e-C.find(".tb_week_header").outerHeight()-C.find(".day_schedule").outerHeight();return C.find(".timeline-scrollfix").width(C.find(".week_body_wrap").width()-C.find(".tb_week_body").width()),C.find(".week_body_wrap").height(t),this},_scrollTo:function(){var t=C.find("div.week_body_wrap"),n=t.innerHeight(),r;if(this.__scrollTop>-1)r=this.__scrollTop;else{var i=C.find("#current-timeline"),s=i.position().top;s<550?r=e(".timeline_wrap div[data-time='07:00:00']").position().top:r=s-n/2}return r>0&&C.find("div.week_body_wrap").scrollTop(r),this},_computeDuration:function(e,n){var r=t(e).clone().startOf("day"),i=t(n).clone().endOf("day");return w(r,i)},_buildTimelineHeader:function(){var e=[];return e.push(this._buildWeekHeader()),e.push('<div class="day_schedule">'),e.push(this._buildRangeEventBgCells()),e.push('<table class="schedule_row tb_fix">'),e.push("<tbody>"),e.push(this._buildRangeEvents()),e.push("</tbody>"),e.push("</table>"),e.push("</div>"),e.join("\n")},_buildWeekHeader:function(){var e=[],n=t(this.__range.from).clone();e.push('<table class="tb_week_header tb_fix">'),e.push('<thead class="type_normal">'),e.push("<tr>"),e.push("<th>"+T["\uc2dc\uac04"]+"</th>");for(var r=0;r<this.__duration;r++){var i=[],s=n.format("MM.DD(ddd)");p(n)&&i.push("sun"),d(n)&&i.push("sat"),v(n)&&i.push("today"),e.push(["<th",i.length>0?[' class="',i.join(" "),'"'].join(""):"",'><span class="day">',s,"</span></th>"].join("")),n.add("days",1)}return e.push(U("th")),e.push("</tr>"),e.push("</thead>"),e.push("</table>"),e.join("\n")},_buildRangeEventBgCells:function(){var e=[],n=t(this.__range.from).clone();e.push('<table class="bg_row tb_fix">'),e.push("<tbody>"),e.push("<tr>"),e.push("<th></th>");for(var r=0;r<this.__duration;r++)e.push('<td data-date="'+n.format("YYYY-MM-DD")+'"></td>'),n.add("days",1);return e.push(U()),e.push("</tr>"),e.push("</tbody>"),e.push("</table>"),e.join("\n")},_buildRangeEvents:function(){var e=this.matrix.getAxis(this.__range.from),t=this.matrix.getRow(e.x),n=new z(t);return n.setType("timeline"),n.addClass("tr","row"),n.addClass("td","cell"),n.build()},_buildTimelineBody:function(){var e=[];return e.push('<div class="week_body_wrap">'),e.push('<table class="tb_week_body tb_fix">'),e.push("<tbody>"),e.push(this._buildTimelineBgGrid()),e.push(this._buildTimelineEvents()),e.push("</tbody>"),e.push("</table>"),e.push("</div>"),e.join("\n")},_buildTimelineBgGrid:function(){var e=[],n=t(new Date).startOf("days");e.push('<tr style="height: 1px">'),e.push('<th style="width: 70px; height: 0"></th>'),e.push(['<td class="time_wrap"',this.__duration>1?' colspan="'+this.__duration+'"':"",">"].join("")),e.push('<div class="timeline_wrap">');for(var r=0;r<48;r++)e.push('	<div class="timeline" data-time="'+n.format("HH:mm:ss")+'"></div>'),n.add("minutes",30);return e.push("</div>"),e.push("</td>"),e.push("</tr>"),e.join("\n")},_buildTimelineEvents:function(){var e=[];return e.push('<tr class="cols">'),e.push("<th>"),e.push(this._buildTimelineLabel()),e.push("</th>"),e.push(this._buileTimelineEventCols()),e.push("</tr>"),e.join("\n")},_buildTimelineLabel:function(){var e=[],n=[],r=t().startOf("days"),i={am:r.clone().hours(1).format("A"),pm:r.clone().hours(12).format("A")};n[0]=["<span>",i.am,"</span> "].join(""),n[12]=["<span>",i.pm,"</span> "].join(""),e.push('<div class="time_wrap">');for(var s=0;s<24;s++)e.push(['	<div class="time">',n[s],r.format("hh"),"</div>"].join("")),r.add("hours",1);return e.push(this._buildFlagOfCurrentTime()),e.push("</div>"),e.join("\n")},_buildFlagOfCurrentTime:function(){var e=t(new Date),n=e.clone().startOf("days"),r=Math.ceil(e.diff(n,"minutes",!0)/parseInt(1));return['<div id="current-timeline" class="real_time" style="top: ',r,'px; left: 0px"></div>'].join("")},_getOffsetYByDate:function(e){var n=t(e),r=n.clone().startOf("days");return Math.ceil(n.diff(r,"minutes",!0))},_buileTimelineEventCols:function(){var e=[],n=this.matrix.getRowByDate(this.__range.from);for(var r=0,i=n.length;r<i;r++){var s=n[r],o=s.instance,u=t(o).format("YYYY-MM-DD"),a=s.events;e.push(["<td",v(o)?' class = "today"':"",' data-date="',u,'"',">"].join("")),a.length>0&&e.push('<div class="schedule_wrap" data-date="'+u+'">'),e.push(this._buildScheduleTimeDiv(a)),a.length>0&&e.push("</div>"),e.push("</td>")}return e.join("\n")},_buildScheduleTimeDiv:function(e){if(e.length<1)return"";var t=[],n=this._getTimelineEvents(e);for(var r in n){var s=n[r],u=s._ref,a=s.summary,f="",l=["schedule_time"],c=u.actions;c&&c.updatable&&(l.push("draggable"),_.isUndefined(u.endCid)||l.push("resizable")),s.width=this._getPercentageValue(100/s.concurrent,"floor",1),s.left=s.hindex*s.width,s.width=s.isLastIndex&&s.concurrent>s.hindex?s.width*(s.concurrent-s.hindex):s.width,l.push(o[i.day]+u.color),f=["top:",s.top,"px;","left:",s.left,"%;","width:",s.width,"%;","height:",s.height,"px"].join(""),t.push('<div class="',l.join(" "),'" style="',f,'" data-id="',r,'" data-periodid="',u.periodId,'" data-docid="',u.docId,'" data-startTime="',u.startTime,'" data-endTime="',u.endTime,'">',"\n"),t.push('<p class="head">'),t.push(R(u.startTime)),t.push("</p>"),t.push('<p class="content" title="',a," ; ",'">',a,"</p>"),c&&c.updatable&&!_.isUndefined(u.endCid)&&t.push('<div class="resize ui-resizable-handle ui-resizable-s"></div>'),t.push("</div>")}return t.join("")},_getPercentageValue:function(t,n,r){r=r||0,n=n||"round";if(e.inArray(n,["ceil","round","floor"])===-1)throw new Error("Illegal type.");var i=Math.pow(10,r);return Math[n].call(Math,t*i)/i},_getSlotIndexByDate:function(e){return Math.ceil(this._getOffsetYByDate(e)/r)},_getTimelineEvents:function(n){var r={},i=new Array(48);for(var o=0,u=n.length;o<u;o++){if(!n[o])continue;var a=n[o],f=a._ref,l=t(f.startTime),c=this._getSlotIndexByDate(f.startTime),h=this._getSlotIndexByDate(f.endTime),p=h-c;if(q(f,a.range))continue;a.top=l.hour()*60+l.minute()-1,a.height=(p===0?1:p)*s,r[a.id]=a;if(p>0)for(var d=c;d<h;d++)this._createTimeslot(i,a.id,d);else this._createTimeslot(i,a.id,c)}var v=0;for(var d=0,u=i.length;d<u;d++){if(!i[d])continue;var m=i[d].length,g=[];for(var y=0;y<m;y++)g[y]=0;if(m>0)for(var b=0;b<m;b++){var a=r[i[d][b]];v<m&&(v=m),typeof a.hindex=="undefined"&&(a.hindex=e.inArray(0,g)),g[a.hindex]=a.id,a.hindex+1==g.length?typeof a.isLastIndex=="undefined"&&(a.isLastIndex=!0):a.isLastIndex=!1}}for(var w in r){var a=r[w];a.concurrent=v}return r},_createTimeslot:function(e,t,n){return e[n]||(e[n]=[]),e[n].push(t),this}},b}(),J=function(){var e=function(e){var n=t(e.date).clone(),r=new V(n);r.setEvents(e.events),r.setStartday(e.startday),this.timlineView=r,this.options=e};return e.prototype.render=function(){this.timlineView.scrollTo(this.options.scrollTo),this.timlineView.render(this.options)},e}(),K=function(){var e=function(e){var n=t(e.date).clone(),r=n.clone().day(0).add("days",e.startday),i=n.clone().day(6).add("days",e.startday),s=new V(r,i);s.setEvents(e.events),s.setStartday(e.startday),this.timlineView=s,this.options=e};return e.prototype.render=function(){this.timlineView.scrollTo(this.options.scrollTo),this.timlineView.render(this.options)},e}();N.getElement=function(){return C},N.bind=N.on=function(){var t=n.call(arguments);e.fn.on.apply(C,t)},N.unbind=N.off=function(){var t=n.call(arguments);e.fn.off.apply(C,t)},N.resize=function(e){return C.trigger(u.resize,[e]),this},N.changeViewType=function(e){return C.trigger(u.change_view_type,[e]),this},N.changeDate=function(e,t){return C.trigger(u.change_date,[e,t]),this},N.updatePeriodColor=function(e,t){return C.trigger(u.update_period_color,[e,t]),this},N.resetEvents=function(e,t){return t=t||!1,C.trigger(u.reset_events,[e,t]),this},N.render=function(e,t){m.lazy&&Q(e,t)};var Q=function(t,n){typeof t!="undefined"&&t instanceof Array&&(n.clearOld&&m.events.length>0?m.events=t:m.events=m.events.concat(t)),_.each(m.events,function(e){if(_.isUndefined(e.endTime)||_.isNull(e.endTime))e.endTime=e.startTime;else if(_.isUndefined(e.startTime)||_.isNull(e.startTime))e.startTime=e.endTime}),e.extend(!0,m,n||{}),L();switch(m.type){case y.d:(new J(m)).render();break;case y.w:(new K(m)).render();break;case y.m:(new X(m)).render();break;default:return new Error("Illegal view type")}},G=function(){k(),m.lazy||Q()};return G(),N}}).call(this,jQuery,moment);