define(function(require){function a(){location.protocol==="http:"&&window.location.replace(location.href.replace("http:","https:"))}var e=require("jquery"),t=require("backbone"),n=require("models/password_config_info"),r=require("hgn!templates/user/user_password"),i=require("i18n!admin/nls/admin"),s=require("i18n!nls/commons"),o=require("i18n!nls/user");require("jquery.go-popup"),require("jquery.go-sdk");var u=t.View.extend({el:"#content",lang:{title:o["\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd \ud0c0\uc774\ud2c0"],passwordChangeDesc1:o["\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd \uc124\uba851"],passwordChangeDesc2:o["\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd \uc124\uba852"],currentPassword:o["\ud604\uc7ac \ube44\ubc00\ubc88\ud638"],newPassword:o["\uc0c8 \ube44\ubc00\ubc88\ud638"],newPasswordConfirm:o["\ube44\ubc00\ubc88\ud638 \ud655\uc778"],passwordRule1:o["\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd \ucd94\ucc9c\uaddc\uce591"],passwordRule2:o["\ube44\ubc00\ubc88\ud638 \ubcc0\uacbd \ucd94\ucc9c\uaddc\uce592"],checkUseSyncPw:o["\uacb8\uc9c1\uc790 \ube44\ubc00\ubc88\ud638 \ub3d9\uae30\ud654"],checkUseSyncPwDesc:GO.i18n(o["\uacb8\uc9c1\uc790 \ube44\ubc00\ubc88\ud638 \ub3d9\uae30\ud654 \uc124\uba85"],{arg1:GO.session("name")}),multiSiteNamesLabel:o["\ube44\ubc00\ubc88\ud638 \ub3d9\uae30\ud654 \uc0ac\uc774\ud2b8\uba85"],adminContactDesc:o["\uacb8\uc9c1\uc790 \ube44\ubc00\ubc88\ud638 \ub3d9\uae30\ud654 \ubb38\uc758"],complete:o["\ubcc0\uacbd\ud558\uae30"]},initialize:function(){GO.config("trustCertification")===!0&&a(),this.PasswordConfigModel=new n,this.setSyncPwUsable(),this.useSyncPw=!1},render:function(){e("#main").css("min-width","400px"),e("#main").css("background-image","none"),e("#main").attr("class","go_skin_default"),this.$el.html(r({lang:this.lang})),this.$newPassword=this.$el.find("#newPassword"),this.$newPasswordConfirm=this.$el.find("#newPasswordConfirm"),this.$failMessage=this.$el.find("#fail_message"),this.PasswordConfigModel.fetch().done(e.proxy(function(){var e=this._generatePasswordMsg();e==""&&this.$el.find(".passwordRule1").hide(),this.$el.find("#ruleFromPwConfig").text(e),this.isSyncPwUsable&&this.renderIntegratedUserSyncPw()},this))},setSyncPwUsable:function(){this.isSyncPwUsable=GO.session().integratedCompanies.length>1},renderIntegratedUserSyncPw:function(){this.$el.find("#useSyncPw").show();var t=this;e.ajax({url:GO.contextRoot+"api/password/sync/config",type:"GET",success:function(e){e!=null&&(t.useSyncPw=e.useSyncPw,t.multiSiteNames=e.multiSiteNames,t.$el.find("#useSyncPwConfirm").prop("checked",t.useSyncPw),t._appendMultiSiteNames(t.multiSiteNames),t.useSyncPw&&t.$el.find(".wrap_opt_display").show())},error:function(t){var n=JSON.parse(t.responseText);n!=null&&e.goAlert(n.message)}})},_appendMultiSiteNames:function(e){var t="";_.each(e,function(e){t+="<li class='default_option'><span class='name'>"+e+"</span></li>"}),this.$el.find("#multiSiteNames").html(t)},showMultiSiteNames:function(t){var n=this.$el.find(".wrap_opt_display");e(t.currentTarget).is(":checked")?n.show():n.hide()},delegateEvents:function(n){return this.undelegateEvents(),t.View.prototype.delegateEvents.call(this,n),this.$el.on("focusout.userconfig","[name=currentPassword]",e.proxy(this.checkCurrentPassword,this)),this.$el.on("focusout.userconfig","[name=newPasswordConfirm]",e.proxy(this.checkNewPasswordConfirm,this)),this.$el.on("input.userconfig","#useSyncPwConfirm",e.proxy(this.showMultiSiteNames,this)),this.$el.on("click.userconfig","#save",e.proxy(this.saveAction,this)),this.$el.on("click.userconfig","#close",e.proxy(this.close,this)),this},checkNewPasswordConfirm:function(){this.$newPassword.val()!=this.$newPasswordConfirm.val()?this.$failMessage.show().find("span.txt").text(o["\uc0c8\ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]):this.$failMessage.hide()},checkCurrentPassword:function(t){var n=e(t.target);if(!n.val())return;var r=this,i=GO.contextRoot+"api/user/passwordcheck",s={password:n.val()};e.go(i,s,{qryType:"GET",contentType:"application/json",responseFn:function(){r.$el.find("#invalidCurrent").hide()},error:function(e){var t=JSON.parse(e.responseText);r.$el.find("#invalidCurrent").show().find("span.txt").text(t.message)}})},undelegateEvents:function(){return t.View.prototype.undelegateEvents.call(this),this.$el.off(".userconfig"),this},_save:function(){var t=this,n=GO.contextRoot+"api/user/password",r={currentPassword:this.$el.find("#currentPassword").val(),newPassword:this.$newPassword.val(),newPasswordConfirm:this.$newPasswordConfirm.val(),useSyncPw:this.$el.find("#useSyncPwConfirm").prop("checked")};e.go(n,JSON.stringify(r),{qryType:"PUT",contentType:"application/json",responseFn:function(e){t.complete()},error:function(e){var n=JSON.parse(e.responseText);t.$failMessage.show().find("span.txt").text(n.message)}})},close:function(){window.close()},reload:function(){this.render()},complete:function(){var e=['<p class="title" style="margin-top: 56px; font-size: 20px;">',s["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],"</p>"],t=['<div class="btn_wrap"><a id="close" class="btn_major_s"><span class="txt">',s["\ub2eb\uae30"],"</span></a></div>"];this.$el.find("div.glad_msg").html(e.join("")),this.$el.find("div.glad_box").html(t.join(""))},saveAction:function(){console.log("password saveAction call !!");try{this._checkValidation(),this._save()}catch(e){console.log("validation Error :: "+e.message)}return!1},_checkValidation:function(){this.$el.find("div.login_msg").hide(),this._checkEmpty(),this._checkEqual()},_checkEmpty:function(){var t=this;_.each(this.$el.find("#passwordForm input"),function(n,r){if(e(n).val()=="")throw t.$failMessage.show().find("span.txt").text(s["\ube44\ubc00\ubc88\ud638\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694"]),n.focus(),new Error("","\ube44\ubc00\ubc88\ud638\ub97c \uc785\ub825\ud574\uc8fc\uc138\uc694.")})},_checkEqual:function(){if(this.$newPassword.val()!=this.$newPasswordConfirm.val())throw this.$failMessage.show().find("span.txt").text(o["\uc0c8\ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]),this.$newPassword.focus(),new Error("",o["\uc0c8\ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."])},_generatePasswordMsg:function(){var e=this.PasswordConfigModel.attributes,t="",n="",r="";return e.usePasswordConfig&&(t=e.minPasswordLength+"~"+e.maxPasswordLength,e.mandatoryCharAlphabet&&(n+=i.EN),e.mandatoryCharNumber&&(n+=n.length>0?", ":"",n+=i["\uc22b\uc790"]),e.mandatoryCharBlank&&(n+=n.length>0?", ":"",n+=i["\uacf5\ubc31"]),e.mandatoryCharSymbol&&(n+=n.length>0?", ":"",n+=i["\ud2b9\uc218\ubb38\uc790"]),r=GO.i18n(this.lang.passwordRule1,{arg1:t,arg2:n})),r}});return{render:function(){var e=new u;return e.render()}}});