(function(){define(["backbone","app","hgn!templates/navigator/menu_item","i18n!board/nls/board","i18n!nls/commons","jquery.go-popup"],function(e,t,n,r,i){function u(){return!!window.history&&!!history.pushState}var s={},o={alert_check_editor:r["\ud604\uc7ac \uc791\uc131\uc911\uc778 \ub0b4\uc6a9\uc774 \uc788\uc2b5\ub2c8\ub2e4.<br>\ud654\uba74 \uc774\ub3d9 \uc2dc \uc791\uc131 \uc911\uc778 \ub0b4\uc6a9\uc740 \uc0ac\ub77c\uc9d1\ub2c8\ub2e4.<br>\uc774\ub3d9\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],confirm:i["\ud655\uc778"],cancel:i["\ucde8\uc18c"],input_placeholder:r["\uc0c8\ub85c\uc6b4 \uc815\ubcf4, \uae30\ubd84 \uc88b\uc740 \uc18c\uc2dd\uc744 \ubd80\uc11c\uc6d0\ub4e4\uacfc \uacf5\uc720\ud558\uc138\uc694."]};s.Model=e.Model.extend({defaults:{name:"",url:t.config("root"),badge_count:0},hasNoti:function(){return this.get("badge_count")>0},hasSubmenu:function(){return this.get("subMenuType")},isCurrent:function(){return(this.isTargetIFrame()?decodeURIComponent(t.router.getSearch("url")):t.config("root")+t.router.getPackageName())===this.get("url")},isTargetNew:function(){return this.get("location")==="new"},isTargetIFrame:function(){return this.get("location")==="iframe"},isSubMenu:function(){return this.get("parentId")>0}}),s.Collection=e.Collection.extend({model:s.Model,comparator:function(e){return e.get("seq")||e.get("id")},initialize:function(){this._generateFromConfig()},_generateFromConfig:function(){return console.log(t.config("menuList")),_.each(t.config("menuList"),function(e,n){var r=_.clone(e),i=t.config("contextRoot"),s=r.url;s.indexOf(i)!==0&&s.indexOf("http://")!==0&&(r.url=s[0]==="/"?s:i+s),this.add(r,{silent:!0})},this),this}}),s.Collection=function(){function r(){return _.each(t.config("menuList"),function(e,n){var r=_.clone(e),i=t.config("contextRoot"),s=r.url;s.indexOf(i)!==0&&s.indexOf("http://")!==0&&(r.url=s[0]==="/"?s:i+s),this.add(r,{silent:!0})},this),this}var n=e.Collection.extend({model:s.Model,comparator:function(e){return e.get("seq")||e.get("id")},initialize:function(){r.call(this)}});return n}();var a=e.View.extend({tagName:"div",className:"gnb_top_menu",initialize:function(){this.menuArr=this.model.get("subMenu"),this.subMenuLength=this.menuArr.length},render:function(){return _this=this,this.$el.html("<ul />"),this.$listEl=this.$el.find("ul"),_.each(this.menuArr,function(e,t){_this.$listEl.append('<li class="nav-'+e.appName+" "+(t==_this.subMenuLength-1?"last":"")+'" id="topSubmenu'+e.id+'" />'),e["is_submenu?"]=!0,$(n(e)).data({url:e.url,location:e.location,hasSubmenu:!1}).appendTo(_this.$listEl.find("#topSubmenu"+e.id))}),this.$el.hide(),this.el}}),f=e.View.extend({tagName:"li",initialize:function(){_this=this,this.model||(this.model=new s.Model),this.variables=_.extend({},this.model.toJSON(),{url:this.getLinkUrl(),"target_new?":this.model.isTargetNew(),"has_submenu?":this.model.hasSubmenu(),"is_submenu?":!1}),this.$el.addClass("nav-"+this.model.get("appName")),this.model.on("change:badge",this.render,this),t.router.on("change:package",this.render,this)},render:function(){return this.variables.subMenuType&&!this.variables["has_submenu?"]?!1:(this.$el.empty(),$(n(this.variables)).data({url:this.variables.url,location:this.variables.location,hasSubmenu:this.variables["has_submenu?"]}).appendTo(this.$el),this.toggleBadge(),this.el)},getLinkUrl:function(){var e=t.config("root"),n=this.model.get("url");return u()||(e=t.config("root"),e+="#"),this.model.isTargetIFrame()?e+"sitelink?url="+encodeURIComponent(t.util.XSSFilter(n)):n},events:{"click a":"moveMenu"},moveMenu:function(e){e.preventDefault(),this.isReportApp()?this.reportMoveValidate()?this.moveMenuAction(e):this.wirtePageMovePopup(e):t.util.hasActiveEditor()?t.util.isEditorWriting()?this.wirtePageMovePopup(e):$(e.currentTarget).data("hasSubmenu")?this.toggleSubmenu(e):this.moveMenuAction(e):$("#feedContent").val()&&$("#feedContent").val()!=o.input_placeholder?this.wirtePageMovePopup(e):$(e.currentTarget).data("hasSubmenu")?this.toggleSubmenu(e):this.moveMenuAction(e),this.$el.data("current_id",this.model.get("id"))},reportMoveValidate:function(){var e=$("#side").find("li p.on a"),n=e.attr("data-form-flag")=="true"?!0:!1,r=$("#content div.reportCreateArea").length==0?!1:!0;return r?n?!1:!n&&t.util.hasActiveEditor()&&!t.util.isEditorWriting()?!0:!1:!0},isReportApp:function(){return this.getAppName()=="report"},getAppName:function(){return location.href.split("/app/")[1].split("/")[0]},toggleSubmenu:function(e){var t=$(e.currentTarget).parent("li"),n=t.parent("ul"),r=$(e.currentTarget).siblings(".gnb_top_menu");r.is(":visible")?(t.removeClass("on"),t.removeClass("on_layer"),r.hide()):(n.find("li.on").removeClass("on"),n.find("li.on_layer").removeClass("on_layer"),n.find(".gnb_top_menu").hide(),t.addClass("on"),r.show(),r.width()+10>$(document).width()-t.offset().left?r.css("right",$(document).width()-t.offset().left-t.width()):r.css("right","auto"))},moveMenuAction:function(e){var n=$(e.currentTarget).data("url"),r=t.util.parseUrl(n),i=t.util.parseUrl(window.location.href),s=$(e.currentTarget).data("location"),o=new RegExp("(app)","gi");switch(s){case"new":this.popupOpen(n);break;case"iframe":window.location.href=n,u()||window.location.reload();case"self":if(t.config("trustCertification")===!0&&i.protocol==="https:")n=r.href.replace("https:","http:"),window.location.href=n;else if(o.test(n)){var a=n.substr(n.lastIndexOf("/")+1);t.router.navigate(a,{trigger:!0,pushState:!0})}else window.location.href=n;break;default:t.router.navigate("/",{trigger:!0,replace:!0})}},popupOpen:function(e){var t=window.open("about:blank");t.location.href=e},wirtePageMovePopup:function(e){var t=this;$.goPopup({title:"",message:o.alert_check_editor,modal:!0,buttons:[{btext:o.confirm,btype:"confirm",callback:function(){t.moveMenuAction(e)}},{btext:o.cancel,btype:"normal",callback:function(){}}]})},toggleOn:function(){this.$el.removeClass("on bar on_layer"),this.model.isCurrent()&&this.$el.addClass("on")},toggleBadge:function(){this.model.hasNoti()?this.$el.find(".badge").css("visibility","visible"):this.$el.find(".badge").html("&nbsp;").css("visibility","none")},toHTML:function(){var e=document.createElement("span");return e.appendChild(this.el),$(e).html()}});return s.View=e.View.extend({tagName:"ul",className:"1depth",initialize:function(e){this.options=e||{},this.navContainer=this.options.container,this.options.menuWidth,this.collection=new s.Collection,this._bindWindowResizeForNav()},render:function(){var e=$.Deferred(),t=115;return this.$el.empty().append('<li class="more" style="display:none"><a><span class="more" title="more"></span></a><div class="gnb_top_menu" style="display:none"><ul class="2depth"></ul></div></li>'),this.navContainer.append(this.$el),this.collection.each(function(e){var n=new f({model:e}),r=n.render();this.options.menuWidth<t?this.navContainer.find("li.more ul.2depth").append(n.render()):r&&this.navContainer.find("ul.1depth li.more").before(n.render()),t+=this.navContainer.find("ul.1depth li:nth-last-child(2)").width()},this),this.options.menuWidth<t?this.navContainer.find("li.more").show():this.navContainer.find("li.more").hide(),e.resolveWith(this,[this]),e},_bindWindowResizeForNav:function(){var e=new GOWindowResizer;$(window).off(".nav").on("resize.nav",function(n){e.bind(n,function(){t.EventEmitter.trigger("default","changed:resizeTopMenu",this)})})},toHTML:function(){var e=document.createElement("span");return e.appendChild(this.render()),$(e).html()}}),s})}).call(this);