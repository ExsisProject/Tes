define(function(require){var e=require("jquery"),t=require("backbone"),n=require("app"),r=require("collections/deptNodes"),i=require("hgn!templates/mobile/m_dept"),s=require("i18n!nls/commons"),o=require("i18n!approval/nls/approval"),u=require("i18n!survey/nls/survey"),a=require("contact/collections/contacts_org_member");require("GO.util");var f=t.View.extend({id:"mobileOrg",attributes:{"data-role":"layer",style:"background:white; position:absolute; width:100%; min-height:100%; top:0; left:0; z-index:102;"},lastScrollTop:0,unbindEvent:function(){this.$el.off("change","select[name=companySelect]"),this.$el.off("vclick","select[name=companySelect]"),this.$el.off("vclick","#companyText"),this.$el.off("vclick",".depthspan"),this.$el.off("vclick","div.dept_info"),this.$el.off("vclick",".btn.btn_plus"),this.$el.off("vclick",".nameTagItem"),this.$el.off("keyup","#searchKeyword"),this.$el.off("vclick","#btnSearch"),this.$el.off("vclick","#btnSearchResetBtn"),this.$el.off("vclick","a[data-btn='ok']"),this.$el.off("vclick","a[data-btn='cancel']"),e(window).off("scroll")},bindEvent:function(){this.$el.on("change","select[name=companySelect]",e.proxy(this.changeCompany,this)),this.$el.on("vclick","select[name=companySelect]",e.proxy(this.reloadCompany,this)),this.$el.on("vclick","#companyText",e.proxy(this.resetDeptList,this)),this.$el.on("vclick",".depthspan",e.proxy(this.clickBreadcrumbDept,this)),this.$el.on("vclick","div.dept_info",e.proxy(this.clickDeptNode,this)),this.$el.on("vclick",".btn.btn_plus",e.proxy(this.setActive,this)),this.$el.on("vclick",".nameTagItem",e.proxy(this.removeActive,this)),this.$el.on("keyup","#searchKeyword",e.proxy(this.searchKeyEvent,this)),this.$el.on("vclick","#btnSearch",e.proxy(this.search,this)),this.$el.on("vclick","#btnSearchResetBtn",e.proxy(this.resetDeptList,this)),this.$el.on("vclick","a[data-btn='ok']",e.proxy(this.sendSelectedNodes,this)),this.$el.on("vclick","a[data-btn='cancel']",e.proxy(this.back,this)),this.$el.on("vclick","#userNode",e.proxy(this.selectUser,this)),e(window).on("scroll",e.proxy(this.detect_scroll,this))},initialize:function(t){this.options=t||{},this.type=t.type||"mydept",this.selectedNodes=[],this.depts=[],this.users=[],this.deptId=t.deptId||{},this.sendNodesCallback=t.sendSelectedNodesCallback,n.EventEmitter.trigger("common","scrollToTop",this),this.back=_.isFunction(t.backCallback)?this.options.backCallback:this.back,this.lang={btn_ok:s["\ucd94\uac00"],btn_cancel:s["\ucde8\uc18c"],search_placeholder:s["\uc774\ub984 \ub610\ub294 \ubd80\uc11c\uba85\uc744 \uac80\uc0c9\ud574\uc8fc\uc138\uc694."],search_result:s["\uac80\uc0c9\uacb0\uacfc"],select:s["\uc120\ud0dd"],search_result_null:s["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"],all:s["\uc804\uccb4"],include_child_dept:u["\ud558\uc704 \ubd80\uc11c \ud3ec\ud568\ud558\uae30"],department:o["\ubd80\uc11c"],dept_users:s["\ubd80\uc11c\uc6d0"],count:s["\uac1c"],msg_duplicate_activity:o["\uc911\ubcf5\ub41c \ub300\uc0c1\uc785\ub2c8\ub2e4."]},this.options.lang=this.lang,this.type==="mydept"?this.options.lang.title=o["\uacb0\uc7ac\uc790 \ucd94\uac00"]:this.type==="docReferenceReaders"?this.options.lang.title=o["\ucc38\uc870\uc790 \ucd94\uac00"]:this.type==="docReceptionReaders"?this.options.lang.title=o["\uc218\uc2e0\uc790 \ucd94\uac00"]:this.type==="docReadingReaders"?this.options.lang.title=o["\uc5f4\ub78c\uc790 \ucd94\uac00"]:this.type==="custom"&&(this.options.lang.title=o["\ub2f4\ub2f9\uc790 \uc9c0\uc815"]),this.tplUnit={listUser:Hogan.compile('<li id="userNode" data-id="{{type}}_{{nodeId}}"><a class="btn btn_plus" value="{{type}}_{{id}}" id="userSort_{{id}}"></a><a class="tit"><div class="photo"><img src="{{thumbnail}}"></div><div class="info" data-id="{{type}}_{{id}}"><span class="name txt_ellipsis">{{displayName}}</span><span class="mail txt_ellipsis"><span class="department">{{deptName}}</span>{{#isMultiCompany}}<span class="part">  |  </span><span class="department">{{companyName}}</span>{{/isMultiCompany}}</span></span></div></a> </li>'),listDept:Hogan.compile('<li id="deptNode" data-id="{{type}}_{{id}}"><a class="btn btn_plus" value="{{type}}_{{id}}" id="userSort_{{id}}"></a><a class="tit">{{#isMultiCompany}}<span class="multi_company"><span class="txt">{{companyName}}</span></span>{{/isMultiCompany}}<div class="depart"><span class="txt">{{department}}</span></div><div class="info dept_info" data-id="{{type}}_{{id}}"><span class="name txt_ellipsis">{{title}}</span>{{#hasDeptChildren}}<span class="ic ic_arrow4" style="display: inline-block"></span>{{/hasDeptChildren}}</div></a></li>'),deptItem:Hogan.compile('<a id="sub_dept" class="depthspan" data-id="{{deptId}}">{{deptName}}</a>'),companyOptions:Hogan.compile('<option value="{{id}}">{{title}}</option>'),companySelect:Hogan.compile('<select id="companySelect" name="companySelect"></select>'),companyText:Hogan.compile('<a id="companyText">{{all}}</a>'),deptNameTagTpl:Hogan.compile('<a value="{{dataId}}" class="nameTagItem"><li><div class="depart"><span class="txt">{{department}}</span></div><span class="name">{{name}}</span><span class="btn_wrap" id="btn_del"  value="{{dataId}}"><span class="btn btn_del_type2"></span></span></li></a>'),deptNameWithSubDeptTagTpl:Hogan.compile('<a value="{{dataId}}" class="nameTagItem"><li><div class="depart"><span class="txt">{{department}}</span></div><span class="name">{{name}}</span><span class="name_option">{{included_depts}}</span><span class="btn_wrap" id="btn_del"  value="{{dataId}}"><span class="btn btn_del_type2"></span></span></li></a>'),userNameTagTpl:Hogan.compile('<a value="{{dataId}}" class="nameTagItem"><li><div class="photo"><img src="{{thumbnail}}"></div><span class="name">{{name}}</span><span class="btn_wrap" id="btn_del"  value="{{dataId}}"><span class="btn btn_del_type2"></span></span></li></a>'),emptyActiveTab:Hogan.compile('<div class="form_tr" id="emptyActiveTab"><div class="form_td"><div class="data_null">{{emptyTab}}</div></div></div>'),listNull:Hogan.compile('<li class="creat data_null"><span class="txt">{{search_result_null}}</span></li>'),employeeNewWrap:'<div class="list_employee_new"><ul class="name_tag" id="activeBar"></ul></div>'},this.collection=new r({type:this.type,deptid:this.deptId}),this.collection.fetch({reset:!0,async:!0,statusCode:{403:function(){e(".wrap_search").hide()}}}),this.useSiteName=n.config("useSiteNameConfig"),this.collection.bind("reset",this.setHeaderBreadList,this),this.collection.bind("reset",this.setOrgAndUserItems,this)},render:function(){this.unbindEvent(),this.bindEvent(),this.$el.css("height",e(document).height()+"px").html(i(this.options)),e("body").append(this.el),this.type==="custom"&&e("div.list_employee_new").remove()},selectUser:function(t){if(this.type!=="custom")return;if(e(t.currentTarget).hasClass("choise")){e(t.currentTarget).removeClass("choise");return}var n=e(t.currentTarget).attr("data-id");e("#deptPeopleItem").children().removeClass("choise"),e(t.currentTarget).addClass("choise");var r=_.first(_.filter(this.users,function(e){var t=e.type+"_"+e.nodeId;return t===n}));this.selectedNodes=[],this.selectedNodes.push(r)},setActive:function(t){t.preventDefault();var n=e.extend({},this.depts),r=e.extend({},this.users),i=e(t.currentTarget).attr("value"),s=i.split("_")[0],u=i.split("_")[1],a=_.find(n,function(e){return e.type===s&&e.id==u}),f=_.find(r,function(e){return e.type==s&&e.id==u});if(_.isUndefined(a)&&_.isUndefined(f))throw new Error("\uc798\ubabb\ub41c \uc751\ub2f5\uc785\ub2c8\ub2e4");var l=_.isUndefined(a)?f:a;l.dataId=i,s=="org"&&(this.type==="docReferenceReaders"||this.type==="docReadingReaders"||this.type==="docReceptionReaders")&&(l.includedSubDept=confirm(this.options.lang.include_child_dept));var c=_.some(this.selectedNodes,function(e){return e.dataId===i});if(c){GO.util.toastMessage(this.lang.msg_duplicate_activity);return}this.selectedNodes.push(l),e("div.list_employee_new").length<1&&e("div.docu_search").before(this.tplUnit.employeeNewWrap),e("#activeBar").append(s!="org"?this.tplUnit.userNameTagTpl.render(l):l.includedSubDept?this.tplUnit.deptNameWithSubDeptTagTpl.render({dataId:l.dataId,department:o["\ubd80\uc11c"],name:l.name,included_depts:o["\ud558\uc704 \ud3ec\ud568"]}):this.tplUnit.deptNameTagTpl.render({dataId:l.dataId,department:o["\ubd80\uc11c"],name:l.name})),this.scrollToRightEnd("#activeBar")},scrollToRightEnd:function(t){var n=e(t),r=n[0].scrollWidth;n.scrollLeft(r)},removeActive:function(t){t.preventDefault();var n=e(t.currentTarget).attr("value"),r=this.selectedNodes;this.selectedNodes=_.filter(r,function(e){return e.dataId!==n}),_.isEmpty(this.selectedNodes)&&e("div.list_employee_new").remove(),this.$el.find(".name_tag").find("a[value="+n+"]").remove(),this.$el.find("#select_count").text(this.selectedNodes.length+" \uac1c")},setHeaderBreadList:function(t){var n=this,r=this.$el.find("#userCheckedScroll"),i=t.toJSON();if(this.isMultiSite(i))r.html(this.tplUnit.companySelect.render()),e.each(i,function(e,t){n.$el.find("#companySelect").append(n.tplUnit.companyOptions.render({id:t.data.id,title:t.data.title}))});else if(this.type==="custom"){var s=i[0],o;this.useSiteName?o=s.children[0].data.title:o=s.data.title,r.html(this.tplUnit.companyText.render({all:o}))}else r.html(this.tplUnit.companyText.render({all:this.options.lang.all}))},setOrgAndUserItems:function(e){this.clearNodes();var t;this.hasMultiCompany=this.isMultiSite(_.map(e.models,function(e){return e.attributes}));if(this.hasMultiCompany){var n=e.models[0];t=n.attributes.children}else this.useSiteName===!1?t=e.toJSON():t=_.first(_.map(e.models,function(e){return e.attributes.children}));this.type==="custom"&&(t=_.first(t).children),this.setDeptUsersNodes(t),this.drawItems()},isMultiSite:function(e){var t=_.filter(e,function(e){return e.data.id.indexOf("company")!==-1});return t.length>1},clickDeptNode:function(t){var n=e(t.currentTarget);n.prop("disabled",!0);if(n.find(".ic.ic_arrow4").length===0)return;var i=e.goPreloader();t.preventDefault();var s=this,o=n.attr("data-id").split("_")[1],u=n.text();i.render(),this.childCollection=new r({type:this.type,deptid:o}),this.childCollection.fetch({success:function(t){i.release(),e("#userCheckedScroll").append(s.tplUnit.deptItem.render({deptId:o,deptName:u})),s.scrollToRightEnd("#userCheckedScroll"),t=t.toJSON(),s.type==="custom"&&(t=_.first(_.map(t,function(e){return e.children})),s.useSiteName===!0&&(t=_.first(t).children)),s.resetDeptItem(t)},error:function(e,t,n){GO.util.toastMessage(t.responseText),i.release()}})},clickCompany:function(t){t.preventDefault(),e("#companyText").nextAll().remove();var n=e.goPreloader();n.render(),this.collection=new r({type:this.type,deptid:this.deptId}),this.collection.fetch({success:e.proxy(function(e){this.type==="custom"?(e=_.first(_.map(e.models,function(e){return e.attributes.children})),this.useSiteName===!0&&(e=_.first(e).children)):e=_.flatten(_.map(e.toJSON(),function(e){return e.children})),n.release(),this.resetDeptItem(e)},this),error:function(e,t,r){n.release(),GO.util.toastMessage(t.responseText)}})},changeCompany:function(t){e("#companySelect").nextAll().remove(),this.collection=new r({type:this.type,deptid:this.deptId}),this.collection.fetch({success:e.proxy(function(e){this.companyReset(e)},this),error:function(e,t,n){GO.util.toastMessage(t.responseText)}})},reloadCompany:function(){this.changeCompany()},clickBreadcrumbDept:function(t){var n=this,i=e(t.currentTarget);i.nextAll().remove();var s=i.attr("data-id"),o=e.goPreloader();o.render(),this.collection=new r({type:this.type,deptid:s}),this.collection.fetch({success:e.proxy(function(e){o.release(),e=e.toJSON(),n.type==="custom"&&(e=_.first(_.map(e,function(e){return e.children})),this.useSiteName===!0&&(e=_.first(e).children)),this.resetDeptItem(e)},this),error:function(e,t,n){o.release(),GO.util.toastMessage(t.responseText)}})},companyReset:function(t){this.clearNodes();var n=_.map(t.models,function(e){return e.attributes}),r=_.find(n,function(t){return t.data.id===e("#companySelect").val()});this.setDeptUsersNodes(r.children),this.drawItems()},setDeptUsersNodes:function(t){e.each(t,e.proxy(function(e,t){if(t.data.id.includes("org")){var n=t.metadata.childrenCount>0||t.metadata.memberCount>0;this.depts.push({title:t.data.title,id:t.metadata.id,email:t.metadata.email,originalEmail:t.metadata.email,name:t.metadata.name,type:t.data.id.split("_")[0],includedSubDept:!1,code:t.metadata.code,useReception:t.metadata.useReception,useReference:t.metadata.useReference,hasDeptChildren:n})}else _.contains(["MASTER","MODERATOR","MEMBER"],t.data.id.split("_")[0])&&this.users.push({nodeId:t.attr.nodeId,id:t.metadata.id,companyName:t.metadata.companyName,email:t.metadata.email,originalEmail:t.metadata.email,name:t.metadata.name,type:t.data.id.split("_")[0],duty:t.metadata.duty,deptId:t.metadata.deptId,deptName:t.metadata.deptName,position:t.metadata.position,displayName:t.metadata.name+t.metadata.position,thumbnail:t.metadata.thumbnail,employeeNumber:t.metadata.employeeNumber,loginId:t.metadata.loginId})},this))},clearNodes:function(){e("#deptItem").empty(),e("#deptPeopleItem").empty(),this.depts=[],this.users=[]},resetDeptItem:function(e){this.clearNodes(),this.setDeptUsersNodes(e),this.drawItems()},drawItems:function(){var t=e("#dept_list_title"),n=e("#users_list_title");this.depts.length===0?t.hide():t.show(),this.users.length===0?n.hide():n.show(),_.each(this.depts,e.proxy(function(e){e.department=o["\ubd80\uc11c"],this.$el.find("#deptItem").append(this.tplUnit.listDept.render(e))}),this),_.each(this.users,e.proxy(function(e){this.$el.find("#deptPeopleItem").append(this.tplUnit.listUser.render(e))}),this),this.type==="custom"&&e(".btn_plus").remove()},searchKeyEvent:function(e){return e.preventDefault(),e.keyCode===13&&this.search(),!1},search:function(e){var t=this.$el.find("#searchKeyword").val();this.$el.find(".bcr").hide(),this.$el.find("#dept_list_title");if(!t){GO.util.toastMessage(s["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."]);return}return this.getDeptUserList(0,t),this.$el.find(".ic.ic_arrow4").remove(),!1},getDeptUserList:function(e,t){var n={},r={};this.type==="custom"&&(n="department",r=this.deptId);var i=a.getCollection(null,t,e,n,r);this.searchedResult(i.toJSON())},searchedResult:function(t){this.clearNodes(),this.users=[],this.depts=[];if(t.length<1){e(".docu_body .list_title").show(),e("#deptItem").html(this.tplUnit.listNull.render(this.lang)),e("#deptPeopleItem").html(this.tplUnit.listNull.render(this.lang));return}_.each(t,e.proxy(function(e){e.nodeType=="user"?this.users.push({nodeId:e.employeeNumber,id:e.id,companyName:e.companyName,email:e.email,originalEmail:e.originalEmail,name:e.name,type:"user",duty:e.duties[0],deptId:e.departmentIds[0],deptName:e.departments[0],position:e.position,displayName:e.name+e.position,thumbnail:e.thumbnail,employeeNumber:e.employeeNumber,loginId:e.loginId,isMultiCompany:this.hasMultiCompany}):e.nodeType=="department"&&this.depts.push({title:e.name,id:e.id,email:e.email,originalEmail:e.email,name:e.name,type:"org",includedSubDept:!1,userReception:e.useReception,useReference:e.useReference,isMultiCompany:this.hasMultiCompany,companyName:e.companyName})},this)),this.drawItems()},resetDeptList:function(){return this.$el.find("#searchKeyword").val(""),this.collection=new r({type:this.type,deptid:this.deptId}),this.$el.find(".bcr").show(),this.collection.fetch({success:e.proxy(function(e){this.$el.find("#companySelect").show(),this.setHeaderBreadList(e),this.setOrgAndUserItems(e)},this),error:function(e,t,n){GO.util.toastMessage(t.responseText)}}),!1},sendSelectedNodes:function(e){var t=this.selectedNodes;return this.sendNodesCallback(this,e,t),!1},back:function(t){return e("#mobileOrg").remove(),t.preventDefault(),!1},close:function(t){return e("#mobileOrg").remove(),t.preventDefault(),!1},detect_scroll:function(t){if(_.isUndefined(t.currentTarget))return;var n=e("#scrollToTop"),r=t.currentTarget.scrollY;r>this.lastScrollTop?n.hide():r<this.lastScrollTop&&r>30?n.show():n.hide(),this.lastScrollTop=r}});return f});