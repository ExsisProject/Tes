(function(){define(["jquery","backbone","app","collections/userSearch","collections/deptSearch","collections/circle_nodes","hgn!templates/mobile/m_org","i18n!nls/commons","GO.util","iscroll"],function(e,t,n,r,i,s,o,u){var a=t.View.extend({id:"mobileOrg",attributes:{"data-role":"layer",style:"background:#fff; position:absolute; width:100%; min-height:100%; top:0; left:0; z-index:999"},unbindEvent:function(){this.$el.off("vclick","a[data-btn='paging']"),this.$el.off("vclick","a[data-btn='cancel']"),this.$el.off("vclick","a#btnSearch"),this.$el.off("vclick","a#btnSearchReset"),this.$el.off("vclick","li span.ic_del"),this.$el.off("keyup","#searchKeyword"),this.$el.off("change","ul#userListEls input[value]"),this.$el.off("change","input#userCheckedAll")},bindEvent:function(){this.$el.on("vclick","a[data-btn='paging']",e.proxy(this.paging,this)),this.$el.on("vclick","a[data-btn='cancel']",e.proxy(this.back,this)),this.$el.on("vclick","a#btnSearch",e.proxy(this.search,this)),this.$el.on("vclick","a#btnSearchReset",e.proxy(this.searchReset,this)),this.$el.on("vclick","ul#userCheckedEls span.ic_del",e.proxy(this.deleteUserEl,this)),this.$el.on("keyup","#searchKeyword",e.proxy(this.searchKeyEvent,this)),this.$el.on("change","ul#userListEls input[value]",e.proxy(this.changeCheckedUser,this)),this.$el.on("change","input#userCheckedAll",e.proxy(this.changeCheckedAll,this))},events:{"vclick a[data-btn='ok']":"checkedSave"},initialize:function(n){var o=this;this.$listEl=null,this.$checkedUserEl=null,this.checkedUserScroll=null,this.options={title:"\uae30\ubcf8\ud0c0\uc774\ud2c0",offset:100,btn_ok:u["\ud655\uc778"],btn_cancel:u["\ucde8\uc18c"],search_placeholder:[u["\uc774\ub984"],[u["\uc544\uc774\ub514"]]].join(", "),search_result:u["\uac80\uc0c9\uacb0\uacfc"],search_result_null:u["\uac80\uc0c9\uacb0\uacfc\uc5c6\uc74c"],type:n.type||{},isSingleSelect:n.isSingleSelect||!1,isDept:n.type=="department"},this.tplUnit={search_result:Hogan.compile('<div class="search_result">{{^isSingleSelect}}<input type="checkbox" id="userCheckedAll">{{/isSingleSelect}}<span class="txt">{{search_result}} {{{totalCount}}}</span></div>'),listUser:Hogan.compile('<li><input type="checkbox" value="{{id}}" id="userSort{{id}}" {{checked}}><label for="userSort{{id}}"><a class="tit" data-bypass><div class="photo"><img src="{{thumbnail}}"></div><div class="info"><span class="name txt_ellipsis">{{name}} {{position}}</span><span class="mail txt_ellipsis">{{email}} {{{departmentNames}}}</span></div></a></label></li>'),listDept:Hogan.compile('<li><input type="checkbox" value="{{id}}" id="userSort{{id}}" {{checked}}><label for="userSort{{id}}"><a class="tit" style="margin-left:0px" data-bypass><div class="info"><span class="name txt_ellipsis">{{name}}</span><span class="mail txt_ellipsis">{{email}} {{{departmentNames}}}</span></div></a></label></li>'),listNull:Hogan.compile('<li class="creat data_null"><span class="txt">{{search_result_null}}</span></li>'),checkedUser:Hogan.compile('<li data-userid="{{id}}"><span class="name">{{name}} {{position}}</span><span class="btn_wrap" data-btntype="attendeeDelete"><span class="ic ic_del"></span></span></li>')};var a=new s({circle:n.circle,type:"member"});this.options.type=="circle"?this.collection=a:this.options.type=="department"?this.collection=new i:this.collection=new r,this.collection.on("reset",function(n,r){o.users=n;var i=[],s=null;checkedIds=o.getCheckedIds(),itemTpl=o.options.isDept?o.tplUnit.listDept:o.tplUnit.listUser,o.items=n.circle?new t.Collection(n.listParser()):n,e.each(o.items.toJSON(),function(t,n){i.push(itemTpl.render(e.extend(n,{checked:e.inArray(n.id,checkedIds)>-1?"checked":"",thumbnail:o.options.type=="circle"?n.thumbnail:(GO.contextRoot+n.thumbnail).replace("//","/"),departmentNames:function(){return this.departments&&this.departments.length>0?'<span class="part">|</span><span class="department">'+this.departments.join(", ")+"</span>":""}})))}),i.length||i.push(o.tplUnit.listNull.render(o.options)),s=GO.util.mPaging(n),o.$listEl.siblings(".paging, .search_result").remove(),o.$listEl.html(i.join("")).after(s),r.data.keyword&&n.page.total>0&&o.$listEl.before(o.tplUnit.search_result.render(e.extend(o.options,{totalCount:GO.i18n(u["\ucd1d\uac74\uc218"],{num:n.page.total})})))})},render:function(){var t=this;this.unbindEvent(),this.bindEvent(),this.options=e.extend(this.options,arguments[0]||{}),this.$el.html(o(this.options)),this.$listEl=this.$el.find("ul#userListEls"),this.$checkedUserEl=this.$el.find("ul#userCheckedEls"),e("body").append(this.el),this.getDeptUserList(0),e.each(this.options.checkedUser||[],function(e,n){n.name=n.username,t.addCheckedUserEl(n)})},search:function(){var e=this.$el.find("#searchKeyword").val();return e||alert(u["\uac80\uc0c9\uc5b4\ub97c \uc785\ub825\ud558\uc138\uc694."]),this.getDeptUserList(0,e),!1},searchReset:function(){return this.$el.find("#searchKeyword").val(""),!1},searchKeyEvent:function(e){return e.preventDefault(),e.keyCode==13&&this.search(),!1},getDeptUserList:function(t,n){this.collection.type=n?"tree/search":"member";var r={page:t||0,offset:10,keyword:n||""},i={async:!0,reset:!0};if(this.options.type=="circle"){i.beforeSend=function(e){e.setRequestHeader("Content-Type","application/json")},i.type="POST";if(n){var s=e.param(r);this.collection.type=this.collection.type+"?"+s}i.data=JSON.stringify(this.collection.circle)}else i.data=r;this.collection.fetch(i),e("#mobileOrg").css("min-height",e("#main").height()+"px")},getCheckedIds:function(){return e(this.$checkedUserEl.find("li")).map(function(t,n){return Number(e(n).attr("data-userid"))}).get()},getCheckedData:function(){return e(this.$checkedUserEl.find("li")).map(function(t,n){return e(n).data()}).get()},changeCheckedUser:function(t,n){var r=t?e(t.currentTarget):e(n),i=r.val(),s=r.is(":checked"),o=null;this.$checkedUserEl.find('li[data-userid="'+i+'"]').remove(),s&&(o=this.items.get(i).toJSON(),this.addCheckedUserEl(o))},changeCheckedAll:function(t){var n=e(t.currentTarget),r=n.is(":checked");_.each(this.$listEl.find("input[type=checkbox]"),function(t){e(t).attr("checked",r),this.changeCheckedUser(null,t)},this)},deleteUserEl:function(t){var n=e(t.currentTarget).parents("li"),r=this.$el.find("#userCheckedScroll");this.$listEl.find('input[type="checkbox"][value="'+n.data("userid")+'"]').removeAttr("checked"),n.remove(),r.find("li").length==0&&r.hide();return},addCheckedUserEl:function(t){if(this.checkedUserScroll==null){this.$el.find("#userCheckedScroll").css({position:"relative","max-height":"98px"}).find("ul").css("padding","5 0");var n=!GO.util.isMobileApp()&&(GO.util.checkOS()=="iphone"||GO.util.checkOS()=="ipad");this.checkedUserScroll=new IScroll("#userCheckedScroll",{bounce:!1,disablePointer:!0,disableMouse:!1,disableTouch:n,preventDefault:n}),n||(this.checkedUserScroll.on("zoomStart",function(t){e("#userCheckedScroll").css("overflow-x","").css("overflow-y","")}),this.checkedUserScroll.on("zoomEnd",function(t){e("#userCheckedScroll").css("overflow-x","scroll").css("overflow-y","hidden")}))}else this.checkedUserScroll.refresh();this.options.isSingleSelect&&this.resetAll(t);var r=this.tplUnit.checkedUser.render(t);this.$el.find("#userCheckedScroll").show(),this.$checkedUserEl.append(e(r).data({id:t.id,name:t.name,position:t.position}))},checkedSave:function(t){t&&e(t.currentTarget).blur().trigger("focusout"),typeof this.options.callback=="function"&&this.options.callback(this.getCheckedData()),this.back();return},back:function(t){var n=this;setTimeout(function(){return typeof n.options.backCallback=="function"&&n.options.backCallback(),e("#mobileOrg").remove(),t&&t.stopPropagation(),!1},500)},paging:function(t){GO.EventEmitter.trigger("common","layout:scrollToTop",this);var n=e(t.currentTarget).attr("data-direction"),r=this.items.page.page||0;return n=="prev"&&r>0?r--:n=="next"&&r++,e(t.currentTarget).parents(".paging").remove(),this.$listEl.empty(),this.getDeptUserList(r),t.stopPropagation(),!1},resetAll:function(e){this.$checkedUserEl.find("li[data-userid]").remove(),this.$el.find("#userCheckedScroll").hide(),this.$listEl.find("input:not(input[value="+e.id+"])").attr("checked",!1)}});return a})}).call(this);