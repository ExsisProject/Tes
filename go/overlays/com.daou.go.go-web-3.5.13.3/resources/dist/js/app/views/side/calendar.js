(function(){define(["underscore","backbone","app","hogan","i18n!nls/commons","i18n!../../../calendar/nls/calendar","hgn!templates/side/calendar"],function(e,t,n,r,i,s,o){var u,a,f,l;return a=n.BaseCollection.extend({apiUrl:n.config("contextRoot")+"api/calendar/user/me/event/daily?",conditions:{year:0,month:0},url:function(){return this.apiUrl+$.param(this.conditions)},setCondition:function(e){return this.conditions=e,this},setConditionByDate:function(e){return this.setCondition({year:e.year(),month:e.month()+1}),this}}),u=t.Model.extend({apiUrl:n.config("contextRoot")+"api/calendar/user/me/event/daily?",conditions:{year:0,month:0},url:function(){return this.apiUrl+$.param(this.conditions)},setCondition:function(e){return this.conditions=e,this},setConditionByDate:function(e){return this.setCondition({year:e.year(),month:e.month()+1}),this}}),f=t.View.extend({tagName:"td",content:{},initialize:function(e){this.options=e,this.datetime=moment(this.model.get("datetime"))},render:function(){var e=[];return e.push("<span id='"+n.util.toISO8601(this.datetime)+"'>"),e.push(this.datetime.date()),this._calculateBadgeCount()>0&&e.push("<span class='badge'>"+this._calculateBadgeCount()+"</span>"),e.push("</span>"),this.$el.html(e.join("")),this.$el.attr("class",this._makeTdClass()),this.$el},_makeTdClass:function(){var e="";return n.util.isToday(this.datetime)&&(e+="on "),this.datetime.day()==0&&(e+="sun "),this.options.current.month()!=this.datetime.month()&&(e+="other_month "),n.util.isBeforeToday(this.datetime)&&(e+="past "),e},_calculateBadgeCount:function(){return this.model.get("eventList").length}}),l=t.View.extend({tagName:"div",className:"layer_normal layer_calendar",current:null,isFirstRendering:!0,WEEK_COUNT_FOR_CACHE:2,WEEK_DAYS_COUNT:7,myEventsViewCallback:function(e){console.log("Any callback didn't binded from MyEventsView!")},events:{"click td":"onItemClicked","click #prev_month":"goToPrevMonth","click #next_month":"goToNextMonth"},initialize:function(e){this.options=e||{},this.current=this.options.current?this.options.current:moment(new Date),this.model=new u,this.options.callback&&(this.myEventsViewCallback=this.options.callback)},onItemClicked:function(e){var t=$(e.target).get(0).tagName=="TD"?$(e.target):$(e.target).parents("td"),n=t.children("span:first-child").attr("id");n&&this._handleCallback(moment(n)),this._addClassToCurrentSelected(t)},_handleCallback:function(r){if(this.model.get("licenseAllowed")==1){var i=[];for(var s=0;s<3;s++){var o=r.clone().startOf("days").add("days",s),u=e.find((new t.Collection(this.model.get("list"))).models,function(e){return n.util.isSameDate(e.get("datetime"),o)});i.push(u)}this.myEventsViewCallback(i)}else this.$el.next().hide()},_addClassToCurrentSelected:function(e){this.$el.find("tbody").find("td").removeClass("select_on"),e.addClass("select_on")},goToPrevMonth:function(){this.current=this.current.subtract("months",1),this.render()},goToNextMonth:function(){this.current=this.current.add("months",1),this.render()},render:function(){return this.$el.empty().html(o(this._makeAppLabels())),this.model.setConditionByDate(this.current).fetch().done($.proxy(function(){this._renderItems(new t.Collection(this.model.get("list"))),this.isFirstRendering&&(this.isFirstRendering=!1,this._handleCallback(this.current))},this)),this.$el},_makeAppLabels:function(){return{title:n.util.formatDatetime(this.current,null,"YYYY. MM"),prev:i["\uc774\uc804"],next:i["\ub2e4\uc74c"],sun:s["\uc77c"],mon:s["\uc6d4"],tue:s["\ud654"],wed:s["\uc218"],thu:s["\ubaa9"],fri:s["\uae08"],sat:s["\ud1a0"]}},_renderItems:function(e){var t=this._makeItemViews(e),n=this._drawWeekRows(t.length);this._appendItems(t,n)},_makeItemViews:function(e){var t=[];return e.each(function(e,n){var r=new f({current:this.current,model:e});t.push(r.render())},this),t},_drawWeekRows:function(e){var t=this.$el.find("tbody"),n=e/this.WEEK_DAYS_COUNT,r=n-this.WEEK_COUNT_FOR_CACHE;for(var i=0;i<r;i++)t.append("<tr></tr>");return t.find("tr")},_appendItems:function(t,n){var r=function(e,t){for(var n=0;n<t.WEEK_DAYS_COUNT;n++)e.pop(),e.shift();return e};e.each(r(t,this),function(e,t){var r=Math.floor(t/this.WEEK_DAYS_COUNT);n.eq(r).append(e)},this)}}),l})}).call(this);