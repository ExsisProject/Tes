define(["underscore","backbone","amplify","app"],function(e,t,n,r){return t.Collection.extend({initialize:function(e,t){this.options=t||{},this.pageNo=0,this.total=0,this.extData=null,this.pageSize=this.options.offset?this.options.offset:amplify.store(r.session("loginId")+"-"+this._storeKey()+"-pagesize"),this.deferred=$.Deferred(),this.isFetching=!1,typeof this.pageSize!="undefined"||this.setPageSize(20),this.setAttributes(t),this.options.restoreParam!==!1&&this.restoreParam()},fetch:function(n){if(this.isFetching)return this.deferred;typeof n!="undefined"||(n={}),this.trigger("fetching"),this.isFetching=!0;var r=this,i=n.success;return n.success=function(e){r.trigger("fetched"),r.isFetching=!1,i&&i(r,e)},n.reset=!0,t.Collection.prototype.fetch.call(this,n).done(e.bind(function(){this.deferred.resolve()},this)),this.deferred},parse:function(e){return this.pageNo=e.page.page,this.pageSize=e.page.offset,this.total=e.page.total,this.extData=e.extParameter,e.data},pageInfo:function(){var e=Math.ceil(this.total/this.pageSize),t={total:this.total,pageNo:this.pageNo,pageSize:this.pageSize,lastPageNo:e?e-1:0,pages:[],prev:!1,next:!1},n=this.navigationSize?this.navigationSize:10,r=Math.floor(t.pageNo/n)*n,i=Math.ceil((t.pageNo+1)/n)*n;for(var s=r;s<i;s++){if(s>t.lastPageNo)break;t.pages.push(s)}return this.pageNo>0&&(t.prev=!0),this.pageNo<t.lastPageNo&&(t.next=!0),t},goPage:function(e){return this.pageNo=e,this.fetch()},nextPage:function(){return this.pageInfo().next?(this.pageNo=this.pageNo+1,this.fetch()):!1},prevPage:function(){return this.pageInfo().prev?(this.pageNo=this.pageNo-1,this.fetch()):!1},setPageSize:function(e,t){t=t!==!1,this.pageSize=e,t&&amplify.store(r.session("loginId")+"-"+this._storeKey()+"-pagesize",e)},setPageNo:function(e){this.pageNo=e},setSearchType:function(e){this.searchType=e},setKeyword:function(e){this.keyword=e},getKeyword:function(){return this.keyword},makeParam:function(){var t={},n=$.param({page:this.pageNo,offset:this.pageSize});return this.keyword&&(n+="&keyword="+encodeURIComponent(this.keyword)),this.property&&(t.property=this.property),this.direction&&(t.direction=this.direction),this.searchType&&(t.searchType=this.searchType),e.isEmpty(t)||(n+="&"+$.param(t)),n},setDuration:function(){},storeParam:function(){r.util.setRouterStorage("param",this._getParam())},restoreParam:function(){var t=r.util.getRouterStorage();t&&t.path==location.pathname&&e.each(t.param,function(e,t){this[t]=e},this)},_getParam:function(){return{pageNo:this.pageNo,pageSize:this.pageSize,keyword:this.keyword,property:this.property,direction:this.direction,searchType:this.searchType}},setAttributes:function(t){e.each(t,function(e,t){this[t]=e},this)},_storeKey:function(){return location.pathname.replace(/[0-9]/g,"")},isEmpty:function(){return this.size()==0},mobilePageInfo:function(){var e=this.pageInfo(),t=e.pageNo,n=e.total,r=e.pageSize,i=e.pageNo===e.lastPageNo,s=t*r+1,o=i?n:(t+1)*r;return{lastIndex:o,firstIndex:s}}})});