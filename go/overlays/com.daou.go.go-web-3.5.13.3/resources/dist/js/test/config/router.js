(function(){var e=this;define(["backbone","app","json!configs/routes.json","json!configs/routes.custom.json","backbone.routefilter"],function(t,n,r,i){var s=document.getElementsByTagName("meta"),o;for(var u in s)s[u].name==="device"&&(o=s[u].content);var a=o?o:n.config("instanceType"),f=n.config("packages"),l=null,c=new RegExp("^([a-zA-Z0-9/=_-]*:)+(.*)$"),h=Array.prototype.slice,p="("+["my","sitelink",f.join("|")].join("|")+")",d=t.Router.extend({initialize:function(){},navigate:function(e,n){return this.getPackageName()!=="home"&&(t.history.fragment=null),t.Router.prototype.navigate.call(this,e,n)},getPackageName:function(){return l},setPackageName:function(e){l!==e?(l=e,this.trigger("change:package",l)):this.trigger("change:page",l)},getRootUrl:function(){var t=null;return e.location&&(t=e.location.protocol+"//"+e.location.host+n.config("root")),t},getSendMailUrl:function(t){var n=null,r=null;typeof t=="object"?(r=$.grep([t.name,t.position,t.department],function(e,t){return e!==""&&e!==undefined}),r.length?r=r.join("/"):r="",r+=" <"+t.email+">"):r=t;var i={to:r};return e.location&&(n=this.getRootUrl()+"app/mail/popup/process?data=to="+encodeURIComponent(JSON.stringify(i))),n},getUrl:function(e){var t=this.getRootUrl(),e=e||location.href;return this.isEqualToRootUrl(e)?e.slice(t.length):e},getSearch:function(t){var n=/[\?](.*)?/,r=e.location.search||e.location.hash,i=n.exec(r),s={};return n.test(r)&&i[1]!=null&&_.each(i[1].split("&"),function(e,t){var n=(e.indexOf("%5B%5D")||e.indexOf("[]"))>0,r=e.split("=");if(n){var i=decodeURIComponent(e).split("[]")[0],o=s[i]||[];s[i]=_.union(o,[decodeURIComponent(r[1])])}else s[r[0]]=decodeURIComponent(r[1])},this),typeof t!="undefined"?s[t]:s},isEqualToRootUrl:function(e){var t=this.getRootUrl();return e.slice(0,t.length)===t},before:function(e){this._parseFragment()},_parseFragment:function(){var e=t.history.getFragment(),n=this._generateRegExpFromStr("[!/]*"+p),r=e.match(n);r&&r[1]?this.setPackageName(r[1]):this.setPackageName(null)},_generateFromPackageInfo:function(){var e=p+"[/]?$";this.route(this._generateRegExpFromStr(e),"package.index")},_generateFromRoutes:function(){var e=$.extend(!0,{},r,i);_.each(e[a],function(e,t){var n=/^exp:/,r=n.test(t)?this._generateRegExpFromStr(t):t+"*search";this._processAction(e,r)},this)},_processAction:function(e,t){if(!this._processDirectiveAction(e,t)){var n=e.split(".");if(n.length!=3)throw new Error("Illegal action name");this.route(t,e,function(){var e=h.call(arguments),t=n[0],r=n[1],i=n[2],s=(t==="core"?"":t+"/")+"controllers"+"/"+r;require([s],function(t){if(!t[i])throw new Error("Action: "+i+" is not exists!!");t[i].apply(t,e)})})}},_processDirectiveAction:function(e,t){var n=e.match(c);return!n||n.length<2?!1:(this.route(t,e,function(){if(n[1]==="redirect:")return this.navigate(n[2],{trigger:!0,replace:!0})}),!0)},_generateRegExpFromStr:function(e){var t=null,r=/\/?([g|i|m]*)$/,i=e.match(r)[1],s=e.replace(/^exp:/,"").replace(/^\//,"").replace(/^\^/,"").replace(r,""),o="!/",u=new RegExp("^"+o);return n.config("useHashbang")&&!u.test(s)&&(s=o+s),s="^"+s+"([?]{1}.*)?",i?t=new RegExp(s,i):t=new RegExp(s),t}});return n.router=new d,n.router})}).call(this);