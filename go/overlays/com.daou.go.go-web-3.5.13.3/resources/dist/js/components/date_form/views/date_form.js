define(function(require){var e=require("i18n!works/nls/works"),t={"\uc624\ub298\ubd80\ud130":e["\uc624\ub298\ubd80\ud130"],"\uc624\ub298\uae4c\uc9c0":e["\uc624\ub298\uae4c\uc9c0"],"\uc77c\uc804":e["\uc77c\uc804"],"\uc77c\ud6c4":e["\uc77c\ud6c4"],"\ub2ec\uc804":e["\ub2ec\uc804"],"\ub2ec\ud6c4":e["\ub2ec\ud6c4"],"\uc2dc\uac01":e["\uc2dc\uac01"],"\ud604\uc7ac\uc77c \uae30\uc900":e["\ud604\uc7ac\uc77c \uae30\uc900"]},n=require("works/constants/condition_type"),r=require("components/date_form/views/time_select"),i=require("components/date_form/models/date_time"),s=require("hgn!components/date_form/templates/date_form");return Backbone.View.extend({tagName:"ul",className:"select_option",DAY_OPTION_SIZE:31,MONTH_OPTION_SIZE:12,initialize:function(e){this.options=e||{},this.hasDate=this.options.hasDate!==!1,this.hasTime=this.options.hasTime!==!1,this.useBackdrop=this.options.useBackdrop!==!1,this.isSingle=this.options.isSingle,this.hasRelativeView=this.options.hasRelativeView,this.externalModel=this.options.externalModel,this.isRelative=this.options.isRelative,this.values=this.options.values;var t=this.options.dateTime?this.options.dateTime.fromDateTime:null,n=this.options.dateTime?this.options.dateTime.toDateTime:null;this.model=new i({startDateTime:t,endDateTime:n}),this.model.on("change:startDateTime",this._onChangeStartDateTime,this),this.model.on("change:endDateTime",this._onChangeEndDateTime,this)},events:{"click ul[el-time-list] li":"_onSelect","keydown input[data-time]":"_onKeydown","change input[data-time]":"_onChange","change select[data-type='fromUnit']":"_onChangeFromUnit","change select[data-type='toUnit']":"_onChangeToUnit","change input[type='radio']":"_onChangePeriod","click li[el-period]":"_onClickPeriod"},render:function(){return this.$el.html(s({lang:t,startDate:this.model.getStartDate(),endDate:this.model.getEndDate(),hasDate:this.hasDate,hasTime:this.hasTime,hasRelativeView:this.hasRelativeView,cid:this.cid,isSingle:this.isSingle})),this._renderTimeList(),this._initDatepicker(),this._togglePeriodView(),this},resetView:function(){if(!this.externalModel)return;var e=this.externalModel.valuesToDateTime().fromDateTime,t=this.externalModel.valuesToDateTime().toDateTime;this.model.set({startDateTime:e}),this._setStartDateOfView(),this.model.set({endDateTime:t}),this._togglePeriodView()},setModel:function(){var e=this._getConditionType(),t=this.model.get("startDateTime"),r=this.model.get("endDateTime"),i={};switch(e){case n.TIME:i.fromTime=t.format("HH:mm"),i.toTime=r.format("HH:mm");break;case n.DATETIME:i.fromDateTime=t,i.toDateTime=r.add(1,"m").subtract(1,"ms");break;case n.RELATIVE_DATETIME:i=this._getRelativeData();break;case n.DATE:i.fromDate=t.format("YYYYMMDD"),i.toDate=r.format("YYYYMMDD");break;case n.RELATIVE_DATE:i=this._getRelativeData()}this.externalModel.set("conditionType",e),this.externalModel.set("values",i)},_togglePeriodView:function(){this.isRelative?this._activateRelative():this._activateAbstract()},_activateAbstract:function(){this.$("#dateFormAbstract"+this.cid).attr("checked",!0)},_activateRelative:function(){this.$("#dateFormRelative"+this.cid).attr("checked",!0),this._renderFromToOption(this.values.fromUnit,"from"),this._renderFromToOption(this.values.toUnit,"to"),_.each(this.values,function(e,t){this.$("select[data-type='"+t+"']").val(e)},this);var e=this.values&&this.values.fromUnit=="now";this.$("select[data-type='fromValue']").toggle(!e);var t=this.values&&this.values.toUnit=="now";this.$("select[data-type='toValue']").toggle(!t)},_onClickPeriod:function(e){e.preventDefault(),console.log("on click period");var t=$(e.currentTarget).attr("el-period");this.$("#dateForm"+GO.util.initCap(t)+this.cid).attr("checked",!0)},_onChangePeriod:function(e){console.log("on change period");var t=$(e.currentTarget).val();this.isRelative=t!="abstract",this._togglePeriodView()},_renderTimeList:function(){_.each(this.$("span[data-el='backdropWrapper']"),function(e){var t=$(e),n=t.attr("data-type"),i=new r({model:this.model,type:n,useBackdrop:this.useBackdrop});t.html(i.render().el),i.linkBackdrop(this.$("input[data-time='"+n+"']")),this[n+"TimeList"]=i},this)},_initDatepicker:function(){this.$("input[data-date='start']").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onClose:_.bind(function(e){this._changeStartDateTimeOfModel(e)},this)}),this.$("input[data-date='end']").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onClose:_.bind(function(e){this._changeEndDateTimeOfModel(e)},this),minDate:this.model.getStartDate()})},_changeStartDateTimeOfModel:function(e){var t=this.model.getStartDateTime(e,null);this.model.set("startDateTime",t)},_changeEndDateTimeOfModel:function(e){var t=this.model.getEndDateTime(e,null);this.model.set("endDateTime",t,{validate:!0}),this.model.validationError&&this.model.set("endDateTime",this.model.get("startDateTime")),this._renderEndTimeOption()},_onChangeStartDateTime:function(){this._setStartTimeOfView();var e=this.model.get("endDateTime").diff(this.model.previous("startDateTime"),"minutes"),t=this.hasDate?this.model.get("startDateTime").clone().add(e,"minutes"):this.model.get("startDateTime");this.model.set("endDateTime",t),this.hasTime&&this.endTimeList.renderTimeOption()},_onChangeEndDateTime:function(){this.$("input[data-date='end']").datepicker("option","minDate",this.model.getStartDate()),this._setEndDateOfView(),this._setEndTimeOfView()},_renderEndTimeOption:function(){this.hasTime&&this.endTimeList.renderTimeOption()},_onSelect:function(e){e.stopPropagation();var t=$(e.currentTarget).closest("[data-type]").attr("data-type"),n=$(e.currentTarget),r=n.find("span.txt").text();this[t+"TimeList"].toggle(!1),this._changeDateTimeOfModel(t,r)},_onKeydown:function(e){if(e.keyCode&&e.keyCode!=13)return;e.preventDefault();var t=$(e.currentTarget),n=t.attr("data-time"),r=t.val();this[n+"TimeList"].toggle(!1),this._changeDateTimeOfModel(n,r)},_onChange:function(e){var t=$(e.currentTarget),n=t.attr("data-time"),r=t.val();this._changeDateTimeOfModel(n,r)},_changeDateTimeOfModel:function(e,t){var n=this.model.parseTime(t),r=this.model["get"+GO.util.initCap(e)+"DateTime"](null,n);this.model.set(e+"DateTime",r)},_setStartDateOfView:function(){this.$("input[data-date='start']").val(this.model.getStartDate())},_setEndDateOfView:function(){this.$("input[data-date='end']").val(this.model.getEndDate())},_setStartTimeOfView:function(){this.$("input[data-time='start']").val(this.model.getStartTime())},_setEndTimeOfView:function(){this.$("input[data-time='end']").val(this.model.getEndTime())},_onChangeFromUnit:function(){var e=this.$("select[data-type='fromUnit']").val(),t=e=="now";this.$("select[data-type='fromValue']").toggle(!t),this._renderFromToOption(e,"from")},_onChangeToUnit:function(){var e=this.$("select[data-type='toUnit']").val(),t=e=="now";this.$("select[data-type='toValue']").toggle(!t),this._renderFromToOption(e,"to")},_getConditionType:function(){var e=this.$("#dateFormRelative"+this.cid).is(":checked"),t="";return this.hasDate&&this.hasTime?t=e?n.RELATIVE_DATETIME:n.DATETIME:this.hasDate&&!this.hasTime?t=e?n.RELATIVE_DATE:n.DATE:!this.hasDate&&this.hasTime&&(t=n.TIME),t},_getRelativeData:function(){var e={};return _.each(this.$("select"),function(t){var n=$(t).attr("data-type");e[n]=$(t).val()}),e},_renderFromToOption:function(e,t){if(_.contains(["day","month"],e)){var n=this[e.toUpperCase()+"_OPTION_SIZE"],r=[];for(var i=1;i<=n;i++)r.push('<option value="'+i+'">'+i+"</option>");this.$('select[data-type="'+t+'Value"]').html(r)}}})});