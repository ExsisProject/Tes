(function(){define(["backbone","app","i18n!nls/commons","hgn!components/emailSend/templates/send_mail_layer","i18n!nls/commons","jquery.autocomplete"],function(e,t,n,r,n){var i={to:n["\ubc1b\ub294\uc0ac\ub78c"],addr:n["\uc8fc\uc18c\ub85d"],subject:n["\uc81c\ubaa9"],memo:n["\uba54\ubaa8"],content:n["\ub0b4\uc6a9"],attach:n["\ucca8\ubd80\ud30c\uc77c"],confirm:n["\ud655\uc778"],cancel:n["\ucde8\uc18c"],appr_desc:n["\u203b \uacb0\uc7ac \ubb38\uc11c\ub294 html \ubcc0\ud658\ub418\uc5b4 \ucca8\ubd80\ud30c\uc77c\ub85c \ubc1c\uc1a1\ud569\ub2c8\ub2e4."]},s=e.View.extend({el:".go_popup .content",events:{"click span#writeAddAddress":"showAddAddress"},initialize:function(e){this.options=e||{},this.content=this.options.content,this.attachInfos=this.options.attachInfos,this.targetApp=this.options.targetApp},showAddAddress:function(e){var t=this;$.goPopup({pclass:"layer_normal layer_address",header:i.addr,width:980,modal:!0,allowPrevPopup:!0,contents:"<iframe id='writeAddrRcptFrame' name='writeAddrRcptFrame' scrolling='no' src='"+GO.config("contextRoot")+"app/contact/connector/to' frameborder='0' style='border:0;width:100%;height:470px;overflow: hidden;'></iframe>",buttons:[{btype:"confirm",btext:i.confirm,autoclose:!1,callback:function(e,n){t.applyWriteAddrRcpt(e,n)}},{btype:"cancel",btext:i.cancel,autoclose:!1,callback:function(e,t){e.close("",t)}}]})},applyWriteAddrRcpt:function(e,t){var n;$.browser.msie?n=window.writeAddrRcptFrame.getAddrRcptList():n=document.getElementById("writeAddrRcptFrame").contentWindow.getAddrRcptList();var r=n.toList;if(r&&r.length>0)for(var i=0;i<r.length;i++)this.insertRcptEmail("to",r[i]);e.close("",t)},insertRcptEmail:function(e,t){$.trim(t)!=""&&this.makeAddressUnitFormat(e,t)},makeAddressUnitFormat:function(e,t){if($.trim(t)=="")return;var n=$("#"+e);this.makeFormatUnit(n,t),n.focus(),n.width("80px")},makeFormatUnit:function(e,t){var n=this;if($.trim(t)=="")return;addressArray=new Array,addressSplit=t.split(">,");for(var r=0;r<addressSplit.length;r++){tempAddressArray=addressSplit[r].split(",");for(var i=0;i<tempAddressArray.length;i++)tempAddressArray[i]=$.trim(tempAddressArray[i]);addressArray=addressArray.concat(GO.util.makeFormatEmail(tempAddressArray))}for(var r=0;r<addressArray.length;r++){t=addressArray[r];var s=GO.util.checkEmailFormat(t),o=GO.util.get_email(t),u=s?o.indexOf("$")==0||o.indexOf("#")==0||o.indexOf("!")==0?!0:!1:!1,a=s?GO.util.getFormatName(t):t,f=s?GO.util.getEmailFormatName(t):t,l=$('<span class="name" id="nameField" evt-rol="select-field" onselectstart="return false"></span>').attr("title",a).data("email",f).data("select",!1).text(a),c=$('<span class="ic_con ic_edit_m" evt-rol="mod-field"></span>');c.attr("title","\uc218\uc815").click(function(){$(this).closest("li").find("span.btn_wrap").hide();var e=$(this).closest("li").hasClass("invalid"),t=$(this).closest("li").addClass(e?"invalid_on":"on").find("span.name"),r=t.data("email"),i="display:none;max-width:300px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;",s=['<input type="text" evt-rol="mod-field-inside" class="edit" style="',i,'">'].join(""),o=$(s).val(r),u={autoResizeWidth:!0,makeFormat:!0,multiple:!1,width:"400px",matchCase:!0,editMode:!0,editModeFunc:n.makeEditFormatUnit.bind(n)};$(o).autocomplete(GO.config("contextRoot")+"api/mail/address/search/name",u),t.before(o).remove(),o.blur(function(e){e.preventDefault(),isModFieldInside=!1,$("div.layer_auto_complete:hover").length?$(this).val(""):GO.util.makeEditFormatUnit(o,o.val())}).keydown(function(e){e.which==13&&(isModFieldInside=!1)});var a=$.Event("keydown");a.which=40,o.trigger(a).show().focus()});var h="";u||(h=$('<span class="btn_wrap"></span>').append(c));var p=$('<span class="ic_classic ic_del"></span>');p.attr("title","\uc0ad\uc81c").click(function(t){t.stopPropagation();var n=$(this).closest("li");n.find("input.edit").unautocomplete(),n.remove(),e.focus()});var d=$('<span class="btn_wrap"></span>').append(p),v=$("<li></li>");v.addClass(s?"":"invalid"),v.append(l).append(h).append(d),e.closest("li").before(v),e.val("")}},makeEditFormatUnit:function(e,t){if($.trim(t)=="")return;var n=GO.util.checkEmailFormat(t),r=n?GO.util.getFormatName(t):t,i=n?GO.util.getEmailFormatName(t):t,s=$('<span class="name" evt-rol="select-field" onselectstart="return false"></span>').attr("title",r).data("email",i).data("select",!1).text(r);e.before(s),e.closest("li").removeClass("invalid invalid_on on").addClass(n?"":"invalid"),e.closest("li").find("span.btn_wrap").show(),e.unautocomplete(),e.remove()},makeFormatEmail:function(e){var t=new Array,n=0,r=!1,i=!1;for(var s=0;s<e.length;s++)if(e[s].indexOf('"')>-1){r=!0;for(var o=s+1;o<e.length;o++)if(e[o].indexOf('"')>-1){i=!0;for(var u=s;u<=o;u++)u==s?t[n]=e[u]+",":u==o?t[n]=t[n]+e[u]:t[n]=t[n]+e[u]+",";n++;break}i||(t[n]=e[s]),s=o}else t[n]=e[s],n++;return t},makeInputAddresskeyEvt:function(e){function n(){var n=t.$("#"+e),r=$.trim(n.val());t.$("div.layer_auto_complete:hover").length?n.val(""):t.makeInputAddressFormat(e,r)}var t=this;$("#"+e).keydown(function(n){var r=$.trim($(this).val());n.which==188&&!n.shiftKey&&(t.makeInputAddressFormat(e,r),n.preventDefault())}).blur(function(e){}).keydown(function(e){e.which==8&&$(this).val()==""&&$(this).closest("ul.name_tag").find("li:not(.creat):last").remove()}),$(document).off("click.outside-mail"),$(document).on("click.outside-mail",function(e){var t=$(e.target).attr("data-outside");if(t!=undefined)return;n()})},makeInputAddressFormat:function(e,t){if(!t)return;var n=$.trim(t),r=n.split(">,");for(var i=0;i<r.length;i++)this.makeAddressUnitFormat(e,r[i])},preventEnterKey:function(e){$("#"+e).keypress(function(e){e.keyCode==13&&$(e.currentTarget).prop("tagName")!="TEXTAREA"&&e.preventDefault()})},render:function(){var e=this,t=function(){return e.attachInfos.length>0?!0:!1},n=r({content:this.content,fileList:this.attachInfos,isApproval:this.targetApp=="approval"?!0:!1,existFile:t,lang:i});this.$el.html(n),this.makeInputAddresskeyEvt("to");var s={autoResizeWidth:!0,makeFormat:!0,makeFormatFunc:this.makeFormatUnit.bind(this),multiple:!1,width:"400px",matchCase:!0,notContact:"F"};$("#to").autocomplete(GO.config("contextRoot")+"api/mail/address/search/name",s),this.preventEnterKey("subject"),this.preventEnterKey("mail_content")}},{__instance__:null,create:function(e){var t=new s({content:e.content,attachInfos:e.attachInfos,targetApp:e.targetApp});return t.render(),t}});return s})}).call(this);