(function(){define(["jquery","backbone","app","hogan","i18n!nls/commons","components/m_comment/views/item","components/comment/collections/comment","hgn!components/m_comment/templates/reply_item","hgn!components/m_comment/templates/temp_attach_image_item","components/go-fileuploader/mobile","i18n!board/nls/board","jquery.go-validation","GO.util"],function(e,t,n,r,i,s,o,u,a,f,l){var c={save:i["\uc800\uc7a5"],cancel:i["\ucde8\uc18c"],modify:i["\uc218\uc815"],"delete":i["\uc0ad\uc81c"],commentSave:i["\ub313\uae00 \uc791\uc131"],commentPlaceholder:i["\ub313\uae00\uc744 \uc785\ub825\ud558\uc138\uc694."],reply_save:i["\ub313\uae00 \ub4f1\ub85d"],reply_cancel:i["\ucde8\uc18c"],save_success:i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],public_writer:l["\uc791\uc131\uc790 \uacf5\uac1c"]},h=t.View.extend({tagName:"li",className:"creat reply",events:{"vclick a.comment_reply_save":"save","vclick a.comment_reply_cancel":"cancel"},initialize:function(e){this.options=e||{},this.attachOptions={},this.$el.off(),this.typeUrl=this.options.typeUrl,this.typeId=this.options.typeId,this.commentId=this.options.commentId,this.model=new o,this.model.set({typeUrl:this.typeUrl,typeId:this.typeId,commentId:this.commentId}),this.boardModel=e.boardModel,n.EventEmitter.off("m_comment","reply_fileuploader"),n.EventEmitter.on("m_comment","reply_fileuploader",this.attachFileInReply,this)},attachFileInReply:function(){window.attachFileSuccess=e.proxy(this.attachSuccess,this),window.attachFileError=this.attachFail},render:function(){return this.$el.html(u({lang:c,thumbnail:n.session("thumbnail"),isMobileApp:n.config("isMobileApp"),anonymFlag:this.boardModel?this.boardModel.get("anonymFlag")||!1:!1,availableAnonymousWriterOptionInPostComment:this.boardModel?this.boardModel.get("availableAnonymousWriterOptionInPostComment")||!1:!1})),this.$el.addClass("depth2"),this},attachFileUploader:function(){this.attachOptions.success=this.attachSuccess,this.attachOptions.error=this.attachFail,f.bind(this.$el.find("#reply_fileuploader"),this.attachOptions)},attachSuccess:function(t){var r=typeof t=="string"?JSON.parse(t):t.data;r.fileSize=n.util.getHumanizedFileSize(r.fileSize),r.isImage=n.util.isImage(r.fileExt),r.icon_class=n.util.getFileIconStyle({extention:r.fileExt});var i=a(r);window.target.closest("li").find("#reply_attach_wrap").show(),window.target.closest("li").find("#reply_attach_wrap ul").show();if(window.target.closest("li").find("#reply_fileuploader").data("attachable")==="false")return;try{this.attachValidate(r)}catch(s){s.message==="overMaxAttachNumber"&&e("#reply_fileuploader").data("attachable","false");return}r.isImage?(window.target.closest("li").find("#reply_attach_wrap ul.img_wrap").append(i),e("span.ic_del").on("click",function(t){e("#reply_fileuploader").data("attachable","true"),e(t.currentTarget).closest("li").remove()})):(window.target.closest("li").find("#reply_attach_wrap ul.file_wrap").append(i),e("span.ic_file_del").on("click",function(t){e("#reply_fileuploader").data("attachable","true"),e(t.currentTarget).closest("li").remove()}))},attachFail:function(){alert(i["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},attachValidate:function(t){var r=null,s=n.util.getFileNameAndTypeData(t);n.config("allowedFileUploadSize")&&(r=n.config("allowedFileUploadSize")/1024/1024);try{e.goValidation.attachValidate("#reply_attach_wrap ul li",s,r),n.session().brandName=="DO_SAAS"&&f.attachFileValidateBySaaS(s.size)}catch(o){var u=o.message;if(u=="AttachSizeException")n.util.delayAlert(n.i18n(i["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",r));else{if(u=="AttachNumberExceptionBySaaS")throw n.util.delayAlert(n.i18n(i["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",n.config("commonAttachConfig").maxAttachNumber)),new Error("overMaxAttachNumber");u=="NotFoundExtException"&&n.util.delayAlert(i["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},save:function(e){var t=this.$el.find("textarea"),r=t.val(),s=this,o=f.getAttachInfo("#reply_attach_wrap div.wrap_attach");this.model.isCalendar()&&this.commentId&&this.model.set({thread:this.commentId});var u=this.$el.find("#isOpenWriter").is(":checked");this.model.set({message:r,attaches:o,publicWriter:u}),this.model.save(null,{success:function(e){n.EventEmitter.trigger("m_comment","change:comment")},error:function(e,t){var n=JSON.parse(t.responseText),r=i["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."];return n.message&&(r=n.message),alert(r),!1}})},cancel:function(){this.$el.remove()}},{__instance__:null,create:function(e){var t=new h({typeUrl:e.typeUrl,typeId:e.typeId,commentId:e.commentId,boardModel:e.boardModel});return t.render(),t}});return h})}).call(this);