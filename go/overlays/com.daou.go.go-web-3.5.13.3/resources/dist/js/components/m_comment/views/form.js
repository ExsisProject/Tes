(function(){define(["jquery","backbone","app","hogan","i18n!nls/commons","components/comment/collections/comment","hgn!components/m_comment/templates/form","hgn!components/m_comment/templates/temp_attach_image_item","components/go-fileuploader/mobile","i18n!board/nls/board","jquery.go-validation","GO.util"],function(e,t,n,r,i,s,o,u,a,f){var l={commentSave:i["\ub4f1\ub85d"],commentPlaceholder:i["\ub313\uae00\uc744 \uc785\ub825\ud558\uc138\uc694."],save_success:i["\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],alert_length:i["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],preview:i["\ubbf8\ub9ac\ubcf4\uae30"],download:i["\ub2e4\uc6b4\ub85c\ub4dc"],public_writer:f["\uc791\uc131\uc790 \uacf5\uac1c"]},c=!1,h=t.View.extend({tagName:"li",className:"creat",events:{"vclick a.save":"save"},initialize:function(e){this.options=e||{},this.attachOptions={},this.$el.off(),this.typeUrl=this.options.typeUrl,this.typeId=this.options.typeId,this.model=new s,this.model.set({typeUrl:this.typeUrl,typeId:this.typeId}),n.EventEmitter.off("m_comment","form_fileuploader"),n.EventEmitter.on("m_comment","form_fileuploader",this.attachFileInForm,this),this.boardModel=e.boardModel},attachFileInForm:function(){window.attachFileSuccess=e.proxy(this.attachSuccess,this),window.attachFileError=this.attachFail},render:function(){return this.$el.html(o({lang:l,isMobileApp:n.config("isMobileApp"),anonymFlag:this.boardModel?this.boardModel.get("anonymFlag")||!1:!1,availableAnonymousWriterOptionInPostComment:this.boardModel?this.boardModel.get("availableAnonymousWriterOptionInPostComment")||!1:!1})),this},attachFileUploader:function(){this.attachOptions.success=this.attachSuccess,this.attachOptions.error=this.attachFail,a.bind(this.$el.find("#form_fileuploader"),this.attachOptions)},attachSuccess:function(t){var r=typeof t=="string"?JSON.parse(t):t.data;r.fileSize=n.util.getHumanizedFileSize(r.fileSize),r.isImage=n.util.isImage(r.fileExt),r.icon_class=n.util.getFileIconStyle({extention:r.fileExt});var i=u(r),s=e("#form_attach_wrap");s.show();if(e("#form_fileuploader").data("attachable")==="false")return;try{this.attachValidate(r)}catch(o){o.message==="overMaxAttachNumber"&&e("#form_fileuploader").data("attachable","false");return}n.util.isImage(r.fileExt)?(e("#form_attach_wrap #img_attach_wrap_ul").append(i),e("span[data-btntype='attachDelete']").on("click",function(t){e("#form_fileuploader").data("attachable","true"),e(t.currentTarget).closest("li").remove()})):(e("#form_attach_wrap #file_attach_wrap_ul").append(i),e("span.ic_file_del").on("click",function(t){e("#form_fileuploader").data("attachable","true"),e(t.currentTarget).closest("li").remove()}))},attachFail:function(){alert(i["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},attachValidate:function(t){var r=null,s=n.util.getFileNameAndTypeData(t);n.config("allowedFileUploadSize")&&(r=n.config("allowedFileUploadSize")/1024/1024);try{e.goValidation.attachValidate("#form_attach_wrap ul li",s,r),n.session().brandName=="DO_SAAS"&&a.attachFileValidateBySaaS(s.size)}catch(o){var u=o.message;if(u=="AttachSizeException")n.util.delayAlert(n.i18n(i["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",r));else{if(u=="AttachNumberExceptionBySaaS")throw n.util.delayAlert(n.i18n(i["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",n.config("commonAttachConfig").maxAttachNumber)),new Error("overMaxAttachNumber");u=="NotFoundExtException"&&n.util.delayAlert(i["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},save:function(t){if(c)return;var r=this.$el.find("textarea"),s=r.val(),o=this;if(!s||!e.goValidation.isCheckLength(2,1e3,e.trim(s))){alert(n.i18n(l.alert_length,{arg1:"2",arg2:"1000"}));return}var u=a.getAttachInfo("#form_attach_wrap"),f=this.$el.find("#isOpenWriter").is(":checked");this.model.set({message:s,attaches:u,publicWriter:f}),this.model.save(null,{beforeSend:function(){c=!0},success:function(e){n.EventEmitter.trigger("m_comment","change:comment")},error:function(e,t){var n=JSON.parse(t.responseText),r=i["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."];return n.message&&(r=n.message),alert(r),!1},complete:function(){c=!1}})}},{__instance__:null,create:function(e,t,n){var r=new h({typeUrl:e,typeId:t,boardModel:n});return r.render(),r}});return h})}).call(this);