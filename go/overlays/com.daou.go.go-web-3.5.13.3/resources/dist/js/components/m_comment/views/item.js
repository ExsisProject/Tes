(function(){define(["jquery","backbone","app","hogan","i18n!nls/commons","hgn!components/m_comment/templates/item","hgn!components/m_comment/templates/temp_attach_image_item","attach_file","components/go-fileuploader/mobile","i18n!board/nls/board","GO.util","jquery.go-validation"],function(e,t,n,r,i,s,o,u,a,f){var l={reply:i["\ub313\uae00"],modify:i["\uc218\uc815"],remove:i["\uc0ad\uc81c"],save:i["\uc800\uc7a5"],cancel:i["\ucde8\uc18c"],alert_length:i["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],removeRemoveDesc:i["\ub313\uae00\uc774 \ub4f1\ub85d\ub41c \uae00\uc740 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."],removeSuccess:i["\ub313\uae00\uc744 \uc0ad\uc81c\ud558\uc600\uc2b5\ub2c8\ub2e4."],removeConfirm:i["\ub313\uae00\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],modifySuccess:i["\ubcc0\uacbd\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],preview:i["\ubbf8\ub9ac\ubcf4\uae30"],download:i["\ub2e4\uc6b4\ub85c\ub4dc"],public_writer:f["\uc791\uc131\uc790 \uacf5\uac1c"],emoticonDelete:i["\uc774\ubaa8\ud2f0\ucf58 \uc0ad\uc81c"]},c=t.View.extend({tagName:"li",events:{"vclick #info_mode a.modify":"modify","vclick #info_mode a.remove":"remove","vclick #edit_mode a.save":"save","vclick #edit_mode a.cancel":"cancel","vclick #emoticonDeleteBtn":"_onClickDeleteEmoticon"},initialize:function(e){this.$el.off(),this.options=e||{},this.attachOptions={},this.isReply=e.isReply,this.typeUrl=this.options.typeUrl,this.typeId=this.options.typeId,this.model=this.options.model,this.model.set({typeUrl:this.typeUrl,typeId:this.typeId}),this.anonymFlag=e.anonymFlag,n.EventEmitter.off("m_comment","item_fileuploader"),n.EventEmitter.on("m_comment","item_fileuploader",this.attachFileInItem,this)},attachFileInItem:function(){window.attachFileSuccess=e.proxy(this.attachSuccess,this),window.attachFileError=this.attachFail},render:function(){var t=this.model.get("id")!=this.model.get("thread"),r=this.isReply&&!t,i=this;this.$el.html(s({data:e.extend({},this.model.toJSON(),{createdAtBasicDate:n.util.basicDate3(this.model.get("createdAt")),isWritableReply:r,showMessage:n.util.escapeHtml(this.model.get("message")),editMessage:this.model.get("message")}),hasEmoticon:this.model.hasEmoticon(),emoticonPathSrc:this.model.getEmoticonPath(),emoticonPath:this.model.get("emoticonPath"),thumbnail:this.model.get("writer").thumbSmall||this.model.get("writer").thumbnail,lang:l,isMobileApp:n.config("isMobileApp"),anonymFlag:this.anonymFlag||!1,availableAnonymousWriterOptionInPostComment:this.model.get("publicWriter")||!1}));var o=this.isBoard()?"/attaches/":"/download/";return u.create(this.$el.find("#attach-placeholder"),this.model.get("attaches"),function(e){return n.config("contextRoot")+"api/"+i.typeUrl+"/"+i.typeId+"/comment/"+i.model.id+o+e.get("id")}),t?this.$el.addClass("depth2"):this.$el.addClass("depth1"),this.$el.attr("comment-id",this.model.get("id")),this.$el.attr("comment-thread-id",this.model.get("thread")),this},attachFileUploader:function(){this.attachOptions.success=this.attachSuccess,this.attachOptions.error=this.attachFile,a.bind(this.$el.find("#item_fileuploader"),this.attachOptions)},attachSuccess:function(t){var r=typeof t=="string"?JSON.parse(t):t.data;r.fileSize=n.util.getHumanizedFileSize(r.fileSize),r.isImage=n.util.isImage(r.fileExt),r.icon_class=n.util.getFileIconStyle({extention:r.fileExt});var i=o(r);window.target.closest("li").find("#item_attach_wrap").show(),window.target.closest("li").find("#item_attach_wrap ul").show();if(window.target.closest("li").find("#item_fileuploader").data("attachable")==="false")return;try{this.attachValidate(r)}catch(s){s.message==="overMaxAttachNumber"&&window.target.closest("li").find("#item_fileuploader").data("attachable","false");return}r.isImage?(window.target.closest("li").find("#item_attach_wrap ul.img_wrap").append(i),e("span.ic_del").on("click",function(t){window.target.closest("li").find("#item_fileuploader").data("attachable","true"),e(t.currentTarget).closest("li").remove()})):(window.target.closest("li").find("#item_attach_wrap ul.file_wrap").append(i),e("span.ic_file_del").on("click",function(t){window.target.closest("li").find("#item_fileuploader").data("attachable","true"),e(t.currentTarget).closest("li").remove()}))},attachFail:function(){alert(i["\uc5c5\ub85c\ub4dc\uc5d0 \uc2e4\ud328\ud558\uc600\uc2b5\ub2c8\ub2e4."])},attachValidate:function(t){var r=null,s=n.util.getFileNameAndTypeData(t);n.config("allowedFileUploadSize")&&(r=n.config("allowedFileUploadSize")/1024/1024);try{e.goValidation.attachValidate("#item_attach_wrap ul li",s,r),n.session().brandName=="DO_SAAS"&&a.attachFileValidateBySaaS(s.size)}catch(o){var u=o.message;if(u=="AttachSizeException")n.util.delayAlert(n.i18n(i["\ucca8\ubd80\ud560 \uc218 \uc788\ub294 \ucd5c\ub300 \uc0ac\uc774\uc988\ub294 0MB \uc785\ub2c8\ub2e4."],"arg1",r));else{if(u=="AttachNumberExceptionBySaaS")throw n.util.delayAlert(n.i18n(i["\ucd5c\ub300 \ucca8\ubd80 \uac2f\uc218\ub294 0\uac1c \uc785\ub2c8\ub2e4."],"arg1",n.config("commonAttachConfig").maxAttachNumber)),new Error("overMaxAttachNumber");u=="NotFoundExtException"&&n.util.delayAlert(i["\ucca8\ubd80\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c \uc785\ub2c8\ub2e4."])}throw new Error("Attach Validation Error")}},_onClickDeleteEmoticon:function(t){t.preventDefault(),t.stopPropagation(),e(t.currentTarget).parents("[data-emoticon-edit-part]").removeClass("thumb_append"),e(t.currentTarget).parents("[data-emoticon-edit-part]").empty()},isBoard:function(){return this.typeUrl.split("/")[0]=="board"},modify:function(e){e.preventDefault(),this.$el.find("#edit_mode").find(".edit_content").height(this.$el.find("#info_mode").find(".subject").height()),this.$el.find("#info_mode").hide(),this.$el.find("#edit_mode").show(),this.$el.find("#edit_mode div.wrap_attach").replaceWith("<div id='attach-placeholder-edit'></div>"),this.model.get("attaches").length>0&&this.$el.find("#item_attach_wrap").show(),u.edit(this.$el.find("#attach-placeholder-edit"),this.model.get("attaches"),""),this.$el.find("#edit_mode ul.img_wrap .btn_wrap span").removeClass("ic_classic").addClass("ic"),this.attachFileUploader();if(this.model.hasEmoticon()){var t=this.$el.find("#edit_mode").find("[data-emoticon-edit-part]");t.addClass("thumb_append"),t.empty(),t.append('<img class="emoticon" id="commentEmoticonImg" src="'+this.model.getEmoticonPath()+'" data-item-path ="'+this.model.get("emoticonPath")+'" alt=""><span class="btn btn_del_type2" id="emoticonDeleteBtn" title=""></span>')}},remove:function(){var e=this;if(this.$el.hasClass("depth1")&&this.$el.next().hasClass("depth2")){alert(l.removeRemoveDesc);return}confirm(l.removeConfirm)&&this.model.destroy({success:function(){n.EventEmitter.trigger("m_comment","change:comment")}})},cancel:function(e){e.preventDefault(),this.$el.find("#info_mode").show(),this.$el.find("#edit_mode").hide(),this.$el.find("#edit_mode textarea.edit_content").val(this.model.get("message"))},save:function(t){t.preventDefault();var r=this,s=this.$el.find("#edit_mode textarea").val(),o=a.getAttachInfo("#item_attach_wrap div.wrap_attach"),u=this.$el.find("#commentEmoticonImg").attr("data-item-path");if(!s||!e.goValidation.isCheckLength(2,1e3,e.trim(s))){alert(n.i18n(l.alert_length,{arg1:"2",arg2:"1000"}));return}this.model.set({message:s,attaches:o,emoticonPath:u}),this.model.save(null,{success:function(){r.render()},error:function(e,t){var n=JSON.parse(t.responseText),r=i["\uc800\uc7a5\uc5d0 \uc2e4\ud328 \ud558\uc600\uc2b5\ub2c8\ub2e4."];return n.message&&(r=n.message),alert(r),!1}})}},{__instance__:null,create:function(e,t){var n=new c({typeUrl:e,typeId:t});return n.render(),n}});return c})}).call(this);