define(function(require){var e=require("backbone"),t=require("components/comment/collections/comments"),n=require("components/comment/views/comment_item"),r=require("components/comment/views/comment_form"),i=require("hgn!components/comment/templates/comment_print_frame"),s=require("components/emoticon/views/emoticons"),o=require("i18n!nls/commons");require("jquery.go-validation");var u={"\ub313\uae00":o["\ub313\uae00"],"\uac1c":o["\uac1c"]},a=e.View.extend({initialize:function(e){this.typeUrl=e.typeUrl,this.typeId=e.typeId,this.rootUrl=e.rootUrl||e.typeUrl,this.rootId=e.rootId||e.typeId,this.isReply=e.hasOwnProperty("isReply")?e.isReply:!0,this.isPrintMode=e.isPrintMode,this.onAfterRender=_.bind(this.options.onAfterRender||function(){},this),this.isWritable=e.isWritable==undefined?!0:e.isWritable,this.popupPrint=e.popupPrint||!1,this.anonymFlag=e.anonymFlag,this.availableAnonymousWriterOptionInPostComment=e.availableAnonymousWriterOptionInPostComment||!1,this.emoticonView=new s({}),this.isPrintMode&&(this.isWritable=!this.isPrintMode),this.collection=new t({typeUrl:this.typeUrl,typeId:this.typeId}),this.collection.on("reset",this.renderList,this);var n=this;this.$el.on("comment:reset",function(){n.fetchComments(!0).done(function(){n.$el.trigger("comment:change",[n.typeUrl,n.collection.length])})})},render:function(){this.$el.html('<ul class="reply"></ul>');if(this.isWritable){var e=new r({typeUrl:this.typeUrl,typeId:this.typeId,uid:this.cid,anonymFlag:this.anonymFlag,availableAnonymousWriterOptionInPostComment:this.availableAnonymousWriterOptionInPostComment,emoticonView:this.emoticonView});this.$el.append(e.render().el),e.$el.addClass("reply_create"),e.$el.attr("data-comment-main-edit",!0)}return this.$el.append(this.emoticonView.render().el),this},renderList:function(){this.$("ul.reply").children().remove(),this.popupPrint&&this.$el.html(i({lang:u})),this.collection.each(function(e){this.addOne(e)},this),this.$("#commentCount").append(this.collection.length),this.$("ul.reply").find("li:last").addClass("last"),this.onAfterRender(this)},addOne:function(e){var t=new n({model:e,rootUrl:this.rootUrl,rootId:this.rootId,typeUrl:this.typeUrl,typeId:this.typeId,isReply:this.isReply,isWritable:this.isWritable,uid:this.cid,popupPrint:this.popupPrint,availableAnonymousWriterOptionInPostComment:this.availableAnonymousWriterOptionInPostComment,anonymFlag:this.anonymFlag||!1});this.popupPrint?this.$("#comment_creat").append(t.render().el):this.$("ul.reply").append(t.render().el)},fetchComments:function(e){var t=e||!1,n=this.collection.fetch({data:{offset:1e3},async:t,reset:!0});return t?n:this},setComments:function(e){this.collection.set(e)}});return{render:function(e){var t=this.init(e);return t.render().fetchComments()},init:function(e){return new a(e)}}});