define(["i18n!nls/commons","i18n!board/nls/board","i18n!works/nls/works","hgn!go-realgrid/templates/realgrid","views/profile_card","grid/views/pagesize","views/pagination","components/realgrid/data_type"],function(e,t,n,r,i,s,o,u){var a={search_all:t["\uc804\uccb4\uae30\uac04"],search_month:t["\uac1c\uc6d4"],search_year:t["\ub144"],search_input:t["\uae30\uac04\uc785\ub825"],search:e["\uac80\uc0c9"]};return Backbone.View.extend({className:"grid_view",initialize:function(e){this.options=e,this.columns=e.columns,this.gridClass=e.gridClass,this.doms=e.doms,this.htmlDatas=e.htmlDatas,this.buttons=e.buttons||[],this.searchOptions=e.searchOptions||[],this.usePeriod=e.usePeriod,this.readOnly=e.readOnly,this.emptyMessage=e.emptyMessage,this.useCheckbox=e.checkbox!==!1,this.usePageSize=e.usePageSize!==!1,this.useTopButton=e.useTopButton!==!1,this.useBottomButton=e.useBottomButton!==!1,this.useToolbar=e.useToolbar!==!1,this.isAdmin=e.isAdmin===!0,this.DataType=u,this.licenseCheck(),this.collection.on("fetching",this._showProgress,this),this.collection.on("sync",this._onSyncCollection,this),this.provider&&(this.provider.clearRows(),this.provider.destroy(),this.provider=null),this.provider=new RealGrid.LocalDataProvider(!1)},events:{"click #searchBtn":"_search","change #duration":"_changeDuration","keypress #searchKeyword":"_keyEventHandler","click [data-profile]":"_profile","click [el-grid-list-item]":"_onClickGridListItem"},render:function(){return this.$el.html(r({useSearch:this.searchOptions.length>0,search:this.searchOptions,usePeriod:this.usePeriod,lang:a,useToolbar:this.useToolbar,isAdmin:this.isAdmin})),this.$pageSize=this.$(".optional"),this._initListView(),this._setFieldsNColumns(),this._renderListView(),this._renderPageSizeView(),this._renderPageView(),this._markHeader(),this._renderButton(),this._setSearchData(),this._setGridEvent(),this.$el.addClass(this.className),this.gridClass&&this.$el.addClass(this.gridClass),this},licenseCheck:function(){$.ajax({url:GO.contextRoot+"api/realgrid/license",async:!1,type:"GET"}).done(function(e){var t=$.trim(e.data);t!=""&&(realGrid2Lic=t)})},getCheckedData:function(){return _.map(this.getCheckedIds(),function(e){return this.collection.get(e).toJSON()},this)},getCheckedIds:function(){var e=this.gridView.getCheckedItems();return _.map(e,function(e){return this.provider.getJsonRow(e).docId},this)},_initListView:function(){this.container=this.$el.find("[data-el-realgrid]"),this.container.empty(),this.gridView=new RealGrid.GridView(this.container[0]),this.gridView.setStateBar({visible:!1}),this.gridView.setCheckBar({visible:this.useCheckbox}),this.gridView.setSortingOptions({enabled:!1}),this.gridView.setCopyOptions({copyDisplayText:!0}),this.gridView.setDataSource(this.provider),this.gridView.setHeaderSummaries({visible:!0,items:[{height:30},{height:30}]}),this.gridView.rowIndicator.visible=!0,this.gridView.rowIndicator.width=50,this.gridView.rowIndicator.displayValue="row",this.gridView.footers.visible=!1,this.gridView.editOptions.commitByCell=!0,this.gridView.displayOptions.fitStyle="even",this.gridView.displayOptions.showEmptyMessage=!0,this.gridView.displayOptions.minCellWidth=150,this.gridView.displayOptions.rowHeight=30,this.gridView.displayOptions.emptyMessage=this.emptyMessage||n["\ubaa9\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."],this.gridView.header.height=30;var e=GO.util.store.get("gridview-rowHeight");e=e&&e>0?e:30,this._setRowHeight(e);var t=GO.util.store.get("gridview-headerSummary");this.gridView.headerSummaries.visible=t?!0:!1,this.readOnly&&(this.gridView.editOptions.editable=!1,this.gridView.editOptions.updatable=!1,this.gridView.displayOptions.columnMovable=!1,this.gridView.headerSummaries.visible=!1),this._registerCustomRenderer()},_registerCustomRenderer:function(){this.gridView.registerCustomRenderer("renderer_html",{initContent:function(e){this.renderParent=e,$(this.renderParent).addClass("renderer-html")},canClick:function(){return!0},clearContent:function(e){e.innerHTML=""},render:function(e,t){$(this.renderParent).html(t.value)}});var e=this;this.gridView.registerCustomRenderer("renderer_view",{initContent:function(e){this.renderParent=e,$(this.renderParent).addClass("renderer-view")},canClick:function(){return!0},clearContent:function(e){e.innerHTML=""},render:function(t,n){var r=e.columnDataView[n.value];r&&r.render&&($(this.renderParent).empty(),$(this.renderParent).html(r.render().el))}})},_setFieldsNColumns:function(){var e=[],t=[];_.each(this.columns,function(n){e.push({fieldName:n.name,dataType:n.dataType}),t.push({name:n.label,fieldName:n.name,type:"data",header:{text:n.label}})}),this.provider.setFields(e),this.gridView.setColumns(t)},_renderListView:function(){this.provider.clearRows(),this.collection.each(function(e){var t={docId:e.id};_.each(this.columns,function(n){t[n.fieldName]=n.render(e)},this),this.provider.addRow(t)},this)},_renderPageSizeView:function(){if(!this.usePageSize)return;_.each(this.$pageSize,function(e){var t=new s({pageSize:this.collection.pageSize});t.setElement($(e)),t.render(),t.bind("changePageSize",this._selectPageSize,this)},this)},_renderPageView:function(){this.pageView&&this.pageView.remove();var e=this.collection.pageInfo();this.pageView=new o({pageInfo:e,useBottomButton:this.useBottomButton}),this.gridView&&(this.gridView.rowIndicator.rowOffset=e.pageNo*e.pageSize),this.pageView.bind("paging",this._selectPage,this),this.$("#bottomToolbar").append(this.pageView.render().el)},_selectPageSize:function(e){this.collection.setPageSize(e),this.collection.setPageNo(0),this.collection.fetch(),this.$("select[data-el-grid-page-size]").val(e)},_selectPage:function(e){this.collection.setPageNo(e),this.collection.fetch(),this._scrollTop(),this.$el.trigger("selectPage",e)},_onClickCheckbox:function(e){e.stopPropagation()},_setGridEvent:function(){this._setOnLoadEvent(),this._setCellClickEvent(),this._setColumnEvent(),this._setEditColumnEvent(),this._setSelectionEvent(),this._setContextMenuPopupEvent(),this._setContextMenuEvent(),this._setOnCopyEvent()},_setOnLoadEvent:function(){this.gridView.onDataLoadComplated=function(e){}},_setCellClickEvent:function(){this.gridView.onCellClicked=$.proxy(function(e,t){t.cellType=="header"?(e.cancel(),this._sorting(t.fieldName)):t.cellType=="indicator"&&(e.cancel(),this._onClickIndicator(e))},this),this.gridView.onCellButtonClicked=$.proxy(function(e){e.cancel(),this._onClickCellButton(e)},this)},_setColumnEvent:function(){this.gridView.onColumnPropertyChanged=function(e,t,n,r){}},_setEditColumnEvent:function(){this.gridView.onValidateColumn=function(e,t,n,r){}},_setSelectionEvent:function(){this.gridView.onSelectionChanged=function(e){}},_setContextMenuPopupEvent:function(){this.gridView.onContextMenuPopup=function(e){}},_getContextMenu:function(){var t=this.gridView.columnByName(this.gridView.getCurrent().column);return[{label:e["\uc5f4 \uace0\uc815"],children:[{label:e["\uccab\ubc88\uc9f8 \uc5f4"],tag:"1colFixed"},{label:e["\ub450\ubc88\uc9f8 \uc5f4"],tag:"2colFixed"},{label:e["\ud604\uc7ac \uc5f4\uae4c\uc9c0"]+" ("+t.header.text+")",tag:"colFixed"},{label:"-"},{label:e["\uace0\uc815 \ucde8\uc18c"],tag:"cancelFixed",enabled:this.gridView.fixedOptions.rightCount+this.gridView.fixedOptions.colCount+this.gridView.fixedOptions.rowCount!=0}]},{label:e["\ud589 \ub192\uc774"],children:[{label:e["\uc881\uac8c"]+" (25px)",tag:"rowSmallHeight",checked:this.gridView.displayOptions.rowHeight==25},{label:e["\ubcf4\ud1b5"]+" (30px)",tag:"rowNormalHeight",checked:this.gridView.displayOptions.rowHeight==30},{label:e["\ub113\uac8c"]+" (35px)",tag:"rowLargeHeight",checked:this.gridView.displayOptions.rowHeight==35}]},{label:e["\ud569\uacc4/\ud3c9\uade0 \ud45c\uc2dc\uc5ec\ubd80"],children:[{label:e["\ud45c\uc2dc\ud558\uae30"],tag:"showHeaderSummary",checked:this.gridView.headerSummaries.visible},{label:e["\uc228\uae30\uae30"],tag:"hideHeaderSummary",checked:!this.gridView.headerSummaries.visible}]}]},_setContextMenuEvent:function(){this.gridView.onContextMenuItemClicked=$.proxy(function(e,t){var n=e.getCurrent(),r=e.columnByName(n.column),i=0,s=!1;switch(t.tag){case"1colFixed":e.setFixedOptions({colCount:1});break;case"2colFixed":e.setFixedOptions({colCount:2});break;case"colFixed":e.setFixedOptions({colCount:r.index+1});break;case"cancelFixed":e.setFixedOptions({colCount:0,rowCount:0});break;case"rowNormalHeight":i=30,s=!0;break;case"rowSmallHeight":i=25,s=!0;break;case"rowLargeHeight":i=35,s=!0;break;case"showHeaderSummary":e.headerSummaries.visible=!0,s=!0;break;case"hideHeaderSummary":e.headerSummaries.visible=!1,s=!0}i>0&&(this._setRowHeight(i),GO.util.store.set("gridview-rowHeight",i)),(t.tag=="showHeaderSummary"||t.tag=="hideHeaderSummary")&&this.$el.trigger("headerSummary:grid",{visible:t.tag=="showHeaderSummary"}),s&&this._resizeGrid(),this.$el.trigger("contextMenu:grid",{tag:t.tag})},this)},_setRowHeight:function(e){this.gridView.displayOptions.rowHeight=e;var t=this.gridView.headerSummaries.count;for(var n=0;n<t;n++)this.gridView.headerSummaries.get(n).height=e},_setOnCopyEvent:function(){this.gridView.onCopy=function(e,t,n){}},_sorting:function(e){if(this.isFetching)return;var t=this.$el.find("span[data-property='"+e+"']"),n=t.attr("data-property"),r=t.attr("data-direction")=="asc"?"desc":"asc";this._sortRendering(n,r),this.collection.property=n,this.collection.direction=r,this.isFetching=!0,this.collection.fetch({success:$.proxy(function(){this.isFetching=!1},this),error:$.proxy(function(){this.isFetching=!1},this)}),this.$el.trigger("sorting:grid",{property:n,direction:r})},_sortRendering:function(e,t){this.$el.find("div.rg-header-renderer .rg-header-sort").removeClass("rg-header-sort-asc rg-header-sort-desc");var n=this.$el.find("span[data-property='"+e+"']");n.attr("data-direction",t),n.addClass("rg-header-sort-"+t)},_changeDuration:function(){var e=this.$("#duration").val();e=="period"?this._showDurationPeriod():(this.$("#durationPeriod").hide(),this.collection.setDuration(e))},_showDurationPeriod:function(){this.$("#durationPeriod").show(),this.$("#fromDate").datepicker({defaultDate:"+1w",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){self.$("#toDate").datepicker("option","minDate",e)}}),this.$("#toDate").datepicker({defaultDate:"+1w",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearSuffix:"",onSelect:function(e){self.$("#fromDate").datepicker("option","maxDate",e)}})},_keyEventHandler:function(e){e.which==13&&this._search()},_search:function(){var t=this.$("#searchKeyword");if(t.val().length>64||t.val().length<2){$.goMessage(GO.i18n(e["0\uc790\uc774\uc0c1 0\uc774\ud558 \uc785\ub825\ud574\uc57c\ud569\ub2c8\ub2e4."],{arg1:2,arg2:64}),t,!1,!0);return}this.collection.setSearchType(this.$("#searchTypes").val()),this.collection.setKeyword(this.$("#searchKeyword").val()),this._setDuration(),this.collection.setPageNo(0),this.collection.fetch()},_setDuration:function(){var e=this.$("#duration").val();e=="period"?this.collection.setDuration(e,{fromDate:this.$("#fromDate").val(),toDate:this.$("#toDate").val()}):this.collection.setDuration(e)},_markHeader:function(){_.each(this.columns,$.proxy(function(e){if(e.useSort){var t=this.gridView.columnByField(e.fieldName).header;if(t){var n=$("<div></div>");n.append("<span>"+t.text+"</span>");var r=$("<span></span>").attr("data-property",e.fieldName);r.addClass("rg-header-sort rg-header-sort-icon"),r.attr("data-direction",this.collection.property==e.fieldName?this.collection.direction:"desc"),this.collection.property==e.fieldName&&r.addClass("rg-header-sort-"+this.collection.direction),n.append(r),t.template=n.html()}}},this)),this._sortRendering(this.collection.property,this.collection.direction)},_setSearchData:function(){this.collection.keyword&&this.$("#searchKeyword").val(decodeURIComponent(this.collection.keyword)),this.collection.searchType&&this.$("#searchTypes").val(this.collection.searchType),this.collection.duration&&(this.$("#duration").val(this.collection.duration),this.collection.duration=="period"&&(this._showDurationPeriod(),this.$("#fromDate").val(GO.util.shortDate(this.collection.fromDate)),this.$("#toDate").val(GO.util.shortDate(this.collection.toDate))))},_renderButton:function(){_.each(this.buttons,function(e){_.each(this.$(this._getToolbarSelector()),function(t){var n=$(e.render());$(t).append(n);if(typeof e.type=="undefined")typeof e.onClick=="function"&&n.on("click",e.onClick);else if(typeof e.type=="function"&&e.type()==="submenu"){typeof e.onClick=="function"&&n.on("click","a#downloadBtn",e.onClick);var r=e.getView(),i=n.find("#submenuBtn");i.append(r.render().el),i.attr("backdrop-toggle",!0),r.linkBackdrop(i),r.toggle(!1),n.append(r.$el)}})},this)},_getToolbarSelector:function(){var e="div.critical";return this.useTopButton&&!this.useBottomButton?e="div.custom_header":!this.useTopButton&&this.useBottomButton&&(e="div.custom_bottom"),e},_resizeGrid:function(){if(!this.gridView)return;setTimeout($.proxy(function(){var e=this.gridView.getItemCount(),t=this.gridView.displayOptions.rowHeight,n=this.$el.find("div.rg-header").height(),r=this.$el.find("div.rg-header-summary").height();r=this.gridView.headerSummaries.visible?r:0;var i=t*(e<=0?1:e)+n+r+70;this.container.css("height",i),this.gridView.resetSize()},this),100)},_showProgress:function(){this.$("#processing").show()},hideProgress:function(){this.$("#processing").hide()},_drawCallback:function(){typeof this.options.drawCallback=="function"&&this.options.drawCallback(this.collection)},_profile:function(e){e.stopPropagation();var t=e.currentTarget,n=$(t).attr("data-id");if(!n)return;i.render(n,t)},_onSyncCollection:function(){this.hideProgress(),this._renderPageView(),this._renderListView(),this._drawCallback(),this.$el.trigger("renderingComplete"),this._resizeGrid()},_scrollTop:function(){$(window).scrollTop(this.$el.offset().top)},_onClickGridListItem:function(e){var t=$(e.target);if(t.is("[data-stop-propagation]")||t.parents("[data-stop-propagation]").length)return;var n=$(e.currentTarget).attr("data-id");this.clickGridListItem(n)},clickGridListItem:function(e){var t=this.collection.get(e);t&&this.columnFields&&t.set("columnFields",this.columnFields),this.collection.storeParam(),this.$el.trigger("navigate:grid",e),t&&this.$el.trigger("onClickListItem",t.toJSON())},_onClickIndicator:function(e){},_onClickCellButton:function(e){}})});