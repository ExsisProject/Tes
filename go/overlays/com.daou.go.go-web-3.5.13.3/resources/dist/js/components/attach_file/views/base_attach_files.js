define(["jquery","backbone","app","hgn!components/attach_file/templates/attach_file","i18n!nls/commons","GO.util","jquery.cookie"],function(e,t,n,r,i){function o(e){a.call(this,"image",e)}function u(e){a.call(this,"file",e)}function a(e,t){var n={image:"img_wrap",file:"file_wrap"}[e],r="."+n,i=p(),s=this;if(t.length<=0)return;_.each(t,function(e){var t=f.call(s,e,i).$el;t.data("model",e.toJSON()),this.$el.find(r).show().append(t)},this)}function f(e,t){var n={model:e,downloadUrl:this.options.downloadUrl,mode:this.options.mode,fancyGroupId:t,editable:_.isUndefined(this.options.editable)?!1:this.options.editable,observer:this.observer};return(new s(n)).render()}function l(e){return new t.Model({name:e.name,extention:e.extension,size:e.size,download:!1,preview:!!e.preview,thumbSmall:e.thumbnail,encrypt:""})}function c(e,t){var r=new RegExp("(jpeg|jpg|png|bmp)","gi"),i=e.extention,s=e.name;if(n.config("deviceType")!=="mobile")return!1;if(r.test(i)&&GO_config.__config__.mobileConfig.useMobilePreview)n.util.attachImages([{fileName:s,url:e.thumbLarge}],0);else{var o=location.protocol+"//"+location.host;n.util.attachFiles(o+t,s,e.size)}return!0}function h(e){return _.defaults(e||{},{id:0,name:"no name",extension:"def",file_size:0,icon_class:e.icon_class==undefined?"ic_def":e.icon_class,download_url:null,"downloadable?":!1,"removable?":!0,"previewable?":e.preview!==undefined,label:{save:i["\ub2e4\uc6b4\ub85c\ub4dc"],remove:i["\uc0ad\uc81c"],preview:i["\ubbf8\ub9ac\ubcf4\uae30"]}}),r(e)}function p(){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function d(){var t=n.config("deviceType"),r=e.cookie("pcVersion"),i=!0;switch(t){case"pc":i=!1;break;case"tablet":r?r&&r==="true"&&(i=!1):i=!1;break;case"mobile":r&&r==="true"&&(i=!1)}return i}var s=t.View.extend({tagName:"li",downloadUrl:null,events:{"click .btn-download":"_download","click .btn-preview":"_preview","click .wrap_ic_file_preview":"_preview","click .btn-file-remove":"_remove","click span.btn_wrap span.ic_classic":"_remove","vclick span.btn_wrap span.ic_del":"_remove","vclick span.optional a.btn-text.ic_del":"_remove","vclick span.optional span.ic_file_del":"_remove"},initialize:function(e){this.options=e||{},this.model=this.options.model,this.fancyGroupId=this.options.fancyGroupId,this.observer=e.observer},render:function(){var e=this,t=this.options.mode=="edit"||this.model.get("mode")=="edit",r=t?!1:d()?this.model.get("download"):!0,i=this.model.get("preview"),s=t?!1:i&&this.model.get("encrypt"),o=t&&n.router.getUrl().indexOf("approval")>-1&&i,u=e.isImage(),a={name:this.model.get("name"),extension:this.model.get("extention"),file_size:n.util.getHumanizedFileSize(this.model.get("size")),icon_class:n.util.getFileIconStyle(this.model.toJSON()),"editable?":t,"downloadable?":r,"previewable?":i,useMobilePreview:s,useMobileTempPreview:o,hostId:this.model.get("hostId"),download_url:this.options.downloadUrl==undefined?"#":this.options.downloadUrl(this.model),encrypt:this.model.get("encrypt"),thumbSmall:this.model.get("thumbSmall"),isImageType:u,imageGroupId:this.fancyGroupId,isMobile:d(),editable:this.options.editable!==!1,isMobileApp:GO_config.__config__.isMobileApp},f=h(a);return this.$el.html(f),this.$el.attr("data-name",this.model.get("name")),this.$el.attr("data-size",this.model.get("size")),this.model.get("id")==undefined?this.$el.attr("data-path",this.model.get("filePath")):this.$el.attr("data-id",this.model.get("id")),this},isImage:function(){return!!n.util.isImage(this.model.get("extention"))},isFile:function(){return!this.isImage()},_preview:function(t){t.preventDefault(),t.stopPropagation();var r=e(t.currentTarget);return n.util.preview(r.attr("data-id"))},on:function(){this.$el.on.apply(this.$el,arguments)},off:function(){this.$el.off.apply(this.$el,arguments)},_download:function(t){var r=e(t.currentTarget),i=r.closest("li");return n.config("deviceType")!=="mobile"?!0:(c(i.data("model"),r.attr("href")),!1)},_remove:function(e){return this.$el.trigger("removedFile",[{id:this.$el.data("id"),name:this.$el.data("name"),el:e}]),this.$el.remove(),_.isUndefined(this.observer)||this.observer.trigger("removeFile",[{id:this.$el.data("id"),name:this.$el.data("name"),el:e}]),!1}});return t.View.extend({className:"wrap_attach",events:{},initialize:function(n){this.options=n||{},this.options.placeholder&&e(this.options.placeholder).replaceWith(this.$el),this.collection||(this.collection=new t.Collection),this.options.downloadUrl||(this.options.downloadUrl=function(){}),this.options.mode!="item"&&this.$el.append('<ul class="file_wrap" style="display:none"></ul>','<ul class="img_wrap" style="display:none"></ul>'),this.observer=_.extend({},t.Events)},render:function(){var e=this,t=this.collection.groupBy(function(t){return e.isImageType(t)?"images":"files"});u.call(this,t.files||[]),o.call(this,t.images||[])},isImageType:function(e){if(n.util.isImage(e.get("extention"))){var t=this.options.mode!=undefined&&this.options.mode=="edit";return!(d()&&!t&&!e.get("mobilePreview"))}return!1},attach:function(e){var t=l(e);n.util.isImage(e.extension)?o.call(this,[t]):u.call(this,[t])}},{create:function(e,n,r,i){var s=new this.prototype.constructor({placeholder:e,collection:_.isArray(n)?new t.Collection(n):n,downloadUrl:_.isFunction(r)?r:function(){return r},mode:i});return s.render(),s},edit:function(e,n,r,i){var s=new this.prototype.constructor({placeholder:e,collection:_.isArray(n)?new t.Collection(n):n,mode:"edit",editable:i});return s.render(),s},makeItem:function(e,n){var r=new s({model:new t.Model(e),downloadUrl:n});return r.render()}})});