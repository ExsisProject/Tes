define(function(require){require("jquery.ui");var e=require("matrix/constants/matrix_event"),t=require("i18n!nls/commons"),n=require("i18n!calendar/nls/calendar"),r=require("backbone"),i=require("matrix/models/matrix"),s=require("matrix/models/matrix_item"),o=require("matrix/views/matrix_row"),u=require("matrix/views/matrix_item"),a=require("hgn!matrix/templates/matrix"),f={"\uc624\ub298":t["\uc624\ub298"],"\uc774\uc804":t["\uc774\uc804"],"\ub2e4\uc74c":t["\ub2e4\uc74c"],"\uc8fc\uac04":n["\uc8fc\uac04"],"\uc77c\uac04":n["\uc77c\uac04"]},l=100;return r.View.extend({isDragging:!1,draggedRow:null,correctionValue:0,attributes:{"data-matrix":""},initialize:function(e){this.matrix=new i(e.matrix),this.leftToolbar=e.leftToolbar||"",this.rightToolbar=e.rightToolbar||"",this.emptyMessage=e.emptyMessage||"",this.matrixHeader=e.matrixHeader||"",this.listenTo(this.collection,"sync",this.render),this.collection.setMatrix(this.matrix),this.collection.fetch(),this._bindResize()},events:{"click [data-matrix-item]":"_onClickItem","click [data-matrix-row]":"_onClickRow","click [data-row-head]":"_onClickRowHead","mousedown [data-matrix-row]":"_onMouseDownRow","mouseup [data-matrix-row]":"_onMouseUpRow","mousemove [data-matrix-row]":"_onMouseMoveRow","click #datePickerBtn":"_onClickDatePicker","click #today":"_onClickToday","click #prev":"_onClickPrev","click #next":"_onClickNext"},render:function(){return this._render(),this.$el.trigger(e.RENDER_DONE),this},fetch:function(){this.collection.fetch()},getMatrix:function(){return this.matrix},_render:function(){this.$el.html(a({lang:f,range:this.matrix.getDateRange(),columns:this.matrix.get("columns"),columnSize:this.matrix.getColumnLength(),headerColumn:this.matrix.getHeaderColumns(),headerColSpan:_.isUndefined(this.matrix.get("headerColSpan"))?1:this.matrix.get("headerColSpan"),rows:this.collection.toJSON(),isEmpty:this.collection.isEmpty(),leftToolbar:this.leftToolbar,rightToolbar:this.rightToolbar,emptyMessage:this.emptyMessage,matrixHeader:this.matrixHeader,displayTimeLine:this.matrix.isDayType()&&!this.collection.isEmpty()})),this.matrix.set("bodyWidth",this.$("div[data-matrix-body]").width()),this.matrix.set("columnWidth",this.$("td[data-matrix-column]:first").outerWidth()),this.matrix.set("minRowHeight",this.$("td[data-row-head]").outerHeight()),this.correctionValue=0,this._correction(),this._renderRows(),this._initDatePicker(),this._renderTimeLine()},_renderRows:function(){this.$("div[data-matrix-body]").empty(),this.collection.each(function(e,t){this._appendRow(e,t)},this)},_appendRow:function(e,t){var n=new o({matrix:this.matrix,model:e});this.$("div[data-matrix-body]").append(n.render().el);var r=n.$el.height();this.$("tr[data-row]:eq("+t+")").css("height",r)},_renderTimeLine:function(){var e=this.matrix.get("rowHeadWidth"),t=this.matrix.dateToPixel(),n=e+t;t<0||t>this.matrix.get("bodyWidth")?this.$("#timeLine").hide():this.$("#timeLine").css({left:n+"px",height:this.$("[data-matrix-body]").height()})},_bindResize:function(){$(window).on("resize.matrix",$.proxy(function(e){if($(e.target).attr("data-matrix-item")=="")return!1;this._correction();var t=this.$("td[data-matrix-column]:first").outerWidth();this.matrix.set("bodyWidth",this.$("div[data-matrix-body]").width()),this.matrix.set("columnWidth",t),this.matrix.get("useGrid")&&(this.matrix.get("resizable")&&this.$("div[data-matrix-item]").resizable("option","grid",[t]),this.matrix.get("draggable")&&this.$("div[data-matrix-item]").draggable("option","grid",[t])),this._renderTimeLine()},this))},_correction:function(){var e=this.$("th:first");this.correctionValue=(this.correctionValue+this.$("div[data-matrix-body]").width())%this.matrix.get("columns").length;var t=l+this.correctionValue;e.css("width",t+"px"),this.matrix.set("rowHeadWidth",t),this.$("[data-matrix-body]").css("left",e.outerWidth())},_onClickItem:function(t){t.stopPropagation();var n=$(t.currentTarget).find(".ui-resizable-handle").length>0;if(n)return;console.log("on click item");var r=$(t.currentTarget).attr("data-matrix-item");this.$el.trigger(e.ITEM_CLICK,{itemId:r,target:$(t.currentTarget)})},_onClickRow:function(t){this.$el.trigger(e.ROW_CLICK)},_onClickRowHead:function(t){this.$el.trigger(e.ROW_HEAD_CLICK,{rowId:$(t.currentTarget).attr("data-row-head")})},_onMouseDownRow:function(t){if(t.which==3)return;if(!this.matrix.get("useDrag"))return;if($(t.target).parents("[data-matrix-item]").length)return!1;console.log("on mouse down row");var n=$(t.currentTarget),r=this._getColumnFromPoint(t),i=r.attr("data-column-key"),o=new s({startTime:i,endTime:i},{matrix:this.matrix});o.setEndDateByGrid(1),this.newItemView=new u({matrix:this.matrix,model:o}),n.append(this.newItemView.render().el),this.newItemView.$el.css("opacity",.5),this.isDragging=!0,this.draggedRow=n,this.$el.trigger(e.ROW_MOUSE_DOWN,{column:r,item:this.newItemView})},_onMouseUpRow:function(t){if(!this.matrix.get("useDrag"))return;if(!this.isDragging)return;console.log("on mouse up row");var n=this._getColumnFromPoint(t);this.$el.trigger(e.ROW_MOUSE_UP,{column:n,item:this.newItemView,row:this.draggedRow}),this.isDragging=!1,this.draggedRow=null},_onMouseMoveRow:function(e){if(!this.matrix.get("useDrag"))return;if(!this.isDragging)return;var t=this._getColumnFromPoint(e);if(!t)return;var n=t.attr("data-column-key");this.newItemView.setEndDateByGrid(n),this.newItemView.render()},_getColumnFromPoint:function(e){var t=$(e.currentTarget),n=t.parent("div[data-matrix-body]");n.hide();var r=$(document.elementFromPoint(e.clientX,e.clientY));return n.show(),r.attr("data-column-key")||(r=null),r},_initDatePicker:function(){$.datepicker.setDefaults($.datepicker.regional[GO.config("locale")]),this.$("#matrixDate").datepicker({yearSuffix:"",dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,beforeShow:function(e,t){t.dpDiv.attr("data-layer","");var n=!0;$(document).trigger("showLayer.goLayer",n)},onClose:function(){var e=!0;$(document).trigger("hideLayer.goLayer",e)},onSelect:$.proxy(function(e){this.selectedDate=e,this.collection.changeTime(e)},this)}),this.selectedDate&&this.$("#matrixDate").datepicker("setDate",this.selectedDate)},_onClickDatePicker:function(){this.$("#matrixDate").focus()},_onClickToday:function(){this.collection.today()},_onClickPrev:function(){this.collection.prev()},_onClickNext:function(){this.collection.next()}})});